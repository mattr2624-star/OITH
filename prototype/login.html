<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OITH Admin - Login</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-tertiary: #1a1a25;
            --bg-card: #15151f;
            --accent: #6366f1;
            --accent-light: #818cf8;
            --accent-glow: rgba(99, 102, 241, 0.3);
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --border: rgba(255, 255, 255, 0.08);
            --border-focus: rgba(99, 102, 241, 0.5);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        /* Animated background */
        .bg-animation {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 0;
            overflow: hidden;
        }

        .bg-gradient {
            position: absolute;
            width: 600px;
            height: 600px;
            border-radius: 50%;
            filter: blur(120px);
            opacity: 0.4;
            animation: float 20s infinite ease-in-out;
        }

        .bg-gradient-1 {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            top: -200px;
            left: -200px;
            animation-delay: 0s;
        }

        .bg-gradient-2 {
            background: linear-gradient(135deg, #06b6d4 0%, #3b82f6 100%);
            bottom: -200px;
            right: -200px;
            animation-delay: -10s;
        }

        .bg-gradient-3 {
            background: linear-gradient(135deg, #8b5cf6 0%, #ec4899 100%);
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 400px;
            height: 400px;
            opacity: 0.2;
            animation-delay: -5s;
        }

        @keyframes float {
            0%, 100% { transform: translate(0, 0) rotate(0deg); }
            25% { transform: translate(50px, 50px) rotate(90deg); }
            50% { transform: translate(0, 100px) rotate(180deg); }
            75% { transform: translate(-50px, 50px) rotate(270deg); }
        }

        /* Grid pattern overlay */
        .grid-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: 
                linear-gradient(rgba(255,255,255,0.02) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255,255,255,0.02) 1px, transparent 1px);
            background-size: 50px 50px;
            z-index: 1;
        }

        .container {
            position: relative;
            z-index: 10;
            width: 100%;
            max-width: 440px;
            padding: 20px;
        }

        .logo-container {
            text-align: center;
            margin-bottom: 40px;
        }

        .logo {
            display: inline-flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .logo-icon {
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, var(--accent), #8b5cf6);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            box-shadow: 0 8px 32px var(--accent-glow);
        }

        .logo-text {
            font-size: 32px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--text-primary) 0%, var(--text-secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: -0.5px;
        }

        .logo-subtitle {
            color: var(--text-muted);
            font-size: 14px;
            font-weight: 500;
        }

        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 24px;
            padding: 40px;
            backdrop-filter: blur(20px);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        .form-title {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 8px;
            text-align: center;
        }

        .form-subtitle {
            color: var(--text-muted);
            font-size: 14px;
            text-align: center;
            margin-bottom: 32px;
        }

        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 32px;
            background: var(--bg-secondary);
            padding: 6px;
            border-radius: 14px;
        }

        .tab {
            flex: 1;
            padding: 12px 16px;
            background: transparent;
            border: none;
            border-radius: 10px;
            color: var(--text-muted);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .tab:hover {
            color: var(--text-secondary);
        }

        .tab.active {
            background: var(--accent);
            color: white;
            box-shadow: 0 4px 12px var(--accent-glow);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .input-wrapper {
            position: relative;
        }

        .input-icon {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
            pointer-events: none;
        }

        .form-input {
            width: 100%;
            padding: 14px 16px 14px 48px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 15px;
            font-family: inherit;
            transition: all 0.2s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 4px var(--accent-glow);
        }

        .form-input::placeholder {
            color: var(--text-muted);
        }

        .password-toggle {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 4px;
        }

        .password-toggle:hover {
            color: var(--text-secondary);
        }

        .form-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: var(--text-secondary);
            cursor: pointer;
        }

        .checkbox-label input {
            width: 18px;
            height: 18px;
            accent-color: var(--accent);
        }

        .forgot-link {
            color: var(--accent-light);
            font-size: 14px;
            text-decoration: none;
            font-weight: 500;
            transition: color 0.2s;
        }

        .forgot-link:hover {
            color: var(--accent);
            text-decoration: underline;
        }

        .btn-primary {
            width: 100%;
            padding: 16px 24px;
            background: linear-gradient(135deg, var(--accent) 0%, #8b5cf6 100%);
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 16px var(--accent-glow);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px var(--accent-glow);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            width: 100%;
            padding: 14px 24px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            color: var(--text-secondary);
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-top: 12px;
        }

        .btn-secondary:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .divider {
            display: flex;
            align-items: center;
            margin: 24px 0;
            color: var(--text-muted);
            font-size: 13px;
        }

        .divider::before,
        .divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: var(--border);
        }

        .divider span {
            padding: 0 16px;
        }

        .message {
            padding: 14px 16px;
            border-radius: 12px;
            margin-bottom: 20px;
            font-size: 14px;
            display: none;
        }

        .message.error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #fca5a5;
            display: block;
        }

        .message.success {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            color: #6ee7b7;
            display: block;
        }

        .form-view {
            display: none;
        }

        .form-view.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .back-link {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-muted);
            font-size: 14px;
            margin-bottom: 20px;
            cursor: pointer;
            transition: color 0.2s;
        }

        .back-link:hover {
            color: var(--text-primary);
        }

        .password-requirements {
            margin-top: 8px;
            font-size: 12px;
            color: var(--text-muted);
        }

        .password-requirements li {
            margin-left: 16px;
            margin-top: 4px;
        }

        .password-requirements li.valid {
            color: var(--success);
        }

        .loader {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .footer-text {
            text-align: center;
            margin-top: 24px;
            font-size: 13px;
            color: var(--text-muted);
        }

        .footer-text a {
            color: var(--accent-light);
            text-decoration: none;
        }

        .footer-text a:hover {
            text-decoration: underline;
        }

        /* Responsive */
        @media (max-width: 480px) {
            .card {
                padding: 24px;
            }
            
            .form-footer {
                flex-direction: column;
                gap: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="bg-animation">
        <div class="bg-gradient bg-gradient-1"></div>
        <div class="bg-gradient bg-gradient-2"></div>
        <div class="bg-gradient bg-gradient-3"></div>
    </div>
    <div class="grid-overlay"></div>

    <div class="container">
        <div class="logo-container">
            <div class="logo">
                <div class="logo-icon">üê¶</div>
                <span class="logo-text">OITH</span>
            </div>
            <p class="logo-subtitle">Admin Dashboard</p>
        </div>

        <div class="card">
            <!-- Login View -->
            <div id="loginView" class="form-view active">
                <h2 class="form-title">Welcome Back</h2>
                <p class="form-subtitle">Sign in to access the admin dashboard</p>

                <div id="loginMessage" class="message"></div>

                <form id="loginForm" onsubmit="handleLogin(event)">
                    <div class="form-group">
                        <label class="form-label">Email Address</label>
                        <div class="input-wrapper">
                            <svg class="input-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                                <polyline points="22,6 12,13 2,6"/>
                            </svg>
                            <input type="email" id="loginEmail" class="form-input" placeholder="admin@oith.com" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Password</label>
                        <div class="input-wrapper">
                            <svg class="input-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                                <path d="M7 11V7a5 5 0 0110 0v4"/>
                            </svg>
                            <input type="password" id="loginPassword" class="form-input" placeholder="Enter your password" required>
                            <button type="button" class="password-toggle" onclick="togglePassword('loginPassword', this)">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                                    <circle cx="12" cy="12" r="3"/>
                                </svg>
                            </button>
                        </div>
                    </div>

                    <div class="form-footer">
                        <label class="checkbox-label">
                            <input type="checkbox" id="rememberMe">
                            Remember me
                        </label>
                        <a href="#" class="forgot-link" onclick="showView('forgotPassword')">Forgot password?</a>
                    </div>

                    <button type="submit" class="btn-primary" id="loginBtn">
                        Sign In
                    </button>
                </form>

                <div class="divider"><span>or</span></div>

                <button class="btn-secondary" onclick="showView('register')">
                    Create New Account
                </button>

                <p class="footer-text">
                    Need help? <a href="mailto:support@oith.com">Contact Support</a>
                </p>
            </div>

            <!-- Register View -->
            <div id="registerView" class="form-view">
                <div class="back-link" onclick="showView('login')">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M19 12H5M12 19l-7-7 7-7"/>
                    </svg>
                    Back to Login
                </div>

                <h2 class="form-title">Create Account</h2>
                <p class="form-subtitle">Register with your company email from the employee hierarchy</p>

                <div id="registerMessage" class="message"></div>

                <form id="registerForm" onsubmit="handleRegister(event)">
                    <div class="form-group">
                        <label class="form-label">Full Name</label>
                        <div class="input-wrapper">
                            <svg class="input-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/>
                                <circle cx="12" cy="7" r="4"/>
                            </svg>
                            <input type="text" id="registerName" class="form-input" placeholder="John Doe" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Email Address</label>
                        <div class="input-wrapper">
                            <svg class="input-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                                <polyline points="22,6 12,13 2,6"/>
                            </svg>
                            <input type="email" id="registerEmail" class="form-input" placeholder="user@oith.com" required oninput="checkEmployeeEmail(this.value)">
                        </div>
                        <div id="emailValidationHint" style="margin-top: 6px; font-size: 12px; display: none;"></div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Password</label>
                        <div class="input-wrapper">
                            <svg class="input-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                                <path d="M7 11V7a5 5 0 0110 0v4"/>
                            </svg>
                            <input type="password" id="registerPassword" class="form-input" placeholder="Create a strong password" required oninput="checkPasswordStrength(this.value)">
                            <button type="button" class="password-toggle" onclick="togglePassword('registerPassword', this)">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                                    <circle cx="12" cy="12" r="3"/>
                                </svg>
                            </button>
                        </div>
                        <ul class="password-requirements" id="passwordRequirements">
                            <li id="req-length">At least 6 characters</li>
                            <li id="req-upper">One uppercase letter</li>
                            <li id="req-number">One number</li>
                        </ul>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Confirm Password</label>
                        <div class="input-wrapper">
                            <svg class="input-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                                <path d="M7 11V7a5 5 0 0110 0v4"/>
                            </svg>
                            <input type="password" id="registerConfirmPassword" class="form-input" placeholder="Confirm your password" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Super Admin Token (Optional)</label>
                        <div class="input-wrapper">
                            <svg class="input-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"/>
                            </svg>
                            <input type="text" id="registerToken" class="form-input" placeholder="Only needed if not in employee hierarchy">
                        </div>
                        <div style="margin-top: 6px; font-size: 11px; color: var(--text-muted);">
                            üí° If your email is not in the employee hierarchy, you'll need a super admin token to register.
                        </div>
                    </div>

                    <button type="submit" class="btn-primary" id="registerBtn">
                        Create Account
                    </button>
                </form>
            </div>

            <!-- Forgot Password View -->
            <div id="forgotPasswordView" class="form-view">
                <div class="back-link" onclick="showView('login')">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M19 12H5M12 19l-7-7 7-7"/>
                    </svg>
                    Back to Login
                </div>

                <h2 class="form-title">Reset Password</h2>
                <p class="form-subtitle">Enter your email to receive a reset link</p>

                <div id="forgotMessage" class="message"></div>

                <form id="forgotForm" onsubmit="handleForgotPassword(event)">
                    <div class="form-group">
                        <label class="form-label">Email Address</label>
                        <div class="input-wrapper">
                            <svg class="input-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                                <polyline points="22,6 12,13 2,6"/>
                            </svg>
                            <input type="email" id="forgotEmail" class="form-input" placeholder="Enter your email" required>
                        </div>
                    </div>

                    <button type="submit" class="btn-primary" id="forgotBtn">
                        Send Reset Link
                    </button>
                </form>
            </div>

            <!-- Reset Password View -->
            <div id="resetPasswordView" class="form-view">
                <h2 class="form-title">Set New Password</h2>
                <p class="form-subtitle">Enter your new password below</p>

                <div id="resetMessage" class="message"></div>

                <form id="resetForm" onsubmit="handleResetPassword(event)">
                    <div class="form-group">
                        <label class="form-label">Reset Token</label>
                        <div class="input-wrapper">
                            <svg class="input-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"/>
                            </svg>
                            <input type="text" id="resetToken" class="form-input" placeholder="Paste your reset token" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">New Password</label>
                        <div class="input-wrapper">
                            <svg class="input-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                                <path d="M7 11V7a5 5 0 0110 0v4"/>
                            </svg>
                            <input type="password" id="newPassword" class="form-input" placeholder="Enter new password" required>
                            <button type="button" class="password-toggle" onclick="togglePassword('newPassword', this)">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                                    <circle cx="12" cy="12" r="3"/>
                                </svg>
                            </button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Confirm New Password</label>
                        <div class="input-wrapper">
                            <svg class="input-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                                <path d="M7 11V7a5 5 0 0110 0v4"/>
                            </svg>
                            <input type="password" id="confirmNewPassword" class="form-input" placeholder="Confirm new password" required>
                        </div>
                    </div>

                    <button type="submit" class="btn-primary" id="resetBtn">
                        Reset Password
                    </button>
                </form>

                <button class="btn-secondary" onclick="showView('login')">
                    Back to Login
                </button>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const LOCAL_API_URL = 'http://localhost:3001/api';
        const AWS_API_URL = localStorage.getItem('oith_aws_api_url') || 'https://emeapbgbui.execute-api.us-east-1.amazonaws.com';
        
        // Determine which API to use
        let API_URL = LOCAL_API_URL;
        
        // Try to detect if local server is available
        async function detectApiUrl() {
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 2000);
                const response = await fetch(`${LOCAL_API_URL}/health`, { 
                    signal: controller.signal,
                    mode: 'cors'
                });
                clearTimeout(timeoutId);
                if (response.ok) {
                    console.log('‚úÖ Using local API server');
                    API_URL = LOCAL_API_URL;
                    return;
                }
            } catch (e) {
                console.log('‚ö†Ô∏è Local server not available, using AWS API');
            }
            API_URL = AWS_API_URL;
            console.log('‚òÅÔ∏è Using AWS API:', API_URL);
        }
        
        // Helper to safely parse JSON response
        async function parseJsonResponse(response) {
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                const text = await response.text();
                if (text.startsWith('<!DOCTYPE') || text.startsWith('<html')) {
                    throw new Error('Server returned HTML instead of JSON. The API endpoint may not exist.');
                }
                throw new Error('Server returned non-JSON response');
            }
            return response.json();
        }

        // View Management
        function showView(view) {
            document.querySelectorAll('.form-view').forEach(v => v.classList.remove('active'));
            document.getElementById(view + 'View').classList.add('active');
            clearMessages();
        }

        function clearMessages() {
            document.querySelectorAll('.message').forEach(m => {
                m.className = 'message';
                m.textContent = '';
            });
        }

        function showMessage(elementId, message, type) {
            const el = document.getElementById(elementId);
            el.textContent = message;
            el.className = `message ${type}`;
        }

        // Password Toggle
        function togglePassword(inputId, button) {
            const input = document.getElementById(inputId);
            const isPassword = input.type === 'password';
            input.type = isPassword ? 'text' : 'password';
            
            button.innerHTML = isPassword 
                ? `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/>
                    <line x1="1" y1="1" x2="23" y2="23"/>
                   </svg>`
                : `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                    <circle cx="12" cy="12" r="3"/>
                   </svg>`;
        }

        // Password Strength Checker
        function checkPasswordStrength(password) {
            const requirements = {
                length: password.length >= 6,
                upper: /[A-Z]/.test(password),
                number: /[0-9]/.test(password)
            };

            document.getElementById('req-length').className = requirements.length ? 'valid' : '';
            document.getElementById('req-upper').className = requirements.upper ? 'valid' : '';
            document.getElementById('req-number').className = requirements.number ? 'valid' : '';
        }

        // Set Loading State
        function setLoading(buttonId, loading) {
            const btn = document.getElementById(buttonId);
            if (loading) {
                btn.disabled = true;
                btn.innerHTML = '<span class="loader"></span>Please wait...';
            } else {
                btn.disabled = false;
                btn.textContent = btn.dataset.originalText || 'Submit';
            }
        }

        // Simple hash function for local password verification
        function simpleHash(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return hash.toString(16);
        }
        
        // Login Handler
        async function handleLogin(event) {
            event.preventDefault();
            
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const remember = document.getElementById('rememberMe').checked;

            const btn = document.getElementById('loginBtn');
            btn.dataset.originalText = btn.textContent;
            setLoading('loginBtn', true);

            try {
                // Try API first
                const response = await fetch(`${API_URL}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                const data = await parseJsonResponse(response);

                if (!response.ok) {
                    throw new Error(data.error || 'Login failed');
                }

                // Save session
                const storage = remember ? localStorage : sessionStorage;
                storage.setItem('oith_admin_token', data.token);
                storage.setItem('oith_admin_user', JSON.stringify(data.user));

                showMessage('loginMessage', 'Login successful! Redirecting...', 'success');
                
                // Redirect to manager
                setTimeout(() => {
                    window.location.href = 'manager.html';
                }, 1000);

            } catch (error) {
                // If API fails, try local authentication
                console.log('API login failed, trying local auth:', error.message);
                
                const localUsers = JSON.parse(localStorage.getItem('oith_local_admins') || '{}');
                const lowerEmail = email.toLowerCase();
                const user = localUsers[lowerEmail];
                
                if (user && user.passwordHash === simpleHash(password + 'oith')) {
                    // Local login success
                    const token = btoa(JSON.stringify({ email: lowerEmail, timestamp: Date.now() }));
                    const storage = remember ? localStorage : sessionStorage;
                    storage.setItem('oith_admin_token', token);
                    storage.setItem('oith_admin_user', JSON.stringify({ 
                        email: lowerEmail, 
                        name: user.name,
                        role: user.role || 'admin'
                    }));
                    
                    showMessage('loginMessage', 'Login successful (offline mode)! Redirecting...', 'success');
                    setTimeout(() => {
                        window.location.href = 'manager.html';
                    }, 1000);
                } else if (!user && authorizedEmployees.find(e => e.email === lowerEmail)) {
                    // Employee exists but hasn't registered locally yet
                    showMessage('loginMessage', 'Account not found. Please create an account first.', 'error');
                } else {
                    showMessage('loginMessage', error.message || 'Invalid email or password', 'error');
                }
            } finally {
                setLoading('loginBtn', false);
                document.getElementById('loginBtn').textContent = 'Sign In';
            }
        }

        // Load authorized employees from org data
        let authorizedEmployees = [];
        
        async function loadAuthorizedEmployees() {
            try {
                // Try API first
                const response = await fetch(`${API_URL}/org/all`);
                if (response.ok) {
                    const contentType = response.headers.get('content-type');
                    if (contentType && contentType.includes('application/json')) {
                        const data = await response.json();
                        authorizedEmployees = (data.employees || [])
                            .filter(e => e.status === 'active' && e.email)
                            .map(e => ({
                                email: e.email.toLowerCase(),
                                name: e.name,
                                role: e.title || 'Employee'
                            }));
                        console.log(`Loaded ${authorizedEmployees.length} authorized employees`);
                        return;
                    }
                }
            } catch (e) {
                console.log('Could not load org data from API:', e.message);
            }
            
            // Fallback to localStorage
            try {
                const saved = localStorage.getItem('oith_org_data');
                if (saved) {
                    const orgData = JSON.parse(saved);
                    authorizedEmployees = (orgData.employees || [])
                        .filter(e => e.status === 'active' && e.email)
                        .map(e => ({
                            email: e.email.toLowerCase(),
                            name: e.name,
                            role: e.title || 'Employee'
                        }));
                }
            } catch (e) {
                console.log('No local org data found');
            }
        }
        
        function isAuthorizedEmployee(email) {
            const emailLower = email.toLowerCase();
            return authorizedEmployees.find(e => e.email === emailLower);
        }
        
        function checkEmployeeEmail(email) {
            const hint = document.getElementById('emailValidationHint');
            const nameField = document.getElementById('registerName');
            
            if (!email || email.length < 3) {
                hint.style.display = 'none';
                return;
            }
            
            const employee = isAuthorizedEmployee(email);
            hint.style.display = 'block';
            
            if (employee) {
                hint.innerHTML = `<span style="color: #10b981;">‚úì Recognized: ${employee.name || employee.email}</span>`;
                if (employee.name && nameField) {
                    nameField.value = employee.name;
                    nameField.readOnly = true;
                    nameField.style.opacity = '0.7';
                }
            } else {
                hint.innerHTML = `<span style="color: #f59e0b;">‚ö† Email not found in employee hierarchy</span>`;
                if (nameField) {
                    nameField.readOnly = false;
                    nameField.style.opacity = '1';
                }
            }
        }
        
        // Register Handler
        async function handleRegister(event) {
            event.preventDefault();
            
            const name = document.getElementById('registerName').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('registerConfirmPassword').value;
            const creatorToken = document.getElementById('registerToken').value;

            if (password !== confirmPassword) {
                showMessage('registerMessage', 'Passwords do not match', 'error');
                return;
            }

            if (password.length < 6) {
                showMessage('registerMessage', 'Password must be at least 6 characters', 'error');
                return;
            }

            // Check if email is from an authorized employee (unless they have admin token)
            const authorizedEmployee = isAuthorizedEmployee(email);
            if (!authorizedEmployee && !creatorToken) {
                showMessage('registerMessage', 'This email is not registered in the employee hierarchy. Only authorized employees can create accounts.', 'error');
                return;
            }

            const btn = document.getElementById('registerBtn');
            btn.dataset.originalText = btn.textContent;
            setLoading('registerBtn', true);

            try {
                const response = await fetch(`${API_URL}/auth/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        email, 
                        password, 
                        name: authorizedEmployee?.name || name, 
                        creatorToken,
                        role: authorizedEmployee?.role || 'admin'
                    })
                });

                const data = await parseJsonResponse(response);

                if (!response.ok) {
                    throw new Error(data.error || 'Registration failed');
                }

                showMessage('registerMessage', 'Account created successfully! You can now login.', 'success');
                
                setTimeout(() => {
                    showView('login');
                    document.getElementById('loginEmail').value = email;
                }, 2000);

            } catch (error) {
                // If API fails, save locally
                console.log('API registration failed, saving locally:', error.message);
                
                const lowerEmail = email.toLowerCase();
                const localUsers = JSON.parse(localStorage.getItem('oith_local_admins') || '{}');
                
                if (localUsers[lowerEmail]) {
                    showMessage('registerMessage', 'An account with this email already exists.', 'error');
                } else {
                    // Save user locally
                    localUsers[lowerEmail] = {
                        name: authorizedEmployee?.name || name,
                        email: lowerEmail,
                        passwordHash: simpleHash(password + 'oith'),
                        role: authorizedEmployee?.role || 'admin',
                        createdAt: new Date().toISOString()
                    };
                    localStorage.setItem('oith_local_admins', JSON.stringify(localUsers));
                    
                    showMessage('registerMessage', 'Account created successfully (offline mode)! You can now login.', 'success');
                    
                    setTimeout(() => {
                        showView('login');
                        document.getElementById('loginEmail').value = email;
                    }, 2000);
                }
            } finally {
                setLoading('registerBtn', false);
                document.getElementById('registerBtn').textContent = 'Create Account';
            }
        }

        // Forgot Password Handler
        async function handleForgotPassword(event) {
            event.preventDefault();
            
            const email = document.getElementById('forgotEmail').value;

            const btn = document.getElementById('forgotBtn');
            btn.dataset.originalText = btn.textContent;
            setLoading('forgotBtn', true);

            try {
                const response = await fetch(`${API_URL}/auth/forgot-password`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email })
                });

                const data = await parseJsonResponse(response);

                if (!response.ok) {
                    throw new Error(data.error || 'Request failed');
                }

                showMessage('forgotMessage', data.message, 'success');
                
                // In development, show the token for testing
                if (data._devToken) {
                    setTimeout(() => {
                        showView('resetPassword');
                        document.getElementById('resetToken').value = data._devToken;
                        showMessage('resetMessage', 'Dev mode: Token pre-filled for testing', 'success');
                    }, 2000);
                }

            } catch (error) {
                showMessage('forgotMessage', error.message, 'error');
            } finally {
                setLoading('forgotBtn', false);
                document.getElementById('forgotBtn').textContent = 'Send Reset Link';
            }
        }

        // Reset Password Handler
        async function handleResetPassword(event) {
            event.preventDefault();
            
            const token = document.getElementById('resetToken').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmNewPassword').value;

            if (newPassword !== confirmPassword) {
                showMessage('resetMessage', 'Passwords do not match', 'error');
                return;
            }

            if (newPassword.length < 6) {
                showMessage('resetMessage', 'Password must be at least 6 characters', 'error');
                return;
            }

            const btn = document.getElementById('resetBtn');
            btn.dataset.originalText = btn.textContent;
            setLoading('resetBtn', true);

            try {
                const response = await fetch(`${API_URL}/auth/reset-password`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token, newPassword })
                });

                const data = await parseJsonResponse(response);

                if (!response.ok) {
                    throw new Error(data.error || 'Reset failed');
                }

                showMessage('resetMessage', 'Password reset successfully! Redirecting to login...', 'success');
                
                setTimeout(() => {
                    showView('login');
                }, 2000);

            } catch (error) {
                showMessage('resetMessage', error.message, 'error');
            } finally {
                setLoading('resetBtn', false);
                document.getElementById('resetBtn').textContent = 'Reset Password';
            }
        }

        // Check for existing session on load
        document.addEventListener('DOMContentLoaded', async () => {
            // Detect which API to use (local or AWS)
            await detectApiUrl();
            
            // Load authorized employees for registration validation
            await loadAuthorizedEmployees();
            
            const token = localStorage.getItem('oith_admin_token') || sessionStorage.getItem('oith_admin_token');
            
            if (token) {
                // Validate token - but allow offline access if server unavailable
                try {
                    const response = await fetch(`${API_URL}/auth/validate`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    
                    if (response.ok) {
                        const contentType = response.headers.get('content-type');
                        if (contentType && contentType.includes('application/json')) {
                            const data = await response.json();
                            if (data.valid) {
                                window.location.href = 'manager.html';
                                return;
                            }
                        }
                    }
                    // Token invalid, clear storage
                    localStorage.removeItem('oith_admin_token');
                    localStorage.removeItem('oith_admin_user');
                    sessionStorage.removeItem('oith_admin_token');
                    sessionStorage.removeItem('oith_admin_user');
                } catch (e) {
                    // Server unavailable - validate token locally
                    try {
                        const payload = JSON.parse(atob(token));
                        // Check if token is less than 24 hours old
                        if (Date.now() - payload.timestamp < 24 * 60 * 60 * 1000) {
                            console.log('‚ö†Ô∏è Server unavailable, using cached session');
                            window.location.href = 'manager.html';
                            return;
                        }
                    } catch {
                        // Invalid token format
                    }
                    // Clear invalid token
                    localStorage.removeItem('oith_admin_token');
                    localStorage.removeItem('oith_admin_user');
                    sessionStorage.removeItem('oith_admin_token');
                    sessionStorage.removeItem('oith_admin_user');
                }
            }

            // Check for reset token in URL
            const urlParams = new URLSearchParams(window.location.search);
            const resetToken = urlParams.get('reset');
            if (resetToken) {
                showView('resetPassword');
                document.getElementById('resetToken').value = resetToken;
            }
        });
    </script>
</body>
</html>

