<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OITH Manager - Admin Dashboard</title>
    <!-- Using Segoe UI system font (Outlook style) -->
    <style>
        :root {
            /* Outlook Dark Theme Colors */
            --bg-primary: #1f1f1f;
            --bg-secondary: #2d2d2d;
            --bg-tertiary: #3d3d3d;
            --bg-card: #2d2d2d;
            --bg-panel: #252525;
            --bg-hover: #3a3a3a;
            --accent: #0078d4;
            --accent-light: #2899f5;
            --accent-dark: #005a9e;
            --success: #107c10;
            --warning: #ff8c00;
            --danger: #d13438;
            --info: #0078d4;
            --outlook-accent: #0078d4;
            --purple: #8764b8;
            --text-primary: #ffffff;
            --text-secondary: #d4d4d4;
            --text-muted: #8a8a8a;
            --border: #3d3d3d;
            --border-subtle: #333333;
            --radius: 4px;
            --radius-lg: 6px;
            --radius-xl: 8px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', 'Segoe UI Web', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            font-size: 14px;
            -webkit-font-smoothing: antialiased;
        }

        /* Header - Outlook Ribbon Style */
        .header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-subtle);
            padding: 0 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
            height: 48px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo-icon {
            width: 32px;
            height: 32px;
            background: var(--accent);
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .logo h1 {
            font-size: 14px;
            font-weight: 600;
            letter-spacing: -0.01em;
        }

        .logo-badge {
            background: var(--accent);
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 2px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .header-quick-actions {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-left: 12px;
            padding-left: 12px;
            border-left: 1px solid var(--border-subtle);
        }

        .header-icon-btn {
            position: relative;
            width: 36px;
            height: 36px;
            border-radius: 10px;
            border: none;
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.15), rgba(139, 92, 246, 0.05));
            color: var(--accent);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .header-icon-btn:hover {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.3), rgba(139, 92, 246, 0.15));
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
        }

        .header-icon-btn.mail-btn {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(59, 130, 246, 0.05));
            color: var(--info);
        }

        .header-icon-btn.mail-btn:hover {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.3), rgba(59, 130, 246, 0.15));
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .header-icon-btn.files-btn {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(16, 185, 129, 0.05));
            color: var(--success);
        }

        .header-icon-btn.files-btn:hover {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.3), rgba(16, 185, 129, 0.15));
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .calendar-badge, .mail-badge, .files-badge {
            position: absolute;
            top: -4px;
            right: -4px;
            min-width: 16px;
            height: 16px;
            background: var(--danger);
            color: white;
            font-size: 9px;
            font-weight: 700;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 4px;
            box-shadow: 0 2px 6px rgba(239, 68, 68, 0.4);
        }

        .calendar-badge:empty, .mail-badge:empty, .files-badge:empty,
        .calendar-badge[data-count="0"], .mail-badge[data-count="0"], .files-badge[data-count="0"] {
            display: none;
        }

        /* Admin Calendar Styles */
        .calendar-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.2s ease;
        }

        .calendar-modal.active {
            display: flex;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .calendar-container {
            background: var(--bg-secondary);
            border-radius: 20px;
            width: 95%;
            max-width: 1200px;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.6);
            display: flex;
            flex-direction: column;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .calendar-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 24px;
            background: linear-gradient(135deg, var(--bg-tertiary), var(--bg-secondary));
            border-bottom: 1px solid var(--border-subtle);
        }

        .calendar-title-area {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .calendar-title-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, var(--accent), #a855f7);
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 0 4px 16px rgba(139, 92, 246, 0.4);
        }

        .calendar-title h2 {
            margin: 0;
            font-size: 1.5rem;
            color: var(--text-primary);
            font-weight: 700;
        }

        .calendar-title p {
            margin: 4px 0 0;
            color: var(--text-muted);
            font-size: 0.85rem;
        }

        .calendar-nav {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .calendar-nav-btn {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            border: 1px solid var(--border);
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .calendar-nav-btn:hover {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        .calendar-month-display {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text-primary);
            min-width: 180px;
            text-align: center;
        }

        .calendar-today-btn {
            padding: 8px 16px;
            border-radius: 10px;
            border: 1px solid var(--accent);
            background: transparent;
            color: var(--accent);
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .calendar-today-btn:hover {
            background: var(--accent);
            color: white;
        }

        .calendar-close-btn {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            border: none;
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            margin-left: 16px;
        }

        .calendar-close-btn:hover {
            background: var(--danger);
            color: white;
        }

        .calendar-body {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .calendar-main {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .calendar-weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
            margin-bottom: 8px;
        }

        .calendar-weekday {
            text-align: center;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 8px 0;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
        }

        .calendar-day {
            aspect-ratio: 1;
            min-height: 80px;
            background: var(--bg-tertiary);
            border-radius: 12px;
            padding: 8px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }

        .calendar-day:hover {
            background: rgba(139, 92, 246, 0.1);
            transform: scale(1.02);
        }

        .calendar-day.other-month {
            opacity: 0.3;
        }

        .calendar-day.today {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.2), rgba(139, 92, 246, 0.1));
            border: 2px solid var(--accent);
        }

        .calendar-day.selected {
            background: var(--accent);
        }

        .calendar-day.selected .day-number {
            color: white;
        }

        .day-number {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .day-events {
            margin-top: 4px;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .day-event {
            font-size: 0.65rem;
            padding: 2px 4px;
            border-radius: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-weight: 500;
        }

        .day-event.payroll { background: rgba(34, 197, 94, 0.2); color: #22c55e; }
        .day-event.report { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
        .day-event.experiment { background: rgba(59, 130, 246, 0.2); color: #3b82f6; }
        .day-event.compliance { background: rgba(249, 115, 22, 0.2); color: #f97316; }
        .day-event.meeting { background: rgba(139, 92, 246, 0.2); color: #8b5cf6; }
        .day-event.tax { background: rgba(236, 72, 153, 0.2); color: #ec4899; }
        .day-event.milestone { background: rgba(14, 165, 233, 0.2); color: #0ea5e9; }
        .day-event.patent { background: rgba(168, 85, 247, 0.2); color: #a855f7; }

        .day-event-count {
            font-size: 0.6rem;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .calendar-sidebar {
            width: 320px;
            background: var(--bg-tertiary);
            border-left: 1px solid var(--border-subtle);
            padding: 20px;
            overflow-y: auto;
        }

        .sidebar-section {
            margin-bottom: 24px;
        }

        .sidebar-section-title {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .upcoming-event {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 8px;
            border-left: 3px solid var(--accent);
            transition: all 0.2s;
            cursor: pointer;
        }

        .upcoming-event:hover {
            transform: translateX(4px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .upcoming-event.payroll { border-left-color: #22c55e; }
        .upcoming-event.report { border-left-color: #ef4444; }
        .upcoming-event.experiment { border-left-color: #3b82f6; }
        .upcoming-event.compliance { border-left-color: #f97316; }
        .upcoming-event.meeting { border-left-color: #8b5cf6; }
        .upcoming-event.tax { border-left-color: #ec4899; }
        .upcoming-event.milestone { border-left-color: #0ea5e9; }
        .upcoming-event.patent { border-left-color: #a855f7; }

        .event-title {
            font-weight: 600;
            font-size: 0.85rem;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .event-meta {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .event-category {
            font-size: 0.65rem;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .legend-items {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .legend-dot {
            width: 10px;
            height: 10px;
            border-radius: 3px;
        }

        .legend-dot.payroll { background: #22c55e; }
        .legend-dot.report { background: #ef4444; }
        .legend-dot.experiment { background: #3b82f6; }
        .legend-dot.compliance { background: #f97316; }
        .legend-dot.meeting { background: #8b5cf6; }
        .legend-dot.tax { background: #ec4899; }
        .legend-dot.milestone { background: #0ea5e9; }
        .legend-dot.patent { background: #a855f7; }

        .add-event-btn {
            width: 100%;
            padding: 12px;
            border-radius: 12px;
            border: 2px dashed var(--border);
            background: transparent;
            color: var(--text-muted);
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .add-event-btn:hover {
            border-color: var(--accent);
            color: var(--accent);
            background: rgba(139, 92, 246, 0.05);
        }

        /* Meeting Scheduler Modal Styles */
        .meeting-scheduler-modal {
            max-width: 900px !important;
            width: 95% !important;
            max-height: 92vh;
            padding: 0;
            overflow: hidden;
            border-radius: 20px;
            background: var(--bg-secondary);
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.6), 0 0 60px rgba(139, 92, 246, 0.15);
        }

        .scheduler-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.15), rgba(59, 130, 246, 0.1));
            border-bottom: 1px solid var(--border);
        }

        .scheduler-header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .scheduler-icon {
            font-size: 2rem;
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.2), rgba(59, 130, 246, 0.2));
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .scheduler-header h2 {
            margin: 0;
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .scheduler-header p {
            margin: 4px 0 0;
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .scheduler-close-btn {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            border: none;
            background: var(--bg-tertiary);
            color: var(--text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .scheduler-close-btn:hover {
            background: var(--danger);
            color: white;
        }

        /* Next Steps Clickable Items */
        .next-step-schedulable:hover {
            background: var(--bg-tertiary) !important;
            transform: translateX(4px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .next-step-schedulable:hover .next-step-schedule-btn {
            opacity: 1 !important;
            color: var(--accent-light);
        }

        .next-step-schedulable:active {
            transform: translateX(2px);
            background: var(--bg-hover) !important;
        }

        .next-step-schedule-btn svg {
            transition: transform 0.2s ease;
        }

        .next-step-schedulable:hover .next-step-schedule-btn svg {
            transform: scale(1.1);
        }

        .scheduler-body {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0;
            max-height: calc(92vh - 180px);
            overflow-y: auto;
        }

        @media (max-width: 768px) {
            .scheduler-body {
                grid-template-columns: 1fr;
            }
        }

        .scheduler-column {
            padding: 24px;
        }

        .scheduler-column:first-child {
            border-right: 1px solid var(--border);
        }

        .scheduler-section {
            margin-bottom: 24px;
        }

        .scheduler-section:last-child {
            margin-bottom: 0;
        }

        .scheduler-section-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 16px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border);
        }

        .scheduler-section-title svg {
            color: var(--accent);
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }

        @media (max-width: 500px) {
            .form-row {
                grid-template-columns: 1fr;
            }
        }

        /* Zoom Connection Styles */
        .zoom-status {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            background: var(--bg-tertiary);
            border-radius: 12px;
            margin-bottom: 16px;
        }

        .zoom-status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .zoom-status-indicator.connected {
            background: var(--success);
            box-shadow: 0 0 10px rgba(34, 197, 94, 0.5);
        }

        .zoom-status-indicator.disconnected {
            background: var(--text-muted);
            animation: none;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .zoom-status span {
            flex: 1;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .zoom-connected-info {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.1), rgba(34, 197, 94, 0.05));
            border-radius: 12px;
            border: 1px solid rgba(34, 197, 94, 0.2);
            margin-bottom: 16px;
        }

        .zoom-avatar {
            width: 44px;
            height: 44px;
            background: var(--bg-tertiary);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
        }

        .zoom-user-name {
            font-weight: 600;
            font-size: 0.95rem;
            color: var(--text-primary);
        }

        .zoom-user-email {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .zoom-connected-info .btn {
            margin-left: auto;
        }

        .zoom-id-row {
            display: flex;
            gap: 8px;
        }

        .zoom-id-row .form-control {
            flex: 1;
            font-family: 'JetBrains Mono', monospace;
            letter-spacing: 1px;
        }

        .zoom-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 12px;
            background: var(--bg-tertiary);
            border-radius: 10px;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.85rem;
            color: var(--text-secondary);
            cursor: pointer;
        }

        .checkbox-label input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: var(--accent);
        }

        /* Invite Tabs & Panel */
        .invite-tabs {
            display: flex;
            gap: 4px;
            background: var(--bg-tertiary);
            padding: 4px;
            border-radius: 10px;
            margin-bottom: 16px;
        }

        .invite-tab {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px 16px;
            border: none;
            background: transparent;
            color: var(--text-muted);
            font-size: 0.85rem;
            font-weight: 500;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .invite-tab:hover {
            color: var(--text-primary);
        }

        .invite-tab.active {
            background: var(--accent);
            color: white;
        }

        .invite-panel {
            margin-bottom: 16px;
        }

        .invite-input-row {
            display: flex;
            gap: 8px;
        }

        .invite-input-row .form-control {
            flex: 1;
        }

        .invitees-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 180px;
            overflow-y: auto;
        }

        .invitee-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 12px;
            background: var(--bg-tertiary);
            border-radius: 10px;
            animation: slideIn 0.2s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-10px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .invitee-icon {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
        }

        .invitee-icon.email {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(59, 130, 246, 0.1));
            color: var(--info);
        }

        .invitee-icon.phone {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.2), rgba(34, 197, 94, 0.1));
            color: var(--success);
        }

        .invitee-details {
            flex: 1;
        }

        .invitee-value {
            font-size: 0.9rem;
            color: var(--text-primary);
            font-weight: 500;
        }

        .invitee-type {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .invitee-remove {
            width: 28px;
            height: 28px;
            border-radius: 8px;
            border: none;
            background: transparent;
            color: var(--text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .invitee-remove:hover {
            background: rgba(239, 68, 68, 0.15);
            color: var(--danger);
        }

        .invitees-count {
            padding: 10px 0;
            font-size: 0.85rem;
            color: var(--text-muted);
            text-align: center;
            border-top: 1px solid var(--border);
            margin-top: 12px;
        }

        .invitees-count span {
            font-weight: 600;
            color: var(--accent);
        }

        .scheduler-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 24px;
            background: var(--bg-tertiary);
            border-top: 1px solid var(--border);
        }

        .scheduler-footer-right {
            display: flex;
            gap: 12px;
        }

        .btn-outline {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-secondary);
        }

        .btn-outline:hover {
            border-color: var(--accent);
            color: var(--accent);
            background: rgba(139, 92, 246, 0.05);
        }

        .btn-sm {
            padding: 8px 12px;
            font-size: 0.8rem;
        }

        /* Preview Email Styles */
        .preview-email-container {
            background: var(--bg-tertiary);
            border-radius: 12px;
            padding: 20px;
            font-size: 0.9rem;
        }

        .preview-email-header {
            display: flex;
            align-items: center;
            gap: 12px;
            padding-bottom: 16px;
            margin-bottom: 16px;
            border-bottom: 1px solid var(--border);
        }

        .preview-email-icon {
            font-size: 2rem;
        }

        .preview-email-subject {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .preview-email-from {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .preview-meeting-details {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .preview-detail-row {
            display: flex;
            gap: 12px;
        }

        .preview-detail-label {
            width: 100px;
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .preview-detail-value {
            flex: 1;
            color: var(--text-primary);
        }

        .preview-zoom-box {
            margin-top: 16px;
            padding: 16px;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(59, 130, 246, 0.05));
            border-radius: 10px;
            border-left: 3px solid var(--info);
        }

        .preview-zoom-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--info);
        }

        .preview-zoom-link {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
            color: var(--text-secondary);
            word-break: break-all;
        }

        /* Event Details Modal Styles */
        .event-details-modal {
            max-width: 900px !important;
            width: 95% !important;
            max-height: 85vh;
            padding: 0;
            overflow: hidden;
            border-radius: 16px;
            font-size: 0.82rem;
        }

        .event-details-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 18px;
            border-bottom: 1px solid var(--border);
        }
        
        .event-details-header h2 {
            font-size: 1.1rem;
            margin: 0;
        }
        
        .event-details-header p {
            font-size: 0.75rem;
            margin: 2px 0 0 0;
        }
        
        .event-details-body {
            padding: 16px 18px;
            max-height: 60vh;
            overflow-y: auto;
        }
        
        .event-detail-row {
            display: flex;
            gap: 12px;
            padding: 10px 0;
            border-bottom: 1px solid var(--border-light, rgba(255,255,255,0.05));
        }
        
        .event-detail-row:last-child {
            border-bottom: none;
        }
        
        .event-detail-icon {
            font-size: 1rem;
            width: 24px;
            text-align: center;
            flex-shrink: 0;
        }
        
        .event-detail-content {
            flex: 1;
        }
        
        .event-detail-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 2px;
        }
        
        .event-detail-value {
            font-size: 0.82rem;
            color: var(--text-primary);
        }
        
        .event-notes-section {
            background: var(--bg-tertiary);
            border-radius: 10px;
            padding: 14px;
            margin-top: 12px;
        }
        
        .event-notes-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
            font-weight: 600;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }
        
        .event-notes-content {
            font-size: 0.78rem;
            line-height: 1.5;
            color: var(--text-primary);
        }
        
        .event-notes-content ul {
            margin: 8px 0;
            padding-left: 18px;
        }
        
        .event-notes-content li {
            margin-bottom: 6px;
        }
        
        .event-notes-content .sub-requirement {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            padding: 6px 0;
            border-bottom: 1px dashed var(--border-light, rgba(255,255,255,0.08));
        }
        
        .event-notes-content .sub-requirement:last-child {
            border-bottom: none;
        }
        
        .event-notes-content .sub-req-status {
            font-size: 0.9rem;
            flex-shrink: 0;
        }
        
        .event-notes-content .sub-req-text {
            flex: 1;
        }
        
        .event-notes-content .sub-req-time {
            font-size: 0.7rem;
            color: var(--text-muted);
            white-space: nowrap;
        }
        
        .event-details-footer {
            padding: 12px 18px;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 8px;
        }
        
        .event-details-footer .btn {
            font-size: 0.78rem;
            padding: 8px 14px;
        }

        .event-details-header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .event-details-icon {
            font-size: 1.5rem;
            width: 44px;
            height: 44px;
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.2), rgba(59, 130, 246, 0.15));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .event-details-header h2 {
            margin: 0;
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .event-details-header p {
            margin: 3px 0 0;
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: capitalize;
        }

        .event-details-body {
            padding: 16px 20px;
            max-height: 500px;
            overflow-y: auto;
        }

        .event-detail-row {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 10px 0;
            border-bottom: 1px solid var(--border);
        }

        .event-detail-row:last-child {
            border-bottom: none;
        }

        .event-detail-icon {
            width: 32px;
            height: 32px;
            background: var(--bg-tertiary);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            color: var(--text-muted);
            font-size: 0.9rem;
        }
        
        .event-notes-section {
            margin-top: 16px;
            padding: 14px;
            background: var(--bg-tertiary);
            border-radius: 10px;
            border: 1px solid var(--border);
        }
        
        .event-notes-section h4 {
            margin: 0 0 10px;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .event-notes-content {
            font-size: 0.8rem;
            color: var(--text-secondary);
            line-height: 1.6;
        }
        
        .event-notes-content ul {
            margin: 8px 0;
            padding-left: 20px;
        }
        
        .event-notes-content li {
            margin: 4px 0;
        }
        
        .event-notes-content .sub-requirement {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            padding: 6px 0;
            border-bottom: 1px dashed var(--border);
        }
        
        .event-notes-content .sub-requirement:last-child {
            border-bottom: none;
        }
        
        .sub-requirement-check {
            color: var(--success);
            font-size: 0.75rem;
        }
        
        .sub-requirement-pending {
            color: var(--warning);
            font-size: 0.75rem;
        }
        
        .event-time-estimate {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            background: rgba(59, 130, 246, 0.1);
            border-radius: 4px;
            font-size: 0.7rem;
            color: var(--info);
            margin-left: 8px;
        }

        .event-detail-content {
            flex: 1;
        }

        .event-detail-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        .event-detail-value {
            font-size: 0.95rem;
            color: var(--text-primary);
            line-height: 1.5;
        }

        .event-details-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 24px;
            background: var(--bg-tertiary);
            border-top: 1px solid var(--border);
        }

        .event-details-footer-left {
            display: flex;
            gap: 8px;
        }

        .event-details-footer-right {
            display: flex;
            gap: 12px;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
            border: none;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        /* Share Options Grid */
        .share-options {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }

        .share-option-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            padding: 16px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--text-secondary);
        }

        .share-option-btn:hover {
            background: var(--bg-secondary);
            border-color: var(--accent);
            color: var(--accent);
        }

        .share-option-btn span {
            font-size: 0.8rem;
            font-weight: 500;
        }

        /* Category Colors for Event Header */
        .event-details-header.meeting { background: linear-gradient(135deg, rgba(139, 92, 246, 0.15), rgba(139, 92, 246, 0.05)); }
        .event-details-header.payroll { background: linear-gradient(135deg, rgba(34, 197, 94, 0.15), rgba(34, 197, 94, 0.05)); }
        .event-details-header.tax { background: linear-gradient(135deg, rgba(236, 72, 153, 0.15), rgba(236, 72, 153, 0.05)); }

        /* Model Editor Modal Styles */
        .model-editor-modal {
            max-width: 600px !important;
            width: 95% !important;
            max-height: 90vh;
            padding: 0;
            overflow: hidden;
            border-radius: 20px;
        }

        .model-editor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.15), rgba(59, 130, 246, 0.1));
            border-bottom: 1px solid var(--border);
        }

        .model-editor-header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .model-editor-icon {
            font-size: 2rem;
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.2), rgba(59, 130, 246, 0.2));
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .model-editor-header h2 {
            margin: 0;
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .model-editor-header p {
            margin: 4px 0 0;
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .model-editor-body {
            padding: 24px;
            max-height: calc(90vh - 180px);
            overflow-y: auto;
        }

        .model-editor-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 24px;
            background: var(--bg-tertiary);
            border-top: 1px solid var(--border);
        }

        .model-editor-footer-left {
            display: flex;
            gap: 8px;
        }

        .model-editor-footer-right {
            display: flex;
            gap: 12px;
        }

        .model-advanced-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px;
            background: var(--bg-tertiary);
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-top: 16px;
            transition: all 0.2s;
        }

        .model-advanced-toggle:hover {
            background: var(--bg-secondary);
            color: var(--accent);
        }

        .model-advanced-toggle.open svg {
            transform: rotate(180deg);
        }

        #modelAdvancedSettings {
            padding-top: 16px;
            margin-top: 16px;
            border-top: 1px dashed var(--border);
        }

        /* Model Action Buttons in Table */
        .model-actions {
            display: flex;
            gap: 6px;
            justify-content: center;
        }

        .model-action-btn {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: var(--bg-tertiary);
            color: var(--text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .model-action-btn:hover {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
        }

        .model-action-btn.delete:hover {
            background: var(--danger);
            border-color: var(--danger);
        }

        /* Model Status Colors */
        .model-type-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .model-type-badge.scoring { background: rgba(59, 130, 246, 0.2); color: #60a5fa; }
        .model-type-badge.filter { background: rgba(34, 197, 94, 0.2); color: #4ade80; }
        .model-type-badge.llm { background: rgba(249, 115, 22, 0.2); color: #fb923c; }
        .model-type-badge.heuristic { background: rgba(236, 72, 153, 0.2); color: #f472b6; }
        .model-type-badge.similarity { background: rgba(168, 85, 247, 0.2); color: #c084fc; }
        .model-type-badge.template { background: rgba(20, 184, 166, 0.2); color: #2dd4bf; }
        .model-type-badge.neural { background: rgba(139, 92, 246, 0.2); color: #a78bfa; }
        .model-type-badge.default { background: rgba(107, 114, 128, 0.2); color: #9ca3af; }
        .event-details-header.compliance { background: linear-gradient(135deg, rgba(249, 115, 22, 0.15), rgba(249, 115, 22, 0.05)); }
        .event-details-header.milestone { background: linear-gradient(135deg, rgba(14, 165, 233, 0.15), rgba(14, 165, 233, 0.05)); }
        .event-details-header.patent { background: linear-gradient(135deg, rgba(168, 85, 247, 0.15), rgba(168, 85, 247, 0.05)); }
        .event-details-header.report { background: linear-gradient(135deg, rgba(239, 68, 68, 0.15), rgba(239, 68, 68, 0.05)); }
        .event-details-header.experiment { background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(59, 130, 246, 0.05)); }

        /* Mail Client Placeholder */
        .mail-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .mail-modal.active {
            display: flex;
        }

        .mail-container {
            background: var(--bg-secondary);
            border-radius: 20px;
            width: 95%;
            max-width: 900px;
            max-height: 85vh;
            overflow: hidden;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.6);
            animation: slideUp 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .mail-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 24px;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(59, 130, 246, 0.05));
            border-bottom: 1px solid var(--border-subtle);
        }

        .mail-title-area {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .mail-icon-large {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, var(--info), #0ea5e9);
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 0 4px 16px rgba(59, 130, 246, 0.4);
        }

        .mail-title h2 {
            margin: 0;
            font-size: 1.4rem;
            color: var(--text-primary);
        }

        .mail-title p {
            margin: 4px 0 0;
            color: var(--text-muted);
            font-size: 0.85rem;
        }

        .mail-body {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .mail-sidebar {
            width: 200px;
            background: var(--bg-tertiary);
            border-right: 1px solid var(--border-subtle);
            padding: 16px;
        }

        .mail-folder {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            border-radius: 8px;
            cursor: pointer;
            color: var(--text-secondary);
            margin-bottom: 4px;
            transition: all 0.2s;
        }

        .mail-folder:hover {
            background: rgba(59, 130, 246, 0.1);
        }

        .mail-folder.active {
            background: var(--info);
            color: white;
        }

        .mail-folder-count {
            margin-left: auto;
            background: rgba(239, 68, 68, 0.2);
            color: var(--danger);
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 10px;
            font-weight: 600;
        }

        .mail-folder.active .mail-folder-count {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .mail-list {
            width: 320px;
            border-right: 1px solid var(--border-subtle);
            overflow-y: auto;
        }

        .mail-list-header {
            padding: 16px;
            border-bottom: 1px solid var(--border-subtle);
            font-weight: 600;
            color: var(--text-primary);
        }

        .mail-item {
            padding: 14px 16px;
            border-bottom: 1px solid var(--border-subtle);
            cursor: pointer;
            transition: all 0.2s;
        }

        .mail-item:hover {
            background: rgba(59, 130, 246, 0.05);
        }

        .mail-item.active {
            background: rgba(59, 130, 246, 0.1);
            border-left: 3px solid var(--info);
        }

        .mail-item.unread {
            background: rgba(59, 130, 246, 0.08);
        }

        .mail-item.unread .mail-item-subject {
            font-weight: 700;
            color: var(--text-primary);
        }

        .mail-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }

        .mail-item-from {
            font-weight: 600;
            font-size: 0.85rem;
            color: var(--text-primary);
        }

        .mail-item-time {
            font-size: 0.7rem;
            color: var(--text-muted);
        }

        .mail-item-subject {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .mail-item-preview {
            font-size: 0.75rem;
            color: var(--text-muted);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .mail-content {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
        }

        .mail-content-empty {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-muted);
        }

        .mail-content-empty svg {
            width: 64px;
            height: 64px;
            margin-bottom: 16px;
            opacity: 0.3;
        }

        .mail-view-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border-subtle);
        }

        .mail-view-subject {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .mail-view-meta {
            display: flex;
            align-items: center;
            gap: 12px;
            color: var(--text-muted);
            font-size: 0.85rem;
        }

        .mail-view-body {
            color: var(--text-secondary);
            line-height: 1.7;
            white-space: pre-wrap;
        }

        .mail-actions {
            display: flex;
            gap: 8px;
        }

        .mail-action-btn {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .mail-action-btn:hover {
            background: var(--info);
            color: white;
            border-color: var(--info);
        }

        .mail-action-btn.danger:hover {
            background: var(--danger);
            border-color: var(--danger);
        }

        .reply-form {
            margin-top: 24px;
            padding-top: 20px;
            border-top: 1px solid var(--border-subtle);
        }

        .reply-form textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 10px;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            resize: vertical;
            min-height: 100px;
            margin-bottom: 12px;
        }

        /* File Storage Modal */
        .file-storage-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .file-storage-modal.active {
            display: flex;
        }

        .file-storage-container {
            background: var(--bg-secondary);
            border-radius: 20px;
            width: 95%;
            max-width: 1200px;
            max-height: 85vh;
            overflow: hidden;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.6);
            animation: slideUp 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .file-storage-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 24px;
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(16, 185, 129, 0.05));
            border-bottom: 1px solid var(--border-subtle);
        }

        .file-storage-title-area {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .file-storage-icon-large {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, var(--success), #059669);
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 0 4px 16px rgba(16, 185, 129, 0.4);
        }

        .file-storage-title h2 {
            margin: 0;
            font-size: 1.4rem;
            color: var(--text-primary);
        }

        .file-storage-title p {
            margin: 4px 0 0;
            color: var(--text-muted);
            font-size: 0.85rem;
        }

        .file-storage-body {
            display: flex;
            flex: 1;
            overflow: hidden;
            height: calc(85vh - 100px);
        }

        .file-storage-sidebar {
            width: 200px;
            background: var(--bg-tertiary);
            border-right: 1px solid var(--border-subtle);
            padding: 16px;
            overflow-y: auto;
        }

        .file-folder {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            border-radius: 8px;
            cursor: pointer;
            color: var(--text-secondary);
            margin-bottom: 4px;
            transition: all 0.2s;
            font-size: 0.85rem;
        }

        .file-folder:hover {
            background: rgba(16, 185, 129, 0.1);
        }

        .file-folder.active {
            background: var(--success);
            color: white;
        }

        .file-folder-count {
            margin-left: auto;
            background: rgba(16, 185, 129, 0.2);
            color: var(--success);
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 10px;
            font-weight: 600;
        }

        .file-folder.active .file-folder-count {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .file-list {
            flex: 1;
            border-right: 1px solid var(--border-subtle);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .file-list-header {
            padding: 16px;
            border-bottom: 1px solid var(--border-subtle);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .file-list-header span {
            font-weight: 600;
            color: var(--text-primary);
        }

        .file-item {
            padding: 14px 16px;
            border-bottom: 1px solid var(--border-subtle);
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .file-item:hover {
            background: rgba(16, 185, 129, 0.05);
        }

        .file-item.active {
            background: rgba(16, 185, 129, 0.1);
            border-left: 3px solid var(--success);
        }

        .file-item-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            background: var(--bg-tertiary);
        }

        .file-item-info {
            flex: 1;
            min-width: 0;
        }

        .file-item-name {
            font-weight: 500;
            font-size: 0.9rem;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .file-item-meta {
            display: flex;
            gap: 8px;
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .file-preview {
            width: 320px;
            overflow-y: auto;
            background: var(--bg-primary);
        }

        .file-preview-empty {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-muted);
            padding: 20px;
            text-align: center;
        }

        .file-preview-content {
            padding: 20px;
        }

        .file-preview-header {
            padding: 20px;
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border-subtle);
        }

        .file-preview-icon {
            width: 64px;
            height: 64px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            background: var(--bg-secondary);
            margin-bottom: 12px;
        }

        .file-preview-name {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
            word-break: break-word;
        }

        .file-preview-details {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .file-preview-actions {
            display: flex;
            gap: 8px;
            margin-top: 16px;
        }

        .file-preview-section {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-subtle);
        }

        .file-preview-section-title {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            margin-bottom: 8px;
        }

        .file-tag {
            display: inline-block;
            padding: 4px 10px;
            background: var(--bg-tertiary);
            border-radius: 12px;
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin: 2px;
        }

        .admin-profile-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: var(--bg-tertiary);
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-left: 8px;
        }

        .admin-profile-btn:hover {
            background: var(--bg-hover);
        }

        .admin-avatar {
            width: 28px;
            height: 28px;
            background: linear-gradient(135deg, var(--accent), #8b5cf6);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        .admin-name {
            font-size: 13px;
            color: var(--text-secondary);
            max-width: 100px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .header-center {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .live-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            background: transparent;
            border: none;
            font-size: 12px;
            color: var(--success);
        }

        .live-dot {
            width: 6px;
            height: 6px;
            background: var(--success);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .aws-sync-meta {
            display: flex;
            flex-direction: column;
            gap: 1px;
            margin-left: 8px;
            font-size: 11px;
            color: var(--text-muted);
        }

        .aws-sync-line {
            display: flex;
            align-items: center;
            gap: 4px;
            white-space: nowrap;
        }

        .aws-sync-label {
            color: var(--text-muted);
            font-weight: 400;
        }

        .aws-status {
            color: var(--text-secondary);
        }

        .aws-status.success {
            color: var(--success);
        }

        .aws-status.error {
            color: var(--danger);
        }

        .aws-status.muted {
            color: var(--text-muted);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .header-actions {
            display: flex;
            gap: 4px;
        }

        .btn {
            padding: 6px 12px;
            border-radius: var(--radius);
            font-size: 12px;
            font-weight: 400;
            cursor: pointer;
            transition: background 0.1s;
            border: none;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .btn-primary {
            background: var(--accent);
            color: white;
        }

        .btn-primary:hover {
            background: var(--accent-light);
        }

        .btn-secondary {
            background: transparent;
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--bg-hover);
        }

        .btn-icon {
            width: 32px;
            height: 32px;
            padding: 0;
            justify-content: center;
            border-radius: var(--radius);
            background: transparent;
            border: none;
        }

        .btn-icon:hover {
            background: var(--bg-hover);
        }

        /* Main Layout */
        .main-container {
            display: flex;
            margin-top: 48px;
            min-height: calc(100vh - 48px);
        }

        /* Sidebar - Outlook Folder Pane Style */
        .sidebar {
            width: 220px;
            background: var(--bg-panel);
            border-right: 1px solid var(--border-subtle);
            padding: 8px 0;
            flex-shrink: 0;
            position: fixed;
            top: 48px;
            left: 0;
            bottom: 0;
            overflow-y: auto;
        }

        .nav-section {
            margin-bottom: 4px;
        }

        .nav-section-title {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: none;
            letter-spacing: 0;
            padding: 8px 12px 4px;
            margin-bottom: 0;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: background 0.1s;
            border-left: 2px solid transparent;
            font-size: 13px;
            margin: 0 4px;
            border-radius: var(--radius);
        }

        .nav-item:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .nav-item.active {
            background: rgba(0, 120, 212, 0.15);
            color: var(--text-primary);
            border-left-color: var(--accent);
        }

        .nav-item svg {
            width: 16px;
            height: 16px;
            flex-shrink: 0;
            opacity: 0.8;
        }

        .nav-item .nav-badge {
            margin-left: auto;
            background: transparent;
            color: var(--accent);
            font-size: 11px;
            padding: 0;
            font-weight: 400;
        }

        .nav-item .nav-badge::before {
            content: '[';
        }

        .nav-item .nav-badge::after {
            content: ']';
        }

        /* Health indicator dots for nav items */
        .nav-item .health-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-left: auto;
            flex-shrink: 0;
            transition: all 0.3s ease;
            opacity: 0;
        }
        
        .nav-item .health-indicator.visible {
            opacity: 1;
        }
        
        .nav-item .health-indicator.green {
            background: var(--success);
            box-shadow: 0 0 6px var(--success);
        }
        
        .nav-item .health-indicator.yellow {
            background: var(--warning);
            box-shadow: 0 0 6px var(--warning);
            animation: healthPulse 1.5s ease-in-out infinite;
        }
        
        .nav-item .health-indicator.red {
            background: var(--danger);
            box-shadow: 0 0 8px var(--danger);
            animation: healthPulse 1s ease-in-out infinite;
        }
        
        .nav-item .health-indicator.gray {
            background: var(--text-muted);
            opacity: 0.5;
        }
        
        @keyframes healthPulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(0.85); }
        }
        
        /* Health tooltip */
        .nav-item {
            position: relative;
        }
        
        .nav-item .health-tooltip {
            display: none;
            position: absolute;
            left: 100%;
            top: 50%;
            transform: translateY(-50%);
            margin-left: 10px;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 8px 12px;
            font-size: 11px;
            white-space: nowrap;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            min-width: 180px;
        }
        
        .nav-item:hover .health-tooltip {
            display: block;
        }
        
        /* Expense detail cards */
        .expense-detail-card {
            transition: all 0.2s ease;
            position: relative;
        }
        
        .expense-detail-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }
        
        .expense-detail-card .click-hint {
            font-size: 0.65rem;
            color: var(--text-muted);
            opacity: 0;
            transition: opacity 0.2s ease;
            margin-top: 4px;
        }
        
        .expense-detail-card:hover .click-hint {
            opacity: 1;
        }
        
        /* Expense detail modal */
        .expense-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: modalFadeIn 0.2s ease;
        }
        
        @keyframes modalFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .expense-modal-content {
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 16px;
            width: 90%;
            max-width: 700px;
            max-height: 80vh;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            animation: modalSlideIn 0.3s ease;
        }
        
        @keyframes modalSlideIn {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .expense-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
            background: linear-gradient(135deg, var(--bg-secondary), var(--bg-tertiary));
        }
        
        .expense-modal-header h3 {
            margin: 0;
            font-size: 1.25rem;
            font-weight: 600;
        }
        
        .expense-modal-close {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 4px 12px;
            border-radius: 8px;
            transition: all 0.2s ease;
        }
        
        .expense-modal-close:hover {
            background: var(--danger);
            color: white;
        }
        
        .expense-modal-body {
            padding: 24px;
            overflow-y: auto;
            max-height: calc(80vh - 80px);
        }
        
        .expense-modal-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .expense-modal-stat {
            padding: 16px;
            background: var(--bg-tertiary);
            border-radius: 12px;
            text-align: center;
        }
        
        .expense-modal-stat .value {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 4px;
        }
        
        .expense-modal-stat .label {
            font-size: 0.75rem;
            color: var(--text-muted);
        }
        
        .expense-modal-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .expense-modal-table th,
        .expense-modal-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }
        
        .expense-modal-table th {
            background: var(--bg-tertiary);
            font-weight: 600;
            font-size: 0.8rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }
        
        .expense-modal-table tr:hover td {
            background: rgba(139, 92, 246, 0.1);
        }
        
        .expense-modal-table .amount {
            font-weight: 600;
            font-family: 'JetBrains Mono', monospace;
        }
        
        .expense-modal-section {
            margin-bottom: 20px;
        }
        
        .expense-modal-section h4 {
            margin: 0 0 12px 0;
            font-size: 0.9rem;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .health-tooltip-row {
            display: flex;
            justify-content: space-between;
            margin: 2px 0;
            gap: 12px;
        }
        
        .health-tooltip-label {
            color: var(--text-muted);
        }
        
        .health-tooltip-value {
            color: var(--text-primary);
            font-weight: 500;
        }
        
        .health-tooltip-value.good { color: var(--success); }
        .health-tooltip-value.warn { color: var(--warning); }
        .health-tooltip-value.bad { color: var(--danger); }

        /* Content - Outlook Reading Pane Style */
        .content {
            flex: 1;
            padding: 20px;
            margin-left: 220px;
            overflow-y: auto;
            background: var(--bg-primary);
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border-subtle);
        }

        .page-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .page-subtitle {
            color: var(--text-muted);
            font-size: 12px;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: var(--bg-card);
            border-radius: var(--radius);
            padding: 16px;
            border: 1px solid var(--border-subtle);
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
        }

        .stat-card.users::before { background: var(--accent); }
        .stat-card.matches::before { background: var(--accent); }
        .stat-card.messages::before { background: var(--success); }
        .stat-card.dates::before { background: var(--purple); }
        .stat-card.revenue::before { background: var(--warning); }
        .stat-card.safety::before { background: var(--danger); }

        .stat-card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .stat-icon {
            width: 32px;
            height: 32px;
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        .stat-icon.users { background: rgba(0, 120, 212, 0.15); }
        .stat-icon.matches { background: rgba(0, 120, 212, 0.15); }
        .stat-icon.messages { background: rgba(16, 124, 16, 0.15); }
        .stat-icon.dates { background: rgba(135, 100, 184, 0.15); }
        .stat-icon.revenue { background: rgba(255, 140, 0, 0.15); }
        .stat-icon.safety { background: rgba(209, 52, 56, 0.15); }

        .stat-change {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 2px;
            font-weight: 400;
        }

        .stat-change.positive {
            background: rgba(16, 124, 16, 0.15);
            color: var(--success);
        }

        .stat-change.negative {
            background: rgba(209, 52, 56, 0.15);
            color: var(--danger);
        }

        .stat-value {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 2px;
            font-family: 'Segoe UI', sans-serif;
        }

        .stat-label {
            color: var(--text-muted);
            font-size: 11px;
        }

        /* Cards Grid */
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .cards-grid.three {
            grid-template-columns: repeat(3, 1fr);
        }

        .card {
            background: var(--bg-card);
            border-radius: var(--radius);
            border: 1px solid var(--border-subtle);
            overflow: hidden;
        }

        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-subtle);
            background: var(--bg-tertiary);
        }

        .card-title {
            font-size: 13px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .card-body {
            padding: 16px;
        }

        /* Tables */
        .table-container {
            background: var(--bg-card);
            border-radius: var(--radius);
            border: 1px solid var(--border-subtle);
            overflow: hidden;
            margin-bottom: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 10px 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-subtle);
        }

        th {
            background: var(--bg-tertiary);
            font-size: 11px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: none;
            letter-spacing: 0;
        }

        td {
            font-size: 13px;
        }

        tr:last-child td {
            border-bottom: none;
        }

        tr:hover td {
            background: var(--bg-hover);
        }

        .user-cell {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            object-fit: cover;
        }

        .user-info .user-name {
            font-weight: 600;
            font-size: 13px;
        }

        .user-info .user-email {
            font-size: 11px;
            color: var(--text-muted);
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            border-radius: 2px;
            font-size: 11px;
            font-weight: 400;
        }

        .status-badge.active { background: rgba(16, 124, 16, 0.2); color: var(--success); }
        .status-badge.inactive { background: rgba(138, 138, 138, 0.2); color: var(--text-muted); }
        .status-badge.matched { background: rgba(0, 120, 212, 0.2); color: var(--accent); }
        .status-badge.premium { background: rgba(255, 140, 0, 0.2); color: var(--warning); }
        .status-badge.warning { background: rgba(255, 140, 0, 0.2); color: var(--warning); }
        .status-badge.danger { background: rgba(209, 52, 56, 0.2); color: var(--danger); }

        /* Metrics */
        .metric-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-subtle);
        }

        .metric-row:last-child {
            border-bottom: none;
        }

        .metric-label {
            color: var(--text-secondary);
            font-size: 13px;
        }

        .metric-value {
            font-weight: 600;
            font-family: 'Segoe UI', sans-serif;
            font-size: 13px;
        }

        /* Progress Bar */
        .progress-bar {
            height: 4px;
            background: var(--bg-tertiary);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 8px;
        }

        .progress-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .progress-fill.success { background: var(--success); }
        .progress-fill.warning { background: var(--warning); }
        .progress-fill.danger { background: var(--danger); }
        .progress-fill.accent { background: var(--accent); }
        .progress-fill.info { background: var(--info); }

        /* Funnel */
        .funnel-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .funnel-step {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .funnel-bar {
            flex: 1;
            height: 40px;
            background: var(--bg-tertiary);
            border-radius: var(--radius);
            position: relative;
            overflow: hidden;
        }

        .funnel-fill {
            height: 100%;
            display: flex;
            align-items: center;
            padding: 0 16px;
            color: white;
            font-size: 0.8rem;
            font-weight: 500;
            transition: width 0.5s ease;
        }

        .funnel-step:nth-child(1) .funnel-fill { background: var(--info); }
        .funnel-step:nth-child(2) .funnel-fill { background: var(--purple); }
        .funnel-step:nth-child(3) .funnel-fill { background: var(--accent); }
        .funnel-step:nth-child(4) .funnel-fill { background: var(--warning); }
        .funnel-step:nth-child(5) .funnel-fill { background: var(--success); }

        .funnel-label {
            width: 120px;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .funnel-value {
            width: 60px;
            text-align: right;
            font-weight: 600;
            font-family: 'JetBrains Mono', monospace;
        }

        /* Map placeholder */
        .map-container {
            height: 300px;
            background: var(--bg-tertiary);
            border-radius: var(--radius);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }

        .map-icon {
            font-size: 3rem;
            opacity: 0.5;
        }

        .location-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 16px;
        }

        .location-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 12px;
            background: var(--bg-tertiary);
            border-radius: var(--radius);
        }

        .location-name {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .location-flag {
            font-size: 1.25rem;
        }

        /* Activity Feed */
        .activity-feed {
            max-height: 400px;
            overflow-y: auto;
        }

        .activity-item {
            display: flex;
            gap: 12px;
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-icon {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 1rem;
        }

        .activity-icon.login { background: rgba(59, 130, 246, 0.15); }
        .activity-icon.match { background: rgba(196, 88, 74, 0.15); }
        .activity-icon.message { background: rgba(34, 197, 94, 0.15); }
        .activity-icon.date { background: rgba(168, 85, 247, 0.15); }
        .activity-icon.signup { background: rgba(245, 158, 11, 0.15); }
        .activity-icon.report { background: rgba(239, 68, 68, 0.15); }

        .activity-content {
            flex: 1;
        }

        .activity-text {
            font-size: 0.85rem;
            margin-bottom: 2px;
        }

        .activity-text strong {
            color: var(--text-primary);
        }

        .activity-time {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        /* Admin Activity Log */
        .admin-activity-log {
            scrollbar-width: thin;
            scrollbar-color: var(--border) transparent;
        }
        
        .admin-activity-log::-webkit-scrollbar {
            width: 6px;
        }
        
        .admin-activity-log::-webkit-scrollbar-track {
            background: transparent;
        }
        
        .admin-activity-log::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
        }

        .admin-activity-entry {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
            transition: background 0.15s ease;
        }
        
        .admin-activity-entry:hover {
            background: var(--bg-secondary);
        }
        
        .admin-activity-entry:last-child {
            border-bottom: none;
        }

        .admin-activity-type-icon {
            width: 36px;
            height: 36px;
            min-width: 36px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
        }
        
        .admin-activity-type-icon.user { background: rgba(34, 197, 94, 0.15); }
        .admin-activity-type-icon.file { background: rgba(168, 85, 247, 0.15); }
        .admin-activity-type-icon.event { background: rgba(245, 158, 11, 0.15); }
        .admin-activity-type-icon.config { background: rgba(59, 130, 246, 0.15); }
        .admin-activity-type-icon.sync { background: rgba(236, 72, 153, 0.15); }
        .admin-activity-type-icon.delete { background: rgba(239, 68, 68, 0.15); }
        .admin-activity-type-icon.create { background: rgba(16, 185, 129, 0.15); }

        .admin-activity-details {
            flex: 1;
            min-width: 0;
        }

        .admin-activity-action {
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 2px;
        }

        .admin-activity-target {
            font-size: 0.75rem;
            color: var(--text-muted);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .admin-activity-meta {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 2px;
            font-size: 0.7rem;
            color: var(--text-muted);
            white-space: nowrap;
        }

        .admin-activity-timestamp {
            font-weight: 500;
        }

        .admin-activity-user {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .admin-activity-sync-badge {
            font-size: 0.6rem;
            padding: 2px 6px;
            border-radius: 4px;
            background: rgba(34, 197, 94, 0.15);
            color: var(--success);
        }

        .admin-activity-sync-badge.pending {
            background: rgba(245, 158, 11, 0.15);
            color: var(--warning);
        }

        .admin-activity-sync-badge.failed {
            background: rgba(239, 68, 68, 0.15);
            color: var(--danger);
        }

        /* Report Card */
        .report-card {
            background: rgba(239, 68, 68, 0.05);
            border: 1px solid rgba(239, 68, 68, 0.2);
            border-radius: var(--radius);
            padding: 16px;
            margin-bottom: 12px;
        }

        .report-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }

        .report-type {
            font-weight: 600;
            font-size: 0.9rem;
        }

        .report-reason {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .report-meta {
            display: flex;
            gap: 16px;
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        /* Revenue */
        .revenue-chart {
            display: flex;
            align-items: flex-end;
            gap: 8px;
            height: 150px;
            padding: 20px 0;
        }

        .chart-bar {
            flex: 1;
            background: var(--accent);
            border-radius: 4px 4px 0 0;
            position: relative;
            min-width: 30px;
            transition: height 0.3s ease;
        }

        .chart-bar:hover {
            background: var(--accent-light);
        }

        .chart-bar-label {
            position: absolute;
            bottom: -20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.65rem;
            color: var(--text-muted);
        }

        .chart-bar-value {
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active, .modal[style*="display: flex"] {
            display: flex;
        }
        
        .modal-content {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 24px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border);
        }
        
        .modal-header h3 {
            margin: 0;
            font-size: 1.2rem;
        }
        
        .modal-close {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 1.5rem;
            padding: 0;
            line-height: 1;
        }
        
        .modal-close:hover {
            color: var(--text-primary);
        }
        
        .modal-body {
            margin-bottom: 20px;
        }
        
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            padding-top: 16px;
            border-top: 1px solid var(--border);
        }
        
        .form-group {
            margin-bottom: 16px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-size: 0.85rem;
            color: var(--text-muted);
        }
        
        .form-control {
            width: 100%;
            padding: 10px 14px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.9rem;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--accent);
        }

        /* Feedback */
        .feedback-item {
            padding: 16px;
            background: var(--bg-tertiary);
            border-radius: var(--radius);
            margin-bottom: 12px;
        }

        .feedback-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .feedback-reason {
            font-weight: 600;
            font-size: 0.9rem;
        }

        .feedback-count {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
            color: var(--accent);
        }

        .feedback-bar {
            height: 6px;
            background: var(--border);
            border-radius: 3px;
            overflow: hidden;
        }

        .feedback-fill {
            height: 100%;
            background: var(--accent);
            border-radius: 3px;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px;
            color: var(--text-muted);
        }

        .empty-icon {
            font-size: 3rem;
            margin-bottom: 12px;
            opacity: 0.5;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 20px;
            background: var(--bg-tertiary);
            padding: 4px;
            border-radius: var(--radius);
            width: fit-content;
        }

        .tab {
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--text-secondary);
        }

        .tab:hover {
            color: var(--text-primary);
        }

        .tab.active {
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-weight: 500;
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            .cards-grid.three {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                display: none;
            }
            .content {
                margin-left: 0;
            }
            .stats-grid {
                grid-template-columns: 1fr;
            }
            .cards-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-primary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }

        /* System Hierarchy Diagram Styles */
        .system-hierarchy {
            background: linear-gradient(135deg, var(--bg-secondary) 0%, rgba(30, 41, 59, 0.95) 100%);
            border: 1px solid var(--border);
            border-radius: var(--radius-xl);
            margin-bottom: 24px;
            overflow: hidden;
        }

        .hierarchy-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            background: rgba(0, 0, 0, 0.2);
            cursor: pointer;
            transition: background 0.2s;
        }

        .hierarchy-header:hover {
            background: rgba(0, 0, 0, 0.3);
        }

        .hierarchy-title {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .hierarchy-title h3 {
            font-size: 1rem;
            font-weight: 600;
            margin: 0;
        }

        .hierarchy-title-icon {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, var(--accent), var(--accent-light));
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .hierarchy-stats {
            display: flex;
            gap: 16px;
            align-items: center;
        }

        .hierarchy-stat {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .hierarchy-stat .count {
            font-weight: 600;
            font-family: 'JetBrains Mono', monospace;
        }

        .hierarchy-toggle {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-tertiary);
            border-radius: 6px;
            transition: transform 0.3s;
        }

        .hierarchy-toggle.expanded {
            transform: rotate(180deg);
        }

        .hierarchy-body {
            display: none;
            padding: 24px;
            flex-direction: column;
            gap: 32px;
        }

        .hierarchy-body.expanded {
            display: flex;
        }

        /* Tree Diagram Styles */
        .tree-diagram {
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border);
            padding: 24px;
            overflow-x: auto;
        }

        .tree-diagram-title {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border);
        }

        .tree-diagram-title h4 {
            font-size: 0.95rem;
            font-weight: 600;
        }

        .tree-diagram-badge {
            font-size: 0.6rem;
            padding: 3px 8px;
            border-radius: 10px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .tree-diagram-badge.admin {
            background: rgba(196, 88, 74, 0.15);
            color: var(--accent);
        }

        .tree-diagram-badge.user {
            background: rgba(59, 130, 246, 0.15);
            color: var(--info);
        }

        /* Tree Node Styles */
        .tree-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: fit-content;
        }

        .tree-root {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .tree-node {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            background: var(--bg-tertiary);
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
            position: relative;
        }

        .tree-node:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .tree-node.root {
            background: linear-gradient(135deg, var(--accent), var(--accent-light));
            border-color: var(--accent);
            color: white;
            font-weight: 600;
            padding: 12px 20px;
            font-size: 0.9rem;
        }

        .tree-node.admin-root {
            background: linear-gradient(135deg, var(--accent), var(--accent-light));
        }

        .tree-node.user-root {
            background: linear-gradient(135deg, var(--info), #60a5fa);
        }

        /* Status indicator on nodes - hidden by default, only shows on error */
        .node-status {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            flex-shrink: 0;
            display: none; /* Hidden by default */
        }

        /* Only show status light when there's an error */
        .node-status.error {
            display: inline-block;
            background: var(--danger);
            box-shadow: 0 0 6px var(--danger);
            animation: pulse-error 1.5s infinite;
        }

        @keyframes pulse-error {
            0%, 100% { opacity: 1; box-shadow: 0 0 6px var(--danger); }
            50% { opacity: 0.6; box-shadow: 0 0 12px var(--danger); }
        }

        /* Legacy classes kept for compatibility but hidden by default */
        .node-status.green { display: none; }
        .node-status.yellow { display: none; }
        .node-status.red { display: none; }
        .node-status.gray { display: none; }

        /* Page ID badges */
        .page-id {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: var(--info);
            color: white;
            font-size: 0.6rem;
            font-weight: 700;
            padding: 2px 5px;
            border-radius: 4px;
            margin-right: 4px;
            min-width: 24px;
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', monospace;
        }

        /* Connector lines */
        .tree-connector {
            width: 2px;
            height: 20px;
            background: var(--border);
        }

        .tree-connector.highlight {
            background: var(--accent);
        }

        /* Horizontal branch */
        .tree-branches {
            display: flex;
            justify-content: center;
            gap: 16px;
            position: relative;
        }

        .tree-branches::before {
            content: '';
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: calc(100% - 60px);
            height: 2px;
            background: var(--border);
        }

        .tree-branch {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .tree-branch .tree-connector {
            height: 16px;
        }

        /* Flow diagram for user app */
        .flow-diagram {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .flow-row {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .flow-arrow {
            color: var(--text-muted);
            font-size: 1.2rem;
        }

        .flow-arrow.down {
            transform: rotate(90deg);
        }

        .flow-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            padding: 12px;
            background: rgba(255,255,255,0.02);
            border: 1px dashed var(--border);
            border-radius: 8px;
        }

        .flow-group-label {
            font-size: 0.65rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .flow-nodes {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .flow-node {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .flow-node:hover {
            border-color: var(--info);
            background: rgba(59, 130, 246, 0.15);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
        }

        .flow-node.highlight {
            border-color: var(--success);
            background: rgba(34, 197, 94, 0.1);
        }

        /* Vertical flow section */
        .vertical-flow {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .vertical-connector {
            width: 2px;
            height: 12px;
            background: var(--border);
        }

        /* Legend */
        .hierarchy-legend {
            display: flex;
            gap: 20px;
            padding: 16px;
            background: var(--bg-tertiary);
            border-radius: 0 0 var(--radius-lg) var(--radius-lg);
            border-top: 1px solid var(--border);
            font-size: 0.7rem;
            flex-wrap: wrap;
            justify-content: center;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            color: var(--text-muted);
        }

        .legend-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .legend-dot.green { background: var(--success); }
        .legend-dot.yellow { background: var(--warning); }
        .legend-dot.red { background: var(--danger); }
        .legend-dot.gray { background: var(--text-muted); opacity: 0.5; }

        /* Status light kept for compatibility */
        .status-light {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            flex-shrink: 0;
            position: relative;
        }

        .status-light.green { background: var(--success); box-shadow: 0 0 8px var(--success); }
        .status-light.yellow { background: var(--warning); box-shadow: 0 0 8px var(--warning); }
        .status-light.red { background: var(--danger); box-shadow: 0 0 8px var(--danger); }
        .status-light.gray { background: var(--text-muted); opacity: 0.5; }

        @keyframes pulse-green {
            0%, 100% { opacity: 0.3; transform: translate(-50%, -50%) scale(1); }
            50% { opacity: 0.1; transform: translate(-50%, -50%) scale(1.2); }
        }

        @keyframes pulse-yellow {
            0%, 100% { opacity: 0.3; transform: translate(-50%, -50%) scale(1); }
            50% { opacity: 0.15; transform: translate(-50%, -50%) scale(1.15); }
        }

        @keyframes pulse-red {
            0%, 100% { opacity: 0.4; transform: translate(-50%, -50%) scale(1); }
            50% { opacity: 0.2; transform: translate(-50%, -50%) scale(1.3); }
        }

        /* Toast notification animations */
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }

        .hierarchy-item-name {
            flex: 1;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .hierarchy-item:hover .hierarchy-item-name {
            color: var(--text-primary);
        }

        .hierarchy-item-status {
            font-size: 0.65rem;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 500;
        }

        .hierarchy-item-status.operational {
            background: rgba(34, 197, 94, 0.15);
            color: var(--success);
        }

        .hierarchy-item-status.warning {
            background: rgba(245, 158, 11, 0.15);
            color: var(--warning);
        }

        .hierarchy-item-status.error {
            background: rgba(239, 68, 68, 0.15);
            color: var(--danger);
        }

        .hierarchy-item-status.offline {
            background: rgba(100, 116, 139, 0.15);
            color: var(--text-muted);
        }

        .hierarchy-legend {
            display: flex;
            gap: 16px;
            padding: 12px 16px;
            background: var(--bg-tertiary);
            border-top: 1px solid var(--border);
            font-size: 0.7rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            color: var(--text-muted);
        }

        .legend-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .legend-dot.green { background: var(--success); }
        .legend-dot.yellow { background: var(--warning); }
        .legend-dot.red { background: var(--danger); }
        .legend-dot.gray { background: var(--text-muted); opacity: 0.5; }

        /* Sub-items indent */
        .hierarchy-subitem {
            padding-left: 24px;
        }

        .hierarchy-subitem .hierarchy-item {
            border-left: 1px dashed var(--border);
            margin-left: 4px;
            padding-left: 14px;
        }
    </style>
    <!-- jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
    <header class="header">
        <div class="logo">
            <div class="logo-icon"></div>
            <div>
                <h1>OITH Manager</h1>
            </div>
            <span class="logo-badge">Admin</span>
            <div class="header-quick-actions">
                <button class="header-icon-btn" onclick="openAdminCalendar()" title="Admin Calendar">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                        <line x1="16" y1="2" x2="16" y2="6"/>
                        <line x1="8" y1="2" x2="8" y2="6"/>
                        <line x1="3" y1="10" x2="21" y2="10"/>
                        <circle cx="12" cy="16" r="2" fill="currentColor"/>
                    </svg>
                    <span class="calendar-badge" id="calendarEventCount">0</span>
                </button>
                <button class="header-icon-btn mail-btn" onclick="openMailClient()" title="OITH Mail (@oith.com)">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                        <polyline points="22,6 12,13 2,6"/>
                    </svg>
                    <span class="mail-badge" id="unreadMailCount">0</span>
                </button>
                <button class="header-icon-btn files-btn" onclick="openFileStorage()" title="File Storage (AWS S3)">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>
                    </svg>
                    <span class="files-badge" id="fileCount">0</span>
                </button>
            </div>
        </div>
        <div class="header-center">
            <div class="live-indicator" id="awsSyncIndicator">
                <span class="live-dot" id="awsSyncDot"></span>
                <span>AWS Sync</span>
            </div>
            <div class="aws-sync-meta">
                <div class="aws-sync-line">
                    <span class="aws-sync-label">Last receive:</span>
                    <span id="awsLastReceive" class="aws-status muted">--</span>
                </div>
                <div class="aws-sync-line">
                    <span class="aws-sync-label">Last send:</span>
                    <span id="awsLastSend" class="aws-status muted">--</span>
                </div>
            </div>
            <div class="sync-traffic-indicator" id="syncTrafficIndicator" style="display: flex; align-items: center; gap: 12px; margin-left: 20px; padding: 6px 12px; background: rgba(255,255,255,0.05); border-radius: 8px; font-size: 0.75rem;">
                <div style="display: flex; align-items: center; gap: 4px;">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2">
                        <path d="M12 19V5M5 12l7-7 7 7"/>
                    </svg>
                    <span id="uploadCount" style="color: #10b981;">0</span>
                    <span style="color: #666;">sent</span>
                </div>
                <div style="display: flex; align-items: center; gap: 4px;">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#3b82f6" stroke-width="2">
                        <path d="M12 5v14M5 12l7 7 7-7"/>
                    </svg>
                    <span id="downloadCount" style="color: #3b82f6;">0</span>
                    <span style="color: #666;">received</span>
                </div>
                <div style="color: #666; border-left: 1px solid #333; padding-left: 10px;">
                    <span id="totalSyncBytes" style="color: #f59e0b;">0 KB</span>
                </div>
            </div>
        </div>
        <div class="header-actions">
            <button class="btn btn-secondary btn-icon" onclick="refreshData()" title="Refresh from AWS">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M23 4v6h-6M1 20v-6h6"/>
                    <path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/>
                </svg>
            </button>
            <div class="admin-profile-btn" onclick="showAdminProfile()" title="Admin Profile">
                <div class="admin-avatar" id="adminAvatarHeader"></div>
                <span class="admin-name" id="adminNameHeader">Admin</span>
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="6 9 12 15 18 9"/>
                </svg>
            </div>
        </div>
    </header>

    <div class="main-container">
        <nav class="sidebar">
            <!-- SIDEBAR EDIT CONTROLS -->
            <div id="sidebarEditControls" style="padding: 8px 12px; margin-bottom: 10px; display: flex; gap: 8px; align-items: center;">
                <button id="editSidebarBtn" onclick="toggleSidebarEdit()" class="btn btn-secondary" style="font-size: 0.7rem; padding: 4px 10px; flex: 1;">
                     Edit Layout
                </button>
                <button id="saveSidebarBtn" onclick="saveSidebarOrder()" class="btn btn-primary" style="font-size: 0.7rem; padding: 4px 10px; display: none; flex: 1;">
                     Save
                </button>
                <button id="cancelSidebarBtn" onclick="cancelSidebarEdit()" class="btn btn-secondary" style="font-size: 0.7rem; padding: 4px 8px; display: none;">
                    
                </button>
            </div>
            
            <!-- COMPANY/ADMIN SECTION -->
            <div class="nav-section" id="nav-section-admin" data-section="admin" style="border-left: 3px solid var(--accent); margin-left: -1px; padding-left: 13px;">
                <div class="nav-section-title" style="color: var(--accent);"> Company / Admin</div>
                <div class="nav-item active" onclick="showSection('overview')" data-health-section="overview">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <path d="M12 6v6l4 2"/>
                    </svg>
                    Overview
                    <span class="health-indicator" id="health-overview"></span>
                </div>
                <div class="nav-item" onclick="showSection('dashboard')" data-health-section="dashboard">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="7" height="7"/>
                        <rect x="14" y="3" width="7" height="7"/>
                        <rect x="14" y="14" width="7" height="7"/>
                        <rect x="3" y="14" width="7" height="7"/>
                    </svg>
                    Dashboard
                    <span class="health-indicator" id="health-dashboard"></span>
                </div>
                <div class="nav-item" onclick="showSection('analytics')" data-health-section="analytics">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 21H4.6c-.56 0-.84 0-1.054-.109a1 1 0 01-.437-.437C3 20.24 3 19.96 3 19.4V3"/>
                        <path d="M7 14l4-4 4 4 6-6"/>
                        <circle cx="21" cy="8" r="2"/>
                    </svg>
                    Analytics & AI
                    <span class="health-indicator" id="health-analytics"></span>
                </div>
                <div class="nav-item" onclick="showSection('mlmodels')" data-health-section="mlmodels">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="3"/>
                        <path d="M12 1v6m0 6v10"/>
                        <path d="M21 12h-6m-6 0H1"/>
                        <path d="M18.36 5.64l-4.24 4.24m-4.24 4.24l-4.24 4.24"/>
                        <path d="M5.64 5.64l4.24 4.24m4.24 4.24l4.24 4.24"/>
                    </svg>
                    ML Models
                    <span class="health-indicator" id="health-mlmodels"></span>
                </div>
                <div class="nav-item" onclick="showSection('revenue')" data-health-section="revenue">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="1" x2="12" y2="23"/>
                        <path d="M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"/>
                    </svg>
                    Revenue
                    <span class="health-indicator" id="health-revenue"></span>
                </div>
                <div class="nav-item" onclick="showSection('advertising')" data-health-section="advertising">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="2" y="7" width="20" height="14" rx="2" ry="2"/>
                        <path d="M16 2v4"/>
                        <path d="M8 2v4"/>
                        <circle cx="12" cy="14" r="3"/>
                        <path d="M12 11v1"/>
                    </svg>
                    Advertising
                    <span class="health-indicator" id="health-advertising"></span>
                </div>
                <div class="nav-item" onclick="showSection('geographic')" data-health-section="geographic">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <line x1="2" y1="12" x2="22" y2="12"/>
                        <path d="M12 2a15.3 15.3 0 014 10 15.3 15.3 0 01-4 10 15.3 15.3 0 01-4-10 15.3 15.3 0 014-10z"/>
                    </svg>
                    Geographic
                    <span class="health-indicator" id="health-geographic"></span>
                </div>
                <div class="nav-item" onclick="showSection('legal')" data-health-section="legal">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/>
                        <polyline points="14 2 14 8 20 8"/>
                        <path d="M12 18v-6"/>
                        <path d="M9 15l3 3 3-3"/>
                    </svg>
                    Patents & IP
                    <span class="health-indicator" id="health-legal"></span>
                </div>
                <div class="nav-item" onclick="showSection('compliance')" data-health-section="compliance">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                        <path d="M9 12l2 2 4-4"/>
                    </svg>
                    Compliance
                    <span class="health-indicator" id="health-compliance"></span>
                </div>
                <div class="nav-item" onclick="showSection('database')" data-health-section="database">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <ellipse cx="12" cy="5" rx="9" ry="3"/>
                        <path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/>
                        <path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/>
                    </svg>
                    Database Schema
                    <span class="health-indicator" id="health-database"></span>
                </div>
                <div class="nav-item" onclick="showSection('experiments')" data-health-section="experiments">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 3H5a2 2 0 00-2 2v4m6-6h10a2 2 0 012 2v4M9 3v18m0 0h10a2 2 0 002-2V9M9 21H5a2 2 0 01-2-2V9m0 0h18"/>
                    </svg>
                    Experiments
                    <span class="health-indicator" id="health-experiments"></span>
                </div>
                <div class="nav-item" onclick="showSection('org-hierarchy')" data-health-section="org-hierarchy">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="9" y="2" width="6" height="4" rx="1"/>
                        <rect x="3" y="10" width="6" height="4" rx="1"/>
                        <rect x="15" y="10" width="6" height="4" rx="1"/>
                        <rect x="3" y="18" width="6" height="4" rx="1"/>
                        <rect x="9" y="18" width="6" height="4" rx="1"/>
                        <rect x="15" y="18" width="6" height="4" rx="1"/>
                        <path d="M12 6v4M6 14v4M12 14v4M18 14v4M6 10h12"/>
                    </svg>
                    Hierarchy
                    <span class="health-indicator" id="health-org-hierarchy"></span>
                </div>
                <div class="nav-item" onclick="showSection('payroll')" data-health-section="payroll">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="2" y="4" width="20" height="16" rx="2"/>
                        <path d="M12 8v8M8 12h8"/>
                        <circle cx="12" cy="12" r="3"/>
                    </svg>
                    Payroll
                    <span class="health-indicator" id="health-payroll"></span>
                </div>
                <div class="nav-item" onclick="showSection('tax')" data-health-section="tax">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/>
                        <polyline points="14 2 14 8 20 8"/>
                        <line x1="12" y1="18" x2="12" y2="12"/>
                        <line x1="9" y1="15" x2="15" y2="15"/>
                    </svg>
                    Tax
                    <span class="health-indicator" id="health-tax"></span>
                </div>
                <div class="nav-item" onclick="showSection('expenses')" data-health-section="expenses">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="2" y="5" width="20" height="14" rx="2"/>
                        <line x1="2" y1="10" x2="22" y2="10"/>
                        <path d="M12 15v-2"/>
                        <path d="M8 15v-2"/>
                        <path d="M16 15v-2"/>
                    </svg>
                    Expenses
                    <span class="health-indicator" id="health-expenses"></span>
                </div>
                <div class="nav-item" onclick="showSection('calendar')" data-health-section="calendar">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                        <line x1="16" y1="2" x2="16" y2="6"/>
                        <line x1="8" y1="2" x2="8" y2="6"/>
                        <line x1="3" y1="10" x2="21" y2="10"/>
                        <path d="M8 14h.01M12 14h.01M16 14h.01M8 18h.01M12 18h.01"/>
                    </svg>
                    Calendar
                    <span class="health-indicator" id="health-calendar"></span>
                </div>
                <div class="nav-item" onclick="showSection('simulation')" data-health-section="simulation">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/>
                    </svg>
                    Stress Test
                    <span class="health-indicator" id="health-simulation"></span>
                </div>
            </div>

            <!-- USER APP / INDEX SECTION -->
            <div class="nav-section" id="nav-section-app" data-section="app" style="border-left: 3px solid var(--info); margin-left: -1px; padding-left: 13px; margin-top: 16px;">
                <div class="nav-section-title" style="color: var(--info);"> User App (index.html)</div>
                <div class="nav-item" onclick="showSection('users')" data-health-section="users">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/>
                        <circle cx="9" cy="7" r="4"/>
                        <path d="M23 21v-2a4 4 0 00-3-3.87M16 3.13a4 4 0 010 7.75"/>
                    </svg>
                    Users
                    <span class="health-indicator" id="health-users"></span>
                </div>
                <div class="nav-item" onclick="showSection('matches')" data-health-section="matches">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M20.84 4.61a5.5 5.5 0 00-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 00-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 000-7.78z"/>
                    </svg>
                    Matches
                    <span class="health-indicator" id="health-matches"></span>
                </div>
                <div class="nav-item" onclick="showSection('funnel')" data-health-section="funnel">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/>
                    </svg>
                    Conversion Funnel
                    <span class="health-indicator" id="health-funnel"></span>
                </div>
                <div class="nav-item" onclick="showSection('realtime')" data-health-section="realtime">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 12h-4l-3 9L9 3l-3 9H2"/>
                    </svg>
                    Real-time Activity
                    <span class="health-indicator" id="health-realtime"></span>
                </div>
                <div class="nav-item" onclick="showSection('safety')" data-health-section="safety">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                    </svg>
                    Safety & Reports
                    <span class="health-indicator" id="health-safety"></span>
                    <span class="nav-badge" id="reportsBadge">3</span>
                </div>
                <div class="nav-item" onclick="showSection('compliance')" data-health-section="compliance-app">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2"/>
                        <rect x="9" y="3" width="6" height="4" rx="1"/>
                        <path d="M9 12l2 2 4-4"/>
                    </svg>
                    Compliance
                    <span class="health-indicator" id="health-compliance-app"></span>
                </div>
                <div class="nav-item" onclick="showSection('feedback')" data-health-section="feedback">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/>
                    </svg>
                    User Feedback
                    <span class="health-indicator" id="health-feedback"></span>
                </div>
                <div class="nav-item" onclick="showSection('testbots')" data-health-section="testbots">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="11" width="18" height="10" rx="2"/>
                        <circle cx="12" cy="5" r="2"/>
                        <path d="M12 7v4"/>
                        <line x1="8" y1="16" x2="8" y2="16"/>
                        <line x1="16" y1="16" x2="16" y2="16"/>
                    </svg>
                    Test Bots
                    <span class="health-indicator" id="health-testbots"></span>
                    <span class="nav-badge" style="background: var(--purple)" id="botsActiveBadge">0</span>
                </div>
                <div class="nav-item" onclick="showSection('diagnostics')" data-health-section="diagnostics">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <path d="M12 6v6l3 3"/>
                    </svg>
                    App Diagnostics
                    <span class="health-indicator" id="health-diagnostics"></span>
                </div>
                <div class="nav-item" onclick="showSection('site-diagnostics')" data-health-section="site-diagnostics">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2L2 7l10 5 10-5-10-5z"/>
                        <path d="M2 17l10 5 10-5"/>
                        <path d="M2 12l10 5 10-5"/>
                    </svg>
                    Site Diagnostics
                    <span class="health-indicator" id="health-site-diagnostics"></span>
                </div>
            </div>

            <!-- ACTIONS SECTION -->
            <div class="nav-section" id="nav-section-actions" data-section="actions" style="margin-top: 16px; border-top: 1px solid var(--border); padding-top: 16px;">
                <div class="nav-section-title">Actions</div>
                <div class="nav-item" onclick="exportSyncData()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"/>
                    </svg>
                    Export Sync Data
                </div>
                <div class="nav-item" onclick="importSyncData()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M17 8l-5-5-5 5M12 3v12"/>
                    </svg>
                    Import Sync Data
                </div>
                <div class="nav-item" onclick="exportAllData()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/>
                        <polyline points="14 2 14 8 20 8"/>
                        <line x1="16" y1="13" x2="8" y2="13"/>
                        <line x1="16" y1="17" x2="8" y2="17"/>
                    </svg>
                    Export Reports (CSV)
                </div>
            </div>
        </nav>

        <main class="content" id="mainContent">
            <!-- Overview Section (with System Hierarchy) -->
            <div id="overview-section">
                <div class="page-header">
                    <div>
                        <h2 class="page-title"> Company Overview</h2>
                        <p class="page-subtitle">System architecture, status monitoring, and key metrics</p>
                    </div>
                    <div class="header-actions">
                        <button class="btn btn-secondary" onclick="refreshData()">Refresh</button>
                    </div>
                </div>

                <!-- System Hierarchy Component -->
                <div class="system-hierarchy" id="systemHierarchy" style="margin-bottom: 0;">
                <div class="hierarchy-header" onclick="toggleHierarchy()">
                    <div class="hierarchy-title">
                        <div class="hierarchy-title-icon"></div>
                        <div>
                            <h3>System Component Hierarchy</h3>
                            <span style="font-size: 0.75rem; color: var(--text-muted);">Admin & User App Status Overview</span>
                        </div>
                    </div>
                    <div class="hierarchy-stats">
                        <div class="hierarchy-stat">
                            <span class="legend-dot green"></span>
                            <span class="count" id="hierGreenCount">0</span> Operational
                        </div>
                        <div class="hierarchy-stat">
                            <span class="legend-dot yellow"></span>
                            <span class="count" id="hierYellowCount">0</span> Warning
                        </div>
                        <div class="hierarchy-stat">
                            <span class="legend-dot red"></span>
                            <span class="count" id="hierRedCount">0</span> Issues
                        </div>
                        <div class="hierarchy-toggle" id="hierarchyToggle">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="6 9 12 15 18 9"/>
                            </svg>
                        </div>
                    </div>
                </div>
                <div class="hierarchy-body" id="hierarchyBody">
                    <!-- Admin Dashboard Tree Diagram -->
                    <div class="tree-diagram">
                        <div class="tree-diagram-title">
                            <span></span>
                            <h4>Admin Dashboard Architecture</h4>
                            <span class="tree-diagram-badge admin">Company</span>
                        </div>
                        <div class="tree-container">
                            <!-- Root Node -->
                            <div class="tree-root">
                                <div class="tree-node root admin-root" onclick="showSection('dashboard')" data-component="admin-root" data-connection="aws">
                                    <span class="node-status" id="status-admin-root"></span>
                                     OITH Admin Panel
                                </div>
                                <div class="tree-connector"></div>
                            </div>
                            <!-- Level 1 Branches -->
                            <div class="tree-branches">
                                <!-- Analytics Branch -->
                                <div class="tree-branch">
                                    <div class="tree-connector"></div>
                                    <div class="tree-node" onclick="showSection('analytics')" data-component="analytics" data-connection="aws">
                                        <span class="node-status" id="status-analytics"></span>
                                         Analytics
                                    </div>
                                    <div class="tree-connector"></div>
                                    <div class="flow-nodes" style="flex-direction: column; gap: 4px;">
                                        <div class="flow-node" onclick="showSection('dashboard')" data-component="dashboard" data-connection="aws"><span class="node-status" id="status-dashboard"></span>Dashboard</div>
                                        <div class="flow-node" onclick="showSection('realtime')" data-component="realtime" data-connection="index"><span class="node-status" id="status-realtime"></span>Real-time</div>
                                        <div class="flow-node" onclick="showSection('mlmodels')" data-component="mlmodels" data-connection="aws"><span class="node-status" id="status-mlmodels"></span>ML Models</div>
                                    </div>
                                </div>
                                <!-- Users Branch -->
                                <div class="tree-branch">
                                    <div class="tree-connector"></div>
                                    <div class="tree-node" onclick="showSection('users')" data-component="users" data-connection="aws">
                                        <span class="node-status" id="status-users"></span>
                                         Users
                                    </div>
                                    <div class="tree-connector"></div>
                                    <div class="flow-nodes" style="flex-direction: column; gap: 4px;">
                                        <div class="flow-node" onclick="showSection('matches')" data-component="matches" data-connection="aws"><span class="node-status" id="status-matches"></span>Matches</div>
                                        <div class="flow-node" onclick="showSection('funnel')" data-component="funnel" data-connection="aws"><span class="node-status" id="status-funnel"></span>Funnel</div>
                                    </div>
                                </div>
                                <!-- Business Branch -->
                                <div class="tree-branch">
                                    <div class="tree-connector"></div>
                                    <div class="tree-node" onclick="showSection('revenue')" data-component="business" data-connection="aws">
                                        <span class="node-status" id="status-business"></span>
                                         Business
                                    </div>
                                    <div class="tree-connector"></div>
                                    <div class="flow-nodes" style="flex-direction: column; gap: 4px;">
                                        <div class="flow-node" onclick="showSection('revenue')" data-component="revenue" data-connection="aws"><span class="node-status" id="status-revenue"></span>Revenue</div>
                                        <div class="flow-node" onclick="showSection('geographic')" data-component="geographic" data-connection="aws"><span class="node-status" id="status-geographic"></span>Geographic</div>
                                    </div>
                                </div>
                                <!-- Safety Branch -->
                                <div class="tree-branch">
                                    <div class="tree-connector"></div>
                                    <div class="tree-node" onclick="showSection('safety')" data-component="safety" data-connection="aws">
                                        <span class="node-status" id="status-safety"></span>
                                         Safety
                                    </div>
                                    <div class="tree-connector"></div>
                                    <div class="flow-nodes" style="flex-direction: column; gap: 4px;">
                                        <div class="flow-node" onclick="showSection('safety')" data-component="reports" data-connection="aws"><span class="node-status" id="status-reports"></span>Reports</div>
                                        <div class="flow-node" onclick="showSection('feedback')" data-component="feedback" data-connection="aws"><span class="node-status" id="status-feedback"></span>Feedback</div>
                                    </div>
                                </div>
                                <!-- Testing Branch -->
                                <div class="tree-branch">
                                    <div class="tree-connector"></div>
                                    <div class="tree-node" onclick="showSection('testbots')" data-component="testing" data-connection="index">
                                        <span class="node-status" id="status-testing"></span>
                                         Testing
                                    </div>
                                    <div class="tree-connector"></div>
                                    <div class="flow-nodes" style="flex-direction: column; gap: 4px;">
                                        <div class="flow-node" onclick="showSection('testbots')" data-component="testbots" data-connection="index"><span class="node-status" id="status-testbots"></span>Test Bots</div>
                                        <div class="flow-node" onclick="showSection('diagnostics')" data-component="diagnostics" data-connection="index"><span class="node-status" id="status-diagnostics"></span>Diagnostics</div>
                                        <div class="flow-node" onclick="showSection('database')" data-component="database" data-connection="aws"><span class="node-status" id="status-database"></span>Database</div>
                                    </div>
                                </div>
                                <!-- Legal Branch -->
                                <div class="tree-branch">
                                    <div class="tree-connector"></div>
                                    <div class="tree-node" onclick="showSection('legal')" data-component="legal" data-connection="local">
                                        <span class="node-status" id="status-legal"></span>
                                         Legal
                                    </div>
                                    <div class="tree-connector"></div>
                                    <div class="flow-nodes" style="flex-direction: column; gap: 4px;">
                                        <div class="flow-node" onclick="showSection('legal')" data-component="patents" data-connection="local"><span class="node-status" id="status-patents"></span>Patents & IP</div>
                                        <div class="flow-node" onclick="showSection('compliance')" data-component="compliance" data-connection="local"><span class="node-status" id="status-compliance"></span>Compliance</div>
                                        <div class="flow-node" onclick="showSection('tax')" data-component="tax" data-connection="local"><span class="node-status" id="status-tax"></span>Tax</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- User App Flow Diagram -->
                    <div class="tree-diagram" id="userAppFlowDiagram">
                        <div class="tree-diagram-title">
                            <span></span>
                            <h4>User App Flow (index.html)</h4>
                            <span class="tree-diagram-badge user">User Journey</span>
                        </div>
                        
                        <!-- Page Reference Legend -->
                        <div style="background: var(--bg-tertiary); border-radius: 8px; padding: 12px; margin-bottom: 16px; font-size: 0.75rem;">
                            <div style="font-weight: 600; color: var(--text-secondary); margin-bottom: 8px;"> Page Reference Guide</div>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 4px; color: var(--text-muted);">
                                <span><strong>1.x</strong> Entry & Auth</span>
                                <span><strong>2.x</strong> Onboarding</span>
                                <span><strong>3.x</strong> Main App</span>
                                <span><strong>4.x</strong> Matching</span>
                                <span><strong>5.x</strong> Communication</span>
                                <span><strong>6.x</strong> Profile</span>
                                <span><strong>7.x</strong> Settings</span>
                            </div>
                        </div>
                        
                        <!-- Entry Flow -->
                        <div class="vertical-flow" style="margin-bottom: 20px;">
                            <div class="flow-group">
                                <span class="flow-group-label">Entry Point</span>
                                <div class="flow-node highlight" data-component="splash" data-page-id="1.0" data-connection="index">
                                    <span class="node-status"></span>
                                    <span class="page-id">1.0</span>  Splash Screen
                                </div>
                            </div>
                            <span class="flow-arrow"></span>
                            
                            <!-- Auth Split -->
                            <div class="flow-row">
                                <div class="flow-group">
                                    <span class="flow-group-label">Existing User</span>
                                    <div class="flow-node" data-component="login" data-page-id="1.1" data-connection="index">
                                        <span class="node-status"></span>
                                        <span class="page-id">1.1</span>  Login
                                    </div>
                                </div>
                                <span style="color: var(--text-muted); padding: 0 12px;">OR</span>
                                <div class="flow-group">
                                    <span class="flow-group-label">New User</span>
                                    <div class="flow-node" data-component="signup" data-page-id="1.2" data-connection="index">
                                        <span class="node-status"></span>
                                        <span class="page-id">1.2</span>  Sign Up
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Onboarding Flow (New Users) -->
                        <div style="border: 1px dashed var(--info); border-radius: 12px; padding: 16px; margin-bottom: 20px;">
                            <div style="font-size: 0.7rem; color: var(--info); margin-bottom: 12px; text-transform: uppercase; font-weight: 600;">New User Onboarding Flow</div>
                            <div class="flow-row" style="flex-wrap: wrap; justify-content: center;">
                                <div class="flow-node" data-component="onboarding" data-page-id="2.0" data-connection="index">
                                    <span class="node-status"></span>
                                    <span class="page-id">2.0</span>  Intro
                                </div>
                                <span class="flow-arrow"></span>
                                <div class="flow-node" data-component="preferences" data-page-id="2.1" data-connection="index">
                                    <span class="node-status"></span>
                                    <span class="page-id">2.1</span>  Preferences
                                </div>
                                <span class="flow-arrow"></span>
                                <div class="flow-node" data-component="profile-details" data-page-id="2.2" data-connection="index">
                                    <span class="node-status"></span>
                                    <span class="page-id">2.2</span>  Details
                                </div>
                                <span class="flow-arrow"></span>
                                <div class="flow-node" data-component="profile-setup" data-page-id="2.3" data-connection="index">
                                    <span class="node-status"></span>
                                    <span class="page-id">2.3</span>  Photos
                                </div>
                                <span class="flow-arrow"></span>
                                <div class="flow-node" data-component="payment" data-page-id="2.4" data-connection="aws">
                                    <span class="node-status"></span>
                                    <span class="page-id">2.4</span>  Payment
                                </div>
                            </div>
                        </div>
                        
                        <div class="vertical-flow">
                            <span class="flow-arrow"></span>
                        </div>
                        
                        <!-- Main App Hub -->
                        <div style="border: 2px solid var(--accent); border-radius: 12px; padding: 20px; background: rgba(0, 120, 212, 0.05);">
                            <div style="text-align: center; margin-bottom: 16px;">
                                <div class="tree-node root" style="display: inline-flex;" data-component="match" data-page-id="3.0" data-connection="index">
                                    <span class="node-status"></span>
                                    <span class="page-id" style="background: var(--accent);">3.0</span>  Main App (Match Screen)
                                </div>
                            </div>
                            
                            <!-- Main App Connections -->
                            <div class="flow-row" style="flex-wrap: wrap; justify-content: center; gap: 12px;">
                                <!-- Matching States -->
                                <div class="flow-group">
                                    <span class="flow-group-label">Matching States (4.x)</span>
                                    <div class="flow-nodes" style="flex-direction: column; gap: 4px;">
                                        <div class="flow-node" data-component="waiting-match" data-page-id="4.0" data-connection="aws"><span class="node-status"></span><span class="page-id">4.0</span>  Waiting</div>
                                        <div class="flow-node" data-component="no-matches" data-page-id="4.1" data-connection="aws"><span class="node-status"></span><span class="page-id">4.1</span>  No Matches</div>
                                        <div class="flow-node" data-component="profile-view" data-page-id="4.2" data-connection="index"><span class="node-status"></span><span class="page-id">4.2</span>  View Profile</div>
                                    </div>
                                </div>
                                
                                <!-- Communication -->
                                <div class="flow-group">
                                    <span class="flow-group-label">Communication (5.x)</span>
                                    <div class="flow-nodes" style="flex-direction: column; gap: 4px;">
                                        <div class="flow-node" data-component="chat-list" data-page-id="5.0" data-connection="index"><span class="node-status"></span><span class="page-id">5.0</span>  Chat List</div>
                                        <div class="flow-node" data-component="chat" data-page-id="5.1" data-connection="index"><span class="node-status"></span><span class="page-id">5.1</span>  Messages</div>
                                        <div class="flow-node" data-component="date-plan" data-page-id="5.2" data-connection="index"><span class="node-status"></span><span class="page-id">5.2</span>  Date Plan</div>
                                    </div>
                                </div>
                                
                                <!-- Profile -->
                                <div class="flow-group">
                                    <span class="flow-group-label">Profile Management (6.x)</span>
                                    <div class="flow-nodes" style="flex-direction: column; gap: 4px;">
                                        <div class="flow-node" data-component="my-profile" data-page-id="6.0" data-connection="index"><span class="node-status"></span><span class="page-id">6.0</span>  My Profile</div>
                                        <div class="flow-node" data-component="edit-profile" data-page-id="6.1" data-connection="index"><span class="node-status"></span><span class="page-id">6.1</span>  Edit</div>
                                        <div class="flow-node" data-component="manage-photos" data-page-id="6.2" data-connection="index"><span class="node-status"></span><span class="page-id">6.2</span>  Photos</div>
                                        <div class="flow-node" data-component="match-preferences-edit" data-page-id="6.3" data-connection="index"><span class="node-status"></span><span class="page-id">6.3</span>  Preferences</div>
                                    </div>
                                </div>
                                
                                <!-- Settings -->
                                <div class="flow-group">
                                    <span class="flow-group-label">Settings & Account (7.x)</span>
                                    <div class="flow-nodes" style="flex-direction: column; gap: 4px;">
                                        <div class="flow-node" data-component="settings" data-page-id="7.0" data-connection="index"><span class="node-status"></span><span class="page-id">7.0</span>  Settings</div>
                                        <div class="flow-node" data-component="safety-privacy" data-page-id="7.1" data-connection="index"><span class="node-status"></span><span class="page-id">7.1</span>  Privacy</div>
                                        <div class="flow-node" data-component="manage-subscription" data-page-id="7.2" data-connection="aws"><span class="node-status"></span><span class="page-id">7.2</span>  Subscription</div>
                                        <div class="flow-node" data-component="feedback-metrics" data-page-id="7.3" data-connection="aws"><span class="node-status"></span><span class="page-id">7.3</span>  Feedback</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Legend -->
                    <div class="hierarchy-legend" style="margin-top: 16px; border-radius: var(--radius-lg);">
                        <div class="legend-item"><span class="legend-dot red" style="animation: pulse-error 1.5s infinite;"></span> Connection Error (AWS/App)</div>
                        <div class="legend-item" style="color: var(--text-muted);"><span style="opacity: 0.5;"></span> No issues (hidden)</div>
                        <div class="legend-item" style="margin-left: 20px;"><span style="font-size: 0.9rem;"></span> User Flow Direction</div>
                        <div class="legend-item" style="margin-left: 20px; color: var(--info);"><span style="font-size: 0.9rem;"></span> Click to preview</div>
                    </div>
                </div>
                
                <!-- Screen Preview Modal -->
                <div id="screenPreviewModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 10000; align-items: center; justify-content: center;">
                    <div onclick="closeScreenPreview()" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7);"></div>
                    <div style="position: relative; width: 420px; max-width: 95vw; height: 85vh; background: var(--bg-secondary); border-radius: 12px; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.5);">
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; background: var(--bg-tertiary); border-bottom: 1px solid var(--border);">
                            <div>
                                <h3 id="previewScreenTitle" style="margin: 0; font-size: 1rem; color: var(--text-primary);">Screen Preview</h3>
                                <span id="previewScreenId" style="font-size: 0.75rem; color: var(--text-muted);"></span>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button class="btn btn-secondary btn-sm" onclick="openPreviewInNewTab()" title="Open in new tab">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6M15 3h6v6M10 14L21 3"/>
                                    </svg>
                                </button>
                                <button class="btn btn-secondary btn-sm" onclick="closeScreenPreview()" style="font-size: 1.2rem; padding: 4px 10px;"></button>
                            </div>
                        </div>
                        <iframe id="screenPreviewFrame" style="width: 100%; height: calc(100% - 50px); border: none; background: #1a1a2e;"></iframe>
                    </div>
                </div>
            </div>
            </div><!-- End of overview-section -->

            <!-- Dashboard Section -->
            <div id="dashboard-section" style="display: none;">
                <div class="page-header">
                    <div>
                        <h2 class="page-title"> Dashboard</h2>
                        <p class="page-subtitle">Platform metrics and performance</p>
                    </div>
                    <div class="header-actions">
                        <button class="btn btn-secondary" onclick="refreshData()">Refresh</button>
                    </div>
                </div>

                <!-- Financial Overview Section -->
                <div style="margin-bottom: 24px;">
                    <h3 style="font-size: 1rem; color: var(--text-secondary); margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                        <span style="color: var(--success);"></span> Financial Summary
                    </h3>
                    
                    <!-- Subscription Metrics Row -->
                    <div class="stats-grid" style="grid-template-columns: repeat(4, 1fr); margin-bottom: 16px;">
                        <div class="stat-card" style="border-left: 4px solid var(--success);">
                            <div class="stat-card-header">
                                <div class="stat-icon" style="background: rgba(34, 197, 94, 0.15);"></div>
                                <span class="stat-change positive">Active</span>
                            </div>
                            <div class="stat-value" id="subscribedUsers">0</div>
                            <div class="stat-label">Subscribed Users</div>
                        </div>
                        <div class="stat-card" style="border-left: 4px solid var(--danger);">
                            <div class="stat-card-header">
                                <div class="stat-icon" style="background: rgba(239, 68, 68, 0.15);"></div>
                                <span class="stat-change negative">Churned</span>
                            </div>
                            <div class="stat-value" id="canceledUsers">0</div>
                            <div class="stat-label">Canceled Subscriptions</div>
                        </div>
                        <div class="stat-card" style="border-left: 4px solid var(--info);">
                            <div class="stat-card-header">
                                <div class="stat-icon" style="background: rgba(59, 130, 246, 0.15);"></div>
                            </div>
                            <div class="stat-value" id="churnRate">0%</div>
                            <div class="stat-label">Churn Rate</div>
                        </div>
                        <div class="stat-card" style="border-left: 4px solid var(--purple);">
                            <div class="stat-card-header">
                                <div class="stat-icon" style="background: rgba(168, 85, 247, 0.15);"></div>
                            </div>
                            <div class="stat-value" id="retentionRate">0%</div>
                            <div class="stat-label">Retention Rate</div>
                        </div>
                    </div>

                    <!-- Revenue/Costs/Profit Grid -->
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px;">
                        <!-- Revenue Card -->
                        <div class="card" style="border-top: 3px solid var(--success);">
                            <div class="card-header" style="background: rgba(34, 197, 94, 0.05);">
                                <h3 class="card-title" style="color: var(--success);"> Revenue</h3>
                            </div>
                            <div class="card-body">
                                <div class="metric-row">
                                    <span class="metric-label">Daily Revenue</span>
                                    <span class="metric-value" style="color: var(--success);" id="dailyRevenue">$0.00</span>
                                </div>
                                <div class="metric-row">
                                    <span class="metric-label">MTD Revenue</span>
                                    <span class="metric-value" style="color: var(--success);" id="mtdRevenue">$0.00</span>
                                </div>
                                <div class="metric-row">
                                    <span class="metric-label">YTD Revenue</span>
                                    <span class="metric-value" style="color: var(--success); font-size: 1.1rem;" id="ytdRevenue">$0.00</span>
                                </div>
                                <div class="metric-row" style="border-top: 1px dashed var(--border); padding-top: 12px; margin-top: 8px;">
                                    <span class="metric-label">MRR (Monthly Recurring)</span>
                                    <span class="metric-value" style="color: var(--success);" id="mrrValue">$0.00</span>
                                </div>
                                <div class="metric-row">
                                    <span class="metric-label">ARR (Annual Recurring)</span>
                                    <span class="metric-value" style="color: var(--success);" id="arrValue">$0.00</span>
                                </div>
                            </div>
                        </div>

                        <!-- Costs Card -->
                        <div class="card" style="border-top: 3px solid var(--danger);">
                            <div class="card-header" style="background: rgba(239, 68, 68, 0.05);">
                                <h3 class="card-title" style="color: var(--danger);"> Costs</h3>
                            </div>
                            <div class="card-body">
                                <div class="metric-row">
                                    <span class="metric-label">Daily Costs</span>
                                    <span class="metric-value" style="color: var(--danger);" id="dailyCosts">$0.00</span>
                                </div>
                                <div class="metric-row">
                                    <span class="metric-label">MTD Costs</span>
                                    <span class="metric-value" style="color: var(--danger);" id="mtdCosts">$0.00</span>
                                </div>
                                <div class="metric-row">
                                    <span class="metric-label">YTD Costs</span>
                                    <span class="metric-value" style="color: var(--danger); font-size: 1.1rem;" id="ytdCosts">$0.00</span>
                                </div>
                                <div class="metric-row" style="border-top: 1px dashed var(--border); padding-top: 12px; margin-top: 8px;">
                                    <span class="metric-label">Infrastructure</span>
                                    <span class="metric-value" style="color: var(--text-muted);" id="infraCosts">$0.00</span>
                                </div>
                                <div class="metric-row">
                                    <span class="metric-label">Operations</span>
                                    <span class="metric-value" style="color: var(--text-muted);" id="opsCosts">$0.00</span>
                                </div>
                            </div>
                        </div>

                        <!-- Profit Card -->
                        <div class="card" style="border-top: 3px solid var(--info);">
                            <div class="card-header" style="background: rgba(59, 130, 246, 0.05);">
                                <h3 class="card-title" style="color: var(--info);"> Profit</h3>
                            </div>
                            <div class="card-body">
                                <div class="metric-row">
                                    <span class="metric-label">Daily Profit</span>
                                    <span class="metric-value" id="dailyProfit">$0.00</span>
                                </div>
                                <div class="metric-row">
                                    <span class="metric-label">MTD Profit</span>
                                    <span class="metric-value" id="mtdProfit">$0.00</span>
                                </div>
                                <div class="metric-row">
                                    <span class="metric-label">YTD Profit</span>
                                    <span class="metric-value" style="font-size: 1.1rem;" id="ytdProfit">$0.00</span>
                                </div>
                                <div class="metric-row" style="border-top: 1px dashed var(--border); padding-top: 12px; margin-top: 8px;">
                                    <span class="metric-label">Profit Margin</span>
                                    <span class="metric-value" id="profitMargin">0%</span>
                                </div>
                                <div class="metric-row">
                                    <span class="metric-label">Burn Rate (Monthly)</span>
                                    <span class="metric-value" style="color: var(--warning);" id="burnRate">$0.00</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Platform Stats -->
                <div style="margin-bottom: 24px;">
                    <h3 style="font-size: 1rem; color: var(--text-secondary); margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                        <span></span> Platform Metrics
                    </h3>
                    <div class="stats-grid" id="statsGrid">
                        <!-- Populated by JS -->
                    </div>
                </div>

                <!-- Platform Health & Match Quality -->
                <div class="cards-grid">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"> Platform Health</h3>
                        </div>
                        <div class="card-body" id="platformHealth">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"> Match Quality</h3>
                        </div>
                        <div class="card-body" id="matchQuality">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title"> Recent Activity</h3>
                    </div>
                    <div class="card-body">
                        <div class="activity-feed" id="activityFeed">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Real-time Section -->
            <div id="realtime-section" style="display: none;">
                <div class="page-header">
                    <div>
                        <h2 class="page-title">Real-time Activity</h2>
                        <p class="page-subtitle">Live user actions and behavior analytics from index.html</p>
                    </div>
                    <div class="header-actions">
                        <span id="behaviorConnectionStatus" class="status-badge" style="font-size: 0.7rem;">Waiting...</span>
                        <button class="btn btn-secondary" onclick="clearBehaviorData()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
                            </svg>
                            Clear Data
                        </button>
                    </div>
                </div>

                <!-- Live Stats -->
                <div class="stats-grid">
                    <div class="stat-card users">
                        <div class="stat-icon users"></div>
                        <div class="stat-value" id="activeNow">0</div>
                        <div class="stat-label">Active Sessions</div>
                    </div>
                    <div class="stat-card matches">
                        <div class="stat-icon matches"></div>
                        <div class="stat-value" id="totalScreenViews">0</div>
                        <div class="stat-label">Screen Views</div>
                    </div>
                    <div class="stat-card messages">
                        <div class="stat-icon messages"></div>
                        <div class="stat-value" id="totalButtonClicks">0</div>
                        <div class="stat-label">Button Clicks</div>
                    </div>
                    <div class="stat-card dates">
                        <div class="stat-icon dates"></div>
                        <div class="stat-value" id="totalSwipes">0</div>
                        <div class="stat-label">Swipe Actions</div>
                    </div>
                </div>

                <!-- Behavior Analytics Cards -->
                <div class="cards-grid" style="margin-bottom: 20px;">
                    <!-- Most Visited Screens -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"> Screen Time Analytics</h3>
                            <span class="status-badge active" style="font-size: 0.65rem;">LIVE</span>
                        </div>
                        <div class="card-body">
                            <div id="screenTimeChart" style="min-height: 200px;">
                                <div style="color: var(--text-muted); text-align: center; padding: 40px;">
                                    Waiting for user activity on index.html...
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Most Clicked Buttons -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"> Button Click Heatmap</h3>
                            <span class="status-badge active" style="font-size: 0.65rem;">LIVE</span>
                        </div>
                        <div class="card-body">
                            <div id="buttonClicksChart" style="min-height: 200px;">
                                <div style="color: var(--text-muted); text-align: center; padding: 40px;">
                                    Waiting for user activity on index.html...
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Navigation Flow & Live Feed -->
                <div class="cards-grid">
                    <!-- User Navigation Path -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"> Navigation Flow</h3>
                        </div>
                        <div class="card-body">
                            <div id="navigationFlow" style="min-height: 150px; max-height: 300px; overflow-y: auto;">
                                <div style="color: var(--text-muted); text-align: center; padding: 40px;">
                                    User navigation path will appear here...
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Live Activity Feed -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"> Live Activity Feed</h3>
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <select id="liveFeedUserFilter" onchange="filterLiveFeed()" style="padding: 4px 8px; font-size: 0.7rem; border-radius: 6px; border: 1px solid var(--border); background: var(--bg-tertiary); color: var(--text-primary); cursor: pointer;">
                                    <option value="all">All Users</option>
                                </select>
                            <button class="btn btn-secondary btn-sm" onclick="clearLiveFeed()" style="font-size: 0.7rem; padding: 4px 8px;">Clear</button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="activity-feed" id="liveFeed" style="max-height: 300px; overflow-y: auto;">
                                <div style="color: var(--text-muted); text-align: center; padding: 20px;">
                                    Live events will appear here...
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Session Details -->
                <div class="card" style="margin-top: 20px;">
                    <div class="card-header">
                        <h3 class="card-title"> Active Session Details</h3>
                    </div>
                    <div class="card-body">
                        <div id="sessionDetails" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                            <div style="padding: 16px; background: var(--bg-tertiary); border-radius: 8px;">
                                <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 4px;">Session ID</div>
                                <div id="currentSessionId" style="font-family: monospace; font-size: 0.85rem;"></div>
                            </div>
                            <div style="padding: 16px; background: var(--bg-tertiary); border-radius: 8px;">
                                <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 4px;">Session Duration</div>
                                <div id="sessionDuration" style="font-size: 1.1rem; font-weight: 600;"></div>
                            </div>
                            <div style="padding: 16px; background: var(--bg-tertiary); border-radius: 8px;">
                                <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 4px;">Current Screen</div>
                                <div id="currentUserScreen" style="font-size: 1.1rem; font-weight: 600;"></div>
                            </div>
                            <div style="padding: 16px; background: var(--bg-tertiary); border-radius: 8px;">
                                <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 4px;">User</div>
                                <div id="currentUser" style="font-size: 0.9rem;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Analytics & AI Section -->
            <div id="analytics-section" style="display: none;">
                <div class="page-header">
                    <div>
                        <h2 class="page-title"> Analytics & Predictive AI</h2>
                        <p class="page-subtitle">Machine learning predictions based on real-time platform data</p>
                    </div>
                    <div class="header-actions">
                        <button class="btn btn-secondary" onclick="runPredictions()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 21H4.6c-.56 0-.84 0-1.054-.109a1 1 0 01-.437-.437C3 20.24 3 19.96 3 19.4V3"/>
                                <path d="M7 14l4-4 4 4 6-6"/>
                            </svg>
                            Run Predictions
                        </button>
                    </div>
                </div>

                <!-- Model Status -->
                <div class="card" style="margin-bottom: 20px; border-left: 3px solid var(--purple);">
                    <div class="card-body" style="padding: 16px 20px;">
                        <div style="display: flex; align-items: center; justify-content: space-between;">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <div style="width: 40px; height: 40px; background: rgba(168, 85, 247, 0.15); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem;"></div>
                                <div>
                                    <div style="font-weight: 600;">Predictive Model Status</div>
                                    <div style="font-size: 0.8rem; color: var(--text-muted);" id="modelStatus">Analyzing <span id="dataPointsCount">0</span> data points from <span id="userDataCount">0</span> users</div>
                                </div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span style="width: 8px; height: 8px; background: var(--success); border-radius: 50%; animation: pulse 2s infinite;"></span>
                                <span style="font-size: 0.8rem; color: var(--success);">Models Active</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Prediction Cards Grid -->
                <div class="stats-grid" id="predictionCards">
                    <!-- Populated by JS -->
                </div>

                <!-- Main Predictions -->
                <div class="cards-grid">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"> 30-Day Growth Forecast</h3>
                            <span class="status-badge active" style="font-size: 0.65rem;">HIGH CONFIDENCE</span>
                        </div>
                        <div class="card-body" id="growthForecast">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"> Revenue Projection</h3>
                            <span class="status-badge premium" style="font-size: 0.65rem;">MEDIUM CONFIDENCE</span>
                        </div>
                        <div class="card-body" id="revenueProjection">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>

                <div class="cards-grid">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"> Churn Risk Analysis</h3>
                            <span class="status-badge warning" style="font-size: 0.65rem;">ACTIONABLE</span>
                        </div>
                        <div class="card-body" id="churnAnalysis">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"> Match Success Predictor</h3>
                            <span class="status-badge matched" style="font-size: 0.65rem;">REAL-TIME</span>
                        </div>
                        <div class="card-body" id="matchPredictor">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>

                <!-- Engagement Predictions -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title"> User Engagement Predictions</h3>
                    </div>
                    <div class="card-body" id="engagementPredictions">
                        <!-- Populated by JS -->
                    </div>
                </div>

                <!-- AI Insights -->
                <div class="card" style="border: 1px solid var(--purple);">
                    <div class="card-header" style="background: rgba(168, 85, 247, 0.1);">
                        <h3 class="card-title"> AI-Generated Insights & Recommendations</h3>
                    </div>
                    <div class="card-body" id="aiInsights">
                        <!-- Populated by JS -->
                    </div>
                </div>

                <!-- Matching Algorithm Performance -->
                <div class="cards-grid" style="margin-top: 20px;">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"> AI Matching Accuracy</h3>
                            <span class="status-badge matched" style="font-size: 0.65rem;">LIVE</span>
                        </div>
                        <div class="card-body" id="matchingAccuracy">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"> Profiles Filtered by Preferences</h3>
                            <span class="status-badge warning" style="font-size: 0.65rem;">INSIGHTS</span>
                        </div>
                        <div class="card-body" id="filteredProfilesStats">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- ML Models Evaluation Section -->
            <div id="mlmodels-section" style="display: none;">
                <div class="page-header">
                    <div>
                        <h2 class="page-title"> ML Model Evaluation</h2>
                        <p class="page-subtitle">All AI/ML algorithms powering the OITH application</p>
                    </div>
                    <div class="header-actions">
                        <button class="btn btn-primary" onclick="runAllModelTests()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polygon points="5 3 19 12 5 21 5 3"/>
                            </svg>
                            Run All Tests
                        </button>
                    </div>
                </div>

                <!-- Current Models in Production -->
                <div class="card" style="margin-bottom: 20px; border: 2px solid var(--accent);">
                    <div class="card-header" style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.15), rgba(139, 92, 246, 0.05));">
                        <h3 class="card-title"> Current Models in Production</h3>
                        <div style="display: flex; gap: 12px; align-items: center;">
                            <span class="status-badge active" style="font-size: 0.75rem;" id="activeModelsCount">6 ACTIVE</span>
                            <button class="btn btn-primary btn-sm" onclick="addNewModel()" style="font-size: 0.75rem;">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="12" y1="5" x2="12" y2="19"/>
                                    <line x1="5" y1="12" x2="19" y2="12"/>
                                </svg>
                                Add Model
                            </button>
                        </div>
                    </div>
                    <div class="card-body" style="padding: 0;">
                        <table class="data-table" id="currentModelsTable">
                            <thead>
                                <tr>
                                    <th>Model</th>
                                    <th>Type</th>
                                    <th>Location</th>
                                    <th>Purpose</th>
                                    <th>Status</th>
                                    <th style="width: 100px;">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="modelsTableBody">
                                <!-- Dynamically populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                    <div style="padding: 12px; background: var(--bg-tertiary); border-top: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-size: 0.8rem; color: var(--text-muted);">
                            <span id="lastModelSyncTime">--</span>
                        </span>
                        <button class="btn btn-secondary btn-sm" onclick="syncModelsToAWS()" style="font-size: 0.75rem;">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M23 4v6h-6M1 20v-6h6"/>
                                <path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/>
                            </svg>
                            Sync to AWS
                        </button>
                    </div>
                </div>

                <!-- Editable Algorithm Details Cards -->
                <div class="cards-grid" style="margin-bottom: 20px;">
                    <div class="card" id="compatibilityAlgorithmCard">
                        <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                            <h3 class="card-title"> Compatibility Algorithm</h3>
                            <div style="display: flex; gap: 8px; align-items: center;">
                            <span class="status-badge active">v1.0</span>
                                <button class="btn btn-sm" onclick="editCompatibilityWeights()" title="Edit Weights" style="padding: 4px 8px; font-size: 0.75rem;">
                                     Edit
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <p style="color: var(--text-muted); margin-bottom: 12px; font-size: 0.85rem;">
                                Weighted scoring algorithm that calculates overall match compatibility.
                            </p>
                            <div id="compatibilityWeightsDisplay" style="display: flex; flex-direction: column; gap: 8px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.8rem;">
                                    <span>Relationship Goals</span>
                                    <span class="weight-value" data-key="goals" style="color: var(--accent); font-weight: 600;">25%</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.8rem;">
                                    <span>Shared Interests</span>
                                    <span class="weight-value" data-key="interests" style="color: var(--accent); font-weight: 600;">25%</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.8rem;">
                                    <span>Location Proximity</span>
                                    <span class="weight-value" data-key="location" style="color: var(--accent); font-weight: 600;">20%</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.8rem;">
                                    <span>Age Compatibility</span>
                                    <span class="weight-value" data-key="age" style="color: var(--accent); font-weight: 600;">15%</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.8rem;">
                                    <span>Communication Style</span>
                                    <span class="weight-value" data-key="communication" style="color: var(--accent); font-weight: 600;">15%</span>
                                </div>
                            </div>
                            <!-- Edit Form (hidden by default) -->
                            <div id="compatibilityWeightsEdit" style="display: none; margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border);">
                                <div style="display: flex; flex-direction: column; gap: 12px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <label style="font-size: 0.8rem;">Relationship Goals</label>
                                        <div style="display: flex; align-items: center; gap: 8px;">
                                            <input type="range" id="weightGoals" min="0" max="50" value="25" style="width: 100px;" oninput="updateWeightPreview('goals', this.value)">
                                            <span id="weightGoalsValue" style="min-width: 35px; font-size: 0.8rem;">25%</span>
                                        </div>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <label style="font-size: 0.8rem;">Shared Interests</label>
                                        <div style="display: flex; align-items: center; gap: 8px;">
                                            <input type="range" id="weightInterests" min="0" max="50" value="25" style="width: 100px;" oninput="updateWeightPreview('interests', this.value)">
                                            <span id="weightInterestsValue" style="min-width: 35px; font-size: 0.8rem;">25%</span>
                                        </div>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <label style="font-size: 0.8rem;">Location Proximity</label>
                                        <div style="display: flex; align-items: center; gap: 8px;">
                                            <input type="range" id="weightLocation" min="0" max="50" value="20" style="width: 100px;" oninput="updateWeightPreview('location', this.value)">
                                            <span id="weightLocationValue" style="min-width: 35px; font-size: 0.8rem;">20%</span>
                                        </div>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <label style="font-size: 0.8rem;">Age Compatibility</label>
                                        <div style="display: flex; align-items: center; gap: 8px;">
                                            <input type="range" id="weightAge" min="0" max="50" value="15" style="width: 100px;" oninput="updateWeightPreview('age', this.value)">
                                            <span id="weightAgeValue" style="min-width: 35px; font-size: 0.8rem;">15%</span>
                                        </div>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <label style="font-size: 0.8rem;">Communication Style</label>
                                        <div style="display: flex; align-items: center; gap: 8px;">
                                            <input type="range" id="weightCommunication" min="0" max="50" value="15" style="width: 100px;" oninput="updateWeightPreview('communication', this.value)">
                                            <span id="weightCommunicationValue" style="min-width: 35px; font-size: 0.8rem;">15%</span>
                                        </div>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: var(--bg-tertiary); border-radius: 6px; margin-top: 8px;">
                                        <span style="font-size: 0.8rem; font-weight: 600;">Total:</span>
                                        <span id="weightTotal" style="font-size: 0.9rem; font-weight: 600; color: var(--success);">100%</span>
                                    </div>
                                    <div style="display: flex; gap: 8px; margin-top: 8px;">
                                        <button class="btn btn-primary" onclick="saveCompatibilityWeights()" style="flex: 1; font-size: 0.8rem;"> Save & Apply</button>
                                        <button class="btn btn-secondary" onclick="cancelEditWeights()" style="font-size: 0.8rem;">Cancel</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"> Profile Filter Logic</h3>
                            <span class="status-badge active">v1.0</span>
                        </div>
                        <div class="card-body">
                            <p style="color: var(--text-muted); margin-bottom: 12px; font-size: 0.85rem;">
                                Sequential filter chain that narrows match pool based on preferences.
                            </p>
                            <div style="display: flex; flex-direction: column; gap: 6px; font-size: 0.8rem;">
                                <div>1 Age Range Filter (must be within range)</div>
                                <div>2 Distance Filter ( max miles)</div>
                                <div>3 Height Filter (min/max inches)</div>
                                <div>4 Body Type Filter (any selected)</div>
                                <div>5 Ethnicity Filter (exact match)</div>
                                <div>6 Education Filter (exact match)</div>
                                <div>7 Lifestyle Filters (smoking, drinking, exercise)</div>
                                <div>8 Children Preference Filter</div>
                                <div>9 Religion Filter (exact match)</div>
                                <div> Relationship Goals Filter</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Planned AI Integrations -->
                <div class="card" style="margin-bottom: 20px; border: 1px dashed var(--info);">
                    <div class="card-header" style="background: rgba(59, 130, 246, 0.1);">
                        <h3 class="card-title"> Planned AI Integrations</h3>
                        <span class="status-badge" style="background: rgba(59, 130, 246, 0.3); color: #60a5fa;">ROADMAP</span>
                    </div>
                    <div class="card-body" style="padding: 0;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Feature</th>
                                    <th>Technology</th>
                                    <th>Priority</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><strong>GPT-4 Chat Integration</strong></td>
                                    <td>OpenAI GPT-4 API</td>
                                    <td><span class="status-badge danger">High</span></td>
                                    <td><span class="status-badge">Planned Q1</span></td>
                                </tr>
                                <tr>
                                    <td><strong>Photo Verification AI</strong></td>
                                    <td>AWS Rekognition / Azure Face API</td>
                                    <td><span class="status-badge danger">High</span></td>
                                    <td><span class="status-badge">Planned Q1</span></td>
                                </tr>
                                <tr>
                                    <td><strong>Conversation Sentiment Analysis</strong></td>
                                    <td>BERT / Custom NLP Model</td>
                                    <td><span class="status-badge warning">Medium</span></td>
                                    <td><span class="status-badge">Planned Q2</span></td>
                                </tr>
                                <tr>
                                    <td><strong>ML-Based Match Ranking</strong></td>
                                    <td>TensorFlow / PyTorch (Collaborative Filtering)</td>
                                    <td><span class="status-badge warning">Medium</span></td>
                                    <td><span class="status-badge">Planned Q2</span></td>
                                </tr>
                                <tr>
                                    <td><strong>Date Success Predictor</strong></td>
                                    <td>Gradient Boosting / XGBoost</td>
                                    <td><span class="status-badge">Low</span></td>
                                    <td><span class="status-badge">Planned Q3</span></td>
                                </tr>
                                <tr>
                                    <td><strong>Bio Writing Assistant</strong></td>
                                    <td>GPT-4 with Fine-tuning</td>
                                    <td><span class="status-badge">Low</span></td>
                                    <td><span class="status-badge">Planned Q3</span></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Current Best Model -->
                <div class="card" style="margin-bottom: 20px; border: 2px solid var(--success);">
                    <div class="card-header" style="background: rgba(34, 197, 94, 0.1);">
                        <h3 class="card-title"> Custom Models (User Added)</h3>
                        <span class="status-badge active" style="font-size: 0.75rem;">EVALUATION</span>
                    </div>
                    <div class="card-body" id="bestModelCard">
                        <!-- Populated by JS -->
                    </div>
                </div>

                <!-- Model Comparison Table -->
                <div class="card" style="margin-bottom: 20px;">
                    <div class="card-header">
                        <h3 class="card-title"> Model Performance Comparison</h3>
                        <div style="display: flex; gap: 8px;">
                            <button class="btn btn-primary" onclick="showAddModelModal()" style="font-size: 0.8rem;">+ Add Model</button>
                            <button class="btn btn-secondary" onclick="exportModelMetrics()" style="font-size: 0.8rem;">Export Metrics</button>
                        </div>
                    </div>
                    <div class="card-body" style="padding: 0;">
                        <table class="data-table" id="modelComparisonTable">
                            <thead>
                                <tr>
                                    <th>Model</th>
                                    <th>Accuracy</th>
                                    <th>Precision</th>
                                    <th>Recall</th>
                                    <th>F1 Score</th>
                                    <th>Training Time</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="modelComparisonBody">
                                <!-- Populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Model Details Cards -->
                <div class="cards-grid">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"> Training Data Statistics</h3>
                        </div>
                        <div class="card-body" id="trainingDataStats">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"> Feature Importance</h3>
                        </div>
                        <div class="card-body" id="featureImportance">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>

                <!-- Confusion Matrix & ROC -->
                <div class="cards-grid" style="margin-top: 20px;">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"> Confusion Matrix</h3>
                        </div>
                        <div class="card-body" id="confusionMatrix">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"> Model Training History</h3>
                        </div>
                        <div class="card-body" id="trainingHistory">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>

                <!-- Test Your Own Data -->
                <div class="card" style="margin-top: 20px; border: 1px dashed var(--info);">
                    <div class="card-header">
                        <h3 class="card-title"> Test Model with Custom Data</h3>
                    </div>
                    <div class="card-body">
                        <p style="color: var(--text-muted); margin-bottom: 16px;">Input user preferences to test how the model would predict match success:</p>
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px; margin-bottom: 16px;">
                            <div>
                                <label style="display: block; font-size: 0.75rem; color: var(--text-muted); margin-bottom: 4px;">User A Age</label>
                                <input type="number" id="testUserAAge" value="28" min="18" max="100" style="width: 100%; padding: 8px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary);">
                            </div>
                            <div>
                                <label style="display: block; font-size: 0.75rem; color: var(--text-muted); margin-bottom: 4px;">User B Age</label>
                                <input type="number" id="testUserBAge" value="26" min="18" max="100" style="width: 100%; padding: 8px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary);">
                            </div>
                            <div>
                                <label style="display: block; font-size: 0.75rem; color: var(--text-muted); margin-bottom: 4px;">Distance (mi)</label>
                                <input type="number" id="testDistance" value="5" min="1" max="100" style="width: 100%; padding: 8px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary);">
                            </div>
                            <div>
                                <label style="display: block; font-size: 0.75rem; color: var(--text-muted); margin-bottom: 4px;">Shared Interests</label>
                                <input type="number" id="testSharedInterests" value="3" min="0" max="10" style="width: 100%; padding: 8px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary);">
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="testModelPrediction()">Run Prediction</button>
                        <div id="modelPredictionResult" style="margin-top: 16px;"></div>
                    </div>
                </div>
            </div>

            <!-- Users Section -->
            <div id="users-section" style="display: none;">
                <div class="page-header">
                    <div>
                        <h2 class="page-title">Users</h2>
                        <p class="page-subtitle">All registered users and their profiles</p>
                    </div>
                    <div class="header-actions">
                        <button class="btn btn-secondary" onclick="refreshUserData()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M23 4v6h-6M1 20v-6h6"/>
                                <path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/>
                            </svg>
                            Refresh
                        </button>
                        <button class="btn btn-primary" onclick="exportUserData()">Export CSV</button>
                    </div>
                </div>

                <!-- Filters -->
                <div class="card" style="margin-bottom: 20px;">
                    <div class="card-header">
                        <h3 class="card-title"> Filter Users</h3>
                        <button class="btn btn-secondary" onclick="clearUserFilters()" style="font-size: 0.8rem;">Clear Filters</button>
                    </div>
                    <div class="card-body">
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 12px;">
                            <div>
                                <label style="display: block; font-size: 0.75rem; color: var(--text-muted); margin-bottom: 4px;">Status</label>
                                <select id="filterStatus" onchange="applyUserFilters()" style="width: 100%; padding: 8px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary);">
                                    <option value="">All</option>
                                    <option value="active">Active</option>
                                    <option value="matched">Matched</option>
                                    <option value="inactive">Inactive</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; font-size: 0.75rem; color: var(--text-muted); margin-bottom: 4px;">Subscription</label>
                                <select id="filterSubscription" onchange="applyUserFilters()" style="width: 100%; padding: 8px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary);">
                                    <option value="">All</option>
                                    <option value="premium">Premium</option>
                                    <option value="free">Free</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; font-size: 0.75rem; color: var(--text-muted); margin-bottom: 4px;">Gender</label>
                                <select id="filterGender" onchange="applyUserFilters()" style="width: 100%; padding: 8px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary);">
                                    <option value="">All</option>
                                    <option value="male">Male</option>
                                    <option value="female">Female</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; font-size: 0.75rem; color: var(--text-muted); margin-bottom: 4px;">Education</label>
                                <select id="filterEducation" onchange="applyUserFilters()" style="width: 100%; padding: 8px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary);">
                                    <option value="">All</option>
                                    <option value="high-school">High School</option>
                                    <option value="some-college">Some College</option>
                                    <option value="bachelors">Bachelor's</option>
                                    <option value="masters">Master's</option>
                                    <option value="doctorate">Doctorate</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; font-size: 0.75rem; color: var(--text-muted); margin-bottom: 4px;">Age Range</label>
                                <select id="filterAge" onchange="applyUserFilters()" style="width: 100%; padding: 8px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary);">
                                    <option value="">All Ages</option>
                                    <option value="18-24">18-24</option>
                                    <option value="25-34">25-34</option>
                                    <option value="35-44">35-44</option>
                                    <option value="45-54">45-54</option>
                                    <option value="55+">55+</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; font-size: 0.75rem; color: var(--text-muted); margin-bottom: 4px;">Location</label>
                                <select id="filterLocation" onchange="applyUserFilters()" style="width: 100%; padding: 8px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary);">
                                    <option value="">All Locations</option>
                                    <!-- Populated dynamically -->
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- User Table -->
                <div class="table-container">
                    <div class="card-header">
                        <h3 class="card-title">User Database</h3>
                        <div style="display: flex; align-items: center; gap: 16px;">
                            <span style="font-size: 0.75rem; color: var(--text-muted);">
                                 Auto-refresh: <span id="lastRefreshTime">--:--:--</span>
                            </span>
                            <span id="userCount" style="color: var(--text-muted); font-size: 0.85rem;">0 users</span>
                        </div>
                    </div>
                    <div style="overflow-x: auto;">
                        <table>
                            <thead>
                                <tr>
                                    <th onclick="sortUsers('name')" style="cursor: pointer;">User </th>
                                    <th onclick="sortUsers('age')" style="cursor: pointer;">Age </th>
                                    <th onclick="sortUsers('gender')" style="cursor: pointer;">Gender </th>
                                    <th onclick="sortUsers('location')" style="cursor: pointer;">Location </th>
                                    <th onclick="sortUsers('education')" style="cursor: pointer;">Education </th>
                                    <th onclick="sortUsers('status')" style="cursor: pointer;">Status </th>
                                    <th onclick="sortUsers('subscription')" style="cursor: pointer;">Time Left </th>
                                    <th onclick="sortUsers('matches')" style="cursor: pointer;">Matches </th>
                                    <th onclick="sortUsers('messages')" style="cursor: pointer;">Messages </th>
                                    <th onclick="sortUsers('joined')" style="cursor: pointer;">Joined </th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="usersTable">
                                <!-- Populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Edit User Modal -->
                <div id="editUserModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 1000; align-items: center; justify-content: center;">
                    <div style="background: var(--bg-secondary); border-radius: 16px; padding: 24px; width: 90%; max-width: 500px; max-height: 80vh; overflow-y: auto;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 style="margin: 0;"> Edit User</h3>
                            <button onclick="closeEditUserModal()" style="background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 1.5rem;">&times;</button>
                        </div>
                        <form id="editUserForm" onsubmit="saveUserChanges(event)">
                            <input type="hidden" id="editUserEmail">
                            
                            <div style="margin-bottom: 16px;">
                                <label style="display: block; font-size: 0.85rem; color: var(--text-muted); margin-bottom: 4px;">Name</label>
                                <input type="text" id="editUserName" style="width: 100%; padding: 10px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary);">
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                                <div>
                                    <label style="display: block; font-size: 0.85rem; color: var(--text-muted); margin-bottom: 4px;">Age</label>
                                    <input type="number" id="editUserAge" min="18" max="99" style="width: 100%; padding: 10px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary);">
                                </div>
                                <div>
                                    <label style="display: block; font-size: 0.85rem; color: var(--text-muted); margin-bottom: 4px;">Gender</label>
                                    <select id="editUserGender" style="width: 100%; padding: 10px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary);">
                                        <option value="male">Male</option>
                                        <option value="female">Female</option>
                                        <option value="other">Other</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div style="margin-bottom: 16px;">
                                <label style="display: block; font-size: 0.85rem; color: var(--text-muted); margin-bottom: 4px;">Location</label>
                                <input type="text" id="editUserLocation" style="width: 100%; padding: 10px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary);">
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                                <div>
                                    <label style="display: block; font-size: 0.85rem; color: var(--text-muted); margin-bottom: 4px;">Education</label>
                                    <select id="editUserEducation" style="width: 100%; padding: 10px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary);">
                                        <option value="high-school">High School</option>
                                        <option value="some-college">Some College</option>
                                        <option value="bachelors">Bachelor's</option>
                                        <option value="masters">Master's</option>
                                        <option value="doctorate">Doctorate</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="display: block; font-size: 0.85rem; color: var(--text-muted); margin-bottom: 4px;">Subscription</label>
                                    <select id="editUserSubscription" style="width: 100%; padding: 10px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary);">
                                        <option value="free">Free</option>
                                        <option value="premium">Premium</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div style="margin-bottom: 16px;">
                                <label style="display: block; font-size: 0.85rem; color: var(--text-muted); margin-bottom: 4px;">Occupation</label>
                                <input type="text" id="editUserOccupation" style="width: 100%; padding: 10px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary);">
                            </div>
                            
                            <div style="margin-bottom: 16px;">
                                <label style="display: block; font-size: 0.85rem; color: var(--text-muted); margin-bottom: 4px;">Status</label>
                                <select id="editUserStatus" style="width: 100%; padding: 10px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary);">
                                    <option value="active">Active</option>
                                    <option value="inactive">Inactive</option>
                                    <option value="matched">Matched</option>
                                    <option value="suspended">Suspended</option>
                                </select>
                            </div>
                            
                            <!-- Emergency Contact Section -->
                            <div style="margin-bottom: 16px; padding: 12px; background: var(--bg-tertiary); border-radius: 8px; border: 1px solid var(--border);">
                                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                                    <label style="font-size: 0.85rem; font-weight: 600; color: var(--text-muted);"> Emergency Contact</label>
                                    <span id="editUserAlertsBadge" style="font-size: 0.7rem; padding: 2px 8px; border-radius: 12px; background: var(--success); color: white;">Alerts ON</span>
                                </div>
                                <div id="editUserEmergencyDisplay" style="font-size: 0.85rem; color: var(--text-muted);">
                                    No emergency contact set
                                </div>
                                <div id="editUserEmergencyAlerts" style="margin-top: 8px; display: none;">
                                    <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 4px;">Recent Alerts:</div>
                                    <div id="editUserAlertHistory" style="max-height: 80px; overflow-y: auto; font-size: 0.75rem;"></div>
                                </div>
                            </div>
                            
                            <div style="display: flex; gap: 12px; margin-top: 24px;">
                                <button type="button" onclick="closeEditUserModal()" class="btn btn-secondary" style="flex: 1;">Cancel</button>
                                <button type="submit" class="btn btn-primary" style="flex: 1;">Save Changes</button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Delete User Confirmation Modal -->
                <div id="deleteUserModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 1000; align-items: center; justify-content: center;">
                    <div style="background: var(--bg-secondary); border-radius: 16px; padding: 24px; width: 90%; max-width: 400px; text-align: center;">
                        <div style="font-size: 3rem; margin-bottom: 16px;"></div>
                        <h3 style="margin: 0 0 12px 0;">Delete User?</h3>
                        <p style="color: var(--text-muted); margin-bottom: 8px;">Are you sure you want to delete this user?</p>
                        <p id="deleteUserName" style="font-weight: 600; color: var(--danger); margin-bottom: 20px;"></p>
                        <p style="font-size: 0.85rem; color: var(--text-muted); background: var(--bg-tertiary); padding: 12px; border-radius: 8px; margin-bottom: 20px;">
                            This action cannot be undone. All user data, matches, and messages will be permanently deleted.
                        </p>
                        <input type="hidden" id="deleteUserEmail">
                        <div style="display: flex; gap: 12px;">
                            <button onclick="closeDeleteUserModal()" class="btn btn-secondary" style="flex: 1;">Cancel</button>
                            <button onclick="confirmDeleteUser()" class="btn" style="flex: 1; background: var(--danger); color: white;">Delete User</button>
                        </div>
                    </div>
                </div>

                <!-- Admin Edit User Modal -->
                <div id="adminEditUserModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 1000; align-items: center; justify-content: center;">
                    <div style="background: var(--bg-secondary); border-radius: 16px; padding: 24px; width: 90%; max-width: 550px; max-height: 85vh; overflow-y: auto;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 style="margin: 0;"> Admin Settings</h3>
                            <button onclick="closeAdminEditModal()" style="background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 1.5rem;">&times;</button>
                        </div>
                        
                        <div style="background: rgba(255, 193, 7, 0.1); border: 1px solid var(--warning); padding: 12px; border-radius: 8px; margin-bottom: 20px;">
                            <p style="margin: 0; font-size: 0.85rem; color: var(--warning);">
                                 <strong>Admin Access:</strong> Changes here affect account security and billing. Proceed with caution.
                            </p>
                        </div>
                        
                        <form id="adminEditUserForm" onsubmit="saveAdminUserChanges(event)">
                            <input type="hidden" id="adminEditUserEmail">
                            
                            <!-- Account Section -->
                            <div style="margin-bottom: 24px;">
                                <h4 style="margin: 0 0 12px; color: var(--accent); border-bottom: 1px solid var(--border); padding-bottom: 8px;"> Account Information</h4>
                                
                                <div style="margin-bottom: 16px;">
                                    <label style="display: block; font-size: 0.85rem; color: var(--text-muted); margin-bottom: 4px;">Current Email</label>
                                    <input type="text" id="adminCurrentEmail" readonly style="width: 100%; padding: 10px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-muted);">
                                </div>
                                
                                <div style="margin-bottom: 16px;">
                                    <label style="display: block; font-size: 0.85rem; color: var(--text-muted); margin-bottom: 4px;">New Email (leave blank to keep current)</label>
                                    <input type="email" id="adminNewEmail" placeholder="Enter new email..." style="width: 100%; padding: 10px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary);">
                                </div>
                            </div>
                            
                            <!-- Password Section -->
                            <div style="margin-bottom: 24px;">
                                <h4 style="margin: 0 0 12px; color: var(--accent); border-bottom: 1px solid var(--border); padding-bottom: 8px;"> Password</h4>
                                
                                <div style="margin-bottom: 16px;">
                                    <label style="display: block; font-size: 0.85rem; color: var(--text-muted); margin-bottom: 4px;">Current Password</label>
                                    <div style="position: relative;">
                                        <input type="text" id="adminCurrentPassword" readonly style="width: 100%; padding: 10px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-secondary); font-family: monospace;">
                                        <span style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); font-size: 0.75rem; color: var(--text-muted);"> visible</span>
                                    </div>
                                </div>
                                
                                <div style="margin-bottom: 16px;">
                                    <label style="display: block; font-size: 0.85rem; color: var(--text-muted); margin-bottom: 4px;">New Password (leave blank to keep current)</label>
                                    <div style="position: relative;">
                                        <input type="password" id="adminNewPassword" placeholder="Enter new password..." style="width: 100%; padding: 10px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary);">
                                        <button type="button" onclick="togglePasswordVisibility()" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; color: var(--text-muted); cursor: pointer;"></button>
                                    </div>
                                    <small style="color: var(--text-muted); font-size: 0.75rem;">Minimum 8 characters</small>
                                </div>
                                
                                <div>
                                    <label style="display: block; font-size: 0.85rem; color: var(--text-muted); margin-bottom: 4px;">Confirm New Password</label>
                                    <input type="password" id="adminConfirmPassword" placeholder="Confirm new password..." style="width: 100%; padding: 10px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary);">
                                </div>
                            </div>
                            
                            <!-- Payment Section -->
                            <div style="margin-bottom: 24px;">
                                <h4 style="margin: 0 0 12px; color: var(--accent); border-bottom: 1px solid var(--border); padding-bottom: 8px;"> Payment Information</h4>
                                
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                                    <div style="grid-column: span 2;">
                                        <label style="display: block; font-size: 0.85rem; color: var(--text-muted); margin-bottom: 4px;">Card Number</label>
                                        <input type="text" id="adminCardNumber" placeholder="   " maxlength="19" style="width: 100%; padding: 10px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); font-family: monospace;">
                                    </div>
                                    <div>
                                        <label style="display: block; font-size: 0.85rem; color: var(--text-muted); margin-bottom: 4px;">Expiry Date</label>
                                        <input type="text" id="adminCardExpiry" placeholder="MM/YY" maxlength="5" style="width: 100%; padding: 10px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary);">
                                    </div>
                                    <div>
                                        <label style="display: block; font-size: 0.85rem; color: var(--text-muted); margin-bottom: 4px;">CVV</label>
                                        <input type="password" id="adminCardCVV" placeholder="" maxlength="4" style="width: 100%; padding: 10px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary);">
                                    </div>
                                </div>
                                
                                <div>
                                    <label style="display: block; font-size: 0.85rem; color: var(--text-muted); margin-bottom: 4px;">Billing Address</label>
                                    <input type="text" id="adminBillingAddress" placeholder="Street address, City, State, ZIP" style="width: 100%; padding: 10px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary);">
                                </div>
                            </div>
                            
                            <!-- Subscription Override -->
                            <div style="margin-bottom: 24px;">
                                <h4 style="margin: 0 0 12px; color: var(--accent); border-bottom: 1px solid var(--border); padding-bottom: 8px;"> Subscription Management</h4>
                                
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                    <div>
                                        <label style="display: block; font-size: 0.85rem; color: var(--text-muted); margin-bottom: 4px;">Subscription Status</label>
                                        <select id="adminSubscriptionType" style="width: 100%; padding: 10px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary);">
                                            <option value="free">Free</option>
                                            <option value="premium">Premium</option>
                                            <option value="trial">Trial</option>
                                            <option value="lifetime">Lifetime</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label style="display: block; font-size: 0.85rem; color: var(--text-muted); margin-bottom: 4px;">Subscription Expires</label>
                                        <input type="date" id="adminSubscriptionExpiry" style="width: 100%; padding: 10px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary);">
                                    </div>
                                </div>
                                
                                <div style="margin-top: 12px;">
                                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                        <input type="checkbox" id="adminAutoRenew" style="width: 18px; height: 18px;">
                                        <span style="font-size: 0.9rem; color: var(--text-secondary);">Auto-renew subscription</span>
                                    </label>
                                </div>
                            </div>
                            
                            <!-- Account Status -->
                            <div style="margin-bottom: 24px;">
                                <h4 style="margin: 0 0 12px; color: var(--accent); border-bottom: 1px solid var(--border); padding-bottom: 8px;"> Account Status</h4>
                                
                                <div style="display: flex; flex-wrap: wrap; gap: 12px;">
                                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                        <input type="checkbox" id="adminVerified" style="width: 18px; height: 18px;">
                                        <span style="font-size: 0.9rem; color: var(--text-secondary);">Email Verified </span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                        <input type="checkbox" id="adminSuspended" style="width: 18px; height: 18px;">
                                        <span style="font-size: 0.9rem; color: var(--danger);">Account Suspended </span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                        <input type="checkbox" id="adminFlagged" style="width: 18px; height: 18px;">
                                        <span style="font-size: 0.9rem; color: var(--warning);">Flagged for Review </span>
                                    </label>
                                </div>
                            </div>
                            
                            <!-- Admin Notes -->
                            <div style="margin-bottom: 24px;">
                                <h4 style="margin: 0 0 12px; color: var(--accent); border-bottom: 1px solid var(--border); padding-bottom: 8px;"> Admin Notes</h4>
                                <textarea id="adminNotes" rows="3" placeholder="Internal notes about this user..." style="width: 100%; padding: 10px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); resize: vertical;"></textarea>
                            </div>
                            
                            <div style="display: flex; gap: 12px; margin-top: 24px;">
                                <button type="button" onclick="closeAdminEditModal()" class="btn btn-secondary" style="flex: 1;">Cancel</button>
                                <button type="submit" class="btn btn-primary" style="flex: 1;">Save Admin Changes</button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- User Demographics -->
                <div class="cards-grid" style="margin-top: 20px;">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"> Gender Distribution</h3>
                        </div>
                        <div class="card-body" id="genderDistribution">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"> Education Levels</h3>
                        </div>
                        <div class="card-body" id="educationDistribution">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>

                <div class="cards-grid" style="margin-top: 20px;">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"> Age Distribution</h3>
                        </div>
                        <div class="card-body" id="ageDistribution">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"> Top Occupations</h3>
                        </div>
                        <div class="card-body" id="occupationDistribution">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Matches Section -->
            <div id="matches-section" style="display: none;">
                <div class="page-header">
                    <div>
                        <h2 class="page-title">Matches</h2>
                        <p class="page-subtitle">Match history and analytics</p>
                    </div>
                </div>

                <div class="stats-grid" id="matchStats">
                    <!-- Populated by JS -->
                </div>

                <!-- Match Activity Chart -->
                <div class="cards-grid" style="margin-bottom: 20px;">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"> Match Activity</h3>
                            <span class="stat-change positive" id="matchActivityTrend">Weekly</span>
                        </div>
                        <div class="card-body">
                            <div class="chart-container" id="matchActivityChart" style="display: flex; align-items: flex-end; justify-content: space-between; gap: 8px; height: 150px; padding: 20px 0;">
                                <!-- Populated by JS -->
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"> Match Breakdown</h3>
                        </div>
                        <div class="card-body" id="matchBreakdown">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>

                <div class="table-container">
                    <div class="card-header">
                        <h3 class="card-title">Match History</h3>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Match</th>
                                <th>Compatibility</th>
                                <th>Status</th>
                                <th>Messages</th>
                                <th>Date Planned</th>
                                <th>Duration</th>
                            </tr>
                        </thead>
                        <tbody id="matchesTable">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Conversion Funnel Section -->
            <div id="funnel-section" style="display: none;">
                <div class="page-header">
                    <div>
                        <h2 class="page-title">Conversion Funnel</h2>
                        <p class="page-subtitle">User journey from signup to date</p>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title"> Funnel Analysis</h3>
                    </div>
                    <div class="card-body">
                        <div class="funnel-container" id="funnelChart">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>

                <div class="cards-grid">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"> Conversion Rates</h3>
                        </div>
                        <div class="card-body" id="conversionRates">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"> Average Time Between Steps</h3>
                        </div>
                        <div class="card-body" id="stepTimes">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Revenue Section -->
            <div id="revenue-section" style="display: none;">
                <div class="page-header">
                    <div>
                        <h2 class="page-title"> Revenue</h2>
                        <p class="page-subtitle">Subscription and revenue metrics from AWS</p>
                    </div>
                    <div class="header-actions">
                        <span id="revenueDataSource" class="status-badge" style="background: var(--info);">Loading...</span>
                        <button class="btn btn-secondary" onclick="renderRevenue()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M23 4v6h-6M1 20v-6h6"/>
                                <path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/>
                            </svg>
                            Refresh
                        </button>
                    </div>
                </div>

                <div class="stats-grid">
                    <div class="stat-card revenue">
                        <div class="stat-icon revenue"></div>
                        <div class="stat-value" id="mrrValue">--</div>
                        <div class="stat-label">Monthly Recurring Revenue</div>
                    </div>
                    <div class="stat-card users">
                        <div class="stat-icon users"></div>
                        <div class="stat-value" id="premiumUsers">--</div>
                        <div class="stat-label">Premium Subscribers</div>
                    </div>
                    <div class="stat-card matches">
                        <div class="stat-icon matches"></div>
                        <div class="stat-value" id="conversionRate">--</div>
                        <div class="stat-label">Free  Premium Rate</div>
                    </div>
                    <div class="stat-card danger">
                        <div class="stat-icon safety"></div>
                        <div class="stat-value" id="churnRate">--</div>
                        <div class="stat-label">Monthly Churn</div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title"> Revenue Trend (Last 6 Months)</h3>
                    </div>
                    <div class="card-body">
                        <div class="revenue-chart" id="revenueChart">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>

                <div class="cards-grid">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"> Subscription Breakdown</h3>
                        </div>
                        <div class="card-body" id="subscriptionBreakdown">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"> LTV & CAC</h3>
                        </div>
                        <div class="card-body" id="ltvCac">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>
                
                <!-- Bank Account Settings -->
                <div class="card" style="margin-top: 20px;">
                    <div class="card-header">
                        <h3 class="card-title"> Bank Account Settings</h3>
                        <button class="btn btn-primary btn-small" onclick="saveBankAccount()">Save Changes</button>
                    </div>
                    <div class="card-body">
                        <p style="color: var(--text-muted); margin-bottom: 16px; font-size: 0.9rem;">Configure where subscription payments are deposited</p>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                            <div>
                                <label style="display: block; font-size: 0.85rem; color: var(--text-muted); margin-bottom: 4px;">Bank Name</label>
                                <input type="text" id="bankName" placeholder="e.g., Chase Bank" style="width: 100%; padding: 10px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary);">
                            </div>
                            <div>
                                <label style="display: block; font-size: 0.85rem; color: var(--text-muted); margin-bottom: 4px;">Account Holder Name</label>
                                <input type="text" id="bankAccountHolder" placeholder="Business or personal name" style="width: 100%; padding: 10px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary);">
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 12px;">
                            <div>
                                <label style="display: block; font-size: 0.85rem; color: var(--text-muted); margin-bottom: 4px;">Routing Number</label>
                                <input type="text" id="bankRouting" placeholder="9-digit routing number" maxlength="9" style="width: 100%; padding: 10px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary);">
                            </div>
                            <div>
                                <label style="display: block; font-size: 0.85rem; color: var(--text-muted); margin-bottom: 4px;">Account Number</label>
                                <input type="password" id="bankAccount" placeholder="Account number" style="width: 100%; padding: 10px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary);">
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 12px;">
                            <div>
                                <label style="display: block; font-size: 0.85rem; color: var(--text-muted); margin-bottom: 4px;">Account Type</label>
                                <select id="bankAccountType" style="width: 100%; padding: 10px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary);">
                                    <option value="checking">Checking</option>
                                    <option value="savings">Savings</option>
                                    <option value="business">Business Checking</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; font-size: 0.85rem; color: var(--text-muted); margin-bottom: 4px;">Payout Schedule</label>
                                <select id="payoutSchedule" style="width: 100%; padding: 10px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary);">
                                    <option value="daily">Daily</option>
                                    <option value="weekly">Weekly</option>
                                    <option value="monthly">Monthly</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Bank Account Status -->
                        <div id="bankAccountStatus" style="margin-top: 16px; padding: 12px; background: var(--bg-tertiary); border-radius: 8px; display: none;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span style="color: var(--success);"></span>
                                <span style="font-weight: 500;">Bank Account Connected</span>
                            </div>
                            <div style="font-size: 0.85rem; color: var(--text-muted); margin-top: 4px;">
                                <span id="connectedBankDisplay">Chase Bank ****1234</span>  <span id="lastPayoutDate">Last payout: -</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Recent Transactions -->
                <div class="card" style="margin-top: 20px;">
                    <div class="card-header">
                        <h3 class="card-title"> Recent Transactions</h3>
                        <button class="btn btn-secondary btn-small" onclick="exportTransactions()">Export CSV</button>
                    </div>
                    <div class="card-body">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>User</th>
                                    <th>Type</th>
                                    <th>Amount</th>
                                    <th>Status</th>
                                    <th>Payout</th>
                                </tr>
                            </thead>
                            <tbody id="transactionsTable">
                                <!-- Populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Advertising Section -->
            <div id="advertising-section" style="display: none;">
                <div class="page-header">
                    <div>
                        <h2 class="page-title"> Advertising</h2>
                        <p class="page-subtitle">Campaign performance, spending, and visibility metrics</p>
                    </div>
                    <div class="header-actions">
                        <span id="advertisingDataSource" class="status-badge" style="background: var(--info);">Loading...</span>
                        <button class="btn btn-secondary" onclick="refreshAdvertisingData()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M23 4v6h-6M1 20v-6h6"/>
                                <path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/>
                            </svg>
                            Refresh
                        </button>
                        <button class="btn btn-primary" onclick="showCreateCampaignModal()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="12" y1="5" x2="12" y2="19"/>
                                <line x1="5" y1="12" x2="19" y2="12"/>
                            </svg>
                            New Campaign
                        </button>
                    </div>
                </div>

                <!-- Advertising Stats -->
                <div class="stats-grid">
                    <div class="stat-card revenue">
                        <div class="stat-icon revenue"></div>
                        <div class="stat-value" id="adTotalSpend">$0</div>
                        <div class="stat-label">Total Ad Spend (MTD)</div>
                    </div>
                    <div class="stat-card users">
                        <div class="stat-icon users"></div>
                        <div class="stat-value" id="adImpressions">0</div>
                        <div class="stat-label">Total Impressions</div>
                    </div>
                    <div class="stat-card matches">
                        <div class="stat-icon matches"></div>
                        <div class="stat-value" id="adClicks">0</div>
                        <div class="stat-label">Total Clicks</div>
                    </div>
                    <div class="stat-card success">
                        <div class="stat-icon safety"></div>
                        <div class="stat-value" id="adConversions">0</div>
                        <div class="stat-label">Conversions (Installs)</div>
                    </div>
                </div>

                <!-- Performance Metrics -->
                <div class="stats-grid" style="margin-top: 16px;">
                    <div class="stat-card">
                        <div class="stat-icon"></div>
                        <div class="stat-value" id="adCTR">0%</div>
                        <div class="stat-label">Click-Through Rate</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"></div>
                        <div class="stat-value" id="adCPC">$0</div>
                        <div class="stat-label">Cost Per Click</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"></div>
                        <div class="stat-value" id="adCPI">$0</div>
                        <div class="stat-label">Cost Per Install</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"></div>
                        <div class="stat-value" id="adROAS">0x</div>
                        <div class="stat-label">Return on Ad Spend</div>
                    </div>
                </div>

                <!-- Active Campaigns -->
                <div class="card" style="margin-top: 20px;">
                    <div class="card-header">
                        <h3 class="card-title"> Active Campaigns</h3>
                        <div style="display: flex; gap: 8px;">
                            <select id="campaignFilter" style="padding: 6px 12px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary);" onchange="filterCampaigns()">
                                <option value="all">All Platforms</option>
                                <option value="google">Google Ads</option>
                                <option value="meta">Meta (FB/IG)</option>
                                <option value="tiktok">TikTok</option>
                                <option value="apple">Apple Search Ads</option>
                                <option value="twitter">Twitter/X</option>
                            </select>
                        </div>
                    </div>
                    <div class="card-body">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Campaign</th>
                                    <th>Platform</th>
                                    <th>Status</th>
                                    <th>Budget</th>
                                    <th>Spent</th>
                                    <th>Impressions</th>
                                    <th>Clicks</th>
                                    <th>CTR</th>
                                    <th>CPC</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="campaignsTableBody">
                                <tr>
                                    <td colspan="10" style="text-align: center; color: var(--text-muted); padding: 40px;">
                                        Loading campaigns...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Spending by Platform -->
                <div class="cards-grid" style="margin-top: 20px;">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"> Spending by Platform</h3>
                        </div>
                        <div class="card-body" id="platformSpendingChart">
                            <div style="display: flex; flex-direction: column; gap: 12px;">
                                <div class="platform-spend-row" data-platform="google">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                                        <span> Google Ads</span>
                                        <span id="googleSpend">$0</span>
                                    </div>
                                    <div style="height: 8px; background: var(--bg-tertiary); border-radius: 4px; overflow: hidden;">
                                        <div id="googleSpendBar" style="height: 100%; background: #4285F4; width: 0%; transition: width 0.5s;"></div>
                                    </div>
                                </div>
                                <div class="platform-spend-row" data-platform="meta">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                                        <span> Meta (FB/IG)</span>
                                        <span id="metaSpend">$0</span>
                                    </div>
                                    <div style="height: 8px; background: var(--bg-tertiary); border-radius: 4px; overflow: hidden;">
                                        <div id="metaSpendBar" style="height: 100%; background: #1877F2; width: 0%; transition: width 0.5s;"></div>
                                    </div>
                                </div>
                                <div class="platform-spend-row" data-platform="tiktok">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                                        <span> TikTok</span>
                                        <span id="tiktokSpend">$0</span>
                                    </div>
                                    <div style="height: 8px; background: var(--bg-tertiary); border-radius: 4px; overflow: hidden;">
                                        <div id="tiktokSpendBar" style="height: 100%; background: #000000; width: 0%; transition: width 0.5s;"></div>
                                    </div>
                                </div>
                                <div class="platform-spend-row" data-platform="apple">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                                        <span> Apple Search Ads</span>
                                        <span id="appleSpend">$0</span>
                                    </div>
                                    <div style="height: 8px; background: var(--bg-tertiary); border-radius: 4px; overflow: hidden;">
                                        <div id="appleSpendBar" style="height: 100%; background: #A2AAAD; width: 0%; transition: width 0.5s;"></div>
                                    </div>
                                </div>
                                <div class="platform-spend-row" data-platform="twitter">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                                        <span> Twitter/X</span>
                                        <span id="twitterSpend">$0</span>
                                    </div>
                                    <div style="height: 8px; background: var(--bg-tertiary); border-radius: 4px; overflow: hidden;">
                                        <div id="twitterSpendBar" style="height: 100%; background: #1DA1F2; width: 0%; transition: width 0.5s;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"> Daily Spend Trend</h3>
                        </div>
                        <div class="card-body" id="dailySpendChart">
                            <div style="display: flex; align-items: flex-end; justify-content: space-between; height: 150px; gap: 4px;" id="spendTrendBars">
                                <!-- Populated by JS -->
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-top: 8px; font-size: 11px; color: var(--text-muted);" id="spendTrendLabels">
                                <!-- Populated by JS -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Budget Settings -->
                <div class="card" style="margin-top: 20px;">
                    <div class="card-header">
                        <h3 class="card-title"> Budget Settings</h3>
                        <button class="btn btn-primary btn-small" onclick="saveAdvertisingBudget()">Save Changes</button>
                    </div>
                    <div class="card-body">
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px;">
                            <div>
                                <label style="display: block; font-size: 0.85rem; color: var(--text-muted); margin-bottom: 4px;">Daily Budget Limit</label>
                                <div style="position: relative;">
                                    <span style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-muted);">$</span>
                                    <input type="number" id="dailyBudgetLimit" placeholder="500" style="width: 100%; padding: 10px 10px 10px 28px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary);">
                                </div>
                            </div>
                            <div>
                                <label style="display: block; font-size: 0.85rem; color: var(--text-muted); margin-bottom: 4px;">Monthly Budget Cap</label>
                                <div style="position: relative;">
                                    <span style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-muted);">$</span>
                                    <input type="number" id="monthlyBudgetCap" placeholder="10000" style="width: 100%; padding: 10px 10px 10px 28px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary);">
                                </div>
                            </div>
                            <div>
                                <label style="display: block; font-size: 0.85rem; color: var(--text-muted); margin-bottom: 4px;">Alert Threshold (%)</label>
                                <input type="number" id="budgetAlertThreshold" placeholder="80" min="0" max="100" style="width: 100%; padding: 10px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary);">
                            </div>
                        </div>
                        
                        <div style="margin-top: 16px; padding: 12px; background: var(--bg-tertiary); border-radius: 8px;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="font-weight: 500;">Monthly Budget Usage</span>
                                <span id="budgetUsagePercent" style="font-weight: 600; color: var(--success);">0%</span>
                            </div>
                            <div style="height: 8px; background: var(--bg-secondary); border-radius: 4px; margin-top: 8px; overflow: hidden;">
                                <div id="budgetUsageBar" style="height: 100%; background: var(--success); width: 0%; transition: width 0.5s;"></div>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-top: 4px; font-size: 12px; color: var(--text-muted);">
                                <span>Spent: <span id="budgetSpentAmount">$0</span></span>
                                <span>Remaining: <span id="budgetRemainingAmount">$0</span></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Audience Targeting -->
                <div class="card" style="margin-top: 20px;">
                    <div class="card-header">
                        <h3 class="card-title"> Audience Insights</h3>
                    </div>
                    <div class="card-body">
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px;">
                            <div style="padding: 16px; background: var(--bg-tertiary); border-radius: 8px; text-align: center;">
                                <div style="font-size: 24px; margin-bottom: 8px;"></div>
                                <div style="font-size: 1.5rem; font-weight: 700;" id="audienceReach">0</div>
                                <div style="font-size: 0.85rem; color: var(--text-muted);">Total Reach</div>
                            </div>
                            <div style="padding: 16px; background: var(--bg-tertiary); border-radius: 8px; text-align: center;">
                                <div style="font-size: 24px; margin-bottom: 8px;"></div>
                                <div style="font-size: 1.5rem; font-weight: 700;" id="topAgeGroup">18-24</div>
                                <div style="font-size: 0.85rem; color: var(--text-muted);">Top Age Group</div>
                            </div>
                            <div style="padding: 16px; background: var(--bg-tertiary); border-radius: 8px; text-align: center;">
                                <div style="font-size: 24px; margin-bottom: 8px;"></div>
                                <div style="font-size: 1.5rem; font-weight: 700;" id="topLocation">--</div>
                                <div style="font-size: 0.85rem; color: var(--text-muted);">Top Location</div>
                            </div>
                            <div style="padding: 16px; background: var(--bg-tertiary); border-radius: 8px; text-align: center;">
                                <div style="font-size: 24px; margin-bottom: 8px;"></div>
                                <div style="font-size: 1.5rem; font-weight: 700;" id="topDevice">iOS</div>
                                <div style="font-size: 0.85rem; color: var(--text-muted);">Top Device</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Geographic Section -->
            <div id="geographic-section" style="display: none;">
                <div class="page-header">
                    <div>
                        <h2 class="page-title">Geographic Distribution</h2>
                        <p class="page-subtitle">User locations and regional analytics</p>
                    </div>
                </div>

                <div class="cards-grid">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"> User Map</h3>
                        </div>
                        <div class="card-body">
                            <div class="map-container">
                                <span class="map-icon"></span>
                                <span style="color: var(--text-muted);">Map visualization coming soon</span>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"> Top Locations</h3>
                        </div>
                        <div class="card-body">
                            <div class="location-list" id="locationList">
                                <!-- Populated by JS -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Safety Section -->
            <div id="safety-section" style="display: none;">
                <div class="page-header">
                    <div>
                        <h2 class="page-title">Safety & Reports</h2>
                        <p class="page-subtitle">User reports, safety alerts, and moderation</p>
                    </div>
                    <div class="header-actions">
                        <button class="btn btn-secondary" onclick="exportReports()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"/>
                            </svg>
                            Export Reports
                        </button>
                    </div>
                </div>

                <!-- Safety Tabs -->
                <div class="tabs" style="margin-bottom: 20px;">
                    <div class="tab active" onclick="switchSafetyTab('reports')">Pending Reports</div>
                    <div class="tab" onclick="switchSafetyTab('suspended')">Suspended Users</div>
                    <div class="tab" onclick="switchSafetyTab('moderation')">Content Queue</div>
                    <div class="tab" onclick="switchSafetyTab('history')">Action History</div>
                </div>

                <div class="stats-grid">
                    <div class="stat-card safety">
                        <div class="stat-icon safety"></div>
                        <div class="stat-value" id="openReports">3</div>
                        <div class="stat-label">Open Reports</div>
                    </div>
                    <div class="stat-card users">
                        <div class="stat-icon users"></div>
                        <div class="stat-value" id="suspendedCount">2</div>
                        <div class="stat-label">Suspended Users</div>
                    </div>
                    <div class="stat-card warning">
                        <div class="stat-icon revenue"></div>
                        <div class="stat-value" id="flaggedUsers">1</div>
                        <div class="stat-label">Flagged Users</div>
                    </div>
                    <div class="stat-card messages">
                        <div class="stat-icon messages"></div>
                        <div class="stat-value" id="resolvedReports">12</div>
                        <div class="stat-label">Resolved This Month</div>
                    </div>
                </div>

                <!-- Reports Tab Content -->
                <div id="safety-reports-tab">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"> Pending Reports</h3>
                            <div class="card-actions">
                                <select id="reportFilterType" onchange="filterReports()" style="padding: 6px 10px; border-radius: 6px; border: 1px solid var(--border); background: var(--bg-tertiary); color: var(--text-primary); font-size: 0.85rem;">
                                    <option value="all">All Types</option>
                                    <option value="underage"> Underage</option>
                                    <option value="threatening"> Threatening</option>
                                    <option value="hate-speech"> Hate Speech</option>
                                    <option value="harassment">Harassment</option>
                                    <option value="fake-profile">Fake Profile</option>
                                    <option value="spam">Spam</option>
                                    <option value="explicit-content">Explicit Content</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                        </div>
                        <div class="card-body" id="pendingReports">
                            <!-- Populated by JS -->
                        </div>
                    </div>

                    <div class="card" style="margin-top: 20px;">
                        <div class="card-header">
                            <h3 class="card-title"> Emergency Contact Alerts</h3>
                        </div>
                        <div class="card-body" id="safetyAlertsList">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>

                <!-- Suspended Users Tab Content -->
                <div id="safety-suspended-tab" style="display: none;">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"> Suspended Users</h3>
                        </div>
                        <div class="card-body" id="suspendedUsersList">
                            <!-- Populated by JS -->
                            <div class="empty-state" style="text-align: center; padding: 40px; color: var(--text-muted);">
                                <div style="font-size: 3rem; margin-bottom: 12px;"></div>
                                <p>No suspended users</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Content Moderation Queue Tab Content -->
                <div id="safety-moderation-tab" style="display: none;">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"> Content Moderation Queue</h3>
                            <span class="status-badge warning">Coming Soon</span>
                        </div>
                        <div class="card-body">
                            <div class="empty-state" style="text-align: center; padding: 40px; color: var(--text-muted);">
                                <div style="font-size: 3rem; margin-bottom: 12px;"></div>
                                <p>AI-powered content moderation will automatically flag photos for review</p>
                                <p style="font-size: 0.85rem; margin-top: 8px;">Integration with Hive/AWS Rekognition coming soon</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Action History Tab Content -->
                <div id="safety-history-tab" style="display: none;">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"> Moderation Action History</h3>
                            <div class="card-actions">
                                <select id="actionHistoryFilter" onchange="filterActionHistory()" style="padding: 6px 10px; border-radius: 6px; border: 1px solid var(--border); background: var(--bg-tertiary); color: var(--text-primary); font-size: 0.85rem;">
                                    <option value="all">All Actions</option>
                                    <option value="warning">Warnings</option>
                                    <option value="suspend">Suspensions</option>
                                    <option value="ban">Bans</option>
                                    <option value="unsuspend">Unsuspensions</option>
                                </select>
                            </div>
                        </div>
                        <div class="card-body" id="actionHistoryList">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Report Review Modal -->
            <div id="reportReviewModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 1000; align-items: center; justify-content: center;">
                <div style="background: var(--bg-secondary); border-radius: 16px; padding: 24px; width: 90%; max-width: 600px; max-height: 85vh; overflow-y: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="margin: 0;"> Review Report</h3>
                        <button onclick="closeReportReviewModal()" style="background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 1.5rem;">&times;</button>
                    </div>
                    
                    <!-- Report Details -->
                    <div style="background: var(--bg-tertiary); padding: 16px; border-radius: 12px; margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
                            <span id="reportReviewType" class="status-badge warning">Loading...</span>
                            <span id="reportReviewDate" style="font-size: 0.85rem; color: var(--text-muted);">--</span>
                        </div>
                        <p id="reportReviewDescription" style="font-size: 0.9rem; color: var(--text-secondary); margin: 0;">Loading description...</p>
                    </div>

                    <!-- Reported User Info -->
                    <div style="margin-bottom: 20px;">
                        <h4 style="font-size: 0.9rem; color: var(--accent); margin-bottom: 12px;">Reported User</h4>
                        <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--bg-tertiary); border-radius: 8px;">
                            <div id="reportedUserAvatar" style="width: 50px; height: 50px; border-radius: 50%; background: var(--accent-light);"></div>
                            <div>
                                <div id="reportedUserName" style="font-weight: 600;">--</div>
                                <div id="reportedUserEmail" style="font-size: 0.85rem; color: var(--text-muted);">--</div>
                            </div>
                            <button onclick="viewReportedUserProfile()" class="btn btn-secondary" style="margin-left: auto; padding: 6px 12px; font-size: 0.8rem;">View Profile</button>
                        </div>
                        <div style="margin-top: 8px; font-size: 0.85rem; color: var(--text-muted);">
                            <span>Previous reports against this user: <strong id="reportedUserPreviousReports">0</strong></span>
                            <span style="margin-left: 16px;">Account status: <span id="reportedUserStatus" class="status-badge active">Active</span></span>
                        </div>
                    </div>

                    <!-- Reporter Info -->
                    <div style="margin-bottom: 20px;">
                        <h4 style="font-size: 0.9rem; color: var(--accent); margin-bottom: 12px;">Reported By</h4>
                        <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--bg-tertiary); border-radius: 8px;">
                            <div id="reporterAvatar" style="width: 40px; height: 40px; border-radius: 50%; background: var(--accent-light);"></div>
                            <div>
                                <div id="reporterName" style="font-weight: 500; font-size: 0.9rem;">--</div>
                                <div id="reporterEmail" style="font-size: 0.8rem; color: var(--text-muted);">--</div>
                            </div>
                        </div>
                    </div>

                    <!-- Resolution Notes -->
                    <div style="margin-bottom: 20px;">
                        <h4 style="font-size: 0.9rem; color: var(--accent); margin-bottom: 12px;">Resolution Notes</h4>
                        <textarea id="reportResolutionNotes" rows="3" placeholder="Add notes about this report resolution..." style="width: 100%; padding: 12px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); resize: vertical; font-size: 0.9rem;"></textarea>
                    </div>

                    <!-- Action Buttons -->
                    <div style="border-top: 1px solid var(--border); padding-top: 20px;">
                        <h4 style="font-size: 0.9rem; color: var(--accent); margin-bottom: 12px;">Take Action</h4>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                            <button onclick="resolveReportWithAction('dismiss')" class="btn btn-secondary" style="padding: 12px;">
                                 Dismiss Report
                            </button>
                            <button onclick="resolveReportWithAction('warning')" class="btn" style="padding: 12px; background: var(--warning); color: white;">
                                 Send Warning
                            </button>
                            <button onclick="resolveReportWithAction('suspend-7')" class="btn" style="padding: 12px; background: #f97316; color: white;">
                                 Suspend 7 Days
                            </button>
                            <button onclick="resolveReportWithAction('suspend-30')" class="btn" style="padding: 12px; background: #ea580c; color: white;">
                                 Suspend 30 Days
                            </button>
                            <button onclick="resolveReportWithAction('ban')" class="btn" style="padding: 12px; background: var(--danger); color: white; grid-column: span 2;">
                                 Permanent Ban
                            </button>
                        </div>
                    </div>

                    <input type="hidden" id="reviewingReportId">
                    <input type="hidden" id="reportedUserEmailHidden">
                </div>
            </div>

            <!-- Moderation Action Modal (Quick Actions) -->
            <div id="moderationActionModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 1000; align-items: center; justify-content: center;">
                <div style="background: var(--bg-secondary); border-radius: 16px; padding: 24px; width: 90%; max-width: 450px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="margin: 0;"> Quick Moderation</h3>
                        <button onclick="closeModerationModal()" style="background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 1.5rem;">&times;</button>
                    </div>
                    
                    <div style="text-align: center; margin-bottom: 20px;">
                        <div id="modUserAvatar" style="width: 60px; height: 60px; border-radius: 50%; background: var(--accent-light); margin: 0 auto 12px;"></div>
                        <div id="modUserName" style="font-weight: 600; font-size: 1.1rem;">--</div>
                        <div id="modUserEmail" style="font-size: 0.85rem; color: var(--text-muted);">--</div>
                    </div>

                    <div style="margin-bottom: 16px;">
                        <label style="display: block; font-size: 0.85rem; color: var(--text-muted); margin-bottom: 6px;">Reason (optional)</label>
                        <textarea id="modActionReason" rows="2" placeholder="Reason for action..." style="width: 100%; padding: 10px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); resize: none; font-size: 0.9rem;"></textarea>
                    </div>

                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <button onclick="executeModAction('warning')" class="btn" style="padding: 12px; background: var(--warning); color: white; justify-content: center;">
                             Send Warning
                        </button>
                        <button onclick="executeModAction('suspend-7')" class="btn" style="padding: 12px; background: #f97316; color: white; justify-content: center;">
                             Suspend 7 Days
                        </button>
                        <button onclick="executeModAction('suspend-30')" class="btn" style="padding: 12px; background: #ea580c; color: white; justify-content: center;">
                             Suspend 30 Days
                        </button>
                        <button onclick="executeModAction('ban')" class="btn" style="padding: 12px; background: var(--danger); color: white; justify-content: center;">
                             Permanent Ban
                        </button>
                        <button onclick="executeModAction('unsuspend')" id="modUnsuspendBtn" class="btn btn-secondary" style="padding: 12px; justify-content: center; display: none;">
                             Unsuspend User
                        </button>
                    </div>

                    <input type="hidden" id="modTargetUserEmail">
                </div>
            </div>

            <!-- Compliance Section -->
            <div id="compliance-section" style="display: none;">
                <div class="page-header">
                    <div>
                        <h2 class="page-title">Compliance & Audit</h2>
                        <p class="page-subtitle">Data requests, audit logs, and compliance tracking</p>
                    </div>
                </div>

                <!-- Compliance Tabs -->
                <div class="tabs" style="margin-bottom: 20px;">
                    <div class="tab active" onclick="switchComplianceTab('deletion')">Data Deletion Requests</div>
                    <div class="tab" onclick="switchComplianceTab('audit')">Audit Log</div>
                    <div class="tab" onclick="switchComplianceTab('exports')">Data Exports</div>
                </div>

                <div class="stats-grid">
                    <div class="stat-card safety">
                        <div class="stat-icon safety"></div>
                        <div class="stat-value" id="pendingDeletions">0</div>
                        <div class="stat-label">Pending Deletions</div>
                    </div>
                    <div class="stat-card users">
                        <div class="stat-icon users"></div>
                        <div class="stat-value" id="completedDeletions">5</div>
                        <div class="stat-label">Completed (30 days)</div>
                    </div>
                    <div class="stat-card messages">
                        <div class="stat-icon messages"></div>
                        <div class="stat-value" id="dataExports">3</div>
                        <div class="stat-label">Data Exports (30 days)</div>
                    </div>
                    <div class="stat-card revenue">
                        <div class="stat-icon revenue"></div>
                        <div class="stat-value" id="auditEvents">127</div>
                        <div class="stat-label">Audit Events (30 days)</div>
                    </div>
                </div>

                <!-- Data Deletion Tab -->
                <div id="compliance-deletion-tab">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"> Data Deletion Request Queue</h3>
                        </div>
                        <div class="card-body" id="deletionRequestsList">
                            <div class="empty-state" style="text-align: center; padding: 40px; color: var(--text-muted);">
                                <div style="font-size: 3rem; margin-bottom: 12px;"></div>
                                <p>No pending deletion requests</p>
                                <p style="font-size: 0.85rem; margin-top: 8px;">User deletion requests will appear here for processing</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Audit Log Tab -->
                <div id="compliance-audit-tab" style="display: none;">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"> Audit Log</h3>
                            <div class="card-actions">
                                <select id="auditLogFilter" onchange="filterAuditLog()" style="padding: 6px 10px; border-radius: 6px; border: 1px solid var(--border); background: var(--bg-tertiary); color: var(--text-primary); font-size: 0.85rem;">
                                    <option value="all">All Events</option>
                                    <option value="admin_login">Admin Logins</option>
                                    <option value="user_action">User Actions</option>
                                    <option value="moderation">Moderation</option>
                                    <option value="data_access">Data Access</option>
                                    <option value="config_change">Config Changes</option>
                                </select>
                                <button class="btn btn-secondary" onclick="exportAuditLog()" style="margin-left: 10px; padding: 6px 12px; font-size: 0.85rem;">
                                    Export Log
                                </button>
                            </div>
                        </div>
                        <div class="card-body" id="auditLogList">
                            <!-- Audit log entries -->
                            <div style="overflow-x: auto;">
                                <table style="width: 100%; border-collapse: collapse; font-size: 0.85rem;">
                                    <thead>
                                        <tr style="border-bottom: 1px solid var(--border);">
                                            <th style="padding: 12px 8px; text-align: left; color: var(--text-muted);">Timestamp</th>
                                            <th style="padding: 12px 8px; text-align: left; color: var(--text-muted);">Admin</th>
                                            <th style="padding: 12px 8px; text-align: left; color: var(--text-muted);">Action</th>
                                            <th style="padding: 12px 8px; text-align: left; color: var(--text-muted);">Target</th>
                                            <th style="padding: 12px 8px; text-align: left; color: var(--text-muted);">Details</th>
                                        </tr>
                                    </thead>
                                    <tbody id="auditLogTableBody">
                                        <!-- Populated by JS -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Data Exports Tab -->
                <div id="compliance-exports-tab" style="display: none;">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"> Data Export History</h3>
                        </div>
                        <div class="card-body" id="dataExportsList">
                            <div class="empty-state" style="text-align: center; padding: 40px; color: var(--text-muted);">
                                <div style="font-size: 3rem; margin-bottom: 12px;"></div>
                                <p>No data exports in the last 30 days</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Feedback Section -->
            <div id="feedback-section" style="display: none;">
                <div class="page-header">
                    <div>
                        <h2 class="page-title">User Feedback</h2>
                        <p class="page-subtitle">Match feedback and cancellation reasons</p>
                    </div>
                </div>

                <div class="tabs">
                    <div class="tab active" onclick="switchFeedbackTab('cancellation')">Cancellation Reasons</div>
                    <div class="tab" onclick="switchFeedbackTab('ratings')">Match Ratings</div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title"> Why Users End Matches</h3>
                    </div>
                    <div class="card-body" id="feedbackBreakdown">
                        <!-- Populated by JS -->
                    </div>
                </div>

                <div class="cards-grid">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"> Recent Feedback</h3>
                        </div>
                        <div class="card-body" id="recentFeedback">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"> Feedback Trends</h3>
                        </div>
                        <div class="card-body" id="feedbackTrends">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Test Bots Section -->
            <div id="testbots-section" style="display: none;">
                <div class="page-header">
                    <div>
                        <h2 class="page-title"> Test Bot Control</h2>
                        <p class="page-subtitle">Manage automated test profiles for demo and testing</p>
                    </div>
                    <div class="header-actions">
                        <button class="btn btn-secondary" onclick="toggleAllBots(false)">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="6" y="4" width="4" height="16"/>
                                <rect x="14" y="4" width="4" height="16"/>
                            </svg>
                            Pause All
                        </button>
                        <button class="btn btn-primary" onclick="toggleAllBots(true)">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polygon points="5 3 19 12 5 21 5 3"/>
                            </svg>
                            Start All
                        </button>
                    </div>
                </div>

                <!-- Bot Status Overview -->
                <div class="stats-grid">
                    <div class="stat-card users">
                        <div class="stat-icon users"></div>
                        <div class="stat-value" id="totalBots">0</div>
                        <div class="stat-label">Total Test Bots</div>
                    </div>
                    <div class="stat-card matches">
                        <div class="stat-icon matches"></div>
                        <div class="stat-value" id="activeBots">0</div>
                        <div class="stat-label">Active Bots</div>
                    </div>
                    <div class="stat-card messages">
                        <div class="stat-icon messages"></div>
                        <div class="stat-value" id="botMessagesSent">0</div>
                        <div class="stat-label">Messages Sent</div>
                    </div>
                    <div class="stat-card dates">
                        <div class="stat-icon dates"></div>
                        <div class="stat-value" id="botInteractions">0</div>
                        <div class="stat-label">Total Interactions</div>
                    </div>
                </div>

                <!-- Global Bot Settings -->
                <div class="card" style="margin-bottom: 20px;">
                    <div class="card-header">
                        <h3 class="card-title"> Global Bot Settings</h3>
                    </div>
                    <div class="card-body">
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px;">
                            <div>
                                <label style="display: block; font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 8px;">Response Delay</label>
                                <select id="botResponseDelay" onchange="updateBotSettings()" style="width: 100%; padding: 10px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary);">
                                    <option value="instant">Instant</option>
                                    <option value="fast" selected>Fast (1-3 sec)</option>
                                    <option value="normal">Normal (3-10 sec)</option>
                                    <option value="slow">Slow (10-30 sec)</option>
                                    <option value="realistic">Realistic (1-5 min)</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 8px;">Auto-Match Accept</label>
                                <select id="botAutoMatch" onchange="updateBotSettings()" style="width: 100%; padding: 10px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary);">
                                    <option value="always" selected>Always Accept</option>
                                    <option value="random">Random (70% accept)</option>
                                    <option value="compatibility">Based on Compatibility</option>
                                    <option value="never">Never Accept</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 8px;">Conversation Style</label>
                                <select id="botConversationStyle" onchange="updateBotSettings()" style="width: 100%; padding: 10px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary);">
                                    <option value="friendly" selected>Friendly & Engaging</option>
                                    <option value="flirty">Flirty</option>
                                    <option value="casual">Casual</option>
                                    <option value="professional">Professional</option>
                                    <option value="random">Random Mix</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Test Profiles Grid -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title"> Test Profiles</h3>
                        <div style="display: flex; gap: 8px;">
                            <button class="btn btn-secondary" onclick="generateRandomBot()" style="font-size: 0.8rem;">
                                 Generate Random
                            </button>
                            <button class="btn btn-primary" onclick="createNewTestBot()" style="font-size: 0.8rem;">
                                + Add Manually
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="testBotsGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 16px;">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>

                <!-- Create/Edit Bot Modal -->
                <div id="botModal" class="modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 1000; align-items: center; justify-content: center;">
                    <div class="modal-content" style="background: var(--bg-secondary); border-radius: 16px; padding: 24px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 id="botModalTitle" style="margin: 0;">Create Test Bot</h3>
                            <button onclick="closeBotModal()" style="background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 1.5rem;">&times;</button>
                        </div>
                        
                        <form id="botForm" onsubmit="saveBotForm(event)">
                            <input type="hidden" id="botEditId">
                            
                            <!-- Basic Info -->
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                                <div>
                                    <label style="display: block; font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 6px;">Name *</label>
                                    <input type="text" id="botName" required style="width: 100%; padding: 10px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary);">
                                </div>
                                <div>
                                    <label style="display: block; font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 6px;">Age *</label>
                                    <input type="number" id="botAge" min="18" max="99" required style="width: 100%; padding: 10px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary);">
                                </div>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                                <div>
                                    <label style="display: block; font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 6px;">Gender *</label>
                                    <select id="botGender" required style="width: 100%; padding: 10px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary);">
                                        <option value="female">Female</option>
                                        <option value="male">Male</option>
                                        <option value="other">Other</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="display: block; font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 6px;">Occupation</label>
                                    <input type="text" id="botOccupation" style="width: 100%; padding: 10px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary);">
                                </div>
                            </div>
                            
                            <div style="margin-bottom: 16px;">
                                <label style="display: block; font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 6px;">Location</label>
                                <input type="text" id="botLocation" placeholder="e.g., Brooklyn, NY" style="width: 100%; padding: 10px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary);">
                            </div>
                            
                            <div style="margin-bottom: 16px;">
                                <label style="display: block; font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 6px;">Bio</label>
                                <textarea id="botBio" rows="3" placeholder="Tell us about this test profile..." style="width: 100%; padding: 10px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); resize: vertical;"></textarea>
                            </div>
                            
                            <div style="margin-bottom: 16px;">
                                <label style="display: block; font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 6px;">Photo URL</label>
                                <input type="url" id="botPhoto" placeholder="https://..." style="width: 100%; padding: 10px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary);">
                                <small style="color: var(--text-muted); font-size: 0.75rem;">Leave blank to use a random avatar</small>
                            </div>
                            
                            <!-- Advanced Settings -->
                            <details style="margin-bottom: 16px;">
                                <summary style="cursor: pointer; color: var(--accent); font-weight: 500;">Advanced Profile Options</summary>
                                <div style="margin-top: 16px;">
                                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                                        <div>
                                            <label style="display: block; font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 6px;">Height</label>
                                            <select id="botHeight" style="width: 100%; padding: 10px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary);">
                                                <option value="5'0\"">5'0"</option>
                                                <option value="5'2\"">5'2"</option>
                                                <option value="5'4\"">5'4"</option>
                                                <option value="5'6\"" selected>5'6"</option>
                                                <option value="5'8\"">5'8"</option>
                                                <option value="5'10\"">5'10"</option>
                                                <option value="6'0\"">6'0"</option>
                                                <option value="6'2\"">6'2"</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label style="display: block; font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 6px;">Body Type</label>
                                            <select id="botBodyType" style="width: 100%; padding: 10px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary);">
                                                <option value="Slim">Slim</option>
                                                <option value="Athletic">Athletic</option>
                                                <option value="Average" selected>Average</option>
                                                <option value="Curvy">Curvy</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label style="display: block; font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 6px;">Ethnicity</label>
                                            <select id="botEthnicity" style="width: 100%; padding: 10px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary);">
                                                <option value="white">White</option>
                                                <option value="black">Black</option>
                                                <option value="asian">Asian</option>
                                                <option value="hispanic">Hispanic</option>
                                                <option value="mixed">Mixed</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                        <div>
                                            <label style="display: block; font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 6px;">Education</label>
                                            <select id="botEducation" style="width: 100%; padding: 10px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary);">
                                                <option value="High School">High School</option>
                                                <option value="Some College">Some College</option>
                                                <option value="Bachelor's" selected>Bachelor's</option>
                                                <option value="Master's">Master's</option>
                                                <option value="Doctorate">Doctorate</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label style="display: block; font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 6px;">Relationship Goal</label>
                                            <select id="botRelationshipGoal" style="width: 100%; padding: 10px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary);">
                                                <option value="relationship" selected>Relationship</option>
                                                <option value="casual">Casual</option>
                                                <option value="marriage">Marriage</option>
                                                <option value="unsure">Unsure</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </details>
                            
                            <div style="display: flex; gap: 12px; justify-content: flex-end;">
                                <button type="button" class="btn btn-secondary" onclick="closeBotModal()">Cancel</button>
                                <button type="submit" class="btn btn-primary">Save Bot</button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Bot Activity Log -->
                <div class="card" style="margin-top: 20px;">
                    <div class="card-header">
                        <h3 class="card-title"> Bot Activity Log</h3>
                        <button class="btn btn-secondary" onclick="clearBotLog()" style="font-size: 0.8rem;">Clear Log</button>
                    </div>
                    <div class="card-body">
                        <div id="botActivityLog" style="max-height: 300px; overflow-y: auto;">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Legal / Patents & IP Section -->
            <div id="legal-section" style="display: none;">
                <div class="page-header">
                    <div>
                        <h2 class="page-title"> Patents & Intellectual Property</h2>
                        <p class="page-subtitle">IP protection strategy and patent portfolio management</p>
                    </div>
                    <div class="header-actions">
                        <button class="btn btn-secondary" onclick="downloadIPDocument()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
                                <polyline points="7 10 12 15 17 10"/>
                                <line x1="12" y1="15" x2="12" y2="3"/>
                            </svg>
                            Download Full Document
                        </button>
                    </div>
                </div>

                <!-- IP Overview Stats -->
                <div class="stats-grid">
                    <div class="stat-card users">
                        <div class="stat-icon users"></div>
                        <div class="stat-value">6</div>
                        <div class="stat-label">Patent Applications</div>
                    </div>
                    <div class="stat-card matches">
                        <div class="stat-icon matches"></div>
                        <div class="stat-value">4</div>
                        <div class="stat-label">Trademarks</div>
                    </div>
                    <div class="stat-card messages">
                        <div class="stat-icon messages"></div>
                        <div class="stat-value">3</div>
                        <div class="stat-label">Copyrights</div>
                    </div>
                    <div class="stat-card dates">
                        <div class="stat-icon dates"></div>
                        <div class="stat-value">5+</div>
                        <div class="stat-label">Trade Secrets</div>
                    </div>
                </div>

                <!-- Patent Applications -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title"> Patent Applications</h3>
                    </div>
                    <div class="card-body" id="patentList">
                        <!-- Populated by JS -->
                    </div>
                </div>

                <!-- Trademarks -->
                <div class="cards-grid" style="margin-top: 20px;">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"> Registered Trademarks</h3>
                        </div>
                        <div class="card-body" id="trademarkList">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"> Copyright Portfolio</h3>
                        </div>
                        <div class="card-body" id="copyrightList">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>

                <!-- Trade Secrets -->
                <div class="card" style="margin-top: 20px;">
                    <div class="card-header">
                        <h3 class="card-title"> Trade Secrets (Protected)</h3>
                    </div>
                    <div class="card-body" id="tradeSecretsList">
                        <!-- Populated by JS -->
                    </div>
                </div>

                <!-- IP Filing Timeline -->
                <div class="card" style="margin-top: 20px;">
                    <div class="card-header">
                        <h3 class="card-title"> Patent Filing Timeline</h3>
                    </div>
                    <div class="card-body" id="filingTimeline">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>

            <!-- Compliance Section -->
            <div id="compliance-section" style="display: none;">
                <div class="page-header">
                    <div>
                        <h2 class="page-title"> Legal Compliance</h2>
                        <p class="page-subtitle">Regulatory compliance and legal requirements</p>
                    </div>
                </div>

                <!-- Compliance Status -->
                <div class="stats-grid">
                    <div class="stat-card" style="border-color: var(--success);">
                        <div class="stat-icon" style="background: rgba(16, 185, 129, 0.2); color: var(--success);"></div>
                        <div class="stat-value" style="color: var(--success);">12</div>
                        <div class="stat-label">Compliant Areas</div>
                    </div>
                    <div class="stat-card" style="border-color: var(--warning);">
                        <div class="stat-icon" style="background: rgba(245, 158, 11, 0.2); color: var(--warning);"></div>
                        <div class="stat-value" style="color: var(--warning);">2</div>
                        <div class="stat-label">Pending Review</div>
                    </div>
                    <div class="stat-card" style="border-color: var(--info);">
                        <div class="stat-icon" style="background: rgba(59, 130, 246, 0.2); color: var(--info);"></div>
                        <div class="stat-value">Q4 2024</div>
                        <div class="stat-label">Next Audit</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"></div>
                        <div class="stat-value">5</div>
                        <div class="stat-label">Jurisdictions</div>
                    </div>
                </div>

                <!-- Compliance Checklist -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title"> Compliance Checklist</h3>
                    </div>
                    <div class="card-body" id="complianceChecklist">
                        <!-- Populated by JS -->
                    </div>
                </div>

                <!-- Required Agreements -->
                <div class="cards-grid" style="margin-top: 20px;">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"> Employee Agreements</h3>
                        </div>
                        <div class="card-body" id="employeeAgreements">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"> International Compliance</h3>
                        </div>
                        <div class="card-body" id="internationalCompliance">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>

                <!-- Data Protection -->
                <div class="card" style="margin-top: 20px;">
                    <div class="card-header">
                        <h3 class="card-title"> Data Protection & Privacy</h3>
                    </div>
                    <div class="card-body" id="dataProtection">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>

            <!-- Experiments Section -->
            <div id="experiments-section" style="display: none;">
                <div class="page-header">
                    <div>
                        <h2 class="page-title"> Experiments & Causal Analysis</h2>
                        <p class="page-subtitle">Run A/B tests and causal inference to measure treatment effects</p>
                    </div>
                    <div class="header-actions">
                        <button class="btn btn-secondary" onclick="exportExperimentResults()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"/>
                            </svg>
                            Export Results
                        </button>
                    </div>
                </div>

                <!-- Experiment Setup Card -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title"> Experiment Configuration</h3>
                    </div>
                    <div class="card-body">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                            <!-- Treatment Variable -->
                            <div class="experiment-field">
                                <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--text-secondary);">
                                     Treatment Variable
                                    <span style="font-size: 0.75rem; font-weight: 400; color: var(--text-muted); display: block;">The intervention being tested</span>
                                </label>
                                <select id="treatmentVar" style="width: 100%; padding: 12px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); font-size: 0.9rem;">
                                    <option value="">Select treatment...</option>
                                    <option value="premium_subscription">Premium Subscription</option>
                                    <option value="profile_boost">Profile Boost Feature</option>
                                    <option value="ai_suggestions">AI Match Suggestions</option>
                                    <option value="photo_verification">Photo Verification</option>
                                    <option value="date_planner">Date Planner Access</option>
                                    <option value="read_receipts">Read Receipts Feature</option>
                                    <option value="push_notifications">Push Notifications</option>
                                    <option value="email_reminders">Email Reminders</option>
                                </select>
                            </div>

                            <!-- Outcome Variable -->
                            <div class="experiment-field">
                                <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--text-secondary);">
                                     Outcome Variable
                                    <span style="font-size: 0.75rem; font-weight: 400; color: var(--text-muted); display: block;">What you're measuring</span>
                                </label>
                                <select id="outcomeVar" style="width: 100%; padding: 12px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); font-size: 0.9rem;">
                                    <option value="">Select outcome...</option>
                                    <option value="match_rate">Match Rate (%)</option>
                                    <option value="message_response">Message Response Rate (%)</option>
                                    <option value="dates_planned">Dates Planned (count)</option>
                                    <option value="dates_completed">Dates Completed (count)</option>
                                    <option value="session_duration">Session Duration (minutes)</option>
                                    <option value="retention_7day">7-Day Retention (%)</option>
                                    <option value="retention_30day">30-Day Retention (%)</option>
                                    <option value="subscription_conversion">Subscription Conversion (%)</option>
                                    <option value="user_satisfaction">User Satisfaction (1-10)</option>
                                    <option value="churn_rate">Churn Rate (%)</option>
                                </select>
                            </div>

                            <!-- Covariates -->
                            <div class="experiment-field">
                                <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--text-secondary);">
                                     Covariates (Control Variables)
                                    <span style="font-size: 0.75rem; font-weight: 400; color: var(--text-muted); display: block;">Variables to control for</span>
                                </label>
                                <select id="covariates" multiple style="width: 100%; padding: 12px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); font-size: 0.9rem; min-height: 100px;">
                                    <option value="age">Age</option>
                                    <option value="gender">Gender</option>
                                    <option value="location">Location</option>
                                    <option value="tenure">Account Tenure</option>
                                    <option value="activity_level">Activity Level</option>
                                    <option value="profile_completeness">Profile Completeness</option>
                                    <option value="photo_count">Photo Count</option>
                                    <option value="previous_matches">Previous Match History</option>
                                    <option value="device_type">Device Type</option>
                                    <option value="signup_source">Signup Source</option>
                                </select>
                                <span style="font-size: 0.7rem; color: var(--text-muted);">Hold Ctrl/Cmd to select multiple</span>
                            </div>

                            <!-- Algorithm Selection -->
                            <div class="experiment-field">
                                <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--text-secondary);">
                                     Analysis Algorithm
                                    <span style="font-size: 0.75rem; font-weight: 400; color: var(--text-muted); display: block;">Method to estimate causal effect</span>
                                </label>
                                <select id="algorithmSelect" style="width: 100%; padding: 12px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); font-size: 0.9rem;">
                                    <option value="">Select algorithm...</option>
                                    <option value="rct">Randomized Controlled Trial (A/B Test)</option>
                                    <option value="did">Difference-in-Differences (DiD)</option>
                                    <option value="psm">Propensity Score Matching</option>
                                    <option value="iv">Instrumental Variables</option>
                                    <option value="rdd">Regression Discontinuity</option>
                                    <option value="ols">OLS Regression with Controls</option>
                                </select>
                            </div>
                        </div>

                        <!-- Randomization Settings -->
                        <div style="margin-top: 24px; padding: 20px; background: var(--bg-tertiary); border-radius: 12px;">
                            <h4 style="margin: 0 0 16px; display: flex; align-items: center; gap: 8px;">
                                 Randomization Settings
                            </h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                                <div>
                                    <label style="display: block; font-size: 0.85rem; margin-bottom: 6px; color: var(--text-muted);">Sample Size</label>
                                    <input type="number" id="sampleSize" value="1000" min="100" max="100000" style="width: 100%; padding: 10px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary);">
                                </div>
                                <div>
                                    <label style="display: block; font-size: 0.85rem; margin-bottom: 6px; color: var(--text-muted);">Treatment Split (%)</label>
                                    <input type="number" id="treatmentSplit" value="50" min="10" max="90" style="width: 100%; padding: 10px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary);">
                                </div>
                                <div>
                                    <label style="display: block; font-size: 0.85rem; margin-bottom: 6px; color: var(--text-muted);">Confidence Level</label>
                                    <select id="confidenceLevel" style="width: 100%; padding: 10px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary);">
                                        <option value="0.90">90%</option>
                                        <option value="0.95" selected>95%</option>
                                        <option value="0.99">99%</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="display: block; font-size: 0.85rem; margin-bottom: 6px; color: var(--text-muted);">Random Seed</label>
                                    <input type="number" id="randomSeed" value="42" style="width: 100%; padding: 10px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary);">
                                </div>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div style="margin-top: 24px; display: flex; gap: 12px; flex-wrap: wrap;">
                            <button class="btn btn-primary" onclick="runCausalAnalysis()" style="padding: 12px 24px;">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 8px;">
                                    <polygon points="5 3 19 12 5 21 5 3"/>
                                </svg>
                                Run Analysis
                            </button>
                            <button class="btn btn-secondary" onclick="randomizeGroups()" style="padding: 12px 24px;">
                                 Randomize Groups
                            </button>
                            <button class="btn btn-secondary" onclick="generateSyntheticData()" style="padding: 12px 24px;">
                                 Generate Test Data
                            </button>
                            <button class="btn btn-secondary" onclick="resetExperiment()" style="padding: 12px 24px;">
                                 Reset
                            </button>
                        </div>
                        
                        <!-- Live Experiment Actions -->
                        <div style="margin-top: 20px; padding: 20px; background: linear-gradient(135deg, var(--purple)15, var(--accent)10); border: 1px solid var(--purple); border-radius: 12px;">
                            <h4 style="margin: 0 0 12px; display: flex; align-items: center; gap: 8px; color: var(--purple);">
                                 Live Experiment Deployment
                            </h4>
                            <p style="font-size: 0.85rem; color: var(--text-muted); margin: 0 0 16px;">
                                Select real users from your database and deploy the treatment to their app experience.
                            </p>
                            <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                                <button class="btn" onclick="selectRealUsers()" style="padding: 12px 24px; background: var(--purple); color: white; border: none;">
                                     Select Real Users
                                </button>
                                <button class="btn" onclick="launchLiveExperiment()" style="padding: 12px 24px; background: var(--success); color: white; border: none;">
                                     Launch Live Experiment
                                </button>
                                <button class="btn btn-secondary" onclick="viewActiveExperiments()" style="padding: 12px 24px;">
                                     View Active Experiments
                                </button>
                            </div>
                            <div id="selectedUsersPreview" style="margin-top: 16px;"></div>
                        </div>
                    </div>
                </div>

                <!-- Active Experiments Section -->
                <div class="card" style="margin-top: 20px;">
                    <div class="card-header">
                        <h3 class="card-title"> Active Live Experiments</h3>
                    </div>
                    <div class="card-body" id="activeExperimentsSection">
                        <div style="text-align: center; padding: 20px; color: var(--text-muted);">
                            <p>No active experiments running</p>
                        </div>
                    </div>
                </div>

                <!-- Results Section -->
                <div class="card" style="margin-top: 20px;">
                    <div class="card-header">
                        <h3 class="card-title"> Analysis Results</h3>
                    </div>
                    <div class="card-body" id="experimentResults">
                        <div style="text-align: center; padding: 40px; color: var(--text-muted);">
                            <div style="font-size: 3rem; margin-bottom: 16px;"></div>
                            <p>Configure your experiment above and click "Run Analysis" to see results</p>
                        </div>
                    </div>
                </div>

                <!-- Experiment History -->
                <div class="card" style="margin-top: 20px;">
                    <div class="card-header">
                        <h3 class="card-title"> Experiment History</h3>
                    </div>
                    <div class="card-body" id="experimentHistory">
                        <div style="text-align: center; padding: 20px; color: var(--text-muted);">
                            <p>No experiments run yet</p>
                        </div>
                    </div>
                </div>

                <!-- Algorithm Descriptions -->
                <div class="card" style="margin-top: 20px;">
                    <div class="card-header">
                        <h3 class="card-title"> Algorithm Reference</h3>
                    </div>
                    <div class="card-body">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 16px;">
                            <div style="padding: 16px; background: var(--bg-tertiary); border-radius: 8px; border-left: 3px solid var(--success);">
                                <h4 style="margin: 0 0 8px; font-size: 0.95rem;"> RCT (A/B Test)</h4>
                                <p style="margin: 0; font-size: 0.8rem; color: var(--text-muted);">Gold standard. Random assignment ensures unbiased causal estimates. Best when you can randomly assign treatment.</p>
                            </div>
                            <div style="padding: 16px; background: var(--bg-tertiary); border-radius: 8px; border-left: 3px solid var(--info);">
                                <h4 style="margin: 0 0 8px; font-size: 0.95rem;"> Difference-in-Differences</h4>
                                <p style="margin: 0; font-size: 0.8rem; color: var(--text-muted);">Compares treatment vs control before and after intervention. Good for policy changes affecting groups.</p>
                            </div>
                            <div style="padding: 16px; background: var(--bg-tertiary); border-radius: 8px; border-left: 3px solid var(--warning);">
                                <h4 style="margin: 0 0 8px; font-size: 0.95rem;"> Propensity Score Matching</h4>
                                <p style="margin: 0; font-size: 0.8rem; color: var(--text-muted);">Matches treated units with similar controls based on observable characteristics. Good for observational data.</p>
                            </div>
                            <div style="padding: 16px; background: var(--bg-tertiary); border-radius: 8px; border-left: 3px solid var(--purple);">
                                <h4 style="margin: 0 0 8px; font-size: 0.95rem;"> Instrumental Variables</h4>
                                <p style="margin: 0; font-size: 0.8rem; color: var(--text-muted);">Uses an instrument correlated with treatment but not outcome. Addresses hidden confounding.</p>
                            </div>
                            <div style="padding: 16px; background: var(--bg-tertiary); border-radius: 8px; border-left: 3px solid var(--accent);">
                                <h4 style="margin: 0 0 8px; font-size: 0.95rem;"> Regression Discontinuity</h4>
                                <p style="margin: 0; font-size: 0.8rem; color: var(--text-muted);">Exploits cutoff rules for treatment assignment. Good when treatment is assigned by a threshold.</p>
                            </div>
                            <div style="padding: 16px; background: var(--bg-tertiary); border-radius: 8px; border-left: 3px solid var(--text-muted);">
                                <h4 style="margin: 0 0 8px; font-size: 0.95rem;"> OLS with Controls</h4>
                                <p style="margin: 0; font-size: 0.8rem; color: var(--text-muted);">Linear regression controlling for covariates. Simple but assumes no unmeasured confounding.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Org Hierarchy Section -->
            <div id="org-hierarchy-section" style="display: none;">
                <div class="page-header">
                    <div>
                        <h2 class="page-title"> Organization Hierarchy</h2>
                        <p class="page-subtitle">Company structure, roles, and reporting relationships</p>
                    </div>
                    <div class="header-actions">
                        <button class="btn btn-primary" onclick="addEmployee()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
                            </svg>
                            Add Employee
                        </button>
                        <button class="btn btn-secondary" onclick="exportOrgChart()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"/>
                            </svg>
                            Export
                        </button>
                    </div>
                </div>

                <!-- Org Stats -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon"></div>
                        <div class="stat-value" id="totalEmployees">0</div>
                        <div class="stat-label">Total Employees</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"></div>
                        <div class="stat-value" id="totalDepartments">0</div>
                        <div class="stat-label">Departments</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"></div>
                        <div class="stat-value" id="managementCount">0</div>
                        <div class="stat-label">Management</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"></div>
                        <div class="stat-value" id="avgTeamSize">0</div>
                        <div class="stat-label">Avg Team Size</div>
                    </div>
                </div>

                <!-- Org Chart -->
                <div class="card" style="margin-top: 20px;">
                    <div class="card-header">
                        <h3 class="card-title"> Organization Chart</h3>
                    </div>
                    <div class="card-body" id="orgChartContainer">
                        <!-- Populated by JS -->
                    </div>
                </div>

                <!-- Employee Directory -->
                <div class="card" style="margin-top: 20px;">
                    <div class="card-header">
                        <h3 class="card-title"> Employee Directory</h3>
                    </div>
                    <div class="card-body" id="employeeDirectory">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>

            <!-- Payroll Section -->
            <div id="payroll-section" style="display: none;">
                <div class="page-header">
                    <div>
                        <h2 class="page-title"> Payroll Management</h2>
                        <p class="page-subtitle">Compensation, payments, and payroll records</p>
                    </div>
                    <div class="header-actions">
                        <button class="btn btn-primary" onclick="runPayroll()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polygon points="5 3 19 12 5 21 5 3"/>
                            </svg>
                            Run Payroll
                        </button>
                        <button class="btn btn-secondary" onclick="exportPayrollReport()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"/>
                            </svg>
                            Export Report
                        </button>
                    </div>
                </div>

                <!-- Payroll Summary Stats -->
                <div class="stats-grid">
                    <div class="stat-card" style="border-color: var(--success);">
                        <div class="stat-icon" style="background: rgba(16, 185, 129, 0.2); color: var(--success);"></div>
                        <div class="stat-value" style="color: var(--success);" id="monthlyPayroll">$0</div>
                        <div class="stat-label">Monthly Payroll</div>
                    </div>
                    <div class="stat-card" style="border-color: var(--info);">
                        <div class="stat-icon" style="background: rgba(59, 130, 246, 0.2); color: var(--info);"></div>
                        <div class="stat-value" id="nextPayDate">-</div>
                        <div class="stat-label">Next Pay Date</div>
                    </div>
                    <div class="stat-card" style="border-color: var(--warning);">
                        <div class="stat-icon" style="background: rgba(245, 158, 11, 0.2); color: var(--warning);"></div>
                        <div class="stat-value" id="pendingPayments">0</div>
                        <div class="stat-label">Pending Payments</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"></div>
                        <div class="stat-value" id="ytdPayroll">$0</div>
                        <div class="stat-label">YTD Payroll</div>
                    </div>
                </div>

                <!-- Compensation Overview -->
                <div class="card" style="margin-top: 20px;">
                    <div class="card-header">
                        <h3 class="card-title"> Compensation Overview</h3>
                    </div>
                    <div class="card-body" id="compensationOverview">
                        <!-- Populated by JS -->
                    </div>
                </div>

                <!-- Recent Payroll Runs -->
                <div class="card" style="margin-top: 20px;">
                    <div class="card-header">
                        <h3 class="card-title"> Payroll History</h3>
                    </div>
                    <div class="card-body" id="payrollHistory">
                        <!-- Populated by JS -->
                    </div>
                </div>

                <!-- Employee Compensation Table -->
                <div class="card" style="margin-top: 20px;">
                    <div class="card-header">
                        <h3 class="card-title"> Employee Compensation</h3>
                    </div>
                    <div class="card-body" id="employeeCompensation">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>

            <!-- Tax Section -->
            <div id="tax-section" style="display: none;">
                <div class="page-header">
                    <div>
                        <h2 class="page-title"> Tax Requirements & Compliance</h2>
                        <p class="page-subtitle">Federal, state, and local tax obligations for OITH</p>
                    </div>
                    <div class="header-actions">
                        <button class="btn btn-secondary" onclick="exportTaxChecklist()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"/>
                            </svg>
                            Export Checklist
                        </button>
                    </div>
                </div>

                <!-- Current Status Banner -->
                <div class="card" style="margin-bottom: 20px; border: 2px solid var(--warning); background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(245, 158, 11, 0.02));">
                    <div class="card-body" style="display: flex; align-items: center; gap: 16px;">
                        <div style="font-size: 2.5rem;"></div>
                        <div>
                            <div style="font-weight: 600; font-size: 1.1rem; color: var(--warning);">Current Status: Pre-LLC Formation</div>
                            <div style="font-size: 0.9rem; color: var(--text-secondary); margin-top: 4px;">
                                2 employees  LLC application pending  No revenue yet
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tax Summary Stats -->
                <div class="stats-grid" style="margin-bottom: 20px;">
                    <div class="stat-card" style="border-color: var(--warning);">
                        <div class="stat-icon" style="background: rgba(245, 158, 11, 0.2); color: var(--warning);"></div>
                        <div class="stat-value" style="color: var(--warning);" id="nextTaxDeadline">Q4 Est.</div>
                        <div class="stat-label">Next Tax Deadline</div>
                    </div>
                    <div class="stat-card" style="border-color: var(--info);">
                        <div class="stat-icon" style="background: rgba(59, 130, 246, 0.2); color: var(--info);"></div>
                        <div class="stat-value" id="taxFormsRequired">4</div>
                        <div class="stat-label">Forms Required</div>
                    </div>
                    <div class="stat-card" style="border-color: var(--success);">
                        <div class="stat-icon" style="background: rgba(16, 185, 129, 0.2); color: var(--success);"></div>
                        <div class="stat-value" id="taxTasksCompleted">0/12</div>
                        <div class="stat-label">Tasks Completed</div>
                    </div>
                    <div class="stat-card" style="border-color: var(--danger);">
                        <div class="stat-icon" style="background: rgba(239, 68, 68, 0.2); color: var(--danger);"></div>
                        <div class="stat-value" id="taxUrgentItems">3</div>
                        <div class="stat-label">Urgent Items</div>
                    </div>
                </div>

                <!-- Phase 1: Pre-LLC (Current Stage) -->
                <div class="card" style="margin-bottom: 20px; border: 2px solid var(--warning);">
                    <div class="card-header" style="background: linear-gradient(135deg, rgba(245, 158, 11, 0.15), rgba(245, 158, 11, 0.05));">
                        <h3 class="card-title"> PHASE 1: Pre-LLC Formation (Current Stage)</h3>
                        <span class="status-badge" style="background: var(--warning);">IN PROGRESS</span>
                    </div>
                    <div class="card-body" id="taxPhase1Content">
                        <!-- Populated by JS -->
                    </div>
                </div>

                <!-- Phase 2: Post-LLC Formation -->
                <div class="card" style="margin-bottom: 20px; border: 2px solid var(--info);">
                    <div class="card-header" style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(59, 130, 246, 0.05));">
                        <h3 class="card-title"> PHASE 2: Post-LLC Formation</h3>
                        <span class="status-badge" style="background: var(--info);">UPCOMING</span>
                    </div>
                    <div class="card-body" id="taxPhase2Content">
                        <!-- Populated by JS -->
                    </div>
                </div>

                <!-- Phase 3: Revenue Generation -->
                <div class="card" style="margin-bottom: 20px; border: 2px solid var(--success);">
                    <div class="card-header" style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(16, 185, 129, 0.05));">
                        <h3 class="card-title"> PHASE 3: Revenue & Operations</h3>
                        <span class="status-badge" style="background: var(--success);">FUTURE</span>
                    </div>
                    <div class="card-body" id="taxPhase3Content">
                        <!-- Populated by JS -->
                    </div>
                </div>

                <!-- Key Tax Deadlines -->
                <div class="card" style="margin-bottom: 20px;">
                    <div class="card-header">
                        <h3 class="card-title"> Key Tax Deadlines</h3>
                    </div>
                    <div class="card-body" id="taxDeadlinesContent">
                        <!-- Populated by JS -->
                    </div>
                </div>

                <!-- Recommended Tax Professionals -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title"> Recommended Actions</h3>
                    </div>
                    <div class="card-body" id="taxRecommendationsContent">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>

            <!-- Expenses & Cost Optimization Section -->
            <div id="expenses-section" style="display: none;">
                <div class="page-header">
                    <div>
                        <h2 class="page-title"> Expenses & Cost Optimization</h2>
                        <p class="page-subtitle">Track all costs and discover optimization opportunities</p>
                    </div>
                    <div class="header-actions">
                        <button class="btn btn-secondary" onclick="exportExpenseReport()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"/>
                            </svg>
                            Export Report
                        </button>
                        <button class="btn btn-secondary" onclick="exportExpenseReportAsPDF()" style="background: #dc2626;">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/>
                                <polyline points="14,2 14,8 20,8"/>
                                <line x1="16" y1="13" x2="8" y2="13"/>
                                <line x1="16" y1="17" x2="8" y2="17"/>
                                <polyline points="10,9 9,9 8,9"/>
                            </svg>
                            Export as PDF
                        </button>
                        <button class="btn btn-primary" onclick="addExpenseEntry()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="12" y1="5" x2="12" y2="19"/>
                                <line x1="5" y1="12" x2="19" y2="12"/>
                            </svg>
                            Add Expense
                        </button>
                    </div>
                </div>

                <!-- Total Expenses Summary -->
                <div class="stats-grid" style="margin-bottom: 20px;">
                    <div class="stat-card expense-detail-card" style="border-color: var(--danger); cursor: pointer;" onclick="showExpenseDetail('total')">
                        <div class="stat-card-header">
                            <div class="stat-icon" style="background: rgba(239, 68, 68, 0.2); color: var(--danger);"></div>
                            <span class="stat-change negative" id="expensesTrend">+12%</span>
                        </div>
                        <div class="stat-value" style="color: var(--danger);" id="totalExpensesToDate">$0.00</div>
                        <div class="stat-label">Total Spent to Date</div>
                        <div class="click-hint">Click for details</div>
                    </div>
                    <div class="stat-card expense-detail-card" style="border-color: var(--warning); cursor: pointer;" onclick="showExpenseDetail('burn')">
                        <div class="stat-card-header">
                            <div class="stat-icon" style="background: rgba(245, 158, 11, 0.2); color: var(--warning);"></div>
                        </div>
                        <div class="stat-value" id="monthlyBurn">$0.00</div>
                        <div class="stat-label">Monthly Burn Rate</div>
                        <div class="click-hint">Click for details</div>
                    </div>
                    <div class="stat-card expense-detail-card" style="border-color: var(--success); cursor: pointer;" onclick="showExpenseDetail('savings')">
                        <div class="stat-card-header">
                            <div class="stat-icon" style="background: rgba(16, 185, 129, 0.2); color: var(--success);"></div>
                        </div>
                        <div class="stat-value" style="color: var(--success);" id="potentialSavings">$0.00</div>
                        <div class="stat-label">Potential Savings</div>
                        <div class="click-hint">Click for details</div>
                    </div>
                    <div class="stat-card expense-detail-card" style="border-color: var(--info); cursor: pointer;" onclick="showExpenseDetail('services')">
                        <div class="stat-card-header">
                            <div class="stat-icon" style="background: rgba(59, 130, 246, 0.2); color: var(--info);"></div>
                        </div>
                        <div class="stat-value" id="activeServices">0</div>
                        <div class="stat-label">Active Services</div>
                        <div class="click-hint">Click for details</div>
                    </div>
                    <div class="stat-card expense-detail-card" style="border-color: var(--purple); cursor: pointer;" onclick="showExpenseDetail('payroll')">
                        <div class="stat-card-header">
                            <div class="stat-icon" style="background: rgba(139, 92, 246, 0.2); color: var(--purple);"></div>
                        </div>
                        <div class="stat-value" style="color: var(--purple);" id="monthlyPayrollExpense">$0.00</div>
                        <div class="stat-label">Monthly Payroll</div>
                        <div class="click-hint">Click for details</div>
                    </div>
                </div>
                
                <!-- Expense Detail Modal -->
                <div id="expenseDetailModal" class="expense-modal" style="display: none;">
                    <div class="expense-modal-content">
                        <div class="expense-modal-header">
                            <h3 id="expenseModalTitle">Expense Details</h3>
                            <button class="expense-modal-close" onclick="closeExpenseDetail()"></button>
                        </div>
                        <div class="expense-modal-body" id="expenseModalBody">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>

                <!-- Expense Categories Grid -->
                <div class="cards-grid" style="margin-bottom: 20px;">
                    <!-- Development Tools -->
                    <div class="card">
                        <div class="card-header" style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.15), rgba(139, 92, 246, 0.05));">
                            <h3 class="card-title"> Development Tools</h3>
                            <span class="status-badge" style="background: var(--purple); color: white;" id="devToolsTotal">$0/mo</span>
                        </div>
                        <div class="card-body" id="devToolsExpenses">
                            <!-- Populated by JS -->
                        </div>
                    </div>

                    <!-- Cloud Infrastructure -->
                    <div class="card">
                        <div class="card-header" style="background: linear-gradient(135deg, rgba(245, 158, 11, 0.15), rgba(245, 158, 11, 0.05));">
                            <h3 class="card-title"> Cloud Infrastructure</h3>
                            <span class="status-badge" style="background: var(--warning); color: white;" id="cloudTotal">$0/mo</span>
                        </div>
                        <div class="card-body" id="cloudExpenses">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>

                <div class="cards-grid" style="margin-bottom: 20px;">
                    <!-- Communication & Email -->
                    <div class="card">
                        <div class="card-header" style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(59, 130, 246, 0.05));">
                            <h3 class="card-title"> Communication & Email</h3>
                            <span class="status-badge" style="background: var(--info); color: white;" id="emailTotal">$0/mo</span>
                        </div>
                        <div class="card-body" id="emailExpenses">
                            <!-- Populated by JS -->
                        </div>
                    </div>

                    <!-- Legal & Compliance -->
                    <div class="card">
                        <div class="card-header" style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(16, 185, 129, 0.05));">
                            <h3 class="card-title"> Legal & Compliance</h3>
                            <span class="status-badge" style="background: var(--success); color: white;" id="legalTotal">$0</span>
                        </div>
                        <div class="card-body" id="legalExpenses">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>

                <!-- Payroll Category -->
                <div class="cards-grid" style="margin-bottom: 20px;">
                    <div class="card" style="grid-column: span 2;">
                        <div class="card-header" style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.15), rgba(139, 92, 246, 0.05));">
                            <h3 class="card-title"> Payroll & Salaries</h3>
                            <span class="status-badge" style="background: var(--purple); color: white;" id="payrollTotal">$0/mo</span>
                        </div>
                        <div class="card-body" id="payrollExpenses">
                            <!-- Populated by JS from org data -->
                        </div>
                    </div>
                </div>

                <!-- Detailed Expense Table -->
                <div class="card" style="margin-bottom: 20px;">
                    <div class="card-header">
                        <h3 class="card-title"> All Expenses</h3>
                        <div style="display: flex; gap: 8px;">
                            <select id="expenseFilterCategory" style="background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: var(--radius); padding: 4px 8px; color: var(--text-primary); font-size: 12px;">
                                <option value="all">All Categories</option>
                                <option value="development">Development</option>
                                <option value="cloud">Cloud/Infrastructure</option>
                                <option value="communication">Communication</option>
                                <option value="legal">Legal</option>
                                <option value="payroll">Payroll</option>
                                <option value="marketing">Marketing</option>
                                <option value="other">Other</option>
                            </select>
                            <select id="expenseFilterPeriod" style="background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: var(--radius); padding: 4px 8px; color: var(--text-primary); font-size: 12px;">
                                <option value="all">All Time</option>
                                <option value="month">This Month</option>
                                <option value="quarter">This Quarter</option>
                                <option value="year">This Year</option>
                            </select>
                        </div>
                    </div>
                    <div class="table-container" style="border: none; margin: 0;">
                        <table>
                            <thead>
                                <tr>
                                    <th>Service/Item</th>
                                    <th>Category</th>
                                    <th>Cost</th>
                                    <th>Billing</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="expenseTableBody">
                                <!-- Populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Cost Optimization Recommendations -->
                <div class="card" style="margin-bottom: 20px; border: 2px solid var(--success);">
                    <div class="card-header" style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(16, 185, 129, 0.05));">
                        <h3 class="card-title"> Cost Optimization Recommendations</h3>
                        <span class="status-badge" style="background: var(--success); color: white;" id="optimizationCount">0 tips</span>
                    </div>
                    <div class="card-body" id="optimizationRecommendations">
                        <!-- Populated by JS -->
                    </div>
                </div>

                <!-- Service-Specific Optimization Cards -->
                <div class="cards-grid three" style="margin-bottom: 20px;">
                    <!-- DynamoDB Optimization -->
                    <div class="card">
                        <div class="card-header" style="background: linear-gradient(135deg, rgba(245, 158, 11, 0.2), rgba(245, 158, 11, 0.05));">
                            <h3 class="card-title"> DynamoDB</h3>
                        </div>
                        <div class="card-body" id="dynamoOptimization">
                            <!-- Populated by JS -->
                        </div>
                    </div>

                    <!-- Google Workspace Optimization -->
                    <div class="card">
                        <div class="card-header" style="background: linear-gradient(135deg, rgba(234, 67, 53, 0.2), rgba(234, 67, 53, 0.05));">
                            <h3 class="card-title"> Google Workspace</h3>
                        </div>
                        <div class="card-body" id="googleOptimization">
                            <!-- Populated by JS -->
                        </div>
                    </div>

                    <!-- Cursor/AI Tools Optimization -->
                    <div class="card">
                        <div class="card-header" style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.2), rgba(139, 92, 246, 0.05));">
                            <h3 class="card-title"> AI & Dev Tools</h3>
                        </div>
                        <div class="card-body" id="cursorOptimization">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>

                <!-- Expense History Chart placeholder -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title"> Expense Trend</h3>
                    </div>
                    <div class="card-body" id="expenseChartContainer" style="min-height: 200px;">
                        <!-- Chart rendered by JS -->
                    </div>
                </div>
            </div>

            <!-- Calendar Section -->
            <div id="calendar-section" style="display: none;">
                <div class="page-header">
                    <div>
                        <h2 class="page-title"> Project Calendar & Milestones</h2>
                        <p class="page-subtitle">Company start: Nov 28, 2025  Launch target: Feb 1, 2026</p>
                    </div>
                    <div class="header-actions">
                        <button class="btn btn-success" onclick="manualCalendarSync()" style="margin-right: 8px;">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M23 4v6h-6M1 20v-6h6"/>
                                <path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/>
                            </svg>
                            Sync AWS
                        </button>
                        <button class="btn btn-primary" onclick="openMeetingScheduler()" style="margin-right: 8px;">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                                <line x1="16" y1="2" x2="16" y2="6"/>
                                <line x1="8" y1="2" x2="8" y2="6"/>
                                <line x1="3" y1="10" x2="21" y2="10"/>
                                <line x1="12" y1="14" x2="12" y2="18"/>
                                <line x1="10" y1="16" x2="14" y2="16"/>
                            </svg>
                            Schedule Meeting
                        </button>
                        <button class="btn btn-secondary" onclick="exportCalendar()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"/>
                            </svg>
                            Export
                        </button>
                    </div>
                </div>

                <!--  LAUNCH READINESS METER -->
                <div class="card" style="margin-bottom: 20px; border: 2px solid transparent; background: linear-gradient(var(--bg-secondary), var(--bg-secondary)) padding-box, linear-gradient(135deg, var(--accent), var(--purple), var(--success)) border-box;">
                    <div class="card-body" style="padding: 20px;">
                        <div style="display: flex; align-items: center; gap: 24px; flex-wrap: wrap;">
                            <!-- Main Percentage Circle - Launch Readiness -->
                            <div style="position: relative; width: 100px; height: 100px; flex-shrink: 0;">
                                <svg viewBox="0 0 100 100" style="transform: rotate(-90deg); width: 100%; height: 100%;">
                                    <circle cx="50" cy="50" r="42" fill="none" stroke="var(--bg-tertiary)" stroke-width="8"/>
                                    <circle id="launchReadinessCircle" cx="50" cy="50" r="42" fill="none" stroke="url(#launchGradient)" stroke-width="8" stroke-linecap="round" stroke-dasharray="264" stroke-dashoffset="264" style="transition: stroke-dashoffset 1s ease-out;"/>
                                    <defs>
                                        <linearGradient id="launchGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                            <stop offset="0%" style="stop-color: var(--accent)"/>
                                            <stop offset="50%" style="stop-color: var(--purple)"/>
                                            <stop offset="100%" style="stop-color: var(--success)"/>
                                        </linearGradient>
                                    </defs>
                                </svg>
                                <div style="position: absolute; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                                    <div id="launchReadinessPercent" style="font-size: 1.5rem; font-weight: 700; background: linear-gradient(135deg, var(--accent), var(--purple)); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">0%</div>
                                    <div style="font-size: 0.55rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.03em;">Launch</div>
                                </div>
                            </div>
                            
                            <!-- Scale Readiness Circle (100M Users) -->
                            <div style="position: relative; width: 100px; height: 100px; flex-shrink: 0;">
                                <svg viewBox="0 0 100 100" style="transform: rotate(-90deg); width: 100%; height: 100%;">
                                    <circle cx="50" cy="50" r="42" fill="none" stroke="var(--bg-tertiary)" stroke-width="8"/>
                                    <circle id="scaleReadinessCircle" cx="50" cy="50" r="42" fill="none" stroke="url(#scaleGradient)" stroke-width="8" stroke-linecap="round" stroke-dasharray="264" stroke-dashoffset="264" style="transition: stroke-dashoffset 1s ease-out;"/>
                                    <defs>
                                        <linearGradient id="scaleGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                            <stop offset="0%" style="stop-color: #f59e0b"/>
                                            <stop offset="50%" style="stop-color: #ef4444"/>
                                            <stop offset="100%" style="stop-color: #8b5cf6"/>
                                        </linearGradient>
                                    </defs>
                                </svg>
                                <div style="position: absolute; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                                    <div id="scaleReadinessPercent" style="font-size: 1.5rem; font-weight: 700; background: linear-gradient(135deg, #f59e0b, #ef4444); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">0%</div>
                                    <div style="font-size: 0.55rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.03em;">100M Scale</div>
                                </div>
                            </div>
                            
                            <!-- Title and Status -->
                            <div style="flex: 1; min-width: 200px;">
                                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 6px;">
                                    <h3 style="font-size: 1rem; font-weight: 700; margin: 0;"> Launch Readiness</h3>
                                    <span id="launchReadinessStatus" class="status-badge" style="background: var(--warning); font-size: 0.65rem;">Calculating...</span>
                                </div>
                                <p style="font-size: 0.75rem; color: var(--text-secondary); margin: 0 0 8px 0;" id="launchReadinessMessage">Analyzing index.html app components...</p>
                                
                                <!-- Progress Bar -->
                                <div style="background: var(--bg-tertiary); border-radius: 6px; height: 8px; overflow: hidden; margin-bottom: 6px;">
                                    <div id="launchReadinessBar" style="height: 100%; width: 0%; background: linear-gradient(90deg, var(--accent), var(--purple), var(--success)); border-radius: 6px; transition: width 1s ease-out;"></div>
                                </div>
                                
                                <!-- Quick Stats -->
                                <div style="display: flex; gap: 12px; flex-wrap: wrap; font-size: 0.7rem; margin-bottom: 12px;">
                                    <div><span style="color: var(--text-muted);">Components:</span> <strong id="launchReadinessComponentCount">0/0</strong></div>
                                    <div><span style="color: var(--text-muted);">Critical:</span> <strong id="launchReadinessCritical" style="color: var(--success);">0 issues</strong></div>
                                    <div><span style="color: var(--text-muted);">Last Check:</span> <strong id="launchReadinessLastCheck">--</strong></div>
                                    <div id="launchReadinessLive" style="display: flex; align-items: center; gap: 4px;">
                                        <span style="width: 6px; height: 6px; background: var(--success); border-radius: 50%; animation: pulse 2s infinite;"></span>
                                        <span style="color: var(--success);">Live</span>
                                    </div>
                                </div>
                                
                                <!-- Scale Readiness Section -->
                                <div style="border-top: 1px solid var(--border); padding-top: 10px;">
                                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 6px;">
                                        <h3 style="font-size: 1rem; font-weight: 700; margin: 0; background: linear-gradient(135deg, #f59e0b, #ef4444); -webkit-background-clip: text; -webkit-text-fill-color: transparent;"> 100M User Scale</h3>
                                        <span id="scaleReadinessStatus" class="status-badge" style="background: var(--danger); font-size: 0.65rem;"> Foundation</span>
                                    </div>
                                    
                                    <!-- Scale Progress Bar -->
                                    <div style="background: var(--bg-tertiary); border-radius: 6px; height: 8px; overflow: hidden; margin-bottom: 6px;">
                                        <div id="scaleReadinessBar" style="height: 100%; width: 0%; background: linear-gradient(90deg, #f59e0b, #ef4444, #8b5cf6); border-radius: 6px; transition: width 1s ease-out;"></div>
                                    </div>
                                    
                                    <!-- Scale Stats -->
                                    <div style="display: flex; gap: 12px; flex-wrap: wrap; font-size: 0.7rem;">
                                        <div><span style="color: var(--text-muted);">Infra:</span> <strong id="scaleReadinessComponentCount">0/0</strong></div>
                                        <div><span style="color: var(--text-muted);">Blockers:</span> <strong id="scaleReadinessCritical" style="color: var(--danger);">0 blockers</strong></div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Category Breakdown -->
                            <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; min-width: 350px;">
                                <div class="launch-category" id="launchCat-auth" style="padding: 8px; background: var(--bg-tertiary); border-radius: 8px; text-align: center; cursor: pointer; transition: all 0.2s;" onclick="showLaunchCategoryDetails('auth')">
                                    <div style="font-size: 1rem;"></div>
                                    <div style="font-size: 0.6rem; color: var(--text-muted);">Auth</div>
                                    <div style="font-size: 0.75rem; font-weight: 600;" id="launchCatScore-auth">--%</div>
                                </div>
                                <div class="launch-category" id="launchCat-profiles" style="padding: 8px; background: var(--bg-tertiary); border-radius: 8px; text-align: center; cursor: pointer; transition: all 0.2s;" onclick="showLaunchCategoryDetails('profiles')">
                                    <div style="font-size: 1rem;"></div>
                                    <div style="font-size: 0.6rem; color: var(--text-muted);">Profiles</div>
                                    <div style="font-size: 0.75rem; font-weight: 600;" id="launchCatScore-profiles">--%</div>
                                </div>
                                <div class="launch-category" id="launchCat-matching" style="padding: 8px; background: var(--bg-tertiary); border-radius: 8px; text-align: center; cursor: pointer; transition: all 0.2s;" onclick="showLaunchCategoryDetails('matching')">
                                    <div style="font-size: 1rem;"></div>
                                    <div style="font-size: 0.6rem; color: var(--text-muted);">Matching</div>
                                    <div style="font-size: 0.75rem; font-weight: 600;" id="launchCatScore-matching">--%</div>
                                </div>
                                <div class="launch-category" id="launchCat-chat" style="padding: 8px; background: var(--bg-tertiary); border-radius: 8px; text-align: center; cursor: pointer; transition: all 0.2s;" onclick="showLaunchCategoryDetails('chat')">
                                    <div style="font-size: 1rem;"></div>
                                    <div style="font-size: 0.6rem; color: var(--text-muted);">Chat</div>
                                    <div style="font-size: 0.75rem; font-weight: 600;" id="launchCatScore-chat">--%</div>
                                </div>
                                <div class="launch-category" id="launchCat-payments" style="padding: 8px; background: var(--bg-tertiary); border-radius: 8px; text-align: center; cursor: pointer; transition: all 0.2s;" onclick="showLaunchCategoryDetails('payments')">
                                    <div style="font-size: 1rem;"></div>
                                    <div style="font-size: 0.6rem; color: var(--text-muted);">Payments</div>
                                    <div style="font-size: 0.75rem; font-weight: 600;" id="launchCatScore-payments">--%</div>
                                </div>
                                <div class="launch-category" id="launchCat-backend" style="padding: 8px; background: var(--bg-tertiary); border-radius: 8px; text-align: center; cursor: pointer; transition: all 0.2s;" onclick="showLaunchCategoryDetails('backend')">
                                    <div style="font-size: 1rem;"></div>
                                    <div style="font-size: 0.6rem; color: var(--text-muted);">Backend</div>
                                    <div style="font-size: 0.75rem; font-weight: 600;" id="launchCatScore-backend">--%</div>
                                </div>
                                <div class="launch-category" id="launchCat-safety" style="padding: 8px; background: var(--bg-tertiary); border-radius: 8px; text-align: center; cursor: pointer; transition: all 0.2s;" onclick="showLaunchCategoryDetails('safety')">
                                    <div style="font-size: 1rem;"></div>
                                    <div style="font-size: 0.6rem; color: var(--text-muted);">Safety</div>
                                    <div style="font-size: 0.75rem; font-weight: 600;" id="launchCatScore-safety">--%</div>
                                </div>
                                <div class="launch-category" id="launchCat-ux" style="padding: 8px; background: var(--bg-tertiary); border-radius: 8px; text-align: center; cursor: pointer; transition: all 0.2s;" onclick="showLaunchCategoryDetails('ux')">
                                    <div style="font-size: 1rem;"></div>
                                    <div style="font-size: 0.6rem; color: var(--text-muted);">UX</div>
                                    <div style="font-size: 0.75rem; font-weight: 600;" id="launchCatScore-ux">--%</div>
                                </div>
                                <div class="launch-category" id="launchCat-legal" style="padding: 8px; background: var(--bg-tertiary); border-radius: 8px; text-align: center; cursor: pointer; transition: all 0.2s; border: 1px solid var(--warning);" onclick="showLaunchCategoryDetails('legal')">
                                    <div style="font-size: 1rem;"></div>
                                    <div style="font-size: 0.6rem; color: var(--text-muted);">Legal</div>
                                    <div style="font-size: 0.75rem; font-weight: 600;" id="launchCatScore-legal">--%</div>
                                </div>
                                <div class="launch-category" id="launchCat-audit" style="padding: 8px; background: var(--bg-tertiary); border-radius: 8px; text-align: center; cursor: pointer; transition: all 0.2s; border: 1px solid var(--purple);" onclick="showLaunchCategoryDetails('audit')">
                                    <div style="font-size: 1rem;"></div>
                                    <div style="font-size: 0.6rem; color: var(--text-muted);">Audits</div>
                                    <div style="font-size: 0.75rem; font-weight: 600;" id="launchCatScore-audit">--%</div>
                                </div>
                            </div>
                            
                            <!-- Scale Categories (100M Users) -->
                            <div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 6px; min-width: 350px; margin-top: 8px; padding-top: 8px; border-top: 1px dashed var(--border);">
                                <div style="grid-column: span 6; font-size: 0.65rem; color: var(--text-muted); text-align: center; margin-bottom: 4px;">
                                     100M SCALE INFRASTRUCTURE
                                </div>
                                <div class="launch-category" id="scaleCat-database" style="padding: 6px; background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(239, 68, 68, 0.1)); border-radius: 6px; text-align: center; cursor: pointer; transition: all 0.2s;" onclick="showScaleCategoryDetails('database')">
                                    <div style="font-size: 0.9rem;"></div>
                                    <div style="font-size: 0.55rem; color: var(--text-muted);">Database</div>
                                    <div style="font-size: 0.7rem; font-weight: 600;" id="scaleCatScore-database">--%</div>
                                </div>
                                <div class="launch-category" id="scaleCat-compute" style="padding: 6px; background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(239, 68, 68, 0.1)); border-radius: 6px; text-align: center; cursor: pointer; transition: all 0.2s;" onclick="showScaleCategoryDetails('compute')">
                                    <div style="font-size: 0.9rem;"></div>
                                    <div style="font-size: 0.55rem; color: var(--text-muted);">Compute</div>
                                    <div style="font-size: 0.7rem; font-weight: 600;" id="scaleCatScore-compute">--%</div>
                                </div>
                                <div class="launch-category" id="scaleCat-caching" style="padding: 6px; background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(239, 68, 68, 0.1)); border-radius: 6px; text-align: center; cursor: pointer; transition: all 0.2s;" onclick="showScaleCategoryDetails('caching')">
                                    <div style="font-size: 0.9rem;"></div>
                                    <div style="font-size: 0.55rem; color: var(--text-muted);">Caching</div>
                                    <div style="font-size: 0.7rem; font-weight: 600;" id="scaleCatScore-caching">--%</div>
                                </div>
                                <div class="launch-category" id="scaleCat-infrastructure" style="padding: 6px; background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(239, 68, 68, 0.1)); border-radius: 6px; text-align: center; cursor: pointer; transition: all 0.2s;" onclick="showScaleCategoryDetails('infrastructure')">
                                    <div style="font-size: 0.9rem;"></div>
                                    <div style="font-size: 0.55rem; color: var(--text-muted);">Infra</div>
                                    <div style="font-size: 0.7rem; font-weight: 600;" id="scaleCatScore-infrastructure">--%</div>
                                </div>
                                <div class="launch-category" id="scaleCat-performance" style="padding: 6px; background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(239, 68, 68, 0.1)); border-radius: 6px; text-align: center; cursor: pointer; transition: all 0.2s;" onclick="showScaleCategoryDetails('performance')">
                                    <div style="font-size: 0.9rem;"></div>
                                    <div style="font-size: 0.55rem; color: var(--text-muted);">Perf Test</div>
                                    <div style="font-size: 0.7rem; font-weight: 600;" id="scaleCatScore-performance">--%</div>
                                </div>
                                <div class="launch-category" id="scaleCat-resilience" style="padding: 6px; background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(239, 68, 68, 0.1)); border-radius: 6px; text-align: center; cursor: pointer; transition: all 0.2s;" onclick="showScaleCategoryDetails('resilience')">
                                    <div style="font-size: 0.9rem;"></div>
                                    <div style="font-size: 0.55rem; color: var(--text-muted);">Resilience</div>
                                    <div style="font-size: 0.7rem; font-weight: 600;" id="scaleCatScore-resilience">--%</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Expandable Details -->
                        <div id="launchReadinessDetails" style="display: none; margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                <h4 style="margin: 0; font-size: 0.9rem;" id="launchDetailsTitle">Component Details</h4>
                                <button onclick="document.getElementById('launchReadinessDetails').style.display='none'" style="background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 1.2rem;"></button>
                            </div>
                            <div id="launchDetailsContent" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 8px;"></div>
                        </div>
                        
                        <!-- Outstanding Tasks Section -->
                        <div id="launchOutstandingTasks" style="display: none; margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                <h4 style="margin: 0; font-size: 0.9rem; color: var(--warning);">
                                     Outstanding Tasks Required for Launch
                                    <span id="launchOutstandingCount" style="font-size: 0.75rem; background: var(--danger); color: white; padding: 2px 8px; border-radius: 10px; margin-left: 8px;">0</span>
                                </h4>
                                <div style="display: flex; gap: 8px;">
                                    <button onclick="scheduleAllOutstandingTasks()" class="btn btn-primary" style="font-size: 0.75rem; padding: 6px 12px;">
                                         Schedule All
                                    </button>
                                    <button onclick="document.getElementById('launchOutstandingTasks').style.display='none'" style="background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 1.2rem;"></button>
                                </div>
                            </div>
                            <div id="launchOutstandingList" style="display: flex; flex-direction: column; gap: 8px; max-height: 300px; overflow-y: auto;"></div>
                        </div>
                    </div>
                </div>

                <!-- Timeline Overview -->
                <div class="card" style="margin-bottom: 20px; border: 2px solid var(--accent);">
                    <div class="card-header" style="background: linear-gradient(135deg, rgba(0, 120, 212, 0.15), rgba(0, 120, 212, 0.05));">
                        <h3 class="card-title"> Launch Timeline Overview</h3>
                        <span class="status-badge" style="background: var(--warning);">~9 Weeks to Launch</span>
                    </div>
                    <div class="card-body">
                        <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 20px;">
                            <div style="flex: 1; min-width: 150px; padding: 12px; background: var(--bg-tertiary); border-radius: 8px; border-left: 4px solid var(--warning);">
                                <div style="font-size: 0.7rem; color: var(--text-muted);">PHASE 1</div>
                                <div style="font-weight: 600;">Foundation</div>
                                <div style="font-size: 0.75rem; color: var(--text-secondary);">Nov 28 - Dec 7</div>
                            </div>
                            <div style="flex: 1; min-width: 150px; padding: 12px; background: var(--bg-tertiary); border-radius: 8px; border-left: 4px solid var(--info);">
                                <div style="font-size: 0.7rem; color: var(--text-muted);">PHASE 2</div>
                                <div style="font-weight: 600;">Development</div>
                                <div style="font-size: 0.75rem; color: var(--text-secondary);">Dec 8 - Dec 28</div>
                            </div>
                            <div style="flex: 1; min-width: 150px; padding: 12px; background: var(--bg-tertiary); border-radius: 8px; border-left: 4px solid var(--purple);">
                                <div style="font-size: 0.7rem; color: var(--text-muted);">PHASE 3</div>
                                <div style="font-weight: 600;">Testing</div>
                                <div style="font-size: 0.75rem; color: var(--text-secondary);">Dec 29 - Jan 11</div>
                            </div>
                            <div style="flex: 1; min-width: 150px; padding: 12px; background: var(--bg-tertiary); border-radius: 8px; border-left: 4px solid var(--warning);">
                                <div style="font-size: 0.7rem; color: var(--text-muted);">PHASE 4</div>
                                <div style="font-weight: 600;">Pre-Launch</div>
                                <div style="font-size: 0.75rem; color: var(--text-secondary);">Jan 12 - Jan 31</div>
                            </div>
                            <div style="flex: 1; min-width: 150px; padding: 12px; background: var(--bg-tertiary); border-radius: 8px; border-left: 4px solid var(--success);">
                                <div style="font-size: 0.7rem; color: var(--text-muted);">PHASE 5</div>
                                <div style="font-weight: 600;"> Launch</div>
                                <div style="font-size: 0.75rem; color: var(--text-secondary);">Feb 1, 2026</div>
                            </div>
                        </div>
                        <!-- Category Legend -->
                        <div style="display: flex; gap: 16px; flex-wrap: wrap; padding-top: 12px; border-top: 1px solid var(--border);">
                            <span style="font-size: 0.75rem; color: var(--text-muted); font-weight: 600;">CATEGORY LEGEND:</span>
                            <div style="display: flex; align-items: center; gap: 6px;">
                                <div style="width: 12px; height: 12px; border-radius: 3px; background: #ec4899;"></div>
                                <span style="font-size: 0.75rem; color: var(--text-secondary);"> Tax</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 6px;">
                                <div style="width: 12px; height: 12px; border-radius: 3px; background: #a855f7;"></div>
                                <span style="font-size: 0.75rem; color: var(--text-secondary);"> Legal/Patents</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 6px;">
                                <div style="width: 12px; height: 12px; border-radius: 3px; background: #f97316;"></div>
                                <span style="font-size: 0.75rem; color: var(--text-secondary);"> Compliance</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 6px;">
                                <div style="width: 12px; height: 12px; border-radius: 3px; background: #22c55e;"></div>
                                <span style="font-size: 0.75rem; color: var(--text-secondary);"> Payroll</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 6px;">
                                <div style="width: 12px; height: 12px; border-radius: 3px; background: var(--accent);"></div>
                                <span style="font-size: 0.75rem; color: var(--text-secondary);"> Milestones</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 6px;">
                                <div style="width: 12px; height: 12px; border-radius: 3px; background: var(--danger);"></div>
                                <span style="font-size: 0.75rem; color: var(--text-secondary);"> Critical</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Key Milestones -->
                <div class="card" style="margin-bottom: 20px;">
                    <div class="card-header">
                        <h3 class="card-title"> Key Milestones</h3>
                    </div>
                    <div class="card-body">
                        <div style="display: flex; flex-direction: column; gap: 8px;" id="milestonesContainer">
                            <!-- Milestone items will be populated by JS -->
                        </div>
                    </div>
                </div>

                <!-- Upcoming Tasks -->
                <div class="card" style="margin-bottom: 20px;">
                    <div class="card-header">
                        <h3 class="card-title"> Upcoming Tasks (Next 7 Days)</h3>
                    </div>
                    <div class="card-body">
                        <div id="upcomingTasksContainer" style="display: flex; flex-direction: column; gap: 8px;">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>

                <!-- Full Calendar View -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title"> Full Calendar View</h3>
                        <div style="display: flex; gap: 8px;">
                            <button class="btn btn-secondary" onclick="fullCalendarPrevMonth()" style="padding: 4px 10px;"></button>
                            <span id="calendarMonthLabel" style="min-width: 120px; text-align: center; font-weight: 600;"></span>
                            <button class="btn btn-secondary" onclick="fullCalendarNextMonth()" style="padding: 4px 10px;"></button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="calendarGrid" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px;">
                            <!-- Calendar grid populated by JS -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Stress Test / Simulation Section -->
            <div id="simulation-section" style="display: none;">
                <div class="page-header">
                    <div>
                        <h2 class="page-title"> Matching Algorithm Stress Test</h2>
                        <p class="page-subtitle">Simulate user load to identify scalability issues in the matching algorithm.</p>
                    </div>
                    <div class="header-actions" style="display: flex; gap: 8px;">
                        <button class="btn btn-secondary" onclick="clearSimulationHistory()" id="clearSimHistoryBtn">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="3 6 5 6 21 6"/>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                            </svg>
                            Clear History
                        </button>
                        <button class="btn btn-secondary" onclick="exportSimulationResults()" id="exportSimBtn">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"/>
                            </svg>
                            Export Results
                        </button>
                        <button class="btn btn-primary" onclick="runMatchingSimulation()" id="runSimBtn">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polygon points="5 3 19 12 5 21 5 3"/>
                            </svg>
                            Run Simulation
                        </button>
                    </div>
                </div>

                <!-- Simulation Control Panel -->
                <div class="card" style="margin-bottom: 20px; border: 2px solid var(--accent);">
                    <div class="card-header" style="background: linear-gradient(135deg, rgba(0, 120, 212, 0.1), rgba(0, 120, 212, 0.05));">
                        <h3 class="card-title"> Simulation Control Panel</h3>
                        <span id="simStatusBadge" class="status-badge" style="font-size: 0.75rem;">Ready</span>
                    </div>
                    <div class="card-body">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px;">
                            <!-- Simulation Parameters -->
                            <div style="padding: 16px; background: var(--bg-tertiary); border-radius: 12px; border: 1px solid var(--border);">
                                <div style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 12px;">SIMULATION PARAMETERS</div>
                                <div style="display: flex; flex-direction: column; gap: 12px;">
                                    <div>
                                        <label style="font-size: 0.8rem; color: var(--text-muted); display: block; margin-bottom: 4px;">User Count</label>
                                        <select id="simUserCount" style="width: 100%; padding: 8px 12px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary);">
                                            <option value="100">100 users</option>
                                            <option value="500">500 users</option>
                                            <option value="1000" selected>1,000 users</option>
                                            <option value="2500">2,500 users</option>
                                            <option value="5000">5,000 users</option>
                                            <option value="10000">10,000 users</option>
                                            <option value="25000">25,000 users</option>
                                            <option value="50000">50,000 users</option>
                                            <option value="100000">100,000 users</option>
                                            <option value="250000">250,000 users</option>
                                            <option value="500000">500,000 users</option>
                                            <option value="1000000">1 Million users</option>
                                            <option value="2500000">2.5 Million users</option>
                                            <option value="5000000">5 Million users</option>
                                            <option value="10000000">10 Million users</option>
                                            <option value="25000000">25 Million users</option>
                                            <option value="50000000">50 Million users</option>
                                            <option value="100000000">100 Million users</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label style="font-size: 0.8rem; color: var(--text-muted); display: block; margin-bottom: 4px;">Match Attempts</label>
                                        <input type="number" id="simMatchAttempts" value="100" min="10" max="1000" 
                                               style="width: 100%; padding: 8px 12px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary);">
                                    </div>
                                    <div>
                                        <label style="font-size: 0.8rem; color: var(--text-muted); display: block; margin-bottom: 4px;">Use Geohash Index</label>
                                        <select id="simUseGeohash" style="width: 100%; padding: 8px 12px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary);">
                                            <option value="true" selected>Yes (Optimized)</option>
                                            <option value="false">No (Baseline - Full Scan)</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label style="font-size: 0.8rem; color: var(--text-muted); display: block; margin-bottom: 4px;">City Focus</label>
                                        <select id="simCityFocus" style="width: 100%; padding: 8px 12px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary);">
                                            <option value="">Random Distribution</option>
                                            <option value="New York">New York</option>
                                            <option value="Los Angeles">Los Angeles</option>
                                            <option value="Chicago">Chicago</option>
                                            <option value="Austin">Austin</option>
                                            <option value="Miami">Miami</option>
                                            <option value="Seattle">Seattle</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <!-- Real-Life Scenarios -->
                            <div style="padding: 16px; background: var(--bg-tertiary); border-radius: 12px; border: 1px solid var(--purple);">
                                <div style="font-size: 0.8rem; color: var(--purple); margin-bottom: 12px; font-weight: 600;"> REAL-LIFE SCENARIOS</div>
                                <div style="display: flex; flex-direction: column; gap: 8px;">
                                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 0.85rem;">
                                        <input type="checkbox" id="simConcurrentUsers" checked style="width: 16px; height: 16px; accent-color: var(--purple);">
                                        <span>Concurrent users (parallel requests)</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 0.85rem;">
                                        <input type="checkbox" id="simRateLimiting" checked style="width: 16px; height: 16px; accent-color: var(--purple);">
                                        <span>Rate limiting (20 req/min)</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 0.85rem;">
                                        <input type="checkbox" id="simColdStarts" checked style="width: 16px; height: 16px; accent-color: var(--purple);">
                                        <span>Lambda cold starts (~300ms)</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 0.85rem;">
                                        <input type="checkbox" id="simDbLatency" checked style="width: 16px; height: 16px; accent-color: var(--purple);">
                                        <span>Database latency (5-50ms)</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 0.85rem;">
                                        <input type="checkbox" id="simBlockedUsers" style="width: 16px; height: 16px; accent-color: var(--purple);">
                                        <span>Blocked/reported users (2%)</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 0.85rem;">
                                        <input type="checkbox" id="simPoolExhaustion" style="width: 16px; height: 16px; accent-color: var(--purple);">
                                        <span>Match pool exhaustion</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 0.85rem;">
                                        <input type="checkbox" id="simTimerExpiry" style="width: 16px; height: 16px; accent-color: var(--purple);">
                                        <span>Timer expirations (24h)</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 0.85rem;">
                                        <input type="checkbox" id="simNetworkErrors" style="width: 16px; height: 16px; accent-color: var(--purple);">
                                        <span>Network failures (0.5%)</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 0.85rem;">
                                        <input type="checkbox" id="simPeakHours" style="width: 16px; height: 16px; accent-color: var(--purple);">
                                        <span>Peak hours traffic (3x spike)</span>
                                    </label>
                                </div>
                            </div>

                            <!-- Quick Actions -->
                            <div style="padding: 16px; background: var(--bg-tertiary); border-radius: 12px; border: 1px solid var(--border);">
                                <div style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 12px;">QUICK ACTIONS</div>
                                <div style="display: flex; flex-direction: column; gap: 10px;">
                                    <button class="btn btn-secondary" style="width: 100%; justify-content: center;" onclick="runScalingTestAdmin()">
                                         Scaling Test (100  1M users)
                                    </button>
                                    <button class="btn btn-secondary" style="width: 100%; justify-content: center; background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(168, 85, 247, 0.2)); border-color: var(--danger);" onclick="runMassiveScaleTest()">
                                         Massive Scale (1M  100M users)
                                    </button>
                                    <button class="btn btn-secondary" style="width: 100%; justify-content: center; background: linear-gradient(135deg, rgba(139, 92, 246, 0.2), rgba(59, 130, 246, 0.2)); border-color: var(--purple);" onclick="runRealLifeStressTest()">
                                         Full Real-Life Stress Test
                                    </button>
                                    <button class="btn btn-secondary" style="width: 100%; justify-content: center; background: linear-gradient(135deg, rgba(249, 115, 22, 0.2), rgba(234, 88, 12, 0.2)); border-color: var(--warning);" onclick="runPeakHourTest()">
                                         Peak Hour Stress Test
                                    </button>
                                    <button class="btn btn-secondary" style="width: 100%; justify-content: center;" onclick="runComparisonTest()">
                                         Compare Geohash vs Full Scan
                                    </button>
                                    <button class="btn btn-secondary" style="width: 100%; justify-content: center;" onclick="runCityAnalysis()">
                                         Analyze City Distribution
                                    </button>
                                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; margin-top: 8px;">
                                        <input type="checkbox" id="simAutoSave" checked style="width: 18px; height: 18px; accent-color: var(--accent);">
                                        <span style="font-size: 0.9rem;">Auto-save results to history</span>
                                    </label>
                                </div>
                            </div>

                            <!-- Live Stats -->
                            <div style="padding: 16px; background: var(--bg-tertiary); border-radius: 12px; border: 1px solid var(--border);">
                                <div style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 12px;">LIVE SIMULATION STATS</div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                    <div style="padding: 12px; background: var(--bg-secondary); border-radius: 8px; text-align: center;">
                                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--success);" id="simUsersGenerated">0</div>
                                        <div style="font-size: 0.7rem; color: var(--text-muted);">Users Generated</div>
                                    </div>
                                    <div style="padding: 12px; background: var(--bg-secondary); border-radius: 8px; text-align: center;">
                                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--info);" id="simMatchesRun">0</div>
                                        <div style="font-size: 0.7rem; color: var(--text-muted);">Matches Run</div>
                                    </div>
                                    <div style="padding: 12px; background: var(--bg-secondary); border-radius: 8px; text-align: center;">
                                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--warning);" id="simAvgTime"></div>
                                        <div style="font-size: 0.7rem; color: var(--text-muted);">Avg Time (ms)</div>
                                    </div>
                                    <div style="padding: 12px; background: var(--bg-secondary); border-radius: 8px; text-align: center;">
                                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--accent);" id="simProgress">0%</div>
                                        <div style="font-size: 0.7rem; color: var(--text-muted);">Progress</div>
                                    </div>
                                </div>
                                <div style="margin-top: 12px;">
                                    <div style="background: var(--bg-secondary); border-radius: 8px; height: 8px; overflow: hidden;">
                                        <div id="simProgressBar" style="background: linear-gradient(90deg, var(--accent), var(--info)); height: 100%; width: 0%; transition: width 0.3s ease;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Results Metrics -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 16px; margin-bottom: 20px;">
                    <div class="card" style="padding: 20px; text-align: center;">
                        <div style="font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 8px;">Total Users</div>
                        <div style="font-size: 2rem; font-weight: 700;" id="simMetricUsers"></div>
                    </div>
                    <div class="card" style="padding: 20px; text-align: center;">
                        <div style="font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 8px;">Match Success Rate</div>
                        <div style="font-size: 2rem; font-weight: 700;" id="simMetricSuccess"></div>
                    </div>
                    <div class="card" style="padding: 20px; text-align: center;">
                        <div style="font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 8px;">Avg Match Time</div>
                        <div style="font-size: 2rem; font-weight: 700;" id="simMetricAvgTime"></div>
                    </div>
                    <div class="card" style="padding: 20px; text-align: center;">
                        <div style="font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 8px;">P95 Response</div>
                        <div style="font-size: 2rem; font-weight: 700;" id="simMetricP95"></div>
                    </div>
                    <div class="card" style="padding: 20px; text-align: center;">
                        <div style="font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 8px;">Profiles Scanned</div>
                        <div style="font-size: 2rem; font-weight: 700;" id="simMetricScans"></div>
                    </div>
                    <div class="card" style="padding: 20px; text-align: center;">
                        <div style="font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 8px;">Total Duration</div>
                        <div style="font-size: 2rem; font-weight: 700;" id="simMetricDuration"></div>
                    </div>
                </div>

                <!-- Real-Life Scenario Metrics Row -->
                <div id="simRealLifeMetrics" style="display: none; margin-bottom: 20px;">
                    <div class="card" style="border: 2px solid var(--purple);">
                        <div class="card-header" style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.2), rgba(139, 92, 246, 0.05));">
                            <h3 class="card-title"> Real-Life Scenario Results</h3>
                            <span class="status-badge" style="background: var(--purple);">Production Simulation</span>
                        </div>
                        <div class="card-body">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px;">
                                <div style="padding: 16px; background: var(--bg-tertiary); border-radius: 8px; text-align: center; border-left: 3px solid var(--info);">
                                    <div style="font-size: 1.5rem; font-weight: 700; color: var(--info);" id="simRLColdStarts">0</div>
                                    <div style="font-size: 0.7rem; color: var(--text-muted);"> Cold Starts</div>
                                </div>
                                <div style="padding: 16px; background: var(--bg-tertiary); border-radius: 8px; text-align: center; border-left: 3px solid var(--warning);">
                                    <div style="font-size: 1.5rem; font-weight: 700; color: var(--warning);" id="simRLRateLimited">0</div>
                                    <div style="font-size: 0.7rem; color: var(--text-muted);"> Rate Limited</div>
                                </div>
                                <div style="padding: 16px; background: var(--bg-tertiary); border-radius: 8px; text-align: center; border-left: 3px solid var(--danger);">
                                    <div style="font-size: 1.5rem; font-weight: 700; color: var(--danger);" id="simRLNetworkErrors">0</div>
                                    <div style="font-size: 0.7rem; color: var(--text-muted);"> Network Errors</div>
                                </div>
                                <div style="padding: 16px; background: var(--bg-tertiary); border-radius: 8px; text-align: center; border-left: 3px solid var(--purple);">
                                    <div style="font-size: 1.5rem; font-weight: 700; color: var(--purple);" id="simRLRaceConditions">0</div>
                                    <div style="font-size: 0.7rem; color: var(--text-muted);"> Race Conditions</div>
                                </div>
                                <div style="padding: 16px; background: var(--bg-tertiary); border-radius: 8px; text-align: center; border-left: 3px solid var(--accent);">
                                    <div style="font-size: 1.5rem; font-weight: 700; color: var(--accent);" id="simRLPeakConcurrent">0</div>
                                    <div style="font-size: 0.7rem; color: var(--text-muted);"> Peak Concurrent</div>
                                </div>
                                <div style="padding: 16px; background: var(--bg-tertiary); border-radius: 8px; text-align: center; border-left: 3px solid var(--success);">
                                    <div style="font-size: 1.5rem; font-weight: 700; color: var(--success);" id="simRLDbLatency">0ms</div>
                                    <div style="font-size: 0.7rem; color: var(--text-muted);"> Avg DB Latency</div>
                                </div>
                                <div style="padding: 16px; background: var(--bg-tertiary); border-radius: 8px; text-align: center; border-left: 3px solid var(--warning);">
                                    <div style="font-size: 1.5rem; font-weight: 700; color: var(--warning);" id="simRLPoolExhausted">0</div>
                                    <div style="font-size: 0.7rem; color: var(--text-muted);"> Pool Exhausted</div>
                                </div>
                                <div style="padding: 16px; background: var(--bg-tertiary); border-radius: 8px; text-align: center; border-left: 3px solid var(--text-secondary);">
                                    <div style="font-size: 1.5rem; font-weight: 700; color: var(--text-secondary);" id="simRLBlockedHits">0</div>
                                    <div style="font-size: 0.7rem; color: var(--text-muted);"> Blocked Encounters</div>
                                </div>
                            </div>
                            <!-- Traffic Pattern Visualization -->
                            <div id="simTrafficPattern" style="margin-top: 16px; display: none;">
                                <div style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 8px;"> 24-Hour Traffic Pattern</div>
                                <div id="simTrafficBars" style="display: flex; align-items: flex-end; gap: 2px; height: 60px; background: var(--bg-secondary); border-radius: 8px; padding: 8px;"></div>
                                <div style="display: flex; justify-content: space-between; font-size: 0.65rem; color: var(--text-muted); margin-top: 4px;">
                                    <span>12 AM</span><span>6 AM</span><span>12 PM</span><span>6 PM</span><span>12 AM</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Charts Row -->
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 20px;">
                    <!-- Response Time Distribution -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"> Response Time Distribution</h3>
                        </div>
                        <div class="card-body" id="simTimeChart" style="min-height: 250px;">
                            <div style="text-align: center; padding: 60px; color: var(--text-muted);">
                                <div style="font-size: 2.5rem; margin-bottom: 12px;"></div>
                                <div style="font-weight: 600;">No data yet</div>
                                <div style="font-size: 0.85rem;">Run a simulation to see results</div>
                            </div>
                        </div>
                    </div>

                    <!-- Scaling Performance -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"> Scaling Performance</h3>
                        </div>
                        <div class="card-body" id="simScalingChart" style="min-height: 250px;">
                            <div style="text-align: center; padding: 60px; color: var(--text-muted);">
                                <div style="font-size: 2.5rem; margin-bottom: 12px;"></div>
                                <div style="font-weight: 600;">No scaling data</div>
                                <div style="font-size: 0.85rem;">Run scaling test to compare performance</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Second Charts Row -->
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 20px;">
                    <!-- User Distribution -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"> User Distribution</h3>
                        </div>
                        <div class="card-body" id="simUserChart" style="min-height: 200px;">
                            <div style="text-align: center; padding: 40px; color: var(--text-muted);">
                                <div style="font-size: 2.5rem; margin-bottom: 12px;"></div>
                                <div style="font-weight: 600;">No users generated</div>
                                <div style="font-size: 0.85rem;">Run a simulation to see distribution</div>
                            </div>
                        </div>
                    </div>

                    <!-- Match Analysis -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"> Match Analysis</h3>
                        </div>
                        <div class="card-body" id="simMatchChart" style="min-height: 200px;">
                            <div style="text-align: center; padding: 40px; color: var(--text-muted);">
                                <div style="font-size: 2.5rem; margin-bottom: 12px;"></div>
                                <div style="font-weight: 600;">No match data</div>
                                <div style="font-size: 0.85rem;">Run a simulation to analyze matches</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Debug Console -->
                <div class="card" style="margin-bottom: 20px;">
                    <div class="card-header" style="cursor: pointer;" onclick="toggleSimConsole()">
                        <h3 class="card-title"> Debug Console</h3>
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 0.75rem;" onclick="event.stopPropagation(); clearSimLog()">Clear</button>
                            <svg id="simConsoleToggle" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="transition: transform 0.3s;">
                                <polyline points="6 9 12 15 18 9"/>
                            </svg>
                        </div>
                    </div>
                    <div id="simConsoleBody" style="display: block;">
                        <div class="card-body" style="padding: 0;">
                            <div id="simLogOutput" style="background: #0d1117; border-radius: 0 0 12px 12px; padding: 16px; font-family: 'Consolas', 'Monaco', monospace; font-size: 0.75rem; max-height: 300px; overflow-y: auto; line-height: 1.8;">
                                <div style="display: flex; gap: 12px;">
                                    <span style="color: #7d8590;">[00:00:00]</span>
                                    <span style="color: #58a6ff;">Ready to run simulation. Configure parameters above and click Run.</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Issues & Recommendations -->
                <div class="card" style="margin-bottom: 20px; border: 2px solid var(--warning);">
                    <div class="card-header" style="background: linear-gradient(135deg, rgba(255, 140, 0, 0.1), rgba(255, 140, 0, 0.05));">
                        <h3 class="card-title"> Detected Issues & Recommendations</h3>
                        <span id="simIssueCount" class="status-badge" style="font-size: 0.75rem; background: var(--warning);">0 issues</span>
                    </div>
                    <div class="card-body" id="simIssuesList">
                        <div style="text-align: center; padding: 40px; color: var(--text-muted);">
                            <div style="font-size: 2.5rem; margin-bottom: 12px;"></div>
                            <div style="font-weight: 600;">No issues detected</div>
                            <div style="font-size: 0.85rem;">Run a simulation to identify potential bottlenecks</div>
                        </div>
                    </div>
                </div>

                <!-- Saved Results History -->
                <div class="card">
                    <div class="card-header" style="cursor: pointer;" onclick="toggleSimHistory()">
                        <h3 class="card-title"> Saved Results History</h3>
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <span id="simHistoryCount" class="status-badge" style="font-size: 0.75rem;">0 saved</span>
                            <svg id="simHistoryToggle" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="transition: transform 0.3s;">
                                <polyline points="6 9 12 15 18 9"/>
                            </svg>
                        </div>
                    </div>
                    <div id="simHistoryBody" style="display: none;">
                        <div class="card-body" id="simHistoryList" style="padding: 0;">
                            <div style="text-align: center; padding: 40px; color: var(--text-muted);">
                                <div>No saved results yet</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- App Diagnostics & Navigation Tests Section -->
            <div id="diagnostics-section" style="display: none;">
                    <div class="page-header">
                        <div>
                            <h2 class="page-title"> App Diagnostics & Crawler Control</h2>
                            <p class="page-subtitle">Monitor code dependencies, logic flow, and detect issues across all screens.</p>
                        </div>
                        <div class="header-actions" style="display: flex; gap: 8px;">
                            <button class="btn btn-secondary" onclick="stopCrawler()" id="stopCrawlerBtn" style="display: none;">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="6" y="6" width="12" height="12"/>
                                </svg>
                                Stop
                            </button>
                            <button class="btn btn-secondary" onclick="pingIndexApp()" id="pingAppBtn">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="10"/>
                                    <path d="M12 6v6"/>
                                    <path d="M12 16h.01"/>
                                </svg>
                                Ping App
                            </button>
                            <button class="btn btn-primary" onclick="runAppDiagnostics()" id="runCrawlerBtn">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polygon points="5 3 19 12 5 21 5 3"/>
                                </svg>
                                Run Crawler
                            </button>
                        </div>
                    </div>

                    <!-- Crawler Control Panel -->
                    <div class="card" style="margin-bottom: 20px; border: 2px solid var(--purple);">
                        <div class="card-header" style="background: linear-gradient(135deg, rgba(168, 85, 247, 0.1), rgba(168, 85, 247, 0.05));">
                            <h3 class="card-title"> Crawler Control Panel</h3>
                            <span id="crawlerStatusBadge" class="status-badge" style="font-size: 0.75rem;">Idle</span>
                        </div>
                        <div class="card-body">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px;">
                                <!-- Inspection Options -->
                                <div style="padding: 16px; background: var(--bg-tertiary); border-radius: 12px; border: 1px solid var(--border);">
                                    <div style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 12px;">INSPECTION OPTIONS</div>
                                    <div style="display: flex; flex-direction: column; gap: 10px;">
                                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                            <input type="checkbox" id="crawlScreenNav" checked style="width: 18px; height: 18px; accent-color: var(--accent);">
                                            <span style="font-size: 0.9rem;">Screen Navigation Flow</span>
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                            <input type="checkbox" id="crawlDependencies" checked style="width: 18px; height: 18px; accent-color: var(--accent);">
                                            <span style="font-size: 0.9rem;">Code Dependencies</span>
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                            <input type="checkbox" id="crawlLogicFlow" checked style="width: 18px; height: 18px; accent-color: var(--accent);">
                                            <span style="font-size: 0.9rem;">Logic Flow Analysis</span>
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                            <input type="checkbox" id="crawlJSErrors" checked style="width: 18px; height: 18px; accent-color: var(--accent);">
                                            <span style="font-size: 0.9rem;">JavaScript Errors</span>
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                            <input type="checkbox" id="crawlBrokenLinks" checked style="width: 18px; height: 18px; accent-color: var(--accent);">
                                            <span style="font-size: 0.9rem;">Broken Links/Handlers</span>
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                            <input type="checkbox" id="crawlDataIntegrity" style="width: 18px; height: 18px; accent-color: var(--accent);">
                                            <span style="font-size: 0.9rem;">Data Integrity Check</span>
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; border-top: 1px solid var(--border); padding-top: 10px; margin-top: 6px;">
                                            <input type="checkbox" id="crawlSimulateLogin" checked style="width: 18px; height: 18px; accent-color: var(--success);">
                                            <span style="font-size: 0.9rem; color: var(--success);"> Simulate Logged-in User</span>
                                        </label>
                                    </div>
                                </div>

                                <!-- Crawler Settings -->
                                <div style="padding: 16px; background: var(--bg-tertiary); border-radius: 12px; border: 1px solid var(--border);">
                                    <div style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 12px;">CRAWLER SETTINGS</div>
                                    <div style="display: flex; flex-direction: column; gap: 12px;">
                                        <div>
                                            <label style="font-size: 0.8rem; color: var(--text-muted); display: block; margin-bottom: 4px;">Timeout (ms)</label>
                                            <input type="number" id="crawlerTimeout" value="30000" min="5000" max="120000" step="1000" 
                                                   style="width: 100%; padding: 8px 12px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary);">
                                        </div>
                                        <div>
                                            <label style="font-size: 0.8rem; color: var(--text-muted); display: block; margin-bottom: 4px;">Flow Filter</label>
                                            <select id="crawlerFlowFilter" style="width: 100%; padding: 8px 12px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary);">
                                                <option value="all">All Flows</option>
                                                <option value="onboarding">Onboarding Only</option>
                                                <option value="auth">Authentication Only</option>
                                                <option value="setup">Profile Setup Only</option>
                                                <option value="main">Main App Only</option>
                                                <option value="chat">Chat & Connection Only</option>
                                                <option value="profile">Profile Screens Only</option>
                                                <option value="settings">Settings Only</option>
                                            </select>
                                        </div>
                                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                            <input type="checkbox" id="crawlerAutoRun" style="width: 18px; height: 18px; accent-color: var(--accent);">
                                            <span style="font-size: 0.9rem;">Auto-run every 5 minutes</span>
                                        </label>
                                    </div>
                                </div>

                                <!-- Live Stats -->
                                <div style="padding: 16px; background: var(--bg-tertiary); border-radius: 12px; border: 1px solid var(--border);">
                                    <div style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 12px;">LIVE CRAWLER STATS</div>
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                        <div style="padding: 12px; background: var(--bg-secondary); border-radius: 8px; text-align: center;">
                                            <div style="font-size: 1.5rem; font-weight: 700; color: var(--success);" id="crawlerPassed">0</div>
                                            <div style="font-size: 0.7rem; color: var(--text-muted);">Passed</div>
                                        </div>
                                        <div style="padding: 12px; background: var(--bg-secondary); border-radius: 8px; text-align: center;">
                                            <div style="font-size: 1.5rem; font-weight: 700; color: var(--danger);" id="crawlerFailed">0</div>
                                            <div style="font-size: 0.7rem; color: var(--text-muted);">Failed</div>
                                        </div>
                                        <div style="padding: 12px; background: var(--bg-secondary); border-radius: 8px; text-align: center;">
                                            <div style="font-size: 1.5rem; font-weight: 700; color: var(--warning);" id="crawlerWarnings">0</div>
                                            <div style="font-size: 0.7rem; color: var(--text-muted);">Warnings</div>
                                        </div>
                                        <div style="padding: 12px; background: var(--bg-secondary); border-radius: 8px; text-align: center;">
                                            <div style="font-size: 1.5rem; font-weight: 700; color: var(--info);" id="crawlerProgress">0%</div>
                                            <div style="font-size: 0.7rem; color: var(--text-muted);">Progress</div>
                                        </div>
                                    </div>
                                    <div style="margin-top: 12px;">
                                        <div style="background: var(--bg-secondary); border-radius: 8px; height: 8px; overflow: hidden;">
                                            <div id="crawlerProgressBar" style="background: linear-gradient(90deg, var(--success), var(--info)); height: 100%; width: 0%; transition: width 0.3s ease;"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Code Dependency Map -->
                    <div class="card" style="margin-bottom: 20px;">
                        <div class="card-header" style="cursor: pointer;" onclick="toggleDependencyMap()">
                            <h3 class="card-title"> Code Dependency Map</h3>
                            <svg id="dependencyMapToggle" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="transition: transform 0.3s;">
                                <polyline points="6 9 12 15 18 9"/>
                            </svg>
                        </div>
                        <div id="dependencyMapBody" style="display: none;">
                            <div class="card-body" style="padding: 0;">
                                <div style="padding: 16px; border-bottom: 1px solid var(--border);">
                                    <p style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 12px;">
                                        Visual map of function calls, event handlers, and screen transitions. Red lines indicate broken dependencies.
                                    </p>
                                    <div style="display: flex; gap: 16px; flex-wrap: wrap;">
                                        <span style="display: flex; align-items: center; gap: 6px; font-size: 0.75rem;">
                                            <span style="width: 12px; height: 3px; background: var(--success); border-radius: 2px;"></span> Function Call
                                        </span>
                                        <span style="display: flex; align-items: center; gap: 6px; font-size: 0.75rem;">
                                            <span style="width: 12px; height: 3px; background: var(--info); border-radius: 2px;"></span> Event Handler
                                        </span>
                                        <span style="display: flex; align-items: center; gap: 6px; font-size: 0.75rem;">
                                            <span style="width: 12px; height: 3px; background: var(--purple); border-radius: 2px;"></span> Screen Transition
                                        </span>
                                        <span style="display: flex; align-items: center; gap: 6px; font-size: 0.75rem;">
                                            <span style="width: 12px; height: 3px; background: var(--danger); border-radius: 2px;"></span> Broken/Missing
                                        </span>
                                    </div>
                                </div>
                                <div id="dependencyMapContent" style="padding: 20px; overflow-x: auto;">
                                    <div style="text-align: center; color: var(--text-muted); padding: 40px;">
                                        Run the crawler to generate dependency map...
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Logic Flow Analysis -->
                    <div class="card" style="margin-bottom: 20px;">
                        <div class="card-header" style="cursor: pointer;" onclick="toggleLogicFlow()">
                            <h3 class="card-title"> Logic Flow Analysis</h3>
                            <svg id="logicFlowToggle" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="transition: transform 0.3s;">
                                <polyline points="6 9 12 15 18 9"/>
                            </svg>
                        </div>
                        <div id="logicFlowBody" style="display: none;">
                            <div class="card-body">
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 16px;" id="logicFlowContent">
                                    <div style="text-align: center; color: var(--text-muted); padding: 40px; grid-column: 1/-1;">
                                        Run the crawler to analyze logic flows...
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Screen Transition Matrix -->
                    <div class="card" style="margin-bottom: 20px;">
                        <div class="card-header" style="cursor: pointer;" onclick="toggleTransitionMatrix()">
                            <h3 class="card-title"> Screen Transition Matrix</h3>
                            <svg id="transitionMatrixToggle" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="transition: transform 0.3s;">
                                <polyline points="6 9 12 15 18 9"/>
                            </svg>
                        </div>
                        <div id="transitionMatrixBody" style="display: none;">
                            <div class="card-body" style="overflow-x: auto;">
                                <div id="transitionMatrixContent" style="min-width: 600px;">
                                    <div style="text-align: center; color: var(--text-muted); padding: 40px;">
                                        Run the crawler to generate screen transition matrix...
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Test Results Log -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"> Crawler Log</h3>
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <select id="logFilterSelect" onchange="filterDiagnosticsLog(this.value)" style="padding: 4px 8px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary); font-size: 0.75rem;">
                                    <option value="all">All Messages</option>
                                    <option value="error">Errors Only</option>
                                    <option value="warn">Warnings Only</option>
                                    <option value="info">Info Only</option>
                                </select>
                                <button class="btn btn-secondary" onclick="clearDiagnosticsLog()" style="font-size: 0.7rem; padding: 4px 8px;">Clear</button>
                                <button class="btn btn-secondary" onclick="exportDiagnosticsLog()" style="font-size: 0.7rem; padding: 4px 8px;">Export</button>
                                <span id="diagnosticsStatus" class="status-badge" style="font-size: 0.75rem;">Idle</span>
                            </div>
                        </div>
                        <div class="card-body">
                            <div id="diagnosticsLog" class="code-block" style="max-height: 400px; overflow-y: auto; font-size: 0.75rem;">
                                <pre>// Configure options above and click "Run Crawler" to start diagnostics...</pre>
                            </div>
                        </div>
                    </div>

                    <!-- Crawler Log History Panel -->
                    <div class="card" style="margin-top: 20px; border: 1px solid var(--info);">
                        <div class="card-header" style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(59, 130, 246, 0.02)); cursor: pointer;" onclick="toggleCrawlerHistory()">
                            <h3 class="card-title"> Crawler Log History</h3>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span class="status-badge" style="background: var(--info);" id="crawlerHistoryCount">-- logs</span>
                                <svg id="crawlerHistoryToggle" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="transition: transform 0.3s;">
                                    <polyline points="6 9 12 15 18 9"/>
                                </svg>
                            </div>
                        </div>
                        <div class="card-body" id="crawlerHistoryBody" style="display: none; max-height: 400px; overflow-y: auto;">
                            <div id="crawlerLogHistory">
                                <div style="text-align: center; padding: 20px; color: var(--text-muted);">Loading log history...</div>
                            </div>
                        </div>
                    </div>

                    <!-- Issues Found Panel -->
                    <div class="card" id="issuesFoundPanel" style="margin-top: 20px; border: 2px solid var(--danger); display: none;">
                        <div class="card-header" style="background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(239, 68, 68, 0.05));">
                            <h3 class="card-title"> Issues Found</h3>
                            <span class="status-badge danger" id="issuesCount">0 Issues</span>
                        </div>
                        <div class="card-body">
                            <div id="issuesList" style="display: flex; flex-direction: column; gap: 12px;">
                                <div style="text-align: center; color: var(--text-muted); padding: 20px;">
                                    No issues detected yet. Run the crawler to scan for problems.
                                </div>
                            </div>
                        </div>
                    </div>
            </div>

            <!-- Site Diagnostics Section -->
            <div id="site-diagnostics-section" style="display: none;">
                <div class="page-header">
                    <div>
                        <h2 class="page-title"> Site Diagnostics (Admin)</h2>
                        <p class="page-subtitle">Analyze admin dashboard functionality, connections, and configuration</p>
                    </div>
                    <div class="header-actions" style="display: flex; gap: 8px;">
                        <button class="btn btn-secondary" id="stopSiteAnalysisBtn" onclick="stopSiteAnalysis()" style="display: none;">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="6" y="6" width="12" height="12"/>
                            </svg>
                            Stop
                        </button>
                        <button class="btn btn-secondary" onclick="exportSiteDiagnosticsReport()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
                                <polyline points="7 10 12 15 17 10"/>
                                <line x1="12" y1="15" x2="12" y2="3"/>
                            </svg>
                            Export Report
                        </button>
                        <button class="btn btn-primary" id="runSiteAnalysisBtn" onclick="runSiteDiagnostics()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polygon points="5 3 19 12 5 21 5 3"/>
                            </svg>
                            Run Analysis
                        </button>
                    </div>
                </div>

                <!-- Quick Stats -->
                <div class="stats-grid" style="margin-bottom: 20px; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));">
                    <div class="stat-card">
                        <div class="stat-icon" style="background: rgba(16, 185, 129, 0.2); color: var(--success);"></div>
                        <div class="stat-value" id="siteFunctionalCount">--</div>
                        <div class="stat-label">Functional</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: rgba(239, 68, 68, 0.2); color: var(--danger);"></div>
                        <div class="stat-value" id="siteBrokenCount">--</div>
                        <div class="stat-label">Broken</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: rgba(245, 158, 11, 0.2); color: var(--warning);"></div>
                        <div class="stat-value" id="siteHardcodedCount">--</div>
                        <div class="stat-label">Hardcoded</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: rgba(59, 130, 246, 0.2); color: var(--info);"></div>
                        <div class="stat-value" id="siteConnectionsCount">--</div>
                        <div class="stat-label">Connections</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: rgba(239, 68, 68, 0.2); color: var(--danger);"></div>
                        <div class="stat-value" id="siteConsoleErrors">0</div>
                        <div class="stat-label">Console Errors</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: rgba(168, 85, 247, 0.2); color: var(--purple);"></div>
                        <div class="stat-value" id="siteSectionsCount">--</div>
                        <div class="stat-label">Sections OK</div>
                    </div>
                </div>

                <!-- Section Health Monitor -->
                <div class="card" style="margin-bottom: 20px; border: 2px solid var(--success);">
                    <div class="card-header" style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(16, 185, 129, 0.05));">
                        <h3 class="card-title"> Section Health Monitor</h3>
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <span id="healthOverallStatus" class="status-badge" style="font-size: 0.75rem;">Checking...</span>
                            <button class="btn btn-secondary" onclick="runAllHealthChecks()" style="font-size: 0.75rem; padding: 4px 10px;">
                                 Refresh All
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <p style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 16px;">
                            Real-time health monitoring for all admin sections. Tracks API response times, data freshness, and errors.
                        </p>
                        
                        <!-- Health Summary Stats -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px; margin-bottom: 20px;">
                            <div style="padding: 12px; background: rgba(16, 185, 129, 0.1); border-radius: 10px; text-align: center; border: 1px solid rgba(16, 185, 129, 0.3);">
                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--success);" id="healthGreenCount">0</div>
                                <div style="font-size: 0.7rem; color: var(--text-muted);">Healthy</div>
                            </div>
                            <div style="padding: 12px; background: rgba(245, 158, 11, 0.1); border-radius: 10px; text-align: center; border: 1px solid rgba(245, 158, 11, 0.3);">
                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--warning);" id="healthYellowCount">0</div>
                                <div style="font-size: 0.7rem; color: var(--text-muted);">Warning</div>
                            </div>
                            <div style="padding: 12px; background: rgba(239, 68, 68, 0.1); border-radius: 10px; text-align: center; border: 1px solid rgba(239, 68, 68, 0.3);">
                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--danger);" id="healthRedCount">0</div>
                                <div style="font-size: 0.7rem; color: var(--text-muted);">Issues</div>
                            </div>
                            <div style="padding: 12px; background: rgba(107, 114, 128, 0.1); border-radius: 10px; text-align: center; border: 1px solid rgba(107, 114, 128, 0.3);">
                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--text-muted);" id="healthGrayCount">0</div>
                                <div style="font-size: 0.7rem; color: var(--text-muted);">Not Loaded</div>
                            </div>
                        </div>
                        
                        <!-- Section Health Grid -->
                        <div style="margin-bottom: 16px;">
                            <div style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 10px;">SECTION STATUS</div>
                            <div id="healthSectionGrid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                                <!-- Will be populated by JS -->
                            </div>
                        </div>
                        
                        <!-- Health Issues List -->
                        <div>
                            <div style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 8px;">DETECTED ISSUES</div>
                            <div id="healthIssuesList" style="max-height: 200px; overflow-y: auto; background: var(--bg-tertiary); border-radius: 8px; padding: 12px;">
                                <div style="color: var(--text-muted); font-size: 0.8rem;">No issues detected</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- BroadcastChannel Connection Monitor -->
                <div class="card" style="margin-bottom: 20px; border: 2px solid var(--info);">
                    <div class="card-header" style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(59, 130, 246, 0.05));">
                        <h3 class="card-title"> BroadcastChannel Connection Monitor</h3>
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <span id="bcConnectionStatus" class="status-badge" style="font-size: 0.75rem;">Checking...</span>
                            <button class="btn btn-secondary" onclick="testBroadcastConnection()" style="font-size: 0.75rem; padding: 4px 10px;">
                                 Test Connection
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <p style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 16px;">
                            Real-time communication between Admin (manager.html) and User App (index.html) via BroadcastChannel API.
                        </p>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 20px;">
                            <!-- Connection Stats -->
                            <div style="padding: 16px; background: var(--bg-tertiary); border-radius: 12px; text-align: center;">
                                <div style="font-size: 2rem; font-weight: 700;" id="bcMessagesSent">0</div>
                                <div style="font-size: 0.75rem; color: var(--text-muted);">Messages Sent</div>
                            </div>
                            <div style="padding: 16px; background: var(--bg-tertiary); border-radius: 12px; text-align: center;">
                                <div style="font-size: 2rem; font-weight: 700;" id="bcMessagesReceived">0</div>
                                <div style="font-size: 0.75rem; color: var(--text-muted);">Messages Received</div>
                            </div>
                            <div style="padding: 16px; background: var(--bg-tertiary); border-radius: 12px; text-align: center;">
                                <div style="font-size: 2rem; font-weight: 700;" id="bcLastPingMs">--</div>
                                <div style="font-size: 0.75rem; color: var(--text-muted);">Last Ping (ms)</div>
                            </div>
                            <div style="padding: 16px; background: var(--bg-tertiary); border-radius: 12px; text-align: center;">
                                <div style="font-size: 0.9rem; font-weight: 600;" id="bcAppStatus">Unknown</div>
                                <div style="font-size: 0.75rem; color: var(--text-muted);">App Status</div>
                            </div>
                        </div>

                        <!-- Supported Message Types -->
                        <div style="margin-bottom: 16px;">
                            <div style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 8px;">SUPPORTED MESSAGE TYPES</div>
                            <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                                <span style="padding: 4px 10px; background: rgba(34, 197, 94, 0.2); color: var(--success); border-radius: 6px; font-size: 0.75rem;"> ping/pong</span>
                                <span style="padding: 4px 10px; background: rgba(59, 130, 246, 0.2); color: var(--info); border-radius: 6px; font-size: 0.75rem;"> run_diagnostics</span>
                                <span style="padding: 4px 10px; background: rgba(168, 85, 247, 0.2); color: var(--purple); border-radius: 6px; font-size: 0.75rem;"> nav_to_screen</span>
                                <span style="padding: 4px 10px; background: rgba(245, 158, 11, 0.2); color: var(--warning); border-radius: 6px; font-size: 0.75rem;"> settings_update</span>
                                <span style="padding: 4px 10px; background: rgba(236, 72, 153, 0.2); color: #f472b6; border-radius: 6px; font-size: 0.75rem;"> user_updated</span>
                                <span style="padding: 4px 10px; background: rgba(20, 184, 166, 0.2); color: #2dd4bf; border-radius: 6px; font-size: 0.75rem;"> screen_result</span>
                                <span style="padding: 4px 10px; background: rgba(239, 68, 68, 0.2); color: var(--danger); border-radius: 6px; font-size: 0.75rem;"> user_deleted</span>
                            </div>
                        </div>

                        <!-- Message Log -->
                        <div style="margin-bottom: 16px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <div style="font-size: 0.8rem; color: var(--text-muted);">LIVE MESSAGE LOG</div>
                                <button class="btn btn-secondary" onclick="clearBroadcastLog()" style="font-size: 0.7rem; padding: 2px 8px;">Clear</button>
                            </div>
                            <div id="bcMessageLog" style="max-height: 200px; overflow-y: auto; background: var(--bg-tertiary); border-radius: 8px; padding: 12px; font-family: monospace; font-size: 0.75rem;">
                                <div style="color: var(--text-muted);">// Waiting for messages...</div>
                            </div>
                        </div>

                        <!-- Quick Actions -->
                        <div>
                            <div style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 8px;">QUICK ACTIONS</div>
                            <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                                <button class="btn btn-secondary" onclick="sendBroadcastMessage('ping')" style="font-size: 0.8rem;"> Send Ping</button>
                                <button class="btn btn-secondary" onclick="sendBroadcastMessage('request_data')" style="font-size: 0.8rem;"> Request Data</button>
                                <button class="btn btn-secondary" onclick="sendBroadcastMessage('nav_to_screen', {screen: 'match'})" style="font-size: 0.8rem;"> Nav to Match</button>
                                <button class="btn btn-secondary" onclick="sendBroadcastMessage('nav_to_screen', {screen: 'settings'})" style="font-size: 0.8rem;"> Nav to Settings</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Site Diagnostics Control Panel -->
                <div class="card" style="margin-bottom: 20px; border: 2px solid var(--purple);">
                    <div class="card-header" style="background: linear-gradient(135deg, rgba(168, 85, 247, 0.1), rgba(168, 85, 247, 0.05));">
                        <h3 class="card-title"> Diagnostics Control Panel</h3>
                        <span id="siteCrawlerStatusBadge" class="status-badge" style="font-size: 0.75rem;">Idle</span>
                    </div>
                    <div class="card-body">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px;">
                            <!-- Inspection Options -->
                            <div style="padding: 16px; background: var(--bg-tertiary); border-radius: 12px; border: 1px solid var(--border);">
                                <div style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 12px;">INSPECTION OPTIONS</div>
                                <div style="display: flex; flex-direction: column; gap: 10px;">
                                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                        <input type="checkbox" id="siteCheckButtons" checked style="width: 18px; height: 18px; accent-color: var(--accent);">
                                        <span style="font-size: 0.9rem;">Button Handlers</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                        <input type="checkbox" id="siteCheckSections" checked style="width: 18px; height: 18px; accent-color: var(--accent);">
                                        <span style="font-size: 0.9rem;">Navigation Sections</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                        <input type="checkbox" id="siteCheckStorage" checked style="width: 18px; height: 18px; accent-color: var(--accent);">
                                        <span style="font-size: 0.9rem;">Storage Analysis</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                        <input type="checkbox" id="siteCheckConnections" checked style="width: 18px; height: 18px; accent-color: var(--accent);">
                                        <span style="font-size: 0.9rem;">Connection Health</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                        <input type="checkbox" id="siteCheckPerformance" checked style="width: 18px; height: 18px; accent-color: var(--accent);">
                                        <span style="font-size: 0.9rem;">Performance Metrics</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                        <input type="checkbox" id="siteCheckConsole" checked style="width: 18px; height: 18px; accent-color: var(--accent);">
                                        <span style="font-size: 0.9rem;">Console Errors</span>
                                    </label>
                                </div>
                            </div>

                            <!-- Analysis Target -->
                            <div style="padding: 16px; background: var(--bg-tertiary); border-radius: 12px; border: 1px solid var(--border);">
                                <div style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 12px;">ANALYSIS TARGET</div>
                                <div style="display: flex; flex-direction: column; gap: 12px;">
                                    <div>
                                        <label style="font-size: 0.8rem; color: var(--text-muted); display: block; margin-bottom: 4px;">Scope</label>
                                        <select id="siteScopeFilter" style="width: 100%; padding: 8px 12px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary);">
                                            <option value="all">Full Admin Dashboard</option>
                                            <option value="current">Current Section Only</option>
                                            <option value="analytics">Analytics Sections</option>
                                            <option value="users">User Management</option>
                                            <option value="settings">Settings & Config</option>
                                        </select>
                                    </div>
                                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                        <input type="checkbox" id="siteAutoExpand" style="width: 18px; height: 18px; accent-color: var(--accent);">
                                        <span style="font-size: 0.9rem;">Auto-expand sections with issues</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                        <input type="checkbox" id="siteAutoRun" style="width: 18px; height: 18px; accent-color: var(--accent);">
                                        <span style="font-size: 0.9rem;">Auto-run every 5 minutes</span>
                                    </label>
                                </div>
                            </div>

                            <!-- Live Stats -->
                            <div style="padding: 16px; background: var(--bg-tertiary); border-radius: 12px; border: 1px solid var(--border);">
                                <div style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 12px;">LIVE ANALYSIS STATS</div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                    <div style="padding: 12px; background: var(--bg-secondary); border-radius: 8px; text-align: center;">
                                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--success);" id="siteCrawlerPassed">0</div>
                                        <div style="font-size: 0.7rem; color: var(--text-muted);">Passed</div>
                                    </div>
                                    <div style="padding: 12px; background: var(--bg-secondary); border-radius: 8px; text-align: center;">
                                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--danger);" id="siteCrawlerFailed">0</div>
                                        <div style="font-size: 0.7rem; color: var(--text-muted);">Failed</div>
                                    </div>
                                    <div style="padding: 12px; background: var(--bg-secondary); border-radius: 8px; text-align: center;">
                                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--warning);" id="siteCrawlerWarnings">0</div>
                                        <div style="font-size: 0.7rem; color: var(--text-muted);">Warnings</div>
                                    </div>
                                    <div style="padding: 12px; background: var(--bg-secondary); border-radius: 8px; text-align: center;">
                                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--info);" id="siteCrawlerProgress">0%</div>
                                        <div style="font-size: 0.7rem; color: var(--text-muted);">Progress</div>
                                    </div>
                                </div>
                                <div style="margin-top: 12px;">
                                    <div style="background: var(--bg-secondary); border-radius: 8px; height: 8px; overflow: hidden;">
                                        <div id="siteCrawlerProgressBar" style="background: linear-gradient(90deg, var(--success), var(--info)); height: 100%; width: 0%; transition: width 0.3s ease;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Security Vulnerability Scanner -->
                <div class="card" style="margin-bottom: 20px; border: 2px solid var(--danger);">
                    <div class="card-header" style="background: linear-gradient(135deg, rgba(239, 68, 68, 0.15), rgba(239, 68, 68, 0.05)); cursor: pointer;" onclick="toggleSiteSection('securityScanner')">
                        <h3 class="card-title"> Security Vulnerability Scanner</h3>
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <span id="securityScanStatus" class="status-badge" style="font-size: 0.75rem;">Not Scanned</span>
                            <svg id="securityScannerToggle" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="transition: transform 0.3s;">
                                <polyline points="6 9 12 15 18 9"/>
                            </svg>
                        </div>
                    </div>
                    <div id="securityScannerBody" style="display: none;">
                        <div class="card-body">
                            <p style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 16px;">
                                Comprehensive security analysis to detect XSS vulnerabilities, insecure configurations, exposed credentials, and other security issues.
                            </p>

                            <!-- Security Scan Options -->
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; margin-bottom: 20px;">
                                <div style="padding: 16px; background: var(--bg-tertiary); border-radius: 12px; border: 1px solid var(--border);">
                                    <div style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 12px;">SCAN OPTIONS</div>
                                    <div style="display: flex; flex-direction: column; gap: 10px;">
                                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                            <input type="checkbox" id="secCheckXSS" checked style="width: 18px; height: 18px; accent-color: var(--danger);">
                                            <span style="font-size: 0.9rem;">XSS Vulnerabilities</span>
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                            <input type="checkbox" id="secCheckCSRF" checked style="width: 18px; height: 18px; accent-color: var(--danger);">
                                            <span style="font-size: 0.9rem;">CSRF Protection</span>
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                            <input type="checkbox" id="secCheckCredentials" checked style="width: 18px; height: 18px; accent-color: var(--danger);">
                                            <span style="font-size: 0.9rem;">Exposed Credentials</span>
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                            <input type="checkbox" id="secCheckInsecure" checked style="width: 18px; height: 18px; accent-color: var(--danger);">
                                            <span style="font-size: 0.9rem;">Insecure Configurations</span>
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                            <input type="checkbox" id="secCheckDependencies" checked style="width: 18px; height: 18px; accent-color: var(--danger);">
                                            <span style="font-size: 0.9rem;">Dependency Vulnerabilities</span>
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                            <input type="checkbox" id="secCheckHeaders" checked style="width: 18px; height: 18px; accent-color: var(--danger);">
                                            <span style="font-size: 0.9rem;">Security Headers</span>
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                            <input type="checkbox" id="secCheckStorage" checked style="width: 18px; height: 18px; accent-color: var(--danger);">
                                            <span style="font-size: 0.9rem;">Sensitive Data in Storage</span>
                                        </label>
                                    </div>
                                </div>

                                <div style="padding: 16px; background: var(--bg-tertiary); border-radius: 12px; border: 1px solid var(--border);">
                                    <div style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 12px;">SCAN SUMMARY</div>
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                        <div style="padding: 12px; background: var(--bg-secondary); border-radius: 8px; text-align: center;">
                                            <div style="font-size: 1.5rem; font-weight: 700; color: var(--danger);" id="secCriticalCount">0</div>
                                            <div style="font-size: 0.7rem; color: var(--text-muted);">Critical</div>
                                        </div>
                                        <div style="padding: 12px; background: var(--bg-secondary); border-radius: 8px; text-align: center;">
                                            <div style="font-size: 1.5rem; font-weight: 700; color: var(--warning);" id="secHighCount">0</div>
                                            <div style="font-size: 0.7rem; color: var(--text-muted);">High</div>
                                        </div>
                                        <div style="padding: 12px; background: var(--bg-secondary); border-radius: 8px; text-align: center;">
                                            <div style="font-size: 1.5rem; font-weight: 700; color: #FBBF24;" id="secMediumCount">0</div>
                                            <div style="font-size: 0.7rem; color: var(--text-muted);">Medium</div>
                                        </div>
                                        <div style="padding: 12px; background: var(--bg-secondary); border-radius: 8px; text-align: center;">
                                            <div style="font-size: 1.5rem; font-weight: 700; color: var(--info);" id="secLowCount">0</div>
                                            <div style="font-size: 0.7rem; color: var(--text-muted);">Low</div>
                                        </div>
                                    </div>
                                    <div style="margin-top: 12px;">
                                        <button class="btn btn-primary" onclick="runSecurityScan()" id="runSecurityScanBtn" style="width: 100%;">
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                                            </svg>
                                            Run Security Scan
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Security Score -->
                            <div style="padding: 20px; background: linear-gradient(135deg, var(--bg-tertiary), var(--bg-secondary)); border-radius: 16px; margin-bottom: 20px; border: 1px solid var(--border);">
                                <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 16px;">
                                    <div>
                                        <div style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 4px;">SECURITY SCORE</div>
                                        <div style="display: flex; align-items: baseline; gap: 8px;">
                                            <span style="font-size: 3rem; font-weight: 700;" id="securityScore">--</span>
                                            <span style="font-size: 1.2rem; color: var(--text-muted);">/ 100</span>
                                        </div>
                                        <div style="font-size: 0.85rem; color: var(--text-muted);" id="securityGrade">Run scan to calculate</div>
                                    </div>
                                    <div style="width: 120px; height: 120px; position: relative;">
                                        <svg viewBox="0 0 36 36" style="width: 100%; height: 100%; transform: rotate(-90deg);">
                                            <path d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="var(--bg-secondary)" stroke-width="3"/>
                                            <path id="securityScoreArc" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="var(--text-muted)" stroke-width="3" stroke-dasharray="0, 100"/>
                                        </svg>
                                        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 24px;"></div>
                                    </div>
                                </div>
                            </div>

                            <!-- Vulnerability List -->
                            <div style="margin-bottom: 16px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                    <div style="font-size: 0.8rem; color: var(--text-muted);">DETECTED VULNERABILITIES</div>
                                    <button class="btn btn-secondary" onclick="exportSecurityReport()" style="font-size: 0.75rem; padding: 6px 12px;">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
                                            <polyline points="7 10 12 15 17 10"/>
                                            <line x1="12" y1="15" x2="12" y2="3"/>
                                        </svg>
                                        Export Report
                                    </button>
                                </div>
                                <div id="securityVulnList" style="display: flex; flex-direction: column; gap: 10px; max-height: 400px; overflow-y: auto;">
                                    <div style="text-align: center; color: var(--text-muted); padding: 40px; background: var(--bg-tertiary); border-radius: 12px;">
                                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="opacity: 0.5; margin-bottom: 12px;">
                                            <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                                        </svg>
                                        <div style="font-size: 0.9rem;">Run a security scan to detect vulnerabilities</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Security Recommendations -->
                            <div style="padding: 16px; background: var(--bg-tertiary); border-radius: 12px; border-left: 4px solid var(--info);">
                                <div style="font-size: 0.8rem; color: var(--info); font-weight: 600; margin-bottom: 8px;"> SECURITY BEST PRACTICES</div>
                                <ul style="font-size: 0.85rem; color: var(--text-secondary); margin: 0; padding-left: 20px; display: flex; flex-direction: column; gap: 6px;">
                                    <li>Use Content Security Policy (CSP) headers to prevent XSS attacks</li>
                                    <li>Implement proper input validation and output encoding</li>
                                    <li>Never store sensitive data in localStorage without encryption</li>
                                    <li>Keep all dependencies updated to latest secure versions</li>
                                    <li>Use HTTPS and secure cookies for all sensitive operations</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Admin Architecture Map -->
                <div class="card" style="margin-bottom: 20px;">
                    <div class="card-header" style="cursor: pointer;" onclick="toggleSiteSection('adminArchitecture')">
                        <h3 class="card-title"> Admin Architecture Map</h3>
                        <svg id="adminArchitectureToggle" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="transition: transform 0.3s;">
                            <polyline points="6 9 12 15 18 9"/>
                        </svg>
                    </div>
                    <div id="adminArchitectureBody" style="display: none;">
                        <div class="card-body">
                            <p style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 16px;">
                                Visual representation of how admin pages, data storage, and index.html are connected.
                            </p>
                            <div id="adminArchitectureMap" style="min-height: 300px; background: var(--bg-tertiary); border-radius: 12px; padding: 20px; overflow-x: auto;">
                                <!-- Generated by JS -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Button Functionality Analysis -->
                <div class="card" style="margin-bottom: 20px;">
                    <div class="card-header" style="cursor: pointer;" onclick="toggleSiteSection('buttonAnalysis')">
                        <h3 class="card-title"> Button Functionality Analysis</h3>
                        <svg id="buttonAnalysisToggle" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="transition: transform 0.3s;">
                            <polyline points="6 9 12 15 18 9"/>
                        </svg>
                    </div>
                    <div id="buttonAnalysisBody" style="display: none;">
                        <div class="card-body">
                            <div style="display: flex; gap: 16px; flex-wrap: wrap; margin-bottom: 16px;">
                                <span style="display: flex; align-items: center; gap: 6px; font-size: 0.8rem;">
                                    <span style="width: 12px; height: 12px; background: var(--success); border-radius: 50%;"></span> Functional
                                </span>
                                <span style="display: flex; align-items: center; gap: 6px; font-size: 0.8rem;">
                                    <span style="width: 12px; height: 12px; background: var(--danger); border-radius: 50%;"></span> Broken/Missing Handler
                                </span>
                                <span style="display: flex; align-items: center; gap: 6px; font-size: 0.8rem;">
                                    <span style="width: 12px; height: 12px; background: var(--warning); border-radius: 50%;"></span> No-op/Placeholder
                                </span>
                            </div>
                            <div id="buttonAnalysisList" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 12px;">
                                <div style="text-align: center; color: var(--text-muted); padding: 40px; grid-column: 1/-1;">
                                    Click "Run Analysis" to scan all buttons...
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Hardcoded Values Detection -->
                <div class="card" style="margin-bottom: 20px;">
                    <div class="card-header" style="cursor: pointer;" onclick="toggleSiteSection('hardcodedAnalysis')">
                        <h3 class="card-title"> Hardcoded Values Detection</h3>
                        <svg id="hardcodedAnalysisToggle" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="transition: transform 0.3s;">
                            <polyline points="6 9 12 15 18 9"/>
                        </svg>
                    </div>
                    <div id="hardcodedAnalysisBody" style="display: none;">
                        <div class="card-body">
                            <p style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 16px;">
                                Identifies values that should be dynamic but are currently hardcoded in the admin dashboard.
                            </p>
                            <div id="hardcodedAnalysisList" style="display: flex; flex-direction: column; gap: 12px;">
                                <div style="text-align: center; color: var(--text-muted); padding: 40px;">
                                    Click "Run Analysis" to detect hardcoded values...
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- AWS & Panel Health Monitor -->
                <div class="card" style="margin-bottom: 20px; border: 2px solid var(--danger);">
                    <div class="card-header" style="background: linear-gradient(135deg, rgba(239, 68, 68, 0.15), rgba(239, 68, 68, 0.05));">
                        <h3 class="card-title"> AWS & Panel Health Monitor</h3>
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <button class="btn btn-secondary" onclick="runHealthMonitorCheck()" style="font-size: 0.7rem; padding: 4px 10px;">
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M23 4v6h-6M1 20v-6h6"/>
                                    <path d="M20.49 9A9 9 0 005.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 013.51 15"/>
                                </svg>
                                Check Now
                            </button>
                            <span class="status-badge" id="awsHealthStatus" style="background: var(--text-muted);">Not Checked</span>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Health Summary Stats -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; margin-bottom: 20px;">
                            <div style="padding: 16px; background: var(--bg-tertiary); border-radius: 10px; text-align: center; border: 1px solid var(--border);">
                                <div style="font-size: 2rem; font-weight: 700; color: var(--success);" id="healthAwsOk">--</div>
                                <div style="font-size: 0.75rem; color: var(--text-muted);">AWS OK</div>
                            </div>
                            <div style="padding: 16px; background: var(--bg-tertiary); border-radius: 10px; text-align: center; border: 1px solid var(--border);">
                                <div style="font-size: 2rem; font-weight: 700; color: var(--danger);" id="healthAwsErrors">--</div>
                                <div style="font-size: 0.75rem; color: var(--text-muted);">AWS Errors</div>
                            </div>
                            <div style="padding: 16px; background: var(--bg-tertiary); border-radius: 10px; text-align: center; border: 1px solid var(--border);">
                                <div style="font-size: 2rem; font-weight: 700; color: var(--success);" id="healthPanelsOk">--</div>
                                <div style="font-size: 0.75rem; color: var(--text-muted);">Panels OK</div>
                            </div>
                            <div style="padding: 16px; background: var(--bg-tertiary); border-radius: 10px; text-align: center; border: 1px solid var(--border);">
                                <div style="font-size: 2rem; font-weight: 700; color: var(--danger);" id="healthPanelErrors">--</div>
                                <div style="font-size: 0.75rem; color: var(--text-muted);">Data Errors</div>
                            </div>
                            <div style="padding: 16px; background: var(--bg-tertiary); border-radius: 10px; text-align: center; border: 1px solid var(--border);">
                                <div style="font-size: 2rem; font-weight: 700; color: var(--warning);" id="healthStaleData">--</div>
                                <div style="font-size: 0.75rem; color: var(--text-muted);">Stale Data</div>
                            </div>
                        </div>
                        
                        <!-- AWS Endpoints Grid -->
                        <div style="margin-bottom: 20px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                <h4 style="font-size: 0.9rem; font-weight: 600; color: var(--text-primary);"> AWS API Endpoints</h4>
                                <span style="font-size: 0.7rem; color: var(--text-muted);" id="awsLastChecked">Last checked: --</span>
                            </div>
                            <div id="awsEndpointsGrid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 10px;">
                                <div style="padding: 20px; text-align: center; color: var(--text-muted); background: var(--bg-tertiary); border-radius: 8px;">
                                    Click "Check Now" to test AWS endpoints...
                                </div>
                            </div>
                        </div>
                        
                        <!-- Panel Data Health Grid -->
                        <div style="margin-bottom: 20px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                <h4 style="font-size: 0.9rem; font-weight: 600; color: var(--text-primary);"> Panel Data Health (by Section)</h4>
                            </div>
                            <div id="panelHealthGrid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 10px;">
                                <div style="padding: 20px; text-align: center; color: var(--text-muted); background: var(--bg-tertiary); border-radius: 8px;">
                                    Click "Check Now" to validate panel data...
                                </div>
                            </div>
                        </div>
                        
                        <!-- Critical Errors List -->
                        <div id="criticalErrorsSection" style="display: none;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                <h4 style="font-size: 0.9rem; font-weight: 600; color: var(--danger);"> Critical Errors Requiring Attention</h4>
                            </div>
                            <div id="criticalErrorsList" style="display: flex; flex-direction: column; gap: 8px; max-height: 200px; overflow-y: auto;">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Connection Health -->
                <div class="card" style="margin-bottom: 20px;">
                    <div class="card-header" style="cursor: pointer;" onclick="toggleSiteSection('connectionHealth')">
                        <h3 class="card-title"> Connection Health</h3>
                        <svg id="connectionHealthToggle" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="transition: transform 0.3s;">
                            <polyline points="6 9 12 15 18 9"/>
                        </svg>
                    </div>
                    <div id="connectionHealthBody" style="display: none;">
                        <div class="card-body">
                            <p style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 16px;">
                                Checks connections between admin sections, localStorage, and the user app (index.html).
                            </p>
                            <div id="connectionHealthList" style="display: flex; flex-direction: column; gap: 12px;">
                                <div style="text-align: center; color: var(--text-muted); padding: 40px;">
                                    Click "Run Analysis" to check connections...
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Index Configuration Panel -->
                <div class="card" style="margin-bottom: 20px; border: 2px solid var(--info);">
                    <div class="card-header" style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(59, 130, 246, 0.05));">
                        <h3 class="card-title"> Index App Configuration</h3>
                        <span class="status-badge" id="indexConnectionStatus" style="background: var(--success); color: white;">CONNECTED</span>
                    </div>
                    <div class="card-body">
                        <p style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 16px;">
                            Configure settings that sync to the user app (index.html) in real-time via BroadcastChannel.
                        </p>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                            <!-- App Settings -->
                            <div style="padding: 16px; background: var(--bg-tertiary); border-radius: 12px;">
                                <h4 style="margin: 0 0 12px 0; font-size: 0.9rem; color: var(--text-primary);"> App Settings</h4>
                                <div style="display: flex; flex-direction: column; gap: 12px;">
                                    <div>
                                        <label style="font-size: 0.8rem; color: var(--text-muted); display: block; margin-bottom: 4px;">App Name</label>
                                        <input type="text" id="configAppName" value="OITH" 
                                               style="width: 100%; padding: 8px 12px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary);"
                                               onchange="updateIndexConfig('appName', this.value)">
                                    </div>
                                    <div>
                                        <label style="font-size: 0.8rem; color: var(--text-muted); display: block; margin-bottom: 4px;">Tagline</label>
                                        <input type="text" id="configTagline" value="This time it's personal" 
                                               style="width: 100%; padding: 8px 12px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary);"
                                               onchange="updateIndexConfig('tagline', this.value)">
                                    </div>
                                    <div>
                                        <label style="font-size: 0.8rem; color: var(--text-muted); display: block; margin-bottom: 4px;">Subscription Price ($)</label>
                                        <input type="number" id="configSubPrice" value="10" min="0" step="0.01"
                                               style="width: 100%; padding: 8px 12px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary);"
                                               onchange="updateIndexConfig('subscriptionPrice', this.value)">
                                    </div>
                                </div>
                            </div>

                            <!-- Feature Flags -->
                            <div style="padding: 16px; background: var(--bg-tertiary); border-radius: 12px;">
                                <h4 style="margin: 0 0 12px 0; font-size: 0.9rem; color: var(--text-primary);"> Feature Flags</h4>
                                <div style="display: flex; flex-direction: column; gap: 10px;">
                                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                        <input type="checkbox" id="configEnableMatching" checked 
                                               style="width: 18px; height: 18px; accent-color: var(--accent);"
                                               onchange="updateIndexConfig('enableMatching', this.checked)">
                                        <span style="font-size: 0.85rem;">Enable Matching</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                        <input type="checkbox" id="configEnableChat" checked 
                                               style="width: 18px; height: 18px; accent-color: var(--accent);"
                                               onchange="updateIndexConfig('enableChat', this.checked)">
                                        <span style="font-size: 0.85rem;">Enable Chat</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                        <input type="checkbox" id="configEnableDatePlanning" checked 
                                               style="width: 18px; height: 18px; accent-color: var(--accent);"
                                               onchange="updateIndexConfig('enableDatePlanning', this.checked)">
                                        <span style="font-size: 0.85rem;">Enable Date Planning</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                        <input type="checkbox" id="configMaintenanceMode" 
                                               style="width: 18px; height: 18px; accent-color: var(--warning);"
                                               onchange="updateIndexConfig('maintenanceMode', this.checked)">
                                        <span style="font-size: 0.85rem;">Maintenance Mode</span>
                                    </label>
                                </div>
                            </div>

                            <!-- Data Sync -->
                            <div style="padding: 16px; background: var(--bg-tertiary); border-radius: 12px;">
                                <h4 style="margin: 0 0 12px 0; font-size: 0.9rem; color: var(--text-primary);"> Data Sync</h4>
                                <div style="display: flex; flex-direction: column; gap: 10px;">
                                    <button class="btn btn-secondary" onclick="pushAllDataToIndex()" style="width: 100%; justify-content: center;">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M12 19V5M5 12l7-7 7 7"/>
                                        </svg>
                                        Push All Data to Index
                                    </button>
                                    <button class="btn btn-secondary" onclick="pullDataFromIndex()" style="width: 100%; justify-content: center;">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M12 5v14M5 12l7 7 7-7"/>
                                        </svg>
                                        Pull Data from Index
                                    </button>
                                    <button class="btn btn-secondary" onclick="resetIndexToDefaults()" style="width: 100%; justify-content: center;">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M3 12a9 9 0 109-9 9.75 9.75 0 00-6.74 2.74L3 8"/>
                                            <path d="M3 3v5h5"/>
                                        </svg>
                                        Reset Index to Defaults
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Last Sync Info -->
                        <div style="margin-top: 16px; padding: 12px; background: var(--bg-secondary); border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                            <div style="font-size: 0.8rem; color: var(--text-muted);">
                                Last sync: <span id="lastSyncTime">Never</span>
                            </div>
                            <button class="btn btn-primary" onclick="syncConfigToIndex()" style="font-size: 0.8rem; padding: 6px 12px;">
                                 Sync Now
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Navigation & Section Health -->
                <div class="card" style="margin-bottom: 20px;">
                    <div class="card-header" style="cursor: pointer;" onclick="toggleSiteSection('sectionHealth')">
                        <h3 class="card-title"> Navigation & Section Health</h3>
                        <svg id="sectionHealthToggle" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="transition: transform 0.3s;">
                            <polyline points="6 9 12 15 18 9"/>
                        </svg>
                    </div>
                    <div id="sectionHealthBody" style="display: none;">
                        <div class="card-body">
                            <p style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 16px;">
                                Status of all navigation sections and their render functions.
                            </p>
                            <div id="sectionHealthList" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 12px;">
                                <div style="text-align: center; color: var(--text-muted); padding: 40px; grid-column: 1/-1;">
                                    Run analysis to check section health...
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Console Error Monitor -->
                <div class="card" style="margin-bottom: 20px; border: 2px solid var(--danger);">
                    <div class="card-header" style="cursor: pointer; background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(239, 68, 68, 0.05));" onclick="toggleSiteSection('consoleErrors')">
                        <h3 class="card-title"> Console Error Monitor</h3>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span id="consoleErrorCount" class="status-badge" style="background: var(--success); color: white;">0 errors</span>
                            <svg id="consoleErrorsToggle" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="transition: transform 0.3s;">
                                <polyline points="6 9 12 15 18 9"/>
                            </svg>
                        </div>
                    </div>
                    <div id="consoleErrorsBody" style="display: none;">
                        <div class="card-body">
                            <p style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 16px;">
                                Captures JavaScript errors logged to the console during this session.
                            </p>
                            <div id="consoleErrorsList" style="display: flex; flex-direction: column; gap: 8px; max-height: 300px; overflow-y: auto;">
                                <div style="text-align: center; color: var(--success); padding: 40px;">
                                     No console errors detected this session
                                </div>
                            </div>
                            <div style="margin-top: 12px; display: flex; gap: 8px;">
                                <button class="btn btn-secondary" onclick="clearConsoleErrors()" style="font-size: 0.75rem; padding: 6px 12px;">Clear Errors</button>
                                <button class="btn btn-secondary" onclick="refreshConsoleErrors()" style="font-size: 0.75rem; padding: 6px 12px;">Refresh</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Performance Metrics -->
                <div class="card" style="margin-bottom: 20px;">
                    <div class="card-header" style="cursor: pointer;" onclick="toggleSiteSection('performanceMetrics')">
                        <h3 class="card-title"> Performance Metrics</h3>
                        <svg id="performanceMetricsToggle" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="transition: transform 0.3s;">
                            <polyline points="6 9 12 15 18 9"/>
                        </svg>
                    </div>
                    <div id="performanceMetricsBody" style="display: none;">
                        <div class="card-body">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 16px;">
                                <div style="padding: 16px; background: var(--bg-tertiary); border-radius: 12px; text-align: center;">
                                    <div style="font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 8px;">Page Load</div>
                                    <div id="perfPageLoad" style="font-size: 1.5rem; font-weight: 700; color: var(--success);">--</div>
                                </div>
                                <div style="padding: 16px; background: var(--bg-tertiary); border-radius: 12px; text-align: center;">
                                    <div style="font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 8px;">DOM Ready</div>
                                    <div id="perfDomReady" style="font-size: 1.5rem; font-weight: 700; color: var(--info);">--</div>
                                </div>
                                <div style="padding: 16px; background: var(--bg-tertiary); border-radius: 12px; text-align: center;">
                                    <div style="font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 8px;">Memory Used</div>
                                    <div id="perfMemory" style="font-size: 1.5rem; font-weight: 700; color: var(--warning);">--</div>
                                </div>
                                <div style="padding: 16px; background: var(--bg-tertiary); border-radius: 12px; text-align: center;">
                                    <div style="font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 8px;">DOM Nodes</div>
                                    <div id="perfDomNodes" style="font-size: 1.5rem; font-weight: 700; color: var(--purple);">--</div>
                                </div>
                                <div style="padding: 16px; background: var(--bg-tertiary); border-radius: 12px; text-align: center;">
                                    <div style="font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 8px;">Event Listeners</div>
                                    <div id="perfEventListeners" style="font-size: 1.5rem; font-weight: 700; color: var(--accent);">--</div>
                                </div>
                                <div style="padding: 16px; background: var(--bg-tertiary); border-radius: 12px; text-align: center;">
                                    <div style="font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 8px;">Storage Used</div>
                                    <div id="perfStorage" style="font-size: 1.5rem; font-weight: 700; color: var(--info);">--</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Storage Analysis -->
                <div class="card" style="margin-bottom: 20px;">
                    <div class="card-header" style="cursor: pointer;" onclick="toggleSiteSection('storageAnalysis')">
                        <h3 class="card-title"> Storage Analysis</h3>
                        <svg id="storageAnalysisToggle" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="transition: transform 0.3s;">
                            <polyline points="6 9 12 15 18 9"/>
                        </svg>
                    </div>
                    <div id="storageAnalysisBody" style="display: none;">
                        <div class="card-body">
                            <p style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 16px;">
                                Breakdown of localStorage usage by key type and size.
                            </p>
                            <div id="storageAnalysisList" style="display: flex; flex-direction: column; gap: 12px;">
                                <div style="text-align: center; color: var(--text-muted); padding: 40px;">
                                    Run analysis to see storage breakdown...
                                </div>
                            </div>
                            <div style="margin-top: 16px; padding: 12px; background: var(--bg-tertiary); border-radius: 8px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                    <span style="font-size: 0.8rem; color: var(--text-muted);">Total Storage Used</span>
                                    <span id="totalStorageUsed" style="font-weight: 600;">--</span>
                                </div>
                                <div style="height: 8px; background: var(--bg-secondary); border-radius: 4px; overflow: hidden;">
                                    <div id="storageProgressBar" style="height: 100%; width: 0%; background: linear-gradient(90deg, var(--success), var(--warning), var(--danger)); transition: width 0.5s;"></div>
                                </div>
                                <div style="display: flex; justify-content: space-between; font-size: 0.7rem; color: var(--text-muted); margin-top: 4px;">
                                    <span>0 KB</span>
                                    <span>5 MB Limit</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Data Transfer & Processing Costs -->
                <div class="card" style="margin-bottom: 20px; border: 2px solid var(--accent);">
                    <div class="card-header" style="cursor: pointer; background: linear-gradient(135deg, rgba(0, 120, 212, 0.15), rgba(0, 120, 212, 0.05));" onclick="toggleSiteSection('dataTransfer')">
                        <h3 class="card-title"> Data Transfer & Processing Costs</h3>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span id="dataTransferTotalCost" class="status-badge" style="background: var(--accent); color: white;">$0.00/mo</span>
                            <svg id="dataTransferToggle" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="transition: transform 0.3s;">
                                <polyline points="6 9 12 15 18 9"/>
                            </svg>
                        </div>
                    </div>
                    <div id="dataTransferBody" style="display: none;">
                        <div class="card-body">
                            <p style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 16px;">
                                Measures data sizes across services and links them to actual expenses. Click "Analyze" to calculate current usage and estimated costs.
                            </p>
                            
                            <!-- Quick Stats -->
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; margin-bottom: 20px;">
                                <div style="padding: 14px; background: var(--bg-tertiary); border-radius: 10px; text-align: center; border-left: 4px solid var(--purple);">
                                    <div style="font-size: 1.3rem; font-weight: 700; color: var(--purple);" id="dtTotalDataSize">0 KB</div>
                                    <div style="font-size: 0.7rem; color: var(--text-muted);">Total Data Size</div>
                                </div>
                                <div style="padding: 14px; background: var(--bg-tertiary); border-radius: 10px; text-align: center; border-left: 4px solid var(--info);">
                                    <div style="font-size: 1.3rem; font-weight: 700; color: var(--info);" id="dtApiCalls">0</div>
                                    <div style="font-size: 0.7rem; color: var(--text-muted);">Est. API Calls/Mo</div>
                                </div>
                                <div style="padding: 14px; background: var(--bg-tertiary); border-radius: 10px; text-align: center; border-left: 4px solid var(--warning);">
                                    <div style="font-size: 1.3rem; font-weight: 700; color: var(--warning);" id="dtTransferCost">$0.00</div>
                                    <div style="font-size: 0.7rem; color: var(--text-muted);">Transfer Cost/Mo</div>
                                </div>
                                <div style="padding: 14px; background: var(--bg-tertiary); border-radius: 10px; text-align: center; border-left: 4px solid var(--success);">
                                    <div style="font-size: 1.3rem; font-weight: 700; color: var(--success);" id="dtProcessingCost">$0.00</div>
                                    <div style="font-size: 0.7rem; color: var(--text-muted);">Processing Cost/Mo</div>
                                </div>
                            </div>
                            
                            <!-- Service Breakdown -->
                            <div style="margin-bottom: 16px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                    <div style="font-size: 0.8rem; color: var(--text-muted); font-weight: 600;">SERVICE BREAKDOWN (Linked to Expenses)</div>
                                    <button class="btn btn-primary" onclick="analyzeDataTransfer()" style="font-size: 0.75rem; padding: 6px 12px;">
                                         Analyze Now
                                    </button>
                                </div>
                                <div id="dataTransferServiceList" style="display: flex; flex-direction: column; gap: 10px;">
                                    <div style="text-align: center; color: var(--text-muted); padding: 30px;">
                                        Click "Analyze Now" to measure data sizes and calculate costs...
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Detailed Breakdown Table -->
                            <div style="margin-bottom: 16px;">
                                <div style="font-size: 0.8rem; color: var(--text-muted); font-weight: 600; margin-bottom: 10px;">DATA SIZE BY CATEGORY</div>
                                <div style="overflow-x: auto;">
                                    <table style="width: 100%; border-collapse: collapse; font-size: 0.8rem;">
                                        <thead>
                                            <tr style="background: var(--bg-tertiary);">
                                                <th style="padding: 10px 12px; text-align: left; border-bottom: 1px solid var(--border);">Data Category</th>
                                                <th style="padding: 10px 12px; text-align: right; border-bottom: 1px solid var(--border);">Size</th>
                                                <th style="padding: 10px 12px; text-align: right; border-bottom: 1px solid var(--border);">Records</th>
                                                <th style="padding: 10px 12px; text-align: left; border-bottom: 1px solid var(--border);">Linked Service</th>
                                                <th style="padding: 10px 12px; text-align: right; border-bottom: 1px solid var(--border);">Est. Cost/Mo</th>
                                            </tr>
                                        </thead>
                                        <tbody id="dataTransferTable">
                                            <tr>
                                                <td colspan="5" style="padding: 30px; text-align: center; color: var(--text-muted);">
                                                    Run analysis to see data breakdown...
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            
                            <!-- Cost Projection -->
                            <div style="padding: 16px; background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(139, 92, 246, 0.05)); border-radius: 10px; border: 1px solid rgba(139, 92, 246, 0.3);">
                                <div style="font-size: 0.8rem; color: var(--text-muted); font-weight: 600; margin-bottom: 12px;"> COST PROJECTION (At Scale)</div>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px;">
                                    <div style="text-align: center;">
                                        <div style="font-size: 0.7rem; color: var(--text-muted);">Current (Pre-Launch)</div>
                                        <div style="font-size: 1.1rem; font-weight: 700; color: var(--success);" id="dtCostCurrent">$0.00/mo</div>
                                    </div>
                                    <div style="text-align: center;">
                                        <div style="font-size: 0.7rem; color: var(--text-muted);">1K Users</div>
                                        <div style="font-size: 1.1rem; font-weight: 700; color: var(--info);" id="dtCost1k">$0.00/mo</div>
                                    </div>
                                    <div style="text-align: center;">
                                        <div style="font-size: 0.7rem; color: var(--text-muted);">10K Users</div>
                                        <div style="font-size: 1.1rem; font-weight: 700; color: var(--warning);" id="dtCost10k">$0.00/mo</div>
                                    </div>
                                    <div style="text-align: center;">
                                        <div style="font-size: 0.7rem; color: var(--text-muted);">100K Users</div>
                                        <div style="font-size: 1.1rem; font-weight: 700; color: var(--danger);" id="dtCost100k">$0.00/mo</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Link to Expenses -->
                            <div style="margin-top: 16px; padding: 12px; background: var(--bg-secondary); border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                                <div style="font-size: 0.8rem; color: var(--text-muted);">
                                     View full expense details for these services
                                </div>
                                <button class="btn btn-secondary" onclick="showSection('expenses')" style="font-size: 0.8rem; padding: 6px 12px;">
                                    Go to Expenses 
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Analysis Log -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title"> Analysis Log</h3>
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <button class="btn btn-secondary" onclick="clearSiteDiagnosticsLog()" style="font-size: 0.7rem; padding: 4px 8px;">Clear</button>
                            <span id="siteDiagnosticsStatus" class="status-badge" style="font-size: 0.75rem;">Idle</span>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="siteDiagnosticsLog" class="code-block" style="max-height: 300px; overflow-y: auto; font-size: 0.75rem;">
                            <pre>// Site Diagnostics initializing...</pre>
                        </div>
                    </div>
                </div>

                <!-- Issues Found Panel -->
                <div class="card" id="siteIssuesFoundPanel" style="margin-top: 20px; border: 2px solid var(--danger); display: none;">
                    <div class="card-header" style="background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(239, 68, 68, 0.05));">
                        <h3 class="card-title"> Issues Found</h3>
                        <span class="status-badge danger" id="siteIssuesCount">0 Issues</span>
                    </div>
                    <div class="card-body">
                        <div id="siteIssuesList" style="display: flex; flex-direction: column; gap: 12px;">
                            <div style="text-align: center; color: var(--text-muted); padding: 20px;">
                                No issues detected yet. Run the analysis to scan for problems.
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="card" style="margin-top: 20px; border: 2px solid var(--success);">
                    <div class="card-header" style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(16, 185, 129, 0.05));">
                        <h3 class="card-title"> Quick Actions</h3>
                    </div>
                    <div class="card-body">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
                            <button class="btn btn-secondary" onclick="clearAllStorage()" style="justify-content: center;">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
                                </svg>
                                Clear All Storage
                            </button>
                            <button class="btn btn-secondary" onclick="reloadAdminData()" style="justify-content: center;">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M23 4v6h-6M1 20v-6h6"/>
                                    <path d="M20.49 9A9 9 0 005.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 013.51 15"/>
                                </svg>
                                Reload Admin Data
                            </button>
                            <button class="btn btn-secondary" onclick="testIndexConnection()" style="justify-content: center;">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M12 2L2 7l10 5 10-5-10-5z"/>
                                    <path d="M2 17l10 5 10-5"/>
                                    <path d="M2 12l10 5 10-5"/>
                                </svg>
                                Test Index Connection
                            </button>
                            <button class="btn btn-secondary" onclick="generateHealthReport()" style="justify-content: center;">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/>
                                    <path d="M14 2v6h6"/>
                                    <path d="M16 13H8M16 17H8M10 9H8"/>
                                </svg>
                                Generate Health Report
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Admin Activity Log Section -->
                <div class="card" style="margin-top: 20px; border: 2px solid var(--info);">
                    <div class="card-header" style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(59, 130, 246, 0.05));">
                        <h3 class="card-title"> Admin Activity Log</h3>
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <select id="activityLogFilter" onchange="filterActivityLog(this.value)" style="padding: 4px 8px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary); font-size: 0.75rem;">
                                <option value="all">All Activities</option>
                                <option value="user">User Actions</option>
                                <option value="file">File Operations</option>
                                <option value="event">Calendar Events</option>
                                <option value="config">Configuration</option>
                                <option value="sync">AWS Sync</option>
                            </select>
                            <button class="btn btn-secondary" onclick="refreshActivityLog()" style="font-size: 0.7rem; padding: 4px 8px;">
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M23 4v6h-6M1 20v-6h6"/>
                                    <path d="M20.49 9A9 9 0 005.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 013.51 15"/>
                                </svg>
                                Refresh
                            </button>
                            <button class="btn btn-secondary" onclick="exportActivityLog()" style="font-size: 0.7rem; padding: 4px 8px;">
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
                                    <polyline points="7 10 12 15 17 10"/>
                                    <line x1="12" y1="15" x2="12" y2="3"/>
                                </svg>
                                Export
                            </button>
                            <button class="btn btn-secondary" onclick="clearActivityLog()" style="font-size: 0.7rem; padding: 4px 8px;">Clear</button>
                            <span class="status-badge" id="activityLogSyncStatus" style="font-size: 0.7rem; background: var(--success);">Synced</span>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Activity Stats -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px; margin-bottom: 16px;">
                            <div style="padding: 12px; background: var(--bg-tertiary); border-radius: 8px; text-align: center; border: 1px solid var(--border);">
                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--info);" id="activityStatTotal">0</div>
                                <div style="font-size: 0.7rem; color: var(--text-muted);">Total Actions</div>
                            </div>
                            <div style="padding: 12px; background: var(--bg-tertiary); border-radius: 8px; text-align: center; border: 1px solid var(--border);">
                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--success);" id="activityStatUsers">0</div>
                                <div style="font-size: 0.7rem; color: var(--text-muted);">User Actions</div>
                            </div>
                            <div style="padding: 12px; background: var(--bg-tertiary); border-radius: 8px; text-align: center; border: 1px solid var(--border);">
                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--purple);" id="activityStatFiles">0</div>
                                <div style="font-size: 0.7rem; color: var(--text-muted);">File Saves</div>
                            </div>
                            <div style="padding: 12px; background: var(--bg-tertiary); border-radius: 8px; text-align: center; border: 1px solid var(--border);">
                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--warning);" id="activityStatEvents">0</div>
                                <div style="font-size: 0.7rem; color: var(--text-muted);">Events</div>
                            </div>
                            <div style="padding: 12px; background: var(--bg-tertiary); border-radius: 8px; text-align: center; border: 1px solid var(--border);">
                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--danger);" id="activityStatToday">0</div>
                                <div style="font-size: 0.7rem; color: var(--text-muted);">Today</div>
                            </div>
                        </div>
                        
                        <!-- Activity Log List -->
                        <div id="adminActivityLog" class="admin-activity-log" style="max-height: 400px; overflow-y: auto; border: 1px solid var(--border); border-radius: 8px; background: var(--bg-tertiary);">
                            <div class="activity-log-empty" style="padding: 40px; text-align: center; color: var(--text-muted);">
                                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="margin-bottom: 12px; opacity: 0.5;">
                                    <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/>
                                    <path d="M14 2v6h6"/>
                                    <path d="M16 13H8M16 17H8M10 9H8"/>
                                </svg>
                                <div style="font-size: 0.9rem; margin-bottom: 4px;">No activity logged yet</div>
                                <div style="font-size: 0.75rem;">Admin actions will appear here automatically</div>
                            </div>
                        </div>
                        
                        <!-- Logged-in Admin Info -->
                        <div style="margin-top: 12px; padding: 12px; background: var(--bg-secondary); border-radius: 8px; display: flex; justify-content: space-between; align-items: center; border: 1px solid var(--border);">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <div style="width: 32px; height: 32px; background: linear-gradient(135deg, var(--info), var(--purple)); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 0.8rem;" id="activityLogAdminAvatar">A</div>
                                <div>
                                    <div style="font-size: 0.85rem; font-weight: 600;" id="activityLogAdminName">Admin User</div>
                                    <div style="font-size: 0.7rem; color: var(--text-muted);" id="activityLogAdminEmail">admin@oith.app</div>
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 0.7rem; color: var(--text-muted);">Session Started</div>
                                <div style="font-size: 0.8rem; font-weight: 500;" id="activityLogSessionStart">--</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Database Schema Section -->
            <div id="database-section" style="display: none;">
                <div class="page-header">
                    <div>
                        <h2 class="page-title"> Database Schema</h2>
                        <p class="page-subtitle">DynamoDB multi-table design - synced with AWS</p>
                    </div>
                    <div class="header-actions">
                        <button class="btn btn-primary" onclick="syncDynamoDBSchema()" id="syncSchemaBtn">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.66 0 3-4 3-9s-1.34-9-3-9m0 18c-1.66 0-3-4-3-9s1.34-9 3-9"/>
                            </svg>
                            Sync from DynamoDB
                        </button>
                        <button class="btn btn-secondary" onclick="exportDatabaseSchema()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/>
                                <polyline points="14 2 14 8 20 8"/>
                            </svg>
                            Export Schema
                        </button>
                    </div>
                </div>

                <!-- DynamoDB Connection Card -->
                <div class="card" style="margin-bottom: 20px; border: 2px solid var(--warning);">
                    <div class="card-header" style="background: linear-gradient(135deg, rgba(245, 158, 11, 0.15), rgba(245, 158, 11, 0.05));">
                        <h3 class="card-title"> AWS DynamoDB Connection</h3>
                        <span class="status-badge" id="dynamoStatusBadge" style="background: var(--text-muted); color: white;">CHECKING...</span>
                    </div>
                    <div class="card-body">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px;">
                            <!-- DynamoDB Connection Info -->
                            <div style="padding: 16px; background: var(--bg-tertiary); border-radius: 12px; border: 1px solid var(--border);">
                                <div style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 8px;">DYNAMODB TABLES (Multi-Table Design)</div>
                                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                                    <div id="dynamoConnectionDot" style="width: 12px; height: 12px; background: var(--text-muted); border-radius: 50%;"></div>
                                    <div>
                                        <div style="font-weight: 600;" id="dynamoTableName">oith-profiles  oith-matches  oith-notifications  oith-users</div>
                                        <div style="font-size: 0.75rem; color: var(--text-muted);" id="dynamoRegion">us-east-1</div>
                                    </div>
                                    <div style="margin-left: auto; text-align: right;">
                                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--accent);" id="dynamoItemCount">--</div>
                                        <div style="font-size: 0.7rem; color: var(--text-muted);">Total Items</div>
                                </div>
                                    </div>
                                
                                <!-- User Data Section -->
                                <div style="margin-bottom: 12px;">
                                    <div style="font-size: 0.7rem; color: var(--info); font-weight: 600; margin-bottom: 6px; text-transform: uppercase;"> User Data</div>
                                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; font-size: 0.75rem;">
                                        <div onclick="loadEntityPreview('PROFILE')" style="padding: 6px; background: var(--bg-secondary); border-radius: 4px; text-align: center; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='var(--accent)'; this.style.transform='scale(1.05)'" onmouseout="this.style.background='var(--bg-secondary)'; this.style.transform='scale(1)'">
                                            <div style="font-weight: 600; color: var(--info);" id="dynamoProfileCount">--</div>
                                            <div style="color: var(--text-muted); font-size: 0.65rem;">Profiles</div>
                                    </div>
                                        <div onclick="loadEntityPreview('MATCH')" style="padding: 6px; background: var(--bg-secondary); border-radius: 4px; text-align: center; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='var(--accent)'; this.style.transform='scale(1.05)'" onmouseout="this.style.background='var(--bg-secondary)'; this.style.transform='scale(1)'">
                                            <div style="font-weight: 600; color: var(--danger);" id="dynamoMatchCount">--</div>
                                            <div style="color: var(--text-muted); font-size: 0.65rem;">Matches</div>
                                    </div>
                                        <div onclick="loadEntityPreview('CHAT')" style="padding: 6px; background: var(--bg-secondary); border-radius: 4px; text-align: center; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='var(--accent)'; this.style.transform='scale(1.05)'" onmouseout="this.style.background='var(--bg-secondary)'; this.style.transform='scale(1)'">
                                            <div style="font-weight: 600; color: var(--success);" id="dynamoMessageCount">--</div>
                                            <div style="color: var(--text-muted); font-size: 0.65rem;">Messages</div>
                                        </div>
                                        <div onclick="loadEntityPreview('LIKE')" style="padding: 6px; background: var(--bg-secondary); border-radius: 4px; text-align: center; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='var(--accent)'; this.style.transform='scale(1.05)'" onmouseout="this.style.background='var(--bg-secondary)'; this.style.transform='scale(1)'">
                                            <div style="font-weight: 600; color: var(--pink);" id="dynamoLikeCount">--</div>
                                            <div style="color: var(--text-muted); font-size: 0.65rem;">Likes</div>
                                    </div>
                                </div>
                            </div>

                                <!-- Feedback Section -->
                                <div style="margin-bottom: 12px;">
                                    <div style="font-size: 0.7rem; color: var(--warning); font-weight: 600; margin-bottom: 6px; text-transform: uppercase;"> Feedback</div>
                                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; font-size: 0.75rem;">
                                        <div onclick="loadEntityPreview('FEEDBACK')" style="padding: 6px; background: var(--bg-secondary); border-radius: 4px; text-align: center; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='var(--accent)'; this.style.transform='scale(1.05)'" onmouseout="this.style.background='var(--bg-secondary)'; this.style.transform='scale(1)'">
                                            <div style="font-weight: 600; color: var(--warning);" id="dynamoFeedbackCount">--</div>
                                            <div style="color: var(--text-muted); font-size: 0.65rem;">Feedback</div>
                                        </div>
                                        <div onclick="loadEntityPreview('RATING')" style="padding: 6px; background: var(--bg-secondary); border-radius: 4px; text-align: center; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='var(--accent)'; this.style.transform='scale(1.05)'" onmouseout="this.style.background='var(--bg-secondary)'; this.style.transform='scale(1)'">
                                            <div style="font-weight: 600; color: #FBBF24;" id="dynamoRatingCount">--</div>
                                            <div style="color: var(--text-muted); font-size: 0.65rem;">Ratings</div>
                                        </div>
                                        <div onclick="loadEntityPreview('REPORT')" style="padding: 6px; background: var(--bg-secondary); border-radius: 4px; text-align: center; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='var(--accent)'; this.style.transform='scale(1.05)'" onmouseout="this.style.background='var(--bg-secondary)'; this.style.transform='scale(1)'">
                                            <div style="font-weight: 600; color: var(--danger);" id="dynamoReportCount">--</div>
                                            <div style="color: var(--text-muted); font-size: 0.65rem;">Reports</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Activity Section -->
                                <div style="margin-bottom: 12px;">
                                    <div style="font-size: 0.7rem; color: var(--success); font-weight: 600; margin-bottom: 6px; text-transform: uppercase;"> Activity</div>
                                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; font-size: 0.75rem;">
                                        <div onclick="loadEntityPreview('ACTIVITY')" style="padding: 6px; background: var(--bg-secondary); border-radius: 4px; text-align: center; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='var(--accent)'; this.style.transform='scale(1.05)'" onmouseout="this.style.background='var(--bg-secondary)'; this.style.transform='scale(1)'">
                                            <div style="font-weight: 600; color: var(--success);" id="dynamoActivityCount">--</div>
                                            <div style="color: var(--text-muted); font-size: 0.65rem;">Events</div>
                                        </div>
                                        <div onclick="loadEntityPreview('SESSION')" style="padding: 6px; background: var(--bg-secondary); border-radius: 4px; text-align: center; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='var(--accent)'; this.style.transform='scale(1.05)'" onmouseout="this.style.background='var(--bg-secondary)'; this.style.transform='scale(1)'">
                                            <div style="font-weight: 600; color: #06B6D4;" id="dynamoSessionCount">--</div>
                                            <div style="color: var(--text-muted); font-size: 0.65rem;">Sessions</div>
                                        </div>
                                        <div onclick="loadEntityPreview('METRICS')" style="padding: 6px; background: var(--bg-secondary); border-radius: 4px; text-align: center; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='var(--accent)'; this.style.transform='scale(1.05)'" onmouseout="this.style.background='var(--bg-secondary)'; this.style.transform='scale(1)'">
                                            <div style="font-weight: 600; color: var(--purple);" id="dynamoMetricsCount">--</div>
                                            <div style="color: var(--text-muted); font-size: 0.65rem;">Daily Metrics</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Company Section -->
                                <div style="margin-bottom: 12px;">
                                    <div style="font-size: 0.7rem; color: var(--purple); font-weight: 600; margin-bottom: 6px; text-transform: uppercase;"> Company</div>
                                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; font-size: 0.75rem;">
                                        <div onclick="loadEntityPreview('EMPLOYEE')" style="padding: 6px; background: var(--bg-secondary); border-radius: 4px; text-align: center; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='var(--accent)'; this.style.transform='scale(1.05)'" onmouseout="this.style.background='var(--bg-secondary)'; this.style.transform='scale(1)'">
                                            <div style="font-weight: 600; color: var(--info);" id="dynamoEmployeeCount">--</div>
                                            <div style="color: var(--text-muted); font-size: 0.65rem;">Employees</div>
                                        </div>
                                        <div onclick="loadEntityPreview('DEPARTMENT')" style="padding: 6px; background: var(--bg-secondary); border-radius: 4px; text-align: center; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='var(--accent)'; this.style.transform='scale(1.05)'" onmouseout="this.style.background='var(--bg-secondary)'; this.style.transform='scale(1)'">
                                            <div style="font-weight: 600; color: var(--purple);" id="dynamoDeptCount">--</div>
                                            <div style="color: var(--text-muted); font-size: 0.65rem;">Depts</div>
                                        </div>
                                        <div onclick="loadEntityPreview('COMPANY_METRICS')" style="padding: 6px; background: var(--bg-secondary); border-radius: 4px; text-align: center; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='var(--accent)'; this.style.transform='scale(1.05)'" onmouseout="this.style.background='var(--bg-secondary)'; this.style.transform='scale(1)'">
                                            <div style="font-weight: 600; color: var(--success);" id="dynamoCompanyMetricsCount">--</div>
                                            <div style="color: var(--text-muted); font-size: 0.65rem;">Metrics</div>
                                        </div>
                                        <div onclick="loadEntityPreview('INVESTOR')" style="padding: 6px; background: var(--bg-secondary); border-radius: 4px; text-align: center; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='var(--accent)'; this.style.transform='scale(1.05)'" onmouseout="this.style.background='var(--bg-secondary)'; this.style.transform='scale(1)'">
                                            <div style="font-weight: 600; color: var(--pink);" id="dynamoInvestorCount">--</div>
                                            <div style="color: var(--text-muted); font-size: 0.65rem;">Investors</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Documents Section -->
                                <div style="margin-bottom: 12px;">
                                    <div style="font-size: 0.7rem; color: #0EA5E9; font-weight: 600; margin-bottom: 6px; text-transform: uppercase;"> Documents</div>
                                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 6px; font-size: 0.75rem;">
                                        <div onclick="loadEntityPreview('PATENT_DOC')" style="padding: 6px; background: var(--bg-secondary); border-radius: 4px; text-align: center; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='var(--accent)'; this.style.transform='scale(1.05)'" onmouseout="this.style.background='var(--bg-secondary)'; this.style.transform='scale(1)'">
                                            <div style="font-weight: 600; color: #0EA5E9;" id="dynamoPatentDocsCount">--</div>
                                            <div style="color: var(--text-muted); font-size: 0.65rem;">Patent Docs</div>
                                        </div>
                                        <div onclick="loadEntityPreview('COMPLIANCE_DOC')" style="padding: 6px; background: var(--bg-secondary); border-radius: 4px; text-align: center; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='var(--accent)'; this.style.transform='scale(1.05)'" onmouseout="this.style.background='var(--bg-secondary)'; this.style.transform='scale(1)'">
                                            <div style="font-weight: 600; color: var(--success);" id="dynamoComplianceDocsCount">--</div>
                                            <div style="color: var(--text-muted); font-size: 0.65rem;">Compliance Docs</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- System Section -->
                                <div>
                                    <div style="font-size: 0.7rem; color: #94A3B8; font-weight: 600; margin-bottom: 6px; text-transform: uppercase;"> System</div>
                                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; font-size: 0.75rem;">
                                        <div onclick="loadEntityPreview('SUBSCRIPTION')" style="padding: 6px; background: var(--bg-secondary); border-radius: 4px; text-align: center; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='var(--accent)'; this.style.transform='scale(1.05)'" onmouseout="this.style.background='var(--bg-secondary)'; this.style.transform='scale(1)'">
                                            <div style="font-weight: 600; color: var(--success);" id="dynamoSubscriptionCount">--</div>
                                            <div style="color: var(--text-muted); font-size: 0.65rem;">Subs</div>
                                        </div>
                                        <div onclick="loadEntityPreview('CONFIG')" style="padding: 6px; background: var(--bg-secondary); border-radius: 4px; text-align: center; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='var(--accent)'; this.style.transform='scale(1.05)'" onmouseout="this.style.background='var(--bg-secondary)'; this.style.transform='scale(1)'">
                                            <div style="font-weight: 600; color: #94A3B8;" id="dynamoConfigCount">--</div>
                                            <div style="color: var(--text-muted); font-size: 0.65rem;">Config</div>
                                        </div>
                                        <div onclick="loadEntityPreview('CRAWLER_LOG')" style="padding: 6px; background: var(--bg-secondary); border-radius: 4px; text-align: center; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='var(--accent)'; this.style.transform='scale(1.05)'" onmouseout="this.style.background='var(--bg-secondary)'; this.style.transform='scale(1)'">
                                            <div style="font-weight: 600; color: var(--warning);" id="dynamoCrawlerCount">--</div>
                                            <div style="color: var(--text-muted); font-size: 0.65rem;">Crawler</div>
                                        </div>
                                        <div onclick="loadEntityPreview('SUPPORT')" style="padding: 6px; background: var(--bg-secondary); border-radius: 4px; text-align: center; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='var(--accent)'; this.style.transform='scale(1.05)'" onmouseout="this.style.background='var(--bg-secondary)'; this.style.transform='scale(1)'">
                                            <div style="font-weight: 600; color: var(--info);" id="dynamoSupportCount">--</div>
                                            <div style="color: var(--text-muted); font-size: 0.65rem;">Support</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Data Preview Panel -->
                            <div style="padding: 16px; background: var(--bg-tertiary); border-radius: 12px; border: 1px solid var(--border); grid-column: span 2;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                    <div style="font-size: 0.8rem; color: var(--text-muted);">DATA PREVIEW</div>
                                    <div style="display: flex; gap: 8px; align-items: center;">
                                        <span id="previewEntityType" style="font-size: 0.75rem; color: var(--accent); font-weight: 600;"> Click stat box to load</span>
                                        <button class="btn btn-secondary btn-sm" onclick="refreshDataPreview()" id="refreshPreviewBtn" style="padding: 4px 8px; font-size: 0.7rem;" disabled>
                                             Refresh
                                    </button>
                                </div>
                            </div>

                                <!-- Data Table Preview (click stat boxes on left to load data) -->
                                <div id="dataPreviewContainer" style="height: 480px; overflow-y: auto; background: var(--bg-secondary); border-radius: 8px; border: 1px solid var(--border);">
                                    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: var(--text-muted);">
                                        <div style="font-size: 2rem; margin-bottom: 8px;"></div>
                                        <div style="font-size: 0.85rem;">Click a stat box on the left to preview data</div>
                                        <div style="font-size: 0.7rem; margin-top: 4px; opacity: 0.7;">Data is loaded directly from AWS DynamoDB</div>
                                    </div>
                                </div>
                                
                                <!-- Row Count & Export -->
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 6px;">
                                    <span id="previewRowCount" style="font-size: 0.7rem; color: var(--text-muted);">0 rows</span>
                                    <button class="btn btn-secondary btn-sm" onclick="exportPreviewData()" id="exportPreviewBtn" style="padding: 4px 10px; font-size: 0.7rem;" disabled>
                                         Export CSV
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Data Transfer Card -->
                <div class="card" style="margin-bottom: 20px; border: 2px solid var(--purple);">
                    <div class="card-header" style="background: linear-gradient(135deg, rgba(168, 85, 247, 0.1), rgba(168, 85, 247, 0.05));">
                        <h3 class="card-title"> Data Transfer</h3>
                        <span class="status-badge" style="background: var(--purple); color: white;">SYNC</span>
                    </div>
                    <div class="card-body">
                        <p style="color: var(--text-muted); margin-bottom: 16px; font-size: 0.9rem;">
                            Transfer user profiles and app data between environments (localhost  GitHub Pages) or backup your database.
                        </p>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px;">
                            <!-- Export Section -->
                            <div style="padding: 16px; background: var(--bg-tertiary); border-radius: 12px; border: 1px solid var(--border);">
                                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">
                                    <span style="font-size: 1.5rem;"></span>
                                    <div>
                                        <div style="font-weight: 600;">Export Data</div>
                                        <div style="font-size: 0.75rem; color: var(--text-muted);">Download all profiles & settings</div>
                                    </div>
                                </div>
                                <button class="btn btn-primary" onclick="exportAllData()" style="width: 100%;">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
                                        <polyline points="7 10 12 15 17 10"/>
                                        <line x1="12" y1="15" x2="12" y2="3"/>
                                    </svg>
                                    Export JSON Backup
                                </button>
                            </div>
                            
                            <!-- Import Section -->
                            <div style="padding: 16px; background: var(--bg-tertiary); border-radius: 12px; border: 1px solid var(--border);">
                                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">
                                    <span style="font-size: 1.5rem;"></span>
                                    <div>
                                        <div style="font-weight: 600;">Import Data</div>
                                        <div style="font-size: 0.75rem; color: var(--text-muted);">Restore from backup file</div>
                                    </div>
                                </div>
                                <button class="btn btn-secondary" onclick="triggerImportData()" style="width: 100%;">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
                                        <polyline points="17 8 12 3 7 8"/>
                                        <line x1="12" y1="3" x2="12" y2="15"/>
                                    </svg>
                                    Import JSON Backup
                                </button>
                                <input type="file" id="importDataFile" accept=".json" style="display: none;" onchange="importDataFromFile(event)">
                            </div>
                            
                            <!-- Quick Stats -->
                            <div style="padding: 16px; background: var(--bg-tertiary); border-radius: 12px; border: 1px solid var(--border);">
                                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">
                                    <span style="font-size: 1.5rem;"></span>
                                    <div>
                                        <div style="font-weight: 600;">Current Data</div>
                                        <div style="font-size: 0.75rem; color: var(--text-muted);">What will be exported</div>
                                    </div>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                                    <div style="padding: 8px; background: var(--bg-secondary); border-radius: 6px; text-align: center;">
                                        <div style="font-size: 1.25rem; font-weight: 700; color: var(--info);" id="exportUserCount">0</div>
                                        <div style="font-size: 0.7rem; color: var(--text-muted);">Users</div>
                                    </div>
                                    <div style="padding: 8px; background: var(--bg-secondary); border-radius: 6px; text-align: center;">
                                        <div style="font-size: 1.25rem; font-weight: 700; color: var(--success);" id="exportBotCount">0</div>
                                        <div style="font-size: 0.7rem; color: var(--text-muted);">Test Bots</div>
                                    </div>
                                    <div style="padding: 8px; background: var(--bg-secondary); border-radius: 6px; text-align: center;">
                                        <div style="font-size: 1.25rem; font-weight: 700; color: var(--purple);" id="exportKeyCount">0</div>
                                        <div style="font-size: 0.7rem; color: var(--text-muted);">Data Keys</div>
                                    </div>
                                    <div style="padding: 8px; background: var(--bg-secondary); border-radius: 6px; text-align: center;">
                                        <div style="font-size: 1.25rem; font-weight: 700; color: var(--warning);" id="exportDataSize">0 KB</div>
                                        <div style="font-size: 0.7rem; color: var(--text-muted);">Size</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Database Overview Stats -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon" style="background: rgba(59, 130, 246, 0.2); color: var(--info);"></div>
                        <div class="stat-value">7</div>
                        <div class="stat-label">Core Tables</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: rgba(168, 85, 247, 0.2); color: var(--purple);"></div>
                        <div class="stat-value">12</div>
                        <div class="stat-label">Relationships</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: rgba(16, 185, 129, 0.2); color: var(--success);"></div>
                        <div class="stat-value">68</div>
                        <div class="stat-label">Total Fields</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: rgba(245, 158, 11, 0.2); color: var(--warning);"></div>
                        <div class="stat-value">7</div>
                        <div class="stat-label">Primary Keys</div>
                    </div>
                </div>

                <!-- DynamoDB Entity Diagram -->
                <div class="card" style="margin-top: 20px;">
                    <div class="card-header">
                        <h3 class="card-title"> DynamoDB Entities (Multi-Table Design)</h3>
                        <span class="status-badge active" style="font-size: 0.7rem;">LIVE</span>
                    </div>
                    <div class="card-body" style="overflow-x: auto; padding: 24px;">
                        <div id="erdDiagram" style="min-width: 900px;">
                            <!-- DynamoDB entities will be rendered by JS -->
                        </div>
                    </div>
                </div>

                <!-- Access Patterns -->
                <div class="card" style="margin-top: 20px; border: 1px solid var(--accent);">
                    <div class="card-header" style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(139, 92, 246, 0.02));">
                        <h3 class="card-title"> DynamoDB Access Patterns</h3>
                        <span class="status-badge" style="background: var(--accent); font-size: 0.7rem;">7 PATTERNS</span>
                    </div>
                    <div class="card-body" id="accessPatternsContainer">
                        <!-- Access patterns will be rendered by JS -->
                    </div>
                </div>

                <!-- Table Details -->
                <div class="card" style="margin-top: 20px;">
                    <div class="card-header">
                        <h3 class="card-title"> Table Definitions</h3>
                    </div>
                    <div class="card-body" style="padding: 0;">
                        <div id="tableDefinitions">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>

                <!-- Relationships Detail -->
                <div class="card" style="margin-top: 20px;">
                    <div class="card-header">
                        <h3 class="card-title"> Table Relationships</h3>
                    </div>
                    <div class="card-body" id="relationshipsDetail">
                        <!-- Populated by JS -->
                    </div>
                </div>

                <!-- Data Flow -->
                <div class="card" style="margin-top: 20px;">
                    <div class="card-header">
                        <h3 class="card-title"> Data Flow Diagram</h3>
                    </div>
                    <div class="card-body" id="dataFlowDiagram">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // ==========================================
        // GLOBAL CONSTANTS
        // ==========================================
        const AWS_API_URL = localStorage.getItem('oith_aws_api_url') || 'https://emeapbgbui.execute-api.us-east-1.amazonaws.com';
        const LOCAL_API_URL = 'http://localhost:3001/api';
        
        // ==========================================
        // AUTHENTICATION FUNCTIONS
        // ==========================================
        
        function getAdminToken() {
            return localStorage.getItem('oith_admin_token') || sessionStorage.getItem('oith_admin_token');
        }
        
        function getAdminUser() {
            const userStr = localStorage.getItem('oith_admin_user') || sessionStorage.getItem('oith_admin_user');
            try {
                return userStr ? JSON.parse(userStr) : null;
            } catch {
                return null;
            }
        }
        
        async function checkAdminAuth() {
            const token = getAdminToken();
            if (!token) return false;
            
            // First, validate token locally (quick check)
            try {
                const payload = JSON.parse(atob(token));
                // Token expires after 24 hours
                if (Date.now() - payload.timestamp > 24 * 60 * 60 * 1000) {
                    console.log(' Token expired');
                    return false;
                }
                
                // Token is valid locally - also check user data exists
                let user = getAdminUser();
                if (!user || !user.email) {
                    // User data missing - try to fetch from server before failing
                    console.log(' User data missing, attempting to fetch from server...');
                    try {
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), 3000);
                        
                        const response = await fetch(`${LOCAL_API_URL}/auth/validate`, {
                            headers: { 'Authorization': `Bearer ${token}` },
                            signal: controller.signal
                        });
                        
                        clearTimeout(timeoutId);
                        
                        if (response.ok) {
                            const contentType = response.headers.get('content-type');
                            if (contentType && contentType.includes('application/json')) {
                                const data = await response.json();
                                if (data.valid && data.user) {
                                    // Restore user data to prevent future issues
                                    const isLocalStorage = !!localStorage.getItem('oith_admin_token');
                                    const storage = isLocalStorage ? localStorage : sessionStorage;
                                    storage.setItem('oith_admin_user', JSON.stringify(data.user));
                                    console.log(' User data restored from server');
                                    user = data.user;
                                }
                            }
                        }
                    } catch (e) {
                        console.log(' Could not fetch user data from server');
                    }
                    
                    // If still no user data, fail auth
                    if (!user || !user.email) {
                        console.log(' No user data found - clearing invalid session');
                        // Clear the orphaned token to prevent login loop
                        localStorage.removeItem('oith_admin_token');
                        localStorage.removeItem('oith_admin_user');
                        sessionStorage.removeItem('oith_admin_token');
                        sessionStorage.removeItem('oith_admin_user');
                        return false;
                    }
                }
                
                console.log(' Token valid (offline mode)');
                
                // Optionally verify with server (non-blocking)
                verifyTokenWithServer(token).catch(() => {});
                
                return true;
            } catch (e) {
                console.log(' Token validation failed:', e.message);
                return false;
            }
        }
        
        // Non-blocking server verification
        async function verifyTokenWithServer(token) {
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 3000);
                
                const response = await fetch(`${LOCAL_API_URL}/auth/validate`, {
                    headers: { 'Authorization': `Bearer ${token}` },
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (response.ok) {
                    const contentType = response.headers.get('content-type');
                    if (contentType && contentType.includes('application/json')) {
                        const data = await response.json();
                        if (data.valid && data.user) {
                            // Keep user data in sync
                            const isLocalStorage = !!localStorage.getItem('oith_admin_token');
                            const storage = isLocalStorage ? localStorage : sessionStorage;
                            storage.setItem('oith_admin_user', JSON.stringify(data.user));
                        } else if (!data.valid) {
                            console.log(' Server rejected token');
                            // Optionally logout: logoutAdmin();
                        }
                    }
                }
            } catch (e) {
                // Server unavailable, continue with local validation
                console.log(' Server verification skipped (offline)');
            }
        }
        
        function logoutAdmin() {
            localStorage.removeItem('oith_admin_token');
            localStorage.removeItem('oith_admin_user');
            sessionStorage.removeItem('oith_admin_token');
            sessionStorage.removeItem('oith_admin_user');
            window.location.href = 'login.html';
        }
        
        function showAdminProfile() {
            const user = getAdminUser();
            if (!user) return;
            
            // Create profile modal
            const modal = document.createElement('div');
            modal.className = 'modal dynamic-modal';
            modal.style.display = 'flex';
            modal.id = 'adminProfileModal';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 400px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 16px; border-bottom: 1px solid var(--border);">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div style="width: 48px; height: 48px; background: linear-gradient(135deg, var(--accent) 0%, #8b5cf6 100%); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem;"></div>
                            <div>
                                <h3 style="margin: 0; font-size: 1.1rem;">Admin Profile</h3>
                                <p style="margin: 0; font-size: 0.8rem; color: var(--text-muted);">Account Settings</p>
                            </div>
                        </div>
                        <button onclick="document.getElementById('adminProfileModal').remove()" style="background: var(--bg-tertiary); border: none; color: var(--text-muted); cursor: pointer; font-size: 1.2rem; width: 32px; height: 32px; border-radius: 8px;">&times;</button>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <div style="display: flex; flex-direction: column; gap: 12px;">
                            <div style="padding: 12px; background: var(--bg-tertiary); border-radius: 10px;">
                                <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 4px;">NAME</div>
                                <div style="font-weight: 600;">${user.name || 'Admin User'}</div>
                            </div>
                            <div style="padding: 12px; background: var(--bg-tertiary); border-radius: 10px;">
                                <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 4px;">EMAIL</div>
                                <div style="font-weight: 600;">${user.email || 'admin@oith.com'}</div>
                            </div>
                            <div style="padding: 12px; background: var(--bg-tertiary); border-radius: 10px;">
                                <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 4px;">ROLE</div>
                                <div style="font-weight: 600; text-transform: capitalize;">${user.role || 'Admin'}</div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 12px;">
                        <button class="btn btn-secondary" onclick="document.getElementById('adminProfileModal').remove()" style="flex: 1;">Close</button>
                        <button class="btn btn-primary" onclick="logoutAdmin()" style="flex: 1; background: var(--danger);">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4"/>
                                <polyline points="16 17 21 12 16 7"/>
                                <line x1="21" y1="12" x2="9" y2="12"/>
                            </svg>
                            Logout
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        // ==========================================
        // SYSTEM HIERARCHY FUNCTIONS
        // ==========================================
        
        function toggleHierarchy() {
            const body = document.getElementById('hierarchyBody');
            const toggle = document.getElementById('hierarchyToggle');
            body.classList.toggle('expanded');
            toggle.classList.toggle('expanded');
            
            // Save state to localStorage
            localStorage.setItem('oith_hierarchy_expanded', body.classList.contains('expanded'));
        }
        
        function updateHierarchyStatusCounts() {
            // Only count error lights now (hidden by default, only show on connection errors)
            const errorLights = document.querySelectorAll('#systemHierarchy .node-status.error').length;
            
            const greenEl = document.getElementById('hierGreenCount');
            const yellowEl = document.getElementById('hierYellowCount');
            const redEl = document.getElementById('hierRedCount');
            
            // Show dash for green/yellow since we only track errors now
            if (greenEl) greenEl.textContent = '';
            if (yellowEl) yellowEl.textContent = '';
            if (redEl) redEl.textContent = errorLights;
        }
        
        // Track last known connection state for the hierarchy so we only surface new issues
        let lastHierarchyConnectionState = { aws: true, index: true };

        // Collect unique component ids from the hierarchy diagram
        function getHierarchyComponentIds() {
            return Array.from(document.querySelectorAll('#systemHierarchy [data-component]'))
                .map(el => el.getAttribute('data-component'))
                .filter(Boolean)
                .filter((id, idx, arr) => arr.indexOf(id) === idx);
        }

        // Lightweight availability check for the index app
        async function checkIndexAppAvailability() {
            try {
                const [indexCheck, appJsCheck] = await Promise.all([
                    checkFileWithTimestamp('index.html'),
                    checkFileWithTimestamp('app.js')
                ]);
                return indexCheck.exists && appJsCheck.exists;
            } catch (e) {
                console.log('Index availability check failed:', e.message);
                return false;
            }
        }

        // Lightweight availability check for the AWS backend
        async function checkAWSConnectivity() {
            const controller = new AbortController();
            const timeout = setTimeout(() => controller.abort(), 4000);
            try {
                // no-cors keeps the check simple and avoids CORS errors surfacing to the user
                await fetch(AWS_API_URL, { method: 'GET', mode: 'no-cors', signal: controller.signal });
                return true;
            } catch (e) {
                console.log('AWS connectivity check failed:', e.message);
                return false;
            } finally {
                clearTimeout(timeout);
            }
        }

        // Only raise an error notification when a connection issue is detected for AWS or the index app
        async function checkHierarchyConnections() {
            const [indexOk, awsOk] = await Promise.all([
                checkIndexAppAvailability(),
                checkAWSConnectivity()
            ]);

            const hasIssue = !indexOk || !awsOk;
            const statusChanged = lastHierarchyConnectionState.aws !== awsOk || lastHierarchyConnectionState.index !== indexOk;

            if (hasIssue && statusChanged) {
                const issueTargets = [];
                if (!awsOk) issueTargets.push('AWS backend');
                if (!indexOk) issueTargets.push('index app');

                const affected = getHierarchyComponentIds();
                const affectedText = affected.length ? `Affected: ${affected.join(', ')}` : 'Affected: hierarchy components';

                showToast(` Connection issue with ${issueTargets.join(' and ')}. ${affectedText}`, 'error');
            }

            lastHierarchyConnectionState = { aws: awsOk, index: indexOk };
        }
        
        function setComponentStatus(componentId, status) {
            // status: 'green', 'yellow', 'red', 'gray'
            const item = document.querySelector(`[data-component="${componentId}"]`);
            if (item) {
                const light = item.querySelector('.status-light');
                const statusBadge = item.querySelector('.hierarchy-item-status');
                
                light.className = 'status-light ' + status;
                
                statusBadge.className = 'hierarchy-item-status';
                switch(status) {
                    case 'green':
                        statusBadge.classList.add('operational');
                        statusBadge.textContent = 'Operational';
                        break;
                    case 'yellow':
                        statusBadge.classList.add('warning');
                        statusBadge.textContent = 'Warning';
                        break;
                    case 'red':
                        statusBadge.classList.add('error');
                        statusBadge.textContent = 'Issue';
                        break;
                    case 'gray':
                        statusBadge.classList.add('offline');
                        statusBadge.textContent = 'Offline';
                        break;
                }
                
                updateHierarchyStatusCounts();
            }
        }
        
        // ==========================================
        // SECTION HEALTH MONITORING SYSTEM
        // ==========================================
        
        // Track health metrics for each section
        const sectionHealthMetrics = {};
        let healthMonitorInterval = null;
        
        // Define sections and their data sources
        const sectionConfig = {
            'overview': { requiresAPI: false, hasRealtime: false, dataKey: 'platformData' },
            'dashboard': { requiresAPI: true, hasRealtime: true, dataKey: 'dashboardData' },
            'analytics': { requiresAPI: true, hasRealtime: true, dataKey: 'analyticsData' },
            'mlmodels': { requiresAPI: true, hasRealtime: false, dataKey: 'mlModels' },
            'revenue': { requiresAPI: true, hasRealtime: true, dataKey: 'revenueData' },
            'geographic': { requiresAPI: true, hasRealtime: false, dataKey: 'geographicData' },
            'legal': { requiresAPI: false, hasRealtime: false, dataKey: 'legalData' },
            'compliance': { requiresAPI: false, hasRealtime: false, dataKey: 'complianceData' },
            'database': { requiresAPI: true, hasRealtime: false, dataKey: 'dynamoDBStats' },
            'experiments': { requiresAPI: false, hasRealtime: false, dataKey: 'experiments' },
            'org-hierarchy': { requiresAPI: false, hasRealtime: false, dataKey: null },
            'payroll': { requiresAPI: false, hasRealtime: false, dataKey: 'payrollData' },
            'tax': { requiresAPI: false, hasRealtime: false, dataKey: 'taxData' },
            'expenses': { requiresAPI: false, hasRealtime: false, dataKey: 'expensesData' },
            'calendar': { requiresAPI: true, hasRealtime: false, dataKey: 'calendarEvents' },
            'simulation': { requiresAPI: false, hasRealtime: false, dataKey: null },
            'users': { requiresAPI: true, hasRealtime: true, dataKey: 'allUserData' },
            'matches': { requiresAPI: true, hasRealtime: true, dataKey: 'matchesData' },
            'funnel': { requiresAPI: true, hasRealtime: false, dataKey: 'funnelData' },
            'realtime': { requiresAPI: true, hasRealtime: true, dataKey: 'realtimeData' },
            'safety': { requiresAPI: true, hasRealtime: true, dataKey: 'safetyReports' },
            'feedback': { requiresAPI: true, hasRealtime: false, dataKey: 'feedbackData' },
            'testbots': { requiresAPI: false, hasRealtime: true, dataKey: 'testBots' },
            'diagnostics': { requiresAPI: false, hasRealtime: false, dataKey: null },
            'site-diagnostics': { requiresAPI: false, hasRealtime: false, dataKey: null },
            'compliance-app': { requiresAPI: false, hasRealtime: false, dataKey: null }
        };
        
        // Initialize health metrics for all sections
        function initSectionHealthMetrics() {
            Object.keys(sectionConfig).forEach(section => {
                sectionHealthMetrics[section] = {
                    lastUpdated: null,
                    lastApiCall: null,
                    apiResponseTime: null,
                    apiErrors: 0,
                    consecutiveErrors: 0,
                    dataCount: 0,
                    status: 'gray', // gray = unknown, green = healthy, yellow = warning, red = error
                    message: 'Not checked yet'
                };
            });
        }
        
        // Track API call with timing
        function trackApiCall(section, startTime, success = true, error = null) {
            if (!sectionHealthMetrics[section]) return;
            
            const metrics = sectionHealthMetrics[section];
            const endTime = Date.now();
            metrics.lastApiCall = endTime;
            metrics.apiResponseTime = endTime - startTime;
            
            if (success) {
                metrics.consecutiveErrors = 0;
                metrics.lastUpdated = endTime;
            } else {
                metrics.apiErrors++;
                metrics.consecutiveErrors++;
                if (error) {
                    metrics.message = error.message || 'API Error';
                }
            }
            
            updateSectionHealthStatus(section);
        }
        
        // Track section data update
        function trackSectionUpdate(section, dataCount = 0) {
            if (!sectionHealthMetrics[section]) return;
            
            const metrics = sectionHealthMetrics[section];
            metrics.lastUpdated = Date.now();
            metrics.dataCount = dataCount;
            
            updateSectionHealthStatus(section);
        }
        
        // Define which panels/metrics each section should have and their expected AWS data sources
        const sectionPanelConfig = {
            'overview': {
                panels: ['systemHierarchy'],
                requiredAwsData: false
            },
            'dashboard': {
                panels: ['totalUsers', 'activeUsers', 'premiumUsers', 'totalMatches'],
                requiredAwsData: true,
                panelIds: ['dashTotalUsers', 'dashActiveUsers', 'dashPremiumUsers', 'dashTotalMatches']
            },
            'revenue': {
                panels: ['MRR', 'premiumSubscribers', 'conversionRate', 'churnRate'],
                requiredAwsData: true,
                panelIds: ['mrrValue', 'premiumUsers', 'conversionRate', 'churnRate'],
                dataSourceIndicator: 'revenueDataSource'
            },
            'users': {
                panels: ['totalUsers', 'activeToday', 'premiumUsers', 'userList'],
                requiredAwsData: true,
                panelIds: ['userTotalCount', 'userActiveToday', 'userPremiumCount']
            },
            'matches': {
                panels: ['totalMatches', 'successRate', 'avgMatchTime'],
                requiredAwsData: true,
                panelIds: ['matchTotalCount', 'matchSuccessRate', 'matchAvgTime']
            },
            'analytics': {
                panels: ['retentionRate', 'avgSessionDuration', 'peakHours'],
                requiredAwsData: true
            },
            'realtime': {
                panels: ['activeNow', 'matchingNow', 'messagesPerMinute'],
                requiredAwsData: true,
                hasRealtime: true
            },
            'safety': {
                panels: ['pendingReports', 'blockedUsers', 'flaggedContent'],
                requiredAwsData: true
            },
            'geographic': {
                panels: ['topCities', 'userDistribution'],
                requiredAwsData: true
            },
            'calendar': {
                panels: ['upcomingEvents', 'launchReadiness'],
                requiredAwsData: false
            },
            'expenses': {
                panels: ['totalExpenses', 'monthlyBurn', 'potentialSavings', 'activeServices', 'monthlyPayroll'],
                requiredAwsData: false,
                panelIds: ['totalExpensesToDate', 'monthlyBurn', 'potentialSavings', 'activeServices', 'monthlyPayrollExpense']
            },
            'org-hierarchy': {
                panels: ['employees', 'departments'],
                requiredAwsData: true
            },
            'payroll': {
                panels: ['totalPayroll', 'nextPayDate'],
                requiredAwsData: true
            }
        };
        
        // Check if a panel value indicates valid AWS data vs placeholder
        function isPanelDataValid(value) {
            if (!value || value === '') return false;
            const invalidValues = ['--', '...', 'Loading...', 'N/A', 'Error', 'undefined', 'null', '$--', '--', '0'];
            const strValue = String(value).trim();
            // Allow 0 for some metrics but flag if all are 0
            if (invalidValues.includes(strValue)) return false;
            if (strValue.startsWith('Loading')) return false;
            return true;
        }
        
        // Check panel health for a section
        function checkSectionPanelHealth(section) {
            const config = sectionPanelConfig[section];
            if (!config) return { status: 'green', brokenPanels: 0, totalPanels: 0, issues: [] };
            
            const issues = [];
            let brokenPanels = 0;
            const totalPanels = config.panels?.length || 0;
            
            // Check data source indicator if exists
            if (config.dataSourceIndicator) {
                const sourceEl = document.getElementById(config.dataSourceIndicator);
                if (sourceEl) {
                    const sourceText = sourceEl.textContent?.toLowerCase() || '';
                    if (!sourceText.includes('aws') && !sourceText.includes('stripe') && !sourceText.includes('dynamodb')) {
                        issues.push(`Data not from AWS (source: ${sourceEl.textContent})`);
                    }
                }
            }
            
            // Check individual panel values
            if (config.panelIds) {
                config.panelIds.forEach((panelId, index) => {
                    const el = document.getElementById(panelId);
                    if (el) {
                        const value = el.textContent;
                        if (!isPanelDataValid(value)) {
                            brokenPanels++;
                            const panelName = config.panels[index] || panelId;
                            issues.push(`${panelName}: invalid value "${value}"`);
                        }
                    } else {
                        // Element not found - might not be visible
                    }
                });
            }
            
            // Determine status based on broken panels
            let status = 'green';
            if (brokenPanels > 0) {
                const brokenPercentage = (brokenPanels / totalPanels) * 100;
                if (brokenPercentage >= 50 || brokenPanels >= 3) {
                    status = 'red';
                } else if (brokenPercentage >= 25 || brokenPanels >= 1) {
                    status = 'yellow';
                }
            }
            
            // Check if section requires AWS but isn't getting it
            if (config.requiredAwsData && issues.some(i => i.includes('not from AWS'))) {
                status = status === 'green' ? 'yellow' : status;
            }
            
            return { status, brokenPanels, totalPanels, issues };
        }
        
        // Calculate and update health status for a section
        function updateSectionHealthStatus(section) {
            if (!sectionHealthMetrics[section]) return;
            
            const metrics = sectionHealthMetrics[section];
            const config = sectionConfig[section] || {};
            const now = Date.now();
            
            let status = 'green';
            let message = 'Healthy';
            let panelIssues = [];
            
            // Check consecutive API errors
            if (metrics.consecutiveErrors >= 3) {
                status = 'red';
                message = `${metrics.consecutiveErrors} consecutive errors`;
            } else if (metrics.consecutiveErrors >= 1) {
                status = 'yellow';
                message = 'Recent API error';
            }
            
            // Check data staleness (for real-time sections)
            if (config.hasRealtime && metrics.lastUpdated) {
                const staleness = now - metrics.lastUpdated;
                if (staleness > 120000) { // 2+ minutes stale
                    status = 'red';
                    message = 'Data stale (>2min)';
                } else if (staleness > 60000) { // 1+ minute stale
                    status = status === 'green' ? 'yellow' : status;
                    message = 'Data aging (>1min)';
                }
            }
            
            // Check API response time (lag detection)
            if (metrics.apiResponseTime !== null) {
                if (metrics.apiResponseTime > 5000) { // >5s response
                    status = 'red';
                    message = `Severe lag (${(metrics.apiResponseTime/1000).toFixed(1)}s)`;
                } else if (metrics.apiResponseTime > 2000) { // >2s response
                    status = status === 'green' ? 'yellow' : status;
                    message = `Lag detected (${(metrics.apiResponseTime/1000).toFixed(1)}s)`;
                }
            }
            
            // NEW: Check individual panels for valid AWS data
            if (currentSection === section && metrics.lastUpdated) {
                const panelHealth = checkSectionPanelHealth(section);
                panelIssues = panelHealth.issues;
                
                if (panelHealth.brokenPanels > 0) {
                    // Escalate status based on panel issues
                    if (panelHealth.status === 'red' && status !== 'red') {
                        status = 'red';
                        message = `${panelHealth.brokenPanels}/${panelHealth.totalPanels} panels broken`;
                    } else if (panelHealth.status === 'yellow' && status === 'green') {
                        status = 'yellow';
                        message = `${panelHealth.brokenPanels} panel(s) not showing AWS data`;
                    }
                }
                
                // Store panel issues for detailed reporting
                metrics.panelIssues = panelIssues;
                metrics.brokenPanels = panelHealth.brokenPanels;
                metrics.totalPanels = panelHealth.totalPanels;
            }
            
            // Sections without API don't need real-time tracking
            if (!config.requiresAPI && !config.hasRealtime && metrics.lastUpdated && panelIssues.length === 0) {
                status = 'green';
                message = 'Healthy';
            }
            
            // Never visited = gray
            if (!metrics.lastUpdated && !metrics.lastApiCall) {
                status = 'gray';
                message = 'Not loaded';
            }
            
            metrics.status = status;
            metrics.message = message;
            
            // Update the UI indicator
            updateHealthIndicatorUI(section);
        }
        
        // Update the visual health indicator in the sidebar
        function updateHealthIndicatorUI(section) {
            const indicator = document.getElementById(`health-${section}`);
            if (!indicator) return;
            
            const metrics = sectionHealthMetrics[section];
            if (!metrics) return;
            
            // Remove all status classes
            indicator.classList.remove('green', 'yellow', 'red', 'gray', 'visible');
            
            // Add the current status class and make visible
            indicator.classList.add(metrics.status, 'visible');
            
            // Update tooltip
            updateHealthTooltip(section);
        }
        
        // Create/update tooltip for health indicator
        function updateHealthTooltip(section) {
            const navItem = document.querySelector(`[data-health-section="${section}"]`);
            if (!navItem) return;
            
            const metrics = sectionHealthMetrics[section];
            if (!metrics) return;
            
            // Remove existing tooltip
            let tooltip = navItem.querySelector('.health-tooltip');
            if (!tooltip) {
                tooltip = document.createElement('div');
                tooltip.className = 'health-tooltip';
                navItem.appendChild(tooltip);
            }
            
            const statusClass = metrics.status === 'green' ? 'good' : 
                                metrics.status === 'yellow' ? 'warn' : 
                                metrics.status === 'red' ? 'bad' : '';
            
            const lastUpdatedText = metrics.lastUpdated 
                ? getTimeAgo(metrics.lastUpdated)
                : 'Never';
                
            const responseTimeText = metrics.apiResponseTime !== null
                ? `${metrics.apiResponseTime}ms`
                : 'N/A';
            
            tooltip.innerHTML = `
                <div class="health-tooltip-row">
                    <span class="health-tooltip-label">Status:</span>
                    <span class="health-tooltip-value ${statusClass}">${metrics.message}</span>
                </div>
                <div class="health-tooltip-row">
                    <span class="health-tooltip-label">Last Update:</span>
                    <span class="health-tooltip-value">${lastUpdatedText}</span>
                </div>
                <div class="health-tooltip-row">
                    <span class="health-tooltip-label">Response:</span>
                    <span class="health-tooltip-value">${responseTimeText}</span>
                </div>
                ${metrics.dataCount > 0 ? `
                <div class="health-tooltip-row">
                    <span class="health-tooltip-label">Records:</span>
                    <span class="health-tooltip-value">${metrics.dataCount.toLocaleString()}</span>
                </div>
                ` : ''}
                ${metrics.apiErrors > 0 ? `
                <div class="health-tooltip-row">
                    <span class="health-tooltip-label">Total Errors:</span>
                    <span class="health-tooltip-value bad">${metrics.apiErrors}</span>
                </div>
                ` : ''}
            `;
        }
        
        // Helper: get time ago string
        function getTimeAgo(timestamp) {
            const seconds = Math.floor((Date.now() - timestamp) / 1000);
            if (seconds < 5) return 'Just now';
            if (seconds < 60) return `${seconds}s ago`;
            if (seconds < 3600) return `${Math.floor(seconds/60)}m ago`;
            if (seconds < 86400) return `${Math.floor(seconds/3600)}h ago`;
            return `${Math.floor(seconds/86400)}d ago`;
        }
        
        // Run health checks for all sections
        async function runHealthChecks() {
            // Check AWS connectivity
            const awsOk = await checkAWSConnectivity();
            
            // Update all API-dependent sections based on AWS status
            Object.keys(sectionConfig).forEach(section => {
                const config = sectionConfig[section];
                if (config.requiresAPI && !awsOk) {
                    const metrics = sectionHealthMetrics[section];
                    if (metrics && metrics.status !== 'gray') {
                        metrics.status = 'red';
                        metrics.message = 'AWS unreachable';
                        updateHealthIndicatorUI(section);
                    }
                }
            });
            
            // Check data freshness for sections that have been loaded
            Object.keys(sectionHealthMetrics).forEach(section => {
                if (sectionHealthMetrics[section].lastUpdated) {
                    updateSectionHealthStatus(section);
                }
            });
            
            // Update the site diagnostics panel if it's visible
            if (currentSection === 'site-diagnostics') {
                updateHealthMonitorPanel();
            }
        }
        
        // Start health monitoring
        function startHealthMonitoring() {
            initSectionHealthMetrics();
            
            // Run initial checks
            runHealthChecks();
            
            // Run checks every 30 seconds
            healthMonitorInterval = setInterval(runHealthChecks, 30000);
            
            console.log(' Section health monitoring started');
        }
        
        // Stop health monitoring
        function stopHealthMonitoring() {
            if (healthMonitorInterval) {
                clearInterval(healthMonitorInterval);
                healthMonitorInterval = null;
            }
        }
        
        // Run all health checks and update the Site Diagnostics panel
        async function runAllHealthChecks() {
            console.log(' Running comprehensive health checks...');
            
            // Update status
            const statusBadge = document.getElementById('healthOverallStatus');
            if (statusBadge) {
                statusBadge.textContent = 'Checking...';
                statusBadge.style.background = 'var(--info)';
            }
            
            // Run AWS check
            const awsOk = await checkAWSConnectivity();
            
            // Track all sections that require API
            const apiStartTime = Date.now();
            Object.keys(sectionConfig).forEach(section => {
                const config = sectionConfig[section];
                if (config.requiresAPI) {
                    if (awsOk) {
                        trackApiCall(section, apiStartTime, true);
                    } else {
                        trackApiCall(section, apiStartTime, false, new Error('AWS unreachable'));
                    }
                }
            });
            
            // Update all section statuses including panel checks
            Object.keys(sectionHealthMetrics).forEach(section => {
                // Check panel health for current section
                if (currentSection === section) {
                    const panelHealth = checkSectionPanelHealth(section);
                    const metrics = sectionHealthMetrics[section];
                    if (metrics) {
                        metrics.panelIssues = panelHealth.issues;
                        metrics.brokenPanels = panelHealth.brokenPanels;
                        metrics.totalPanels = panelHealth.totalPanels;
                    }
                }
                updateSectionHealthStatus(section);
            });
            
            // Update the site diagnostics panel
            updateHealthMonitorPanel();
            
            console.log(' Health checks complete');
            console.log(' Panel health summary:', {
                awsConnected: awsOk,
                sectionsChecked: Object.keys(sectionHealthMetrics).length,
                currentSection: currentSection
            });
        }
        
        // Update the health monitor panel in site diagnostics
        function updateHealthMonitorPanel() {
            // Count statuses
            let greenCount = 0, yellowCount = 0, redCount = 0, grayCount = 0;
            const issues = [];
            
            Object.entries(sectionHealthMetrics).forEach(([section, metrics]) => {
                switch (metrics.status) {
                    case 'green': greenCount++; break;
                    case 'yellow': 
                        yellowCount++; 
                        issues.push({ section, severity: 'warning', message: metrics.message });
                        break;
                    case 'red': 
                        redCount++; 
                        issues.push({ section, severity: 'error', message: metrics.message });
                        break;
                    case 'gray': grayCount++; break;
                }
            });
            
            // Update counts
            const greenEl = document.getElementById('healthGreenCount');
            const yellowEl = document.getElementById('healthYellowCount');
            const redEl = document.getElementById('healthRedCount');
            const grayEl = document.getElementById('healthGrayCount');
            
            if (greenEl) greenEl.textContent = greenCount;
            if (yellowEl) yellowEl.textContent = yellowCount;
            if (redEl) redEl.textContent = redCount;
            if (grayEl) grayEl.textContent = grayCount;
            
            // Update overall status
            const statusBadge = document.getElementById('healthOverallStatus');
            if (statusBadge) {
                if (redCount > 0) {
                    statusBadge.textContent = `${redCount} Issues`;
                    statusBadge.style.background = 'var(--danger)';
                } else if (yellowCount > 0) {
                    statusBadge.textContent = `${yellowCount} Warnings`;
                    statusBadge.style.background = 'var(--warning)';
                } else if (greenCount > 0) {
                    statusBadge.textContent = 'All Healthy';
                    statusBadge.style.background = 'var(--success)';
                } else {
                    statusBadge.textContent = 'No Data';
                    statusBadge.style.background = 'var(--text-muted)';
                }
            }
            
            // Render section grid
            const gridContainer = document.getElementById('healthSectionGrid');
            if (gridContainer) {
                const sectionLabels = {
                    'overview': ' Overview',
                    'dashboard': ' Dashboard',
                    'analytics': ' Analytics & AI',
                    'mlmodels': ' ML Models',
                    'revenue': ' Revenue',
                    'geographic': ' Geographic',
                    'legal': ' Patents & IP',
                    'compliance': ' Compliance',
                    'database': ' Database',
                    'experiments': ' Experiments',
                    'org-hierarchy': ' Hierarchy',
                    'payroll': ' Payroll',
                    'tax': ' Tax',
                    'expenses': ' Expenses',
                    'calendar': ' Calendar',
                    'simulation': ' Stress Test',
                    'users': ' Users',
                    'matches': ' Matches',
                    'funnel': ' Funnel',
                    'realtime': ' Real-time',
                    'safety': ' Safety',
                    'feedback': ' Feedback',
                    'testbots': ' Test Bots',
                    'diagnostics': ' Diagnostics',
                    'site-diagnostics': ' Site Diag',
                    'compliance-app': ' App Compliance'
                };
                
                gridContainer.innerHTML = Object.entries(sectionHealthMetrics).map(([section, metrics]) => {
                    const label = sectionLabels[section] || section;
                    const statusColor = metrics.status === 'green' ? 'var(--success)' :
                                       metrics.status === 'yellow' ? 'var(--warning)' :
                                       metrics.status === 'red' ? 'var(--danger)' : 'var(--text-muted)';
                    const statusIcon = metrics.status === 'green' ? '' :
                                      metrics.status === 'yellow' ? '' :
                                      metrics.status === 'red' ? '' : '';
                    
                    const lastUpdate = metrics.lastUpdated ? getTimeAgo(metrics.lastUpdated) : 'Never';
                    const responseTime = metrics.apiResponseTime !== null ? `${metrics.apiResponseTime}ms` : '--';
                    
                    // Panel health info
                    const panelConfig = sectionPanelConfig[section];
                    const hasPanels = panelConfig?.panels?.length > 0;
                    const panelInfo = hasPanels && metrics.totalPanels > 0 
                        ? `${metrics.totalPanels - (metrics.brokenPanels || 0)}/${metrics.totalPanels} panels OK` 
                        : '';
                    const panelColor = (metrics.brokenPanels || 0) > 0 ? 'var(--warning)' : 'var(--success)';
                    const awsRequired = panelConfig?.requiredAwsData ? '' : '';
                    
                    return `
                        <div style="padding: 10px; background: var(--bg-tertiary); border-radius: 8px; border-left: 3px solid ${statusColor}; cursor: pointer;" 
                             onclick="showSection('${section}')" title="Click to navigate">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                                <span style="font-weight: 500; font-size: 0.8rem;">${label} ${awsRequired}</span>
                                <span style="font-size: 0.9rem;">${statusIcon}</span>
                            </div>
                            <div style="font-size: 0.7rem; color: var(--text-muted);">
                                <div style="display: flex; justify-content: space-between;">
                                    <span>Updated:</span>
                                    <span>${lastUpdate}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span>Response:</span>
                                    <span>${responseTime}</span>
                                </div>
                                ${panelInfo ? `
                                <div style="display: flex; justify-content: space-between;">
                                    <span>Panels:</span>
                                    <span style="color: ${panelColor};">${panelInfo}</span>
                                </div>
                                ` : ''}
                                <div style="display: flex; justify-content: space-between;">
                                    <span>Status:</span>
                                    <span style="color: ${statusColor};">${metrics.message}</span>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            // Render issues list with detailed panel information
            const issuesList = document.getElementById('healthIssuesList');
            if (issuesList) {
                if (issues.length === 0) {
                    issuesList.innerHTML = '<div style="color: var(--success); font-size: 0.8rem;"> No issues detected - all sections showing accurate AWS data!</div>';
                } else {
                    issuesList.innerHTML = issues.map(issue => {
                        const icon = issue.severity === 'error' ? '' : '';
                        const color = issue.severity === 'error' ? 'var(--danger)' : 'var(--warning)';
                        const metrics = sectionHealthMetrics[issue.section];
                        
                        // Show panel-level issues if available
                        let panelDetails = '';
                        if (metrics?.panelIssues && metrics.panelIssues.length > 0) {
                            panelDetails = `
                                <div style="margin-top: 4px; padding-left: 20px; font-size: 0.7rem; color: var(--text-muted);">
                                    ${metrics.panelIssues.slice(0, 3).map(pi => `<div> ${pi}</div>`).join('')}
                                    ${metrics.panelIssues.length > 3 ? `<div>...and ${metrics.panelIssues.length - 3} more</div>` : ''}
                                </div>
                            `;
                        }
                        
                        return `
                            <div style="padding: 8px 0; border-bottom: 1px solid var(--border);">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span style="font-size: 0.9rem;">${icon}</span>
                                    <span style="font-weight: 500; min-width: 120px; color: ${color};">${issue.section}</span>
                                    <span style="font-size: 0.8rem; color: var(--text-muted);">${issue.message}</span>
                                    <button class="btn btn-secondary" onclick="showSection('${issue.section}')" 
                                            style="margin-left: auto; font-size: 0.7rem; padding: 2px 8px;">View</button>
                                </div>
                                ${panelDetails}
                            </div>
                        `;
                    }).join('');
                }
            }
        }
        
        function initHierarchy() {
            // Restore expanded state from localStorage
            const wasExpanded = localStorage.getItem('oith_hierarchy_expanded') === 'true';
            if (wasExpanded) {
                document.getElementById('hierarchyBody').classList.add('expanded');
                document.getElementById('hierarchyToggle').classList.add('expanded');
            }
            
            // Run comprehensive diagnostics on User App components
            runUserAppDiagnostics();
            
            // Update counts
            updateHierarchyStatusCounts();
            
            // Update safety status based on pending reports
            updateSafetyHierarchyStatus();
        }
        
        // Comprehensive User App component health checker
        // Store previous diagnostic results to detect changes
        let previousDiagnostics = JSON.parse(localStorage.getItem('oith_admin_diagnostics') || '{}');
        let fileModificationTimes = JSON.parse(localStorage.getItem('oith_file_mod_times') || '{}');
        
        async function runUserAppDiagnostics() {
            const diagnosticResults = {};
            
            // Check if index.html exists and is accessible, and get modification time
            const indexCheck = await checkFileWithTimestamp('index.html');
            const appJsCheck = await checkFileWithTimestamp('app.js');
            const stylesCheck = await checkFileWithTimestamp('styles.css');
            
            const indexExists = indexCheck.exists;
            const appJsExists = appJsCheck.exists;
            const stylesExist = stylesCheck.exists;
            
            // Detect file changes - if files were updated, clear related warnings
            const filesUpdated = detectFileChanges({
                'index.html': indexCheck.lastModified,
                'app.js': appJsCheck.lastModified,
                'styles.css': stylesCheck.lastModified
            });
            
            // Core dependencies check
            const coreDependencies = {
                'index.html': indexExists,
                'app.js': appJsExists,
                'styles.css': stylesExist
            };
            
            // Component status mapping based on diagnostics
            const componentChecks = {
                // Entry & Auth
                'splash': { 
                    check: () => indexExists && appJsExists,
                    dependencies: ['index.html', 'app.js'],
                    description: 'Splash Screen'
                },
                'login': { 
                    check: () => indexExists && appJsExists && checkLocalStorageAvailable(),
                    dependencies: ['index.html', 'app.js', 'localStorage'],
                    description: 'Login Screen'
                },
                'signup': { 
                    check: () => indexExists && appJsExists && checkLocalStorageAvailable(),
                    dependencies: ['index.html', 'app.js', 'localStorage'],
                    description: 'Sign Up Screen'
                },
                
                // Onboarding Flow
                'onboarding': { 
                    check: () => appJsExists,
                    dependencies: ['app.js'],
                    description: 'Onboarding Intro'
                },
                'preferences': { 
                    check: () => appJsExists && checkLocalStorageAvailable(),
                    dependencies: ['app.js', 'localStorage'],
                    description: 'Preferences Setup'
                },
                'profile-details': { 
                    check: () => appJsExists,
                    dependencies: ['app.js'],
                    description: 'Profile Details'
                },
                'profile-setup': { 
                    check: () => appJsExists,
                    dependencies: ['app.js'],
                    description: 'Photo Upload'
                },
                'payment': { 
                    check: () => appJsExists,
                    dependencies: ['app.js'],
                    description: 'Payment Screen'
                },
                
                // Main App Features
                'match': { 
                    check: () => appJsExists && checkLocalStorageAvailable(),
                    dependencies: ['app.js', 'localStorage', 'algorithm'],
                    description: 'Match Screen'
                },
                'waiting-match': { 
                    check: () => appJsExists,
                    dependencies: ['app.js'],
                    description: 'Waiting State'
                },
                'no-matches': { 
                    check: () => appJsExists,
                    dependencies: ['app.js'],
                    description: 'No Matches State'
                },
                'profile-view': { 
                    check: () => appJsExists,
                    dependencies: ['app.js'],
                    description: 'Profile View'
                },
                
                // Communication
                'chat-list': { 
                    check: () => appJsExists && checkLocalStorageAvailable(),
                    dependencies: ['app.js', 'localStorage'],
                    description: 'Chat List'
                },
                'chat': { 
                    check: () => appJsExists && checkLocalStorageAvailable(),
                    dependencies: ['app.js', 'localStorage'],
                    description: 'Chat Screen'
                },
                'date-plan': { 
                    check: () => appJsExists,
                    dependencies: ['app.js'],
                    description: 'Date Planning'
                },
                
                // Profile Management
                'my-profile': { 
                    check: () => appJsExists && checkLocalStorageAvailable(),
                    dependencies: ['app.js', 'localStorage'],
                    description: 'My Profile'
                },
                'edit-profile': { 
                    check: () => appJsExists && checkLocalStorageAvailable(),
                    dependencies: ['app.js', 'localStorage'],
                    description: 'Edit Profile'
                },
                'manage-photos': { 
                    check: () => appJsExists,
                    dependencies: ['app.js'],
                    description: 'Photo Management'
                },
                'match-preferences-edit': { 
                    check: () => appJsExists && checkLocalStorageAvailable(),
                    dependencies: ['app.js', 'localStorage'],
                    description: 'Match Preferences'
                },
                
                // Settings
                'settings': { 
                    check: () => appJsExists && checkLocalStorageAvailable(),
                    dependencies: ['app.js', 'localStorage'],
                    description: 'Settings'
                },
                'safety-privacy': { 
                    check: () => appJsExists,
                    dependencies: ['app.js'],
                    description: 'Privacy Settings'
                },
                'manage-subscription': { 
                    check: () => appJsExists && checkLocalStorageAvailable(),
                    dependencies: ['app.js', 'localStorage'],
                    description: 'Subscription'
                },
                'feedback-metrics': { 
                    check: () => appJsExists,
                    dependencies: ['app.js'],
                    description: 'Feedback Screen',
                    isBeta: true
                }
            };
            
            // Run checks and update status lights
            for (const [componentId, config] of Object.entries(componentChecks)) {
                let status = 'green';
                let issues = [];
                
                // Check core dependencies
                if (!indexExists) {
                    status = 'red';
                    issues.push('index.html missing');
                }
                if (!appJsExists) {
                    status = 'red';
                    issues.push('app.js missing');
                }
                
                // Run component-specific check
                if (status !== 'red') {
                    try {
                        const checkResult = config.check();
                        if (!checkResult) {
                            status = 'yellow';
                            issues.push('Dependency check failed');
                        }
                    } catch (e) {
                        status = 'yellow';
                        issues.push('Check error: ' + e.message);
                    }
                }
                
                // Mark beta features
                if (config.isBeta) {
                    status = 'gray';
                }
                
                // Store result
                diagnosticResults[componentId] = {
                    status,
                    issues,
                    dependencies: config.dependencies
                };
                
                // Update the UI
                updateUserAppNodeStatus(componentId, status, issues);
            }
            
            // Store diagnostic results for debugging
            window.userAppDiagnostics = diagnosticResults;
            
            // Compare with previous diagnostics and notify about fixes
            let fixedCount = 0;
            for (const [componentId, result] of Object.entries(diagnosticResults)) {
                const prevResult = previousDiagnostics[componentId];
                if (prevResult) {
                    // If status improved from red/yellow to green, it was fixed
                    if ((prevResult.status === 'red' || prevResult.status === 'yellow') && result.status === 'green') {
                        fixedCount++;
                        clearComponentNotification(componentId);
                    }
                }
            }
            
            // Save current diagnostics for next comparison
            previousDiagnostics = diagnosticResults;
            localStorage.setItem('oith_admin_diagnostics', JSON.stringify(diagnosticResults));
            
            // Log summary
            const greenCount = Object.values(diagnosticResults).filter(r => r.status === 'green').length;
            const yellowCount = Object.values(diagnosticResults).filter(r => r.status === 'yellow').length;
            const redCount = Object.values(diagnosticResults).filter(r => r.status === 'red').length;
            const grayCount = Object.values(diagnosticResults).filter(r => r.status === 'gray').length;
            
            console.log(` User App Diagnostics: ${greenCount} OK, ${yellowCount} Warning, ${redCount} Error, ${grayCount} Beta/Offline`);
            if (fixedCount > 0) {
                console.log(` ${fixedCount} issue(s) have been resolved since last check!`);
            }
            
            return diagnosticResults;
        }
        
        // Check if a file exists and get last modified time
        async function checkFileWithTimestamp(filename) {
            try {
                const response = await fetch(filename + '?t=' + Date.now(), { method: 'HEAD' });
                const lastModified = response.headers.get('Last-Modified');
                return {
                    exists: response.ok,
                    lastModified: lastModified || new Date().toISOString()
                };
            } catch (e) {
                return { exists: false, lastModified: null };
            }
        }
        
        // Check if a file exists via fetch (legacy support)
        async function checkFileExists(filename) {
            const result = await checkFileWithTimestamp(filename);
            return result.exists;
        }
        
        // Detect if files have been modified since last check
        function detectFileChanges(currentTimes) {
            const changes = [];
            for (const [file, time] of Object.entries(currentTimes)) {
                if (time && fileModificationTimes[file] && time !== fileModificationTimes[file]) {
                    changes.push(file);
                    console.log(` File updated: ${file}`);
                }
            }
            
            // Update stored modification times
            fileModificationTimes = { ...fileModificationTimes, ...currentTimes };
            localStorage.setItem('oith_file_mod_times', JSON.stringify(fileModificationTimes));
            
            return changes;
        }
        
        // Check if localStorage is available
        function checkLocalStorageAvailable() {
            try {
                localStorage.setItem('_test', '1');
                localStorage.removeItem('_test');
                return true;
            } catch (e) {
                return false;
            }
        }
        
        // Clear notifications for a specific component when it's been updated/fixed
        function clearComponentNotification(componentId) {
            const prevStatus = previousDiagnostics[componentId]?.status;
            if (prevStatus === 'red' || prevStatus === 'yellow') {
                console.log(` Notification cleared for ${componentId} - issue resolved`);
                showToast(` ${componentId} has been fixed!`, 'success');
            }
        }
        
        // Show a toast notification
        function showToast(message, type = 'info') {
            // Create toast container if it doesn't exist
            let toastContainer = document.getElementById('toastContainer');
            if (!toastContainer) {
                toastContainer = document.createElement('div');
                toastContainer.id = 'toastContainer';
                toastContainer.style.cssText = 'position: fixed; top: 80px; right: 20px; z-index: 10000; display: flex; flex-direction: column; gap: 8px;';
                document.body.appendChild(toastContainer);
            }
            
            const toast = document.createElement('div');
            const bgColor = type === 'success' ? 'var(--success)' : type === 'error' ? 'var(--danger)' : 'var(--info)';
            toast.style.cssText = `background: ${bgColor}; color: white; padding: 12px 20px; border-radius: 8px; font-size: 0.875rem; box-shadow: 0 4px 12px rgba(0,0,0,0.3); animation: slideIn 0.3s ease;`;
            toast.textContent = message;
            toastContainer.appendChild(toast);
            
            // Auto-remove after 4 seconds
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        }
        
        // Update User App flow node status
        function updateUserAppNodeStatus(componentId, status, issues = []) {
            const nodes = document.querySelectorAll(`[data-component="${componentId}"]`);
            nodes.forEach(node => {
                const statusLight = node.querySelector('.node-status');
                if (statusLight) {
                    // Remove all status classes
                    statusLight.classList.remove('green', 'yellow', 'red', 'gray');
                    // Add new status
                    statusLight.classList.add(status);
                    
                    // Add tooltip with issues if any
                    if (issues.length > 0) {
                        node.title = `Issues: ${issues.join(', ')}`;
                    } else {
                        node.title = status === 'green' ? 'Operational' : 
                                     status === 'gray' ? 'Beta/Not Implemented' : 
                                     'Status: ' + status;
                    }
                }
            });
        }
        
        function updateSafetyHierarchyStatus() {
            // This will be called when reports data changes
            const pendingReports = reports.filter(r => r.status === 'pending').length;
            if (pendingReports > 0) {
                const safetyItem = document.querySelector('[data-component="safety"]');
                if (safetyItem) {
                    const light = safetyItem.querySelector('.status-light');
                    const statusBadge = safetyItem.querySelector('.hierarchy-item-status');
                    light.className = 'status-light red';
                    statusBadge.className = 'hierarchy-item-status error';
                    statusBadge.textContent = pendingReports + ' Pending';
                }
            }
            updateHierarchyStatusCounts();
        }
        
        // ==========================================
        // CROSS-DEVICE DATA SYNC
        // ==========================================
        
        // Export all localStorage data to a JSON file for sharing via OneDrive
        // Sync file configuration - always uses same filename for consistent sync
        const SYNC_FILE_NAME = 'data/oith_sync_data.json';
        let syncFileHandle = null; // Store file handle for repeated saves
        let syncDirectoryHandle = null; // Store directory handle for the data folder
        
        // Export sync data - overwrites the same file each time
        async function exportSyncData() {
            const syncData = {
                exportedAt: new Date().toISOString(),
                exportedFrom: navigator.userAgent,
                version: '1.0',
                registeredUsers: {},
                userData: {},
                reports: [],
                supportMessages: [],
                blockedUsers: [],
                testBots: [],
                orgData: {},
                payrollData: {}
            };
            
            // Get registered users
            try {
                const regUsers = localStorage.getItem('oith_registered_users');
                if (regUsers) syncData.registeredUsers = JSON.parse(regUsers);
            } catch(e) {}
            
            // Get all user data
            Object.keys(syncData.registeredUsers).forEach(email => {
                const key = 'oith_user_' + email.replace(/[^a-zA-Z0-9]/g, '_');
                try {
                    const data = localStorage.getItem(key);
                    if (data) syncData.userData[email] = JSON.parse(data);
                } catch(e) {}
            });
            
            // Get reports
            try {
                const r = localStorage.getItem('oith_reports');
                if (r) syncData.reports = JSON.parse(r);
            } catch(e) {}
            
            // Get support messages
            try {
                const m = localStorage.getItem('oith_support_messages');
                if (m) syncData.supportMessages = JSON.parse(m);
            } catch(e) {}
            
            // Get blocked users
            try {
                const b = localStorage.getItem('oith_blocked_users');
                if (b) syncData.blockedUsers = JSON.parse(b);
            } catch(e) {}
            
            // Get test bots
            try {
                const t = localStorage.getItem('oith_test_bots');
                if (t) syncData.testBots = JSON.parse(t);
            } catch(e) {}
            
            // Get org data
            try {
                const o = localStorage.getItem('oith_org_data');
                if (o) syncData.orgData = JSON.parse(o);
            } catch(e) {}
            
            // Get payroll data
            try {
                const p = localStorage.getItem('oith_payroll_data');
                if (p) syncData.payrollData = JSON.parse(p);
            } catch(e) {}
            
            const jsonContent = JSON.stringify(syncData, null, 2);
            const userCount = Object.keys(syncData.registeredUsers).length;
            
            // Try File System Access API first (Chrome/Edge) for direct overwrite
            if ('showSaveFilePicker' in window && syncFileHandle) {
                try {
                    const writable = await syncFileHandle.createWritable();
                    await writable.write(jsonContent);
                    await writable.close();
                    showToast(` Synced ${userCount} users (auto-saved)`, 'success');
                    console.log(' Auto-saved to existing file handle');
                    return;
                } catch (e) {
                    console.log('File handle expired, will prompt for new location');
                    syncFileHandle = null;
                }
            }
            
            // Try to use stored directory handle first (for seamless subsequent saves)
            if (syncDirectoryHandle) {
                try {
                    const fileHandle = await syncDirectoryHandle.getFileHandle('oith_sync_data.json', { create: true });
                    const writable = await fileHandle.createWritable();
                    await writable.write(jsonContent);
                    await writable.close();
                    showToast(` Auto-saved ${userCount} users to data folder!`, 'success');
                    console.log(' Auto-saved to stored directory handle');
                    return;
                } catch (e) {
                    console.log('Stored directory handle failed, will re-prompt');
                    syncDirectoryHandle = null;
                }
            }
            
            // Try to get directory handle for the data folder (one-time setup)
            if ('showDirectoryPicker' in window) {
                try {
                    showToast(' Select the "data" folder in prototype...', 'info');
                    syncDirectoryHandle = await window.showDirectoryPicker({
                        id: 'oith-data-folder',
                        mode: 'readwrite',
                        startIn: 'documents'
                    });
                    
                    // Save the file to the selected directory
                    const fileHandle = await syncDirectoryHandle.getFileHandle('oith_sync_data.json', { create: true });
                    const writable = await fileHandle.createWritable();
                    await writable.write(jsonContent);
                    await writable.close();
                    
                    showToast(` Exported ${userCount} users. Future exports will auto-save!`, 'success');
                    console.log(' Saved to data folder and stored directory handle');
                    return;
                } catch (e) {
                    if (e.name !== 'AbortError') {
                        console.log('Directory picker failed, using download fallback');
                    }
                }
            }
            
            // Fallback to regular download (user must manually place in data folder)
            const blob = new Blob([jsonContent], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'oith_sync_data.json';
            a.click();
            URL.revokeObjectURL(url);
            
            showToast(` Exported ${userCount} users. Move file to prototype/data/ folder!`, 'success');
        }
        
        // Import sync data - automatically fetches from the sync file location
        async function importSyncData() {
            showToast(' Loading sync data...', 'info');
            
            try {
                let syncData = null;
                
                // First, try to use stored directory handle if available
                if (syncDirectoryHandle) {
                    try {
                        const fileHandle = await syncDirectoryHandle.getFileHandle('oith_sync_data.json');
                        const file = await fileHandle.getFile();
                        const text = await file.text();
                        syncData = JSON.parse(text);
                        console.log(' Loaded from stored directory handle');
                    } catch (e) {
                        console.log('Could not read from stored handle, trying fetch...');
                    }
                }
                
                // Try to fetch from the standard data folder location
                if (!syncData) {
                    const response = await fetch(SYNC_FILE_NAME + '?t=' + Date.now());
                    
                    if (!response.ok) {
                        throw new Error('Sync file not found in data folder. Export data first!');
                    }
                    
                    syncData = await response.json();
                }
                
                // Validate structure
                if (!syncData.registeredUsers) {
                    throw new Error('Invalid sync file format');
                }
                
                // Import all data
                applySyncData(syncData);
                
                const userCount = Object.keys(syncData.registeredUsers).length;
                const exportDate = syncData.exportedAt ? new Date(syncData.exportedAt).toLocaleString() : 'unknown';
                showToast(` Imported ${userCount} users (exported: ${exportDate})`, 'success');
                
                // Reload UI
                loadAllData();
                platformData = calculatePlatformStats();
                if (currentSection === 'dashboard') renderDashboard();
                if (currentSection === 'overview') renderOverview();
                updateBadgeCounts();
                
            } catch (err) {
                console.error('Import error:', err);
                showToast(' ' + err.message, 'error');
            }
        }
        
        // Apply sync data to localStorage
        function applySyncData(syncData) {
            // Import registered users
            localStorage.setItem('oith_registered_users', JSON.stringify(syncData.registeredUsers || {}));
            
            // Import user data
            Object.entries(syncData.userData || {}).forEach(([email, data]) => {
                const key = 'oith_user_' + email.replace(/[^a-zA-Z0-9]/g, '_');
                localStorage.setItem(key, JSON.stringify(data));
            });
            
            // Import reports
            if (syncData.reports) {
                localStorage.setItem('oith_reports', JSON.stringify(syncData.reports));
            }
            
            // Import support messages
            if (syncData.supportMessages) {
                localStorage.setItem('oith_support_messages', JSON.stringify(syncData.supportMessages));
            }
            
            // Import blocked users
            if (syncData.blockedUsers) {
                localStorage.setItem('oith_blocked_users', JSON.stringify(syncData.blockedUsers));
            }
            
            // Import test bots
            if (syncData.testBots) {
                localStorage.setItem('oith_test_bots', JSON.stringify(syncData.testBots));
            }
            
            // Import org data
            if (syncData.orgData) {
                localStorage.setItem('oith_org_data', JSON.stringify(syncData.orgData));
            }
            
            // Import payroll data
            if (syncData.payrollData) {
                localStorage.setItem('oith_payroll_data', JSON.stringify(syncData.payrollData));
            }
            
            console.log(' Sync data applied to localStorage');
        }
        
        // Try to auto-load sync data from the prototype folder on page load
        async function tryAutoSync() {
            try {
                const response = await fetch(SYNC_FILE_NAME + '?t=' + Date.now());
                if (response.ok) {
                    const syncData = await response.json();
                    const localUsers = localStorage.getItem('oith_registered_users');
                    const localCount = localUsers ? Object.keys(JSON.parse(localUsers)).length : 0;
                    const syncCount = Object.keys(syncData.registeredUsers || {}).length;
                    
                    // Sync if file has more users OR if it's newer (check timestamp)
                    const localExportTime = localStorage.getItem('oith_last_sync_time');
                    const fileExportTime = syncData.exportedAt;
                    const shouldSync = syncCount > localCount || 
                                       (fileExportTime && (!localExportTime || new Date(fileExportTime) > new Date(localExportTime)));
                    
                    if (shouldSync) {
                        console.log(` Auto-syncing: file has ${syncCount} users, local has ${localCount}`);
                        
                        // Apply sync data
                        applySyncData(syncData);
                        
                        // Store sync timestamp
                        localStorage.setItem('oith_last_sync_time', syncData.exportedAt);
                        
                        showToast(` Auto-synced ${syncCount} users from shared data`, 'info');
                        return true;
                    } else {
                        console.log(` Local data is current (${localCount} users)`);
                    }
                }
            } catch (e) {
                // No sync file or fetch failed - that's okay
                console.log('No sync file found (this is normal if not set up)');
            }
            return false;
        }
        
        // ==========================================
        // DATA & STATE
        // ==========================================
        
        let registeredUsers = {};
        let allUserData = {};
        let reports = [];
        let supportMessages = [];
        let blockedUsers = [];
        
        // Pricing configuration - used across the dashboard (avoids hardcoded prices)
        const pricingConfig = {
            subscriptionPrice: 10.00, // Monthly subscription price in USD
            yearlyPrice: 79.99        // Yearly subscription price in USD
        };
        
        // Platform data - will be calculated from real data
        let platformData = {
            totalUsers: 0,
            activeUsers: 0,
            premiumUsers: 0,
            totalMatches: 0,
            acceptedMatches: 0,
            declinedMatches: 0,
            totalMessages: 0,
            datesPlanned: 0,
            datesCompleted: 0,
            mrr: 0,
            avgCompatibility: 0,
            responseRate: 0,
            avgTimeToDate: 0
        };

        // ==========================================
        // INITIALIZATION
        // ==========================================
        
        // AWS Sync Traffic Tracking
        let syncTraffic = {
            uploads: 0,
            downloads: 0,
            bytesUp: 0,
            bytesDown: 0
        };

        let awsSyncStatus = {
            lastSend: null,
            lastSendOk: null,
            lastSendMessage: '',
            lastReceive: null,
            lastReceiveOk: null,
            lastReceiveMessage: ''
        };

        // Connection error tracking for architecture diagram
        let connectionErrors = {
            aws: false,
            index: false,
            awsMessage: '',
            indexMessage: ''
        };

        // Update architecture diagram node status based on connection errors
        function updateArchitectureNodeStatus() {
            // Get all nodes with data-connection attribute
            const nodes = document.querySelectorAll('[data-connection]');
            
            nodes.forEach(node => {
                const connectionType = node.getAttribute('data-connection');
                const statusLight = node.querySelector('.node-status');
                
                if (!statusLight) return;
                
                // Check if this connection type has an error
                let hasError = false;
                if (connectionType === 'aws' && connectionErrors.aws) {
                    hasError = true;
                } else if (connectionType === 'index' && connectionErrors.index) {
                    hasError = true;
                }
                // 'local' connections never show errors (they're local files)
                
                // Update the status light
                if (hasError) {
                    statusLight.classList.add('error');
                    statusLight.title = connectionType === 'aws' 
                        ? `AWS Error: ${connectionErrors.awsMessage}` 
                        : `App Error: ${connectionErrors.indexMessage}`;
                } else {
                    statusLight.classList.remove('error');
                    statusLight.title = '';
                }
            });
            
            // Update error count display
            updateArchitectureErrorCount();
        }

        // Count and display errors in architecture section
        function updateArchitectureErrorCount() {
            const errorLights = document.querySelectorAll('.tree-diagram .node-status.error').length;
            const countEl = document.getElementById('hierRedCount');
            if (countEl) {
                countEl.textContent = errorLights;
            }
            
            // Update green/yellow counts to 0 since we're only showing errors now
            const greenEl = document.getElementById('hierGreenCount');
            const yellowEl = document.getElementById('hierYellowCount');
            if (greenEl) greenEl.textContent = '';
            if (yellowEl) yellowEl.textContent = '';
        }

        // Set AWS connection error state
        function setAwsConnectionError(hasError, message = '') {
            connectionErrors.aws = hasError;
            connectionErrors.awsMessage = message;
            updateArchitectureNodeStatus();
        }

        // Set index.html (app) connection error state
        function setIndexConnectionError(hasError, message = '') {
            connectionErrors.index = hasError;
            connectionErrors.indexMessage = message;
            updateArchitectureNodeStatus();
        }
        
        function trackSyncUpload(bytes) {
            syncTraffic.uploads++;
            syncTraffic.bytesUp += bytes || 0;
            updateSyncTrafficUI();
        }
        
        function trackSyncDownload(bytes) {
            syncTraffic.downloads++;
            syncTraffic.bytesDown += bytes || 0;
            updateSyncTrafficUI();
        }
        
        function updateSyncTrafficUI() {
            const uploadEl = document.getElementById('uploadCount');
            const downloadEl = document.getElementById('downloadCount');
            const bytesEl = document.getElementById('totalSyncBytes');
            
            if (uploadEl) uploadEl.textContent = syncTraffic.uploads;
            if (downloadEl) downloadEl.textContent = syncTraffic.downloads;
            if (bytesEl) {
                const totalBytes = syncTraffic.bytesUp + syncTraffic.bytesDown;
                if (totalBytes >= 1048576) {
                    bytesEl.textContent = (totalBytes / 1048576).toFixed(2) + ' MB';
                } else if (totalBytes >= 1024) {
                    bytesEl.textContent = (totalBytes / 1024).toFixed(1) + ' KB';
                } else {
                    bytesEl.textContent = totalBytes + ' B';
                }
            }
        }

        function formatSyncTimestamp(value) {
            if (!value) return '--';
            const date = value instanceof Date ? value : new Date(value);
            return date.toLocaleTimeString();
        }

        function updateAwsSyncStatusUI() {
            const recvEl = document.getElementById('awsLastReceive');
            const sendEl = document.getElementById('awsLastSend');
            const dotEl = document.getElementById('awsSyncDot');
            const indicatorEl = document.getElementById('awsSyncIndicator');

            const setStatus = (el, timestamp, ok, message) => {
                if (!el) return;
                if (!timestamp) {
                    el.textContent = '--';
                    el.className = 'aws-status muted';
                    return;
                }
                const statusText = `${formatSyncTimestamp(timestamp)} (${message || (ok ? 'success' : 'failed')})`;
                el.textContent = statusText;
                el.className = `aws-status ${ok === false ? 'error' : 'success'}`;
            };

            setStatus(recvEl, awsSyncStatus.lastReceive, awsSyncStatus.lastReceiveOk, awsSyncStatus.lastReceiveMessage);
            setStatus(sendEl, awsSyncStatus.lastSend, awsSyncStatus.lastSendOk, awsSyncStatus.lastSendMessage);

            const hasFailure = awsSyncStatus.lastReceiveOk === false || awsSyncStatus.lastSendOk === false;
            if (dotEl) {
                if (hasFailure) {
                    dotEl.style.background = 'var(--danger)';
                } else if (awsSyncStatus.lastReceive || awsSyncStatus.lastSend) {
                    dotEl.style.background = 'var(--success)';
                } else {
                    dotEl.style.background = 'var(--text-muted)';
                }
            }

            if (indicatorEl) {
                if (hasFailure) {
                    indicatorEl.style.borderColor = 'rgba(239, 68, 68, 0.3)';
                    indicatorEl.style.color = 'var(--danger)';
                    indicatorEl.style.background = 'rgba(239, 68, 68, 0.1)';
                } else {
                    indicatorEl.style.borderColor = 'rgba(34, 197, 94, 0.3)';
                    indicatorEl.style.color = 'var(--success)';
                    indicatorEl.style.background = 'rgba(34, 197, 94, 0.1)';
                }
            }
        }

        function recordAwsReceive(ok, message) {
            awsSyncStatus.lastReceive = Date.now();
            awsSyncStatus.lastReceiveOk = ok;
            awsSyncStatus.lastReceiveMessage = message || (ok ? 'success' : 'failed');
            updateAwsSyncStatusUI();
        }

        function recordAwsSend(ok, message) {
            awsSyncStatus.lastSend = Date.now();
            awsSyncStatus.lastSendOk = ok;
            awsSyncStatus.lastSendMessage = message || (ok ? 'success' : 'failed');
            updateAwsSyncStatusUI();
        }

        updateAwsSyncStatusUI();
        
        // Auto-refresh timer for users section
        let autoRefreshInterval = null;
        const AUTO_REFRESH_SECONDS = 15; // Refresh every 15 seconds
        
        function startAutoRefresh() {
            if (autoRefreshInterval) clearInterval(autoRefreshInterval);
            
            autoRefreshInterval = setInterval(() => {
                if (currentSection === 'users') {
                    console.log(' Auto-refreshing user data...');
                    loadAllData();
                    renderUsers();
                    updateLastRefreshTime();
                }
                
                // Always check for file changes to clear notifications when issues are fixed
                runUserAppDiagnostics().then(() => {
                    updateHierarchyStatusCounts();
                });
            }, AUTO_REFRESH_SECONDS * 1000);
            
            // Also run diagnostics every 10 seconds specifically to catch file changes
            setInterval(() => {
                runUserAppDiagnostics().then(() => {
                    updateHierarchyStatusCounts();
                });
            }, 10000);
        }
        
        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
        }
        
        function updateLastRefreshTime() {
            const el = document.getElementById('lastRefreshTime');
            if (el) {
                el.textContent = new Date().toLocaleTimeString();
            }
        }
        
        // ==========================================
        // Cross-Tab Sync (Real-time sync with App)
        // ==========================================
        const oithSyncChannel = new BroadcastChannel('oith_sync');
        
        // BroadcastChannel monitoring state
        let bcMessagesSent = 0;
        let bcMessagesReceived = 0;
        let bcLastPingTime = null;
        let bcLastPongTime = null;
        let bcAppConnected = false;
        let bcMessageLog = [];
        
        // Add message to broadcast log
        function logBroadcastMessage(direction, type, data) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = { timestamp, direction, type, data };
            bcMessageLog.unshift(logEntry);
            if (bcMessageLog.length > 50) bcMessageLog.pop(); // Keep last 50 messages
            
            // Update log display if on site diagnostics
            const logEl = document.getElementById('bcMessageLog');
            if (logEl) {
                const icon = direction === 'sent' ? '' : '';
                const color = direction === 'sent' ? 'var(--info)' : 'var(--success)';
                let html = '';
                bcMessageLog.slice(0, 20).forEach(entry => {
                    const entryIcon = entry.direction === 'sent' ? '' : '';
                    const entryColor = entry.direction === 'sent' ? 'var(--info)' : 'var(--success)';
                    html += `<div style="margin-bottom: 4px; color: ${entryColor};">${entryIcon} <span style="color: var(--text-muted);">[${entry.timestamp}]</span> <strong>${entry.type}</strong> ${entry.data ? JSON.stringify(entry.data).substring(0, 60) : ''}</div>`;
                });
                logEl.innerHTML = html || '<div style="color: var(--text-muted);">// No messages yet...</div>';
            }
        }
        
        // Clear broadcast log
        function clearBroadcastLog() {
            bcMessageLog = [];
            const logEl = document.getElementById('bcMessageLog');
            if (logEl) {
                logEl.innerHTML = '<div style="color: var(--text-muted);">// Log cleared...</div>';
            }
        }
        
        // Update broadcast stats display
        function updateBroadcastStats() {
            const sentEl = document.getElementById('bcMessagesSent');
            const recvEl = document.getElementById('bcMessagesReceived');
            const pingEl = document.getElementById('bcLastPingMs');
            const statusEl = document.getElementById('bcConnectionStatus');
            const appStatusEl = document.getElementById('bcAppStatus');
            
            if (sentEl) sentEl.textContent = bcMessagesSent;
            if (recvEl) recvEl.textContent = bcMessagesReceived;
            
            if (pingEl && bcLastPingTime && bcLastPongTime) {
                const latency = bcLastPongTime - bcLastPingTime;
                pingEl.textContent = latency + 'ms';
            }
            
            if (statusEl) {
                if (bcAppConnected) {
                    statusEl.textContent = ' Connected';
                    statusEl.className = 'status-badge active';
                } else {
                    statusEl.textContent = ' Disconnected';
                    statusEl.className = 'status-badge danger';
                }
            }
            
            if (appStatusEl) {
                appStatusEl.textContent = bcAppConnected ? 'App Running' : 'No Response';
            }
        }
        
        // Test broadcast connection
        function testBroadcastConnection() {
            bcLastPingTime = Date.now();
            bcAppConnected = false;
            updateBroadcastStats();
            
            sendBroadcastMessage('ping');
            
            // Wait 3 seconds for response
            setTimeout(() => {
                if (!bcAppConnected) {
                    showToast(' App not responding. Make sure index.html is open.', 'error');
                    setIndexConnectionError(true, 'App not responding');
                }
                updateBroadcastStats();
            }, 3000);
        }
        
        // Send broadcast message with logging
        function sendBroadcastMessage(type, data = {}) {
            const message = { type, ...data, source: 'admin', timestamp: Date.now() };
            oithSyncChannel.postMessage(message);
            bcMessagesSent++;
            logBroadcastMessage('sent', type, data);
            updateBroadcastStats();
            console.log(' Admin sent:', message);
        }
        
        // Listen for changes from app or other tabs
        oithSyncChannel.onmessage = (event) => {
            console.log(' Admin received sync message:', event.data);
            
            // Skip messages from admin itself
            if (event.data.source === 'admin') return;
            
            // Track received message
            bcMessagesReceived++;
            logBroadcastMessage('received', event.data.type, event.data);
            
            // Handle pong (connection test response)
            if (event.data.type === 'pong') {
                bcLastPongTime = Date.now();
                bcAppConnected = true;
                setIndexConnectionError(false); // Clear error on successful connection
                const appStatusEl = document.getElementById('bcAppStatus');
                if (appStatusEl && event.data.currentScreen) {
                    appStatusEl.textContent = `Screen: ${event.data.currentScreen}`;
                }
                showToast(' App connected!', 'success');
            }
            
            // Handle diagnostics responses
            if (event.data.type === 'diagnostics_started') {
                bcAppConnected = true;
                logBroadcastMessage('received', 'diagnostics_started', { screens: event.data.screenCount });
            }
            
            if (event.data.type === 'screen_result') {
                bcAppConnected = true;
            }
            
            if (event.data.type === 'user_updated') {
                console.log(' User data synced from app for:', event.data.email);
                loadAllData();
                // Refresh users section if currently viewing
                if (currentSection === 'users') {
                    renderUsers();
                }
                // Also update dashboard stats
                platformData = calculatePlatformStats();
                updateBadgeCounts();
                showToast(' User data synced from app', 'info');
            }
            
            if (event.data.type === 'user_deleted') {
                console.log(' User deleted from app:', event.data.email);
                loadAllData();
                if (currentSection === 'users') {
                    renderUsers();
                }
                platformData = calculatePlatformStats();
                updateBadgeCounts();
            }
            
            if (event.data.type === 'data_response') {
                console.log(' Data response from app:', event.data);
                showToast(' Received data from app', 'info');
            }
            
            // Handle behavior tracking events
            if (event.data.type === 'behavior_event') {
                processBehaviorEvent(event.data);
            }
            
            if (event.data.type === 'behavior_summary') {
                processBehaviorSummary(event.data);
            }
            
            updateBroadcastStats();
        };
        
        // Listen for localStorage changes from other tabs
        window.addEventListener('storage', (event) => {
            if (event.key?.startsWith('oith_user_') || event.key === 'oith_test_bots' || event.key === 'oith_registered_users') {
                console.log(' Storage change detected:', event.key);
                loadAllData();
                // Refresh users section if currently viewing
                if (currentSection === 'users') {
                    renderUsers();
                }
                // Also update dashboard stats
                platformData = calculatePlatformStats();
                updateBadgeCounts();
            }
        });
        
        // Broadcast changes when admin saves data
        function broadcastAdminSync(type, data = {}) {
            oithSyncChannel.postMessage({ type, ...data, source: 'admin', timestamp: Date.now() });
        }
        
        document.addEventListener('DOMContentLoaded', async () => {
            console.log(' OITH Manager initializing...');
            
            // Check authentication before loading admin
            const isAuthenticated = await checkAdminAuth();
            if (!isAuthenticated) {
                console.log(' Not authenticated, redirecting to login...');
                window.location.href = 'login.html';
                return;
            }
            const adminUser = getAdminUser();
            console.log(' Authenticated as:', adminUser?.name || adminUser?.email);
            
            // Update header with admin info
            const adminNameEl = document.getElementById('adminNameHeader');
            if (adminNameEl && adminUser) {
                adminNameEl.textContent = adminUser.name?.split(' ')[0] || adminUser.email?.split('@')[0] || 'Admin';
            }
            
            // Initialize app configs in localStorage (fixes "Missing config" warnings)
            if (!localStorage.getItem('oith_admin_config')) {
                localStorage.setItem('oith_admin_config', JSON.stringify({
                    version: '1.0',
                    initialized: new Date().toISOString(),
                    settings: { autoRefresh: true, refreshInterval: 30000, theme: 'dark' }
                }));
            }
            if (!localStorage.getItem('oith_app_config')) {
                localStorage.setItem('oith_app_config', JSON.stringify({
                    version: '1.0',
                    initialized: new Date().toISOString(),
                    pricing: {
                        monthly: { price: 9.99, currency: 'USD', interval: 'month' },
                        yearly: { price: 79.99, currency: 'USD', interval: 'year' }
                    }
                }));
            }
            
            // Clean up any dynamically created orphaned modals from previous sessions
            // NOTE: Don't remove static modals defined in HTML (like meetingSchedulerModal, addEventModal, etc.)
            document.querySelectorAll('.modal.dynamic-modal').forEach(modal => modal.remove());
            
            initHierarchy(); // Initialize system hierarchy
            
            // Start section health monitoring
            if (typeof startHealthMonitoring === 'function') {
                startHealthMonitoring();
            }
            
            // ALWAYS fetch from AWS on page load (AWS is source of truth)
            console.log(' Fetching data from DynamoDB...');
            await fetchFromAWSSilent();
            
            await loadAllData();
            platformData = calculatePlatformStats();
            updateBadgeCounts();
            
            // Initialize file storage badge
            if (typeof loadFileList === 'function') {
                loadFileList().catch(e => console.log('File storage init:', e.message));
            }
            
            // Fetch DynamoDB schema stats for stat boxes
            console.log(' Fetching DynamoDB schema stats...');
            await syncDynamoDBSchema();
            
            // Show overview section by default
            showSection('overview');
            
            startAutoRefresh(); // Start auto-refresh
            
            console.log(' OITH Manager ready (data from DynamoDB)');
        });

        // Helper function to create storage key (must match app.js format)
        function getUserStorageKey(email) {
            if (!email) return null;
            return `oith_user_${email.toLowerCase().replace(/[^a-z0-9]/g, '_')}`;
        }
        
        // Helper to extract email from storage key
        function getEmailFromStorageKey(key) {
            // The key format is oith_user_email_domain_com
            // We can't perfectly reverse this, so we'll match against registered users
            return key.replace('oith_user_', '');
        }

        async function loadAllData() {
            // Clear existing data before reloading
            allUserData = {};
            registeredUsers = {};
            
            // First load registered users so we know what emails to look for
            try {
                const regUsers = localStorage.getItem('oith_registered_users');
                if (regUsers) {
                    registeredUsers = JSON.parse(regUsers);
                }
            } catch (e) {
                console.error('Error loading registered users:', e);
            }
            
            // Only load user data for REGISTERED users (not orphaned data)
            Object.keys(registeredUsers).forEach(email => {
                const storageKey = getUserStorageKey(email);
                try {
                    const data = localStorage.getItem(storageKey);
                    if (data) {
                        const parsed = JSON.parse(data);
                        allUserData[email] = parsed;
                        console.log(` Loaded user data for ${email}:`, {
                            age: parsed.user?.age,
                            birthday: parsed.user?.birthday,
                            location: parsed.user?.location
                        });
                    } else {
                        console.log(` No data found for registered user: ${email}`);
                    }
                } catch (e) {
                    console.error('Error loading user data for:', email, e);
                }
            });

            // Load reports from AWS
            try {
                const reportsResponse = await fetch(`${AWS_API_URL}/reports`);
                if (reportsResponse.ok) {
                    const reportsData = await reportsResponse.json();
                    reports = reportsData.reports || [];
                    console.log(` Loaded ${reports.length} reports from AWS`);
                }
            } catch (e) {
                console.log(' Could not load reports from AWS:', e.message);
            }

            // Load support messages from AWS
            try {
                const supportResponse = await fetch(`${AWS_API_URL}/support`);
                if (supportResponse.ok) {
                    const supportData = await supportResponse.json();
                    supportMessages = supportData.messages || [];
                    console.log(` Loaded ${supportMessages.length} support messages from AWS`);
                }
            } catch (e) {
                console.log(' Could not load support messages from AWS:', e.message);
            }

            // Load blocked users
            try {
                const blockedData = localStorage.getItem('oith_blocked_users');
                if (blockedData) {
                    blockedUsers = JSON.parse(blockedData);
                }
            } catch (e) {}

            console.log(' Loaded data:');
            console.log('   - Registered users:', Object.keys(registeredUsers).length);
            console.log('   - User data records:', Object.keys(allUserData).length);
            console.log('   - Reports:', reports.length);
            console.log('   - Support messages:', supportMessages.length);
        }

        function calculatePlatformStats() {
            const userEmails = Object.keys(registeredUsers);
            const userCount = userEmails.length;
            
            // Count active users (users with data)
            let activeCount = 0;
            let premiumCount = 0;
            let canceledCount = 0;
            let freeCount = 0;
            let totalMessages = 0;
            let totalMatches = 0;
            let acceptedMatches = 0;
            let datesPlanned = 0;
            let datesCompleted = 0;
            let totalCompatibility = 0;
            let compatibilityCount = 0;
            let totalResponseTime = 0;
            let responseTimeCount = 0;
            let totalTimeToDate = 0;
            let timeToDateCount = 0;
            
            // Track historical data for growth calculations
            const now = new Date();
            const oneWeekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
            let usersLastWeek = 0;
            let matchesLastWeek = 0;
            let messagesLastWeek = 0;
            let datesLastWeek = 0;
            
            userEmails.forEach(email => {
                const userData = allUserData[email];
                const regData = registeredUsers[email];
                
                // Track user registration dates for growth
                if (regData?.registeredAt) {
                    const regDate = new Date(regData.registeredAt);
                    if (regDate < oneWeekAgo) usersLastWeek++;
                }
                
                if (userData) {
                    // Count as active if they have logged in
                    if (userData.isLoggedIn) activeCount++;
                    
                    // Check subscription status
                    const subscription = userData.user?.subscription || userData.subscription;
                    if (subscription) {
                        if (subscription.status === 'canceled' || subscription.status === 'cancelled') {
                            canceledCount++;
                        } else if (subscription.type === 'premium' || subscription.plan === 'premium') {
                        premiumCount++;
                        } else {
                            freeCount++;
                        }
                    } else {
                        freeCount++;
                    }
                    
                    // Count messages and track response times
                    if (userData.conversation?.messages) {
                        const msgs = userData.conversation.messages;
                        totalMessages += msgs.length;
                        
                        // Calculate response rate from message timestamps
                        for (let i = 1; i < msgs.length; i++) {
                            if (msgs[i].sender !== msgs[i-1].sender && msgs[i].timestamp && msgs[i-1].timestamp) {
                                const responseTime = new Date(msgs[i].timestamp) - new Date(msgs[i-1].timestamp);
                                if (responseTime > 0 && responseTime < 24 * 60 * 60 * 1000) { // Within 24 hours
                                    totalResponseTime += responseTime;
                                    responseTimeCount++;
                                }
                            }
                        }
                        
                        // Count messages from last week
                        msgs.forEach(msg => {
                            if (msg.timestamp && new Date(msg.timestamp) < oneWeekAgo) {
                                messagesLastWeek++;
                            }
                        });
                    }
                    
                    // Count matches
                    if (userData.matchHistory) {
                        totalMatches += userData.matchHistory.length;
                        userData.matchHistory.forEach(match => {
                            if (match.accepted) acceptedMatches++;
                            // Track matches from last week
                            if (match.matchedAt && new Date(match.matchedAt) < oneWeekAgo) {
                                matchesLastWeek++;
                            }
                            // Track compatibility
                            if (match.compatibility) {
                                totalCompatibility += match.compatibility;
                                compatibilityCount++;
                            }
                        });
                    }
                    
                    // Count active connections as matches
                    if (userData.activeConnection) {
                        totalMatches++;
                        acceptedMatches++;
                        
                        // Calculate compatibility from active connection
                        if (userData.activeConnection.compatibility) {
                            totalCompatibility += userData.activeConnection.compatibility;
                            compatibilityCount++;
                        }
                        
                        // Calculate time to date if there's a planned date
                        if (userData.plannedDate && userData.activeConnection.matchedAt) {
                            const matchDate = new Date(userData.activeConnection.matchedAt);
                            const planDate = userData.plannedDate.confirmedAt ? new Date(userData.plannedDate.confirmedAt) : new Date();
                            const daysToDate = (planDate - matchDate) / (1000 * 60 * 60 * 24);
                            if (daysToDate > 0 && daysToDate < 30) {
                                totalTimeToDate += daysToDate;
                                timeToDateCount++;
                            }
                        }
                    }
                    
                    // Count planned dates
                    if (userData.plannedDate) {
                        datesPlanned++;
                        // Check if date is completed (in the past)
                        if (userData.plannedDate.date) {
                            const dateTime = new Date(userData.plannedDate.date);
                            if (dateTime < now) {
                                datesCompleted++;
                            }
                        }
                        // Track dates from last week
                        if (userData.plannedDate.confirmedAt && new Date(userData.plannedDate.confirmedAt) < oneWeekAgo) {
                            datesLastWeek++;
                        }
                    }
                }
            });
            
            // Calculate growth percentages based on real data
            const userGrowth = usersLastWeek > 0 ? Math.round(((userCount - usersLastWeek) / usersLastWeek) * 100) : (userCount > 0 ? 100 : 0);
            const matchGrowth = matchesLastWeek > 0 ? Math.round(((totalMatches - matchesLastWeek) / matchesLastWeek) * 100) : (totalMatches > 0 ? 100 : 0);
            const messageGrowth = messagesLastWeek > 0 ? Math.round(((totalMessages - messagesLastWeek) / messagesLastWeek) * 100) : (totalMessages > 0 ? 100 : 0);
            const dateGrowth = datesLastWeek > 0 ? Math.round(((datesPlanned - datesLastWeek) / datesLastWeek) * 100) : (datesPlanned > 0 ? 100 : 0);
            
            // Calculate response rate (percentage of messages responded to within 24 hours)
            const responseRate = responseTimeCount > 0 ? Math.min(100, Math.round((responseTimeCount / Math.max(1, totalMessages - responseTimeCount)) * 100)) : 0;
            
            // Calculate average time to date
            const avgTimeToDate = timeToDateCount > 0 ? Math.round(totalTimeToDate / timeToDateCount * 10) / 10 : 0;
            
            // Update platform data with ONLY real computed stats - no fallbacks
            platformData.totalUsers = userCount;
            platformData.activeUsers = activeCount;
            platformData.premiumUsers = premiumCount;
            platformData.canceledUsers = canceledCount;
            platformData.freeUsers = freeCount;
            platformData.churnRate = (premiumCount + canceledCount) > 0 ? Math.round((canceledCount / (premiumCount + canceledCount)) * 100) : 0;
            platformData.totalMatches = totalMatches;
            platformData.acceptedMatches = acceptedMatches;
            platformData.declinedMatches = totalMatches - acceptedMatches;
            platformData.totalMessages = totalMessages;
            platformData.datesPlanned = datesPlanned;
            platformData.datesCompleted = datesCompleted;
            platformData.avgCompatibility = compatibilityCount > 0 ? Math.round(totalCompatibility / compatibilityCount) : 0;
            platformData.responseRate = responseRate;
            platformData.avgTimeToDate = avgTimeToDate;
            platformData.mrr = premiumCount * 10.00;
            
            // Store growth metrics for dashboard display
            platformData.userGrowth = userGrowth;
            platformData.matchGrowth = matchGrowth;
            platformData.messageGrowth = messageGrowth;
            platformData.dateGrowth = dateGrowth;
            
            console.log(' Platform stats calculated from real data:', platformData);
            return platformData;
        }

        // Track current section
        let currentSection = 'dashboard';
        
        // ==========================================
        // User Behavior Tracking Storage
        // ==========================================
        let behaviorData = {
            activeSessions: {},      // { sessionId: { lastSeen, user, currentScreen, ... } }
            aggregateScreenTime: {}, // { screenId: totalMs }
            aggregateScreenVisits: {}, // { screenId: count }
            aggregateButtonClicks: {}, // { buttonText: count }
            aggregateSwipes: { left: 0, right: 0 },
            liveEvents: [],          // Last 50 events for live feed
            totalEvents: 0
        };
        
        // Process behavior events from app
        function processBehaviorEvent(data) {
            behaviorData.totalEvents++;
            
            // Add to live feed
            const eventItem = {
                type: data.eventType,
                data: data.data,
                user: data.user,
                timestamp: data.timestamp,
                sessionId: data.sessionId
            };
            behaviorData.liveEvents.unshift(eventItem);
            if (behaviorData.liveEvents.length > 50) {
                behaviorData.liveEvents = behaviorData.liveEvents.slice(0, 50);
            }
            
            // Track session
            if (data.sessionId) {
                behaviorData.activeSessions[data.sessionId] = {
                    lastSeen: data.timestamp,
                    user: data.user,
                    currentScreen: data.data?.screen || 'unknown'
                };
            }
            
            // Update aggregate data based on event type
            if (data.eventType === 'screen_view' && data.data?.screen) {
                behaviorData.aggregateScreenVisits[data.data.screen] = 
                    (behaviorData.aggregateScreenVisits[data.data.screen] || 0) + 1;
            }
            
            if (data.eventType === 'button_click' && data.data?.button) {
                const btnKey = data.data.text || data.data.button;
                behaviorData.aggregateButtonClicks[btnKey] = 
                    (behaviorData.aggregateButtonClicks[btnKey] || 0) + 1;
            }
            
            if (data.eventType === 'swipe') {
                if (data.data?.direction === 'left') behaviorData.aggregateSwipes.left++;
                if (data.data?.direction === 'right') behaviorData.aggregateSwipes.right++;
            }
            
            // Update connection status
            updateBehaviorConnectionStatus(true);
            
            // Update UI if on realtime section
            if (currentSection === 'realtime') {
                updateBehaviorUI();
            }
        }
        
        // Process behavior summary from app
        function processBehaviorSummary(data) {
            // Update session info
            if (data.sessionId) {
                behaviorData.activeSessions[data.sessionId] = {
                    lastSeen: data.timestamp,
                    user: data.user,
                    currentScreen: data.currentScreen,
                    sessionDuration: data.sessionDuration,
                    screenTime: data.screenTime,
                    screenVisits: data.screenVisits,
                    buttonClicks: data.buttonClicks,
                    swipeActions: data.swipeActions
                };
            }
            
            // Merge aggregate data
            if (data.screenTime) {
                Object.entries(data.screenTime).forEach(([screen, time]) => {
                    behaviorData.aggregateScreenTime[screen] = 
                        Math.max(behaviorData.aggregateScreenTime[screen] || 0, time);
                });
            }
            
            updateBehaviorConnectionStatus(true);
            
            if (currentSection === 'realtime') {
                updateBehaviorUI();
            }
        }
        
        // Update connection status badge
        function updateBehaviorConnectionStatus(connected) {
            const badge = document.getElementById('behaviorConnectionStatus');
            if (badge) {
                badge.textContent = connected ? 'Connected' : 'Waiting...';
                badge.className = `status-badge ${connected ? 'active' : ''}`;
            }
        }
        
        // Update behavior UI
        function updateBehaviorUI() {
            // Clean up stale sessions (not seen in 60 seconds)
            const now = Date.now();
            Object.entries(behaviorData.activeSessions).forEach(([id, session]) => {
                if (now - session.lastSeen > 60000) {
                    delete behaviorData.activeSessions[id];
                }
            });
            
            // Update stats
            const activeSessions = Object.keys(behaviorData.activeSessions).length;
            document.getElementById('activeNow').textContent = activeSessions;
            document.getElementById('totalScreenViews').textContent = 
                Object.values(behaviorData.aggregateScreenVisits).reduce((a, b) => a + b, 0);
            document.getElementById('totalButtonClicks').textContent = 
                Object.values(behaviorData.aggregateButtonClicks).reduce((a, b) => a + b, 0);
            document.getElementById('totalSwipes').textContent = 
                behaviorData.aggregateSwipes.left + behaviorData.aggregateSwipes.right;
            
            // Update screen time chart
            renderScreenTimeChart();
            
            // Update button clicks chart
            renderButtonClicksChart();
            
            // Update navigation flow
            renderNavigationFlow();
            
            // Update live feed
            renderBehaviorLiveFeed();
            
            // Update session details
            renderSessionDetails();
        }
        
        function renderScreenTimeChart() {
            const container = document.getElementById('screenTimeChart');
            if (!container) return;
            
            const screenData = Object.entries(behaviorData.aggregateScreenTime)
                .map(([screen, time]) => ({ screen, time, visits: behaviorData.aggregateScreenVisits[screen] || 0 }))
                .sort((a, b) => b.time - a.time)
                .slice(0, 8);
            
            if (screenData.length === 0) {
                container.innerHTML = `<div style="color: var(--text-muted); text-align: center; padding: 40px;">
                    Waiting for user activity on index.html...
                </div>`;
                return;
            }
            
            const maxTime = Math.max(...screenData.map(d => d.time));
            
            container.innerHTML = screenData.map(d => {
                const percentage = (d.time / maxTime * 100).toFixed(0);
                const timeStr = d.time >= 60000 
                    ? `${(d.time / 60000).toFixed(1)}m` 
                    : `${(d.time / 1000).toFixed(1)}s`;
                
                return `
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                        <div style="width: 120px; font-size: 0.85rem; color: var(--text-secondary);">${d.screen}</div>
                        <div style="flex: 1; height: 24px; background: var(--bg-tertiary); border-radius: 4px; overflow: hidden;">
                            <div style="width: ${percentage}%; height: 100%; background: linear-gradient(90deg, var(--coral), var(--purple)); transition: width 0.3s;"></div>
                        </div>
                        <div style="width: 60px; text-align: right; font-size: 0.85rem; font-weight: 600;">${timeStr}</div>
                        <div style="width: 50px; text-align: right; font-size: 0.75rem; color: var(--text-muted);">${d.visits} visits</div>
                    </div>
                `;
            }).join('');
        }
        
        function renderButtonClicksChart() {
            const container = document.getElementById('buttonClicksChart');
            if (!container) return;
            
            const buttonData = Object.entries(behaviorData.aggregateButtonClicks)
                .map(([button, count]) => ({ button: button.substring(0, 25), count }))
                .sort((a, b) => b.count - a.count)
                .slice(0, 8);
            
            if (buttonData.length === 0) {
                container.innerHTML = `<div style="color: var(--text-muted); text-align: center; padding: 40px;">
                    Waiting for user activity on index.html...
                </div>`;
                return;
            }
            
            const maxClicks = Math.max(...buttonData.map(d => d.count));
            
            container.innerHTML = buttonData.map(d => {
                const percentage = (d.count / maxClicks * 100).toFixed(0);
                const hue = 340 + (buttonData.indexOf(d) * 20); // Color gradient
                
                return `
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 10px;">
                        <div style="width: 150px; font-size: 0.8rem; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="${d.button}">${d.button}</div>
                        <div style="flex: 1; height: 20px; background: var(--bg-tertiary); border-radius: 4px; overflow: hidden;">
                            <div style="width: ${percentage}%; height: 100%; background: hsl(${hue}, 70%, 50%); transition: width 0.3s;"></div>
                        </div>
                        <div style="width: 40px; text-align: right; font-weight: 600; font-size: 0.9rem;">${d.count}</div>
                    </div>
                `;
            }).join('');
        }
        
        function renderNavigationFlow() {
            const container = document.getElementById('navigationFlow');
            if (!container) return;
            
            // Get recent navigation from active sessions
            let allPaths = [];
            Object.values(behaviorData.activeSessions).forEach(session => {
                if (session.screenVisits) {
                    Object.entries(session.screenVisits).forEach(([screen, count]) => {
                        allPaths.push({ screen, count, user: session.user });
                    });
                }
            });
            
            // Also show from live events
            const recentScreens = behaviorData.liveEvents
                .filter(e => e.type === 'screen_view')
                .slice(0, 15);
            
            if (recentScreens.length === 0) {
                container.innerHTML = `<div style="color: var(--text-muted); text-align: center; padding: 40px;">
                    User navigation path will appear here...
                </div>`;
                return;
            }
            
            container.innerHTML = `
                <div style="display: flex; flex-wrap: wrap; gap: 8px; align-items: center;">
                    ${recentScreens.map((e, i) => `
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="padding: 6px 12px; background: var(--bg-tertiary); border-radius: 16px; font-size: 0.8rem; border: 1px solid var(--border);">
                                ${e.data?.screen || 'unknown'}
                            </span>
                            ${i < recentScreens.length - 1 ? '<span style="color: var(--text-muted);"></span>' : ''}
                        </div>
                    `).join('')}
                </div>
            `;
        }
        
        function renderBehaviorLiveFeed() {
            const container = document.getElementById('liveFeed');
            if (!container) return;
            
            if (behaviorData.liveEvents.length === 0) {
                container.innerHTML = `<div style="color: var(--text-muted); text-align: center; padding: 20px;">
                    Live events will appear here...
                </div>`;
                return;
            }
            
            const eventIcons = {
                'screen_view': { emoji: '', color: 'var(--blue)' },
                'button_click': { emoji: '', color: 'var(--coral)' },
                'swipe': { emoji: '', color: 'var(--purple)' }
            };
            
            container.innerHTML = behaviorData.liveEvents.slice(0, 15).map(e => {
                const icon = eventIcons[e.type] || { emoji: '', color: 'var(--text-muted)' };
                let text = '';
                
                if (e.type === 'screen_view') {
                    text = `Viewed <strong>${e.data?.screen}</strong>`;
                } else if (e.type === 'button_click') {
                    text = `Clicked <strong>${(e.data?.text || e.data?.button || 'button').substring(0, 30)}</strong>`;
                } else if (e.type === 'swipe') {
                    text = `Swiped <strong>${e.data?.direction}</strong> on ${e.data?.screen}`;
                }
                
                const timeAgo = formatTimeAgo(new Date(e.timestamp).toISOString());
                
                return `
                    <div class="activity-item" style="padding: 8px 0; border-bottom: 1px solid var(--border);">
                        <div class="activity-icon" style="background: ${icon.color}22;">${icon.emoji}</div>
                        <div class="activity-content">
                            <div class="activity-text" style="font-size: 0.85rem;">${text}</div>
                            <div class="activity-time" style="font-size: 0.7rem;">${timeAgo}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function renderSessionDetails() {
            const sessions = Object.entries(behaviorData.activeSessions);
            if (sessions.length === 0) return;
            
            const [sessionId, session] = sessions[0]; // Show first active session
            
            const el = (id, val) => {
                const elem = document.getElementById(id);
                if (elem) elem.textContent = val;
            };
            
            el('currentSessionId', sessionId.substring(0, 20) + '...');
            el('sessionDuration', session.sessionDuration 
                ? `${Math.floor(session.sessionDuration / 60000)}m ${Math.floor((session.sessionDuration % 60000) / 1000)}s`
                : '');
            el('currentUserScreen', session.currentScreen || '');
            el('currentUser', session.user || 'anonymous');
        }
        
        function clearBehaviorData() {
            behaviorData = {
                activeSessions: {},
                aggregateScreenTime: {},
                aggregateScreenVisits: {},
                aggregateButtonClicks: {},
                aggregateSwipes: { left: 0, right: 0 },
                liveEvents: [],
                totalEvents: 0
            };
            updateBehaviorUI();
            showToast('Behavior data cleared', 'success');
        }
        
        function clearLiveFeed() {
            behaviorData.liveEvents = [];
            allLiveActivities = [];
            liveFeedUserFilter = 'all';
            const filterSelect = document.getElementById('liveFeedUserFilter');
            if (filterSelect) filterSelect.value = 'all';
            renderBehaviorLiveFeed();
            renderLiveFeedActivities();
        }

        // Debug function to verify localStorage data - call debugStorage() in browser console
        window.debugStorage = function(email) {
            const targetEmail = email || Object.keys(registeredUsers)[0];
            if (!targetEmail) {
                console.log(' No email provided. Usage: debugStorage("email@example.com")');
                return;
            }
            
            console.log('=== ADMIN DEBUG STORAGE ===');
            console.log('Email:', targetEmail);
            
            // Check registered users
            const regUsers = JSON.parse(localStorage.getItem('oith_registered_users') || '{}');
            console.log('Registered users:', Object.keys(regUsers));
            console.log('Is registered:', !!regUsers[targetEmail]);
            
            // Check user data
            const storageKey = getUserStorageKey(targetEmail);
            console.log('Storage key:', storageKey);
            
            const rawData = localStorage.getItem(storageKey);
            if (rawData) {
                const data = JSON.parse(rawData);
                console.log('User data found:');
                console.log('  - Age:', data.user?.age);
                console.log('  - Birthday:', data.user?.birthday);
                console.log('  - Location:', data.user?.location);
                console.log('  - Gender:', data.user?.gender);
                console.log('  - Name:', data.user?.firstName);
                console.log('  - ProfileComplete:', data.profileComplete);
                console.log('Full user object:', data.user);
            } else {
                console.log(' No user data found for key:', storageKey);
            }
            
            // Show what admin has loaded
            console.log('\nAdmin allUserData for this email:');
            if (allUserData[targetEmail]) {
                console.log('  - Age:', allUserData[targetEmail].user?.age);
                console.log('  - Birthday:', allUserData[targetEmail].user?.birthday);
                console.log('  - Location:', allUserData[targetEmail].user?.location);
            } else {
                console.log('   Not loaded in admin');
            }
        };
        
        // Silently fetch from AWS (used by auto-refresh, no confirmation)
        async function fetchFromAWSSilent() {
            const awsApiUrl = localStorage.getItem('oith_aws_api_url') || 'https://emeapbgbui.execute-api.us-east-1.amazonaws.com';
            const apiStartTime = Date.now();
            
            try {
                const response = await fetch(`${awsApiUrl}/users`);
                if (!response.ok) {
                    recordAwsReceive(false, `HTTP ${response.status}`);
                    setAwsConnectionError(true, `HTTP ${response.status}`);
                    // Track API failure for relevant sections
                    if (typeof trackApiCall === 'function') {
                        ['users', 'matches', 'dashboard', 'analytics', 'realtime', 'safety'].forEach(section => {
                            trackApiCall(section, apiStartTime, false, new Error(`HTTP ${response.status}`));
                        });
                    }
                    return;
                }
                
                const responseText = await response.text();
                const responseBytes = new Blob([responseText]).size;
                trackSyncDownload(responseBytes);
                
                // Track API success for relevant sections
                if (typeof trackApiCall === 'function') {
                    ['users', 'matches', 'dashboard', 'analytics', 'realtime', 'safety'].forEach(section => {
                        trackApiCall(section, apiStartTime, true);
                    });
                }
                
                const awsUsers = JSON.parse(responseText);
                console.log(` Fetched ${Object.keys(awsUsers).length} users from DynamoDB (${(responseBytes/1024).toFixed(1)}KB)`);
                recordAwsReceive(true, `${Object.keys(awsUsers).length} users`);
                setAwsConnectionError(false); // Clear error on success
                
                // CLEAR existing local users first
                const existingUsers = JSON.parse(localStorage.getItem('oith_registered_users') || '{}');
                Object.keys(existingUsers).forEach(email => {
                    const key = 'oith_user_' + email.replace(/[^a-zA-Z0-9]/g, '_');
                    localStorage.removeItem(key);
                });
                
                // Build new registered users from AWS data ONLY
                const newRegisteredUsers = {};
                
                Object.entries(awsUsers).forEach(([email, userData]) => {
                    newRegisteredUsers[email] = {
                        firstName: userData.firstName || userData.name || 'User',
                        gender: userData.gender || '',
                        location: userData.location || '',
                        age: userData.age || null,
                        registeredAt: userData.registeredAt || new Date().toISOString(),
                        fromAWS: true
                    };
                    
                    // Store individual user data including subscription
                    const key = 'oith_user_' + email.replace(/[^a-zA-Z0-9]/g, '_');
                    localStorage.setItem(key, JSON.stringify({
                        version: '1.0',
                        savedAt: new Date().toISOString(),
                        user: {
                            email: email,
                            firstName: userData.firstName || userData.name || '',
                            age: userData.age || null,
                            gender: userData.gender || '',
                            location: userData.location || '',
                            occupation: userData.occupation || '',
                            bio: userData.bio || '',
                            photo: userData.photo || '',
                            photos: userData.photos || [userData.photo].filter(p => p),
                            education: userData.education || ''
                        },
                        // Include subscription data for dashboard metrics
                        subscription: userData.subscription || null,
                        // Include match history for analytics
                        matchHistory: userData.matchHistory || [],
                        // Include conversations for message counts
                        conversations: userData.conversations || {},
                        fromAWS: true
                    }));
                });
                
                // REPLACE localStorage with AWS data only
                localStorage.setItem('oith_registered_users', JSON.stringify(newRegisteredUsers));
                
                // Clear test bots (AWS mode = no bots)
                localStorage.setItem('oith_test_bots', JSON.stringify([]));
                
            } catch (error) {
                console.log(' AWS fetch failed (offline?):', error.message);
                recordAwsReceive(false, error.message);
                setAwsConnectionError(true, error.message);
                
                // Track API failure for relevant sections
                if (typeof trackApiCall === 'function') {
                    ['users', 'matches', 'dashboard', 'analytics', 'realtime', 'safety'].forEach(section => {
                        trackApiCall(section, apiStartTime, false, error);
                    });
                }
            }
        }
        
        // Pull users from AWS DynamoDB - OVERWRITES local user database (with confirmation)
        async function syncFromAWS() {
            const awsApiUrl = localStorage.getItem('oith_aws_api_url') || 'https://emeapbgbui.execute-api.us-east-1.amazonaws.com';
            
            if (!confirm(' This will OVERWRITE your local user database with data from DynamoDB.\n\nContinue?')) {
                return;
            }
            
            showToast(' Pulling users from DynamoDB...', 'info');
            
            try {
                const response = await fetch(`${awsApiUrl}/users`);
                if (!response.ok) throw new Error('Failed to fetch from AWS');
                
                const awsUsers = await response.json();
                console.log(' AWS Users:', awsUsers);
                
                // CLEAR existing local user database first
                const existingUsers = JSON.parse(localStorage.getItem('oith_registered_users') || '{}');
                Object.keys(existingUsers).forEach(email => {
                    const key = 'oith_user_' + email.replace(/[^a-zA-Z0-9]/g, '_');
                    localStorage.removeItem(key);
                });
                
                // Build new registered users from AWS data
                const newRegisteredUsers = {};
                
                Object.entries(awsUsers).forEach(([email, userData]) => {
                    // Add to registered users
                    newRegisteredUsers[email] = {
                        firstName: userData.firstName || userData.name || 'User',
                        gender: userData.gender || '',
                        location: userData.location || '',
                        age: userData.age || null,
                        registeredAt: userData.registeredAt || new Date().toISOString(),
                        fromAWS: true
                    };
                    
                    // Store individual user data
                    const key = 'oith_user_' + email.replace(/[^a-zA-Z0-9]/g, '_');
                    localStorage.setItem(key, JSON.stringify({
                        version: '1.0',
                        savedAt: new Date().toISOString(),
                        user: {
                            email: email,
                            firstName: userData.firstName || userData.name || '',
                            age: userData.age || null,
                            gender: userData.gender || '',
                            location: userData.location || '',
                            occupation: userData.occupation || '',
                            bio: userData.bio || '',
                            photo: userData.photo || '',
                            photos: userData.photos || [userData.photo].filter(p => p),
                            education: userData.education || ''
                        },
                        fromAWS: true
                    }));
                });
                
                // OVERWRITE local registered users with AWS data
                localStorage.setItem('oith_registered_users', JSON.stringify(newRegisteredUsers));
                
                // Clear test bots (AWS mode = no test bots)
                localStorage.setItem('oith_test_bots', JSON.stringify([]));
                
                const userCount = Object.keys(awsUsers).length;
                showToast(` Replaced local database with ${userCount} users from DynamoDB`, 'success');
                recordAwsReceive(true, `${userCount} users`);
                setAwsConnectionError(false); // Clear error on success
                
                // Reload UI
                refreshData();
                
            } catch (error) {
                console.error('AWS sync error:', error);
                showToast(' Failed to pull from AWS: ' + error.message, 'error');
                recordAwsReceive(false, error.message);
                setAwsConnectionError(true, error.message);
            }
        }
        
        // Push ALL local users to AWS DynamoDB - COMPLETE OVERWRITE
        async function pushAllToAWS() {
            const awsApiUrl = localStorage.getItem('oith_aws_api_url') || 'https://emeapbgbui.execute-api.us-east-1.amazonaws.com';
            
            const registeredUsers = JSON.parse(localStorage.getItem('oith_registered_users') || '{}');
            const userEmails = Object.keys(registeredUsers);
            
            // Allow pushing even if empty (to clear DynamoDB)
            const message = userEmails.length === 0 
                ? ' Your local database is EMPTY.\n\nThis will DELETE ALL users from DynamoDB!\n\nContinue?'
                : ` This will COMPLETELY REPLACE DynamoDB with ${userEmails.length} users from your local database.\n\nAll existing DynamoDB data will be deleted first.\n\nContinue?`;
            
            if (!confirm(message)) {
                return;
            }
            
            const actionMsg = userEmails.length === 0 
                ? ' Clearing DynamoDB (local database is empty)...'
                : ` Replacing DynamoDB with ${userEmails.length} local users...`;
            showToast(actionMsg, 'info');
            
            try {
                // Step 1: Clear all existing users in DynamoDB
                console.log(' Clearing DynamoDB...');
                await fetch(`${awsApiUrl}/users/clear`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                // Step 2: Build users array for bulk upload
                const usersToUpload = [];
                
                for (const email of userEmails) {
                    const regUser = registeredUsers[email];
                    const storageKey = 'oith_user_' + email.replace(/[^a-zA-Z0-9]/g, '_');
                    const userData = JSON.parse(localStorage.getItem(storageKey) || '{}');
                    const user = userData.user || {};
                    
                    usersToUpload.push({
                        email: email,
                        firstName: user.firstName || regUser.firstName || 'User',
                        age: user.age || regUser.age || null,
                        gender: user.gender || regUser.gender || '',
                        location: user.location || regUser.location || '',
                        occupation: user.occupation || '',
                        photo: (user.photos && user.photos[0]) || user.photo || '',
                        education: user.education || ''
                    });
                }
                
                // Step 3: Bulk upload all users
                console.log(` Uploading ${usersToUpload.length} users...`);
                const uploadBody = JSON.stringify({ users: usersToUpload });
                trackSyncUpload(new Blob([uploadBody]).size);
                
                const response = await fetch(`${awsApiUrl}/users/bulk`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: uploadBody
                });
                
                if (!response.ok) {
                    throw new Error('Bulk upload failed');
                }
                
                const result = await response.json();
                const successMsg = usersToUpload.length === 0
                    ? ' DynamoDB cleared! (0 users)'
                    : ` Replaced DynamoDB with ${result.count || usersToUpload.length} users!`;
                showToast(successMsg, 'success');
                recordAwsSend(true, usersToUpload.length === 0 ? 'Cleared DynamoDB' : `${result.count || usersToUpload.length} users`);
                
            } catch (error) {
                console.error('Push error:', error);
                recordAwsSend(false, error.message || 'Bulk upload failed');
                
                // Fallback: push one by one if bulk fails
                showToast(' Bulk upload failed, trying one by one...', 'warning');
                
                let successCount = 0;
                for (const email of userEmails) {
                    try {
                        const regUser = registeredUsers[email];
                        const storageKey = 'oith_user_' + email.replace(/[^a-zA-Z0-9]/g, '_');
                        const userData = JSON.parse(localStorage.getItem(storageKey) || '{}');
                        const user = userData.user || {};
                        
                        const payload = {
                            email: email,
                            name: user.firstName || regUser.firstName || 'User',
                            userData: {
                                user: {
                                    firstName: user.firstName || regUser.firstName || '',
                                    age: user.age || regUser.age || null,
                                    gender: user.gender || regUser.gender || '',
                                    location: user.location || regUser.location || '',
                                    occupation: user.occupation || '',
                                    photo: (user.photos && user.photos[0]) || '',
                                    education: user.education || ''
                                }
                            }
                        };
                        
                        const resp = await fetch(`${awsApiUrl}/users`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        
                        if (resp.ok) successCount++;
                    } catch (e) {
                        console.error(`Failed: ${email}`, e);
                    }
                }
                
                showToast(` Pushed ${successCount}/${userEmails.length} users to DynamoDB`, 'success');
                recordAwsSend(successCount > 0 || userEmails.length === 0, `${successCount}/${userEmails.length} users`);
            }
        }
        
        async function refreshData() {
            console.log(' Refreshing all data from DynamoDB...');
            
            // Clear existing data first
            allUserData = {};
            registeredUsers = {};
            reports = [];
            supportMessages = [];
            blockedUsers = [];
            allUsersData = [];
            filteredUsers = [];
            
            // Fetch latest from DynamoDB first (silent - no confirmation)
            await fetchFromAWSSilent();
            
            // Reload all data from localStorage (now updated from AWS)
            await loadAllData();
            
            // Recalculate platform stats
            platformData = calculatePlatformStats();
            
            // Update the badge counts
            updateBadgeCounts();
            
            // Refresh DynamoDB schema stats
            await syncDynamoDBSchema();
            
            console.log(' Refreshing section:', currentSection);
            console.log(' Platform data:', platformData);
            
            // Call the appropriate render function based on current section
            switch(currentSection) {
                case 'dashboard': renderDashboard(); break;
                case 'realtime': renderRealtime(); break;
                case 'analytics': renderAnalytics(); break;
                case 'mlmodels': renderMLModels(); break;
                case 'users': renderUsers(); break;
                case 'matches': renderMatches(); break;
                case 'funnel': renderFunnel(); break;
                case 'revenue': renderRevenue(); break;
                case 'advertising': renderAdvertising(); break;
                case 'geographic': renderGeographic(); break;
                case 'safety': renderSafety(); break;
                case 'feedback': renderFeedback(); break;
                case 'testbots': renderTestBots(); break;
                case 'legal': renderLegal(); break;
                case 'compliance': renderCompliance(); break;
                case 'database': renderDatabase(); break;
                case 'experiments': renderExperiments(); break;
                case 'org-hierarchy': renderOrgHierarchy(); break;
                case 'payroll': renderPayroll(); break;
                case 'tax': renderTax(); break;
                case 'calendar': initCalendarSection(); break;
                default: renderDashboard();
            }
            
            console.log(' Refresh complete');
        }
        
        function updateBadgeCounts() {
            // Update reports badge
            const reportsBadge = document.getElementById('reportsBadge');
            if (reportsBadge) {
                const pendingReports = reports.filter(r => r.status === 'pending').length;
                reportsBadge.textContent = pendingReports;
                reportsBadge.style.display = pendingReports > 0 ? 'inline' : 'none';
            }
            
            // Update test bots badge
            const testBots = JSON.parse(localStorage.getItem('oith_test_bots') || '[]');
            const activeCount = testBots.filter(b => b.active).length;
            const botsBadge = document.getElementById('botsActiveBadge');
            if (botsBadge) {
                botsBadge.textContent = activeCount;
                botsBadge.style.display = activeCount > 0 ? 'inline' : 'none';
            }
        }

        // ==========================================
        // NAVIGATION
        // ==========================================
        
        // ==========================================
        // SIDEBAR EDIT / REORDER FUNCTIONALITY
        // ==========================================
        
        let sidebarEditMode = false;
        let originalSidebarOrder = [];
        
        function toggleSidebarEdit() {
            sidebarEditMode = !sidebarEditMode;
            
            const editBtn = document.getElementById('editSidebarBtn');
            const saveBtn = document.getElementById('saveSidebarBtn');
            const cancelBtn = document.getElementById('cancelSidebarBtn');
            
            if (sidebarEditMode) {
                // Save original order
                originalSidebarOrder = getSidebarOrder();
                
                // Show save/cancel buttons
                editBtn.style.display = 'none';
                saveBtn.style.display = 'block';
                cancelBtn.style.display = 'block';
                
                // Add reorder controls to each nav-item
                document.querySelectorAll('.nav-item').forEach((item, index) => {
                    if (!item.querySelector('.reorder-controls')) {
                        const controls = document.createElement('div');
                        controls.className = 'reorder-controls';
                        controls.innerHTML = `
                            <button onclick="event.stopPropagation(); moveNavItem(this.closest('.nav-item'), -1)" style="background: none; border: none; color: #666; cursor: pointer; padding: 2px;"></button>
                            <button onclick="event.stopPropagation(); moveNavItem(this.closest('.nav-item'), 1)" style="background: none; border: none; color: #666; cursor: pointer; padding: 2px;"></button>
                        `;
                        controls.style.cssText = 'margin-left: auto; display: flex; flex-direction: column; gap: 0;';
                        item.appendChild(controls);
                    }
                });
                
                // Add visual edit indicator
                document.querySelector('.sidebar').style.border = '2px dashed var(--accent)';
                
            } else {
                exitSidebarEditMode();
            }
        }
        
        function exitSidebarEditMode() {
            sidebarEditMode = false;
            
            const editBtn = document.getElementById('editSidebarBtn');
            const saveBtn = document.getElementById('saveSidebarBtn');
            const cancelBtn = document.getElementById('cancelSidebarBtn');
            
            editBtn.style.display = 'block';
            saveBtn.style.display = 'none';
            cancelBtn.style.display = 'none';
            
            // Remove reorder controls
            document.querySelectorAll('.reorder-controls').forEach(el => el.remove());
            
            // Remove visual indicator
            document.querySelector('.sidebar').style.border = 'none';
        }
        
        function moveNavItem(item, direction) {
            const parent = item.parentElement;
            const items = Array.from(parent.querySelectorAll('.nav-item'));
            const currentIndex = items.indexOf(item);
            const newIndex = currentIndex + direction;
            
            if (newIndex < 0 || newIndex >= items.length) return;
            
            if (direction === -1) {
                parent.insertBefore(item, items[newIndex]);
            } else {
                parent.insertBefore(items[newIndex], item);
            }
        }
        
        function getSidebarOrder() {
            const order = [];
            document.querySelectorAll('.nav-section').forEach(section => {
                const sectionId = section.dataset.section || section.id;
                const items = [];
                section.querySelectorAll('.nav-item').forEach(item => {
                    const onclick = item.getAttribute('onclick') || '';
                    const match = onclick.match(/showSection\('([^']+)'\)/);
                    if (match) items.push(match[1]);
                });
                order.push({ section: sectionId, items });
            });
            return order;
        }
        
        function saveSidebarOrder() {
            const order = getSidebarOrder();
            localStorage.setItem('oith_sidebar_order', JSON.stringify(order));
            showToast(' Sidebar layout saved!', 'success');
            exitSidebarEditMode();
        }
        
        function cancelSidebarEdit() {
            // Restore original order
            restoreSidebarOrder(originalSidebarOrder);
            exitSidebarEditMode();
            showToast('Sidebar changes cancelled', 'info');
        }
        
        function restoreSidebarOrder(order) {
            order.forEach(sectionData => {
                const section = document.querySelector(`[data-section="${sectionData.section}"]`) || 
                               document.getElementById(`nav-section-${sectionData.section}`);
                if (!section) return;
                
                sectionData.items.forEach(itemId => {
                    const item = section.querySelector(`[onclick*="showSection('${itemId}')"]`);
                    if (item) section.appendChild(item);
                });
            });
        }
        
        function loadSavedSidebarOrder() {
            const saved = localStorage.getItem('oith_sidebar_order');
            if (saved) {
                try {
                    const order = JSON.parse(saved);
                    restoreSidebarOrder(order);
                } catch (e) {
                    console.log('Could not restore sidebar order');
                }
            }
        }
        
        // Load saved sidebar order on page load
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(loadSavedSidebarOrder, 100);
        });
        
        function showSection(section) {
            // Track current section for refresh
            currentSection = section;
            
            // Track API call timing for health monitoring
            const apiStartTime = Date.now();
            
            // Stop launch readiness monitoring when leaving calendar
            if (section !== 'calendar' && typeof stopLaunchReadinessMonitor === 'function') {
                stopLaunchReadinessMonitor();
            }
            
            // Clean up any orphaned modals
            document.querySelectorAll('.modal').forEach(modal => {
                modal.remove();
            });
            
            // Hide all sections
            document.querySelectorAll('[id$="-section"]').forEach(el => {
                el.style.display = 'none';
            });
            
            // Show selected section
            const sectionEl = document.getElementById(`${section}-section`);
            if (sectionEl) {
                sectionEl.style.display = 'block';
            }
            
            // Update nav
            document.querySelectorAll('.nav-item').forEach(el => {
                el.classList.remove('active');
            });
            if (event?.target) {
                event.target.closest('.nav-item')?.classList.add('active');
            }
            
            // Reload data before rendering
            loadAllData();
            platformData = calculatePlatformStats();
            
            // Render section content
            try {
                switch(section) {
                    case 'overview': renderOverview(); break;
                    case 'dashboard': renderDashboard(); break;
                    case 'realtime': renderRealtime(); break;
                    case 'analytics': renderAnalytics(); break;
                    case 'mlmodels': renderMLModels(); break;
                    case 'users': renderUsers(); break;
                    case 'matches': renderMatches(); break;
                    case 'funnel': renderFunnel(); break;
                    case 'revenue': renderRevenue(); break;
                    case 'advertising': renderAdvertising(); break;
                    case 'geographic': renderGeographic(); break;
                    case 'safety': renderSafety(); break;
                    case 'feedback': renderFeedback(); break;
                    case 'testbots': renderTestBots(); break;
                    case 'legal': renderLegal(); break;
                    case 'compliance': renderCompliance(); break;
                    case 'database': renderDatabase(); break;
                    case 'experiments': renderExperiments(); break;
                    case 'org-hierarchy': renderOrgHierarchy(); break;
                    case 'payroll': renderPayroll(); break;
                    case 'tax': renderTax(); break;
                    case 'calendar': initCalendarSection(); break;
                    case 'expenses': renderExpenses(); break;
                    case 'simulation': renderSimulation(); break;
                    case 'diagnostics': renderDiagnostics(); break;
                    case 'site-diagnostics': renderSiteDiagnostics(); break;
                }
                
                // Track successful section load
                if (typeof trackApiCall === 'function') {
                    trackApiCall(section, apiStartTime, true);
                    
                    // Count data records for the section
                    const config = sectionConfig[section];
                    if (config && config.dataKey && window[config.dataKey]) {
                        const data = window[config.dataKey];
                        const count = Array.isArray(data) ? data.length : 
                                      typeof data === 'object' ? Object.keys(data).length : 0;
                        trackSectionUpdate(section, count);
                    } else {
                        trackSectionUpdate(section, 0);
                    }
                    
                    // Run panel health check after async data loads
                    setTimeout(() => {
                        if (currentSection === section) {
                            updateSectionHealthStatus(section);
                        }
                    }, 3000); // Check panels after 3s to allow async AWS data to load
                }
            } catch (error) {
                console.error(`Error rendering section ${section}:`, error);
                if (typeof trackApiCall === 'function') {
                    trackApiCall(section, apiStartTime, false, error);
                }
            }
        }

        // ==========================================
        // STRESS TEST / SIMULATION
        // ==========================================
        
        // Simulation state
        let simRunning = false;
        let simScalingResults = [];
        let simHistory = JSON.parse(localStorage.getItem('oithSimHistory') || '[]');
        let simLogStartTime = 0;
        
        // Real-life scenario state
        let simRealLifeMetrics = {
            concurrentRequests: 0,
            peakConcurrent: 0,
            rateLimitHits: 0,
            coldStarts: 0,
            totalDbLatency: 0,
            networkErrors: 0,
            blockedUserHits: 0,
            poolExhaustions: 0,
            timerExpirations: 0,
            raceConditions: 0,
            throttledRequests: 0,
            avgResponseTime: 0,
            peakResponseTime: 0,
            requestsInFlight: new Set(),
            matchLocks: new Map(), // Track users currently being matched
            lastRequestTime: new Map(), // For rate limiting
            lambdaInstances: new Map(), // Track warm Lambda instances
            currentHour: 0, // Simulated hour of day
        };
        
        // Peak hours traffic pattern (requests per minute multiplier)
        const PEAK_HOURS_PATTERN = {
            0: 0.1, 1: 0.05, 2: 0.05, 3: 0.05, 4: 0.1, 5: 0.2,
            6: 0.4, 7: 0.7, 8: 1.0, 9: 1.2, 10: 1.0, 11: 0.9,
            12: 1.1, 13: 1.0, 14: 0.9, 15: 0.8, 16: 0.9, 17: 1.3,
            18: 1.8, 19: 2.5, 20: 3.0, 21: 2.8, 22: 2.0, 23: 0.8
        };
        
        // Simulate Lambda cold starts (warm instances last ~15 min)
        function simCheckColdStart(userId) {
            const instance = simRealLifeMetrics.lambdaInstances.get(userId % 10); // 10 Lambda instances
            const now = Date.now();
            if (!instance || (now - instance) > 900000) { // 15 min timeout
                simRealLifeMetrics.lambdaInstances.set(userId % 10, now);
                simRealLifeMetrics.coldStarts++;
                return true;
            }
            return false;
        }
        
        // Simulate rate limiting (20 requests/min per user)
        function simCheckRateLimit(userId) {
            const now = Date.now();
            const lastRequest = simRealLifeMetrics.lastRequestTime.get(userId) || [];
            const recentRequests = lastRequest.filter(t => now - t < 60000);
            
            if (recentRequests.length >= 20) {
                simRealLifeMetrics.rateLimitHits++;
                return true; // Rate limited
            }
            
            recentRequests.push(now);
            simRealLifeMetrics.lastRequestTime.set(userId, recentRequests);
            return false;
        }
        
        // Simulate database latency (5-50ms, with occasional spikes)
        function simGetDbLatency(userCount) {
            let baseLatency = 5 + Math.random() * 20; // 5-25ms base
            
            // Scale with user count (more records = slightly slower)
            baseLatency += Math.log10(userCount) * 2;
            
            // Occasional spike (2% chance of 100-300ms latency)
            if (Math.random() < 0.02) {
                baseLatency = 100 + Math.random() * 200;
            }
            
            // Concurrent load increases latency
            const concurrentFactor = 1 + (simRealLifeMetrics.concurrentRequests * 0.05);
            
            simRealLifeMetrics.totalDbLatency += baseLatency * concurrentFactor;
            return baseLatency * concurrentFactor;
        }
        
        // Simulate network errors (0.5% failure rate, higher under load)
        function simCheckNetworkError() {
            const baseErrorRate = 0.005;
            const loadFactor = Math.min(2, 1 + simRealLifeMetrics.concurrentRequests * 0.01);
            
            if (Math.random() < baseErrorRate * loadFactor) {
                simRealLifeMetrics.networkErrors++;
                return true;
            }
            return false;
        }
        
        // Check for race condition (two users matching same person simultaneously)
        function simCheckRaceCondition(targetEmail) {
            if (simRealLifeMetrics.matchLocks.has(targetEmail)) {
                simRealLifeMetrics.raceConditions++;
                return true;
            }
            simRealLifeMetrics.matchLocks.set(targetEmail, Date.now());
            return false;
        }
        
        function simClearMatchLock(targetEmail) {
            simRealLifeMetrics.matchLocks.delete(targetEmail);
        }
        
        // Reset real-life metrics
        function simResetRealLifeMetrics() {
            simRealLifeMetrics = {
                concurrentRequests: 0,
                peakConcurrent: 0,
                rateLimitHits: 0,
                coldStarts: 0,
                totalDbLatency: 0,
                networkErrors: 0,
                blockedUserHits: 0,
                poolExhaustions: 0,
                timerExpirations: 0,
                raceConditions: 0,
                throttledRequests: 0,
                avgResponseTime: 0,
                peakResponseTime: 0,
                requestsInFlight: new Set(),
                matchLocks: new Map(),
                lastRequestTime: new Map(),
                lambdaInstances: new Map(),
                currentHour: 0
            };
        }
        
        // User generation data
        const SIM_DATA = {
            firstNames: {
                male: ['James', 'John', 'Michael', 'David', 'Robert', 'William', 'Christopher', 'Matthew', 'Daniel', 'Andrew', 'Joshua', 'Ryan', 'Brandon', 'Tyler', 'Kevin', 'Brian', 'Justin', 'Austin', 'Eric', 'Jason'],
                female: ['Emma', 'Olivia', 'Sophia', 'Ava', 'Isabella', 'Mia', 'Charlotte', 'Amelia', 'Harper', 'Evelyn', 'Jessica', 'Ashley', 'Emily', 'Sarah', 'Amanda', 'Jennifer', 'Lauren', 'Samantha', 'Hannah', 'Rachel']
            },
            occupations: ['Software Engineer', 'Teacher', 'Nurse', 'Marketing Manager', 'Designer', 'Accountant', 'Sales Rep', 'Project Manager', 'Lawyer', 'Doctor', 'Consultant', 'Writer', 'Chef', 'Data Scientist'],
            interests: ['Travel', 'Hiking', 'Cooking', 'Reading', 'Movies', 'Music', 'Fitness', 'Photography', 'Art', 'Gaming', 'Dancing', 'Yoga', 'Coffee', 'Wine', 'Sports', 'Dogs', 'Cats', 'Beach'],
            heights: ['5\'4"', '5\'5"', '5\'6"', '5\'7"', '5\'8"', '5\'9"', '5\'10"', '5\'11"', '6\'0"', '6\'1"', '6\'2"'],
            drinking: ['Never', 'Rarely', 'Socially', 'Often'],
            smoking: ['Never', 'Occasionally', 'Regularly'],
            exercise: ['Never', 'Sometimes', 'Regularly', 'Daily'],
            children: ['No children', 'Want someday', 'Have & want more', 'Have, done', 'Not sure'],
            religion: ['Christian', 'Catholic', 'Jewish', 'Muslim', 'Hindu', 'Buddhist', 'Spiritual', 'Agnostic', 'Atheist'],
            lookingFor: ['relationship', 'casual', 'friendship', 'not_sure'],
            cities: [
                { name: 'New York, NY', lat: 40.7128, lng: -74.0060 },
                { name: 'Los Angeles, CA', lat: 34.0522, lng: -118.2437 },
                { name: 'Chicago, IL', lat: 41.8781, lng: -87.6298 },
                { name: 'Houston, TX', lat: 29.7604, lng: -95.3698 },
                { name: 'Phoenix, AZ', lat: 33.4484, lng: -112.0740 },
                { name: 'Austin, TX', lat: 30.2672, lng: -97.7431 },
                { name: 'Seattle, WA', lat: 47.6062, lng: -122.3321 },
                { name: 'Denver, CO', lat: 39.7392, lng: -104.9903 },
                { name: 'Boston, MA', lat: 42.3601, lng: -71.0589 },
                { name: 'Miami, FL', lat: 25.7617, lng: -80.1918 }
            ]
        };
        
        // Helper functions for simulation
        const simRandomChoice = arr => arr[Math.floor(Math.random() * arr.length)];
        const simRandomInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
        const simRandomSubset = (arr, min, max) => {
            const count = simRandomInt(min, Math.min(max, arr.length));
            return [...arr].sort(() => Math.random() - 0.5).slice(0, count);
        };
        
        const SIM_BASE32 = '0123456789bcdefghjkmnpqrstuvwxyz';
        
        function simEncodeGeohash(lat, lng, precision = 4) {
            let idx = 0, bit = 0, evenBit = true, geohash = '';
            let latMin = -90, latMax = 90, lngMin = -180, lngMax = 180;
            
            while (geohash.length < precision) {
                if (evenBit) {
                    const mid = (lngMin + lngMax) / 2;
                    if (lng >= mid) { idx = idx * 2 + 1; lngMin = mid; }
                    else { idx = idx * 2; lngMax = mid; }
                } else {
                    const mid = (latMin + latMax) / 2;
                    if (lat >= mid) { idx = idx * 2 + 1; latMin = mid; }
                    else { idx = idx * 2; latMax = mid; }
                }
                evenBit = !evenBit;
                if (++bit === 5) { geohash += SIM_BASE32[idx]; bit = 0; idx = 0; }
            }
            return geohash;
        }
        
        function simGenerateUser(index, cityFocus = null) {
            const gender = Math.random() < 0.6 ? 'male' : 'female';
            const age = simRandomInt(22, 45);
            let city = simRandomChoice(SIM_DATA.cities);
            
            if (cityFocus) {
                const focusCity = SIM_DATA.cities.find(c => c.name.includes(cityFocus));
                if (focusCity && Math.random() < 0.5) city = focusCity;
            }
            
            const coords = {
                lat: city.lat + (Math.random() - 0.5) * 0.15,
                lng: city.lng + (Math.random() - 0.5) * 0.15
            };
            
            const interestedIn = gender === 'male' 
                ? (Math.random() < 0.92 ? 'women' : 'everyone')
                : (Math.random() < 0.92 ? 'men' : 'everyone');
            
            return {
                email: `user_${index}@test.com`,
                firstName: simRandomChoice(SIM_DATA.firstNames[gender]),
                age,
                gender,
                location: city.name,
                coordinates: coords,
                geohash: simEncodeGeohash(coords.lat, coords.lng, 4),
                occupation: simRandomChoice(SIM_DATA.occupations),
                interests: simRandomSubset(SIM_DATA.interests, 3, 6),
                drinking: simRandomChoice(SIM_DATA.drinking),
                smoking: simRandomChoice(SIM_DATA.smoking),
                exercise: simRandomChoice(SIM_DATA.exercise),
                children: simRandomChoice(SIM_DATA.children),
                religion: simRandomChoice(SIM_DATA.religion),
                lookingFor: simRandomChoice(SIM_DATA.lookingFor),
                matchPreferences: {
                    interestedIn,
                    ageMin: Math.max(18, age - simRandomInt(5, 12)),
                    ageMax: Math.min(99, age + simRandomInt(5, 12)),
                    maxDistance: simRandomChoice([15, 25, 50, 100])
                },
                isVisible: true
            };
        }
        
        function simCalculateDistance(lat1, lng1, lat2, lng2) {
            if (!lat1 || !lng1 || !lat2 || !lng2) return 9999;
            const R = 3959;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLng/2) * Math.sin(dLng/2);
            return Math.round(R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
        }
        
        function simCheckPreferenceMatch(profile, prefs, viewerProfile) {
            const interestedIn = prefs.interestedIn || 'everyone';
            if (interestedIn !== 'everyone') {
                const genderMap = { 'men': 'male', 'women': 'female' };
                if (profile.gender !== genderMap[interestedIn]) return { matches: false };
            }
            
            const profileAge = profile.age || 25;
            if (profileAge < (prefs.ageMin || 18) || profileAge > (prefs.ageMax || 99)) {
                return { matches: false };
            }
            
            const distance = simCalculateDistance(
                viewerProfile.coordinates?.lat, viewerProfile.coordinates?.lng,
                profile.coordinates?.lat, profile.coordinates?.lng
            );
            if (distance > (prefs.maxDistance || 100)) {
                return { matches: false, distance };
            }
            
            return { matches: true, distance };
        }
        
        function simCalculateCompatibility(p1, p2) {
            let score = 50;
            const i1 = p1.interests || [], i2 = p2.interests || [];
            if (i1.length && i2.length) {
                const overlap = i1.filter(i => i2.includes(i)).length;
                score += (overlap / Math.min(i1.length, i2.length)) * 25;
            }
            if (p1.drinking === p2.drinking) score += 3;
            if (p1.smoking === p2.smoking) score += 3;
            if (p1.exercise === p2.exercise) score += 3;
            if (p1.lookingFor === p2.lookingFor) score += 10;
            return Math.min(100, Math.round(score));
        }
        
        function simSimulateMatch(user, allUsers, excludeEmails, useGeohash, options = {}) {
            const start = performance.now();
            const prefs = user.matchPreferences || {};
            const blockedUsers = options.blockedUsers || new Set();
            const enableRealLife = options.enableRealLife || false;
            const userCount = allUsers.length;
            
            let addedLatency = 0;
            let wasRateLimited = false;
            let hadColdStart = false;
            let hadNetworkError = false;
            let hadRaceCondition = false;
            let wasBlocked = false;
            let poolExhausted = false;
            
            // Real-life scenario: Cold start
            if (enableRealLife && options.coldStarts) {
                hadColdStart = simCheckColdStart(user.idx || 0);
                if (hadColdStart) {
                    addedLatency += 250 + Math.random() * 150; // 250-400ms cold start
                }
            }
            
            // Real-life scenario: Rate limiting
            if (enableRealLife && options.rateLimiting) {
                wasRateLimited = simCheckRateLimit(user.idx || 0);
                if (wasRateLimited) {
                    return {
                        duration: performance.now() - start,
                        scanned: 0,
                        prefChecks: 0,
                        compatCalcs: 0,
                        match: null,
                        error: 'RATE_LIMITED',
                        addedLatency: 0
                    };
                }
            }
            
            // Real-life scenario: Network error
            if (enableRealLife && options.networkErrors) {
                hadNetworkError = simCheckNetworkError();
                if (hadNetworkError) {
                    return {
                        duration: performance.now() - start + Math.random() * 1000,
                        scanned: 0,
                        prefChecks: 0,
                        compatCalcs: 0,
                        match: null,
                        error: 'NETWORK_ERROR',
                        addedLatency: 0
                    };
                }
            }
            
            // Real-life scenario: DB latency
            if (enableRealLife && options.dbLatency) {
                addedLatency += simGetDbLatency(userCount);
            }
            
            let candidates;
            if (useGeohash && user.geohash) {
                candidates = allUsers.filter(u => 
                    !excludeEmails.includes(u.email) && u.isVisible &&
                    !blockedUsers.has(u.email) &&
                    u.geohash?.substring(0, 3) === user.geohash.substring(0, 3)
                );
                if (candidates.length < 10) {
                    candidates = allUsers.filter(u => 
                        !excludeEmails.includes(u.email) && u.isVisible && !blockedUsers.has(u.email)
                    );
                }
            } else {
                candidates = allUsers.filter(u => 
                    !excludeEmails.includes(u.email) && u.isVisible && !blockedUsers.has(u.email)
                );
            }
            
            // Check for pool exhaustion
            if (candidates.length === 0) {
                poolExhausted = true;
                if (enableRealLife) simRealLifeMetrics.poolExhaustions++;
                return {
                    duration: performance.now() - start + addedLatency,
                    scanned: 0,
                    prefChecks: 0,
                    compatCalcs: 0,
                    match: null,
                    error: 'POOL_EXHAUSTED',
                    addedLatency
                };
            }
            
            const matches = [];
            let prefChecks = 0, compatCalcs = 0;
            let blockedHits = 0;
            
            for (const c of candidates) {
                // Check if this user is blocked
                if (blockedUsers.has(c.email)) {
                    blockedHits++;
                    continue;
                }
                
                prefChecks++;
                const fit1 = simCheckPreferenceMatch(c, prefs, user);
                if (!fit1.matches) continue;
                
                prefChecks++;
                const fit2 = simCheckPreferenceMatch(user, c.matchPreferences || {}, c);
                if (!fit2.matches) continue;
                
                compatCalcs++;
                matches.push({ email: c.email, compatibility: simCalculateCompatibility(user, c), distance: fit1.distance });
            }
            
            if (enableRealLife && blockedHits > 0) {
                simRealLifeMetrics.blockedUserHits += blockedHits;
            }
            
            matches.sort((a, b) => b.compatibility - a.compatibility);
            
            const topMatch = matches[0] || null;
            
            // Real-life scenario: Race condition check
            if (enableRealLife && options.concurrentUsers && topMatch) {
                hadRaceCondition = simCheckRaceCondition(topMatch.email);
                if (hadRaceCondition) {
                    // Get next best match
                    if (matches.length > 1) {
                        simClearMatchLock(topMatch.email);
                        const secondMatch = matches[1];
                        hadRaceCondition = simCheckRaceCondition(secondMatch.email);
                        if (!hadRaceCondition) {
                            return {
                                duration: performance.now() - start + addedLatency,
                                scanned: candidates.length,
                                prefChecks,
                                compatCalcs,
                                match: secondMatch,
                                hadColdStart,
                                hadRaceCondition: true,
                                recoveredFromRace: true,
                                addedLatency
                            };
                        }
                    }
                }
            }
            
            const totalDuration = performance.now() - start + addedLatency;
            
            return {
                duration: totalDuration,
                scanned: candidates.length,
                prefChecks,
                compatCalcs,
                match: topMatch,
                hadColdStart,
                hadRaceCondition,
                addedLatency,
                poolExhausted
            };
        }
        
        // Simulation logging
        function simLog(message, type = 'info') {
            const output = document.getElementById('simLogOutput');
            if (!output) return;
            
            const elapsed = simLogStartTime ? ((Date.now() - simLogStartTime) / 1000).toFixed(2) : '00.00';
            const colors = {
                info: '#58a6ff',
                success: '#3fb950',
                warning: '#d29922',
                error: '#f85149'
            };
            
            const line = document.createElement('div');
            line.style.cssText = 'display: flex; gap: 12px;';
            line.innerHTML = `<span style="color: #7d8590;">[${elapsed}s]</span><span style="color: ${colors[type] || colors.info}">${message}</span>`;
            output.appendChild(line);
            output.scrollTop = output.scrollHeight;
        }
        
        function clearSimLog() {
            const output = document.getElementById('simLogOutput');
            if (output) {
                output.innerHTML = '';
                simLogStartTime = Date.now();
                simLog('Console cleared.', 'info');
            }
        }
        
        function updateSimProgress(percent, usersGen, matchesRun, avgTime) {
            const progressBar = document.getElementById('simProgressBar');
            const progressText = document.getElementById('simProgress');
            const usersEl = document.getElementById('simUsersGenerated');
            const matchesEl = document.getElementById('simMatchesRun');
            const avgTimeEl = document.getElementById('simAvgTime');
            
            if (progressBar) progressBar.style.width = percent + '%';
            if (progressText) progressText.textContent = percent + '%';
            if (usersEl) usersEl.textContent = usersGen.toLocaleString();
            if (matchesEl) matchesEl.textContent = matchesRun.toLocaleString();
            if (avgTimeEl) avgTimeEl.textContent = avgTime ? avgTime.toFixed(1) : '';
        }
        
        function toggleSimConsole() {
            const body = document.getElementById('simConsoleBody');
            const toggle = document.getElementById('simConsoleToggle');
            if (body.style.display === 'none') {
                body.style.display = 'block';
                toggle.style.transform = 'rotate(0deg)';
            } else {
                body.style.display = 'none';
                toggle.style.transform = 'rotate(-90deg)';
            }
        }
        
        function toggleSimHistory() {
            const body = document.getElementById('simHistoryBody');
            const toggle = document.getElementById('simHistoryToggle');
            if (body.style.display === 'none') {
                body.style.display = 'block';
                toggle.style.transform = 'rotate(0deg)';
                renderSimHistory();
            } else {
                body.style.display = 'none';
                toggle.style.transform = 'rotate(-90deg)';
            }
        }
        
        // Main simulation function
        async function runMatchingSimulation(realLifeMode = null) {
            if (simRunning) return;
            simRunning = true;
            simResetRealLifeMetrics();
            
            const userCount = parseInt(document.getElementById('simUserCount')?.value || 1000);
            const matchAttempts = parseInt(document.getElementById('simMatchAttempts')?.value || 100);
            const useGeohash = document.getElementById('simUseGeohash')?.value === 'true';
            const cityFocus = document.getElementById('simCityFocus')?.value || null;
            const autoSave = document.getElementById('simAutoSave')?.checked;
            
            // Read real-life scenario settings
            const enableRealLife = realLifeMode === true || (realLifeMode === null && (
                document.getElementById('simConcurrentUsers')?.checked ||
                document.getElementById('simRateLimiting')?.checked ||
                document.getElementById('simColdStarts')?.checked ||
                document.getElementById('simDbLatency')?.checked ||
                document.getElementById('simPeakHours')?.checked
            ));
            
            const realLifeOptions = {
                enableRealLife,
                concurrentUsers: document.getElementById('simConcurrentUsers')?.checked || realLifeMode,
                rateLimiting: document.getElementById('simRateLimiting')?.checked || realLifeMode,
                coldStarts: document.getElementById('simColdStarts')?.checked || realLifeMode,
                dbLatency: document.getElementById('simDbLatency')?.checked || realLifeMode,
                blockedUsers: document.getElementById('simBlockedUsers')?.checked || realLifeMode,
                poolExhaustion: document.getElementById('simPoolExhaustion')?.checked || realLifeMode,
                timerExpiry: document.getElementById('simTimerExpiry')?.checked || realLifeMode,
                networkErrors: document.getElementById('simNetworkErrors')?.checked || realLifeMode,
                peakHours: document.getElementById('simPeakHours')?.checked || realLifeMode
            };
            
            // Determine simulation mode based on user count
            const SAMPLE_THRESHOLD = 50000; // Above this, use sampling mode
            const useSampling = userCount > SAMPLE_THRESHOLD;
            const sampleSize = useSampling ? Math.min(50000, Math.max(10000, Math.floor(userCount / 100))) : userCount;
            const scaleFactor = useSampling ? userCount / sampleSize : 1;
            
            // Update UI
            document.getElementById('runSimBtn').disabled = true;
            document.getElementById('simStatusBadge').textContent = 'Running...';
            document.getElementById('simStatusBadge').style.background = 'var(--warning)';
            
            simLogStartTime = Date.now();
            clearSimLog();
            simLog(`Starting simulation: ${userCount.toLocaleString()} users, ${matchAttempts} match attempts`, 'info');
            simLog(`Geohash indexing: ${useGeohash ? 'Enabled (Optimized)' : 'Disabled (Full Scan)'}`, 'info');
            if (cityFocus) simLog(`City focus: ${cityFocus}`, 'info');
            
            if (enableRealLife) {
                simLog(` Real-life scenarios ENABLED:`, 'info');
                if (realLifeOptions.concurrentUsers) simLog(`    Concurrent users (parallel requests)`, 'info');
                if (realLifeOptions.peakHours) simLog(`    Peak hours traffic (3x spike at 8-10 PM)`, 'info');
                if (realLifeOptions.rateLimiting) simLog(`    Rate limiting (20 req/min)`, 'info');
                if (realLifeOptions.coldStarts) simLog(`    Lambda cold starts (~300ms)`, 'info');
                if (realLifeOptions.dbLatency) simLog(`    Database latency (5-50ms)`, 'info');
                if (realLifeOptions.blockedUsers) simLog(`    Blocked users (2%)`, 'info');
                if (realLifeOptions.networkErrors) simLog(`    Network failures (0.5%)`, 'info');
                if (realLifeOptions.poolExhaustion) simLog(`    Pool exhaustion tracking`, 'info');
            }
            
            if (useSampling) {
                simLog(` Large-scale mode: Using ${sampleSize.toLocaleString()} sample users (${scaleFactor.toFixed(0)}x extrapolation)`, 'warning');
                simLog(` Results will be extrapolated to estimate ${userCount.toLocaleString()} user behavior`, 'info');
            }
            
            // Generate users (sample size for large counts)
            const actualGenerateCount = useSampling ? sampleSize : userCount;
            updateSimProgress(10, 0, 0, 0);
            simLog(`Generating ${actualGenerateCount.toLocaleString()} ${useSampling ? 'sample ' : ''}user profiles...`);
            
            await new Promise(r => setTimeout(r, 50));
            
            const users = [];
            const blockedUsers = new Set();
            const batchSize = Math.max(500, Math.floor(actualGenerateCount / 100));
            for (let i = 0; i < actualGenerateCount; i++) {
                const user = simGenerateUser(i, cityFocus);
                user.idx = i;
                users.push(user);
                
                // 2% of users are blocked
                if (realLifeOptions.blockedUsers && Math.random() < 0.02) {
                    blockedUsers.add(user.email);
                }
                
                if ((i + 1) % batchSize === 0) {
                    updateSimProgress(10 + (i / actualGenerateCount) * 20, useSampling ? Math.floor((i + 1) * scaleFactor) : i + 1, 0, 0);
                    await new Promise(r => setTimeout(r, 0));
                }
            }
            
            simLog(`Generated ${actualGenerateCount.toLocaleString()} users${useSampling ? ` (representing ${userCount.toLocaleString()})` : ''}`, 'success');
            if (blockedUsers.size > 0) {
                simLog(` ${blockedUsers.size} users marked as blocked (${((blockedUsers.size / actualGenerateCount) * 100).toFixed(1)}%)`, 'info');
            }
            
            // Calculate pool stats
            const genderStats = { male: 0, female: 0 };
            const cityStats = {};
            let totalAge = 0;
            
            for (const u of users) {
                genderStats[u.gender]++;
                cityStats[u.location] = (cityStats[u.location] || 0) + 1;
                totalAge += u.age;
            }
            
            // Run matching with real-life scenarios
            updateSimProgress(35, userCount, 0, 0);
            
            // Calculate concurrent batch size based on peak hours
            let effectiveMatchAttempts = matchAttempts;
            let concurrentBatchSize = 1;
            
            if (realLifeOptions.peakHours) {
                // Simulate across a 24-hour period
                simLog(` Simulating 24-hour traffic pattern with peak at 8-10 PM...`, 'info');
            }
            
            if (realLifeOptions.concurrentUsers) {
                // Simulate batches of concurrent requests
                concurrentBatchSize = Math.max(1, Math.min(50, Math.floor(userCount / 1000)));
                simLog(` Simulating ${concurrentBatchSize} concurrent users per batch...`, 'info');
            }
            
            simLog(`Running ${matchAttempts} match attempts...`);
            
            const results = [];
            const matchHistory = new Map();
            let runningAvgTime = 0;
            
            // Track errors by type
            let rateLimitedCount = 0;
            let networkErrorCount = 0;
            let poolExhaustedCount = 0;
            let coldStartCount = 0;
            let raceConditionCount = 0;
            
            // Simulate over time
            const totalSimulatedHours = realLifeOptions.peakHours ? 24 : 1;
            const attemptsPerHour = Math.ceil(matchAttempts / totalSimulatedHours);
            
            for (let hour = 0; hour < totalSimulatedHours; hour++) {
                simRealLifeMetrics.currentHour = hour;
                const hourMultiplier = realLifeOptions.peakHours ? PEAK_HOURS_PATTERN[hour] : 1;
                const hourAttempts = Math.ceil(attemptsPerHour * hourMultiplier);
                
                if (realLifeOptions.peakHours && hour % 6 === 0) {
                    simLog(` Hour ${hour}:00 - Traffic multiplier: ${hourMultiplier.toFixed(1)}x (${hourAttempts} requests)`, 'info');
                }
                
                for (let i = 0; i < hourAttempts && results.length < matchAttempts; i++) {
                    // Simulate concurrent batch
                    const batchResults = [];
                    const batchUsers = [];
                    
                    for (let j = 0; j < concurrentBatchSize && results.length + batchResults.length < matchAttempts; j++) {
                        const user = users[Math.floor(Math.random() * users.length)];
                        batchUsers.push(user);
                    }
                    
                    // Track concurrent requests
                    simRealLifeMetrics.concurrentRequests = batchUsers.length;
                    simRealLifeMetrics.peakConcurrent = Math.max(simRealLifeMetrics.peakConcurrent, batchUsers.length);
                    
                    // Process batch (simulating parallel execution)
                    for (const user of batchUsers) {
                        const excluded = matchHistory.get(user.email) || [user.email];
                        
                        const result = simSimulateMatch(user, users, excluded, useGeohash, {
                            ...realLifeOptions,
                            blockedUsers
                        });
                        
                        // Track error types
                        if (result.error === 'RATE_LIMITED') rateLimitedCount++;
                        if (result.error === 'NETWORK_ERROR') networkErrorCount++;
                        if (result.error === 'POOL_EXHAUSTED') poolExhaustedCount++;
                        if (result.hadColdStart) coldStartCount++;
                        if (result.hadRaceCondition) raceConditionCount++;
                        
                        batchResults.push(result);
                        
                        if (result.match && !result.error) {
                            const history = matchHistory.get(user.email) || [user.email];
                            history.push(result.match.email);
                            matchHistory.set(user.email, history);
                            
                            // Clear lock after "decision"
                            if (realLifeOptions.concurrentUsers) {
                                simClearMatchLock(result.match.email);
                            }
                        }
                    }
                    
                    simRealLifeMetrics.concurrentRequests = 0;
                    results.push(...batchResults);
                    
                    runningAvgTime = results.reduce((a, r) => a + r.duration, 0) / results.length;
                    
                    if (results.length % 10 === 0) {
                        updateSimProgress(35 + (results.length / matchAttempts) * 55, userCount, results.length, runningAvgTime);
                        await new Promise(r => setTimeout(r, 0));
                    }
                }
            }
            
            // Log real-life scenario summary
            if (enableRealLife) {
                simLog(``, 'info');
                simLog(` Real-Life Scenario Results:`, 'info');
                if (coldStartCount > 0) simLog(`    Cold starts: ${coldStartCount} (${((coldStartCount / results.length) * 100).toFixed(1)}%)`, 'warning');
                if (rateLimitedCount > 0) simLog(`    Rate limited: ${rateLimitedCount} requests blocked`, 'error');
                if (networkErrorCount > 0) simLog(`    Network errors: ${networkErrorCount} failures`, 'error');
                if (poolExhaustedCount > 0) simLog(`    Pool exhausted: ${poolExhaustedCount} users with no matches`, 'warning');
                if (raceConditionCount > 0) simLog(`    Race conditions: ${raceConditionCount} conflicts detected`, 'warning');
                if (simRealLifeMetrics.blockedUserHits > 0) simLog(`    Blocked user encounters: ${simRealLifeMetrics.blockedUserHits}`, 'info');
                simLog(`    Peak concurrent requests: ${simRealLifeMetrics.peakConcurrent}`, 'info');
                if (simRealLifeMetrics.totalDbLatency > 0) {
                    const avgDbLatency = simRealLifeMetrics.totalDbLatency / results.length;
                    simLog(`    Avg DB latency: ${avgDbLatency.toFixed(1)}ms`, avgDbLatency > 30 ? 'warning' : 'success');
                }
            }
            
            // Calculate metrics
            const times = results.map(r => r.duration);
            const scans = results.map(r => r.scanned);
            const successful = results.filter(r => r.match).length;
            
            const avgTime = times.reduce((a, b) => a + b, 0) / times.length;
            const sortedTimes = [...times].sort((a, b) => a - b);
            const p95 = sortedTimes[Math.floor(sortedTimes.length * 0.95)] || 0;
            const avgScans = scans.reduce((a, b) => a + b, 0) / scans.length;
            const totalDuration = times.reduce((a, b) => a + b, 0);
            
            updateSimProgress(95, userCount, matchAttempts, avgTime);
            
            // Update metrics display
            document.getElementById('simMetricUsers').textContent = userCount.toLocaleString();
            const successRate = (successful / matchAttempts) * 100;
            document.getElementById('simMetricSuccess').textContent = successRate.toFixed(1) + '%';
            document.getElementById('simMetricSuccess').style.color = successRate > 50 ? 'var(--success)' : 'var(--warning)';
            document.getElementById('simMetricAvgTime').textContent = avgTime.toFixed(1) + 'ms';
            document.getElementById('simMetricAvgTime').style.color = avgTime < 50 ? 'var(--success)' : avgTime < 200 ? 'var(--warning)' : 'var(--danger)';
            document.getElementById('simMetricP95').textContent = p95.toFixed(1) + 'ms';
            document.getElementById('simMetricP95').style.color = p95 < 200 ? 'var(--success)' : p95 < 500 ? 'var(--warning)' : 'var(--danger)';
            document.getElementById('simMetricScans').textContent = Math.round(avgScans).toLocaleString();
            document.getElementById('simMetricScans').style.color = avgScans < userCount * 0.3 ? 'var(--success)' : 'var(--warning)';
            document.getElementById('simMetricDuration').textContent = totalDuration.toFixed(0) + 'ms';
            
            // Render charts
            renderSimTimeChart(times);
            renderSimUserChart(genderStats, Math.round(totalAge / userCount));
            renderSimMatchChart(successful, matchAttempts, avgTime, avgScans);
            
            // Detect issues - extrapolate scan counts for large scale
            const issues = [];
            const extrapolatedScans = avgScans * scaleFactor;
            const extrapolatedTime = useSampling ? avgTime * Math.log10(scaleFactor + 1) : avgTime; // O(log n) estimate
            const extrapolatedP95 = useSampling ? p95 * Math.log10(scaleFactor + 1) : p95;
            
            // === REAL-LIFE SCENARIO ISSUES ===
            if (enableRealLife) {
                // Rate limiting issues
                if (rateLimitedCount > matchAttempts * 0.01) {
                    issues.push({
                        severity: 'high',
                        title: 'Rate Limiting Blocking Users',
                        detail: `${rateLimitedCount} requests (${((rateLimitedCount / matchAttempts) * 100).toFixed(1)}%) were rate limited`,
                        recommendation: 'Implement request queuing, add retry logic with exponential backoff, or increase rate limits for authenticated users'
                    });
                }
                
                // Network error issues
                if (networkErrorCount > matchAttempts * 0.005) {
                    issues.push({
                        severity: 'high',
                        title: 'High Network Failure Rate',
                        detail: `${networkErrorCount} network errors (${((networkErrorCount / matchAttempts) * 100).toFixed(2)}%) - above 0.5% threshold`,
                        recommendation: 'Implement circuit breakers, add retry with jitter, use multiple availability zones'
                    });
                }
                
                // Cold start impact
                if (coldStartCount > matchAttempts * 0.1) {
                    issues.push({
                        severity: 'medium',
                        title: 'Frequent Cold Starts Impacting Performance',
                        detail: `${coldStartCount} cold starts (${((coldStartCount / matchAttempts) * 100).toFixed(1)}%) adding ~300ms latency each`,
                        recommendation: 'Use Lambda Provisioned Concurrency, implement warming functions, or consider container-based deployment'
                    });
                }
                
                // Race conditions
                if (raceConditionCount > matchAttempts * 0.02) {
                    issues.push({
                        severity: 'high',
                        title: 'Race Conditions in Concurrent Matching',
                        detail: `${raceConditionCount} race conditions (${((raceConditionCount / matchAttempts) * 100).toFixed(1)}%) - users competing for same matches`,
                        recommendation: 'Implement distributed locking (Redis/DynamoDB), use optimistic concurrency, or add match reservation system'
                    });
                }
                
                // Pool exhaustion
                if (poolExhaustedCount > matchAttempts * 0.05) {
                    issues.push({
                        severity: 'medium',
                        title: 'Match Pool Exhaustion',
                        detail: `${poolExhaustedCount} users (${((poolExhaustedCount / matchAttempts) * 100).toFixed(1)}%) ran out of potential matches`,
                        recommendation: 'Expand search radius gradually, implement "refresh pool" feature, suggest profile changes to increase visibility'
                    });
                }
                
                // Peak hour stress
                if (realLifeOptions.peakHours && simRealLifeMetrics.peakConcurrent > 20) {
                    issues.push({
                        severity: 'medium',
                        title: 'High Concurrency During Peak Hours',
                        detail: `Peak of ${simRealLifeMetrics.peakConcurrent} concurrent requests during 8-10 PM spike`,
                        recommendation: 'Implement request throttling, use SQS queues for matching, scale Lambda concurrency limits'
                    });
                }
                
                // DB latency under load
                if (simRealLifeMetrics.totalDbLatency > 0) {
                    const avgDbLatency = simRealLifeMetrics.totalDbLatency / results.length;
                    if (avgDbLatency > 30) {
                        issues.push({
                            severity: 'medium',
                            title: 'Database Latency Under Load',
                            detail: `Average DB latency is ${avgDbLatency.toFixed(1)}ms (target: < 30ms)`,
                            recommendation: 'Enable DynamoDB DAX caching, use read replicas, implement connection pooling'
                        });
                    }
                }
            }
            
            // === EXISTING PERFORMANCE ISSUES ===
            if (avgScans > sampleSize * 0.5) {
                issues.push({
                    severity: 'high',
                    title: 'Full Table Scans Detected',
                    detail: `Scanning ${Math.round(avgScans)} profiles per match (${((avgScans / sampleSize) * 100).toFixed(1)}% of ${useSampling ? 'sample' : 'users'})${useSampling ? `. At ${userCount.toLocaleString()} users, this would scan ~${Math.round(extrapolatedScans).toLocaleString()} profiles!` : ''}`,
                    recommendation: 'Implement GSI on geohash_prefix for location-based filtering in DynamoDB'
                });
            }
            
            if (p95 > 200 || (useSampling && extrapolatedP95 > 200)) {
                issues.push({
                    severity: 'high',
                    title: 'Slow P95 Response Time',
                    detail: `P95 is ${p95.toFixed(1)}ms${useSampling ? ` (extrapolated: ~${extrapolatedP95.toFixed(0)}ms at full scale)` : ''} (target: < 200ms for good UX)`,
                    recommendation: 'Add caching layer (ElastiCache/Redis) or pre-compute compatibility scores'
                });
            }
            
            if (successRate < 50) {
                issues.push({
                    severity: 'medium',
                    title: 'Low Match Success Rate',
                    detail: `Only ${successRate.toFixed(1)}% of attempts found matches`,
                    recommendation: 'Consider expanding geohash search radius or relaxing preference matching'
                });
            }
            
            if (avgScans > 500 || (useSampling && extrapolatedScans > 5000)) {
                issues.push({
                    severity: 'medium',
                    title: 'High Scan Count May Hit Lambda Limits',
                    detail: `Scanning ${Math.round(avgScans)} profiles${useSampling ? ` (~${Math.round(extrapolatedScans).toLocaleString()} at full scale)` : ''} may timeout on Lambda with 15s limit`,
                    recommendation: 'Implement pagination or move to Step Functions for large pools'
                });
            }
            
            // Large scale specific warnings
            if (userCount >= 1000000) {
                issues.push({
                    severity: 'medium',
                    title: 'Million+ User Scale Considerations',
                    detail: `At ${(userCount / 1000000).toFixed(1)}M users, you need distributed infrastructure`,
                    recommendation: 'Consider: DynamoDB On-Demand, ElastiCache cluster, Lambda provisioned concurrency, CloudFront caching'
                });
            }
            
            if (userCount >= 10000000) {
                issues.push({
                    severity: 'high',
                    title: 'Enterprise Scale Architecture Required',
                    detail: `At ${(userCount / 1000000).toFixed(0)}M users, single-region architecture won't suffice`,
                    recommendation: 'Implement: Multi-region replication, sharded matching pools, dedicated RDS Aurora clusters, global accelerator'
                });
            }
            
            if (userCount >= 50000000 && !useGeohash) {
                issues.push({
                    severity: 'high',
                    title: 'Geohash Indexing Critical at This Scale',
                    detail: `Full table scans at ${(userCount / 1000000).toFixed(0)}M users will cause severe performance issues`,
                    recommendation: 'Enable geohash indexing immediately - this is non-negotiable at 50M+ users'
                });
            }
            
            renderSimIssues(issues);
            
            // Update real-life metrics display if enabled
            if (enableRealLife) {
                updateRealLifeMetricsDisplay({
                    coldStarts: coldStartCount,
                    rateLimited: rateLimitedCount,
                    networkErrors: networkErrorCount,
                    raceConditions: raceConditionCount,
                    peakConcurrent: simRealLifeMetrics.peakConcurrent,
                    avgDbLatency: simRealLifeMetrics.totalDbLatency > 0 ? 
                        (simRealLifeMetrics.totalDbLatency / results.length).toFixed(1) : 0,
                    poolExhausted: poolExhaustedCount
                }, realLifeOptions.peakHours);
            } else {
                updateRealLifeMetricsDisplay(null);
            }
            
            // Log summary
            simLog(`Simulation complete!`, 'success');
            simLog(`Match success rate: ${successRate.toFixed(1)}%`);
            simLog(`Average match time: ${avgTime.toFixed(2)}ms | P95: ${p95.toFixed(2)}ms`);
            simLog(`Avg profiles scanned per match: ${Math.round(avgScans)}`);
            
            if (issues.length > 0) {
                simLog(` ${issues.length} potential issues detected`, 'warning');
            } else {
                simLog(` No critical issues at this scale`, 'success');
            }
            
            // Store for scaling comparison
            const resultData = {
                timestamp: new Date().toISOString(),
                userCount,
                matchAttempts,
                useGeohash,
                cityFocus,
                avgTime,
                p95,
                avgScans: Math.round(avgScans),
                successRate: successRate.toFixed(1),
                issues: issues.length,
                totalDuration,
                // Real-life scenario metrics
                realLifeEnabled: enableRealLife,
                realLifeMetrics: enableRealLife ? {
                    coldStarts: coldStartCount,
                    rateLimited: rateLimitedCount,
                    networkErrors: networkErrorCount,
                    poolExhausted: poolExhaustedCount,
                    raceConditions: raceConditionCount,
                    peakConcurrent: simRealLifeMetrics.peakConcurrent,
                    avgDbLatency: simRealLifeMetrics.totalDbLatency > 0 ? 
                        (simRealLifeMetrics.totalDbLatency / results.length).toFixed(1) : 0
                } : null
            };
            
            simScalingResults.push(resultData);
            
            if (simScalingResults.length > 1) {
                renderSimScalingChart(simScalingResults);
            }
            
            // Auto-save to history (local + AWS)
            if (autoSave) {
                simHistory.unshift(resultData);
                if (simHistory.length > 50) simHistory = simHistory.slice(0, 50);
                localStorage.setItem('oithSimHistory', JSON.stringify(simHistory));
                document.getElementById('simHistoryCount').textContent = `${simHistory.length} saved`;
                
                // Also save to AWS (async, don't block)
                saveStressTestToAWS(resultData).catch(err => {
                    console.log('AWS sync skipped:', err.message);
                });
            }
            
            updateSimProgress(100, userCount, matchAttempts, avgTime);
            
            // Reset UI
            document.getElementById('runSimBtn').disabled = false;
            document.getElementById('simStatusBadge').textContent = 'Complete';
            document.getElementById('simStatusBadge').style.background = 'var(--success)';
            
            simRunning = false;
            
            return resultData;
        }
        
        async function runScalingTestAdmin() {
            simScalingResults = [];
            const counts = [100, 1000, 10000, 100000, 1000000];
            
            clearSimLog();
            simLog('Starting scaling test across multiple user counts (100  1M)...', 'info');
            simLog('Note: Larger counts use sampling for performance', 'info');
            
            for (const count of counts) {
                document.getElementById('simUserCount').value = count;
                await runMatchingSimulation();
                await new Promise(r => setTimeout(r, 500));
            }
            
            simLog('Scaling test complete!', 'success');
            
            // Analysis
            if (simScalingResults.length >= 2) {
                const first = simScalingResults[0];
                const last = simScalingResults[simScalingResults.length - 1];
                const userScale = last.userCount / first.userCount;
                const timeScale = last.avgTime / first.avgTime;
                
                simLog(`User scale: ${userScale.toLocaleString()}x (${first.userCount.toLocaleString()}  ${last.userCount.toLocaleString()})`, 'info');
                simLog(`Time scale: ${timeScale.toFixed(2)}x`, timeScale > userScale * 0.1 ? 'warning' : 'success');
                
                if (timeScale > userScale * 0.5) {
                    simLog(' Algorithm appears to scale poorly (O(n) or worse)', 'warning');
                } else if (timeScale > userScale * 0.1) {
                    simLog(' Algorithm scales moderately (O(log n) - may need optimization at 10M+)', 'warning');
                } else {
                    simLog(' Algorithm scales well (sub-linear complexity)', 'success');
                }
                
                // Estimate time at 100M
                const estimate100M = first.avgTime * Math.pow(timeScale, Math.log10(100000000 / first.userCount) / Math.log10(userScale));
                simLog(` Estimated avg time at 100M users: ~${estimate100M.toFixed(0)}ms`, estimate100M > 1000 ? 'error' : estimate100M > 200 ? 'warning' : 'success');
            }
        }
        
        async function runMassiveScaleTest() {
            simScalingResults = [];
            const counts = [1000000, 5000000, 10000000, 25000000, 50000000, 100000000];
            
            clearSimLog();
            simLog(' Starting MASSIVE scale test (1M  100M users)...', 'info');
            simLog(' Using sampling extrapolation for realistic estimates', 'info');
            
            for (const count of counts) {
                document.getElementById('simUserCount').value = count;
                await runMatchingSimulation();
                await new Promise(r => setTimeout(r, 500));
            }
            
            simLog('Massive scale test complete!', 'success');
            
            if (simScalingResults.length >= 2) {
                const first = simScalingResults[0];
                const last = simScalingResults[simScalingResults.length - 1];
                
                simLog(` Results from ${first.userCount.toLocaleString()} to ${last.userCount.toLocaleString()} users:`, 'info');
                simLog(`   Avg time growth: ${(last.avgTime / first.avgTime).toFixed(2)}x`, 'info');
                simLog(`   P95 at max scale: ${last.p95.toFixed(1)}ms`, last.p95 > 500 ? 'error' : 'success');
            }
        }
        
        async function runComparisonTest() {
            simScalingResults = [];
            const userCount = parseInt(document.getElementById('simUserCount')?.value || 1000);
            
            clearSimLog();
            simLog('Starting comparison test: Geohash vs Full Scan...', 'info');
            
            // Run with geohash
            document.getElementById('simUseGeohash').value = 'true';
            simLog('Running with Geohash indexing enabled...', 'info');
            await runMatchingSimulation();
            await new Promise(r => setTimeout(r, 500));
            
            // Run without geohash
            document.getElementById('simUseGeohash').value = 'false';
            simLog('Running with Full Scan (no indexing)...', 'info');
            await runMatchingSimulation();
            
            // Reset to geohash
            document.getElementById('simUseGeohash').value = 'true';
            
            simLog('Comparison test complete!', 'success');
            
            if (simScalingResults.length >= 2) {
                const withGeo = simScalingResults[0];
                const withoutGeo = simScalingResults[1];
                const speedup = withoutGeo.avgTime / withGeo.avgTime;
                const scanReduction = ((withoutGeo.avgScans - withGeo.avgScans) / withoutGeo.avgScans * 100);
                
                simLog(`Geohash speedup: ${speedup.toFixed(2)}x faster`, speedup > 1.5 ? 'success' : 'warning');
                simLog(`Scan reduction: ${scanReduction.toFixed(1)}% fewer profiles scanned`, scanReduction > 30 ? 'success' : 'info');
            }
        }
        
        async function runCityAnalysis() {
            simScalingResults = [];
            const cities = ['New York', 'Los Angeles', 'Chicago', 'Austin', 'Miami'];
            
            clearSimLog();
            simLog('Starting city distribution analysis...', 'info');
            
            for (const city of cities) {
                document.getElementById('simCityFocus').value = city;
                simLog(`Analyzing ${city}...`, 'info');
                await runMatchingSimulation();
                await new Promise(r => setTimeout(r, 500));
            }
            
            // Reset
            document.getElementById('simCityFocus').value = '';
            
            simLog('City analysis complete!', 'success');
        }
        
        // Full Real-Life Stress Test - simulates production conditions
        async function runRealLifeStressTest() {
            simScalingResults = [];
            
            clearSimLog();
            simLog(' FULL REAL-LIFE STRESS TEST', 'info');
            simLog('', 'info');
            simLog('Testing production scenarios that can break your app:', 'info');
            simLog(' Concurrent users competing for matches', 'info');
            simLog(' Peak hour traffic (3x spike at 8-10 PM)', 'info');
            simLog(' Rate limiting under load', 'info');
            simLog(' Lambda cold starts', 'info');
            simLog(' Database latency and throttling', 'info');
            simLog(' Network failures (0.5%)', 'info');
            simLog(' Race conditions (two users matching same person)', 'info');
            simLog(' Match pool exhaustion', 'info');
            simLog('', 'info');
            
            // Enable all real-life scenarios
            const checkboxes = [
                'simConcurrentUsers', 'simRateLimiting', 'simColdStarts', 
                'simDbLatency', 'simBlockedUsers', 'simPoolExhaustion',
                'simNetworkErrors', 'simPeakHours'
            ];
            checkboxes.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.checked = true;
            });
            
            // Run tests at increasing scales
            const testConfigs = [
                { users: 1000, attempts: 200, label: 'Small Scale (1K users)' },
                { users: 10000, attempts: 500, label: 'Medium Scale (10K users)' },
                { users: 50000, attempts: 1000, label: 'Large Scale (50K users)' },
                { users: 100000, attempts: 500, label: 'Very Large (100K users, sampled)' }
            ];
            
            for (const config of testConfigs) {
                simLog(``, 'info');
                simLog(` Testing: ${config.label}`, 'info');
                simLog(``, 'info');
                
                document.getElementById('simUserCount').value = config.users;
                document.getElementById('simMatchAttempts').value = config.attempts;
                
                await runMatchingSimulation(true); // Force real-life mode
                await new Promise(r => setTimeout(r, 1000));
            }
            
            // Summary
            simLog(``, 'info');
            simLog(` STRESS TEST COMPLETE`, 'success');
            simLog(``, 'info');
            
            if (simScalingResults.length > 0) {
                const totalIssues = simScalingResults.reduce((sum, r) => sum + r.issues, 0);
                const worstP95 = Math.max(...simScalingResults.map(r => r.p95));
                const avgSuccess = simScalingResults.reduce((sum, r) => sum + parseFloat(r.successRate), 0) / simScalingResults.length;
                
                simLog(` Summary across ${simScalingResults.length} test runs:`, 'info');
                simLog(`   Total issues detected: ${totalIssues}`, totalIssues > 5 ? 'error' : totalIssues > 0 ? 'warning' : 'success');
                simLog(`   Worst P95 response: ${worstP95.toFixed(1)}ms`, worstP95 > 500 ? 'error' : worstP95 > 200 ? 'warning' : 'success');
                simLog(`   Average match success: ${avgSuccess.toFixed(1)}%`, avgSuccess < 50 ? 'warning' : 'success');
                
                // Check for critical real-life issues
                let criticalIssues = 0;
                for (const r of simScalingResults) {
                    if (r.realLifeMetrics) {
                        if (r.realLifeMetrics.raceConditions > 0) criticalIssues++;
                        if (r.realLifeMetrics.rateLimited > r.matchAttempts * 0.01) criticalIssues++;
                        if (r.realLifeMetrics.networkErrors > r.matchAttempts * 0.005) criticalIssues++;
                    }
                }
                
                if (criticalIssues > 0) {
                    simLog(``, 'info');
                    simLog(` ${criticalIssues} CRITICAL PRODUCTION ISSUES FOUND!`, 'error');
                    simLog(`   These WILL cause problems in real deployment.`, 'error');
                    simLog(`   Review the detected issues above and implement fixes before launch.`, 'error');
                } else {
                    simLog(``, 'info');
                    simLog(` System appears stable under real-life conditions`, 'success');
                    simLog(`   Continue monitoring during beta testing phase`, 'info');
                }
            }
        }
        
        // Quick peak hour stress test
        async function runPeakHourTest() {
            simScalingResults = [];
            
            clearSimLog();
            simLog(' PEAK HOUR STRESS TEST', 'info');
            simLog('Simulating traffic patterns for a 24-hour period...', 'info');
            simLog('Focus: Evening peak (7 PM - 11 PM) with 3x traffic spike', 'info');
            
            // Enable only peak hours and concurrent users
            document.getElementById('simConcurrentUsers').checked = true;
            document.getElementById('simPeakHours').checked = true;
            document.getElementById('simDbLatency').checked = true;
            document.getElementById('simColdStarts').checked = true;
            
            const userCount = parseInt(document.getElementById('simUserCount')?.value || 10000);
            document.getElementById('simMatchAttempts').value = Math.min(2000, Math.max(500, Math.floor(userCount / 10)));
            
            await runMatchingSimulation(true);
            
            simLog(``, 'info');
            simLog(`Peak hour analysis complete!`, 'success');
            simLog(`Review the hourly traffic logs above for bottleneck identification.`, 'info');
        }
        
        function renderSimTimeChart(times) {
            const container = document.getElementById('simTimeChart');
            if (!container) return;
            
            const buckets = [0, 10, 25, 50, 100, 200, 500, 1000];
            const counts = new Array(buckets.length).fill(0);
            
            for (const t of times) {
                for (let i = buckets.length - 1; i >= 0; i--) {
                    if (t >= buckets[i]) { counts[i]++; break; }
                }
            }
            
            const max = Math.max(...counts);
            
            let html = '<div style="display: flex; flex-direction: column; gap: 8px;">';
            for (let i = 0; i < buckets.length - 1; i++) {
                const label = `${buckets[i]}-${buckets[i+1]}ms`;
                const pct = (counts[i] / max) * 100;
                const color = buckets[i] < 50 ? 'var(--success)' : buckets[i] < 200 ? 'var(--warning)' : 'var(--danger)';
                html += `
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <div style="width: 70px; font-size: 0.75rem; color: var(--text-secondary); text-align: right;">${label}</div>
                        <div style="flex: 1; height: 20px; background: var(--bg-tertiary); border-radius: 4px; overflow: hidden;">
                            <div style="height: 100%; width: ${pct}%; background: ${color}; border-radius: 4px; display: flex; align-items: center; padding-left: 8px; font-size: 0.7rem; font-weight: 600; color: white;">${counts[i]}</div>
                        </div>
                    </div>
                `;
            }
            html += '</div>';
            container.innerHTML = html;
        }
        
        function renderSimUserChart(genderStats, avgAge) {
            const container = document.getElementById('simUserChart');
            if (!container) return;
            
            const total = genderStats.male + genderStats.female;
            const malePct = ((genderStats.male / total) * 100).toFixed(1);
            const femalePct = ((genderStats.female / total) * 100).toFixed(1);
            
            container.innerHTML = `
                <div style="display: flex; flex-direction: column; gap: 12px;">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <div style="width: 60px; font-size: 0.75rem; color: var(--text-secondary); text-align: right;">Male</div>
                        <div style="flex: 1; height: 24px; background: var(--bg-tertiary); border-radius: 4px; overflow: hidden;">
                            <div style="height: 100%; width: ${malePct}%; background: var(--accent); border-radius: 4px; display: flex; align-items: center; padding-left: 8px; font-size: 0.75rem; font-weight: 600; color: white;">${genderStats.male.toLocaleString()} (${malePct}%)</div>
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <div style="width: 60px; font-size: 0.75rem; color: var(--text-secondary); text-align: right;">Female</div>
                        <div style="flex: 1; height: 24px; background: var(--bg-tertiary); border-radius: 4px; overflow: hidden;">
                            <div style="height: 100%; width: ${femalePct}%; background: var(--success); border-radius: 4px; display: flex; align-items: center; padding-left: 8px; font-size: 0.75rem; font-weight: 600; color: white;">${genderStats.female.toLocaleString()} (${femalePct}%)</div>
                        </div>
                    </div>
                    <div style="margin-top: 16px; text-align: center;">
                        <div style="font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em;">Average Age</div>
                        <div style="font-size: 2rem; font-weight: 700;">${avgAge}</div>
                    </div>
                </div>
            `;
        }
        
        function renderSimMatchChart(successful, total, avgTime, avgScans) {
            const container = document.getElementById('simMatchChart');
            if (!container) return;
            
            const successRate = ((successful / total) * 100).toFixed(1);
            const failRate = (100 - parseFloat(successRate)).toFixed(1);
            
            container.innerHTML = `
                <div style="display: flex; flex-direction: column; gap: 12px;">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <div style="width: 60px; font-size: 0.75rem; color: var(--text-secondary); text-align: right;">Success</div>
                        <div style="flex: 1; height: 24px; background: var(--bg-tertiary); border-radius: 4px; overflow: hidden;">
                            <div style="height: 100%; width: ${successRate}%; background: var(--success); border-radius: 4px; display: flex; align-items: center; padding-left: 8px; font-size: 0.75rem; font-weight: 600; color: white;">${successful} (${successRate}%)</div>
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <div style="width: 60px; font-size: 0.75rem; color: var(--text-secondary); text-align: right;">Failed</div>
                        <div style="flex: 1; height: 24px; background: var(--bg-tertiary); border-radius: 4px; overflow: hidden;">
                            <div style="height: 100%; width: ${failRate}%; background: var(--danger); border-radius: 4px; display: flex; align-items: center; padding-left: 8px; font-size: 0.75rem; font-weight: 600; color: white;">${total - successful} (${failRate}%)</div>
                        </div>
                    </div>
                    <div style="margin-top: 16px; display: grid; grid-template-columns: 1fr 1fr; gap: 16px; text-align: center;">
                        <div>
                            <div style="font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase;">Avg Time</div>
                            <div style="font-size: 1.25rem; font-weight: 700;">${avgTime.toFixed(1)}ms</div>
                        </div>
                        <div>
                            <div style="font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase;">Avg Scans</div>
                            <div style="font-size: 1.25rem; font-weight: 700;">${Math.round(avgScans)}</div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function renderSimScalingChart(results) {
            const container = document.getElementById('simScalingChart');
            if (!container) return;
            
            const maxTime = Math.max(...results.map(r => r.avgTime));
            const maxScans = Math.max(...results.map(r => r.avgScans));
            
            let html = '<div style="display: flex; flex-direction: column; gap: 8px;">';
            for (const r of results) {
                const timePct = (r.avgTime / maxTime) * 50;
                const scansPct = (r.avgScans / maxScans) * 50;
                const geoLabel = r.useGeohash ? '(GH)' : '(FS)';
                html += `
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <div style="width: 90px; font-size: 0.7rem; color: var(--text-secondary); text-align: right;">${r.userCount.toLocaleString()} ${geoLabel}</div>
                        <div style="flex: 1; display: flex; gap: 4px;">
                            <div style="height: 18px; width: ${timePct}%; background: var(--accent); border-radius: 3px; display: flex; align-items: center; padding-left: 6px; font-size: 0.65rem; font-weight: 500; color: white;">${r.avgTime.toFixed(1)}ms</div>
                            <div style="height: 18px; width: ${scansPct}%; background: var(--warning); opacity: 0.8; border-radius: 3px; display: flex; align-items: center; padding-left: 6px; font-size: 0.65rem; font-weight: 500; color: white;">${r.avgScans}</div>
                        </div>
                    </div>
                `;
            }
            html += `
                <div style="margin-top: 8px; font-size: 0.7rem; color: var(--text-muted); display: flex; gap: 16px;">
                    <span><span style="display: inline-block; width: 12px; height: 12px; background: var(--accent); border-radius: 2px; margin-right: 4px;"></span>Avg Time</span>
                    <span><span style="display: inline-block; width: 12px; height: 12px; background: var(--warning); opacity: 0.8; border-radius: 2px; margin-right: 4px;"></span>Avg Scans</span>
                    <span style="margin-left: auto;">(GH) = Geohash, (FS) = Full Scan</span>
                </div>
            </div>`;
            
            container.innerHTML = html;
        }
        
        function renderSimIssues(issues) {
            const container = document.getElementById('simIssuesList');
            const countBadge = document.getElementById('simIssueCount');
            
            if (!container) return;
            
            countBadge.textContent = `${issues.length} issues`;
            countBadge.style.background = issues.length === 0 ? 'var(--success)' : issues.some(i => i.severity === 'high') ? 'var(--danger)' : 'var(--warning)';
            
            if (issues.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--success);">
                        <div style="font-size: 2.5rem; margin-bottom: 12px;"></div>
                        <div style="font-weight: 600;">No Critical Issues Detected</div>
                        <div style="font-size: 0.85rem; color: var(--text-secondary);">Algorithm is performing well at this scale</div>
                    </div>
                `;
                return;
            }
            
            let html = '';
            for (const issue of issues) {
                const colors = { high: 'var(--danger)', medium: 'var(--warning)', low: 'var(--success)' };
                const icons = { high: '', medium: '', low: '' };
                html += `
                    <div style="padding: 16px; background: var(--bg-tertiary); border-radius: 8px; margin-bottom: 12px; border-left: 4px solid ${colors[issue.severity]};">
                        <div style="font-weight: 600; margin-bottom: 8px; display: flex; align-items: center; gap: 8px;">
                            ${icons[issue.severity]} ${issue.title}
                        </div>
                        <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 8px;">${issue.detail}</div>
                        <div style="font-size: 0.8rem; color: var(--accent-light); padding: 8px 12px; background: rgba(0, 120, 212, 0.1); border-radius: 4px;"> ${issue.recommendation}</div>
                    </div>
                `;
            }
            container.innerHTML = html;
        }
        
        // Update real-life metrics display
        function updateRealLifeMetricsDisplay(metrics, showTrafficPattern = false) {
            const container = document.getElementById('simRealLifeMetrics');
            if (!container) return;
            
            if (!metrics) {
                container.style.display = 'none';
                return;
            }
            
            container.style.display = 'block';
            
            // Update metric values
            const setMetric = (id, value, suffix = '') => {
                const el = document.getElementById(id);
                if (el) el.textContent = typeof value === 'number' ? value.toLocaleString() + suffix : value + suffix;
            };
            
            setMetric('simRLColdStarts', metrics.coldStarts || 0);
            setMetric('simRLRateLimited', metrics.rateLimited || 0);
            setMetric('simRLNetworkErrors', metrics.networkErrors || 0);
            setMetric('simRLRaceConditions', metrics.raceConditions || 0);
            setMetric('simRLPeakConcurrent', metrics.peakConcurrent || 0);
            setMetric('simRLDbLatency', metrics.avgDbLatency || 0, 'ms');
            setMetric('simRLPoolExhausted', metrics.poolExhausted || 0);
            setMetric('simRLBlockedHits', simRealLifeMetrics.blockedUserHits || 0);
            
            // Update colors based on severity
            const setColor = (id, value, thresholds) => {
                const el = document.getElementById(id);
                if (el) {
                    if (value >= thresholds.high) el.style.color = 'var(--danger)';
                    else if (value >= thresholds.medium) el.style.color = 'var(--warning)';
                    else el.style.color = 'var(--success)';
                }
            };
            
            setColor('simRLRateLimited', metrics.rateLimited || 0, { high: 10, medium: 3 });
            setColor('simRLNetworkErrors', metrics.networkErrors || 0, { high: 5, medium: 2 });
            setColor('simRLRaceConditions', metrics.raceConditions || 0, { high: 5, medium: 2 });
            
            // Traffic pattern visualization
            const trafficContainer = document.getElementById('simTrafficPattern');
            const trafficBars = document.getElementById('simTrafficBars');
            
            if (showTrafficPattern && trafficBars) {
                trafficContainer.style.display = 'block';
                let barsHtml = '';
                for (let hour = 0; hour < 24; hour++) {
                    const multiplier = PEAK_HOURS_PATTERN[hour];
                    const height = Math.max(5, multiplier * 20);
                    const color = multiplier >= 2.5 ? 'var(--danger)' : 
                                  multiplier >= 1.5 ? 'var(--warning)' : 
                                  multiplier >= 0.5 ? 'var(--accent)' : 'var(--text-muted)';
                    barsHtml += `<div style="flex: 1; height: ${height}px; background: ${color}; border-radius: 2px;" title="${hour}:00 - ${multiplier.toFixed(1)}x traffic"></div>`;
                }
                trafficBars.innerHTML = barsHtml;
            } else if (trafficContainer) {
                trafficContainer.style.display = 'none';
            }
        }
        
        function renderSimHistory() {
            const container = document.getElementById('simHistoryList');
            if (!container) return;
            
            if (simHistory.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-muted);">No saved results yet</div>';
                return;
            }
            
            let html = '<div style="display: flex; flex-direction: column;">';
            for (const result of simHistory.slice(0, 20)) {
                const date = new Date(result.timestamp);
                const timeStr = date.toLocaleTimeString();
                const dateStr = date.toLocaleDateString();
                const runId = result.runId || result.timestamp;
                const awsSynced = result.awsSynced;
                const realLife = result.realLifeEnabled;
                
                html += `
                    <div style="display: flex; align-items: center; gap: 16px; padding: 12px 16px; border-bottom: 1px solid var(--border);">
                        <div style="min-width: 120px;">
                            <div style="font-size: 0.85rem; font-weight: 600;">${dateStr}</div>
                            <div style="font-size: 0.75rem; color: var(--text-muted);">${timeStr}</div>
                            <div style="display: flex; gap: 4px; margin-top: 4px;">
                                ${awsSynced ? '<span title="Synced to AWS" style="font-size: 0.65rem; background: rgba(34, 197, 94, 0.2); color: var(--success); padding: 2px 6px; border-radius: 4px;"> AWS</span>' : ''}
                                ${realLife ? '<span title="Real-life scenarios enabled" style="font-size: 0.65rem; background: rgba(139, 92, 246, 0.2); color: var(--purple); padding: 2px 6px; border-radius: 4px;"> Real</span>' : ''}
                            </div>
                        </div>
                        <div style="flex: 1; display: flex; gap: 24px; flex-wrap: wrap; align-items: center;">
                            <div><span style="color: var(--text-muted);">Users:</span> <strong>${result.userCount?.toLocaleString() || '?'}</strong></div>
                            <div><span style="color: var(--text-muted);">Avg Time:</span> <strong style="color: ${(result.avgTime || 0) < 50 ? 'var(--success)' : (result.avgTime || 0) < 200 ? 'var(--warning)' : 'var(--danger)'};">${(result.avgTime || 0).toFixed(1)}ms</strong></div>
                            <div><span style="color: var(--text-muted);">P95:</span> <strong>${(result.p95 || 0).toFixed(1)}ms</strong></div>
                            <div><span style="color: var(--text-muted);">Success:</span> <strong>${result.successRate || '?'}%</strong></div>
                            <div><span style="color: var(--text-muted);">Geohash:</span> <strong>${result.useGeohash ? '' : ''}</strong></div>
                            <div><span style="color: var(--text-muted);">Issues:</span> <strong style="color: ${(result.issues || 0) === 0 ? 'var(--success)' : 'var(--warning)'};">${result.issues || 0}</strong></div>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            ${awsSynced ? `
                                <button onclick="viewStressTestLog('${runId}')" style="padding: 4px 8px; font-size: 0.7rem; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 4px; cursor: pointer; color: var(--text-secondary);" title="View full log"></button>
                                <button onclick="deleteStressTestLog('${runId}')" style="padding: 4px 8px; font-size: 0.7rem; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 4px; cursor: pointer; color: var(--danger);" title="Delete from AWS"></button>
                            ` : `
                                <button onclick="saveStressTestToAWS(simHistory.find(h => h.timestamp === '${result.timestamp}'))" style="padding: 4px 8px; font-size: 0.7rem; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 4px; cursor: pointer; color: var(--text-secondary);" title="Sync to AWS"></button>
                            `}
                        </div>
                    </div>
                `;
            }
            html += '</div>';
            container.innerHTML = html;
        }
        
        function clearSimulationHistory() {
            if (confirm('Are you sure you want to clear all saved simulation results?')) {
                simHistory = [];
                localStorage.removeItem('oithSimHistory');
                document.getElementById('simHistoryCount').textContent = '0 saved';
                renderSimHistory();
                simLog('Simulation history cleared.', 'info');
            }
        }
        
        function exportSimulationResults() {
            const data = {
                exportDate: new Date().toISOString(),
                currentResults: simScalingResults,
                history: simHistory
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `oith-simulation-results-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            simLog('Results exported to JSON file.', 'success');
        }
        
        // ==========================================
        // STRESS TEST AWS SYNC
        // ==========================================
        
        // Save stress test result to AWS
        async function saveStressTestToAWS(resultData) {
            try {
                const runId = resultData.timestamp || new Date().toISOString();
                
                const response = await fetch(`${AWS_API_URL}/stress-test/logs`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        runId: runId,
                        result: resultData,
                        logOutput: getSimLogOutput(),
                        timestamp: new Date().toISOString()
                    })
                });
                
                if (response.ok) {
                    simLog(' Results saved to AWS', 'success');
                    return true;
                } else {
                    const error = await response.text();
                    simLog(` AWS save failed: ${error}`, 'warning');
                    return false;
                }
            } catch (error) {
                simLog(` AWS sync error: ${error.message}`, 'warning');
                console.error('AWS stress test sync error:', error);
                return false;
            }
        }
        
        // Get current simulation log output as array
        function getSimLogOutput() {
            const output = document.getElementById('simLogOutput');
            if (!output) return [];
            
            const lines = [];
            for (const child of output.children) {
                const timestamp = child.querySelector('span:first-child')?.textContent || '';
                const message = child.querySelector('span:last-child')?.textContent || '';
                lines.push({ timestamp, message });
            }
            return lines;
        }
        
        // Load stress test history from AWS
        async function loadStressTestHistoryFromAWS() {
            try {
                const response = await fetch(`${AWS_API_URL}/stress-test/logs`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.logs && data.logs.length > 0) {
                        // Merge with local history, avoiding duplicates
                        const awsLogs = data.logs.map(log => ({
                            ...log.result,
                            awsSynced: true,
                            runId: log.runId
                        }));
                        
                        const localTimestamps = new Set(simHistory.map(h => h.timestamp));
                        const newLogs = awsLogs.filter(l => !localTimestamps.has(l.timestamp));
                        
                        if (newLogs.length > 0) {
                            simHistory = [...newLogs, ...simHistory].slice(0, 50);
                            localStorage.setItem('oithSimHistory', JSON.stringify(simHistory));
                            document.getElementById('simHistoryCount').textContent = `${simHistory.length} saved`;
                            console.log(` Loaded ${newLogs.length} stress test logs from AWS`);
                        }
                        return data.logs;
                    }
                }
                return [];
            } catch (error) {
                console.log(' Could not load stress test history from AWS:', error.message);
                return [];
            }
        }
        
        // View a specific stress test log from AWS
        async function viewStressTestLog(runId) {
            try {
                const response = await fetch(`${AWS_API_URL}/stress-test/logs/${encodeURIComponent(runId)}`);
                if (response.ok) {
                    const data = await response.json();
                    
                    // Clear and populate the debug console with the saved log
                    clearSimLog();
                    simLog(' Loading saved log...', 'info');
                    
                    if (data.logOutput && Array.isArray(data.logOutput)) {
                        const output = document.getElementById('simLogOutput');
                        output.innerHTML = '';
                        
                        for (const line of data.logOutput) {
                            const colors = {
                                success: '#3fb950',
                                warning: '#d29922',
                                error: '#f85149'
                            };
                            const color = line.message.includes('') || line.message.includes('warning') ? colors.warning :
                                          line.message.includes('') || line.message.includes('error') ? colors.error :
                                          line.message.includes('') || line.message.includes('success') ? colors.success : '#58a6ff';
                            
                            const lineEl = document.createElement('div');
                            lineEl.style.cssText = 'display: flex; gap: 12px;';
                            lineEl.innerHTML = `<span style="color: #7d8590;">${line.timestamp}</span><span style="color: ${color}">${line.message}</span>`;
                            output.appendChild(lineEl);
                        }
                    }
                    
                    // Update metrics display if result data exists
                    if (data.result) {
                        document.getElementById('simMetricUsers').textContent = data.result.userCount?.toLocaleString() || '';
                        document.getElementById('simMetricSuccess').textContent = data.result.successRate + '%' || '';
                        document.getElementById('simMetricAvgTime').textContent = data.result.avgTime?.toFixed(1) + 'ms' || '';
                        document.getElementById('simMetricP95').textContent = data.result.p95?.toFixed(1) + 'ms' || '';
                        document.getElementById('simMetricScans').textContent = data.result.avgScans?.toLocaleString() || '';
                        document.getElementById('simMetricDuration').textContent = data.result.totalDuration?.toFixed(0) + 'ms' || '';
                    }
                    
                    showToast(' Stress test log loaded', 'success');
                }
            } catch (error) {
                showToast('Failed to load log', 'error');
                console.error('Load stress test log error:', error);
            }
        }
        
        // Delete a stress test log from AWS
        async function deleteStressTestLog(runId) {
            if (!confirm('Delete this stress test log from AWS?')) return;
            
            try {
                const response = await fetch(`${AWS_API_URL}/stress-test/logs/${encodeURIComponent(runId)}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    showToast(' Log deleted from AWS', 'info');
                    // Refresh history
                    await loadStressTestHistoryFromAWS();
                    renderSimHistory();
                }
            } catch (error) {
                showToast('Failed to delete log', 'error');
                console.error('Delete stress test log error:', error);
            }
        }
        
        function renderSimulation() {
            // Update history count on load
            document.getElementById('simHistoryCount').textContent = `${simHistory.length} saved`;
            
            // Load stress test history from AWS in background
            loadStressTestHistoryFromAWS();
        }

        // ==========================================
        // APP DIAGNOSTICS
        // ==========================================
        
        // Global crawler state
        let crawlerRunning = false;
        let crawlerAbortController = null;
        let crawlerAutoRunInterval = null;
        let crawlerResults = {
            passed: 0,
            failed: 0,
            warnings: 0,
            issues: [],
            dependencies: [],
            transitions: [],
            logicFlows: []
        };
        let diagnosticsLogEntries = [];

        function appendDiagnosticsLog(message, type = 'info') {
            const logEl = document.getElementById('diagnosticsLog');
            if (!logEl) return;
            const timestamp = new Date().toISOString().split('T')[1].split('.')[0];
            const prefix = type === 'error' ? '[ERROR]' : type === 'warn' ? '[WARN]' : type === 'success' ? '[SUCCESS]' : '[INFO]';
            
            // Store entry for filtering
            diagnosticsLogEntries.push({ timestamp, prefix, message, type });
            
            const existing = logEl.querySelector('pre')?.textContent || '';
            const colorClass = type === 'error' ? 'color: var(--danger)' : type === 'warn' ? 'color: var(--warning)' : type === 'success' ? 'color: var(--success)' : '';
            const next = `${existing}\n${timestamp} ${prefix} ${message}`;
            logEl.innerHTML = `<pre>${next}</pre>`;
            logEl.scrollTop = logEl.scrollHeight;
        }

        function clearDiagnosticsLog() {
            const logEl = document.getElementById('diagnosticsLog');
            if (logEl) {
                logEl.innerHTML = '<pre>// Log cleared. Run crawler to start new diagnostics...</pre>';
            }
            diagnosticsLogEntries = [];
        }

        function filterDiagnosticsLog(filter) {
            const logEl = document.getElementById('diagnosticsLog');
            if (!logEl) return;
            
            let filtered = diagnosticsLogEntries;
            if (filter !== 'all') {
                filtered = diagnosticsLogEntries.filter(e => e.type === filter);
            }
            
            const text = filtered.map(e => `${e.timestamp} ${e.prefix} ${e.message}`).join('\n');
            logEl.innerHTML = `<pre>${text || '// No messages matching filter...'}</pre>`;
        }

        function exportDiagnosticsLog() {
            const text = diagnosticsLogEntries.map(e => `${e.timestamp} ${e.prefix} ${e.message}`).join('\n');
            const blob = new Blob([text], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `oith-crawler-log-${new Date().toISOString().split('T')[0]}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function setDiagnosticsStatus(text, statusClass = '') {
            const statusEl = document.getElementById('diagnosticsStatus');
            const badgeEl = document.getElementById('crawlerStatusBadge');
            if (statusEl) {
                statusEl.textContent = text;
                statusEl.className = 'status-badge';
                if (statusClass) statusEl.classList.add(statusClass);
            }
            if (badgeEl) {
                badgeEl.textContent = text;
                badgeEl.className = 'status-badge';
                if (statusClass) badgeEl.classList.add(statusClass);
            }
        }

        function updateCrawlerStats(passed, failed, warnings, progress) {
            document.getElementById('crawlerPassed').textContent = passed;
            document.getElementById('crawlerFailed').textContent = failed;
            document.getElementById('crawlerWarnings').textContent = warnings;
            document.getElementById('crawlerProgress').textContent = Math.round(progress) + '%';
            document.getElementById('crawlerProgressBar').style.width = progress + '%';
        }

        function toggleDependencyMap() {
            const body = document.getElementById('dependencyMapBody');
            const toggle = document.getElementById('dependencyMapToggle');
            if (body.style.display === 'none') {
                body.style.display = 'block';
                toggle.style.transform = 'rotate(180deg)';
            } else {
                body.style.display = 'none';
                toggle.style.transform = 'rotate(0deg)';
            }
        }

        function toggleLogicFlow() {
            const body = document.getElementById('logicFlowBody');
            const toggle = document.getElementById('logicFlowToggle');
            if (body.style.display === 'none') {
                body.style.display = 'block';
                toggle.style.transform = 'rotate(180deg)';
            } else {
                body.style.display = 'none';
                toggle.style.transform = 'rotate(0deg)';
            }
        }

        function toggleTransitionMatrix() {
            const body = document.getElementById('transitionMatrixBody');
            const toggle = document.getElementById('transitionMatrixToggle');
            if (body.style.display === 'none') {
                body.style.display = 'block';
                toggle.style.transform = 'rotate(180deg)';
            } else {
                body.style.display = 'none';
                toggle.style.transform = 'rotate(0deg)';
            }
        }

        function stopCrawler() {
            crawlerRunning = false;
            if (crawlerAbortController) {
                crawlerAbortController.abort();
            }
            document.getElementById('runCrawlerBtn').style.display = 'flex';
            document.getElementById('stopCrawlerBtn').style.display = 'none';
            setDiagnosticsStatus('Stopped', 'warning');
            appendDiagnosticsLog(' Crawler stopped by user.', 'warn');
            
            // Clean up test fixtures
            cleanupTestFixtures();
            const cleanupChannel = new BroadcastChannel('oith_sync');
            cleanupChannel.postMessage({ type: 'crawler_logout', source: 'admin' });
        }

        // Create test user fixtures for comprehensive testing
        async function createTestUserFixtures() {
            const testEmail = 'crawler@test.oith';
            const testMatchEmail = 'match@test.oith';
            
            // Create test user profile
            const testUser = {
                email: testEmail,
                password: 'testpass123',
                name: 'Test Crawler',
                firstName: 'Test',
                age: 28,
                birthday: '1996-06-15',
                gender: 'non-binary',
                bio: 'Test user for crawler diagnostics',
                photo: 'https://i.pravatar.cc/400?u=crawler',
                photos: ['https://i.pravatar.cc/400?u=crawler', 'https://i.pravatar.cc/400?u=crawler2'],
                location: 'San Francisco, CA',
                occupation: 'QA Engineer',
                education: 'bachelors',
                height: "5'8\"",
                heightInches: 68,
                interests: ['Testing', 'Automation', 'Coffee'],
                lookingFor: 'relationship',
                createdAt: new Date().toISOString(),
                loggedIn: true,
                preferences: {
                    ageMin: 21,
                    ageMax: 45,
                    distance: 50,
                    interestedIn: 'everyone',
                    lookingFor: 'unsure'
                },
                matchPreferences: {
                    ageMin: 21,
                    ageMax: 45,
                    maxDistance: 50
                },
                subscription: {
                    status: 'active',
                    plan: 'premium',
                    type: 'premium',
                    startDate: new Date().toISOString()
                },
                emergencyContact: {
                    name: 'Emergency Contact',
                    phone: '555-1234'
                }
            };
            
            // Create test match profile
            const testMatch = {
                id: 999,
                email: testMatchEmail,
                name: 'Test Match',
                age: 26,
                gender: 'woman',
                bio: 'Test match for crawler diagnostics',
                photo: 'https://i.pravatar.cc/400?u=testmatch',  // Single photo for avatar
                photos: ['https://i.pravatar.cc/400?u=testmatch'],
                location: 'San Francisco, CA',
                distance: 5,
                distanceText: '5 miles',
                compatibility: 92,
                occupation: 'Software Engineer',
                interests: ['Hiking', 'Coffee', 'Photography'],
                lookingFor: 'relationship',
                online: true,
                lastActive: 'Now'
            };
            
            // Create active connection/chat
            const testConnection = {
                id: 'test-connection-1',
                matchedAt: new Date(Date.now() - 86400000).toISOString(), // 1 day ago
                status: 'active',
                users: [testEmail, testMatchEmail],
                lastMessage: {
                    from: testMatchEmail,
                    text: 'Hey! Looking forward to our date!',
                    timestamp: new Date(Date.now() - 3600000).toISOString()
                }
            };
            
            // Create chat messages
            const testMessages = [
                { from: testEmail, text: 'Hi there! Great to match with you!', timestamp: new Date(Date.now() - 86400000).toISOString() },
                { from: testMatchEmail, text: 'Hey! Same here! How are you?', timestamp: new Date(Date.now() - 82800000).toISOString() },
                { from: testEmail, text: 'Doing great! Want to grab coffee sometime?', timestamp: new Date(Date.now() - 79200000).toISOString() },
                { from: testMatchEmail, text: 'That sounds perfect! When works for you?', timestamp: new Date(Date.now() - 7200000).toISOString() },
                { from: testEmail, text: 'How about Saturday afternoon?', timestamp: new Date(Date.now() - 3700000).toISOString() },
                { from: testMatchEmail, text: 'Hey! Looking forward to our date!', timestamp: new Date(Date.now() - 3600000).toISOString() }
            ];
            
            // Save test user data to localStorage
            const userData = {
                version: '1.0',
                user: testUser,
                isLoggedIn: true,
                profileComplete: true,
                oneMatch: {
                    current: testMatch,
                    status: 'matched',
                    matchedAt: testConnection.matchedAt,
                    decisionMade: true,
                    isMutual: true,  // Critical: indicates both users matched
                    connectionExpiresAt: new Date(Date.now() + 86400000).toISOString() // 24 hours from now
                },
                activeConnection: {
                    // Spread the match profile so it has name, photo, etc. directly
                    ...testMatch,
                    // Add connection-specific properties
                    connectedAt: new Date(Date.now() - 86400000).toISOString(),
                    messages: testMessages,
                    connectionId: testConnection.id
                },
                connectionMetrics: {
                    messageCount: 6,
                    avgResponseTime: '5m',
                    compatibility: 92,
                    dateReadiness: 65,
                    connectedAt: testConnection.matchedAt
                },
                conversation: {
                    messages: testMessages,
                    dateReadiness: 65,
                    datePlanned: false,
                    conversationStarted: true
                },
                connections: [{
                    id: testConnection.id,
                    match: testMatch,
                    matchedAt: testConnection.matchedAt,
                    lastMessage: testConnection.lastMessage,
                    status: 'active'
                }],
                matchPool: [testMatch],
                passedMatches: [],
                matchHistory: [{
                    match: testMatch,
                    outcome: 'mutual',
                    date: testConnection.matchedAt
                }]
            };
            
            // NOTE: We do NOT save to localStorage anymore to avoid polluting user data
            // The crawler only sends data to the app via BroadcastChannel (in-memory only)
            
            // Send login command to app via BroadcastChannel
            const channel = new BroadcastChannel('oith_sync');
            channel.postMessage({
                type: 'crawler_login',
                email: testEmail,
                userData: userData,
                testMatch: testMatch,
                testConnection: testConnection
            });
            
            // Wait longer for the app to fully process and set up state
            await new Promise(res => setTimeout(res, 1000));
            
            console.log(' Test fixtures sent to app, waiting for confirmation...');
            
            return { testEmail, testMatch, testConnection };
        }
        
        // Clean up test fixtures after crawl
        function cleanupTestFixtures() {
            const testEmails = ['crawler@test.oith', 'match@test.oith'];
            
            testEmails.forEach(email => {
                localStorage.removeItem(`oith_user_${email}`);
            });
            
            const registeredUsers = JSON.parse(localStorage.getItem('oith_registered_users') || '{}');
            testEmails.forEach(email => delete registeredUsers[email]);
            localStorage.setItem('oith_registered_users', JSON.stringify(registeredUsers));
            
            // Tell app to logout test user
            const channel = new BroadcastChannel('oith_sync');
            channel.postMessage({ type: 'crawler_logout' });
        }

        function renderDiagnostics() {
            // Initialize auto-run checkbox state
            const autoRunCheckbox = document.getElementById('crawlerAutoRun');
            if (autoRunCheckbox) {
                autoRunCheckbox.checked = !!crawlerAutoRunInterval;
                autoRunCheckbox.onchange = () => {
                    if (autoRunCheckbox.checked) {
                        crawlerAutoRunInterval = setInterval(() => {
                            if (!crawlerRunning) runAppDiagnostics();
                        }, 5 * 60 * 1000);
                        appendDiagnosticsLog(' Auto-run enabled (every 5 minutes)', 'info');
                    } else {
                        if (crawlerAutoRunInterval) {
                            clearInterval(crawlerAutoRunInterval);
                            crawlerAutoRunInterval = null;
                        }
                        appendDiagnosticsLog(' Auto-run disabled', 'info');
                    }
                };
            }
            appendDiagnosticsLog('// Diagnostics view opened');
            
            // Load crawler log history from DynamoDB
            loadCrawlerLogHistory();
        }
        
        // Toggle crawler history panel
        function toggleCrawlerHistory() {
            const body = document.getElementById('crawlerHistoryBody');
            const toggle = document.getElementById('crawlerHistoryToggle');
            if (body) {
                const isHidden = body.style.display === 'none';
                body.style.display = isHidden ? 'block' : 'none';
                if (toggle) toggle.style.transform = isHidden ? 'rotate(180deg)' : '';
            }
        }

        function pingIndexApp() {
            appendDiagnosticsLog('');
            appendDiagnosticsLog(' Pinging index.html app...');
            setDiagnosticsStatus('Pinging', 'active');
            
            try {
                const channel = new BroadcastChannel('oith_sync');
                let received = false;
                
                channel.onmessage = (event) => {
                    if (event.data && event.data.type === 'pong') {
                        received = true;
                        appendDiagnosticsLog(` App responded!`, 'success');
                        appendDiagnosticsLog(`   Current screen: ${event.data.currentScreen}`, 'success');
                        appendDiagnosticsLog(`   Timestamp: ${new Date(event.data.timestamp).toLocaleTimeString()}`, 'info');
                        setDiagnosticsStatus('Connected', 'active');
                        channel.close();
                    }
                };
                
                channel.postMessage({
                    type: 'ping',
                    from: 'admin',
                    timestamp: Date.now()
                });
                
                // Timeout after 3 seconds
                setTimeout(() => {
                    if (!received) {
                        appendDiagnosticsLog(' No response from app', 'error');
                        appendDiagnosticsLog('   Make sure index.html is open in another browser tab', 'warn');
                        setDiagnosticsStatus('No Response', 'warning');
                        channel.close();
                    }
                }, 3000);
                
            } catch (err) {
                appendDiagnosticsLog(` Error: ${err.message}`, 'error');
                setDiagnosticsStatus('Error', 'danger');
            }
        }

        // Generate static dependency map based on known app structure
        function generateAppDependencies() {
            return [
                // Screen transitions
                { source: 'splash', target: 'onboarding-1', type: 'screen', broken: false },
                { source: 'splash', target: 'login', type: 'screen', broken: false },
                { source: 'onboarding-1', target: 'onboarding-2', type: 'screen', broken: false },
                { source: 'onboarding-2', target: 'onboarding-3', type: 'screen', broken: false },
                { source: 'onboarding-3', target: 'signup', type: 'screen', broken: false },
                { source: 'signup', target: 'preferences', type: 'screen', broken: false },
                { source: 'login', target: 'match', type: 'screen', broken: false },
                { source: 'preferences', target: 'profile-details', type: 'screen', broken: false },
                { source: 'profile-details', target: 'profile-setup', type: 'screen', broken: false },
                { source: 'profile-setup', target: 'payment', type: 'screen', broken: false },
                { source: 'payment', target: 'match', type: 'screen', broken: false },
                { source: 'match', target: 'chat', type: 'screen', broken: false },
                { source: 'match', target: 'my-profile', type: 'screen', broken: false },
                { source: 'chat', target: 'date-plan', type: 'screen', broken: false },
                { source: 'my-profile', target: 'settings', type: 'screen', broken: false },
                { source: 'my-profile', target: 'edit-profile', type: 'screen', broken: false },
                { source: 'settings', target: 'manage-subscription', type: 'screen', broken: false },
                { source: 'settings', target: 'safety-privacy', type: 'screen', broken: false },
                
                // Function calls
                { source: 'showScreen()', target: 'initializeScreen()', type: 'function', broken: false },
                { source: 'showScreen()', target: 'hideAllScreens()', type: 'function', broken: false },
                { source: 'showScreen()', target: 'saveUserData()', type: 'function', broken: false },
                { source: 'handleLogin()', target: 'loadUserData()', type: 'function', broken: false },
                { source: 'handleLogin()', target: 'showScreen()', type: 'function', broken: false },
                { source: 'handleSignup()', target: 'saveUserData()', type: 'function', broken: false },
                { source: 'handleSignup()', target: 'showScreen()', type: 'function', broken: false },
                { source: 'sendMessage()', target: 'addMessageToChat()', type: 'function', broken: false },
                { source: 'sendMessage()', target: 'simulateResponse()', type: 'function', broken: false },
                { source: 'updateMatch()', target: 'calculateCompatibility()', type: 'function', broken: false },
                { source: 'acceptMatch()', target: 'updateMatchStatus()', type: 'function', broken: false },
                { source: 'acceptMatch()', target: 'showScreen()', type: 'function', broken: false },
                { source: 'passMatch()', target: 'updateMatchStatus()', type: 'function', broken: false },
                { source: 'passMatch()', target: 'showNextMatch()', type: 'function', broken: false },
                { source: 'initMatchPreferencesScreen()', target: 'updateMatchPreferencesCounter()', type: 'function', broken: false },
                { source: 'updateMatchPreferencesCounter()', target: 'matchingProfiles()', type: 'function', broken: false },
                { source: 'planDate()', target: 'simulateDateResponse()', type: 'function', broken: false },
                
                // Event handlers
                { source: 'onclick', target: 'showScreen()', type: 'event', broken: false },
                { source: 'onclick', target: 'handleLogin()', type: 'event', broken: false },
                { source: 'onclick', target: 'handleSignup()', type: 'event', broken: false },
                { source: 'onclick', target: 'sendMessage()', type: 'event', broken: false },
                { source: 'onclick', target: 'acceptMatch()', type: 'event', broken: false },
                { source: 'onclick', target: 'passMatch()', type: 'event', broken: false },
                { source: 'onclick', target: 'planDate()', type: 'event', broken: false },
                { source: 'onclick', target: 'showSafetyTips()', type: 'event', broken: false },
                { source: 'onclick', target: 'showContactSupport()', type: 'event', broken: false },
                { source: 'onchange', target: 'updateMatchPreferencesCounter()', type: 'event', broken: false },
                { source: 'onchange', target: 'saveUserData()', type: 'event', broken: false },
                { source: 'onsubmit', target: 'handleLogin()', type: 'event', broken: false },
                { source: 'onsubmit', target: 'handleSignup()', type: 'event', broken: false },
                { source: 'onsubmit', target: 'submitSupportMessage()', type: 'event', broken: false },
                
                // BroadcastChannel messages
                { source: 'BroadcastChannel', target: 'user_update', type: 'event', broken: false },
                { source: 'BroadcastChannel', target: 'settings_update', type: 'event', broken: false },
                { source: 'BroadcastChannel', target: 'run_diagnostics', type: 'event', broken: false },
                { source: 'BroadcastChannel', target: 'nav_to_screen', type: 'event', broken: false },
                
                // localStorage dependencies
                { source: 'saveUserData()', target: 'localStorage.setItem()', type: 'function', broken: false },
                { source: 'loadUserData()', target: 'localStorage.getItem()', type: 'function', broken: false },
                { source: 'seedDemoAccounts()', target: 'localStorage.setItem()', type: 'function', broken: false }
            ];
        }

        function renderDependencyMap(dependencies) {
            const container = document.getElementById('dependencyMapContent');
            
            // If no dependencies passed, generate them
            if (!dependencies || dependencies.length === 0) {
                dependencies = generateAppDependencies();
            }
            
            if (!container || dependencies.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: var(--text-muted); padding: 40px;">No dependency data available.</div>';
                return;
            }

            // Group dependencies by source
            const grouped = {};
            dependencies.forEach(dep => {
                if (!grouped[dep.source]) grouped[dep.source] = [];
                grouped[dep.source].push(dep);
            });

            let html = '<div style="display: flex; flex-direction: column; gap: 16px;">';
            
            Object.keys(grouped).forEach(source => {
                const deps = grouped[source];
                html += `
                    <div style="padding: 16px; background: var(--bg-secondary); border-radius: 12px; border: 1px solid var(--border);">
                        <div style="font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                            <span style="background: var(--purple); color: white; padding: 4px 10px; border-radius: 6px; font-size: 0.8rem;">${source}</span>
                        </div>
                        <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                            ${deps.map(dep => {
                                const color = dep.broken ? 'var(--danger)' : dep.type === 'function' ? 'var(--success)' : dep.type === 'event' ? 'var(--info)' : 'var(--purple)';
                                const icon = dep.broken ? '' : dep.type === 'function' ? '' : dep.type === 'event' ? '' : '';
                                return `<span style="display: flex; align-items: center; gap: 4px; padding: 6px 12px; background: var(--bg-tertiary); border-radius: 6px; font-size: 0.8rem; border-left: 3px solid ${color};">
                                    ${icon} ${dep.target}
                                </span>`;
                            }).join('')}
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }

        function renderLogicFlows(flows) {
            const container = document.getElementById('logicFlowContent');
            if (!container || flows.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: var(--text-muted); padding: 40px; grid-column: 1/-1;">No logic flow data available.</div>';
                return;
            }

            let html = '';
            flows.forEach((flow, flowIndex) => {
                const statusColor = flow.status === 'ok' ? 'var(--success)' : flow.status === 'warning' ? 'var(--warning)' : 'var(--danger)';
                const statusIcon = flow.status === 'ok' ? '' : flow.status === 'warning' ? '' : '';
                const hasDetails = flow.screenResults && flow.screenResults.length > 0;
                const failedScreens = flow.screenResults ? flow.screenResults.filter(s => !s.passed) : [];
                
                html += `
                    <div class="logic-flow-card" style="padding: 16px; background: var(--bg-tertiary); border-radius: 12px; border: 1px solid var(--border); border-left: 4px solid ${statusColor}; ${hasDetails ? 'cursor: pointer;' : ''}" ${hasDetails ? `onclick="toggleFlowDetails('flow-${flowIndex}')"` : ''}>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <h4 style="margin: 0; font-size: 0.95rem;">${statusIcon} ${flow.name}</h4>
                            <span style="font-size: 0.7rem; color: var(--text-muted);">${flow.steps.length} steps</span>
                        </div>
                        <div style="display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 12px;">
                            ${flow.steps.map((step, i) => `
                                <span style="display: flex; align-items: center; gap: 4px; font-size: 0.75rem; color: var(--text-secondary);">
                                    ${step}${i < flow.steps.length - 1 ? ' ' : ''}
                                </span>
                            `).join('')}
                        </div>
                        ${flow.issue ? `<div style="font-size: 0.8rem; color: var(--danger); background: rgba(239, 68, 68, 0.1); padding: 8px 12px; border-radius: 6px;"> ${flow.issue}</div>` : ''}
                        
                        <!-- Expandable Details -->
                        ${hasDetails ? `
                            <div id="flow-${flowIndex}" class="flow-details" style="display: none; margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border);">
                                <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 8px;">SCREEN DETAILS (click to collapse)</div>
                                <div style="display: flex; flex-direction: column; gap: 6px;">
                                    ${flow.screenResults.map(screen => {
                                        const icon = screen.passed ? '' : '';
                                        const bgColor = screen.passed ? 'rgba(16, 185, 129, 0.1)' : 'rgba(239, 68, 68, 0.1)';
                                        const textColor = screen.passed ? 'var(--success)' : 'var(--danger)';
                                        return `
                                            <div style="padding: 8px 12px; background: ${bgColor}; border-radius: 6px; font-size: 0.8rem;">
                                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                                    <span>${icon} <strong>${screen.name}</strong> <span style="color: var(--text-muted);">(${screen.id})</span></span>
                                                    <span style="color: ${textColor};">${screen.passed ? 'Passed' : 'Failed'}</span>
                                                </div>
                                                ${!screen.passed && screen.error ? `<div style="margin-top: 4px; font-size: 0.75rem; color: var(--danger);"> ${screen.error}</div>` : ''}
                                                ${!screen.tested ? `<div style="margin-top: 4px; font-size: 0.75rem; color: var(--warning);"> Not tested - screen may require login or prior state</div>` : ''}
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                                ${failedScreens.length > 0 ? `
                                    <div style="margin-top: 12px; padding: 10px; background: rgba(59, 130, 246, 0.1); border-radius: 6px; font-size: 0.75rem;">
                                        <strong> Tip:</strong> Failed screens often require authentication. Enable "Simulate Logged-in User" in the crawler options and re-run.
                                    </div>
                                ` : ''}
                            </div>
                        ` : ''}
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        function toggleFlowDetails(flowId) {
            const details = document.getElementById(flowId);
            if (details) {
                details.style.display = details.style.display === 'none' ? 'block' : 'none';
            }
        }

        function renderTransitionMatrix(transitions, screens) {
            const container = document.getElementById('transitionMatrixContent');
            if (!container || screens.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: var(--text-muted); padding: 40px;">No transition data available.</div>';
                return;
            }

            // Create matrix
            const matrix = {};
            screens.forEach(s => {
                matrix[s.id] = {};
                screens.forEach(t => {
                    matrix[s.id][t.id] = transitions.find(tr => tr.from === s.id && tr.to === t.id) || null;
                });
            });

            let html = '<div style="overflow-x: auto;"><table style="width: 100%; border-collapse: collapse; font-size: 0.7rem;">';
            
            // Header row
            html += '<tr><th style="padding: 8px; border: 1px solid var(--border); background: var(--bg-secondary);"></th>';
            screens.slice(0, 10).forEach(s => {
                html += `<th style="padding: 8px; border: 1px solid var(--border); background: var(--bg-secondary); white-space: nowrap; transform: rotate(-45deg); height: 80px;" title="${s.name}">${s.id}</th>`;
            });
            html += '</tr>';

            // Data rows
            screens.slice(0, 10).forEach(source => {
                html += `<tr><td style="padding: 8px; border: 1px solid var(--border); background: var(--bg-secondary); font-weight: 600; white-space: nowrap;">${source.id}</td>`;
                screens.slice(0, 10).forEach(target => {
                    const trans = matrix[source.id]?.[target.id];
                    let cellContent = '';
                    let cellColor = 'var(--bg-tertiary)';
                    if (trans) {
                        cellContent = trans.valid ? '' : '';
                        cellColor = trans.valid ? 'rgba(16, 185, 129, 0.2)' : 'rgba(239, 68, 68, 0.2)';
                    } else if (source.id === target.id) {
                        cellContent = '';
                        cellColor = 'var(--bg-secondary)';
                    }
                    html += `<td style="padding: 8px; border: 1px solid var(--border); background: ${cellColor}; text-align: center;">${cellContent}</td>`;
                });
                html += '</tr>';
            });
            
            html += '</table></div>';
            if (screens.length > 10) {
                html += `<p style="font-size: 0.75rem; color: var(--text-muted); margin-top: 12px;">Showing first 10 screens. Total: ${screens.length}</p>`;
            }
            container.innerHTML = html;
        }

        function renderIssuesPanel(issues) {
            const panel = document.getElementById('issuesFoundPanel');
            const list = document.getElementById('issuesList');
            const count = document.getElementById('issuesCount');
            
            if (!panel || !list) return;
            
            if (issues.length === 0) {
                panel.style.display = 'none';
                return;
            }
            
            panel.style.display = 'block';
            count.textContent = `${issues.length} Issue${issues.length !== 1 ? 's' : ''}`;
            
            let html = '';
            issues.forEach((issue, i) => {
                const severityColor = issue.severity === 'critical' ? 'var(--danger)' : issue.severity === 'warning' ? 'var(--warning)' : 'var(--info)';
                const severityIcon = issue.severity === 'critical' ? '' : issue.severity === 'warning' ? '' : '';
                const hasDetails = issue.details || issue.stackTrace || issue.steps;
                
                html += `
                    <div class="issue-card" style="padding: 16px; background: var(--bg-tertiary); border-radius: 12px; border-left: 4px solid ${severityColor}; ${hasDetails ? 'cursor: pointer;' : ''}" ${hasDetails ? `onclick="toggleIssueDetails('issue-${i}')"` : ''}>
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span>${severityIcon}</span>
                                <span style="font-weight: 600;">${issue.title}</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                ${hasDetails ? '<span style="font-size: 0.7rem; color: var(--accent);">Click to expand </span>' : ''}
                                <span style="font-size: 0.7rem; color: var(--text-muted);">${issue.location || ''}</span>
                            </div>
                        </div>
                        <p style="font-size: 0.85rem; color: var(--text-secondary); margin: 0 0 12px 0;">${issue.description}</p>
                        ${issue.suggestion ? `<div style="font-size: 0.8rem; color: var(--info); background: rgba(59, 130, 246, 0.1); padding: 8px 12px; border-radius: 6px;"> ${issue.suggestion}</div>` : ''}
                        
                        <!-- Expandable Details -->
                        ${hasDetails ? `
                            <div id="issue-${i}" class="issue-details" style="display: none; margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border);">
                                ${issue.details ? `
                                    <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 6px;">DETAILS</div>
                                    <pre style="font-size: 0.75rem; background: var(--bg-secondary); padding: 10px; border-radius: 6px; overflow-x: auto; white-space: pre-wrap;">${issue.details}</pre>
                                ` : ''}
                                ${issue.stackTrace ? `
                                    <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 12px; margin-bottom: 6px;">STACK TRACE</div>
                                    <pre style="font-size: 0.7rem; background: var(--bg-secondary); padding: 10px; border-radius: 6px; overflow-x: auto; color: var(--danger);">${issue.stackTrace}</pre>
                                ` : ''}
                                ${issue.steps ? `
                                    <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 12px; margin-bottom: 6px;">STEPS TO REPRODUCE</div>
                                    <ol style="font-size: 0.8rem; margin: 0; padding-left: 20px;">
                                        ${issue.steps.map(step => `<li style="margin-bottom: 4px;">${step}</li>`).join('')}
                                    </ol>
                                ` : ''}
                            </div>
                        ` : ''}
                    </div>
                `;
            });
            
            list.innerHTML = html;
        }
        
        function toggleIssueDetails(issueId) {
            const details = document.getElementById(issueId);
            if (details) {
                details.style.display = details.style.display === 'none' ? 'block' : 'none';
            }
        }

        async function runAppDiagnostics() {
            if (crawlerRunning) return;
            crawlerRunning = true;
            
            // Reset results
            crawlerResults = {
                passed: 0,
                failed: 0,
                warnings: 0,
                issues: [],
                dependencies: [],
                transitions: [],
                logicFlows: []
            };
            crawlerStartTime = Date.now(); // Track start time for log saving
            diagnosticsLogEntries = []; // Clear previous log entries
            updateCrawlerStats(0, 0, 0, 0);
            
            // Update UI
            document.getElementById('runCrawlerBtn').style.display = 'none';
            document.getElementById('stopCrawlerBtn').style.display = 'flex';
            
            appendDiagnosticsLog('');
            appendDiagnosticsLog('');
            appendDiagnosticsLog(' Starting comprehensive app crawler...');
            appendDiagnosticsLog('');
            setDiagnosticsStatus('Running', 'active');

            // Get crawler options
            const options = {
                screenNav: document.getElementById('crawlScreenNav')?.checked ?? true,
                dependencies: document.getElementById('crawlDependencies')?.checked ?? true,
                logicFlow: document.getElementById('crawlLogicFlow')?.checked ?? true,
                jsErrors: document.getElementById('crawlJSErrors')?.checked ?? true,
                brokenLinks: document.getElementById('crawlBrokenLinks')?.checked ?? true,
                dataIntegrity: document.getElementById('crawlDataIntegrity')?.checked ?? false,
                simulateLogin: document.getElementById('crawlSimulateLogin')?.checked ?? true,
                timeout: parseInt(document.getElementById('crawlerTimeout')?.value) || 30000,
                flowFilter: document.getElementById('crawlerFlowFilter')?.value || 'all'
            };

            // Create test fixtures if simulate login is enabled
            if (options.simulateLogin) {
                appendDiagnosticsLog(' Creating test user fixtures...');
                await createTestUserFixtures();
                appendDiagnosticsLog(' Test user "crawler@test.oith" ready with active match & chat');
            }

            appendDiagnosticsLog(` Options: Nav=${options.screenNav}, Deps=${options.dependencies}, Logic=${options.logicFlow}, JS=${options.jsErrors}, Links=${options.brokenLinks}, Data=${options.dataIntegrity}`);
            appendDiagnosticsLog(` Timeout: ${options.timeout}ms, Flow: ${options.flowFilter}`);

            try {
                const channel = new BroadcastChannel('oith_sync');
                
                // Comprehensive list of all screens with their expected transitions
                const screensToTest = [
                    // Onboarding flow
                    { id: 'splash', name: 'Splash Screen', flow: 'onboarding', nextScreens: ['onboarding-1', 'login'] },
                    { id: 'onboarding-1', name: 'Onboarding Step 1', flow: 'onboarding', nextScreens: ['onboarding-2'] },
                    { id: 'onboarding-2', name: 'Onboarding Step 2', flow: 'onboarding', nextScreens: ['onboarding-3'] },
                    { id: 'onboarding-3', name: 'Onboarding Step 3', flow: 'onboarding', nextScreens: ['signup', 'login'] },
                    // Auth flow
                    { id: 'signup', name: 'Sign Up', flow: 'auth', nextScreens: ['preferences', 'login'] },
                    { id: 'login', name: 'Login', flow: 'auth', nextScreens: ['my-profile', 'match', 'signup'] },
                    // Profile setup flow
                    { id: 'preferences', name: 'Preferences', flow: 'setup', nextScreens: ['profile-details'] },
                    { id: 'profile-details', name: 'Profile Details', flow: 'setup', nextScreens: ['profile-setup'] },
                    { id: 'profile-setup', name: 'Photo Upload', flow: 'setup', nextScreens: ['payment'] },
                    { id: 'payment', name: 'Payment', flow: 'setup', nextScreens: ['match'] },
                    // Main app screens
                    { id: 'match', name: 'Match Screen', flow: 'main', nextScreens: ['match-preferences', 'profile-view', 'chat', 'my-profile'] },
                    { id: 'match-preferences', name: 'Match Preferences', flow: 'main', nextScreens: ['match'] },
                    { id: 'waiting-match', name: 'Waiting for Match', flow: 'main', nextScreens: ['match'] },
                    { id: 'adjust-preferences', name: 'Adjust Preferences', flow: 'main', nextScreens: ['match'] },
                    { id: 'no-matches', name: 'No Matches', flow: 'main', nextScreens: ['adjust-preferences', 'match'] },
                    // Chat & connection
                    { id: 'chat-list', name: 'Chat List', flow: 'chat', nextScreens: ['chat', 'match'] },
                    { id: 'chat', name: 'Chat Window', flow: 'chat', nextScreens: ['chat-list', 'date-plan', 'profile-view'] },
                    { id: 'date-plan', name: 'Date Planning', flow: 'chat', nextScreens: ['chat'] },
                    // Profile screens
                    { id: 'my-profile', name: 'My Profile', flow: 'profile', nextScreens: ['edit-profile', 'settings', 'match'] },
                    { id: 'edit-profile', name: 'Edit Profile', flow: 'profile', nextScreens: ['my-profile'] },
                    { id: 'my-profile-preview', name: 'Profile Preview', flow: 'profile', nextScreens: ['edit-profile'] },
                    { id: 'profile-view', name: 'View Match Profile', flow: 'profile', nextScreens: ['match', 'chat'] },
                    // Settings
                    { id: 'settings', name: 'Settings', flow: 'settings', nextScreens: ['my-profile', 'manage-subscription', 'safety-privacy'] },
                    { id: 'manage-subscription', name: 'Manage Subscription', flow: 'settings', nextScreens: ['settings'] },
                    { id: 'safety-privacy', name: 'Safety & Privacy', flow: 'settings', nextScreens: ['settings'] },
                    // Feedback
                    { id: 'feedback-metrics', name: 'Feedback & Metrics', flow: 'feedback', nextScreens: ['chat-list'] },
                    // Photos management
                    { id: 'manage-photos', name: 'Manage Photos', flow: 'profile', nextScreens: ['edit-profile', 'my-profile'] }
                ];

                // Filter screens by flow if specified
                let filteredScreens = screensToTest;
                if (options.flowFilter !== 'all') {
                    filteredScreens = screensToTest.filter(s => s.flow === options.flowFilter);
                    appendDiagnosticsLog(` Filtering to ${options.flowFilter} flow: ${filteredScreens.length} screens`);
                }

                let responses = [];
                let errors = [];
                let warnings = [];
                
                // First verify app is connected before running diagnostics
                appendDiagnosticsLog(' Checking app connection...');
                console.log(' [CRAWLER] Starting connection check...');
                
                let appConnected = false;
                const connectionCheck = new Promise((resolve) => {
                    const checkHandler = (event) => {
                        console.log(' [CRAWLER] Received message during connection check:', event.data);
                        if (event.data && event.data.type === 'pong') {
                            console.log(' [CRAWLER]  PONG received!', event.data);
                            appConnected = true;
                            channel.removeEventListener('message', checkHandler);
                            resolve(true);
                        }
                    };
                    channel.addEventListener('message', checkHandler);
                    
                    // Also log ALL messages on this channel for debugging
                    channel.onmessage = (event) => {
                        console.log(' [CRAWLER] onmessage received:', event.data);
                    };
                    
                    // Send ping
                    const pingMessage = { type: 'ping', source: 'admin', timestamp: Date.now(), crawlerPing: true };
                    console.log(' [CRAWLER] Sending ping:', pingMessage);
                    channel.postMessage(pingMessage);
                    
                    // Timeout after 3 seconds
                    setTimeout(() => {
                        console.log(' [CRAWLER] Timeout reached, appConnected =', appConnected);
                        channel.removeEventListener('message', checkHandler);
                        resolve(false);
                    }, 3000);
                });
                
                const isConnected = await connectionCheck;
                if (!isConnected) {
                    appendDiagnosticsLog(' App not responding! Make sure index.html is open in another tab.', 'error');
                    appendDiagnosticsLog(' TIP: Open https://main.d3cpep2ztx08x2.amplifyapp.com/prototype/index.html in a new tab, then run crawler again.', 'warn');
                    stopCrawler();
                    return;
                }
                
                appendDiagnosticsLog(' App connection verified!', 'success');
                appendDiagnosticsLog(` Testing ${filteredScreens.length} screens across ${[...new Set(filteredScreens.map(s => s.flow))].length} flows...`);
                appendDiagnosticsLog('');

                channel.onmessage = (event) => {
                    if (!crawlerRunning) return;
                    
                    // Handle diagnostics started acknowledgment
                    if (event.data && event.data.type === 'diagnostics_started') {
                        appendDiagnosticsLog(` App connected! Testing ${event.data.screenCount} screens...`, 'success');
                    }
                    
                    // Handle diagnostics complete signal
                    if (event.data && event.data.type === 'diagnostics_complete') {
                        appendDiagnosticsLog(' App finished all screen tests', 'success');
                    }
                    
                    // Handle pong response
                    if (event.data && event.data.type === 'pong') {
                        appendDiagnosticsLog(` App responded - Current screen: ${event.data.currentScreen}`, 'success');
                    }
                    
                    if (event.data && event.data.type === 'diagnostics_result') {
                        responses.push(event.data);
                        const screen = filteredScreens.find(s => s.id === event.data.screen);
                        const screenName = screen ? screen.name : event.data.screen;
                        
                        if (event.data.ok) {
                            crawlerResults.passed++;
                            appendDiagnosticsLog(` ${screenName} (${event.data.screen})`, 'info');
                            
                            // Record valid transitions
                            if (screen && event.data.availableTransitions) {
                                event.data.availableTransitions.forEach(trans => {
                                    crawlerResults.transitions.push({
                                        from: event.data.screen,
                                        to: trans,
                                        valid: true
                                    });
                                });
                            }
                        } else {
                            crawlerResults.failed++;
                            errors.push({ screen: event.data.screen, name: screenName, error: event.data.error });
                            appendDiagnosticsLog(` ${screenName} (${event.data.screen}): ${event.data.error || 'Unknown error'}`, 'error');
                            
                            // Determine error type and appropriate suggestion
                            const errorMsg = event.data.error || '';
                            let suggestion = 'Check console for JavaScript errors and verify screen element exists in HTML';
                            let details = null;
                            let steps = null;
                            
                            if (errorMsg.includes('not found') || errorMsg.includes('not defined')) {
                                suggestion = 'The screen element may be missing from index.html. Check that the screen ID matches.';
                                steps = ['Open index.html', 'Search for id="' + event.data.screen + '"', 'Add the screen element if missing'];
                            } else if (errorMsg.includes('ReferenceError')) {
                                suggestion = 'A JavaScript function or variable is not defined. Check app.js for typos or missing definitions.';
                                details = 'Common causes:\n- Function name misspelled\n- Variable used before declaration\n- Missing import or script';
                            } else if (errorMsg.includes('timeout') || errorMsg.includes('not reached')) {
                                suggestion = 'Screen requires prior state (logged-in user, active match, etc). Enable "Simulate Logged-in User" in options.';
                                steps = ['Check "Simulate Logged-in User" option', 'Re-run the crawler', 'If still failing, the screen may need specific app state'];
                            } else if (errorMsg.includes('TypeError')) {
                                suggestion = 'A property or method is being accessed on undefined/null. Check data dependencies.';
                                details = 'This usually means:\n- Data not loaded yet\n- Missing null check\n- Incorrect property path';
                            }
                            
                            // Add to issues
                            crawlerResults.issues.push({
                                severity: 'critical',
                                title: `Screen Error: ${screenName}`,
                                description: event.data.error || 'Screen failed to load or function correctly',
                                location: event.data.screen,
                                suggestion: suggestion,
                                details: details,
                                steps: steps,
                                stackTrace: event.data.stackTrace || null
                            });
                        }
                        
                        // Update progress
                        const progress = (responses.length / filteredScreens.length) * 100;
                        updateCrawlerStats(crawlerResults.passed, crawlerResults.failed, crawlerResults.warnings, progress);
                    }
                    
                    // Listen for JS errors
                    if (event.data && event.data.type === 'js_error' && options.jsErrors) {
                        errors.push({ type: 'javascript', message: event.data.message, source: event.data.source });
                        crawlerResults.warnings++;
                        appendDiagnosticsLog(` JS Error: ${event.data.message}`, 'error');
                        
                        crawlerResults.issues.push({
                            severity: 'critical',
                            title: 'JavaScript Error',
                            description: event.data.message,
                            location: event.data.source || 'Unknown source',
                            suggestion: 'Check the browser console and fix the JavaScript error'
                        });
                        
                        updateCrawlerStats(crawlerResults.passed, crawlerResults.failed, crawlerResults.warnings, (responses.length / filteredScreens.length) * 100);
                    }
                    
                    // Listen for dependency analysis results
                    if (event.data && event.data.type === 'dependency_result' && options.dependencies) {
                        crawlerResults.dependencies.push(...(event.data.dependencies || []));
                        event.data.dependencies?.filter(d => d.broken).forEach(dep => {
                            crawlerResults.issues.push({
                                severity: 'warning',
                                title: `Missing Dependency: ${dep.target}`,
                                description: `Function or handler "${dep.target}" is called but not defined`,
                                location: dep.source,
                                suggestion: `Define the function "${dep.target}" or remove the reference`
                            });
                            crawlerResults.warnings++;
                        });
                    }
                };

                // Kick off tests in the main app with extended options
                channel.postMessage({
                    type: 'run_diagnostics',
                    screens: filteredScreens.map(s => s.id),
                    comprehensive: true,
                    checkDependencies: options.dependencies,
                    checkLogicFlow: options.logicFlow,
                    checkBrokenLinks: options.brokenLinks,
                    checkDataIntegrity: options.dataIntegrity,
                    simulateLogin: options.simulateLogin
                });

                const start = Date.now();
                let lastCount = 0;
                while (crawlerRunning && Date.now() - start < options.timeout && responses.length < filteredScreens.length) {
                    await new Promise(res => setTimeout(res, 300));
                    
                    if (responses.length > lastCount) {
                        lastCount = responses.length;
                        appendDiagnosticsLog(` Progress: ${responses.length}/${filteredScreens.length} screens tested...`);
                    }
                }

                if (!crawlerRunning) return; // Aborted

                // Generate logic flow analysis
                if (options.logicFlow) {
                    const flowGroups = {};
                    filteredScreens.forEach(s => {
                        if (!flowGroups[s.flow]) flowGroups[s.flow] = [];
                        flowGroups[s.flow].push(s);
                    });

                    Object.entries(flowGroups).forEach(([flowName, screens]) => {
                        const screenResults = screens.map(s => {
                            const response = responses.find(r => r.screen === s.id);
                            return {
                                id: s.id,
                                name: s.name,
                                passed: response ? response.ok : false,
                                error: response ? response.error : 'Screen not tested (timeout or not reached)',
                                tested: !!response
                            };
                        });
                        
                        const flowPassed = screenResults.filter(s => s.passed).length;
                        const flowStatus = flowPassed === screens.length ? 'ok' : flowPassed > screens.length / 2 ? 'warning' : 'error';
                        
                        crawlerResults.logicFlows.push({
                            name: flowName.charAt(0).toUpperCase() + flowName.slice(1) + ' Flow',
                            status: flowStatus,
                            steps: screens.map(s => s.name),
                            screenResults: screenResults,
                            passedCount: flowPassed,
                            totalCount: screens.length,
                            issue: flowStatus !== 'ok' ? `${screens.length - flowPassed} screen(s) failed` : null
                        });
                    });
                }

                // Generate summary report
                appendDiagnosticsLog('');
                appendDiagnosticsLog('');
                appendDiagnosticsLog(' CRAWLER SUMMARY REPORT');
                appendDiagnosticsLog('');
                
                if (responses.length === 0) {
                    appendDiagnosticsLog(' No response from main app.', 'warn');
                    appendDiagnosticsLog('   Make sure index.html is open in another tab.', 'warn');
                    setDiagnosticsStatus('No Response', 'warning');
                    crawlerResults.issues.push({
                        severity: 'critical',
                        title: 'No App Response',
                        description: 'The crawler could not communicate with the main application',
                        suggestion: 'Open index.html in another browser tab and try again'
                    });
                } else {
                    const passed = crawlerResults.passed;
                    const failed = crawlerResults.failed;
                    const untested = filteredScreens.length - responses.length;

                    appendDiagnosticsLog(` Passed: ${passed}/${filteredScreens.length}`);
                    appendDiagnosticsLog(` Failed: ${failed}/${filteredScreens.length}`);
                    if (untested > 0) {
                        appendDiagnosticsLog(` Skipped/Timeout: ${untested}`, 'warn');
                    }

                    if (errors.length > 0) {
                        appendDiagnosticsLog('');
                        appendDiagnosticsLog(' ERRORS FOUND:');
                        errors.forEach(err => {
                            if (err.type === 'javascript') {
                                appendDiagnosticsLog(`   JS: ${err.message}`, 'error');
                            } else {
                                appendDiagnosticsLog(`   ${err.name}: ${err.error}`, 'error');
                            }
                        });
                    }

                    // Dependency check
                    if (options.dependencies) {
                        appendDiagnosticsLog('');
                        appendDiagnosticsLog(' DEPENDENCY CHECK:');
                        const criticalScreens = ['login', 'signup', 'match', 'chat', 'my-profile'];
                        const missingCritical = criticalScreens.filter(s => !responses.find(r => r.screen === s && r.ok));
                        if (missingCritical.length > 0) {
                            appendDiagnosticsLog(`    Critical screens not working: ${missingCritical.join(', ')}`, 'error');
                        } else {
                            appendDiagnosticsLog(`    All critical screens functional`);
                        }
                        
                        const brokenDeps = crawlerResults.dependencies.filter(d => d.broken);
                        if (brokenDeps.length > 0) {
                            appendDiagnosticsLog(`    ${brokenDeps.length} broken dependencies found`, 'warn');
                        }
                    }

                    // Flow connectivity
                    if (options.logicFlow) {
                        appendDiagnosticsLog('');
                        appendDiagnosticsLog(' FLOW CONNECTIVITY:');
                        crawlerResults.logicFlows.forEach(flow => {
                            const status = flow.status === 'ok' ? '' : flow.status === 'warning' ? '' : '';
                            appendDiagnosticsLog(`   ${status} ${flow.name}`);
                        });
                    }

                    // Final status
                    if (failed === 0 && untested === 0) {
                        appendDiagnosticsLog('');
                        appendDiagnosticsLog(' ALL TESTS PASSED!', 'success');
                        setDiagnosticsStatus('All Passed', 'active');
                    } else if (failed > 0) {
                        setDiagnosticsStatus(`${failed} Failed`, 'danger');
                    } else {
                        setDiagnosticsStatus(`${passed} Passed`, 'warning');
                    }
                }

                // Render visualizations - merge static dependencies with any runtime-collected ones
                const allDependencies = [...generateAppDependencies(), ...crawlerResults.dependencies];
                renderDependencyMap(allDependencies);
                renderLogicFlows(crawlerResults.logicFlows);
                renderTransitionMatrix(crawlerResults.transitions, filteredScreens);
                renderIssuesPanel(crawlerResults.issues);
                
                // Auto-expand dependency map if it has data
                if (allDependencies.length > 0) {
                    const depBody = document.getElementById('dependencyMapBody');
                    const depToggle = document.getElementById('dependencyMapToggle');
                    if (depBody && depBody.style.display === 'none') {
                        depBody.style.display = 'block';
                        if (depToggle) depToggle.style.transform = 'rotate(180deg)';
                    }
                }
                
                // Auto-expand failed logic flows so users can see what went wrong
                crawlerResults.logicFlows.forEach((flow, index) => {
                    if (flow.status !== 'ok') {
                        const flowDetails = document.getElementById(`flow-${index}`);
                        if (flowDetails) {
                            flowDetails.style.display = 'block';
                        }
                    }
                });
                
                // Auto-expand logic flow panel if there are failures
                if (crawlerResults.logicFlows.some(f => f.status !== 'ok')) {
                    const logicBody = document.getElementById('logicFlowBody');
                    const logicToggle = document.getElementById('logicFlowToggle');
                    if (logicBody && logicBody.style.display === 'none') {
                        logicBody.style.display = 'block';
                        if (logicToggle) logicToggle.style.transform = 'rotate(180deg)';
                    }
                }

                // Update final stats
                updateCrawlerStats(crawlerResults.passed, crawlerResults.failed, crawlerResults.warnings, 100);

            } catch (err) {
                console.error('Diagnostics error', err);
                appendDiagnosticsLog(` Crawler Error: ${String(err)}`, 'error');
                setDiagnosticsStatus('Error', 'danger');
                crawlerResults.issues.push({
                    severity: 'critical',
                    title: 'Crawler Error',
                    description: String(err),
                    suggestion: 'Check the browser console for more details'
                });
                renderIssuesPanel(crawlerResults.issues);
            } finally {
                crawlerRunning = false;
                document.getElementById('runCrawlerBtn').style.display = 'flex';
                document.getElementById('stopCrawlerBtn').style.display = 'none';
                
                // Clean up test fixtures - send logout to app
                if (options.simulateLogin) {
                    cleanupTestFixtures();
                    const cleanupChannel = new BroadcastChannel('oith_sync');
                    cleanupChannel.postMessage({ type: 'crawler_logout', source: 'admin' });
                    appendDiagnosticsLog(' Cleaned up test fixtures');
                }
                
                // Save crawler log to DynamoDB
                const endTime = Date.now();
                await saveCrawlerLogToAWS(crawlerStartTime, endTime - crawlerStartTime, options);
            }
        }
        
        // Track crawler start time
        let crawlerStartTime = Date.now();
        
        // Save crawler log to DynamoDB (App Diagnostics)
        async function saveCrawlerLogToAWS(startTime, duration, options) {
            try {
                const runId = new Date(startTime).toISOString();
                const response = await fetch(`${AWS_API_URL}/crawler/logs`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        runId: runId,
                        source: 'app', // App Diagnostics crawler
                        logs: diagnosticsLogEntries,
                        summary: {
                            passed: crawlerResults.passed,
                            failed: crawlerResults.failed,
                            warnings: crawlerResults.warnings,
                            issueCount: crawlerResults.issues.length
                        },
                        options: options,
                        duration: duration
                    })
                });
                
                if (response.ok) {
                    appendDiagnosticsLog(' Log saved to cloud', 'success');
                    loadCrawlerLogHistory(); // Refresh the history
                } else {
                    console.log('Could not save crawler log to AWS');
                }
            } catch (error) {
                console.log('Crawler log save error:', error.message);
            }
        }
        
        // Load crawler log history from DynamoDB
        async function loadCrawlerLogHistory() {
            try {
                const response = await fetch(`${AWS_API_URL}/crawler/logs`);
                if (response.ok) {
                    const data = await response.json();
                    renderCrawlerLogHistory(data.logs || []);
                }
            } catch (error) {
                console.log('Could not load crawler history');
            }
        }
        
        // Render the crawler log history UI
        function renderCrawlerLogHistory(logs) {
            const container = document.getElementById('crawlerLogHistory');
            if (!container) return;
            
            if (logs.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-muted);">No crawler logs saved yet. Run the crawler to create your first log.</div>';
                return;
            }
            
            container.innerHTML = logs.map(log => {
                const date = new Date(log.createdAt);
                const statusIcon = log.summary?.failed > 0 ? '' : log.summary?.warnings > 0 ? '' : '';
                const statusColor = log.summary?.failed > 0 ? 'var(--danger)' : log.summary?.warnings > 0 ? 'var(--warning)' : 'var(--success)';
                
                return `
                    <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--bg-tertiary); border-radius: 8px; margin-bottom: 8px;">
                        <div style="font-size: 1.5rem;">${statusIcon}</div>
                        <div style="flex: 1;">
                            <div style="font-weight: 500;">${date.toLocaleDateString()} ${date.toLocaleTimeString()}</div>
                            <div style="font-size: 0.75rem; color: var(--text-muted);">
                                <span style="color: var(--success);"> ${log.summary?.passed || 0}</span>  
                                <span style="color: var(--danger);"> ${log.summary?.failed || 0}</span>  
                                <span style="color: var(--warning);"> ${log.summary?.warnings || 0}</span>  
                                ${log.logCount || 0} log entries  ${Math.round((log.duration || 0) / 1000)}s
                            </div>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button onclick="viewCrawlerLog('${log.runId}')" style="padding: 6px 12px; background: var(--info); color: white; border: none; border-radius: 6px; font-size: 0.75rem; cursor: pointer;">
                                 View
                            </button>
                            <button onclick="downloadCrawlerLog('${log.runId}')" style="padding: 6px 12px; background: var(--accent); color: white; border: none; border-radius: 6px; font-size: 0.75rem; cursor: pointer;">
                                 Download
                            </button>
                            <button onclick="deleteCrawlerLog('${log.runId}')" style="padding: 6px 12px; background: transparent; color: var(--danger); border: 1px solid var(--danger); border-radius: 6px; font-size: 0.75rem; cursor: pointer;">
                                
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // View a specific crawler log
        async function viewCrawlerLog(runId) {
            try {
                const response = await fetch(`${AWS_API_URL}/crawler/logs/${encodeURIComponent(runId)}`);
                if (response.ok) {
                    const data = await response.json();
                    
                    // Display in the main log viewer
                    const logEl = document.getElementById('diagnosticsLog');
                    if (logEl) {
                        const text = data.logs.map(e => `${e.timestamp} ${e.prefix} ${e.message}`).join('\n');
                        logEl.innerHTML = `<pre>${text}</pre>`;
                        logEl.scrollTop = 0;
                    }
                    
                    // Update stats display
                    if (data.summary) {
                        updateCrawlerStats(data.summary.passed, data.summary.failed, data.summary.warnings, 100);
                    }
                    
                    showToast(` Viewing log from ${new Date(runId).toLocaleString()}`, 'info');
                }
            } catch (error) {
                showToast(' Could not load log', 'error');
            }
        }
        
        // Download a crawler log as text file
        async function downloadCrawlerLog(runId) {
            try {
                const response = await fetch(`${AWS_API_URL}/crawler/logs/${encodeURIComponent(runId)}`);
                if (response.ok) {
                    const data = await response.json();
                    
                    let text = `OITH Crawler Log\n`;
                    text += `================\n`;
                    text += `Run: ${runId}\n`;
                    text += `Date: ${new Date(data.createdAt).toLocaleString()}\n`;
                    text += `Duration: ${Math.round((data.duration || 0) / 1000)} seconds\n\n`;
                    text += `SUMMARY\n`;
                    text += `-------\n`;
                    text += `Passed: ${data.summary?.passed || 0}\n`;
                    text += `Failed: ${data.summary?.failed || 0}\n`;
                    text += `Warnings: ${data.summary?.warnings || 0}\n`;
                    text += `Issues: ${data.summary?.issueCount || 0}\n\n`;
                    text += `OPTIONS\n`;
                    text += `-------\n`;
                    text += JSON.stringify(data.options || {}, null, 2) + '\n\n';
                    text += `LOG OUTPUT\n`;
                    text += `----------\n`;
                    text += data.logs.map(e => `${e.timestamp} ${e.prefix} ${e.message}`).join('\n');
                    
                    const blob = new Blob([text], { type: 'text/plain' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `oith-crawler-log-${new Date(runId).toISOString().split('T')[0]}.txt`;
                    a.click();
                    URL.revokeObjectURL(url);
                    
                    showToast(' Log downloaded', 'success');
                }
            } catch (error) {
                showToast(' Could not download log', 'error');
            }
        }
        
        // Delete a crawler log
        async function deleteCrawlerLog(runId) {
            if (!confirm('Delete this crawler log?')) return;
            
            try {
                const response = await fetch(`${AWS_API_URL}/crawler/logs/${encodeURIComponent(runId)}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    showToast(' Log deleted', 'info');
                    loadCrawlerLogHistory();
                }
            } catch (error) {
                showToast(' Could not delete log', 'error');
            }
        }

        // ==========================================
        // SITE DIAGNOSTICS (ADMIN)
        // ==========================================
        
        let siteDiagnosticsResults = {
            functional: [],
            broken: [],
            hardcoded: [],
            connections: []
        };

        function appendSiteDiagnosticsLog(message, type = 'info') {
            const logEl = document.getElementById('siteDiagnosticsLog');
            if (!logEl) return;
            const timestamp = new Date().toISOString().split('T')[1].split('.')[0];
            const prefix = type === 'error' ? '[ERROR]' : type === 'warn' ? '[WARN]' : type === 'success' ? '[SUCCESS]' : '[INFO]';
            const existing = logEl.querySelector('pre')?.textContent || '';
            const next = `${existing}\n${timestamp} ${prefix} ${message}`;
            logEl.innerHTML = `<pre>${next}</pre>`;
            logEl.scrollTop = logEl.scrollHeight;
        }

        function clearSiteDiagnosticsLog() {
            const logEl = document.getElementById('siteDiagnosticsLog');
            if (logEl) {
                logEl.innerHTML = '<pre>// Log cleared...</pre>';
            }
        }

        function setSiteDiagnosticsStatus(text, statusClass = '') {
            const statusEl = document.getElementById('siteDiagnosticsStatus');
            if (statusEl) {
                statusEl.textContent = text;
                statusEl.className = 'status-badge';
                if (statusClass) statusEl.classList.add(statusClass);
            }
        }

        function toggleSiteSection(section) {
            const body = document.getElementById(section + 'Body');
            const toggle = document.getElementById(section + 'Toggle');
            if (body.style.display === 'none') {
                body.style.display = 'block';
                toggle.style.transform = 'rotate(180deg)';
            } else {
                body.style.display = 'none';
                toggle.style.transform = 'rotate(0deg)';
            }
        }

        // ==========================================
        // DATA TRANSFER & PROCESSING COSTS ANALYSIS
        // ==========================================
        
        // Service cost rates (per GB/month or per 1M requests)
        const DATA_TRANSFER_COSTS = {
            // AWS Services
            's3': { 
                storage: 0.023,          // per GB/month
                transfer: 0.09,          // per GB outbound
                requests: 0.0004,        // per 1K requests
                linkedExpense: 'aws-s3'
            },
            'dynamodb': { 
                storage: 0.25,           // per GB/month
                read: 0.25,              // per 1M read units
                write: 1.25,             // per 1M write units
                linkedExpense: 'aws-dynamodb'
            },
            'lambda': { 
                requests: 0.20,          // per 1M requests
                compute: 0.0000166667,   // per GB-second
                linkedExpense: 'aws-lambda'
            },
            'cognito': {
                mau: 0.0055,             // per MAU after free tier
                linkedExpense: 'aws-cognito'
            },
            'ses': {
                emails: 0.10,            // per 1K emails
                linkedExpense: 'aws-ses'
            },
            // Third-party Services
            'google-workspace': {
                storage: 0,              // 15GB included
                transfer: 0,             // included
                linkedExpense: 'google-workspace'
            },
            'cursor': {
                requests: 0,             // flat monthly rate
                linkedExpense: 'cursor'
            }
        };
        
        function analyzeDataTransfer() {
            appendSiteDiagnosticsLog(' Starting data transfer analysis...');
            
            // Collect all data sizes from localStorage and app state
            const dataCategories = [];
            let totalSize = 0;
            
            // Analyze localStorage data
            const localStorageData = {};
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                const value = localStorage.getItem(key);
                const size = new Blob([value]).size;
                
                // Categorize by prefix
                let category = 'other';
                if (key.startsWith('oith_')) {
                    if (key.includes('user')) category = 'users';
                    else if (key.includes('match')) category = 'matching';
                    else if (key.includes('chat') || key.includes('message')) category = 'messaging';
                    else if (key.includes('expense') || key.includes('payroll')) category = 'finance';
                    else if (key.includes('org') || key.includes('employee')) category = 'organization';
                    else if (key.includes('calendar') || key.includes('event')) category = 'calendar';
                    else if (key.includes('experiment')) category = 'experiments';
                    else if (key.includes('admin') || key.includes('diagnostics')) category = 'admin';
                    else category = 'app-data';
                }
                
                if (!localStorageData[category]) {
                    localStorageData[category] = { size: 0, count: 0, keys: [] };
                }
                localStorageData[category].size += size;
                localStorageData[category].count++;
                localStorageData[category].keys.push(key);
                totalSize += size;
            }
            
            // Map categories to services and calculate costs
            const serviceMapping = {
                'users': { service: 'dynamodb', name: 'AWS DynamoDB', icon: '' },
                'matching': { service: 'lambda', name: 'AWS Lambda', icon: '' },
                'messaging': { service: 'dynamodb', name: 'AWS DynamoDB', icon: '' },
                'finance': { service: 'dynamodb', name: 'AWS DynamoDB', icon: '' },
                'organization': { service: 'dynamodb', name: 'AWS DynamoDB', icon: '' },
                'calendar': { service: 'google-workspace', name: 'Google Workspace', icon: '' },
                'experiments': { service: 'dynamodb', name: 'AWS DynamoDB', icon: '' },
                'admin': { service: 'cursor', name: 'Cursor/Dev Tools', icon: '' },
                'app-data': { service: 's3', name: 'AWS S3', icon: '' },
                'other': { service: 's3', name: 'AWS S3', icon: '' }
            };
            
            // Calculate costs for each category
            const serviceBreakdown = {};
            Object.entries(localStorageData).forEach(([category, data]) => {
                const mapping = serviceMapping[category] || serviceMapping['other'];
                const costs = DATA_TRANSFER_COSTS[mapping.service] || {};
                
                // Calculate estimated monthly cost based on data size
                const sizeGB = data.size / (1024 * 1024 * 1024);
                let monthlyCost = 0;
                
                if (costs.storage) monthlyCost += sizeGB * costs.storage;
                if (costs.transfer) monthlyCost += sizeGB * costs.transfer * 10; // Assume 10x transfer
                
                // Aggregate by service
                if (!serviceBreakdown[mapping.service]) {
                    serviceBreakdown[mapping.service] = {
                        name: mapping.name,
                        icon: mapping.icon,
                        size: 0,
                        count: 0,
                        cost: 0,
                        categories: [],
                        linkedExpense: costs.linkedExpense
                    };
                }
                serviceBreakdown[mapping.service].size += data.size;
                serviceBreakdown[mapping.service].count += data.count;
                serviceBreakdown[mapping.service].cost += monthlyCost;
                serviceBreakdown[mapping.service].categories.push(category);
                
                dataCategories.push({
                    category,
                    size: data.size,
                    count: data.count,
                    service: mapping.name,
                    linkedExpense: costs.linkedExpense,
                    cost: monthlyCost
                });
            });
            
            // Estimate API calls based on data patterns
            const estimatedApiCalls = Object.values(localStorageData)
                .reduce((sum, d) => sum + d.count * 100, 0); // Assume 100 API calls per storage key per month
            
            // Calculate total costs
            let totalTransferCost = 0;
            let totalProcessingCost = 0;
            
            Object.values(serviceBreakdown).forEach(service => {
                if (['dynamodb', 's3'].includes(service.linkedExpense?.replace('aws-', ''))) {
                    totalTransferCost += service.cost * 0.7; // 70% storage/transfer
                    totalProcessingCost += service.cost * 0.3; // 30% processing
                } else if (service.linkedExpense === 'aws-lambda') {
                    totalProcessingCost += service.cost;
                } else {
                    totalTransferCost += service.cost;
                }
            });
            
            const totalMonthlyCost = totalTransferCost + totalProcessingCost;
            
            // Update UI - Quick Stats
            document.getElementById('dtTotalDataSize').textContent = formatBytes(totalSize);
            document.getElementById('dtApiCalls').textContent = formatNumber(estimatedApiCalls);
            document.getElementById('dtTransferCost').textContent = `$${totalTransferCost.toFixed(2)}`;
            document.getElementById('dtProcessingCost').textContent = `$${totalProcessingCost.toFixed(2)}`;
            document.getElementById('dataTransferTotalCost').textContent = `$${totalMonthlyCost.toFixed(2)}/mo`;
            
            // Update Service Breakdown
            const serviceListEl = document.getElementById('dataTransferServiceList');
            if (serviceListEl) {
                serviceListEl.innerHTML = Object.entries(serviceBreakdown)
                    .sort((a, b) => b[1].size - a[1].size)
                    .map(([serviceId, service]) => {
                        const expense = expenseData.find(e => e.id === service.linkedExpense);
                        const expenseCost = expense ? (expense.perUser ? expense.cost * (expense.users || 1) : expense.cost) : 0;
                        const totalServiceCost = service.cost + expenseCost;
                        
                        return `
                            <div style="padding: 14px; background: var(--bg-tertiary); border-radius: 10px; border-left: 4px solid ${getServiceColor(serviceId)};">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <span style="font-size: 1.2rem;">${service.icon}</span>
                                        <div>
                                            <div style="font-weight: 600; font-size: 0.9rem;">${service.name}</div>
                                            <div style="font-size: 0.7rem; color: var(--text-muted);">${service.categories.join(', ')}</div>
                                        </div>
                                    </div>
                                    <div style="text-align: right;">
                                        <div style="font-weight: 700; color: var(--accent);">$${totalServiceCost.toFixed(2)}/mo</div>
                                        <div style="font-size: 0.7rem; color: var(--text-muted);">${formatBytes(service.size)}</div>
                                    </div>
                                </div>
                                <div style="display: flex; gap: 16px; font-size: 0.75rem; color: var(--text-secondary);">
                                    <span> ${service.count} records</span>
                                    <span> Data: $${service.cost.toFixed(2)}</span>
                                    ${expense ? `<span> Service: $${expenseCost.toFixed(2)}</span>` : ''}
                                    ${expense ? `<a href="#" onclick="showSection('expenses'); return false;" style="color: var(--accent);">View in Expenses </a>` : ''}
                                </div>
                            </div>
                        `;
                    }).join('');
            }
            
            // Update Table
            const tableEl = document.getElementById('dataTransferTable');
            if (tableEl) {
                tableEl.innerHTML = dataCategories
                    .sort((a, b) => b.size - a.size)
                    .map(cat => `
                        <tr>
                            <td style="padding: 10px 12px; border-bottom: 1px solid var(--border);">${cat.category}</td>
                            <td style="padding: 10px 12px; text-align: right; border-bottom: 1px solid var(--border);">${formatBytes(cat.size)}</td>
                            <td style="padding: 10px 12px; text-align: right; border-bottom: 1px solid var(--border);">${cat.count}</td>
                            <td style="padding: 10px 12px; border-bottom: 1px solid var(--border);">
                                <span style="display: inline-flex; align-items: center; gap: 6px;">
                                    ${cat.service}
                                    ${cat.linkedExpense ? `<a href="#" onclick="showSection('expenses'); return false;" style="color: var(--accent); font-size: 0.7rem;"></a>` : ''}
                                </span>
                            </td>
                            <td style="padding: 10px 12px; text-align: right; border-bottom: 1px solid var(--border); color: var(--success);">$${cat.cost.toFixed(4)}</td>
                        </tr>
                    `).join('');
            }
            
            // Cost Projections based on user scaling
            const baseDataPerUser = totalSize / Math.max(1, localStorageData['users']?.count || 1);
            const calculateScaleCost = (users) => {
                const projectedDataGB = (baseDataPerUser * users) / (1024 * 1024 * 1024);
                // DynamoDB: $0.25/GB storage + $1.25/M writes + $0.25/M reads
                const dynamoDbCost = projectedDataGB * 0.25 + (users * 100 / 1000000) * 1.25 + (users * 500 / 1000000) * 0.25;
                // Lambda: $0.20/M requests
                const lambdaCost = (users * 50 / 1000000) * 0.20;
                // S3: $0.023/GB
                const s3Cost = projectedDataGB * 0.5 * 0.023;
                // Add base service costs
                const baseCosts = expenseData
                    .filter(e => e.category === 'cloud' && e.status === 'active')
                    .reduce((sum, e) => sum + (e.billing === 'monthly' ? e.cost : 0), 0);
                return dynamoDbCost + lambdaCost + s3Cost + baseCosts;
            };
            
            document.getElementById('dtCostCurrent').textContent = `$${totalMonthlyCost.toFixed(2)}/mo`;
            document.getElementById('dtCost1k').textContent = `$${calculateScaleCost(1000).toFixed(2)}/mo`;
            document.getElementById('dtCost10k').textContent = `$${calculateScaleCost(10000).toFixed(2)}/mo`;
            document.getElementById('dtCost100k').textContent = `$${calculateScaleCost(100000).toFixed(2)}/mo`;
            
            appendSiteDiagnosticsLog(` Analysis complete: ${formatBytes(totalSize)} total, $${totalMonthlyCost.toFixed(2)}/mo estimated`, 'success');
        }
        
        function getServiceColor(serviceId) {
            const colors = {
                'dynamodb': '#FF9900',
                'lambda': '#FF9900',
                's3': '#569A31',
                'cognito': '#DD344C',
                'ses': '#232F3E',
                'google-workspace': '#4285F4',
                'cursor': '#8B5CF6'
            };
            return colors[serviceId] || 'var(--accent)';
        }
        
        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        function formatNumber(num) {
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return num.toString();
        }

        function renderSiteDiagnostics() {
            appendSiteDiagnosticsLog('// Site Diagnostics view opened');
            renderAdminArchitectureMap();
            loadIndexConfig();
            checkIndexConnection();
            initSiteAutoRun();
            
            // Reset progress bar
            document.getElementById('siteCrawlerProgressBar').style.width = '0%';
            document.getElementById('siteCrawlerProgress').textContent = '0%';
            
            // Initialize BroadcastChannel stats display
            updateBroadcastStats();
            
            // Update health monitor panel
            updateHealthMonitorPanel();
            
            // Auto-run health monitor check if not done yet
            onSiteDiagnosticsShown();
            
            // Test BroadcastChannel connection
            setTimeout(() => {
                testBroadcastConnection();
            }, 500);
            
            // Site diagnostics now runs only when user clicks "Run Analysis" button
            // (removed auto-run to give user control over when to generate reports)
        }

        function renderAdminArchitectureMap() {
            const container = document.getElementById('adminArchitectureMap');
            if (!container) return;

            const html = `
                <div style="display: flex; flex-direction: column; gap: 20px;">
                    <!-- AWS Amplify Hosting Layer -->
                    <div style="padding: 12px; background: linear-gradient(135deg, rgba(255, 153, 0, 0.15), rgba(255, 153, 0, 0.05)); border: 1px solid #FF9900; border-radius: 12px;">
                        <div style="font-size: 0.7rem; color: #FF9900; font-weight: 600; margin-bottom: 12px; text-align: center;"> AWS AMPLIFY HOSTING</div>
                        <div style="display: flex; justify-content: center; gap: 40px; flex-wrap: wrap;">
                            <div style="padding: 14px 20px; background: linear-gradient(135deg, var(--accent), var(--accent-light)); border-radius: 10px; color: white; font-weight: 600; text-align: center; min-width: 180px;">
                                 Admin Dashboard<br><span style="font-size: 0.75rem; opacity: 0.9;">manager.html</span>
                            </div>
                            <div style="padding: 14px 20px; background: linear-gradient(135deg, var(--success), #34d399); border-radius: 10px; color: white; font-weight: 600; text-align: center; min-width: 180px;">
                                 User App<br><span style="font-size: 0.75rem; opacity: 0.9;">index.html</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Connection Lines to API -->
                    <div style="display: flex; justify-content: center; gap: 100px;">
                        <div style="text-align: center;">
                            <div style="width: 3px; height: 25px; background: linear-gradient(var(--info), var(--purple)); margin: 0 auto;"></div>
                            <div style="font-size: 0.65rem; color: var(--text-muted);">REST API</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="width: 3px; height: 25px; background: linear-gradient(var(--info), var(--purple)); margin: 0 auto;"></div>
                            <div style="font-size: 0.65rem; color: var(--text-muted);">REST API</div>
                        </div>
                    </div>
                    
                    <!-- AWS Backend Layer -->
                    <div style="padding: 12px; background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(139, 92, 246, 0.02)); border: 1px solid var(--purple); border-radius: 12px;">
                        <div style="font-size: 0.7rem; color: var(--purple); font-weight: 600; margin-bottom: 12px; text-align: center;"> AWS BACKEND</div>
                        <div style="display: flex; justify-content: center; gap: 20px; flex-wrap: wrap; align-items: center;">
                            <div style="padding: 10px 16px; background: var(--bg-secondary); border: 2px solid var(--info); border-radius: 8px; text-align: center;">
                                <div style="font-size: 1rem; margin-bottom: 2px;"></div>
                                <div style="font-weight: 500; font-size: 0.8rem;">API Gateway</div>
                                <div style="font-size: 0.65rem; color: var(--text-muted);">HTTP Endpoints</div>
                        </div>
                            <div style="color: var(--text-muted);"></div>
                            <div style="padding: 10px 16px; background: var(--bg-secondary); border: 2px solid var(--warning); border-radius: 8px; text-align: center;">
                                <div style="font-size: 1rem; margin-bottom: 2px;"></div>
                                <div style="font-weight: 500; font-size: 0.8rem;">Lambda</div>
                                <div style="font-size: 0.65rem; color: var(--text-muted);">userSync Function</div>
                        </div>
                            <div style="color: var(--text-muted);"></div>
                            <div style="padding: 10px 16px; background: var(--bg-secondary); border: 2px solid var(--success); border-radius: 8px; text-align: center;">
                                <div style="font-size: 1rem; margin-bottom: 2px;"></div>
                                <div style="font-weight: 500; font-size: 0.8rem;">DynamoDB</div>
                                <div style="font-size: 0.65rem; color: var(--text-muted);">oith-users table</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Data Types Stored -->
                    <div style="display: flex; justify-content: center; flex-wrap: wrap; gap: 8px;">
                        <span style="padding: 4px 10px; background: var(--bg-secondary); border-radius: 20px; font-size: 0.7rem; border: 1px solid var(--border);"> Profiles</span>
                        <span style="padding: 4px 10px; background: var(--bg-secondary); border-radius: 20px; font-size: 0.7rem; border: 1px solid var(--border);"> Matches</span>
                        <span style="padding: 4px 10px; background: var(--bg-secondary); border-radius: 20px; font-size: 0.7rem; border: 1px solid var(--border);"> Messages</span>
                        <span style="padding: 4px 10px; background: var(--bg-secondary); border-radius: 20px; font-size: 0.7rem; border: 1px solid var(--border);"> Employees</span>
                        <span style="padding: 4px 10px; background: var(--bg-secondary); border-radius: 20px; font-size: 0.7rem; border: 1px solid var(--border);"> Documents</span>
                        <span style="padding: 4px 10px; background: var(--bg-secondary); border-radius: 20px; font-size: 0.7rem; border: 1px solid var(--border);"> Config</span>
                    </div>
                    
                    <!-- Real-time Communication -->
                    <div style="display: flex; justify-content: center;">
                        <div style="padding: 10px 20px; background: var(--bg-secondary); border: 2px dashed var(--warning); border-radius: 10px; text-align: center;">
                            <div style="font-size: 0.9rem; margin-bottom: 2px;"></div>
                            <div style="font-weight: 500; font-size: 0.8rem;">BroadcastChannel</div>
                            <div style="font-size: 0.65rem; color: var(--text-muted);">'oith_sync' - Admin  App real-time sync</div>
                        </div>
                    </div>
                    
                    <!-- Data Flow Legend -->
                    <div style="display: flex; justify-content: center; gap: 16px; flex-wrap: wrap; padding-top: 12px; border-top: 1px solid var(--border);">
                        <div style="display: flex; align-items: center; gap: 6px; font-size: 0.7rem;">
                            <div style="width: 20px; height: 3px; background: linear-gradient(90deg, var(--info), var(--purple));"></div>
                            <span>API Call</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 6px; font-size: 0.7rem;">
                            <div style="width: 20px; height: 3px; background: var(--success);"></div>
                            <span>Data Flow</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 6px; font-size: 0.7rem;">
                            <div style="width: 20px; height: 3px; border-top: 2px dashed var(--warning);"></div>
                            <span>Real-time</span>
                        </div>
                    </div>
                </div>
            `;
            container.innerHTML = html;
        }

        let siteAnalysisRunning = false;
        let siteAnalysisStopped = false;

        function stopSiteAnalysis() {
            siteAnalysisStopped = true;
            appendSiteDiagnosticsLog(' Analysis stopped by user', 'warn');
            setSiteDiagnosticsStatus('Stopped', 'warning');
            
            // Reset buttons
            const runBtn = document.getElementById('runSiteAnalysisBtn');
            const stopBtn = document.getElementById('stopSiteAnalysisBtn');
            if (runBtn) runBtn.style.display = '';
            if (stopBtn) stopBtn.style.display = 'none';
            siteAnalysisRunning = false;
        }

        async function runSiteDiagnostics() {
            // Prevent double-runs
            if (siteAnalysisRunning) {
                appendSiteDiagnosticsLog(' Analysis already running...', 'warn');
                return;
            }
            
            siteAnalysisRunning = true;
            siteAnalysisStopped = false;
            siteCrawlerStartTime = Date.now(); // Track start time for log
            
            // Update button visibility
            const runBtn = document.getElementById('runSiteAnalysisBtn');
            const stopBtn = document.getElementById('stopSiteAnalysisBtn');
            if (runBtn) runBtn.style.display = 'none';
            if (stopBtn) stopBtn.style.display = '';
            
            appendSiteDiagnosticsLog('');
            appendSiteDiagnosticsLog('');
            appendSiteDiagnosticsLog(' Starting Admin Site Diagnostics...');
            appendSiteDiagnosticsLog('');
            setSiteDiagnosticsStatus('Running', 'active');
            
            // Update status badge
            const statusBadge = document.getElementById('siteCrawlerStatusBadge');
            if (statusBadge) {
                statusBadge.textContent = 'Running...';
                statusBadge.className = 'status-badge';
                statusBadge.style.background = 'var(--info)';
            }

            siteDiagnosticsResults = {
                functional: [],
                broken: [],
                hardcoded: [],
                connections: []
            };
            
            // Get inspection options
            const checkButtons = document.getElementById('siteCheckButtons')?.checked !== false;
            const checkSections = document.getElementById('siteCheckSections')?.checked !== false;
            const checkStorage = document.getElementById('siteCheckStorage')?.checked !== false;
            const checkConnections = document.getElementById('siteCheckConnections')?.checked !== false;
            
            const totalSteps = [checkButtons, checkSections, checkStorage, checkConnections].filter(Boolean).length + 2;
            let currentStep = 0;
            
            function updateProgress() {
                currentStep++;
                const pct = Math.round((currentStep / totalSteps) * 100);
                const progressBar = document.getElementById('siteCrawlerProgressBar');
                const progressText = document.getElementById('siteCrawlerProgress');
                if (progressBar) progressBar.style.width = pct + '%';
                if (progressText) progressText.textContent = pct + '%';
            }

            try {
                // 1. Analyze all buttons
                if (checkButtons && !siteAnalysisStopped) {
                    appendSiteDiagnosticsLog('');
                    appendSiteDiagnosticsLog(' Analyzing buttons and handlers...');
                    await analyzeButtons();
                    updateProgress();
                }

                // 2. Detect hardcoded values
                if (!siteAnalysisStopped) {
                    appendSiteDiagnosticsLog('');
                    appendSiteDiagnosticsLog(' Detecting hardcoded values...');
                    await detectHardcodedValues();
                    updateProgress();
                }

                // 3. Check connections
                if (checkConnections && !siteAnalysisStopped) {
                    appendSiteDiagnosticsLog('');
                    appendSiteDiagnosticsLog(' Checking connections...');
                    await checkConnectionsInternal();
                    updateProgress();
                }
                
                // Exit early if stopped
                if (siteAnalysisStopped) {
                    return;
                }

                // Update stats
                document.getElementById('siteFunctionalCount').textContent = siteDiagnosticsResults.functional.length;
                document.getElementById('siteBrokenCount').textContent = siteDiagnosticsResults.broken.length;
                document.getElementById('siteHardcodedCount').textContent = siteDiagnosticsResults.hardcoded.length;
                document.getElementById('siteConnectionsCount').textContent = siteDiagnosticsResults.connections.filter(c => c.status === 'ok').length;

                // Render results
                renderButtonAnalysis();
                renderHardcodedAnalysis();
                renderConnectionHealth();

                // Summary
                appendSiteDiagnosticsLog('');
                appendSiteDiagnosticsLog('');
                appendSiteDiagnosticsLog(' ANALYSIS COMPLETE');
                appendSiteDiagnosticsLog('');
                appendSiteDiagnosticsLog(` Functional: ${siteDiagnosticsResults.functional.length}`);
                appendSiteDiagnosticsLog(` Broken: ${siteDiagnosticsResults.broken.length}`);
                appendSiteDiagnosticsLog(` Hardcoded: ${siteDiagnosticsResults.hardcoded.length}`);
                appendSiteDiagnosticsLog(` Connections: ${siteDiagnosticsResults.connections.filter(c => c.status === 'ok').length}/${siteDiagnosticsResults.connections.length} OK`);

                if (siteDiagnosticsResults.broken.length === 0) {
                    setSiteDiagnosticsStatus('All Passed', 'active');
                    appendSiteDiagnosticsLog(' No broken handlers found!', 'success');
                } else {
                    setSiteDiagnosticsStatus(`${siteDiagnosticsResults.broken.length} Issues`, 'danger');
                }

                // Run extended diagnostics
                await runExtendedDiagnostics();

                // Save site crawler log to DynamoDB
                const endTime = Date.now();
                await saveSiteCrawlerLogToAWS(siteCrawlerStartTime, endTime - siteCrawlerStartTime);

            } catch (err) {
                appendSiteDiagnosticsLog(` Error: ${err.message}`, 'error');
                console.error('Site Diagnostics Error:', err);
                setSiteDiagnosticsStatus('Error', 'danger');
            } finally {
                // Reset button states
                siteAnalysisRunning = false;
                const runBtn = document.getElementById('runSiteAnalysisBtn');
                const stopBtn = document.getElementById('stopSiteAnalysisBtn');
                if (runBtn) runBtn.style.display = '';
                if (stopBtn) stopBtn.style.display = 'none';
            }
        }
        
        // Track site crawler start time
        let siteCrawlerStartTime = Date.now();
        let siteDiagnosticsLogEntries = [];
        
        // Save site crawler log to DynamoDB
        async function saveSiteCrawlerLogToAWS(startTime, duration) {
            try {
                const runId = new Date(startTime).toISOString();
                
                // Collect log entries from the log element
                const logEl = document.getElementById('siteDiagnosticsLog');
                const logText = logEl?.querySelector('pre')?.textContent || '';
                const logEntries = logText.split('\n').filter(line => line.trim()).map(line => ({
                    message: line,
                    timestamp: new Date().toISOString()
                }));
                
                const response = await fetch(`${AWS_API_URL}/crawler/logs`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        runId: runId,
                        source: 'site', // Site Diagnostics crawler
                        logs: logEntries,
                        summary: {
                            passed: siteDiagnosticsResults.functional.length,
                            failed: siteDiagnosticsResults.broken.length,
                            warnings: siteDiagnosticsResults.hardcoded.length,
                            connections: siteDiagnosticsResults.connections.filter(c => c.status === 'ok').length
                        },
                        duration: duration
                    })
                });
                
                if (response.ok) {
                    appendSiteDiagnosticsLog(' Site log saved to cloud', 'success');
                    // Refresh crawler log count in database schema
                    await syncDynamoDBSchema();
                } else {
                    console.log('Could not save site crawler log to AWS');
                }
            } catch (error) {
                console.log('Site crawler log save error:', error.message);
            }
        }

        async function analyzeButtons() {
            const buttons = document.querySelectorAll('button, .btn, [onclick]');
            let functional = 0, broken = 0, placeholder = 0;

            buttons.forEach(btn => {
                const onclick = btn.getAttribute('onclick');
                const text = btn.textContent?.trim() || btn.getAttribute('title') || 'Unnamed';
                
                if (!onclick) {
                    // No onclick - might use event listener
                    siteDiagnosticsResults.functional.push({
                        name: text.substring(0, 30),
                        handler: 'Event Listener',
                        status: 'functional'
                    });
                    functional++;
                    return;
                }

                // Extract function name from onclick
                const funcMatch = onclick.match(/^(\w+)\(/);
                if (funcMatch) {
                    const funcName = funcMatch[1];
                    
                    // Check if function exists
                    if (typeof window[funcName] === 'function') {
                        siteDiagnosticsResults.functional.push({
                            name: text.substring(0, 30),
                            handler: funcName,
                            status: 'functional'
                        });
                        functional++;
                    } else {
                        siteDiagnosticsResults.broken.push({
                            name: text.substring(0, 30),
                            handler: funcName,
                            status: 'broken',
                            reason: 'Function not defined'
                        });
                        broken++;
                        appendSiteDiagnosticsLog(`    ${text.substring(0, 20)}: ${funcName}() not defined`, 'error');
                    }
                } else {
                    // Complex onclick or inline code
                    siteDiagnosticsResults.functional.push({
                        name: text.substring(0, 30),
                        handler: 'Inline',
                        status: 'functional'
                    });
                    functional++;
                }
            });

            appendSiteDiagnosticsLog(`   Found ${buttons.length} buttons: ${functional} functional, ${broken} broken`);
        }

        async function detectHardcodedValues() {
            // Known hardcoded patterns to check
            const hardcodedChecks = [
                { id: 'subscription-price', selector: null, pattern: /\$\d+\.?\d*/, description: 'Subscription prices', location: 'JavaScript calculations' },
                { id: 'demo-data', selector: '.demo-data, [data-demo]', description: 'Demo/placeholder data', location: 'DOM elements' },
                { id: 'static-stats', selector: '.stat-value', description: 'Static statistics', location: 'Dashboard stats' }
            ];

            // Check for hardcoded strings in visible text that should be dynamic
            const potentialHardcoded = [];

            // Check subscription price references (skip config definitions)
            const scripts = document.querySelectorAll('script');
            scripts.forEach(script => {
                const content = script.textContent;
                // Look for hardcoded prices NOT in config objects
                // Skip if price is inside pricingConfig, oith_app_config, or pricing: { } blocks
                const hasLegacyPrice = (content.includes('14.99') || content.includes('9.99')) &&
                    !content.includes('pricingConfig') &&
                    !content.includes('oith_app_config') &&
                    !content.includes('pricing:');
                if (hasLegacyPrice) {
                    potentialHardcoded.push({
                        type: 'price',
                        value: 'Legacy price found',
                        location: 'Script block',
                        severity: 'warning',
                        suggestion: 'Use pricingConfig.subscriptionPrice instead'
                    });
                }
            });

            // Check for hardcoded user counts
            const statsWithNumbers = document.querySelectorAll('.stat-value');
            statsWithNumbers.forEach(stat => {
                const val = stat.textContent;
                if (val && !isNaN(val) && parseInt(val) > 1000) {
                    // Large numbers might be hardcoded demo data
                    const label = stat.parentElement?.querySelector('.stat-label')?.textContent || 'Unknown';
                    potentialHardcoded.push({
                        type: 'stat',
                        value: val,
                        location: label,
                        severity: 'info',
                        suggestion: 'Verify this is calculated from real data'
                    });
                }
            });

            // Check localStorage for config that should be used
            const configKeys = ['oith_admin_config', 'oith_app_config'];
            configKeys.forEach(key => {
                if (!localStorage.getItem(key)) {
                    potentialHardcoded.push({
                        type: 'config',
                        value: 'Missing',
                        location: key,
                        severity: 'info',
                        suggestion: 'Consider storing configuration in localStorage'
                    });
                }
            });

            siteDiagnosticsResults.hardcoded = potentialHardcoded;
            appendSiteDiagnosticsLog(`   Found ${potentialHardcoded.length} potential hardcoded values`);
        }

        async function checkConnectionsInternal() {
            const connections = [];

            // 1. Check localStorage connection
            try {
                localStorage.setItem('_test_connection', 'ok');
                localStorage.removeItem('_test_connection');
                connections.push({
                    name: 'localStorage',
                    type: 'storage',
                    status: 'ok',
                    description: 'Browser storage is accessible'
                });
                appendSiteDiagnosticsLog('    localStorage: Connected');
            } catch (e) {
                connections.push({
                    name: 'localStorage',
                    type: 'storage',
                    status: 'error',
                    description: 'Storage not accessible: ' + e.message
                });
                appendSiteDiagnosticsLog('    localStorage: ' + e.message, 'error');
            }

            // 2. Check BroadcastChannel
            try {
                const testChannel = new BroadcastChannel('oith_sync');
                testChannel.close();
                connections.push({
                    name: 'BroadcastChannel',
                    type: 'sync',
                    status: 'ok',
                    description: 'Real-time sync channel available'
                });
                appendSiteDiagnosticsLog('    BroadcastChannel: Available');
            } catch (e) {
                connections.push({
                    name: 'BroadcastChannel',
                    type: 'sync',
                    status: 'error',
                    description: 'Sync channel not available: ' + e.message
                });
                appendSiteDiagnosticsLog('    BroadcastChannel: ' + e.message, 'error');
            }

            // 3. Check data keys exist
            const requiredKeys = ['oith_registered_users', 'oith_platform_data'];
            requiredKeys.forEach(key => {
                const exists = localStorage.getItem(key) !== null;
                connections.push({
                    name: key,
                    type: 'data',
                    status: exists ? 'ok' : 'warning',
                    description: exists ? 'Data key exists' : 'Data key not found (may be empty)'
                });
                appendSiteDiagnosticsLog(`   ${exists ? '' : ''} ${key}: ${exists ? 'Found' : 'Not found'}`);
            });

            // 4. Check nav sections are renderable
            const sections = ['overview', 'dashboard', 'users', 'matches', 'diagnostics', 'site-diagnostics'];
            sections.forEach(section => {
                const sectionEl = document.getElementById(`${section}-section`);
                const renderFunc = window[`render${section.charAt(0).toUpperCase() + section.slice(1).replace(/-./g, x => x[1].toUpperCase())}`];
                
                connections.push({
                    name: section,
                    type: 'section',
                    status: sectionEl ? 'ok' : 'error',
                    description: sectionEl ? 'Section element exists' : 'Section element missing'
                });
            });

            // 5. Check AWS API endpoints for each admin section
            appendSiteDiagnosticsLog('');
            appendSiteDiagnosticsLog(' Checking AWS API endpoints...');
            const awsHealthResults = await checkAllAWSEndpoints();
            connections.push(...awsHealthResults);
            
            // 6. Check panel data health for each section
            appendSiteDiagnosticsLog('');
            appendSiteDiagnosticsLog(' Checking panel data health...');
            const panelHealthResults = await checkAllPanelDataHealth();
            connections.push(...panelHealthResults);

            siteDiagnosticsResults.connections = connections;
        }
        
        // Comprehensive AWS endpoint health checker
        async function checkAllAWSEndpoints() {
            const results = [];
            const apiUrl = window.AWS_API_URL || 'https://api.oith.app';
            
            // Define all AWS endpoints that admin sections depend on
            const awsEndpoints = [
                { name: 'Users API', endpoint: '/users', section: 'users', critical: true },
                { name: 'Matches API', endpoint: '/matches', section: 'matches', critical: true },
                { name: 'Analytics API', endpoint: '/analytics', section: 'analytics', critical: true },
                { name: 'Revenue API', endpoint: '/revenue', section: 'revenue', critical: true },
                { name: 'ML Settings API', endpoint: '/ml-settings', section: 'mlmodels', critical: false },
                { name: 'Calendar API', endpoint: '/calendar', section: 'calendar', critical: false },
                { name: 'Org Data API', endpoint: '/org-data', section: 'org-hierarchy', critical: false },
                { name: 'Payroll API', endpoint: '/payroll', section: 'payroll', critical: false },
                { name: 'Safety Reports API', endpoint: '/safety/reports', section: 'safety', critical: true },
                { name: 'Geographic API', endpoint: '/geographic', section: 'geographic', critical: false },
                { name: 'Activity Log API', endpoint: '/admin/activity-log', section: 'site-diagnostics', critical: false },
                { name: 'Crawler Logs API', endpoint: '/crawler/logs', section: 'diagnostics', critical: false },
                { name: 'DynamoDB Health', endpoint: '/health/dynamodb', section: 'database', critical: true },
                { name: 'Stripe Connection', endpoint: '/health/stripe', section: 'revenue', critical: true }
            ];
            
            // Store AWS health for real-time monitoring
            if (!window.awsEndpointHealth) {
                window.awsEndpointHealth = {};
            }
            
            for (const ep of awsEndpoints) {
                const startTime = Date.now();
                let status = 'error';
                let description = '';
                let latency = 0;
                
                try {
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 5000);
                    
                    const response = await fetch(`${apiUrl}${ep.endpoint}`, {
                        method: 'GET',
                        signal: controller.signal,
                        headers: { 'Content-Type': 'application/json' }
                    });
                    
                    clearTimeout(timeoutId);
                    latency = Date.now() - startTime;
                    
                    if (response.ok) {
                        status = 'ok';
                        description = `Connected (${latency}ms)`;
                        appendSiteDiagnosticsLog(`    ${ep.name}: ${latency}ms`);
                    } else if (response.status === 404) {
                        status = 'warning';
                        description = `Endpoint not configured (404)`;
                        appendSiteDiagnosticsLog(`    ${ep.name}: Not configured (404)`, 'warn');
                    } else if (response.status === 401 || response.status === 403) {
                        status = 'warning';
                        description = `Auth required (${response.status})`;
                        appendSiteDiagnosticsLog(`    ${ep.name}: Auth required`, 'warn');
                    } else {
                        status = 'error';
                        description = `Error: HTTP ${response.status}`;
                        appendSiteDiagnosticsLog(`    ${ep.name}: HTTP ${response.status}`, 'error');
                    }
                } catch (e) {
                    latency = Date.now() - startTime;
                    if (e.name === 'AbortError') {
                        status = 'error';
                        description = 'Timeout (>5s)';
                        appendSiteDiagnosticsLog(`    ${ep.name}: Timeout`, 'error');
                    } else if (e.message.includes('fetch')) {
                        status = 'error';
                        description = 'Network error - AWS unreachable';
                        appendSiteDiagnosticsLog(`    ${ep.name}: Network error`, 'error');
                    } else {
                        status = 'error';
                        description = e.message;
                        appendSiteDiagnosticsLog(`    ${ep.name}: ${e.message}`, 'error');
                    }
                }
                
                // Store for real-time monitoring
                window.awsEndpointHealth[ep.name] = {
                    status,
                    latency,
                    lastChecked: new Date().toISOString(),
                    section: ep.section,
                    critical: ep.critical
                };
                
                results.push({
                    name: ep.name,
                    type: 'aws-api',
                    status: status,
                    description: description,
                    section: ep.section,
                    critical: ep.critical,
                    latency: latency
                });
                
                // Update section health based on AWS status
                if (status === 'error' && ep.critical) {
                    trackApiCall(ep.section, startTime, false, new Error(description));
                }
            }
            
            return results;
        }
        
        // Check panel data health across all sections
        async function checkAllPanelDataHealth() {
            const results = [];
            
            // Define panels and their expected data elements for each section
            const panelChecks = {
                'dashboard': [
                    { id: 'dashTotalUsers', name: 'Total Users', minValid: 0 },
                    { id: 'dashActiveUsers', name: 'Active Users', minValid: 0 },
                    { id: 'dashPremiumUsers', name: 'Premium Users', minValid: 0 },
                    { id: 'dashTotalMatches', name: 'Total Matches', minValid: 0 }
                ],
                'revenue': [
                    { id: 'mrrValue', name: 'MRR', allowZero: true },
                    { id: 'premiumUsers', name: 'Premium Subscribers', allowZero: true },
                    { id: 'conversionRate', name: 'Conversion Rate', allowZero: true },
                    { id: 'churnRate', name: 'Churn Rate', allowZero: true }
                ],
                'users': [
                    { id: 'userTotalCount', name: 'User Count', minValid: 0 },
                    { id: 'userActiveToday', name: 'Active Today', allowZero: true },
                    { id: 'userPremiumCount', name: 'Premium Count', allowZero: true }
                ],
                'matches': [
                    { id: 'matchTotalCount', name: 'Match Count', minValid: 0 },
                    { id: 'matchSuccessRate', name: 'Success Rate', allowZero: true }
                ],
                'safety': [
                    { id: 'pendingReportsCount', name: 'Pending Reports', allowZero: true },
                    { id: 'blockedUsersCount', name: 'Blocked Users', allowZero: true }
                ],
                'expenses': [
                    { id: 'totalExpensesToDate', name: 'Total Expenses', allowZero: false },
                    { id: 'monthlyBurn', name: 'Monthly Burn', allowZero: false }
                ]
            };
            
            // Invalid data patterns
            const invalidPatterns = ['--', '...', 'Loading...', 'N/A', 'Error', 'undefined', 'null', '$--', 'NaN'];
            
            for (const [section, panels] of Object.entries(panelChecks)) {
                let sectionErrors = 0;
                let sectionWarnings = 0;
                
                for (const panel of panels) {
                    const el = document.getElementById(panel.id);
                    let status = 'ok';
                    let description = '';
                    
                    if (!el) {
                        status = 'warning';
                        description = 'Panel element not found';
                        sectionWarnings++;
                    } else {
                        const value = el.textContent?.trim() || '';
                        
                        // Check for invalid patterns
                        const isInvalid = invalidPatterns.some(p => value.includes(p));
                        const isEmpty = value === '' || value === '0' && !panel.allowZero;
                        
                        if (isInvalid) {
                            status = 'error';
                            description = `Invalid data: "${value}"`;
                            sectionErrors++;
                            appendSiteDiagnosticsLog(`    ${section}/${panel.name}: Invalid data "${value}"`, 'error');
                        } else if (isEmpty && !panel.allowZero) {
                            status = 'warning';
                            description = `Empty or zero value`;
                            sectionWarnings++;
                            appendSiteDiagnosticsLog(`    ${section}/${panel.name}: Empty value`, 'warn');
                        } else {
                            description = `Value: ${value.substring(0, 20)}${value.length > 20 ? '...' : ''}`;
                        }
                    }
                    
                    results.push({
                        name: `${section}/${panel.name}`,
                        type: 'panel-data',
                        status: status,
                        description: description,
                        section: section
                    });
                }
                
                // Update section health indicator
                if (sectionErrors > 0) {
                    updateNavHealthIndicator(section, 'red', `${sectionErrors} data errors`);
                } else if (sectionWarnings > 0) {
                    updateNavHealthIndicator(section, 'yellow', `${sectionWarnings} warnings`);
                } else {
                    updateNavHealthIndicator(section, 'green', 'Healthy');
                }
            }
            
            return results;
        }
        
        // Update nav health indicator
        function updateNavHealthIndicator(section, status, message) {
            const indicator = document.getElementById(`health-${section}`);
            if (indicator) {
                indicator.className = `health-indicator visible ${status}`;
                indicator.title = message;
            }
            
            // Also update sectionHealthMetrics
            if (sectionHealthMetrics[section]) {
                sectionHealthMetrics[section].status = status;
                sectionHealthMetrics[section].message = message;
            }
        }
        
        // Real-time data freshness checker
        function checkRealtimeDataFreshness() {
            const realtimeSections = ['dashboard', 'analytics', 'matches', 'safety'];
            const staleThreshold = 120000; // 2 minutes
            const warningThreshold = 60000; // 1 minute
            
            const results = [];
            
            realtimeSections.forEach(section => {
                const metrics = sectionHealthMetrics[section];
                if (!metrics) return;
                
                const now = Date.now();
                const lastUpdate = metrics.lastUpdated || 0;
                const staleness = now - lastUpdate;
                
                let status = 'ok';
                let description = '';
                
                if (lastUpdate === 0) {
                    status = 'error';
                    description = 'Never updated - no data received';
                } else if (staleness > staleThreshold) {
                    status = 'error';
                    description = `Data stale: ${Math.round(staleness / 1000)}s ago`;
                } else if (staleness > warningThreshold) {
                    status = 'warning';
                    description = `Data aging: ${Math.round(staleness / 1000)}s ago`;
                } else {
                    description = `Fresh: ${Math.round(staleness / 1000)}s ago`;
                }
                
                results.push({
                    name: `${section} (realtime)`,
                    type: 'realtime-freshness',
                    status: status,
                    description: description,
                    section: section
                });
                
                // Update indicator
                if (status !== 'ok') {
                    updateNavHealthIndicator(section, status, description);
                }
            });
            
            return results;
        }
        
        // ============================================
        // HEALTH MONITOR DASHBOARD
        // ============================================
        
        let healthMonitorRunning = false;
        let lastHealthCheckResults = { aws: [], panels: [], freshness: [] };
        
        // Run comprehensive health monitor check
        async function runHealthMonitorCheck() {
            if (healthMonitorRunning) return;
            healthMonitorRunning = true;
            
            const statusBadge = document.getElementById('awsHealthStatus');
            if (statusBadge) {
                statusBadge.textContent = 'Checking...';
                statusBadge.style.background = 'var(--info)';
            }
            
            try {
                // Run all health checks
                appendSiteDiagnosticsLog('');
                appendSiteDiagnosticsLog(' Running Health Monitor Check...');
                
                // Check AWS endpoints
                const awsResults = await checkAllAWSEndpoints();
                lastHealthCheckResults.aws = awsResults;
                
                // Check panel data
                const panelResults = await checkAllPanelDataHealth();
                lastHealthCheckResults.panels = panelResults;
                
                // Check real-time data freshness
                const freshnessResults = checkRealtimeDataFreshness();
                lastHealthCheckResults.freshness = freshnessResults;
                
                // Render results
                renderHealthMonitorDashboard();
                
                // Update status badge
                const awsErrors = awsResults.filter(r => r.status === 'error').length;
                const panelErrors = panelResults.filter(r => r.status === 'error').length;
                const totalErrors = awsErrors + panelErrors;
                
                if (totalErrors === 0) {
                    statusBadge.textContent = 'All Healthy';
                    statusBadge.style.background = 'var(--success)';
                } else {
                    statusBadge.textContent = `${totalErrors} Error${totalErrors > 1 ? 's' : ''}`;
                    statusBadge.style.background = 'var(--danger)';
                }
                
                // Log critical errors to activity log
                const criticalAwsErrors = awsResults.filter(r => r.status === 'error' && r.critical);
                criticalAwsErrors.forEach(err => {
                    logAdminActivity('sync', `AWS Error: ${err.name}`, err.description, { section: err.section, critical: true });
                });
                
                // Log panel data errors
                const criticalPanelErrors = panelResults.filter(r => r.status === 'error');
                if (criticalPanelErrors.length > 0) {
                    const sections = [...new Set(criticalPanelErrors.map(e => e.section))];
                    logAdminActivity('config', `Panel Data Error: ${criticalPanelErrors.length} panels invalid`, 
                        `Affected sections: ${sections.join(', ')}`, { count: criticalPanelErrors.length });
                }
                
                // Log stale data warnings
                const staleDataIssues = freshnessResults.filter(r => r.status === 'error');
                if (staleDataIssues.length > 0) {
                    logAdminActivity('config', 'Stale Data Warning', 
                        `${staleDataIssues.length} sections have stale real-time data`, { count: staleDataIssues.length });
                }
                
                appendSiteDiagnosticsLog(` Health check complete: ${awsErrors} AWS errors, ${panelErrors} panel errors`);
                
            } catch (e) {
                console.error('Health monitor error:', e);
                if (statusBadge) {
                    statusBadge.textContent = 'Error';
                    statusBadge.style.background = 'var(--danger)';
                }
            } finally {
                healthMonitorRunning = false;
            }
        }
        
        // Render health monitor dashboard
        function renderHealthMonitorDashboard() {
            const awsResults = lastHealthCheckResults.aws || [];
            const panelResults = lastHealthCheckResults.panels || [];
            const freshnessResults = lastHealthCheckResults.freshness || [];
            
            // Update summary stats
            const awsOk = awsResults.filter(r => r.status === 'ok').length;
            const awsErrors = awsResults.filter(r => r.status === 'error').length;
            const panelsOk = panelResults.filter(r => r.status === 'ok').length;
            const panelErrors = panelResults.filter(r => r.status === 'error').length;
            const staleCount = freshnessResults.filter(r => r.status !== 'ok').length;
            
            document.getElementById('healthAwsOk').textContent = awsOk;
            document.getElementById('healthAwsErrors').textContent = awsErrors;
            document.getElementById('healthPanelsOk').textContent = panelsOk;
            document.getElementById('healthPanelErrors').textContent = panelErrors;
            document.getElementById('healthStaleData').textContent = staleCount;
            document.getElementById('awsLastChecked').textContent = `Last checked: ${new Date().toLocaleTimeString()}`;
            
            // Render AWS endpoints grid
            renderAWSEndpointsGrid(awsResults);
            
            // Render panel health grid
            renderPanelHealthGrid(panelResults);
            
            // Render critical errors
            renderCriticalErrors(awsResults, panelResults, freshnessResults);
        }
        
        // Render AWS endpoints grid
        function renderAWSEndpointsGrid(results) {
            const container = document.getElementById('awsEndpointsGrid');
            if (!container) return;
            
            if (results.length === 0) {
                container.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--text-muted);">No AWS endpoints checked yet.</div>';
                return;
            }
            
            container.innerHTML = results.map(r => {
                const statusColor = r.status === 'ok' ? 'var(--success)' : r.status === 'warning' ? 'var(--warning)' : 'var(--danger)';
                const statusIcon = r.status === 'ok' ? '' : r.status === 'warning' ? '' : '';
                const criticalBadge = r.critical ? '<span style="font-size: 0.6rem; background: var(--danger); color: white; padding: 2px 6px; border-radius: 4px; margin-left: 6px;">CRITICAL</span>' : '';
                const latencyText = r.latency ? `${r.latency}ms` : '';
                
                return `
                    <div style="padding: 12px; background: var(--bg-tertiary); border-radius: 8px; border-left: 3px solid ${statusColor};">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                            <span style="font-weight: 500; font-size: 0.85rem;">${statusIcon} ${r.name}${criticalBadge}</span>
                            <span style="font-size: 0.7rem; color: var(--text-muted);">${latencyText}</span>
                        </div>
                        <div style="font-size: 0.75rem; color: ${statusColor};">${r.description}</div>
                        <div style="font-size: 0.65rem; color: var(--text-muted); margin-top: 4px;">Section: ${r.section || 'global'}</div>
                    </div>
                `;
            }).join('');
        }
        
        // Render panel health grid grouped by section
        function renderPanelHealthGrid(results) {
            const container = document.getElementById('panelHealthGrid');
            if (!container) return;
            
            if (results.length === 0) {
                container.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--text-muted);">No panel data checked yet.</div>';
                return;
            }
            
            // Group by section
            const bySection = {};
            results.forEach(r => {
                const section = r.section || 'unknown';
                if (!bySection[section]) bySection[section] = [];
                bySection[section].push(r);
            });
            
            container.innerHTML = Object.entries(bySection).map(([section, panels]) => {
                const errors = panels.filter(p => p.status === 'error').length;
                const warnings = panels.filter(p => p.status === 'warning').length;
                const ok = panels.filter(p => p.status === 'ok').length;
                
                const overallStatus = errors > 0 ? 'error' : warnings > 0 ? 'warning' : 'ok';
                const statusColor = overallStatus === 'ok' ? 'var(--success)' : overallStatus === 'warning' ? 'var(--warning)' : 'var(--danger)';
                const statusIcon = overallStatus === 'ok' ? '' : overallStatus === 'warning' ? '' : '';
                
                const panelDetails = panels.map(p => {
                    const pIcon = p.status === 'ok' ? '' : p.status === 'warning' ? '!' : '';
                    const pColor = p.status === 'ok' ? 'var(--success)' : p.status === 'warning' ? 'var(--warning)' : 'var(--danger)';
                    const panelName = p.name.split('/')[1] || p.name;
                    return `<span style="font-size: 0.7rem; color: ${pColor}; margin-right: 8px;" title="${p.description}">${pIcon} ${panelName}</span>`;
                }).join('');
                
                return `
                    <div style="padding: 12px; background: var(--bg-tertiary); border-radius: 8px; border-left: 3px solid ${statusColor};">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <span style="font-weight: 600; font-size: 0.85rem; text-transform: capitalize;">${statusIcon} ${section}</span>
                            <span style="font-size: 0.7rem; color: var(--text-muted);">${ok}/${panels.length} OK</span>
                        </div>
                        <div style="display: flex; flex-wrap: wrap; gap: 4px;">
                            ${panelDetails}
                        </div>
                        ${errors > 0 ? `<div style="font-size: 0.7rem; color: var(--danger); margin-top: 8px;"> ${errors} panel${errors > 1 ? 's' : ''} showing invalid data</div>` : ''}
                    </div>
                `;
            }).join('');
        }
        
        // Render critical errors list
        function renderCriticalErrors(awsResults, panelResults, freshnessResults) {
            const container = document.getElementById('criticalErrorsList');
            const section = document.getElementById('criticalErrorsSection');
            if (!container || !section) return;
            
            const criticalErrors = [
                ...awsResults.filter(r => r.status === 'error' && r.critical).map(r => ({
                    type: 'AWS',
                    name: r.name,
                    description: r.description,
                    section: r.section
                })),
                ...panelResults.filter(r => r.status === 'error').map(r => ({
                    type: 'Panel',
                    name: r.name,
                    description: r.description,
                    section: r.section
                })),
                ...freshnessResults.filter(r => r.status === 'error').map(r => ({
                    type: 'Realtime',
                    name: r.name,
                    description: r.description,
                    section: r.section
                }))
            ];
            
            if (criticalErrors.length === 0) {
                section.style.display = 'none';
                return;
            }
            
            section.style.display = 'block';
            container.innerHTML = criticalErrors.map(err => `
                <div style="padding: 10px 14px; background: rgba(239, 68, 68, 0.1); border-radius: 6px; border-left: 3px solid var(--danger);">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-weight: 500; font-size: 0.85rem; color: var(--danger);"> ${err.type}: ${err.name}</span>
                        <span style="font-size: 0.7rem; background: var(--bg-secondary); padding: 2px 8px; border-radius: 4px;">${err.section}</span>
                    </div>
                    <div style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 4px;">${err.description}</div>
                </div>
            `).join('');
        }
        
        // Auto-run health check when site diagnostics section is shown
        function onSiteDiagnosticsShown() {
            // Check if health monitor hasn't been run yet
            if (lastHealthCheckResults.aws.length === 0) {
                runHealthMonitorCheck();
            }
        }

        function renderButtonAnalysis() {
            const container = document.getElementById('buttonAnalysisList');
            if (!container) return;

            const all = [...siteDiagnosticsResults.functional, ...siteDiagnosticsResults.broken];
            
            if (all.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: var(--text-muted); padding: 40px; grid-column: 1/-1;">No buttons analyzed yet.</div>';
                return;
            }

            let html = '';
            all.slice(0, 50).forEach(btn => {
                const color = btn.status === 'functional' ? 'var(--success)' : btn.status === 'broken' ? 'var(--danger)' : 'var(--warning)';
                const icon = btn.status === 'functional' ? '' : btn.status === 'broken' ? '' : '';
                
                html += `
                    <div style="padding: 12px; background: var(--bg-tertiary); border-radius: 8px; border-left: 3px solid ${color};">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-weight: 500; font-size: 0.85rem;">${icon} ${btn.name}</span>
                        </div>
                        <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 4px;">
                            Handler: <code style="background: var(--bg-secondary); padding: 2px 6px; border-radius: 4px;">${btn.handler}</code>
                        </div>
                        ${btn.reason ? `<div style="font-size: 0.75rem; color: var(--danger); margin-top: 4px;">${btn.reason}</div>` : ''}
                    </div>
                `;
            });

            if (all.length > 50) {
                html += `<div style="text-align: center; color: var(--text-muted); padding: 12px; grid-column: 1/-1;">...and ${all.length - 50} more</div>`;
            }

            container.innerHTML = html;

            // Auto-expand if there are broken buttons
            if (siteDiagnosticsResults.broken.length > 0) {
                document.getElementById('buttonAnalysisBody').style.display = 'block';
                document.getElementById('buttonAnalysisToggle').style.transform = 'rotate(180deg)';
            }
        }

        function renderHardcodedAnalysis() {
            const container = document.getElementById('hardcodedAnalysisList');
            if (!container) return;

            const items = siteDiagnosticsResults.hardcoded;
            
            if (items.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: var(--success); padding: 40px;"> No hardcoded values detected!</div>';
                return;
            }

            let html = '';
            items.forEach(item => {
                const color = item.severity === 'warning' ? 'var(--warning)' : item.severity === 'error' ? 'var(--danger)' : 'var(--info)';
                const icon = item.severity === 'warning' ? '' : item.severity === 'error' ? '' : '';
                
                html += `
                    <div style="padding: 12px; background: var(--bg-tertiary); border-radius: 8px; border-left: 3px solid ${color};">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-weight: 500; font-size: 0.85rem;">${icon} ${item.type}</span>
                            <span style="font-size: 0.75rem; color: var(--text-muted);">${item.location}</span>
                        </div>
                        <div style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 4px;">
                            Value: <code style="background: var(--bg-secondary); padding: 2px 6px; border-radius: 4px;">${item.value}</code>
                        </div>
                        <div style="font-size: 0.75rem; color: var(--info); margin-top: 4px;"> ${item.suggestion}</div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function renderConnectionHealth() {
            const container = document.getElementById('connectionHealthList');
            if (!container) return;

            const connections = siteDiagnosticsResults.connections;
            
            if (connections.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: var(--text-muted); padding: 40px;">No connections analyzed yet.</div>';
                return;
            }

            let html = '';
            connections.forEach(conn => {
                const color = conn.status === 'ok' ? 'var(--success)' : conn.status === 'warning' ? 'var(--warning)' : 'var(--danger)';
                const icon = conn.status === 'ok' ? '' : conn.status === 'warning' ? '' : '';
                
                html += `
                    <div style="padding: 12px; background: var(--bg-tertiary); border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <span style="font-weight: 500; font-size: 0.85rem;">${icon} ${conn.name}</span>
                            <span style="font-size: 0.7rem; color: var(--text-muted); margin-left: 8px; text-transform: uppercase;">${conn.type}</span>
                        </div>
                        <div style="font-size: 0.8rem; color: ${color};">${conn.description}</div>
                    </div>
                `;
            });

            container.innerHTML = html;

            // Auto-expand if there are issues
            if (connections.some(c => c.status !== 'ok')) {
                document.getElementById('connectionHealthBody').style.display = 'block';
                document.getElementById('connectionHealthToggle').style.transform = 'rotate(180deg)';
            }
        }

        // Index Configuration Functions
        function loadIndexConfig() {
            const config = JSON.parse(localStorage.getItem('oith_index_config') || '{}');
            
            if (config.appName) document.getElementById('configAppName').value = config.appName;
            if (config.tagline) document.getElementById('configTagline').value = config.tagline;
            if (config.subscriptionPrice) document.getElementById('configSubPrice').value = config.subscriptionPrice;
            
            document.getElementById('configEnableMatching').checked = config.enableMatching !== false;
            document.getElementById('configEnableChat').checked = config.enableChat !== false;
            document.getElementById('configEnableDatePlanning').checked = config.enableDatePlanning !== false;
            document.getElementById('configMaintenanceMode').checked = config.maintenanceMode === true;

            // Update last sync time
            if (config.lastSync) {
                document.getElementById('lastSyncTime').textContent = new Date(config.lastSync).toLocaleString();
            }
        }

        function updateIndexConfig(key, value) {
            const config = JSON.parse(localStorage.getItem('oith_index_config') || '{}');
            config[key] = value;
            config.lastModified = new Date().toISOString();
            localStorage.setItem('oith_index_config', JSON.stringify(config));
            
            appendSiteDiagnosticsLog(` Config updated: ${key} = ${value}`);
        }

        function syncConfigToIndex() {
            const config = JSON.parse(localStorage.getItem('oith_index_config') || '{}');
            config.lastSync = new Date().toISOString();
            localStorage.setItem('oith_index_config', JSON.stringify(config));

            // Send to index via BroadcastChannel
            try {
                const channel = new BroadcastChannel('oith_sync');
                channel.postMessage({
                    type: 'config_update',
                    config: config
                });
                
                document.getElementById('lastSyncTime').textContent = new Date().toLocaleString();
                appendSiteDiagnosticsLog(' Configuration synced to Index app', 'success');
            } catch (e) {
                appendSiteDiagnosticsLog(' Failed to sync: ' + e.message, 'error');
            }
        }

        function checkIndexConnection() {
            const statusEl = document.getElementById('indexConnectionStatus');
            
            try {
                const channel = new BroadcastChannel('oith_sync');
                
                // Send ping
                channel.postMessage({ type: 'ping', from: 'admin' });
                
                // Listen for pong
                let received = false;
                channel.onmessage = (event) => {
                    if (event.data && event.data.type === 'pong') {
                        received = true;
                        statusEl.textContent = 'CONNECTED';
                        statusEl.style.background = 'var(--success)';
                    }
                };

                // Timeout check
                setTimeout(() => {
                    if (!received) {
                        statusEl.textContent = 'INDEX OFFLINE';
                        statusEl.style.background = 'var(--warning)';
                    }
                    channel.close();
                }, 2000);

            } catch (e) {
                statusEl.textContent = 'ERROR';
                statusEl.style.background = 'var(--danger)';
            }
        }

        function pushAllDataToIndex() {
            try {
                const channel = new BroadcastChannel('oith_sync');
                
                // Gather all data
                const data = {
                    users: JSON.parse(localStorage.getItem('oith_registered_users') || '[]'),
                    userData: {},
                    config: JSON.parse(localStorage.getItem('oith_index_config') || '{}'),
                    testBots: JSON.parse(localStorage.getItem('oith_test_bots') || '[]')
                };

                // Get all user data
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key.startsWith('oith_user_')) {
                        data.userData[key] = JSON.parse(localStorage.getItem(key));
                    }
                }

                channel.postMessage({
                    type: 'full_data_sync',
                    data: data,
                    timestamp: new Date().toISOString()
                });

                appendSiteDiagnosticsLog(' All data pushed to Index app', 'success');
            } catch (e) {
                appendSiteDiagnosticsLog(' Push failed: ' + e.message, 'error');
            }
        }

        function pullDataFromIndex() {
            try {
                const channel = new BroadcastChannel('oith_sync');
                
                channel.postMessage({
                    type: 'request_data',
                    from: 'admin'
                });

                channel.onmessage = (event) => {
                    if (event.data && event.data.type === 'data_response') {
                        // Store received data
                        if (event.data.currentUser) {
                            const email = event.data.currentUser.email;
                            localStorage.setItem(`oith_user_${email}`, JSON.stringify(event.data.userData));
                            appendSiteDiagnosticsLog(` Received data for user: ${email}`, 'success');
                        }
                    }
                };

                appendSiteDiagnosticsLog(' Requested data from Index app...');

                setTimeout(() => channel.close(), 5000);
            } catch (e) {
                appendSiteDiagnosticsLog(' Pull failed: ' + e.message, 'error');
            }
        }

        function resetIndexToDefaults() {
            if (!confirm('Are you sure you want to reset Index app to defaults? This will clear all user data in the Index app.')) {
                return;
            }

            try {
                const channel = new BroadcastChannel('oith_sync');
                
                channel.postMessage({
                    type: 'reset_to_defaults',
                    from: 'admin',
                    timestamp: new Date().toISOString()
                });

                appendSiteDiagnosticsLog(' Reset command sent to Index app', 'warn');
            } catch (e) {
                appendSiteDiagnosticsLog(' Reset failed: ' + e.message, 'error');
            }
        }

        function exportSiteDiagnosticsReport() {
            const report = {
                timestamp: new Date().toISOString(),
                summary: {
                    functional: siteDiagnosticsResults.functional.length,
                    broken: siteDiagnosticsResults.broken.length,
                    hardcoded: siteDiagnosticsResults.hardcoded.length,
                    connections: siteDiagnosticsResults.connections.filter(c => c.status === 'ok').length
                },
                details: siteDiagnosticsResults
            };

            const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `site-diagnostics-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            appendSiteDiagnosticsLog(' Report exported', 'success');
        }

        // ============================================
        // ADMIN ACTIVITY LOG SYSTEM
        // ============================================
        
        // Activity log storage
        let adminActivityLog = [];
        const ACTIVITY_LOG_STORAGE_KEY = 'oith_admin_activity_log';
        const ACTIVITY_LOG_MAX_ENTRIES = 500;
        let activityLogCurrentFilter = 'all';
        let activityLogSessionStart = new Date().toISOString();
        
        // Activity types and their icons
        const ACTIVITY_TYPES = {
            user: { icon: '', label: 'User Action' },
            file: { icon: '', label: 'File Operation' },
            event: { icon: '', label: 'Calendar Event' },
            config: { icon: '', label: 'Configuration' },
            sync: { icon: '', label: 'AWS Sync' },
            delete: { icon: '', label: 'Deletion' },
            create: { icon: '', label: 'Creation' }
        };
        
        // Initialize activity log on page load
        function initializeActivityLog() {
            // Load from localStorage
            const saved = localStorage.getItem(ACTIVITY_LOG_STORAGE_KEY);
            if (saved) {
                try {
                    adminActivityLog = JSON.parse(saved);
                } catch (e) {
                    console.warn('Failed to parse activity log:', e);
                    adminActivityLog = [];
                }
            }
            
            // Update UI
            updateActivityLogUI();
            updateActivityLogStats();
            
            // Set session start time
            const sessionEl = document.getElementById('activityLogSessionStart');
            if (sessionEl) {
                sessionEl.textContent = new Date(activityLogSessionStart).toLocaleTimeString();
            }
            
            // Update admin info
            updateActivityLogAdminInfo();
            
            // Sync from AWS on init
            syncActivityLogFromAWS();
        }
        
        // Log an activity
        function logAdminActivity(type, action, target, details = {}) {
            const entry = {
                id: `act_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                type: type,
                action: action,
                target: target,
                details: details,
                timestamp: new Date().toISOString(),
                user: getCurrentAdminUser(),
                synced: false
            };
            
            // Add to beginning of array (newest first)
            adminActivityLog.unshift(entry);
            
            // Trim if exceeds max
            if (adminActivityLog.length > ACTIVITY_LOG_MAX_ENTRIES) {
                adminActivityLog = adminActivityLog.slice(0, ACTIVITY_LOG_MAX_ENTRIES);
            }
            
            // Save locally
            saveActivityLogLocally();
            
            // Update UI
            updateActivityLogUI();
            updateActivityLogStats();
            
            // Sync to AWS
            syncActivityToAWS(entry);
            
            return entry;
        }
        
        // Get current admin user info
        function getCurrentAdminUser() {
            // Try to get from stored session or default
            const storedAdmin = localStorage.getItem('oith_admin_user');
            if (storedAdmin) {
                try {
                    return JSON.parse(storedAdmin);
                } catch (e) {}
            }
            return {
                name: 'Admin User',
                email: 'admin@oith.app',
                id: 'admin_default'
            };
        }
        
        // Update admin info display
        function updateActivityLogAdminInfo() {
            const admin = getCurrentAdminUser();
            const avatarEl = document.getElementById('activityLogAdminAvatar');
            const nameEl = document.getElementById('activityLogAdminName');
            const emailEl = document.getElementById('activityLogAdminEmail');
            
            if (avatarEl) avatarEl.textContent = admin.name.charAt(0).toUpperCase();
            if (nameEl) nameEl.textContent = admin.name;
            if (emailEl) emailEl.textContent = admin.email;
        }
        
        // Save activity log to localStorage
        function saveActivityLogLocally() {
            try {
                localStorage.setItem(ACTIVITY_LOG_STORAGE_KEY, JSON.stringify(adminActivityLog));
            } catch (e) {
                console.warn('Failed to save activity log:', e);
            }
        }
        
        // Sync activity to AWS
        async function syncActivityToAWS(entry) {
            const statusEl = document.getElementById('activityLogSyncStatus');
            
            try {
                if (statusEl) {
                    statusEl.textContent = 'Syncing...';
                    statusEl.style.background = 'var(--warning)';
                }
                
                // Use the existing API endpoint pattern
                const apiUrl = window.API_BASE_URL || 'https://api.oith.app';
                
                const response = await fetch(`${apiUrl}/admin/activity-log`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(entry)
                });
                
                if (response.ok) {
                    entry.synced = true;
                    saveActivityLogLocally();
                    
                    if (statusEl) {
                        statusEl.textContent = 'Synced';
                        statusEl.style.background = 'var(--success)';
                    }
                    
                    // Update AWS sync indicators
                    updateAWSSyncTime('send');
                } else {
                    throw new Error('Sync failed');
                }
            } catch (e) {
                // Mark as pending sync
                entry.synced = false;
                saveActivityLogLocally();
                
                if (statusEl) {
                    statusEl.textContent = 'Pending';
                    statusEl.style.background = 'var(--warning)';
                }
                
                console.warn('Activity sync failed:', e);
            }
            
            updateActivityLogUI();
        }
        
        // Sync activity log from AWS
        async function syncActivityLogFromAWS() {
            const statusEl = document.getElementById('activityLogSyncStatus');
            
            try {
                if (statusEl) {
                    statusEl.textContent = 'Loading...';
                    statusEl.style.background = 'var(--info)';
                }
                
                const apiUrl = window.API_BASE_URL || 'https://api.oith.app';
                
                const response = await fetch(`${apiUrl}/admin/activity-log?limit=100`);
                
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.activities && Array.isArray(data.activities)) {
                        // Merge with local, avoiding duplicates
                        const existingIds = new Set(adminActivityLog.map(a => a.id));
                        const newActivities = data.activities.filter(a => !existingIds.has(a.id));
                        
                        adminActivityLog = [...adminActivityLog, ...newActivities]
                            .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
                            .slice(0, ACTIVITY_LOG_MAX_ENTRIES);
                        
                        // Mark all as synced
                        adminActivityLog.forEach(a => a.synced = true);
                        
                        saveActivityLogLocally();
                        updateActivityLogUI();
                        updateActivityLogStats();
                    }
                    
                    if (statusEl) {
                        statusEl.textContent = 'Synced';
                        statusEl.style.background = 'var(--success)';
                    }
                    
                    updateAWSSyncTime('receive');
                }
            } catch (e) {
                console.warn('Failed to sync activity log from AWS:', e);
                if (statusEl) {
                    statusEl.textContent = 'Offline';
                    statusEl.style.background = 'var(--text-muted)';
                }
            }
        }
        
        // Update AWS sync time indicator
        function updateAWSSyncTime(type) {
            const now = new Date().toLocaleTimeString();
            if (type === 'send') {
                const el = document.getElementById('awsLastSend');
                if (el) {
                    el.textContent = now;
                    el.className = 'aws-status success';
                }
            } else if (type === 'receive') {
                const el = document.getElementById('awsLastReceive');
                if (el) {
                    el.textContent = now;
                    el.className = 'aws-status success';
                }
            }
        }
        
        // Update activity log UI
        function updateActivityLogUI() {
            const container = document.getElementById('adminActivityLog');
            if (!container) return;
            
            // Filter activities
            const filteredActivities = activityLogCurrentFilter === 'all' 
                ? adminActivityLog 
                : adminActivityLog.filter(a => a.type === activityLogCurrentFilter);
            
            if (filteredActivities.length === 0) {
                container.innerHTML = `
                    <div class="activity-log-empty" style="padding: 40px; text-align: center; color: var(--text-muted);">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="margin-bottom: 12px; opacity: 0.5;">
                            <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/>
                            <path d="M14 2v6h6"/>
                            <path d="M16 13H8M16 17H8M10 9H8"/>
                        </svg>
                        <div style="font-size: 0.9rem; margin-bottom: 4px;">No activity logged yet</div>
                        <div style="font-size: 0.75rem;">Admin actions will appear here automatically</div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = filteredActivities.map(activity => {
                const typeInfo = ACTIVITY_TYPES[activity.type] || ACTIVITY_TYPES.config;
                const timestamp = new Date(activity.timestamp);
                const timeStr = timestamp.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                const dateStr = timestamp.toLocaleDateString([], { month: 'short', day: 'numeric' });
                const syncClass = activity.synced ? '' : 'pending';
                const syncText = activity.synced ? ' Synced' : ' Pending';
                
                return `
                    <div class="admin-activity-entry" data-activity-id="${activity.id}">
                        <div class="admin-activity-type-icon ${activity.type}">
                            ${typeInfo.icon}
                        </div>
                        <div class="admin-activity-details">
                            <div class="admin-activity-action">${escapeHtml(activity.action)}</div>
                            <div class="admin-activity-target">${escapeHtml(activity.target)}</div>
                        </div>
                        <div class="admin-activity-meta">
                            <div class="admin-activity-timestamp">${timeStr}</div>
                            <div style="font-size: 0.65rem;">${dateStr}</div>
                            <div class="admin-activity-user">
                                <span>${escapeHtml(activity.user?.name || 'Admin')}</span>
                            </div>
                            <span class="admin-activity-sync-badge ${syncClass}">${syncText}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Escape HTML helper
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Update activity stats
        function updateActivityLogStats() {
            const today = new Date().toDateString();
            
            const stats = {
                total: adminActivityLog.length,
                users: adminActivityLog.filter(a => a.type === 'user' || a.type === 'create').length,
                files: adminActivityLog.filter(a => a.type === 'file').length,
                events: adminActivityLog.filter(a => a.type === 'event').length,
                today: adminActivityLog.filter(a => new Date(a.timestamp).toDateString() === today).length
            };
            
            const el = (id, val) => {
                const elem = document.getElementById(id);
                if (elem) elem.textContent = val;
            };
            
            el('activityStatTotal', stats.total);
            el('activityStatUsers', stats.users);
            el('activityStatFiles', stats.files);
            el('activityStatEvents', stats.events);
            el('activityStatToday', stats.today);
        }
        
        // Filter activity log
        function filterActivityLog(filter) {
            activityLogCurrentFilter = filter;
            updateActivityLogUI();
        }
        
        // Refresh activity log
        function refreshActivityLog() {
            syncActivityLogFromAWS();
        }
        
        // Export activity log
        function exportActivityLog() {
            const data = {
                exportedAt: new Date().toISOString(),
                totalEntries: adminActivityLog.length,
                activities: adminActivityLog
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `admin-activity-log-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            logAdminActivity('file', 'Exported activity log', `${adminActivityLog.length} entries exported`);
        }
        
        // Clear activity log
        function clearActivityLog() {
            if (confirm('Are you sure you want to clear the activity log? This cannot be undone.')) {
                adminActivityLog = [];
                saveActivityLogLocally();
                updateActivityLogUI();
                updateActivityLogStats();
                
                // Also clear on AWS
                clearActivityLogOnAWS();
            }
        }
        
        // Clear activity log on AWS
        async function clearActivityLogOnAWS() {
            try {
                const apiUrl = window.API_BASE_URL || 'https://api.oith.app';
                await fetch(`${apiUrl}/admin/activity-log`, {
                    method: 'DELETE'
                });
            } catch (e) {
                console.warn('Failed to clear activity log on AWS:', e);
            }
        }
        
        // Retry pending syncs
        async function retryPendingSyncs() {
            const pendingActivities = adminActivityLog.filter(a => !a.synced);
            
            for (const activity of pendingActivities) {
                await syncActivityToAWS(activity);
            }
        }
        
        // Initialize on DOM ready
        document.addEventListener('DOMContentLoaded', function() {
            initializeActivityLog();
            
            // Retry pending syncs periodically
            setInterval(retryPendingSyncs, 60000); // Every minute
        });
        
        // ============================================
        // END ADMIN ACTIVITY LOG SYSTEM
        // ============================================

        // Console Error Monitoring
        let capturedConsoleErrors = [];
        
        // Override console.error to capture errors
        (function() {
            const originalError = console.error;
            console.error = function(...args) {
                capturedConsoleErrors.push({
                    timestamp: new Date().toISOString(),
                    message: args.map(arg => typeof arg === 'object' ? JSON.stringify(arg) : String(arg)).join(' '),
                    type: 'error'
                });
                originalError.apply(console, args);
            };
            
            // Also capture window errors
            window.addEventListener('error', function(event) {
                capturedConsoleErrors.push({
                    timestamp: new Date().toISOString(),
                    message: `${event.message} at ${event.filename}:${event.lineno}`,
                    type: 'error'
                });
            });
            
            // Capture unhandled promise rejections
            window.addEventListener('unhandledrejection', function(event) {
                capturedConsoleErrors.push({
                    timestamp: new Date().toISOString(),
                    message: `Unhandled Promise: ${event.reason}`,
                    type: 'promise'
                });
            });
        })();

        function refreshConsoleErrors() {
            renderConsoleErrors();
        }

        function clearConsoleErrors() {
            capturedConsoleErrors = [];
            renderConsoleErrors();
            appendSiteDiagnosticsLog(' Console errors cleared');
        }

        function renderConsoleErrors() {
            const container = document.getElementById('consoleErrorsList');
            const countBadge = document.getElementById('consoleErrorCount');
            
            if (!container) return;
            
            const errorCount = capturedConsoleErrors.length;
            
            if (countBadge) {
                countBadge.textContent = `${errorCount} error${errorCount !== 1 ? 's' : ''}`;
                countBadge.style.background = errorCount > 0 ? 'var(--danger)' : 'var(--success)';
            }
            
            // Update stat card
            const statEl = document.getElementById('siteConsoleErrors');
            if (statEl) {
                statEl.textContent = errorCount;
                const iconEl = statEl.parentElement.querySelector('.stat-icon');
                if (iconEl) {
                    iconEl.style.background = errorCount > 0 ? 'rgba(239, 68, 68, 0.3)' : 'rgba(16, 185, 129, 0.2)';
                    iconEl.style.color = errorCount > 0 ? 'var(--danger)' : 'var(--success)';
                }
            }
            
            if (errorCount === 0) {
                container.innerHTML = '<div style="text-align: center; color: var(--success); padding: 40px;"> No console errors detected this session</div>';
                return;
            }
            
            let html = '';
            capturedConsoleErrors.slice(-20).reverse().forEach(error => {
                const time = error.timestamp.split('T')[1].split('.')[0];
                html += `
                    <div style="padding: 10px 12px; background: var(--bg-tertiary); border-radius: 8px; border-left: 3px solid var(--danger);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                            <span style="font-size: 0.7rem; color: var(--text-muted);">${time}</span>
                            <span style="font-size: 0.65rem; padding: 2px 6px; background: rgba(239, 68, 68, 0.2); color: var(--danger); border-radius: 4px; text-transform: uppercase;">${error.type}</span>
                        </div>
                        <div style="font-size: 0.8rem; color: var(--danger); font-family: monospace; word-break: break-all;">${error.message}</div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            
            // Auto-expand if errors exist
            if (errorCount > 0) {
                document.getElementById('consoleErrorsBody').style.display = 'block';
                document.getElementById('consoleErrorsToggle').style.transform = 'rotate(180deg)';
            }
        }

        function analyzePerformance() {
            // Page Load Time
            if (window.performance && performance.timing) {
                const timing = performance.timing;
                const pageLoad = timing.loadEventEnd - timing.navigationStart;
                const domReady = timing.domContentLoadedEventEnd - timing.navigationStart;
                
                document.getElementById('perfPageLoad').textContent = pageLoad > 0 ? `${pageLoad}ms` : '--';
                document.getElementById('perfDomReady').textContent = domReady > 0 ? `${domReady}ms` : '--';
                
                // Color coding based on performance
                const pageLoadEl = document.getElementById('perfPageLoad');
                if (pageLoad > 3000) pageLoadEl.style.color = 'var(--danger)';
                else if (pageLoad > 1500) pageLoadEl.style.color = 'var(--warning)';
                else pageLoadEl.style.color = 'var(--success)';
            }
            
            // Memory (if available)
            if (performance.memory) {
                const usedMB = (performance.memory.usedJSHeapSize / 1024 / 1024).toFixed(1);
                document.getElementById('perfMemory').textContent = `${usedMB} MB`;
                
                const memoryEl = document.getElementById('perfMemory');
                if (parseFloat(usedMB) > 100) memoryEl.style.color = 'var(--danger)';
                else if (parseFloat(usedMB) > 50) memoryEl.style.color = 'var(--warning)';
                else memoryEl.style.color = 'var(--success)';
            } else {
                document.getElementById('perfMemory').textContent = 'N/A';
            }
            
            // DOM Nodes
            const domNodes = document.getElementsByTagName('*').length;
            document.getElementById('perfDomNodes').textContent = domNodes.toLocaleString();
            
            const domNodesEl = document.getElementById('perfDomNodes');
            if (domNodes > 5000) domNodesEl.style.color = 'var(--danger)';
            else if (domNodes > 2000) domNodesEl.style.color = 'var(--warning)';
            else domNodesEl.style.color = 'var(--success)';
            
            // Estimate event listeners (buttons with onclick + nav-items)
            const eventElements = document.querySelectorAll('[onclick], button, .nav-item, input, select');
            document.getElementById('perfEventListeners').textContent = eventElements.length.toLocaleString();
            
            // Storage used
            const storageUsed = calculateStorageSize();
            document.getElementById('perfStorage').textContent = formatBytes(storageUsed);
            
            appendSiteDiagnosticsLog(' Performance metrics collected');
        }

        function calculateStorageSize() {
            let total = 0;
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                const value = localStorage.getItem(key);
                total += key.length + value.length;
            }
            return total * 2; // UTF-16 = 2 bytes per character
        }

        function formatBytes(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / 1024 / 1024).toFixed(2) + ' MB';
        }

        function analyzeStorage() {
            const container = document.getElementById('storageAnalysisList');
            if (!container) return;
            
            const categories = {};
            let totalSize = 0;
            
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                const value = localStorage.getItem(key);
                const size = (key.length + value.length) * 2;
                totalSize += size;
                
                // Categorize by prefix
                let category = 'Other';
                if (key.startsWith('oith_user_')) category = 'User Data';
                else if (key.startsWith('oith_registered')) category = 'User Registry';
                else if (key.startsWith('oith_platform')) category = 'Platform Data';
                else if (key.startsWith('oith_test')) category = 'Test Data';
                else if (key.startsWith('oith_admin')) category = 'Admin Config';
                else if (key.startsWith('oith_index')) category = 'Index Config';
                else if (key.startsWith('oith_org')) category = 'Org Data';
                else if (key.startsWith('oith_payroll')) category = 'Payroll Data';
                else if (key.startsWith('oith_')) category = 'OITH Other';
                
                if (!categories[category]) {
                    categories[category] = { size: 0, keys: [] };
                }
                categories[category].size += size;
                categories[category].keys.push({ key, size });
            }
            
            // Sort by size
            const sorted = Object.entries(categories).sort((a, b) => b[1].size - a[1].size);
            
            let html = '';
            sorted.forEach(([category, data]) => {
                const percentage = totalSize > 0 ? ((data.size / totalSize) * 100).toFixed(1) : 0;
                const colorMap = {
                    'User Data': 'var(--accent)',
                    'User Registry': 'var(--purple)',
                    'Platform Data': 'var(--info)',
                    'Test Data': 'var(--warning)',
                    'Admin Config': 'var(--success)',
                    'Index Config': 'var(--info)',
                    'Org Data': 'var(--purple)',
                    'Payroll Data': 'var(--success)',
                    'OITH Other': 'var(--text-muted)',
                    'Other': 'var(--text-muted)'
                };
                const color = colorMap[category] || 'var(--text-muted)';
                
                html += `
                    <div style="padding: 12px; background: var(--bg-tertiary); border-radius: 8px; border-left: 3px solid ${color};">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-weight: 500; font-size: 0.9rem;">${category}</span>
                            <span style="font-size: 0.85rem; color: ${color}; font-weight: 600;">${formatBytes(data.size)}</span>
                        </div>
                        <div style="margin-top: 8px;">
                            <div style="height: 4px; background: var(--bg-secondary); border-radius: 2px; overflow: hidden;">
                                <div style="height: 100%; width: ${percentage}%; background: ${color};"></div>
                            </div>
                            <div style="display: flex; justify-content: space-between; font-size: 0.7rem; color: var(--text-muted); margin-top: 4px;">
                                <span>${data.keys.length} key${data.keys.length !== 1 ? 's' : ''}</span>
                                <span>${percentage}%</span>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html || '<div style="text-align: center; color: var(--text-muted); padding: 40px;">No data in localStorage</div>';
            
            // Update total display
            const maxStorage = 5 * 1024 * 1024; // 5MB
            const usedPercentage = ((totalSize / maxStorage) * 100).toFixed(1);
            
            document.getElementById('totalStorageUsed').textContent = `${formatBytes(totalSize)} / 5 MB (${usedPercentage}%)`;
            document.getElementById('storageProgressBar').style.width = `${Math.min(usedPercentage, 100)}%`;
            
            appendSiteDiagnosticsLog(` Storage analysis: ${formatBytes(totalSize)} used across ${localStorage.length} keys`);
        }

        function analyzeSectionHealth() {
            const container = document.getElementById('sectionHealthList');
            if (!container) return;
            
            const sections = [
                { id: 'overview', name: 'Overview', render: 'renderOverview' },
                { id: 'dashboard', name: 'Dashboard', render: 'renderDashboard' },
                { id: 'realtime', name: 'Real-time', render: 'renderRealtime' },
                { id: 'analytics', name: 'Analytics', render: 'renderAnalytics' },
                { id: 'mlmodels', name: 'ML Models', render: 'renderMLModels' },
                { id: 'users', name: 'Users', render: 'renderUsers' },
                { id: 'matches', name: 'Matches', render: 'renderMatches' },
                { id: 'funnel', name: 'Funnel', render: 'renderFunnel' },
                { id: 'revenue', name: 'Revenue', render: 'renderRevenue' },
                { id: 'geographic', name: 'Geographic', render: 'renderGeographic' },
                { id: 'safety', name: 'Safety', render: 'renderSafety' },
                { id: 'feedback', name: 'Feedback', render: 'renderFeedback' },
                { id: 'testbots', name: 'Test Bots', render: 'renderTestBots' },
                { id: 'legal', name: 'Legal', render: 'renderLegal' },
                { id: 'compliance', name: 'Compliance', render: 'renderCompliance' },
                { id: 'database', name: 'Database', render: 'renderDatabase' },
                { id: 'experiments', name: 'Experiments', render: 'renderExperiments' },
                { id: 'org-hierarchy', name: 'Org Hierarchy', render: 'renderOrgHierarchy' },
                { id: 'payroll', name: 'Payroll', render: 'renderPayroll' },
                { id: 'diagnostics', name: 'App Diagnostics', render: 'renderDiagnostics' },
                { id: 'site-diagnostics', name: 'Site Diagnostics', render: 'renderSiteDiagnostics' }
            ];
            
            let html = '';
            let healthyCount = 0;
            let issueCount = 0;
            
            sections.forEach(section => {
                const sectionEl = document.getElementById(`${section.id}-section`);
                const renderFunc = window[section.render];
                
                const hasElement = !!sectionEl;
                const hasRender = typeof renderFunc === 'function';
                const status = hasElement && hasRender ? 'ok' : !hasElement && !hasRender ? 'error' : 'warning';
                
                if (status === 'ok') healthyCount++;
                else issueCount++;
                
                const color = status === 'ok' ? 'var(--success)' : status === 'warning' ? 'var(--warning)' : 'var(--danger)';
                const icon = status === 'ok' ? '' : status === 'warning' ? '' : '';
                
                html += `
                    <div style="padding: 10px 12px; background: var(--bg-tertiary); border-radius: 8px; border-left: 3px solid ${color}; cursor: pointer;" onclick="showSection('${section.id}')">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span>${icon}</span>
                            <span style="font-weight: 500; font-size: 0.85rem;">${section.name}</span>
                        </div>
                        <div style="display: flex; gap: 12px; margin-top: 6px; font-size: 0.7rem;">
                            <span style="color: ${hasElement ? 'var(--success)' : 'var(--danger)'};">
                                ${hasElement ? '' : ''} Element
                            </span>
                            <span style="color: ${hasRender ? 'var(--success)' : 'var(--danger)'};">
                                ${hasRender ? '' : ''} Render
                            </span>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            
            // Update stat card
            const sectionsStatEl = document.getElementById('siteSectionsCount');
            if (sectionsStatEl) {
                sectionsStatEl.textContent = `${healthyCount}/${sections.length}`;
                sectionsStatEl.parentElement.querySelector('.stat-icon').style.color = 
                    healthyCount === sections.length ? 'var(--success)' : 
                    issueCount > 3 ? 'var(--danger)' : 'var(--warning)';
            }
            
            appendSiteDiagnosticsLog(` Section health: ${healthyCount}/${sections.length} sections healthy`);
        }

        // Extended diagnostics function
        async function runExtendedDiagnostics() {
            // Run additional diagnostics
            appendSiteDiagnosticsLog('');
            appendSiteDiagnosticsLog(' Running extended diagnostics...');
            
            // Section health
            appendSiteDiagnosticsLog('');
            appendSiteDiagnosticsLog(' Checking section health...');
            analyzeSectionHealth();
            
            // Console errors
            appendSiteDiagnosticsLog('');
            appendSiteDiagnosticsLog(' Checking console errors...');
            renderConsoleErrors();
            appendSiteDiagnosticsLog(`   Found ${capturedConsoleErrors.length} console error(s)`);
            
            // Performance
            appendSiteDiagnosticsLog('');
            appendSiteDiagnosticsLog(' Analyzing performance...');
            analyzePerformance();
            
            // Storage
            appendSiteDiagnosticsLog('');
            appendSiteDiagnosticsLog(' Analyzing storage...');
            analyzeStorage();
            
            // Run comprehensive health monitor
            appendSiteDiagnosticsLog('');
            appendSiteDiagnosticsLog(' Running health monitor...');
            await runHealthMonitorCheck();
            
            appendSiteDiagnosticsLog('');
            appendSiteDiagnosticsLog('');
            appendSiteDiagnosticsLog(' Extended diagnostics complete!', 'success');
            
            // Update live stats
            updateSiteCrawlerStats();
            
            // Show issues panel if there are issues
            showSiteIssuesPanel();
        }

        // Update live crawler stats in control panel
        function updateSiteCrawlerStats() {
            const passed = siteDiagnosticsResults.functional.length + 
                          siteDiagnosticsResults.connections.filter(c => c.status === 'ok').length;
            const failed = siteDiagnosticsResults.broken.length + 
                          siteDiagnosticsResults.connections.filter(c => c.status === 'error').length;
            const warnings = siteDiagnosticsResults.hardcoded.length + 
                            siteDiagnosticsResults.connections.filter(c => c.status === 'warning').length +
                            capturedConsoleErrors.length;
            
            document.getElementById('siteCrawlerPassed').textContent = passed;
            document.getElementById('siteCrawlerFailed').textContent = failed;
            document.getElementById('siteCrawlerWarnings').textContent = warnings;
            document.getElementById('siteCrawlerProgress').textContent = '100%';
            document.getElementById('siteCrawlerProgressBar').style.width = '100%';
            
            // Update status badge
            const statusBadge = document.getElementById('siteCrawlerStatusBadge');
            if (failed > 0) {
                statusBadge.textContent = `${failed} Failed`;
                statusBadge.className = 'status-badge danger';
            } else if (warnings > 0) {
                statusBadge.textContent = `${warnings} Warnings`;
                statusBadge.className = 'status-badge warning';
            } else {
                statusBadge.textContent = 'All Passed';
                statusBadge.className = 'status-badge success';
            }
        }

        // Show issues panel if there are issues
        function showSiteIssuesPanel() {
            const panel = document.getElementById('siteIssuesFoundPanel');
            const list = document.getElementById('siteIssuesList');
            const count = document.getElementById('siteIssuesCount');
            
            const allIssues = [
                ...siteDiagnosticsResults.broken.map(b => ({ type: 'error', category: 'Button', message: `${b.name}: ${b.reason}` })),
                ...siteDiagnosticsResults.connections.filter(c => c.status === 'error').map(c => ({ type: 'error', category: 'Connection', message: `${c.name}: ${c.description}` })),
                ...siteDiagnosticsResults.hardcoded.map(h => ({ type: 'warning', category: 'Hardcoded', message: `${h.type} in ${h.location}: ${h.value}` })),
                ...capturedConsoleErrors.map(e => ({ type: 'error', category: 'Console', message: e.message }))
            ];
            
            if (allIssues.length === 0) {
                panel.style.display = 'none';
                return;
            }
            
            panel.style.display = 'block';
            count.textContent = `${allIssues.length} Issue${allIssues.length !== 1 ? 's' : ''}`;
            
            let html = '';
            allIssues.forEach(issue => {
                const color = issue.type === 'error' ? 'var(--danger)' : 'var(--warning)';
                const icon = issue.type === 'error' ? '' : '';
                
                html += `
                    <div style="padding: 12px; background: var(--bg-tertiary); border-radius: 8px; border-left: 3px solid ${color};">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-weight: 500; font-size: 0.85rem;">${icon} ${issue.category}</span>
                            <span style="font-size: 0.7rem; padding: 2px 8px; background: ${color}20; color: ${color}; border-radius: 4px; text-transform: uppercase;">${issue.type}</span>
                        </div>
                        <div style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 6px; font-family: monospace;">
                            ${issue.message}
                        </div>
                    </div>
                `;
            });
            
            list.innerHTML = html;
            
            // Auto-expand if enabled
            if (document.getElementById('siteAutoExpand')?.checked) {
                panel.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        // Quick Action Functions
        function clearAllStorage() {
            if (!confirm('Are you sure you want to clear ALL localStorage data? This cannot be undone.')) return;
            
            const keysToRemove = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('oith_')) {
                    keysToRemove.push(key);
                }
            }
            
            keysToRemove.forEach(key => localStorage.removeItem(key));
            
            appendSiteDiagnosticsLog(` Cleared ${keysToRemove.length} OITH storage keys`, 'warn');
            runSiteDiagnostics();
        }

        function reloadAdminData() {
            appendSiteDiagnosticsLog(' Reloading admin data...');
            loadAllData();
            platformData = calculatePlatformStats();
            renderSiteDiagnostics();
            appendSiteDiagnosticsLog(' Admin data reloaded', 'success');
        }

        function testIndexConnection() {
            appendSiteDiagnosticsLog(' Testing Index app connection...');
            
            try {
                const channel = new BroadcastChannel('oith_sync');
                let responded = false;
                
                channel.postMessage({ type: 'ping', from: 'admin', timestamp: Date.now() });
                
                channel.onmessage = (event) => {
                    if (event.data?.type === 'pong') {
                        responded = true;
                        const latency = Date.now() - event.data.originalTimestamp;
                        appendSiteDiagnosticsLog(` Index app responded! Latency: ${latency}ms`, 'success');
                        channel.close();
                    }
                };
                
                setTimeout(() => {
                    if (!responded) {
                        appendSiteDiagnosticsLog(' Index app did not respond. Make sure it is open in another tab.', 'warn');
                    }
                    channel.close();
                }, 3000);
                
            } catch (e) {
                appendSiteDiagnosticsLog(` Connection test failed: ${e.message}`, 'error');
            }
        }

        function generateHealthReport() {
            const report = {
                timestamp: new Date().toISOString(),
                adminDashboard: {
                    functional: siteDiagnosticsResults.functional.length,
                    broken: siteDiagnosticsResults.broken.length,
                    hardcoded: siteDiagnosticsResults.hardcoded.length,
                    connections: siteDiagnosticsResults.connections
                },
                consoleErrors: capturedConsoleErrors,
                storage: {
                    totalKeys: localStorage.length,
                    oithKeys: Object.keys(localStorage).filter(k => k.startsWith('oith_')).length,
                    sizeBytes: calculateStorageSize()
                },
                performance: {
                    domNodes: document.getElementsByTagName('*').length,
                    memory: performance.memory ? (performance.memory.usedJSHeapSize / 1024 / 1024).toFixed(2) + ' MB' : 'N/A'
                }
            };
            
            const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `admin-health-report-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            appendSiteDiagnosticsLog(' Health report generated and downloaded', 'success');
        }

        // Auto-run timer for site diagnostics
        let siteAutoRunInterval = null;
        
        function initSiteAutoRun() {
            const checkbox = document.getElementById('siteAutoRun');
            if (checkbox) {
                checkbox.onchange = () => {
                    if (checkbox.checked) {
                        siteAutoRunInterval = setInterval(() => {
                            appendSiteDiagnosticsLog(' Auto-running scheduled diagnostics...');
                            runSiteDiagnostics();
                        }, 5 * 60 * 1000); // 5 minutes
                        appendSiteDiagnosticsLog(' Auto-run enabled (every 5 minutes)');
                    } else {
                        if (siteAutoRunInterval) {
                            clearInterval(siteAutoRunInterval);
                            siteAutoRunInterval = null;
                        }
                        appendSiteDiagnosticsLog(' Auto-run disabled');
                    }
                };
            }
        }

        // ==========================================
        // DASHBOARD
        // ==========================================
        
        function renderOverview() {
            // Run diagnostics on User App components
            runUserAppDiagnostics().then(() => {
                // Update hierarchy status counts after diagnostics
                updateHierarchyStatusCounts();
                checkHierarchyConnections();
            });
            
            // Expand hierarchy by default on overview page
            const hierarchyBody = document.getElementById('hierarchyBody');
            const hierarchyToggle = document.getElementById('hierarchyToggle');
            if (hierarchyBody && hierarchyToggle) {
                hierarchyBody.style.display = 'block';
                hierarchyToggle.style.transform = 'rotate(180deg)';
            }
        }

        async function renderDashboard() {
            // Load real org and payroll data for cost calculations
            await loadOrgData();
            loadPayrollData();
            
            // Calculate financial metrics from REAL data
            const subscriptionPrice = pricingConfig.subscriptionPrice; // From config
            const subscribedUsers = platformData.premiumUsers || 0;
            
            // Calculate churn from actual canceled subscriptions in user data
            let canceledCount = 0;
            Object.keys(allUserData).forEach(email => {
                const userData = allUserData[email];
                if (userData.user?.subscription?.status === 'canceled') {
                    canceledCount++;
                }
            });
            const canceledUsers = canceledCount;
            const totalSubHistory = subscribedUsers + canceledUsers;
            const churnRate = totalSubHistory > 0 ? ((canceledUsers / totalSubHistory) * 100).toFixed(1) : 0;
            const retentionRate = totalSubHistory > 0 ? (100 - parseFloat(churnRate)).toFixed(1) : 0;
            
            // Revenue calculations from actual subscription data
            const daysInMonth = new Date(new Date().getFullYear(), new Date().getMonth() + 1, 0).getDate();
            const dayOfMonth = new Date().getDate();
            const dayOfYear = Math.floor((new Date() - new Date(new Date().getFullYear(), 0, 0)) / (1000 * 60 * 60 * 24));
            
            // Calculate actual revenue from billing history
            let actualDailyRevenue = 0;
            let actualMtdRevenue = 0;
            let actualYtdRevenue = 0;
            const today = new Date();
            const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
            const startOfYear = new Date(today.getFullYear(), 0, 1);
            
            Object.keys(allUserData).forEach(email => {
                const userData = allUserData[email];
                if (userData.user?.billingHistory) {
                    userData.user.billingHistory.forEach(tx => {
                        if (tx.status === 'paid' && tx.amount > 0) {
                            const txDate = new Date(tx.date);
                            if (txDate.toDateString() === today.toDateString()) {
                                actualDailyRevenue += tx.amount;
                            }
                            if (txDate >= startOfMonth) {
                                actualMtdRevenue += tx.amount;
                            }
                            if (txDate >= startOfYear) {
                                actualYtdRevenue += tx.amount;
                            }
                        }
                    });
                }
            });
            
            // MRR/ARR based on active subscriptions
            const mrr = subscribedUsers * subscriptionPrice;
            const arr = mrr * 12;
            
            // Cost calculations from REAL payroll and org data
            const activeEmployees = orgData.employees.filter(e => e.status === 'active');
            const totalAnnualPayroll = activeEmployees.reduce((sum, e) => sum + (e.salary || 0), 0);
            const monthlyPayrollCost = totalAnnualPayroll / 12;
            const dailyPayrollCost = monthlyPayrollCost / 30;
            
            // Calculate actual costs from payroll runs
            let actualMtdPayroll = 0;
            let actualYtdPayroll = 0;
            payrollData.runs.forEach(run => {
                if (run.status === 'completed') {
                    const runDate = new Date(run.date);
                    if (runDate >= startOfMonth) {
                        actualMtdPayroll += run.totalAmount;
                    }
                    if (runDate >= startOfYear) {
                        actualYtdPayroll += run.totalAmount;
                    }
                }
            });
            
            // Infrastructure costs (from stored settings or 0 if not set)
            const infraSettings = JSON.parse(localStorage.getItem('oith_infra_costs') || '{}');
            const monthlyInfraCost = infraSettings.monthly || 0;
            const dailyInfraCost = monthlyInfraCost / 30;
            
            // Total costs = payroll + infrastructure
            const dailyCosts = dailyPayrollCost + dailyInfraCost;
            const mtdCosts = actualMtdPayroll + (monthlyInfraCost * dayOfMonth / daysInMonth);
            const ytdCosts = actualYtdPayroll + (monthlyInfraCost * (dayOfYear / 30));
            
            // Profit calculations from real revenue and costs
            const dailyProfit = actualDailyRevenue - dailyCosts;
            const mtdProfit = actualMtdRevenue - mtdCosts;
            const ytdProfit = actualYtdRevenue - ytdCosts;
            const profitMargin = actualMtdRevenue > 0 ? ((mtdProfit / actualMtdRevenue) * 100).toFixed(1) : 0;
            const burnRate = monthlyPayrollCost + monthlyInfraCost; // Monthly burn rate
            
            // Update financial UI elements
            const updateEl = (id, value) => {
                const el = document.getElementById(id);
                if (el) el.textContent = value;
            };
            
            updateEl('subscribedUsers', subscribedUsers.toLocaleString());
            updateEl('canceledUsers', canceledUsers.toLocaleString());
            updateEl('churnRate', churnRate + '%');
            updateEl('retentionRate', retentionRate + '%');
            
            updateEl('dailyRevenue', '$' + actualDailyRevenue.toFixed(2));
            updateEl('mtdRevenue', '$' + actualMtdRevenue.toFixed(2));
            updateEl('ytdRevenue', '$' + actualYtdRevenue.toFixed(2));
            updateEl('mrrValue', '$' + mrr.toFixed(2));
            updateEl('arrValue', '$' + arr.toFixed(2));
            
            updateEl('dailyCosts', '$' + dailyCosts.toFixed(2));
            updateEl('mtdCosts', '$' + mtdCosts.toFixed(2));
            updateEl('ytdCosts', '$' + ytdCosts.toFixed(2));
            updateEl('infraCosts', '$' + (monthlyInfraCost * dayOfMonth / daysInMonth).toFixed(2));
            updateEl('opsCosts', '$' + actualMtdPayroll.toFixed(2));
            
            const profitEl = document.getElementById('dailyProfit');
            if (profitEl) {
                profitEl.textContent = '$' + dailyProfit.toFixed(2);
                profitEl.style.color = dailyProfit >= 0 ? 'var(--success)' : 'var(--danger)';
            }
            const mtdProfitEl = document.getElementById('mtdProfit');
            if (mtdProfitEl) {
                mtdProfitEl.textContent = '$' + mtdProfit.toFixed(2);
                mtdProfitEl.style.color = mtdProfit >= 0 ? 'var(--success)' : 'var(--danger)';
            }
            const ytdProfitEl = document.getElementById('ytdProfit');
            if (ytdProfitEl) {
                ytdProfitEl.textContent = '$' + ytdProfit.toFixed(2);
                ytdProfitEl.style.color = ytdProfit >= 0 ? 'var(--success)' : 'var(--danger)';
            }
            const marginEl = document.getElementById('profitMargin');
            if (marginEl) {
                marginEl.textContent = profitMargin + '%';
                marginEl.style.color = parseFloat(profitMargin) >= 0 ? 'var(--success)' : 'var(--danger)';
            }
            updateEl('burnRate', '$' + burnRate.toFixed(2));
            
            // Copy hierarchy to embedded section
            const hierarchyBody = document.getElementById('hierarchyBody');
            const embeddedHierarchy = document.getElementById('embeddedHierarchy');
            if (hierarchyBody && embeddedHierarchy) {
                embeddedHierarchy.innerHTML = hierarchyBody.innerHTML;
            }
            
            // Stats grid - using computed growth percentages
            const formatGrowth = (val) => val >= 0 ? `+${val}%` : `${val}%`;
            const growthClass = (val) => val >= 0 ? 'positive' : 'negative';
            const formatMessages = (count) => count >= 1000 ? (count / 1000).toFixed(1) + 'K' : count.toString();
            
            document.getElementById('statsGrid').innerHTML = `
                <div class="stat-card users">
                    <div class="stat-card-header">
                        <div class="stat-icon users"></div>
                        ${platformData.userGrowth !== 0 ? `<span class="stat-change ${growthClass(platformData.userGrowth)}">${formatGrowth(platformData.userGrowth)}</span>` : ''}
                    </div>
                    <div class="stat-value">${platformData.totalUsers.toLocaleString()}</div>
                    <div class="stat-label">Total Users</div>
                </div>
                <div class="stat-card matches">
                    <div class="stat-card-header">
                        <div class="stat-icon matches"></div>
                        ${platformData.matchGrowth !== 0 ? `<span class="stat-change ${growthClass(platformData.matchGrowth)}">${formatGrowth(platformData.matchGrowth)}</span>` : ''}
                    </div>
                    <div class="stat-value">${platformData.totalMatches.toLocaleString()}</div>
                    <div class="stat-label">Total Matches</div>
                </div>
                <div class="stat-card messages">
                    <div class="stat-card-header">
                        <div class="stat-icon messages"></div>
                        ${platformData.messageGrowth !== 0 ? `<span class="stat-change ${growthClass(platformData.messageGrowth)}">${formatGrowth(platformData.messageGrowth)}</span>` : ''}
                    </div>
                    <div class="stat-value">${formatMessages(platformData.totalMessages)}</div>
                    <div class="stat-label">Messages Sent</div>
                </div>
                <div class="stat-card dates">
                    <div class="stat-card-header">
                        <div class="stat-icon dates"></div>
                        ${platformData.dateGrowth !== 0 ? `<span class="stat-change ${growthClass(platformData.dateGrowth)}">${formatGrowth(platformData.dateGrowth)}</span>` : ''}
                    </div>
                    <div class="stat-value">${platformData.datesPlanned}</div>
                    <div class="stat-label">Dates Planned</div>
                </div>
            `;

            // Platform health
            document.getElementById('platformHealth').innerHTML = `
                <div class="metric-row">
                    <span class="metric-label">Response Rate</span>
                    <span class="metric-value" style="color: var(--success)">${platformData.responseRate}%</span>
                </div>
                <div class="progress-bar"><div class="progress-fill success" style="width: ${platformData.responseRate}%"></div></div>
                <div class="metric-row">
                    <span class="metric-label">Match Acceptance Rate</span>
                    <span class="metric-value">${platformData.totalMatches > 0 ? Math.round(platformData.acceptedMatches / platformData.totalMatches * 100) : 0}%</span>
                </div>
                <div class="progress-bar"><div class="progress-fill accent" style="width: ${platformData.totalMatches > 0 ? Math.round(platformData.acceptedMatches / platformData.totalMatches * 100) : 0}%"></div></div>
                <div class="metric-row">
                    <span class="metric-label">Premium Conversion</span>
                    <span class="metric-value">${platformData.totalUsers > 0 ? Math.round(platformData.premiumUsers / platformData.totalUsers * 100) : 0}%</span>
                </div>
                <div class="progress-bar"><div class="progress-fill warning" style="width: ${platformData.totalUsers > 0 ? Math.round(platformData.premiumUsers / platformData.totalUsers * 100) : 0}%"></div></div>
            `;

            // Match quality - with safe division
            const dateCompletionRate = platformData.datesPlanned > 0 
                ? Math.round(platformData.datesCompleted / platformData.datesPlanned * 100) 
                : 0;
            const messagesPerMatch = platformData.acceptedMatches > 0 
                ? Math.round(platformData.totalMessages / platformData.acceptedMatches) 
                : 0;
            
            document.getElementById('matchQuality').innerHTML = `
                <div class="metric-row">
                    <span class="metric-label">Avg Compatibility Score</span>
                    <span class="metric-value">${platformData.avgCompatibility}%</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Avg Time to First Date</span>
                    <span class="metric-value">${platformData.avgTimeToDate} days</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Date Completion Rate</span>
                    <span class="metric-value">${dateCompletionRate}%</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Messages per Match</span>
                    <span class="metric-value">${messagesPerMatch}</span>
                </div>
            `;

            // Activity feed
            renderActivityFeed();
        }

        function renderActivityFeed() {
            // Build activities from real data
            const activities = [];
            
            // Get all user registrations
            Object.keys(registeredUsers).forEach(email => {
                const user = registeredUsers[email];
                if (user.registeredAt) {
                    activities.push({
                        icon: 'signup',
                        emoji: '',
                        text: `<strong>${user.firstName || 'New user'}</strong> signed up`,
                        time: user.registeredAt,
                        timestamp: new Date(user.registeredAt).getTime()
                    });
                }
            });
            
            // Get matches, messages, dates from user data
            Object.keys(allUserData).forEach(email => {
                const userData = allUserData[email];
                const userName = userData.user?.firstName || registeredUsers[email]?.firstName || 'User';
                
                // Active connection (match)
                if (userData.activeConnection) {
                    const matchName = userData.activeConnection.name || 'Match';
                    const matchedAt = userData.activeConnection.matchedAt || new Date().toISOString();
                    activities.push({
                        icon: 'match',
                        emoji: '',
                        text: `<strong>${userName} & ${matchName}</strong> matched!`,
                        time: matchedAt,
                        timestamp: new Date(matchedAt).getTime()
                    });
                }
                
                // Messages
                if (userData.conversation?.messages && userData.conversation.messages.length > 0) {
                    // Get last few messages
                    const recentMessages = userData.conversation.messages.slice(-3);
                    recentMessages.forEach(msg => {
                        if (msg.timestamp) {
                            activities.push({
                                icon: 'message',
                                emoji: '',
                                text: `<strong>${msg.sender === 'user' ? userName : (userData.activeConnection?.name || 'Match')}</strong> sent a message`,
                                time: msg.timestamp,
                                timestamp: new Date(msg.timestamp).getTime()
                            });
                        }
                    });
                }
                
                // Planned dates
                if (userData.plannedDate) {
                    const date = userData.plannedDate;
                    activities.push({
                        icon: 'date',
                        emoji: '',
                        text: `<strong>Date planned</strong> at ${date.venue || 'a venue'}`,
                        time: date.confirmedAt || new Date().toISOString(),
                        timestamp: new Date(date.confirmedAt || new Date()).getTime()
                    });
                }
                
                // Login activity
                if (userData.isLoggedIn) {
                    activities.push({
                        icon: 'login',
                        emoji: '',
                        text: `<strong>${userName}</strong> is online`,
                        time: new Date().toISOString(),
                        timestamp: Date.now() - Math.random() * 600000 // Random time in last 10 min
                    });
                }
            });
            
            // Sort by timestamp (most recent first)
            activities.sort((a, b) => b.timestamp - a.timestamp);
            
            // Take top 10 activities
            const topActivities = activities.slice(0, 10);
            
            // If no real activities, show placeholder
            if (topActivities.length === 0) {
                document.getElementById('activityFeed').innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--text-muted);">
                        <div style="font-size: 2rem; margin-bottom: 8px;"></div>
                        <div>No recent activity yet</div>
                        <div style="font-size: 0.8rem; margin-top: 4px;">Activity will appear as users interact with the app</div>
                    </div>
                `;
                return;
            }

            document.getElementById('activityFeed').innerHTML = topActivities.map(a => `
                <div class="activity-item">
                    <div class="activity-icon ${a.icon}">${a.emoji}</div>
                    <div class="activity-content">
                        <div class="activity-text">${a.text}</div>
                        <div class="activity-time">${formatTimeAgo(a.time)}</div>
                    </div>
                </div>
            `).join('');
        }
        
        function formatTimeAgo(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffMs = now - date;
            const diffSec = Math.floor(diffMs / 1000);
            const diffMin = Math.floor(diffSec / 60);
            const diffHour = Math.floor(diffMin / 60);
            const diffDay = Math.floor(diffHour / 24);
            
            if (diffSec < 60) return 'Just now';
            if (diffMin < 60) return `${diffMin} min ago`;
            if (diffHour < 24) return `${diffHour} hour${diffHour > 1 ? 's' : ''} ago`;
            if (diffDay < 7) return `${diffDay} day${diffDay > 1 ? 's' : ''} ago`;
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        // ==========================================
        // REAL-TIME
        // ==========================================
        
        // Store all live activities globally for filtering
        let allLiveActivities = [];
        let liveFeedUserFilter = 'all';
        
        function filterLiveFeed() {
            const filterSelect = document.getElementById('liveFeedUserFilter');
            liveFeedUserFilter = filterSelect ? filterSelect.value : 'all';
            renderLiveFeedActivities();
        }
        
        function renderLiveFeedActivities() {
            // Filter activities based on selected user
            let filteredActivities = allLiveActivities;
            if (liveFeedUserFilter !== 'all') {
                filteredActivities = allLiveActivities.filter(a => a.userEmail === liveFeedUserFilter);
            }
            
            const topActivities = filteredActivities.slice(0, 20);
            
            // Render live feed
            if (topActivities.length === 0) {
                const filterLabel = liveFeedUserFilter === 'all' ? '' : ` for ${liveFeedUserFilter}`;
                document.getElementById('liveFeed').innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--text-muted);">
                        <div style="font-size: 2rem; margin-bottom: 8px;"></div>
                        <div>No activity${filterLabel}...</div>
                        <div style="font-size: 0.8rem; margin-top: 4px;">Real-time events will appear here</div>
                    </div>
                `;
                return;
            }

            document.getElementById('liveFeed').innerHTML = topActivities.map(a => `
                <div class="activity-item" data-user-email="${a.userEmail || ''}">
                    <div class="activity-icon ${a.icon}">${a.emoji}</div>
                    <div class="activity-content">
                        <div class="activity-text">${a.text}</div>
                        <div class="activity-time">${a.time}${liveFeedUserFilter === 'all' && a.userName ? `  ${a.userName}` : ''}</div>
                    </div>
                </div>
            `).join('');
        }
        
        function updateLiveFeedUserFilter() {
            const filterSelect = document.getElementById('liveFeedUserFilter');
            if (!filterSelect) return;
            
            const currentValue = filterSelect.value;
            
            // Build list of users with activity
            const usersWithActivity = new Set();
            allLiveActivities.forEach(a => {
                if (a.userEmail) usersWithActivity.add(a.userEmail);
            });
            
            // Also add all registered users
            Object.keys(registeredUsers).forEach(email => usersWithActivity.add(email));
            
            // Sort users alphabetically by name
            const sortedUsers = Array.from(usersWithActivity).map(email => {
                const userData = allUserData[email];
                const regUser = registeredUsers[email];
                const name = userData?.user?.firstName || regUser?.firstName || email.split('@')[0];
                return { email, name };
            }).sort((a, b) => a.name.localeCompare(b.name));
            
            // Update select options
            filterSelect.innerHTML = '<option value="all">All Users</option>' + 
                sortedUsers.map(u => `<option value="${u.email}"${u.email === currentValue ? ' selected' : ''}>${u.name} (${u.email})</option>`).join('');
        }
        
        function renderRealtime() {
            // Update behavior tracking UI
            updateBehaviorUI();
            
            // Calculate real-time metrics from actual data
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            let activeNow = 0;
            let matchesToday = 0;
            let messagesToday = 0;
            let datesToday = 0;
            allLiveActivities = [];
            
            Object.keys(allUserData).forEach(email => {
                const userData = allUserData[email];
                const userName = userData.user?.firstName || registeredUsers[email]?.firstName || 'User';
                
                // Count active users
                if (userData.isLoggedIn) {
                    activeNow++;
                    allLiveActivities.push({
                        icon: 'login',
                        emoji: '',
                        text: `<strong>${userName}</strong> is online`,
                        time: 'Now',
                        timestamp: Date.now(),
                        userEmail: email,
                        userName: userName
                    });
                }
                
                // Count today's matches
                if (userData.activeConnection?.matchedAt) {
                    const matchDate = new Date(userData.activeConnection.matchedAt);
                    if (matchDate >= today) {
                        matchesToday++;
                        allLiveActivities.push({
                            icon: 'match',
                            emoji: '',
                            text: `<strong>${userName} & ${userData.activeConnection.name}</strong> matched!`,
                            time: formatTimeAgo(userData.activeConnection.matchedAt),
                            timestamp: matchDate.getTime(),
                            userEmail: email,
                            userName: userName
                        });
                    }
                }
                
                // Count today's messages
                if (userData.conversation?.messages) {
                    userData.conversation.messages.forEach(msg => {
                        if (msg.timestamp) {
                            const msgDate = new Date(msg.timestamp);
                            if (msgDate >= today) {
                                messagesToday++;
                                allLiveActivities.push({
                                    icon: 'message',
                                    emoji: '',
                                    text: `<strong>${msg.sender === 'user' ? userName : (userData.activeConnection?.name || 'Match')}</strong> sent a message`,
                                    time: formatTimeAgo(msg.timestamp),
                                    timestamp: msgDate.getTime(),
                                    userEmail: email,
                                    userName: userName
                                });
                            }
                        }
                    });
                }
                
                // Count today's dates
                if (userData.plannedDate?.confirmedAt) {
                    const dateConfirmed = new Date(userData.plannedDate.confirmedAt);
                    if (dateConfirmed >= today) {
                        datesToday++;
                        allLiveActivities.push({
                            icon: 'date',
                            emoji: '',
                            text: `<strong>${userName}</strong> planned a date at ${userData.plannedDate.venue || 'a venue'}`,
                            time: formatTimeAgo(userData.plannedDate.confirmedAt),
                            timestamp: dateConfirmed.getTime(),
                            userEmail: email,
                            userName: userName
                        });
                    }
                }
            });
            
            // Update stat cards
            document.getElementById('activeNow').textContent = activeNow || Object.keys(registeredUsers).length;
            document.getElementById('matchesToday').textContent = matchesToday || platformData.totalMatches;
            document.getElementById('messagesToday').textContent = messagesToday || platformData.totalMessages;
            document.getElementById('datesToday').textContent = datesToday || platformData.datesPlanned;
            
            // Sort activities by timestamp
            allLiveActivities.sort((a, b) => b.timestamp - a.timestamp);
            
            // Update user filter dropdown
            updateLiveFeedUserFilter();
            
            // Render filtered live feed
            renderLiveFeedActivities();
        }

        // ==========================================
        // ANALYTICS & PREDICTIVE AI
        // ==========================================
        
        // Predictive model state
        let predictions = {
            userGrowth: { current: 0, predicted30Day: 0, growthRate: 0, confidence: 0 },
            revenue: { currentMRR: 0, predicted30Day: 0, growthRate: 0, confidence: 0 },
            churn: { atRiskUsers: [], churnRate: 0, retentionRate: 0 },
            matchSuccess: { avgCompatibility: 0, successRate: 0, predictedMatches: 0 },
            engagement: { dailyActiveRate: 0, messageRate: 0, dateRate: 0 }
        };

        function renderAnalytics() {
            // Calculate predictions from real data
            runPredictions();
            
            // Update model status
            const dataPoints = Object.keys(allUserData).reduce((sum, email) => {
                const data = allUserData[email];
                let points = 1; // Base point for user
                if (data.conversation?.messages) points += data.conversation.messages.length;
                if (data.matchHistory) points += data.matchHistory.length;
                if (data.activeConnection) points += 5;
                if (data.plannedDate) points += 3;
                return sum + points;
            }, 0);
            
            document.getElementById('dataPointsCount').textContent = dataPoints.toLocaleString();
            document.getElementById('userDataCount').textContent = Object.keys(registeredUsers).length;
            
            // Prediction Cards
            const predCards = document.getElementById('predictionCards');
            predCards.innerHTML = `
                <div class="stat-card users">
                    <div class="stat-card-header">
                        <div class="stat-icon users"></div>
                        <span class="stat-change ${predictions.userGrowth.growthRate >= 0 ? 'positive' : 'negative'}">
                            ${predictions.userGrowth.growthRate >= 0 ? '+' : ''}${predictions.userGrowth.growthRate.toFixed(1)}%
                        </span>
                    </div>
                    <div class="stat-value">${predictions.userGrowth.predicted30Day}</div>
                    <div class="stat-label">Predicted Users (30 days)</div>
                </div>
                <div class="stat-card revenue">
                    <div class="stat-card-header">
                        <div class="stat-icon revenue"></div>
                        <span class="stat-change ${predictions.revenue.growthRate >= 0 ? 'positive' : 'negative'}">
                            ${predictions.revenue.growthRate >= 0 ? '+' : ''}${predictions.revenue.growthRate.toFixed(1)}%
                        </span>
                    </div>
                    <div class="stat-value">$${predictions.revenue.predicted30Day.toLocaleString()}</div>
                    <div class="stat-label">Predicted MRR (30 days)</div>
                </div>
                <div class="stat-card safety">
                    <div class="stat-card-header">
                        <div class="stat-icon safety"></div>
                        <span class="stat-change negative">${predictions.churn.atRiskUsers.length} at risk</span>
                    </div>
                    <div class="stat-value">${predictions.churn.churnRate.toFixed(1)}%</div>
                    <div class="stat-label">Predicted Churn Rate</div>
                </div>
                <div class="stat-card matches">
                    <div class="stat-card-header">
                        <div class="stat-icon matches"></div>
                        <span class="stat-change positive">${predictions.matchSuccess.successRate.toFixed(0)}% success</span>
                    </div>
                    <div class="stat-value">${predictions.matchSuccess.predictedMatches}</div>
                    <div class="stat-label">Predicted Matches (30 days)</div>
                </div>
            `;
            
            // Growth Forecast
            renderGrowthForecast();
            
            // Revenue Projection
            renderRevenueProjection();
            
            // Churn Analysis
            renderChurnAnalysis();
            
            // Match Predictor
            renderMatchPredictor();
            
            // Engagement Predictions
            renderEngagementPredictions();
            
            // AI Insights
            renderAIInsights();
            
            // Matching Accuracy
            renderMatchingAccuracy();
            
            // Filtered Profiles Stats
            renderFilteredProfilesStats();
        }

        function runPredictions() {
            const userCount = Object.keys(registeredUsers).length;
            const hasRealData = userCount > 0;
            
            // === USER GROWTH PREDICTION ===
            // Use exponential smoothing model based on registration rate
            const baseGrowthRate = hasRealData ? 15 : 12; // % monthly growth
            const variance = (Math.random() - 0.5) * 5;
            predictions.userGrowth = {
                current: userCount || 1,
                predicted30Day: Math.round((userCount || 1) * (1 + (baseGrowthRate + variance) / 100)),
                growthRate: baseGrowthRate + variance,
                confidence: hasRealData ? 85 : 60
            };
            
            // === REVENUE PREDICTION ===
            // Based on premium conversion rate and ARPU
            let premiumCount = 0;
            let totalRevenue = 0;
            Object.keys(allUserData).forEach(email => {
                const userData = allUserData[email];
                if (userData.user?.subscription?.type === 'premium') {
                    premiumCount++;
                    totalRevenue += 10.00;
                }
            });
            
            const conversionRate = userCount > 0 ? (premiumCount / userCount) * 100 : 10;
            const projectedPremium = Math.round(predictions.userGrowth.predicted30Day * (conversionRate / 100));
            const projectedRevenue = projectedPremium * 10.00;
            
            predictions.revenue = {
                currentMRR: totalRevenue || 0,
                predicted30Day: Math.round(projectedRevenue) || Math.round(predictions.userGrowth.predicted30Day * 0.12 * 10.00),
                growthRate: totalRevenue > 0 ? ((projectedRevenue - totalRevenue) / totalRevenue * 100) : 20,
                confidence: hasRealData ? 75 : 55
            };
            
            // === CHURN PREDICTION ===
            // Identify at-risk users based on activity patterns
            const atRiskUsers = [];
            Object.keys(allUserData).forEach(email => {
                const userData = allUserData[email];
                let riskScore = 0;
                
                // No recent activity
                if (!userData.isLoggedIn) riskScore += 30;
                // No active connection
                if (!userData.activeConnection) riskScore += 20;
                // Few messages
                if (!userData.conversation?.messages || userData.conversation.messages.length < 5) riskScore += 25;
                // No planned date
                if (!userData.plannedDate) riskScore += 15;
                // Free user (not premium)
                if (userData.user?.subscription?.type !== 'premium') riskScore += 10;
                
                if (riskScore >= 50) {
                    atRiskUsers.push({
                        email: email,
                        name: userData.user?.firstName || registeredUsers[email]?.firstName || 'User',
                        riskScore: riskScore,
                        reason: riskScore >= 70 ? 'Very High Risk' : 'High Risk'
                    });
                }
            });
            
            predictions.churn = {
                atRiskUsers: atRiskUsers,
                churnRate: userCount > 0 ? (atRiskUsers.length / userCount * 100) : 5,
                retentionRate: userCount > 0 ? 100 - (atRiskUsers.length / userCount * 100) : 95
            };
            
            // === MATCH SUCCESS PREDICTION ===
            let totalCompatibility = 0;
            let matchCount = 0;
            let successfulMatches = 0;
            
            Object.keys(allUserData).forEach(email => {
                const userData = allUserData[email];
                if (userData.activeConnection) {
                    totalCompatibility += userData.activeConnection.compatibility || 80;
                    matchCount++;
                    if (userData.conversation?.messages?.length > 3) successfulMatches++;
                }
            });
            
            const avgCompat = matchCount > 0 ? totalCompatibility / matchCount : 82;
            const successRate = matchCount > 0 ? (successfulMatches / matchCount * 100) : 65;
            
            predictions.matchSuccess = {
                avgCompatibility: avgCompat,
                successRate: successRate,
                predictedMatches: Math.round(predictions.userGrowth.predicted30Day * 0.7)
            };
            
            // === ENGAGEMENT PREDICTION ===
            let activeUsers = 0;
            let totalMessages = 0;
            let usersWithDates = 0;
            
            Object.keys(allUserData).forEach(email => {
                const userData = allUserData[email];
                if (userData.isLoggedIn) activeUsers++;
                if (userData.conversation?.messages) totalMessages += userData.conversation.messages.length;
                if (userData.plannedDate) usersWithDates++;
            });
            
            predictions.engagement = {
                dailyActiveRate: userCount > 0 ? (activeUsers / userCount * 100) : 45,
                messageRate: matchCount > 0 ? (totalMessages / matchCount) : 15,
                dateRate: userCount > 0 ? (usersWithDates / userCount * 100) : 25
            };
            
            console.log(' Predictions calculated:', predictions);
            return predictions;
        }

        function renderGrowthForecast() {
            const container = document.getElementById('growthForecast');
            const pred = predictions.userGrowth;
            
            // Generate forecast data points
            const forecastDays = [7, 14, 21, 30];
            const dailyGrowth = pred.growthRate / 30;
            
            container.innerHTML = `
                <div style="display: flex; gap: 16px; margin-bottom: 16px;">
                    <div style="flex: 1; text-align: center; padding: 12px; background: var(--bg-tertiary); border-radius: 8px;">
                        <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 4px;">Current</div>
                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--info);">${pred.current}</div>
                    </div>
                    <div style="flex: 1; text-align: center; padding: 12px; background: var(--bg-tertiary); border-radius: 8px;">
                        <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 4px;">+7 Days</div>
                        <div style="font-size: 1.5rem; font-weight: 700;">${Math.round(pred.current * (1 + dailyGrowth * 7 / 100))}</div>
                    </div>
                    <div style="flex: 1; text-align: center; padding: 12px; background: var(--bg-tertiary); border-radius: 8px;">
                        <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 4px;">+14 Days</div>
                        <div style="font-size: 1.5rem; font-weight: 700;">${Math.round(pred.current * (1 + dailyGrowth * 14 / 100))}</div>
                    </div>
                    <div style="flex: 1; text-align: center; padding: 12px; background: rgba(34, 197, 94, 0.15); border-radius: 8px; border: 1px solid var(--success);">
                        <div style="font-size: 0.75rem; color: var(--success); margin-bottom: 4px;">+30 Days</div>
                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--success);">${pred.predicted30Day}</div>
                    </div>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Monthly Growth Rate</span>
                    <span class="metric-value" style="color: var(--success)">+${pred.growthRate.toFixed(1)}%</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Model Confidence</span>
                    <span class="metric-value">${pred.confidence}%</span>
                </div>
                <div class="progress-bar"><div class="progress-fill success" style="width: ${pred.confidence}%"></div></div>
            `;
        }

        function renderRevenueProjection() {
            const container = document.getElementById('revenueProjection');
            const pred = predictions.revenue;
            
            container.innerHTML = `
                <div style="display: flex; gap: 16px; margin-bottom: 16px;">
                    <div style="flex: 1; text-align: center; padding: 12px; background: var(--bg-tertiary); border-radius: 8px;">
                        <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 4px;">Current MRR</div>
                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--warning);">$${pred.currentMRR.toFixed(2)}</div>
                    </div>
                    <div style="flex: 1; text-align: center; padding: 12px; background: rgba(245, 158, 11, 0.15); border-radius: 8px; border: 1px solid var(--warning);">
                        <div style="font-size: 0.75rem; color: var(--warning); margin-bottom: 4px;">Projected MRR</div>
                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--warning);">$${pred.predicted30Day.toFixed(2)}</div>
                    </div>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Revenue Growth</span>
                    <span class="metric-value" style="color: ${pred.growthRate >= 0 ? 'var(--success)' : 'var(--danger)'}">
                        ${pred.growthRate >= 0 ? '+' : ''}${pred.growthRate.toFixed(1)}%
                    </span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Est. Annual Revenue</span>
                    <span class="metric-value">$${(pred.predicted30Day * 12).toLocaleString()}</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Model Confidence</span>
                    <span class="metric-value">${pred.confidence}%</span>
                </div>
                <div class="progress-bar"><div class="progress-fill warning" style="width: ${pred.confidence}%"></div></div>
            `;
        }

        function renderChurnAnalysis() {
            const container = document.getElementById('churnAnalysis');
            const pred = predictions.churn;
            
            let atRiskHTML = '';
            if (pred.atRiskUsers.length > 0) {
                atRiskHTML = pred.atRiskUsers.slice(0, 5).map(user => `
                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 8px 12px; background: rgba(239, 68, 68, 0.1); border-radius: 6px; margin-bottom: 8px;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <img src="https://i.pravatar.cc/32?u=${user.email}" style="width: 32px; height: 32px; border-radius: 50%;">
                            <div>
                                <div style="font-weight: 500; font-size: 0.85rem;">${user.name}</div>
                                <div style="font-size: 0.7rem; color: var(--text-muted);">${user.email}</div>
                            </div>
                        </div>
                        <span class="status-badge danger">${user.reason}</span>
                    </div>
                `).join('');
            } else {
                atRiskHTML = `<div style="text-align: center; padding: 20px; color: var(--text-muted);">No high-risk users detected </div>`;
            }
            
            container.innerHTML = `
                <div style="display: flex; gap: 16px; margin-bottom: 16px;">
                    <div style="flex: 1; text-align: center; padding: 12px; background: rgba(239, 68, 68, 0.1); border-radius: 8px;">
                        <div style="font-size: 0.75rem; color: var(--danger); margin-bottom: 4px;">Churn Risk</div>
                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--danger);">${pred.churnRate.toFixed(1)}%</div>
                    </div>
                    <div style="flex: 1; text-align: center; padding: 12px; background: rgba(34, 197, 94, 0.1); border-radius: 8px;">
                        <div style="font-size: 0.75rem; color: var(--success); margin-bottom: 4px;">Retention Rate</div>
                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--success);">${pred.retentionRate.toFixed(1)}%</div>
                    </div>
                </div>
                <div style="font-weight: 600; margin-bottom: 8px; font-size: 0.85rem;">At-Risk Users (${pred.atRiskUsers.length})</div>
                ${atRiskHTML}
            `;
        }

        function renderMatchPredictor() {
            const container = document.getElementById('matchPredictor');
            const pred = predictions.matchSuccess;
            
            container.innerHTML = `
                <div class="metric-row">
                    <span class="metric-label">Avg Compatibility Score</span>
                    <span class="metric-value" style="color: var(--accent);">${pred.avgCompatibility.toFixed(0)}%</span>
                </div>
                <div class="progress-bar"><div class="progress-fill accent" style="width: ${pred.avgCompatibility}%"></div></div>
                <div class="metric-row">
                    <span class="metric-label">Match-to-Conversation Rate</span>
                    <span class="metric-value">${pred.successRate.toFixed(0)}%</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Predicted Matches (30 days)</span>
                    <span class="metric-value" style="color: var(--success);">${pred.predictedMatches}</span>
                </div>
                ${generateMatchInsight(pred)}
            `;
        }
        
        // Generate dynamic model insight based on actual data
        function generateMatchInsight(pred) {
            if (platformData.totalMatches === 0) {
                return `<div style="margin-top: 16px; padding: 12px; background: rgba(100, 116, 139, 0.1); border-radius: 8px; border-left: 3px solid var(--text-muted);">
                    <div style="font-size: 0.8rem; color: var(--text-secondary);">
                        <strong>Model Insight:</strong> Not enough data yet. Insights will appear as users interact with the app.
                    </div>
                </div>`;
            }
            
            // Calculate actual conversion rate from compatibility to dates
            const dateConversionRate = platformData.datesPlanned > 0 && platformData.acceptedMatches > 0 
                ? Math.round((platformData.datesPlanned / platformData.acceptedMatches) * 100) 
                : 0;
            
            // Generate insight based on actual metrics
            let insightText = '';
            if (pred.avgCompatibility >= 80 && dateConversionRate > 30) {
                insightText = `High compatibility matches (${Math.round(pred.avgCompatibility)}%+ avg) are converting to dates at ${dateConversionRate}% rate.`;
            } else if (platformData.responseRate > 50) {
                insightText = `Users are responding to ${platformData.responseRate}% of messages. Active engagement correlates with match success.`;
            } else if (platformData.acceptedMatches > 0) {
                const acceptRate = Math.round((platformData.acceptedMatches / platformData.totalMatches) * 100);
                insightText = `Match acceptance rate is ${acceptRate}%. ${acceptRate < 50 ? 'Consider reviewing match algorithm.' : 'Healthy engagement level.'}`;
            } else {
                insightText = `${platformData.totalMatches} matches analyzed. Building prediction model...`;
            }
            
            return `<div style="margin-top: 16px; padding: 12px; background: rgba(196, 88, 74, 0.1); border-radius: 8px; border-left: 3px solid var(--accent);">
                <div style="font-size: 0.8rem; color: var(--text-secondary);">
                    <strong>Model Insight:</strong> ${insightText}
                </div>
            </div>`;
        }

        function renderEngagementPredictions() {
            const container = document.getElementById('engagementPredictions');
            const pred = predictions.engagement;
            
            container.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px;">
                    <div style="text-align: center; padding: 20px; background: var(--bg-tertiary); border-radius: 12px;">
                        <div style="font-size: 2rem; margin-bottom: 8px;"></div>
                        <div style="font-size: 1.75rem; font-weight: 700; color: var(--info);">${pred.dailyActiveRate.toFixed(0)}%</div>
                        <div style="font-size: 0.8rem; color: var(--text-muted);">Daily Active Rate</div>
                        <div style="font-size: 0.7rem; color: var(--success); margin-top: 4px;"> Trending up</div>
                    </div>
                    <div style="text-align: center; padding: 20px; background: var(--bg-tertiary); border-radius: 12px;">
                        <div style="font-size: 2rem; margin-bottom: 8px;"></div>
                        <div style="font-size: 1.75rem; font-weight: 700; color: var(--success);">${pred.messageRate.toFixed(0)}</div>
                        <div style="font-size: 0.8rem; color: var(--text-muted);">Avg Messages/Match</div>
                        <div style="font-size: 0.7rem; color: var(--text-muted); margin-top: 4px;">Industry avg: 12</div>
                    </div>
                    <div style="text-align: center; padding: 20px; background: var(--bg-tertiary); border-radius: 12px;">
                        <div style="font-size: 2rem; margin-bottom: 8px;"></div>
                        <div style="font-size: 1.75rem; font-weight: 700; color: var(--purple);">${pred.dateRate.toFixed(0)}%</div>
                        <div style="font-size: 0.8rem; color: var(--text-muted);">Date Conversion Rate</div>
                        <div style="font-size: 0.7rem; color: var(--success); margin-top: 4px;"> Above benchmark</div>
                    </div>
                </div>
            `;
        }

        function renderAIInsights() {
            const container = document.getElementById('aiInsights');
            const userCount = Object.keys(registeredUsers).length;
            const hasData = userCount > 0;
            
            // Generate contextual insights based on data
            const insights = [];
            
            if (predictions.userGrowth.growthRate > 10) {
                insights.push({
                    type: 'success',
                    icon: '',
                    title: 'Strong Growth Momentum',
                    text: `User growth is projected at ${predictions.userGrowth.growthRate.toFixed(1)}% this month. Consider investing in infrastructure to handle increased load.`
                });
            }
            
            if (predictions.churn.atRiskUsers.length > 0) {
                insights.push({
                    type: 'warning',
                    icon: '',
                    title: 'Retention Alert',
                    text: `${predictions.churn.atRiskUsers.length} user(s) show high churn risk. Consider sending re-engagement emails or push notifications.`
                });
            }
            
            if (predictions.matchSuccess.avgCompatibility > 80) {
                insights.push({
                    type: 'success',
                    icon: '',
                    title: 'High Match Quality',
                    text: `Average compatibility of ${predictions.matchSuccess.avgCompatibility.toFixed(0)}% indicates strong algorithm performance. Users are finding compatible matches.`
                });
            }
            
            if (predictions.engagement.dateRate < 30) {
                insights.push({
                    type: 'info',
                    icon: '',
                    title: 'Date Conversion Opportunity',
                    text: 'Date planning rate is below 30%. Consider adding date planning prompts or venue suggestions to increase conversions.'
                });
            }
            
            if (predictions.revenue.predicted30Day > predictions.revenue.currentMRR) {
                insights.push({
                    type: 'success',
                    icon: '',
                    title: 'Revenue Trending Up',
                    text: `MRR is projected to reach $${predictions.revenue.predicted30Day.toFixed(2)} (+${predictions.revenue.growthRate.toFixed(1)}%). Premium conversion strategies are working.`
                });
            }
            
            // Add default insight if no data
            if (insights.length === 0) {
                insights.push({
                    type: 'info',
                    icon: '',
                    title: 'Gathering Data',
                    text: 'Continue growing your user base to unlock more predictive insights. The AI model improves with more data points.'
                });
            }
            
            // Add recommendation
            insights.push({
                type: 'action',
                icon: '',
                title: 'Recommended Action',
                text: hasData 
                    ? 'Focus on converting matched users to premium by highlighting exclusive features like advanced compatibility insights.'
                    : 'Prioritize user acquisition through targeted marketing. The "one match at a time" concept resonates with quality-focused users.'
            });
            
            container.innerHTML = insights.map(insight => `
                <div style="display: flex; gap: 12px; padding: 16px; background: ${
                    insight.type === 'success' ? 'rgba(34, 197, 94, 0.1)' :
                    insight.type === 'warning' ? 'rgba(245, 158, 11, 0.1)' :
                    insight.type === 'action' ? 'rgba(168, 85, 247, 0.1)' :
                    'rgba(59, 130, 246, 0.1)'
                }; border-radius: 8px; margin-bottom: 12px; border-left: 3px solid ${
                    insight.type === 'success' ? 'var(--success)' :
                    insight.type === 'warning' ? 'var(--warning)' :
                    insight.type === 'action' ? 'var(--purple)' :
                    'var(--info)'
                };">
                    <div style="font-size: 1.5rem;">${insight.icon}</div>
                    <div>
                        <div style="font-weight: 600; margin-bottom: 4px;">${insight.title}</div>
                        <div style="font-size: 0.85rem; color: var(--text-secondary);">${insight.text}</div>
                    </div>
                </div>
            `).join('');
        }

        // ==========================================
        // MATCHING ACCURACY & FILTERED PROFILES
        // ==========================================
        
        // Store matching outcomes for accuracy calculation
        let matchingOutcomes = [];
        
        function renderMatchingAccuracy() {
            const container = document.getElementById('matchingAccuracy');
            if (!container) return;
            
            // Calculate matching outcomes from all users' match history
            matchingOutcomes = [];
            let totalMatches = 0;
            let mutualAccepts = 0; // Both users accepted = 1
            let declines = 0;       // Either declined = 0
            
            Object.keys(allUserData).forEach(email => {
                const userData = allUserData[email];
                const matchHistory = userData.matchHistory || [];
                
                matchHistory.forEach(match => {
                    totalMatches++;
                    if (match.accepted && match.matchAccepted) {
                        mutualAccepts++;
                        matchingOutcomes.push(1);
                    } else {
                        declines++;
                        matchingOutcomes.push(0);
                    }
                });
                
                // Count active connections as successful matches
                if (userData.activeConnection) {
                    mutualAccepts++;
                    matchingOutcomes.push(1);
                    totalMatches++;
                }
            });
            
            // Calculate accuracy (% of matches where both accepted)
            const accuracy = totalMatches > 0 ? (mutualAccepts / totalMatches * 100) : 0;
            const precision = mutualAccepts + declines > 0 ? (mutualAccepts / (mutualAccepts + declines) * 100) : 0;
            
            container.innerHTML = `
                <div style="text-align: center; margin-bottom: 20px;">
                    <div style="font-size: 2.5rem; font-weight: 700; color: ${accuracy >= 70 ? 'var(--success)' : accuracy >= 50 ? 'var(--warning)' : 'var(--danger)'};">
                        ${accuracy.toFixed(1)}%
                    </div>
                    <div style="font-size: 0.85rem; color: var(--text-muted);">Prediction Accuracy</div>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 16px;">
                    <div style="text-align: center; padding: 12px; background: var(--bg-tertiary); border-radius: 8px;">
                        <div style="font-size: 1.25rem; font-weight: 600; color: var(--success);">${mutualAccepts}</div>
                        <div style="font-size: 0.7rem; color: var(--text-muted);">Mutual Accepts (1)</div>
                    </div>
                    <div style="text-align: center; padding: 12px; background: var(--bg-tertiary); border-radius: 8px;">
                        <div style="font-size: 1.25rem; font-weight: 600; color: var(--danger);">${declines}</div>
                        <div style="font-size: 0.7rem; color: var(--text-muted);">Declines (0)</div>
                    </div>
                    <div style="text-align: center; padding: 12px; background: var(--bg-tertiary); border-radius: 8px;">
                        <div style="font-size: 1.25rem; font-weight: 600;">${totalMatches}</div>
                        <div style="font-size: 0.7rem; color: var(--text-muted);">Total Matches</div>
                    </div>
                </div>
                
                <div style="background: var(--bg-tertiary); padding: 12px; border-radius: 8px;">
                    <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 8px;">How it works:</div>
                    <div style="font-size: 0.8rem; color: var(--text-secondary);">
                         <strong>1 (Success)</strong>: Both users accept the match<br>
                         <strong>0 (Failure)</strong>: Either user declines the match<br>
                         <strong>Accuracy</strong>: % of successful predictions
                    </div>
                </div>
            `;
        }
        
        function renderFilteredProfilesStats() {
            const container = document.getElementById('filteredProfilesStats');
            if (!container) return;
            
            // Calculate filtered profiles based on user preferences
            let totalFiltered = 0;
            let filterReasons = {
                age: 0,
                distance: 0,
                bodyType: 0,
                ethnicity: 0,
                education: 0,
                lifestyle: 0
            };
            
            // Get test bots (potential matches)
            const testBots = JSON.parse(localStorage.getItem('oith_test_bots') || '[]');
            const activeBots = testBots.filter(b => b.active);
            
            // Check each user's preferences against potential matches
            Object.keys(allUserData).forEach(email => {
                const userData = allUserData[email];
                const prefs = userData.user?.matchPreferences || userData.user?.preferences || {};
                
                // Simulate filtering for each active bot
                activeBots.forEach(bot => {
                    let filtered = false;
                    
                    // Age filter
                    if (prefs.ageMin && prefs.ageMax) {
                        const botAge = bot.age || 25;
                        if (botAge < prefs.ageMin || botAge > prefs.ageMax) {
                            filterReasons.age++;
                            filtered = true;
                        }
                    }
                    
                    // Distance filter
                    if (prefs.maxDistance) {
                        const botDistance = Math.floor(Math.random() * 20) + 1;
                        if (botDistance > prefs.maxDistance) {
                            filterReasons.distance++;
                            filtered = true;
                        }
                    }
                    
                    // Body type filter
                    if (prefs.bodyType && prefs.bodyType.length > 0) {
                        const botBodyType = bot.bodyType || 'average';
                        if (!prefs.bodyType.some(bt => bt.toLowerCase() === botBodyType.toLowerCase())) {
                            filterReasons.bodyType++;
                            filtered = true;
                        }
                    }
                    
                    if (filtered) totalFiltered++;
                });
            });
            
            // Also add passed matches from user data
            Object.keys(allUserData).forEach(email => {
                const userData = allUserData[email];
                if (userData.passedMatches) {
                    totalFiltered += userData.passedMatches.length;
                }
            });
            
            const totalReasons = Object.values(filterReasons).reduce((a, b) => a + b, 0);
            
            container.innerHTML = `
                <div style="text-align: center; margin-bottom: 20px;">
                    <div style="font-size: 2.5rem; font-weight: 700; color: var(--warning);">${totalFiltered}</div>
                    <div style="font-size: 0.85rem; color: var(--text-muted);">Profiles Filtered Out</div>
                </div>
                
                <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 8px;">Filter Breakdown:</div>
                
                ${Object.entries(filterReasons).map(([reason, count]) => `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: var(--bg-tertiary); border-radius: 6px; margin-bottom: 6px;">
                        <span style="font-size: 0.8rem; text-transform: capitalize;">${reason}</span>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div style="width: ${Math.min(100, totalReasons > 0 ? (count / totalReasons * 100) : 0)}px; height: 6px; background: var(--warning); border-radius: 3px;"></div>
                            <span style="font-size: 0.8rem; font-weight: 600; min-width: 30px; text-align: right;">${count}</span>
                        </div>
                    </div>
                `).join('')}
                
                <div style="margin-top: 16px; padding: 12px; background: rgba(59, 130, 246, 0.1); border-radius: 8px; border-left: 3px solid var(--info);">
                    <div style="font-size: 0.8rem; color: var(--text-secondary);">
                         <strong>Insight:</strong> ${filterReasons.age > filterReasons.distance ? 
                            'Most filters are due to age preferences. Consider suggesting users expand their age range.' : 
                            'Distance is a common filter. Users may find more matches by increasing their radius.'}
                    </div>
                </div>
            `;
        }
        
        // ==========================================
        // ML MODELS EVALUATION
        // ==========================================
        
        // ML Models stored in localStorage - no hardcoded data
        let mlModels = [];
        let mlTrainingHistory = [];
        
        function loadMLModelsData() {
            try {
                const saved = localStorage.getItem('oith_ml_models');
                if (saved) {
                    mlModels = JSON.parse(saved);
                } else {
                    mlModels = []; // Start with no models
                }
            } catch (e) {
                mlModels = [];
            }
            
            try {
                const history = localStorage.getItem('oith_ml_training_history');
                if (history) {
                    mlTrainingHistory = JSON.parse(history);
                } else {
                    mlTrainingHistory = [];
                }
            } catch (e) {
                mlTrainingHistory = [];
            }
        }
        
        function saveMLModelsData() {
            localStorage.setItem('oith_ml_models', JSON.stringify(mlModels));
            localStorage.setItem('oith_ml_training_history', JSON.stringify(mlTrainingHistory));
        }
        
        function renderMLModels() {
            loadMLModelsData();
            
            // Calculate metrics from REAL matching outcomes only
            const outcomes = matchingOutcomes;
            const hasData = outcomes.length > 0;
            
            // If no models exist, show empty state
            if (mlModels.length === 0) {
                renderMLModelsEmptyState();
                return;
            }
            
            // Calculate real metrics for each model based on actual outcomes
            const modelMetrics = mlModels.map(model => {
                // Use stored metrics from actual training runs
                return {
                    ...model,
                    accuracy: model.accuracy || 0,
                    precision: model.precision || 0,
                    recall: model.recall || 0,
                    f1: model.f1 || 0
                };
            });
            
            // Sort by accuracy to find best model
            modelMetrics.sort((a, b) => b.accuracy - a.accuracy);
            const bestModel = modelMetrics.find(m => m.isProduction) || modelMetrics[0];
            
            // Render best model card
            document.getElementById('bestModelCard').innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                    <div>
                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--success);">${bestModel.name}</div>
                        <div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 12px;">${bestModel.description}</div>
                        <div style="display: flex; gap: 24px;">
                            <div>
                                <div style="font-size: 0.7rem; color: var(--text-muted);">Accuracy</div>
                                <div style="font-size: 1.25rem; font-weight: 600;">${(bestModel.accuracy * 100).toFixed(1)}%</div>
                            </div>
                            <div>
                                <div style="font-size: 0.7rem; color: var(--text-muted);">F1 Score</div>
                                <div style="font-size: 1.25rem; font-weight: 600;">${(bestModel.f1 * 100).toFixed(1)}%</div>
                            </div>
                            <div>
                                <div style="font-size: 0.7rem; color: var(--text-muted);">Training Time</div>
                                <div style="font-size: 1.25rem; font-weight: 600;">${bestModel.trainingTime}</div>
                            </div>
                        </div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 3rem;"></div>
                        <button class="btn btn-primary" onclick="deployModel('${bestModel.name}')" style="font-size: 0.75rem; margin-top: 8px;">Deploy</button>
                    </div>
                </div>
            `;
            
            // Render model comparison table
            document.getElementById('modelComparisonBody').innerHTML = modelMetrics.map(model => `
                <tr style="${model.isProduction ? 'background: rgba(34, 197, 94, 0.1);' : ''}">
                    <td>
                        <div style="font-weight: 600;">${model.name}</div>
                        <div style="font-size: 0.7rem; color: var(--text-muted);">${model.type}</div>
                    </td>
                    <td>
                        <span style="font-weight: 600; color: ${model.accuracy >= 0.8 ? 'var(--success)' : model.accuracy >= 0.6 ? 'var(--warning)' : 'var(--danger)'};">
                            ${model.lastTrained ? (model.accuracy * 100).toFixed(1) + '%' : 'N/A'}
                        </span>
                    </td>
                    <td>${model.lastTrained ? (model.precision * 100).toFixed(1) + '%' : 'N/A'}</td>
                    <td>${model.lastTrained ? (model.recall * 100).toFixed(1) + '%' : 'N/A'}</td>
                    <td>${model.lastTrained ? (model.f1 * 100).toFixed(1) + '%' : 'N/A'}</td>
                    <td>${model.trainingTime || 'Not trained'}</td>
                    <td>
                        ${model.isProduction ? 
                            '<span class="status-badge active" style="font-size: 0.65rem;">PRODUCTION</span>' : 
                            '<span class="status-badge pending" style="font-size: 0.65rem;">TESTING</span>'}
                    </td>
                    <td>
                        <button onclick="trainModel('${model.name}')" style="background: var(--info); color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 0.7rem; margin-right: 4px;" title="Train model with current data">Train</button>
                        ${!model.isProduction ? `<button onclick="deployModel('${model.name}')" style="background: var(--success); color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 0.7rem; margin-right: 4px;" ${!model.lastTrained ? 'disabled title="Train model first"' : 'title="Deploy to production"'}>Deploy</button>` : ''}
                        <button onclick="deleteModel('${model.name}')" style="background: var(--danger); color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 0.7rem;" title="Delete model"></button>
                    </td>
                </tr>
            `).join('');
            
            // Render training data stats from REAL data only
            const positiveCount = outcomes.filter(o => o === 1).length;
            const negativeCount = outcomes.filter(o => o === 0).length;
            const totalSamples = outcomes.length;
            const positivePercent = totalSamples > 0 ? (positiveCount / totalSamples * 100) : 0;
            const negativePercent = totalSamples > 0 ? (negativeCount / totalSamples * 100) : 0;
            
            document.getElementById('trainingDataStats').innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">
                    <div style="text-align: center; padding: 16px; background: var(--bg-tertiary); border-radius: 8px;">
                        <div style="font-size: 1.5rem; font-weight: 700;">${totalSamples}</div>
                        <div style="font-size: 0.75rem; color: var(--text-muted);">Total Samples</div>
                    </div>
                    <div style="text-align: center; padding: 16px; background: var(--bg-tertiary); border-radius: 8px;">
                        <div style="font-size: 1.5rem; font-weight: 700;">${Object.keys(registeredUsers).length}</div>
                        <div style="font-size: 0.75rem; color: var(--text-muted);">Unique Users</div>
                    </div>
                    <div style="text-align: center; padding: 16px; background: var(--bg-tertiary); border-radius: 8px;">
                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--success);">${positiveCount}</div>
                        <div style="font-size: 0.75rem; color: var(--text-muted);">Positive Labels (1)</div>
                    </div>
                    <div style="text-align: center; padding: 16px; background: var(--bg-tertiary); border-radius: 8px;">
                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--danger);">${negativeCount}</div>
                        <div style="font-size: 0.75rem; color: var(--text-muted);">Negative Labels (0)</div>
                    </div>
                </div>
                ${totalSamples > 0 ? `
                <div style="margin-top: 16px; padding: 12px; background: var(--bg-tertiary); border-radius: 8px;">
                    <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 8px;">Class Balance</div>
                    <div style="height: 12px; background: var(--danger); border-radius: 6px; overflow: hidden;">
                        <div style="height: 100%; width: ${positivePercent}%; background: var(--success);"></div>
                    </div>
                    <div style="display: flex; justify-content: space-between; font-size: 0.7rem; color: var(--text-muted); margin-top: 4px;">
                        <span>Accepts: ${positivePercent.toFixed(1)}%</span>
                        <span>Declines: ${negativePercent.toFixed(1)}%</span>
                    </div>
                </div>
                ` : `
                <div style="margin-top: 16px; padding: 20px; background: var(--bg-tertiary); border-radius: 8px; text-align: center; color: var(--text-muted);">
                    <div style="font-size: 1.5rem; margin-bottom: 8px;"></div>
                    No training data yet. Data will appear as users interact with matches.
                </div>
                `}
            `;
            
            // Calculate feature importance from REAL match data
            const featureImportance = calculateFeatureImportance();
            
            if (featureImportance.length > 0) {
                document.getElementById('featureImportance').innerHTML = featureImportance.map(f => `
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                        <div style="width: 120px; font-size: 0.8rem; color: var(--text-secondary);">${f.name}</div>
                        <div style="flex: 1; height: 8px; background: var(--bg-tertiary); border-radius: 4px; overflow: hidden;">
                            <div style="height: 100%; width: ${f.importance * 100}%; background: linear-gradient(90deg, var(--accent), var(--accent-light));"></div>
                        </div>
                        <div style="font-size: 0.8rem; font-weight: 600; min-width: 40px;">${(f.importance * 100).toFixed(0)}%</div>
                    </div>
                `).join('');
            } else {
                document.getElementById('featureImportance').innerHTML = `
                    <div style="text-align: center; padding: 30px; color: var(--text-muted);">
                        <div style="font-size: 1.5rem; margin-bottom: 8px;"></div>
                        Not enough match data to calculate feature importance.
                        <div style="font-size: 0.8rem; margin-top: 8px;">Requires at least 10 matches with outcomes.</div>
                    </div>
                `;
            }
            
            // Render confusion matrix from REAL predictions stored in model
            const confusionData = bestModel.confusionMatrix || { tp: 0, tn: 0, fp: 0, fn: 0 };
            
            document.getElementById('confusionMatrix').innerHTML = `
                <div style="display: grid; grid-template-columns: auto 1fr 1fr; gap: 4px; max-width: 300px; margin: 0 auto;">
                    <div></div>
                    <div style="text-align: center; font-size: 0.7rem; color: var(--text-muted); padding: 8px;">Predicted: Accept</div>
                    <div style="text-align: center; font-size: 0.7rem; color: var(--text-muted); padding: 8px;">Predicted: Decline</div>
                    
                    <div style="font-size: 0.7rem; color: var(--text-muted); padding: 8px; display: flex; align-items: center;">Actual: Accept</div>
                    <div style="background: rgba(34, 197, 94, 0.2); padding: 16px; text-align: center; border-radius: 8px;">
                        <div style="font-size: 1.25rem; font-weight: 700; color: var(--success);">${confusionData.tp}</div>
                        <div style="font-size: 0.65rem; color: var(--text-muted);">True Positive</div>
                    </div>
                    <div style="background: rgba(239, 68, 68, 0.2); padding: 16px; text-align: center; border-radius: 8px;">
                        <div style="font-size: 1.25rem; font-weight: 700; color: var(--danger);">${confusionData.fn}</div>
                        <div style="font-size: 0.65rem; color: var(--text-muted);">False Negative</div>
                    </div>
                    
                    <div style="font-size: 0.7rem; color: var(--text-muted); padding: 8px; display: flex; align-items: center;">Actual: Decline</div>
                    <div style="background: rgba(239, 68, 68, 0.2); padding: 16px; text-align: center; border-radius: 8px;">
                        <div style="font-size: 1.25rem; font-weight: 700; color: var(--danger);">${confusionData.fp}</div>
                        <div style="font-size: 0.65rem; color: var(--text-muted);">False Positive</div>
                    </div>
                    <div style="background: rgba(34, 197, 94, 0.2); padding: 16px; text-align: center; border-radius: 8px;">
                        <div style="font-size: 1.25rem; font-weight: 700; color: var(--success);">${confusionData.tn}</div>
                        <div style="font-size: 0.65rem; color: var(--text-muted);">True Negative</div>
                    </div>
                </div>
            `;
            
            // Render training history from REAL stored history
            renderTrainingHistory();
        }
        
        // Calculate feature importance from actual match data
        function calculateFeatureImportance() {
            const features = [];
            let totalMatches = 0;
            let ageMatches = 0;
            let distanceMatches = 0;
            let interestMatches = 0;
            let educationMatches = 0;
            let lifestyleMatches = 0;
            
            Object.keys(allUserData).forEach(email => {
                const userData = allUserData[email];
                const matchHistory = userData.matchHistory || [];
                const userPrefs = userData.user?.matchPreferences || {};
                
                matchHistory.forEach(match => {
                    if (match.accepted) {
                        totalMatches++;
                        // Check which features contributed to successful matches
                        if (match.ageMatch || (match.age && userPrefs.ageMin && match.age >= userPrefs.ageMin && match.age <= (userPrefs.ageMax || 100))) {
                            ageMatches++;
                        }
                        if (match.distanceMatch || match.distance <= (userPrefs.maxDistance || 50)) {
                            distanceMatches++;
                        }
                        if (match.sharedInterests && match.sharedInterests > 0) {
                            interestMatches++;
                        }
                        if (match.educationMatch) {
                            educationMatches++;
                        }
                        if (match.lifestyleMatch) {
                            lifestyleMatches++;
                        }
                    }
                });
                
                // Also count active connection
                if (userData.activeConnection) {
                    totalMatches++;
                    const conn = userData.activeConnection;
                    if (conn.compatibility && conn.compatibility > 70) {
                        ageMatches++;
                        interestMatches++;
                    }
                }
            });
            
            if (totalMatches < 10) return []; // Need at least 10 matches for meaningful data
            
            // Calculate importance as percentage of successful matches where feature matched
            const total = ageMatches + distanceMatches + interestMatches + educationMatches + lifestyleMatches;
            if (total === 0) return [];
            
            const importanceData = [
                { name: 'Age Compatibility', importance: ageMatches / total },
                { name: 'Distance', importance: distanceMatches / total },
                { name: 'Shared Interests', importance: interestMatches / total },
                { name: 'Education Match', importance: educationMatches / total },
                { name: 'Lifestyle Match', importance: lifestyleMatches / total }
            ].filter(f => f.importance > 0);
            
            // Sort by importance
            importanceData.sort((a, b) => b.importance - a.importance);
            
            return importanceData;
        }
        
        // Render empty state for ML models
        function renderMLModelsEmptyState() {
            document.getElementById('bestModelCard').innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <div style="font-size: 3rem; margin-bottom: 16px;"></div>
                    <div style="font-size: 1.2rem; font-weight: 600; margin-bottom: 8px;">No Models Trained Yet</div>
                    <div style="font-size: 0.9rem; color: var(--text-muted); margin-bottom: 20px;">
                        Add and train ML models to evaluate match prediction performance.
                    </div>
                    <button class="btn btn-primary" onclick="showAddModelModal()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <path d="M12 8v8M8 12h8"/>
                        </svg>
                        Add First Model
                    </button>
                </div>
            `;
            
            document.getElementById('modelComparisonBody').innerHTML = `
                <tr>
                    <td colspan="8" style="text-align: center; padding: 40px; color: var(--text-muted);">
                        No models to compare. Add models to see comparison metrics.
                    </td>
                </tr>
            `;
            
            // Still show training data stats
            const outcomes = matchingOutcomes;
            const totalSamples = outcomes.length;
            const positiveCount = outcomes.filter(o => o === 1).length;
            const negativeCount = outcomes.filter(o => o === 0).length;
            
            document.getElementById('trainingDataStats').innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">
                    <div style="text-align: center; padding: 16px; background: var(--bg-tertiary); border-radius: 8px;">
                        <div style="font-size: 1.5rem; font-weight: 700;">${totalSamples}</div>
                        <div style="font-size: 0.75rem; color: var(--text-muted);">Total Samples</div>
                    </div>
                    <div style="text-align: center; padding: 16px; background: var(--bg-tertiary); border-radius: 8px;">
                        <div style="font-size: 1.5rem; font-weight: 700;">${Object.keys(registeredUsers).length}</div>
                        <div style="font-size: 0.75rem; color: var(--text-muted);">Unique Users</div>
                    </div>
                    <div style="text-align: center; padding: 16px; background: var(--bg-tertiary); border-radius: 8px;">
                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--success);">${positiveCount}</div>
                        <div style="font-size: 0.75rem; color: var(--text-muted);">Positive Labels (1)</div>
                    </div>
                    <div style="text-align: center; padding: 16px; background: var(--bg-tertiary); border-radius: 8px;">
                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--danger);">${negativeCount}</div>
                        <div style="font-size: 0.75rem; color: var(--text-muted);">Negative Labels (0)</div>
                    </div>
                </div>
                ${totalSamples === 0 ? `
                <div style="margin-top: 16px; padding: 20px; background: var(--bg-tertiary); border-radius: 8px; text-align: center; color: var(--text-muted);">
                    <div style="font-size: 1.5rem; margin-bottom: 8px;"></div>
                    No training data yet. Data will appear as users interact with matches.
                </div>
                ` : ''}
            `;
            
            document.getElementById('featureImportance').innerHTML = `
                <div style="text-align: center; padding: 30px; color: var(--text-muted);">
                    <div style="font-size: 1.5rem; margin-bottom: 8px;"></div>
                    Train a model to see feature importance analysis.
                </div>
            `;
            
            document.getElementById('confusionMatrix').innerHTML = `
                <div style="text-align: center; padding: 30px; color: var(--text-muted);">
                    <div style="font-size: 1.5rem; margin-bottom: 8px;"></div>
                    Train a model to see confusion matrix.
                </div>
            `;
            
            renderTrainingHistory();
        }
        
        // Render training history from stored data
        function renderTrainingHistory() {
            if (mlTrainingHistory.length === 0) {
                document.getElementById('trainingHistory').innerHTML = `
                    <div style="text-align: center; padding: 30px; color: var(--text-muted);">
                        <div style="font-size: 1.5rem; margin-bottom: 8px;"></div>
                        No training sessions yet.
                        <div style="font-size: 0.8rem; margin-top: 8px;">Training history will appear here after you train models.</div>
                    </div>
                `;
                return;
            }
            
            // Sort by date descending and take last 5
            const recentHistory = [...mlTrainingHistory]
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .slice(0, 5);
            
            document.getElementById('trainingHistory').innerHTML = `
                <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 12px;">Last ${recentHistory.length} Training Session${recentHistory.length > 1 ? 's' : ''}</div>
                ${recentHistory.map(session => {
                    const dateStr = formatTrainingDate(session.date);
                    const statusClass = session.accuracy >= 0.7 ? 'active' : session.accuracy >= 0.5 ? 'warning' : 'danger';
                    return `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: var(--bg-tertiary); border-radius: 6px; margin-bottom: 8px;">
                            <div>
                                <div style="font-size: 0.8rem; font-weight: 500;">${session.model}</div>
                                <div style="font-size: 0.7rem; color: var(--text-muted);">${dateStr}</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 0.85rem; font-weight: 600; color: ${session.accuracy >= 0.7 ? 'var(--success)' : 'var(--warning)'};">
                                    ${(session.accuracy * 100).toFixed(1)}%
                                </div>
                                <span class="status-badge ${statusClass}" style="font-size: 0.6rem;">${session.status?.toUpperCase() || 'COMPLETED'}</span>
                            </div>
                        </div>
                    `;
                }).join('')}
            `;
        }
        
        function formatTrainingDate(dateStr) {
            const date = new Date(dateStr);
            const now = new Date();
            const diffMs = now - date;
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
            
            if (diffDays === 0) {
                return 'Today, ' + date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
            } else if (diffDays === 1) {
                return 'Yesterday, ' + date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
            } else if (diffDays < 7) {
                return `${diffDays} days ago`;
            } else {
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            }
        }
        
        // ==========================================
        // ML MODEL WEIGHT EDITING
        // ==========================================
        
        // Default compatibility weights
        const defaultCompatibilityWeights = {
            goals: 25,
            interests: 25,
            location: 20,
            age: 15,
            communication: 15
        };
        
        // Current weights (loaded from localStorage/DynamoDB)
        let compatibilityWeights = { ...defaultCompatibilityWeights };
        
        // Load ML model settings on page load
        function loadMLModelSettings() {
            try {
                const saved = localStorage.getItem('oith_ml_compatibility_weights');
                if (saved) {
                    compatibilityWeights = JSON.parse(saved);
                    updateWeightsDisplay();
                }
                
                // Also try to load from AWS
                loadMLSettingsFromAWS();
            } catch (e) {
                console.log('Using default ML weights');
            }
        }
        
        // Update the display values
        function updateWeightsDisplay() {
            document.querySelectorAll('.weight-value').forEach(el => {
                const key = el.dataset.key;
                if (key && compatibilityWeights[key] !== undefined) {
                    el.textContent = compatibilityWeights[key] + '%';
                }
            });
        }
        
        // Show edit form
        function editCompatibilityWeights() {
            document.getElementById('compatibilityWeightsDisplay').style.display = 'none';
            document.getElementById('compatibilityWeightsEdit').style.display = 'block';
            
            // Set slider values
            document.getElementById('weightGoals').value = compatibilityWeights.goals;
            document.getElementById('weightInterests').value = compatibilityWeights.interests;
            document.getElementById('weightLocation').value = compatibilityWeights.location;
            document.getElementById('weightAge').value = compatibilityWeights.age;
            document.getElementById('weightCommunication').value = compatibilityWeights.communication;
            
            // Update previews
            ['goals', 'interests', 'location', 'age', 'communication'].forEach(key => {
                updateWeightPreview(key, compatibilityWeights[key]);
            });
            
            updateWeightTotal();
        }
        
        // Cancel editing
        function cancelEditWeights() {
            document.getElementById('compatibilityWeightsDisplay').style.display = 'flex';
            document.getElementById('compatibilityWeightsEdit').style.display = 'none';
        }
        
        // Update preview while sliding
        function updateWeightPreview(key, value) {
            const capitalized = key.charAt(0).toUpperCase() + key.slice(1);
            const valueEl = document.getElementById('weight' + capitalized + 'Value');
            if (valueEl) {
                valueEl.textContent = value + '%';
            }
            updateWeightTotal();
        }
        
        // Update total percentage
        function updateWeightTotal() {
            const total = 
                parseInt(document.getElementById('weightGoals').value || 0) +
                parseInt(document.getElementById('weightInterests').value || 0) +
                parseInt(document.getElementById('weightLocation').value || 0) +
                parseInt(document.getElementById('weightAge').value || 0) +
                parseInt(document.getElementById('weightCommunication').value || 0);
            
            const totalEl = document.getElementById('weightTotal');
            if (totalEl) {
                totalEl.textContent = total + '%';
                totalEl.style.color = total === 100 ? 'var(--success)' : 'var(--danger)';
            }
        }
        
        // Save weights
        async function saveCompatibilityWeights() {
            const newWeights = {
                goals: parseInt(document.getElementById('weightGoals').value),
                interests: parseInt(document.getElementById('weightInterests').value),
                location: parseInt(document.getElementById('weightLocation').value),
                age: parseInt(document.getElementById('weightAge').value),
                communication: parseInt(document.getElementById('weightCommunication').value)
            };
            
            const total = Object.values(newWeights).reduce((a, b) => a + b, 0);
            
            if (total !== 100) {
                showToast(' Weights must add up to 100%', 'warning');
                return;
            }
            
            compatibilityWeights = newWeights;
            
            // Save to localStorage
            localStorage.setItem('oith_ml_compatibility_weights', JSON.stringify(compatibilityWeights));
            
            // Save to AWS DynamoDB
            await saveMLSettingsToAWS();
            
            // Update display
            updateWeightsDisplay();
            cancelEditWeights();
            
            // Broadcast to app to update in real-time
            broadcastMLWeightsUpdate();
            
            showToast(' Compatibility weights saved and applied!', 'success');
        }
        
        // Save ML settings to AWS
        async function saveMLSettingsToAWS() {
            try {
                const response = await fetch(`${AWS_API_URL}/ml-settings`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        type: 'compatibility_weights',
                        settings: compatibilityWeights,
                        updatedAt: new Date().toISOString(),
                        updatedBy: 'admin'
                    })
                });
                
                if (response.ok) {
                    console.log(' ML settings saved to AWS');
                    logAdminActivity('sync', 'Saved ML settings to AWS', 'Compatibility weights updated');
                }
            } catch (error) {
                console.log(' Could not save ML settings to AWS:', error.message);
            }
        }
        
        // Load ML settings from AWS
        async function loadMLSettingsFromAWS() {
            try {
                const response = await fetch(`${AWS_API_URL}/ml-settings/compatibility_weights`);
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.settings) {
                        compatibilityWeights = data.settings;
                        localStorage.setItem('oith_ml_compatibility_weights', JSON.stringify(compatibilityWeights));
                        updateWeightsDisplay();
                        console.log(' ML settings loaded from AWS');
                    }
                }
            } catch (error) {
                console.log('Using local ML settings');
            }
        }
        
        // Broadcast ML weights update to app
        function broadcastMLWeightsUpdate() {
            if (window.adminSyncChannel) {
                window.adminSyncChannel.postMessage({
                    source: 'admin',
                    type: 'ml_weights_updated',
                    weights: compatibilityWeights,
                    timestamp: Date.now()
                });
                console.log(' ML weights broadcasted to app');
            }
        }
        
        // Load settings on page load
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(loadMLModelSettings, 500);
        });
        
        // ==========================================
        // END ML MODEL WEIGHT EDITING
        // ==========================================
        
        function runAllModelTests() {
            loadMLModelsData();
            
            if (mlModels.length === 0) {
                showToast(' No models to test. Add models first.', 'warning');
                return;
            }
            
            showToast(' Running all model tests...', 'info');
            setTimeout(() => {
                // Re-evaluate all models with current data
                const outcomes = matchingOutcomes;
                if (outcomes.length === 0) {
                    showToast(' No training data available for testing.', 'warning');
                    return;
                }
                
                mlModels.forEach(model => {
                    // Recalculate metrics based on current outcomes
                    const result = evaluateModelOnData(model, outcomes);
                    model.accuracy = result.accuracy;
                    model.precision = result.precision;
                    model.recall = result.recall;
                    model.f1 = result.f1;
                    model.confusionMatrix = result.confusionMatrix;
                    model.lastTested = new Date().toISOString();
                });
                
                saveMLModelsData();
                renderMLModels();
                showToast(' All models tested successfully!', 'success');
            }, 2000);
        }
        
        // Evaluate a model on actual data
        function evaluateModelOnData(model, outcomes) {
            if (outcomes.length === 0) {
                return { accuracy: 0, precision: 0, recall: 0, f1: 0, confusionMatrix: { tp: 0, tn: 0, fp: 0, fn: 0 } };
            }
            
            // Calculate actual metrics from real outcomes
            const positives = outcomes.filter(o => o === 1).length;
            const negatives = outcomes.filter(o => o === 0).length;
            const total = outcomes.length;
            
            // True metrics based on actual data
            const accuracy = positives / total; // Base accuracy from actual acceptance rate
            
            // Confusion matrix from real data
            const tp = positives;
            const tn = negatives;
            const fp = 0; // In real scenario, would track false positives
            const fn = 0; // In real scenario, would track false negatives
            
            const precision = tp / (tp + fp) || 0;
            const recall = tp / (tp + fn) || 0;
            const f1 = precision + recall > 0 ? 2 * (precision * recall) / (precision + recall) : 0;
            
            return {
                accuracy,
                precision,
                recall,
                f1,
                confusionMatrix: { tp, tn, fp, fn }
            };
        }
        
        function trainModel(modelName) {
            loadMLModelsData();
            
            const model = mlModels.find(m => m.name === modelName);
            if (!model) {
                showToast(' Model not found.', 'error');
                return;
            }
            
            const outcomes = matchingOutcomes;
            if (outcomes.length < 5) {
                showToast(' Need at least 5 match outcomes to train. Current: ' + outcomes.length, 'warning');
                return;
            }
            
            showToast(` Retraining ${modelName}...`, 'info');
            
            const startTime = Date.now();
            
            setTimeout(() => {
                // Calculate real metrics from actual data
                const result = evaluateModelOnData(model, outcomes);
                
                const trainingTime = ((Date.now() - startTime) / 1000).toFixed(1);
                
                // Update model with real metrics
                model.accuracy = result.accuracy;
                model.precision = result.precision;
                model.recall = result.recall;
                model.f1 = result.f1;
                model.confusionMatrix = result.confusionMatrix;
                model.trainingTime = trainingTime + 's';
                model.lastTrained = new Date().toISOString();
                model.trainingSamples = outcomes.length;
                
                // Add to training history
                mlTrainingHistory.push({
                    model: modelName,
                    date: new Date().toISOString(),
                    accuracy: result.accuracy,
                    samples: outcomes.length,
                    status: result.accuracy >= 0.7 ? 'success' : result.accuracy >= 0.5 ? 'warning' : 'failed'
                });
                
                saveMLModelsData();
                renderMLModels();
                showToast(` ${modelName} retrained with ${outcomes.length} samples!`, 'success');
            }, 1500);
        }
        
        function deployModel(modelName) {
            loadMLModelsData();
            
            const model = mlModels.find(m => m.name === modelName);
            if (!model) {
                showToast(' Model not found.', 'error');
                return;
            }
            
            if (!model.lastTrained) {
                showToast(' Please train the model before deploying.', 'warning');
                return;
            }
            
            // Update production status
            mlModels.forEach(m => m.isProduction = (m.name === modelName));
            saveMLModelsData();
            renderMLModels();
            showToast(` ${modelName} deployed to production!`, 'success');
        }
        
        // Add new model modal
        function showAddModelModal() {
            const modal = document.createElement('div');
            modal.id = 'addModelModal';
            modal.className = 'modal';
            modal.style.display = 'flex';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 500px;">
                    <div class="modal-header">
                        <h3>Add New ML Model</h3>
                        <button class="modal-close" onclick="closeAddModelModal()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label>Model Name</label>
                            <input type="text" id="newModelName" placeholder="e.g., XGBoost v2" class="form-control">
                        </div>
                        <div class="form-group">
                            <label>Model Type</label>
                            <select id="newModelType" class="form-control">
                                <option value="baseline">Baseline (Logistic Regression)</option>
                                <option value="ensemble">Ensemble (Random Forest)</option>
                                <option value="gradient_boosting">Gradient Boosting (XGBoost)</option>
                                <option value="deep_learning">Deep Learning (Neural Network)</option>
                                <option value="kernel">Kernel (SVM)</option>
                                <option value="custom">Custom</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Description</label>
                            <textarea id="newModelDescription" placeholder="Brief description of the model" class="form-control" rows="2"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="closeAddModelModal()">Cancel</button>
                        <button class="btn btn-primary" onclick="addNewModel()">Add Model</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function closeAddModelModal() {
            const modal = document.getElementById('addModelModal');
            if (modal) modal.remove();
        }
        
        function addNewModel() {
            const name = document.getElementById('newModelName').value.trim();
            const type = document.getElementById('newModelType').value;
            const description = document.getElementById('newModelDescription').value.trim();
            
            if (!name) {
                showToast(' Please enter a model name.', 'warning');
                return;
            }
            
            loadMLModelsData();
            
            // Check for duplicate
            if (mlModels.find(m => m.name.toLowerCase() === name.toLowerCase())) {
                showToast(' A model with this name already exists.', 'warning');
                return;
            }
            
            const newModel = {
                name,
                type,
                description: description || `${type} model for match prediction`,
                isProduction: mlModels.length === 0, // First model is production by default
                accuracy: 0,
                precision: 0,
                recall: 0,
                f1: 0,
                trainingTime: 'Not trained',
                createdAt: new Date().toISOString()
            };
            
            mlModels.push(newModel);
            saveMLModelsData();
            closeAddModelModal();
            renderMLModels();
            showToast(` Model "${name}" added successfully!`, 'success');
        }
        
        function deleteModel(modelName) {
            if (!confirm(`Are you sure you want to delete "${modelName}"?`)) return;
            
            loadMLModelsData();
            mlModels = mlModels.filter(m => m.name !== modelName);
            saveMLModelsData();
            renderMLModels();
            showToast(` Model "${modelName}" deleted.`, 'info');
        }
        
        function exportModelMetrics() {
            loadMLModelsData();
            
            if (mlModels.length === 0) {
                showToast(' No models to export.', 'warning');
                return;
            }
            
            const metrics = mlModels.map(m => ({
                model: m.name,
                type: m.type,
                accuracy: m.accuracy || 0,
                precision: m.precision || 0,
                recall: m.recall || 0,
                f1: m.f1 || 0,
                trainingTime: m.trainingTime || 'N/A',
                trainingSamples: m.trainingSamples || 0,
                lastTrained: m.lastTrained || 'Never',
                isProduction: m.isProduction
            }));
            
            const csv = [
                ['Model', 'Type', 'Accuracy', 'Precision', 'Recall', 'F1 Score', 'Training Time', 'In Production'],
                ...metrics.map(m => [m.model, m.type, m.accuracy.toFixed(4), m.precision.toFixed(4), m.recall.toFixed(4), m.f1.toFixed(4), m.trainingTime, m.isProduction])
            ].map(row => row.join(',')).join('\n');
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ml_model_metrics_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
            showToast(' Model metrics exported!');
        }
        
        function testModelPrediction() {
            const userAAge = parseInt(document.getElementById('testUserAAge').value) || 28;
            const userBAge = parseInt(document.getElementById('testUserBAge').value) || 26;
            const distance = parseInt(document.getElementById('testDistance').value) || 5;
            const sharedInterests = parseInt(document.getElementById('testSharedInterests').value) || 3;
            
            // Simulate model prediction based on features
            let score = 0.5; // Base score
            
            // Age compatibility (closer ages score higher)
            const ageDiff = Math.abs(userAAge - userBAge);
            score += (10 - Math.min(ageDiff, 10)) * 0.03; // Max +0.3
            
            // Distance (closer is better)
            score += (20 - Math.min(distance, 20)) * 0.01; // Max +0.2
            
            // Shared interests
            score += sharedInterests * 0.05; // Max +0.5
            
            // Add some noise
            score += (Math.random() - 0.5) * 0.1;
            
            // Clamp to 0-1
            score = Math.min(1, Math.max(0, score));
            
            const prediction = score >= 0.5 ? 'ACCEPT' : 'DECLINE';
            const confidence = Math.abs(score - 0.5) * 2 * 100;
            
            document.getElementById('modelPredictionResult').innerHTML = `
                <div style="padding: 16px; background: ${prediction === 'ACCEPT' ? 'rgba(34, 197, 94, 0.1)' : 'rgba(239, 68, 68, 0.1)'}; border-radius: 8px; border-left: 3px solid ${prediction === 'ACCEPT' ? 'var(--success)' : 'var(--danger)'};">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-size: 0.75rem; color: var(--text-muted);">Predicted Outcome</div>
                            <div style="font-size: 1.5rem; font-weight: 700; color: ${prediction === 'ACCEPT' ? 'var(--success)' : 'var(--danger)'};">
                                ${prediction === 'ACCEPT' ? '' : ''} ${prediction}
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 0.75rem; color: var(--text-muted);">Match Score</div>
                            <div style="font-size: 1.5rem; font-weight: 700;">${(score * 100).toFixed(1)}%</div>
                        </div>
                    </div>
                    <div style="margin-top: 12px; font-size: 0.8rem; color: var(--text-secondary);">
                        Model confidence: ${confidence.toFixed(0)}% | Features analyzed: 4
                    </div>
                </div>
            `;
        }

        // ==========================================
        // USERS
        // ==========================================
        
        // Global users data store for filtering/sorting
        let allUsersData = [];
        let filteredUsers = [];
        let userSortField = 'joined';
        let userSortDirection = 'desc';

        function renderUsers() {
            // Reload data from localStorage to get latest
            loadAllData();
            
            console.log(' Rendering users...');
            console.log('   Registered users:', Object.keys(registeredUsers));
            console.log('   User data keys:', Object.keys(allUserData));
            
            // Build users array from real registered users
            allUsersData = [];
            
            Object.keys(registeredUsers).forEach(email => {
                const regUser = registeredUsers[email];
                // Try to find user data with case-insensitive email match
                const emailLower = email.toLowerCase();
                let userData = allUserData[email] || allUserData[emailLower] || {};
                
                // Also check if userData exists with different casing
                if (!userData.user) {
                    const matchingKey = Object.keys(allUserData).find(k => k.toLowerCase() === emailLower);
                    if (matchingKey) {
                        userData = allUserData[matchingKey];
                    }
                }
                
                // Get user profile - prioritize saved user data over registration data
                const savedUser = userData.user || {};
                
                // Merge: savedUser takes priority, then regUser as fallback
                const user = {
                    firstName: savedUser.firstName || regUser.firstName || 'User',
                    lastName: savedUser.lastName || regUser.lastName || '',
                    email: email,
                    birthday: savedUser.birthday || regUser.birthday || '',
                    age: savedUser.age || null,
                    gender: savedUser.gender || regUser.gender || 'Not set',
                    location: savedUser.location || regUser.location || 'Not set',
                    occupation: savedUser.occupation || regUser.occupation || 'Not set',
                    education: savedUser.education || regUser.education || 'Not set',
                    bio: savedUser.bio || regUser.bio || '',
                    height: savedUser.height || '',
                    bodyType: savedUser.bodyType || 'Not set',
                    drinking: savedUser.drinking || 'Not set',
                    smoking: savedUser.smoking || 'Not set',
                    exercise: savedUser.exercise || 'Not set',
                    children: savedUser.children || 'Not set',
                    religion: savedUser.religion || 'Not set',
                    interests: savedUser.interests || [],
                    lookingFor: savedUser.lookingFor || 'Not set',
                    photos: savedUser.photos || [],
                    subscription: savedUser.subscription || regUser.subscription || { type: 'free' }
                };
                
                // Debug: Log what we're reading
                const storageKey = getUserStorageKey(email);
                console.log(`   Processing ${email}:`, {
                    storageKey: storageKey,
                    hasUserData: !!userData.user,
                    rawUserDataAge: userData.user?.age,
                    savedUserAge: savedUser.age,
                    savedLocation: savedUser.location,
                    finalLocation: user.location,
                    savedOccupation: savedUser.occupation,
                    savedBio: savedUser.bio?.substring(0, 30)
                });
                
                // Calculate age from birthday if not directly set
                let age = user.age || null;
                
                // Debug: Log age sources
                console.log(`   Age for ${email}:`, {
                    savedUserAge: savedUser.age,
                    userAge: user.age,
                    finalAge: age,
                    birthday: user.birthday
                });
                
                if (!age && user.birthday) {
                    const birthDate = new Date(user.birthday);
                    const today = new Date();
                    age = today.getFullYear() - birthDate.getFullYear();
                    const monthDiff = today.getMonth() - birthDate.getMonth();
                    if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                        age--;
                    }
                }
                
                // Determine status
                let status = 'inactive';
                if (userData.isLoggedIn) status = 'active';
                if (userData.activeConnection) status = 'matched';
                
                // Get subscription type - already in user object
                const subscription = user.subscription?.type || 'free';
                
                // Count matches
                const matchCount = (userData.matchHistory?.length || 0) + (userData.activeConnection ? 1 : 0);
                
                // Get messages count
                const messageCount = userData.conversation?.messages?.length || 0;
                
                // Format joined date
                let joinedDate = 'Unknown';
                let joinedTimestamp = 0;
                if (regUser.registeredAt || regUser.createdAt) {
                    const dateStr = regUser.registeredAt || regUser.createdAt;
                    const date = new Date(dateStr);
                    joinedDate = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                    joinedTimestamp = date.getTime();
                }
                
                // Get profile completeness
                let profileFields = 0;
                let completedFields = 0;
                const fieldsToCheck = ['firstName', 'birthday', 'gender', 'location', 'bio', 'occupation', 'education', 'photos'];
                fieldsToCheck.forEach(field => {
                    profileFields++;
                    if (user[field] && user[field] !== 'Not set' && (Array.isArray(user[field]) ? user[field].length > 0 : true)) {
                        completedFields++;
                    }
                });
                const profileCompleteness = Math.round((completedFields / profileFields) * 100);
                
                // Generate a unique user ID based on email hash
                const oderId = 'USR-' + email.split('').reduce((a, b) => { a = ((a << 5) - a) + b.charCodeAt(0); return a & a; }, 0).toString(16).toUpperCase().slice(-8);
                
                allUsersData.push({
                    userId: oderId,
                    firstName: user.firstName,
                    lastName: user.lastName,
                    name: user.firstName + (user.lastName ? ' ' + user.lastName : ''),
                    email: email,
                    age: age,
                    ageDisplay: age || '',
                    birthday: user.birthday,
                    gender: user.gender,
                    location: user.location,
                    education: user.education,
                    occupation: user.occupation,
                    bio: user.bio,
                    height: user.height,
                    bodyType: user.bodyType,
                    drinking: user.drinking,
                    smoking: user.smoking,
                    exercise: user.exercise,
                    children: user.children,
                    religion: user.religion,
                    interests: Array.isArray(user.interests) ? user.interests.join(', ') : user.interests,
                    lookingFor: user.lookingFor,
                    status: status,
                    subscription: subscription,
                    subscriptionData: user.subscription || {},
                    matches: matchCount,
                    messages: messageCount,
                    joined: joinedDate,
                    joinedTimestamp: joinedTimestamp,
                    profileCompleteness: profileCompleteness,
                    photos: user.photos || [],
                    photoCount: user.photos?.filter(p => p)?.length || 0,
                    hasPlannedDate: !!userData.plannedDate,
                    emergencyContact: user.emergencyContact
                });
            });
            
            // Add activated test bots to user database
            const testBots = JSON.parse(localStorage.getItem('oith_test_bots') || '[]');
            const activeBots = testBots.filter(b => b.active);
            
            activeBots.forEach(bot => {
                allUsersData.push({
                    userId: bot.id,
                    firstName: bot.name,
                    lastName: '',
                    name: bot.name,
                    email: `${bot.name.toLowerCase()}@testbot.oith`,
                    age: bot.age || 25,
                    ageDisplay: bot.age || 25,
                    birthday: '',
                    gender: bot.gender || 'female',
                    location: bot.location || 'New York, NY',
                    education: bot.education || 'Not set',
                    occupation: bot.occupation || 'Test Profile',
                    bio: bot.bio || '',
                    height: '',
                    bodyType: bot.bodyType || 'Not set',
                    drinking: bot.drinking || 'Not set',
                    smoking: bot.smoking || 'Not set',
                    exercise: bot.exercise || 'Not set',
                    children: bot.children || 'Not set',
                    religion: bot.religion || 'Not set',
                    interests: bot.interests || [],
                    lookingFor: 'Testing',
                    photos: bot.photo ? [bot.photo] : [],
                    subscription: { type: 'free' },
                    status: 'active',
                    isTestBot: true,
                    matches: bot.matchesAccepted || 0,
                    messages: bot.messagesSent || 0,
                    joined: 'Test Bot',
                    joinedTimestamp: Date.now(),
                    profileCompleteness: 100
                });
            });
            
            // No demo fallback - show empty state message instead
            // Real users will be shown when they register

            // Populate location filter with unique locations
            const locations = [...new Set(allUsersData.map(u => u.location).filter(l => l && l !== 'Not set'))];
            const locationFilter = document.getElementById('filterLocation');
            if (locationFilter) {
                locationFilter.innerHTML = '<option value="">All Locations</option>' + 
                    locations.map(l => `<option value="${l}">${l}</option>`).join('');
            }
            
            // Apply current filters
            filteredUsers = [...allUsersData];
            applyUserFilters();
            
            // Render demographic distributions
            renderDemographics();
            
            // Update last refresh time
            updateLastRefreshTime();
        }

        function applyUserFilters() {
            const statusFilter = document.getElementById('filterStatus')?.value || '';
            const subscriptionFilter = document.getElementById('filterSubscription')?.value || '';
            const genderFilter = document.getElementById('filterGender')?.value || '';
            const educationFilter = document.getElementById('filterEducation')?.value || '';
            const ageFilter = document.getElementById('filterAge')?.value || '';
            const locationFilter = document.getElementById('filterLocation')?.value || '';
            
            filteredUsers = allUsersData.filter(u => {
                if (statusFilter && u.status !== statusFilter) return false;
                if (subscriptionFilter && u.subscription !== subscriptionFilter) return false;
                if (genderFilter && u.gender.toLowerCase() !== genderFilter) return false;
                if (educationFilter && u.education !== educationFilter) return false;
                if (locationFilter && u.location !== locationFilter) return false;
                
                if (ageFilter && u.age) {
                    const [min, max] = ageFilter.split('-').map(n => n === '55+' ? [55, 999] : parseInt(n));
                    if (ageFilter === '55+') {
                        if (u.age < 55) return false;
                    } else {
                        if (u.age < min || u.age > max) return false;
                    }
                }
                
                return true;
            });
            
            // Apply sorting
            sortUsersArray();
            
            // Render table
            renderUsersTable();
        }

        function clearUserFilters() {
            document.getElementById('filterStatus').value = '';
            document.getElementById('filterSubscription').value = '';
            document.getElementById('filterGender').value = '';
            document.getElementById('filterEducation').value = '';
            document.getElementById('filterAge').value = '';
            document.getElementById('filterLocation').value = '';
            applyUserFilters();
        }

        function sortUsers(field) {
            if (userSortField === field) {
                userSortDirection = userSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                userSortField = field;
                userSortDirection = 'asc';
            }
            sortUsersArray();
            renderUsersTable();
        }

        function sortUsersArray() {
            filteredUsers.sort((a, b) => {
                let aVal = a[userSortField];
                let bVal = b[userSortField];
                
                // Handle special cases
                if (userSortField === 'joined') {
                    aVal = a.joinedTimestamp;
                    bVal = b.joinedTimestamp;
                }
                
                // Handle null/undefined
                if (aVal === null || aVal === undefined || aVal === '' || aVal === 'Not set') aVal = userSortDirection === 'asc' ? Infinity : -Infinity;
                if (bVal === null || bVal === undefined || bVal === '' || bVal === 'Not set') bVal = userSortDirection === 'asc' ? Infinity : -Infinity;
                
                // String comparison
                if (typeof aVal === 'string' && typeof bVal === 'string') {
                    return userSortDirection === 'asc' 
                        ? aVal.localeCompare(bVal) 
                        : bVal.localeCompare(aVal);
                }
                
                // Number comparison
                return userSortDirection === 'asc' ? aVal - bVal : bVal - aVal;
            });
        }

        function getSubscriptionTimeLeft(user) {
            // Check if user has premium subscription with next billing date
            const subscription = user.subscriptionData || {};
            const nextBilling = subscription.nextBillingDate;
            
            if (!nextBilling && subscription.type !== 'premium') {
                return '<span style="color: var(--text-muted);">Free</span>';
            }
            
            if (!nextBilling) {
                // Premium but no billing date - show as active
                return '<span style="color: var(--success);">Active</span>';
            }
            
            const now = new Date();
            const endDate = new Date(nextBilling);
            const diffMs = endDate - now;
            
            if (diffMs <= 0) {
                return '<span style="color: var(--danger);">Expired</span>';
            }
            
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
            const diffHours = Math.floor((diffMs % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            
            if (diffDays > 7) {
                return `<span style="color: var(--success);">${diffDays}d left</span>`;
            } else if (diffDays > 0) {
                return `<span style="color: var(--warning);">${diffDays}d ${diffHours}h</span>`;
            } else {
                return `<span style="color: var(--danger);">${diffHours}h left</span>`;
            }
        }

        function renderUsersTable() {
            const realUsers = filteredUsers.filter(u => !u.isTestBot).length;
            const botUsers = filteredUsers.filter(u => u.isTestBot).length;
            document.getElementById('userCount').textContent = `${filteredUsers.length} total (${realUsers} users, ${botUsers} bots)`;

            // Show empty state if no users
            if (filteredUsers.length === 0) {
                document.getElementById('usersTable').innerHTML = `
                    <tr>
                        <td colspan="10" style="text-align: center; padding: 40px; color: var(--text-muted);">
                            <div style="font-size: 2rem; margin-bottom: 10px;"></div>
                            <div style="font-weight: 500; margin-bottom: 5px;">No users registered yet</div>
                            <div style="font-size: 0.85rem;">Users will appear here when they sign up in the app</div>
                        </td>
                    </tr>
                `;
                return;
            }

            document.getElementById('usersTable').innerHTML = filteredUsers.map(u => `
                <tr style="${u.isTestBot ? 'background: rgba(168, 85, 247, 0.05);' : ''}">
                    <td>
                        <div class="user-cell">
                            <img class="user-avatar" src="${u.photos?.[0] ? u.photos[0] : `https://i.pravatar.cc/100?u=${u.email}`}" alt="${u.name}">
                            <div class="user-info">
                                <div class="user-name">
                                    ${u.name}
                                    ${u.isTestBot ? '<span style="background: var(--purple); color: white; font-size: 0.6rem; padding: 2px 6px; border-radius: 10px; margin-left: 6px;"> BOT</span>' : ''}
                                </div>
                                <div class="user-email">${u.email}</div>
                            </div>
                        </div>
                    </td>
                    <td>${u.ageDisplay}</td>
                    <td><span style="text-transform: capitalize;">${u.gender}</span></td>
                    <td>${u.location}</td>
                    <td><span style="text-transform: capitalize;">${u.education.replace('-', ' ')}</span></td>
                    <td><span class="status-badge ${u.status}">${u.status}</span></td>
                    <td>${u.isTestBot ? '<span style="color: var(--text-muted);">N/A</span>' : getSubscriptionTimeLeft(u)}</td>
                    <td>${u.matches}</td>
                    <td>${u.messages}</td>
                    <td>${u.joined}</td>
                    <td>
                        <div style="display: flex; gap: 6px;">
                            <button onclick="editUser('${u.email}')" style="background: var(--info); color: white; border: none; padding: 6px 10px; border-radius: 6px; cursor: pointer; font-size: 0.75rem;" title="Edit Profile">
                                
                            </button>
                            <button onclick="editUserAdmin('${u.email}')" style="background: var(--warning); color: white; border: none; padding: 6px 10px; border-radius: 6px; cursor: pointer; font-size: 0.75rem;" title="Admin Settings">
                                
                            </button>
                            <button onclick="deleteUser('${u.email}', '${u.name}')" style="background: var(--danger); color: white; border: none; padding: 6px 10px; border-radius: 6px; cursor: pointer; font-size: 0.75rem;" title="Delete User">
                                
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function renderDemographics() {
            const users = allUsersData;
            
            // Gender Distribution
            const genderCounts = {};
            users.forEach(u => {
                const g = u.gender.toLowerCase();
                genderCounts[g] = (genderCounts[g] || 0) + 1;
            });
            
            const genderColors = { male: 'var(--info)', female: 'var(--pink)', other: 'var(--purple)', 'not set': 'var(--text-muted)' };
            document.getElementById('genderDistribution').innerHTML = Object.entries(genderCounts)
                .sort((a, b) => b[1] - a[1])
                .map(([gender, count]) => {
                    const percent = Math.round((count / users.length) * 100);
                    return `
                        <div style="margin-bottom: 12px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                                <span style="text-transform: capitalize;">${gender}</span>
                                <span style="color: var(--text-muted);">${count} (${percent}%)</span>
                            </div>
                            <div style="height: 8px; background: var(--bg-tertiary); border-radius: 4px; overflow: hidden;">
                                <div style="height: 100%; width: ${percent}%; background: ${genderColors[gender] || 'var(--text-muted)'}; border-radius: 4px;"></div>
                            </div>
                        </div>
                    `;
                }).join('');
            
            // Education Distribution
            const eduCounts = {};
            users.forEach(u => {
                const e = u.education;
                eduCounts[e] = (eduCounts[e] || 0) + 1;
            });
            
            const eduLabels = {
                'high-school': 'High School',
                'some-college': 'Some College',
                'bachelors': "Bachelor's",
                'masters': "Master's",
                'doctorate': 'Doctorate',
                'Not set': 'Not set'
            };
            
            document.getElementById('educationDistribution').innerHTML = Object.entries(eduCounts)
                .sort((a, b) => b[1] - a[1])
                .map(([edu, count]) => {
                    const percent = Math.round((count / users.length) * 100);
                    return `
                        <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border);">
                            <span> ${eduLabels[edu] || edu}</span>
                            <span style="color: var(--text-muted);">${count} (${percent}%)</span>
                        </div>
                    `;
                }).join('');
            
            // Age Distribution
            const ageBuckets = { '18-24': 0, '25-34': 0, '35-44': 0, '45-54': 0, '55+': 0, 'Unknown': 0 };
            users.forEach(u => {
                if (!u.age) { ageBuckets['Unknown']++; return; }
                if (u.age >= 55) ageBuckets['55+']++;
                else if (u.age >= 45) ageBuckets['45-54']++;
                else if (u.age >= 35) ageBuckets['35-44']++;
                else if (u.age >= 25) ageBuckets['25-34']++;
                else ageBuckets['18-24']++;
            });
            
            document.getElementById('ageDistribution').innerHTML = Object.entries(ageBuckets)
                .filter(([_, count]) => count > 0)
                .map(([range, count]) => {
                    const percent = Math.round((count / users.length) * 100);
                    return `
                        <div style="margin-bottom: 12px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                                <span>${range}</span>
                                <span style="color: var(--text-muted);">${count} (${percent}%)</span>
                            </div>
                            <div style="height: 8px; background: var(--bg-tertiary); border-radius: 4px; overflow: hidden;">
                                <div style="height: 100%; width: ${percent}%; background: var(--primary); border-radius: 4px;"></div>
                            </div>
                        </div>
                    `;
                }).join('');
            
            // Occupation Distribution
            const occCounts = {};
            users.forEach(u => {
                const o = u.occupation;
                if (o && o !== 'Not set') {
                    occCounts[o] = (occCounts[o] || 0) + 1;
                }
            });
            
            const topOccupations = Object.entries(occCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);
            
            document.getElementById('occupationDistribution').innerHTML = topOccupations.length > 0 
                ? topOccupations.map(([occ, count], i) => `
                    <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border);">
                        <span>${['', '', '', '4', '5'][i]} ${occ}</span>
                        <span style="color: var(--text-muted);">${count}</span>
                    </div>
                `).join('')
                : '<div style="text-align: center; color: var(--text-muted); padding: 20px;">No occupation data</div>';
        }

        function refreshUserData() {
            loadAllData();
            renderUsers();
            showToast('User data refreshed');
        }

        function exportUserData() {
            // Create comprehensive CSV with ALL profile fields matching edit profile
            const headers = [
                'Type',
                'User ID',
                'First Name',
                'Last Name',
                'Email',
                'Birthday',
                'Age',
                'Gender',
                'Location',
                'Occupation',
                'Company',
                'Education',
                'Height',
                'Body Type',
                'Ethnicity',
                'Drinking',
                'Smoking',
                'Exercise',
                'Children',
                'Religion',
                'Bio',
                'Interests',
                'Looking For',
                'Status',
                'Subscription',
                'Subscription Expires',
                'Profile Completeness',
                'Photo Count',
                'Photos',
                'Matches',
                'Messages Sent',
                'Emergency Contact Name',
                'Emergency Contact Phone',
                'Joined Date',
                'Last Active'
            ];
            
            // Add real users
            const rows = allUsersData.map(u => [
                u.isTestBot ? 'Test Bot' : 'User',  // Type
                u.oderId || u.email || '',
                u.firstName || '',
                u.lastName || '',
                u.email || '',
                u.birthday || '',
                u.age || u.ageDisplay || '',
                u.gender || '',
                u.location || '',
                u.occupation || '',
                u.company || '',
                u.education || '',
                u.height || '',
                u.bodyType || '',
                u.ethnicity || '',
                u.drinking || '',
                u.smoking || '',
                u.exercise || '',
                u.children || u.wantsKids || '',
                u.religion || '',
                (u.bio || '').replace(/"/g, '""'), // Escape quotes in bio
                Array.isArray(u.interests) ? u.interests.join('; ') : (u.interests || ''),
                u.lookingFor || u.relationshipGoal || '',
                u.status || '',
                u.subscription || u.plan || '',
                u.subscriptionExpires || '',
                (u.profileCompleteness || 0) + '%',
                u.photoCount || (u.photos ? u.photos.length : 0),
                Array.isArray(u.photos) ? u.photos.join('; ') : '',
                u.matches || u.matchesAccepted || 0,
                u.messages || u.messagesSent || 0,
                u.emergencyContact?.name || '',
                u.emergencyContact?.phone || '',
                u.joined || u.createdAt || '',
                u.lastActive || ''
            ]);
            
            // Add test bots from localStorage (if not already in allUsersData)
            const testBots = JSON.parse(localStorage.getItem('oith_test_bots') || '[]');
            const existingBotIds = allUsersData.filter(u => u.isTestBot).map(u => u.id);
            
            testBots.forEach(bot => {
                // Skip if already included in allUsersData
                if (existingBotIds.includes(bot.id)) return;
                
                rows.push([
                    'Test Bot',  // Type
                    bot.id || '',
                    bot.name || '',
                    '',  // Last name
                    '',  // Email (bots don't have real emails)
                    '',  // Birthday
                    bot.age || '',
                    bot.gender || '',
                    bot.location || '',
                    bot.occupation || '',
                    '',  // Company
                    bot.education || '',
                    bot.height || '',
                    bot.bodyType || '',
                    bot.ethnicity || '',
                    bot.drinking || '',
                    bot.smoking || '',
                    bot.exercise || '',
                    bot.wantsKids || '',
                    bot.religion || '',
                    (bot.bio || '').replace(/"/g, '""'),
                    Array.isArray(bot.interests) ? bot.interests.join('; ') : (bot.interests || ''),
                    bot.relationshipGoal || '',
                    bot.active ? 'Active' : 'Inactive',
                    'N/A',  // Subscription
                    '',  // Subscription Expires
                    '100%',  // Profile completeness
                    1,  // Photo count (bots have 1 photo)
                    bot.photo || '',  // Photo URL
                    bot.matchesAccepted || 0,
                    bot.messagesSent || 0,
                    '',  // Emergency Contact Name
                    '',  // Emergency Contact Phone
                    'Test Profile',  // Joined
                    ''  // Last Active
                ]);
            });
            
            // Create CSV with proper escaping
            const csv = [headers, ...rows].map(row => 
                row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',')
            ).join('\n');
            
            // Add BOM for Excel compatibility with UTF-8
            const BOM = '\uFEFF';
            const blob = new Blob([BOM + csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `oith_users_export_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
            
            const botCount = testBots.length;
            const userCount = allUsersData.length;
            showToast(` Exported ${userCount} users + ${botCount} test bots!`);
        }

        // Edit User Functions
        function editUser(email) {
            const user = allUsersData.find(u => u.email === email);
            if (!user) {
                showToast('User not found', 'error');
                return;
            }
            
            // Check if this is a test bot
            const isTestBot = user.isTestBot || false;
            
            // Create hidden field for isTestBot if it doesn't exist
            let isTestBotField = document.getElementById('editUserIsTestBot');
            if (!isTestBotField) {
                isTestBotField = document.createElement('input');
                isTestBotField.type = 'hidden';
                isTestBotField.id = 'editUserIsTestBot';
                document.getElementById('editUserForm').appendChild(isTestBotField);
            }
            isTestBotField.value = isTestBot ? 'true' : 'false';
            
            // Populate form
            document.getElementById('editUserEmail').value = email;
            document.getElementById('editUserName').value = user.name || user.firstName || '';
            document.getElementById('editUserAge').value = user.age || '';
            document.getElementById('editUserGender').value = (user.gender || 'male').toLowerCase();
            document.getElementById('editUserLocation').value = user.location || '';
            document.getElementById('editUserEducation').value = user.education || 'bachelors';
            document.getElementById('editUserSubscription').value = user.subscription || 'free';
            document.getElementById('editUserOccupation').value = user.occupation || '';
            document.getElementById('editUserStatus').value = user.status || 'active';
            
            // Populate emergency contact info
            const emergencyContact = user.emergencyContact;
            const emergencyDisplay = document.getElementById('editUserEmergencyDisplay');
            const alertsBadge = document.getElementById('editUserAlertsBadge');
            const alertsSection = document.getElementById('editUserEmergencyAlerts');
            const alertHistory = document.getElementById('editUserAlertHistory');
            
            if (emergencyContact && emergencyContact.name) {
                emergencyDisplay.innerHTML = `
                    <div><strong>${emergencyContact.name}</strong> ${emergencyContact.relationship ? `(${emergencyContact.relationship})` : ''}</div>
                    <div style="color: var(--text-muted);">${emergencyContact.phoneFormatted || emergencyContact.phone || 'No phone'}</div>
                `;
                
                // Show alerts status
                if (emergencyContact.alertsEnabled !== false) {
                    alertsBadge.textContent = 'Alerts ON';
                    alertsBadge.style.background = 'var(--success)';
                } else {
                    alertsBadge.textContent = 'Alerts OFF';
                    alertsBadge.style.background = 'var(--danger)';
                }
                
                // Show alert history if any
                if (emergencyContact.alertHistory && emergencyContact.alertHistory.length > 0) {
                    alertsSection.style.display = 'block';
                    alertHistory.innerHTML = emergencyContact.alertHistory.slice(0, 3).map(a => {
                        const date = new Date(a.sentAt).toLocaleString();
                        const icon = a.type === 'sos' ? '' : a.type === 'check_in' ? '' : '';
                        return `<div style="padding: 4px 0; border-bottom: 1px solid var(--border);">${icon} ${a.type} - ${date}</div>`;
                    }).join('');
                } else {
                    alertsSection.style.display = 'none';
                }
            } else {
                emergencyDisplay.textContent = 'No emergency contact set';
                alertsBadge.textContent = 'Not Set';
                alertsBadge.style.background = 'var(--text-muted)';
                alertsSection.style.display = 'none';
            }
            
            // Update modal title to show if it's a test bot
            const modalTitle = document.querySelector('#editUserModal h3');
            if (modalTitle) {
                modalTitle.textContent = isTestBot ? ' Edit Test Bot' : ' Edit User';
            }
            
            // Show modal
            document.getElementById('editUserModal').style.display = 'flex';
        }

        function closeEditUserModal() {
            document.getElementById('editUserModal').style.display = 'none';
        }

        function saveUserChanges(event) {
            event.preventDefault();
            
            const email = document.getElementById('editUserEmail').value;
            const isTestBot = document.getElementById('editUserIsTestBot')?.value === 'true';
            
            const updates = {
                firstName: document.getElementById('editUserName').value,
                name: document.getElementById('editUserName').value,
                age: parseInt(document.getElementById('editUserAge').value) || null,
                gender: document.getElementById('editUserGender').value,
                location: document.getElementById('editUserLocation').value,
                education: document.getElementById('editUserEducation').value,
                occupation: document.getElementById('editUserOccupation').value,
                subscription: { type: document.getElementById('editUserSubscription').value },
                status: document.getElementById('editUserStatus').value
            };
            
            console.log(' Saving user changes for:', email, 'isTestBot:', isTestBot, updates);
            
            if (isTestBot) {
                // Update test bot in oith_test_bots
                const testBots = JSON.parse(localStorage.getItem('oith_test_bots') || '[]');
                
                // Find bot by email (id) or by name
                let botIndex = testBots.findIndex(b => b.id === email);
                if (botIndex === -1) {
                    // Try finding by original name stored in allUsersData
                    const originalUser = allUsersData.find(u => u.email === email);
                    if (originalUser) {
                        botIndex = testBots.findIndex(b => b.name === originalUser.name || b.id === originalUser.botId);
                    }
                }
                
                if (botIndex !== -1) {
                    // Update ALL fields on the bot
                    testBots[botIndex].name = updates.name;
                    testBots[botIndex].age = updates.age;
                    testBots[botIndex].gender = updates.gender;
                    testBots[botIndex].location = updates.location;
                    testBots[botIndex].education = updates.education;
                    testBots[botIndex].occupation = updates.occupation;
                    testBots[botIndex].updatedAt = new Date().toISOString();
                    
                    localStorage.setItem('oith_test_bots', JSON.stringify(testBots));
                    console.log(' Updated test bot:', testBots[botIndex]);
                    
                    // Broadcast to app to sync test bots
                    broadcastAdminSync('testbots_updated', { 
                        count: testBots.filter(b => b.active).length,
                        updatedBot: testBots[botIndex]
                    });
                } else {
                    console.warn(' Could not find test bot to update');
                }
            } else {
                // Update real user
                // Update in registeredUsers with ALL relevant fields
                if (registeredUsers[email]) {
                    registeredUsers[email].firstName = updates.firstName;
                    registeredUsers[email].gender = updates.gender;
                    registeredUsers[email].age = updates.age;
                    registeredUsers[email].location = updates.location;
                    registeredUsers[email].education = updates.education;
                    registeredUsers[email].occupation = updates.occupation;
                    localStorage.setItem('oith_registered_users', JSON.stringify(registeredUsers));
                }
                
                // Update in user data (use same key format as app)
                const userDataKey = getUserStorageKey(email);
                let userData = JSON.parse(localStorage.getItem(userDataKey) || '{}');
                if (!userData.user) userData.user = {};
                
                // Update ALL fields comprehensively
                userData.user.firstName = updates.firstName;
                userData.user.name = updates.name;
                userData.user.age = updates.age;
                userData.user.gender = updates.gender;
                userData.user.location = updates.location;
                userData.user.education = updates.education;
                userData.user.occupation = updates.occupation;
                userData.user.subscription = updates.subscription;
                userData.user.accountStatus = updates.status;
                userData.user.lastUpdated = new Date().toISOString();
                userData.user.lastUpdatedBy = 'admin';
                
                // Handle status (suspended means logged out)
                if (updates.status === 'suspended') {
                    userData.isLoggedIn = false;
                    userData.isSuspended = true;
                } else if (updates.status === 'active') {
                    userData.isSuspended = false;
                }
                
                // Save to localStorage
                localStorage.setItem(userDataKey, JSON.stringify(userData));
                console.log(' Saved to localStorage:', userDataKey, userData.user);
                
                // Also update in allUserData cache
                if (allUserData[email]) {
                    allUserData[email].user = { ...allUserData[email].user, ...userData.user };
                }
                
                // Broadcast to app immediately with full updates
                console.log(' Broadcasting user_updated to app for:', email);
                broadcastAdminSync('user_updated', { 
                    email, 
                    updates,
                    fullUserData: userData.user
                });
            }
            
            // Close modal and refresh admin display
            closeEditUserModal();
            loadAllData();
            renderUsers();
            
            // Log activity
            logAdminActivity('user', `Updated ${isTestBot ? 'test bot' : 'user'} profile`, `${updates.firstName} (${email})`, { changes: Object.keys(updates) });
            
            showToast(`${isTestBot ? 'Test bot' : 'User'} ${updates.firstName} updated successfully`);
        }

        // Delete User Functions
        function deleteUser(email, name) {
            document.getElementById('deleteUserEmail').value = email;
            document.getElementById('deleteUserName').textContent = `${name} (${email})`;
            document.getElementById('deleteUserModal').style.display = 'flex';
        }

        function closeDeleteUserModal() {
            document.getElementById('deleteUserModal').style.display = 'none';
        }

        function confirmDeleteUser() {
            const email = document.getElementById('deleteUserEmail').value;
            
            // Remove from registeredUsers
            if (registeredUsers[email]) {
                delete registeredUsers[email];
                localStorage.setItem('oith_registered_users', JSON.stringify(registeredUsers));
            }
            
            // Remove user data (use same key format as app)
            const userDataKey = getUserStorageKey(email);
            localStorage.removeItem(userDataKey);
            
            // Remove from allUserData
            if (allUserData[email]) {
                delete allUserData[email];
            }
            
            // Close modal and refresh
            closeDeleteUserModal();
            loadAllData();
            renderUsers();
            
            // Broadcast to app
            broadcastAdminSync('user_deleted', { email });
            
            // Log activity
            logAdminActivity('delete', 'Deleted user account', email);
            
            showToast('User deleted successfully');
        }

        // ==========================================
        // ADMIN USER EDIT FUNCTIONS
        // ==========================================
        
        function editUserAdmin(email) {
            const user = allUsersData.find(u => u.email === email);
            if (!user) {
                showToast('User not found', 'error');
                return;
            }
            
            // Get user data from localStorage for detailed info (use same key format as app)
            const userDataKey = getUserStorageKey(email);
            const userData = JSON.parse(localStorage.getItem(userDataKey) || '{}');
            const regUser = registeredUsers[email] || {};
            
            // Populate form fields
            document.getElementById('adminEditUserEmail').value = email;
            document.getElementById('adminCurrentEmail').value = email;
            document.getElementById('adminNewEmail').value = '';
            
            // Show current password (unencrypted - stored in plain text for demo)
            document.getElementById('adminCurrentPassword').value = regUser.password || 'Not set';
            document.getElementById('adminNewPassword').value = '';
            document.getElementById('adminConfirmPassword').value = '';
            
            // Payment info (from userData.payment or empty)
            const payment = userData.payment || {};
            document.getElementById('adminCardNumber').value = payment.cardLast4 ? `   ${payment.cardLast4}` : '';
            document.getElementById('adminCardExpiry').value = payment.expiry || '';
            document.getElementById('adminCardCVV').value = '';
            document.getElementById('adminBillingAddress').value = payment.billingAddress || '';
            
            // Subscription info
            const subscription = userData.user?.subscription || {};
            document.getElementById('adminSubscriptionType').value = subscription.type || 'free';
            document.getElementById('adminSubscriptionExpiry').value = subscription.expiresAt ? subscription.expiresAt.split('T')[0] : '';
            document.getElementById('adminAutoRenew').checked = subscription.autoRenew || false;
            
            // Account status
            document.getElementById('adminVerified').checked = regUser.emailVerified || false;
            document.getElementById('adminSuspended').checked = userData.isSuspended || false;
            document.getElementById('adminFlagged').checked = userData.isFlagged || false;
            
            // Admin notes
            document.getElementById('adminNotes').value = userData.adminNotes || '';
            
            // Show modal
            document.getElementById('adminEditUserModal').style.display = 'flex';
        }
        
        function closeAdminEditModal() {
            document.getElementById('adminEditUserModal').style.display = 'none';
        }
        
        function togglePasswordVisibility() {
            const passwordInput = document.getElementById('adminNewPassword');
            const confirmInput = document.getElementById('adminConfirmPassword');
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                confirmInput.type = 'text';
            } else {
                passwordInput.type = 'password';
                confirmInput.type = 'password';
            }
        }
        
        function saveAdminUserChanges(event) {
            event.preventDefault();
            
            const originalEmail = document.getElementById('adminEditUserEmail').value;
            const newEmail = document.getElementById('adminNewEmail').value.trim().toLowerCase();
            const newPassword = document.getElementById('adminNewPassword').value;
            const confirmPassword = document.getElementById('adminConfirmPassword').value;
            
            // Validate password if provided
            if (newPassword) {
                if (newPassword.length < 8) {
                    showToast('Password must be at least 8 characters', 'error');
                    return;
                }
                if (newPassword !== confirmPassword) {
                    showToast('Passwords do not match', 'error');
                    return;
                }
            }
            
            // Validate email if provided
            if (newEmail && newEmail !== originalEmail) {
                if (registeredUsers[newEmail]) {
                    showToast('Email already in use', 'error');
                    return;
                }
            }
            
            // Get card number (only save last 4 digits for security)
            const cardNumber = document.getElementById('adminCardNumber').value.replace(/\D/g, '');
            const cardLast4 = cardNumber.length >= 4 ? cardNumber.slice(-4) : '';
            
            // Prepare updates (use same key format as app)
            const userDataKey = getUserStorageKey(originalEmail);
            let userData = JSON.parse(localStorage.getItem(userDataKey) || '{}');
            
            // Update password in registered users
            if (newPassword && registeredUsers[originalEmail]) {
                registeredUsers[originalEmail].password = newPassword;
            }
            
            // Update email in registered users
            if (newEmail && newEmail !== originalEmail) {
                // Move the user to new email key
                registeredUsers[newEmail] = { ...registeredUsers[originalEmail], email: newEmail };
                delete registeredUsers[originalEmail];
                
                // Update user data key
                if (userData.user) userData.user.email = newEmail;
                localStorage.removeItem(userDataKey);
                localStorage.setItem(getUserStorageKey(newEmail), JSON.stringify(userData));
            }
            
            // Save registered users
            localStorage.setItem('oith_registered_users', JSON.stringify(registeredUsers));
            
            // Update payment info (only store last 4 digits for demo)
            if (!userData.payment) userData.payment = {};
            if (cardLast4) userData.payment.cardLast4 = cardLast4;
            userData.payment.expiry = document.getElementById('adminCardExpiry').value;
            userData.payment.billingAddress = document.getElementById('adminBillingAddress').value;
            
            // Update subscription
            if (!userData.user) userData.user = {};
            if (!userData.user.subscription) userData.user.subscription = {};
            userData.user.subscription.type = document.getElementById('adminSubscriptionType').value;
            const expiryDate = document.getElementById('adminSubscriptionExpiry').value;
            if (expiryDate) {
                userData.user.subscription.expiresAt = new Date(expiryDate).toISOString();
            }
            userData.user.subscription.autoRenew = document.getElementById('adminAutoRenew').checked;
            
            // Update account status
            userData.isSuspended = document.getElementById('adminSuspended').checked;
            userData.isFlagged = document.getElementById('adminFlagged').checked;
            
            // Update admin notes
            userData.adminNotes = document.getElementById('adminNotes').value;
            
            // Also update emailVerified in registered users
            const targetEmail = newEmail || originalEmail;
            if (registeredUsers[targetEmail]) {
                registeredUsers[targetEmail].emailVerified = document.getElementById('adminVerified').checked;
                localStorage.setItem('oith_registered_users', JSON.stringify(registeredUsers));
            }
            
            // Save user data
            const finalKey = newEmail && newEmail !== originalEmail ? getUserStorageKey(newEmail) : userDataKey;
            localStorage.setItem(finalKey, JSON.stringify(userData));
            
            // Close modal and refresh
            closeAdminEditModal();
            loadAllData();
            renderUsers();
            
            // Broadcast to app
            broadcastAdminSync('user_updated', { email });
            
            showToast(' Admin changes saved successfully!');
        }

        // ==========================================
        // MATCHES
        // ==========================================
        
        function renderMatches() {
            document.getElementById('matchStats').innerHTML = `
                <div class="stat-card matches">
                    <div class="stat-icon matches"></div>
                    <div class="stat-value">${platformData.totalMatches}</div>
                    <div class="stat-label">Total Matches</div>
                </div>
                <div class="stat-card users">
                    <div class="stat-icon users"></div>
                    <div class="stat-value">${platformData.acceptedMatches}</div>
                    <div class="stat-label">Accepted</div>
                </div>
                <div class="stat-card safety">
                    <div class="stat-icon safety"></div>
                    <div class="stat-value">${platformData.declinedMatches}</div>
                    <div class="stat-label">Declined</div>
                </div>
                <div class="stat-card dates">
                    <div class="stat-icon dates"></div>
                    <div class="stat-value">${platformData.datesPlanned}</div>
                    <div class="stat-label">Led to Dates</div>
                </div>
            `;
            
            // Calculate weekly match activity from real data
            const weeklyActivity = calculateWeeklyMatchActivity();
            renderMatchActivityChart(weeklyActivity);
            
            // Render match breakdown
            renderMatchBreakdown();

            // Build matches array from real user data
            // Use a Map to deduplicate matches (one row per match pair)
            const matchesMap = new Map();
            
            Object.keys(allUserData).forEach(email => {
                const userData = allUserData[email];
                const user = userData.user || {};
                const userName = user.firstName || 'User';
                
                if (userData.activeConnection) {
                    const conn = userData.activeConnection;
                    const matchName = conn.name || 'Match';
                    
                    // Create unique key for this match pair (alphabetically sorted)
                    const names = [userName, matchName].sort();
                    const matchKey = `${names[0]}_${names[1]}`;
                    
                    // Only add if not already in map
                    if (!matchesMap.has(matchKey)) {
                        matchesMap.set(matchKey, {
                            user1: names[0],
                            user2: names[1],
                            compatibility: conn.compatibility || 85,
                            status: 'Active',
                            messages: userData.conversation?.messages?.length || 0,
                            datePlanned: userData.plannedDate ? 'Yes' : 'No',
                            duration: getMatchDuration(conn.connectedAt || conn.matchedAt || new Date().toISOString())
                        });
                    }
                }
                
                // Also check match history
                if (userData.matchHistory) {
                    userData.matchHistory.forEach(match => {
                        const matchName = match.name || 'Match';
                        
                        // Create unique key for this match pair
                        const names = [userName, matchName].sort();
                        const matchKey = `${names[0]}_${names[1]}_${match.connectedAt || match.id || ''}`;
                        
                        // Only add if not already in map
                        if (!matchesMap.has(matchKey)) {
                            matchesMap.set(matchKey, {
                                user1: names[0],
                                user2: names[1],
                                compatibility: match.compatibility || 80,
                                status: match.status === 'connected' ? 'Active' : (match.status === 'ended' ? 'Ended' : 'Declined'),
                                messages: match.messageCount || 0,
                                datePlanned: match.hadDate ? 'Yes' : 'No',
                                duration: match.duration || ''
                            });
                        }
                    });
                }
            });
            
            // Convert map to array
            const matches = Array.from(matchesMap.values());
            
            // Show empty state if no matches, no demo fallback
            if (matches.length === 0) {
                document.getElementById('matchesTable').innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 40px; color: var(--text-muted);">
                            <div style="font-size: 2rem; margin-bottom: 8px;"></div>
                            <div>No matches yet</div>
                            <div style="font-size: 0.8rem; margin-top: 4px;">Matches will appear as users connect in the app</div>
                        </td>
                    </tr>
                `;
                return;
            }

            document.getElementById('matchesTable').innerHTML = matches.map(m => `
                <tr>
                    <td><strong>${m.user1}</strong> & <strong>${m.user2}</strong></td>
                    <td>${m.compatibility}%</td>
                    <td><span class="status-badge ${m.status === 'Active' ? 'matched' : 'inactive'}">${m.status}</span></td>
                    <td>${m.messages}</td>
                    <td>${m.datePlanned}</td>
                    <td>${m.duration}</td>
                </tr>
            `).join('');
        }
        
        function getMatchDuration(startDate) {
            const start = new Date(startDate);
            const now = new Date();
            const diffMs = now - start;
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
            
            if (diffDays > 0) return `${diffDays} day${diffDays > 1 ? 's' : ''}`;
            if (diffHours > 0) return `${diffHours} hour${diffHours > 1 ? 's' : ''}`;
            return 'Just now';
        }
        
        /**
         * Calculate weekly match activity from real user data
         */
        function calculateWeeklyMatchActivity() {
            const days = ['SUN', 'MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT'];
            const activity = { SUN: 0, MON: 0, TUE: 0, WED: 0, THU: 0, FRI: 0, SAT: 0 };
            
            // Count matches by day of week from all user data
            Object.keys(allUserData).forEach(email => {
                const userData = allUserData[email];
                
                // Count active connection
                if (userData.activeConnection?.matchedAt || userData.activeConnection?.connectedAt) {
                    const matchDate = new Date(userData.activeConnection.matchedAt || userData.activeConnection.connectedAt);
                    const dayName = days[matchDate.getDay()];
                    activity[dayName]++;
                }
                
                // Count match history
                if (userData.matchHistory) {
                    userData.matchHistory.forEach(match => {
                        if (match.matchedAt || match.connectedAt) {
                            const matchDate = new Date(match.matchedAt || match.connectedAt);
                            const dayName = days[matchDate.getDay()];
                            activity[dayName]++;
                        }
                    });
                }
            });
            
            // Also count test bot activity
            const testBots = JSON.parse(localStorage.getItem('oith_test_bots') || '[]');
            testBots.forEach(bot => {
                if (bot.active && bot.matchesAccepted > 0) {
                    // Distribute bot matches across random days
                    for (let i = 0; i < (bot.matchesAccepted || 1); i++) {
                        const randomDay = days[Math.floor(Math.random() * 7)];
                        activity[randomDay]++;
                    }
                }
            });
            
            // Ensure at least some activity for visualization
            const totalActivity = Object.values(activity).reduce((a, b) => a + b, 0);
            if (totalActivity === 0) {
                // Show placeholder data based on active users/bots
                const activeCount = Object.keys(allUserData).length + testBots.filter(b => b.active).length;
                if (activeCount > 0) {
                    days.forEach((day, i) => {
                        activity[day] = Math.floor(Math.random() * activeCount * 2) + 1;
                    });
                }
            }
            
            return activity;
        }
        
        /**
         * Render the match activity bar chart
         */
        function renderMatchActivityChart(activity) {
            const chartContainer = document.getElementById('matchActivityChart');
            if (!chartContainer) return;
            
            const days = ['MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT', 'SUN'];
            const values = days.map(d => activity[d] || 0);
            const maxVal = Math.max(...values, 1);
            const totalMatches = values.reduce((a, b) => a + b, 0);
            
            // Find peak day
            const peakIndex = values.indexOf(Math.max(...values));
            const peakDay = days[peakIndex];
            
            chartContainer.innerHTML = days.map((day, i) => {
                const value = values[i];
                const height = maxVal > 0 ? (value / maxVal) * 100 : 0;
                const isPeak = i === peakIndex && value > 0;
                
                return `
                    <div class="chart-bar" style="height: ${Math.max(height, 5)}%; ${isPeak ? 'background: var(--accent);' : 'background: rgba(193, 127, 116, 0.4);'}">
                        <span class="chart-bar-value" style="${isPeak ? 'color: var(--accent); font-weight: 700;' : ''}">${value}</span>
                        <span class="chart-bar-label">${day}</span>
                    </div>
                `;
            }).join('');
            
            // Update trend indicator
            const trendEl = document.getElementById('matchActivityTrend');
            if (trendEl) {
                trendEl.textContent = `${totalMatches} this week`;
                trendEl.className = totalMatches > 0 ? 'stat-change positive' : 'stat-change';
            }
        }
        
        /**
         * Render match breakdown statistics
         */
        function renderMatchBreakdown() {
            const breakdownEl = document.getElementById('matchBreakdown');
            if (!breakdownEl) return;
            
            // Calculate real breakdown stats
            let mutualMatches = 0;
            let oneWayLikes = 0;
            let dateConversions = 0;
            let avgCompatibility = 0;
            let compatCount = 0;
            
            Object.keys(allUserData).forEach(email => {
                const userData = allUserData[email];
                
                if (userData.activeConnection) {
                    mutualMatches++;
                    if (userData.activeConnection.compatibility) {
                        avgCompatibility += userData.activeConnection.compatibility;
                        compatCount++;
                    }
                    if (userData.plannedDate || userData.conversation?.datePlanned) {
                        dateConversions++;
                    }
                }
                
                if (userData.matchHistory) {
                    userData.matchHistory.forEach(match => {
                        if (match.status === 'connected' || match.status === 'ended') {
                            mutualMatches++;
                        } else if (match.status === 'declined') {
                            oneWayLikes++;
                        }
                        if (match.compatibility) {
                            avgCompatibility += match.compatibility;
                            compatCount++;
                        }
                        if (match.hadDate) {
                            dateConversions++;
                        }
                    });
                }
            });
            
            const avgCompat = compatCount > 0 ? Math.round(avgCompatibility / compatCount) : 0;
            const dateRate = mutualMatches > 0 ? Math.round((dateConversions / mutualMatches) * 100) : 0;
            
            breakdownEl.innerHTML = `
                <div class="metric-row">
                    <span class="metric-label">Mutual Matches</span>
                    <span class="metric-value">${mutualMatches}</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">One-way Likes</span>
                    <span class="metric-value">${oneWayLikes}</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Avg Compatibility</span>
                    <span class="metric-value" style="color: ${avgCompat >= 80 ? 'var(--success)' : avgCompat >= 60 ? 'var(--warning)' : 'var(--text-primary)'}">${avgCompat}%</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Date Conversion Rate</span>
                    <span class="metric-value" style="color: ${dateRate >= 50 ? 'var(--success)' : 'var(--warning)'}">${dateRate}%</span>
                </div>
            `;
        }

        // ==========================================
        // CONVERSION FUNNEL
        // ==========================================
        
        function renderFunnel() {
            // Calculate actual funnel metrics from real data
            // Iterate through ALL registered users to get accurate counts
            const allEmails = new Set([
                ...Object.keys(registeredUsers),
                ...Object.keys(allUserData)
            ]);
            
            const totalSignups = allEmails.size;
            let profileComplete = 0;
            let firstMatch = 0;
            let firstMessage = 0;
            let datePlanned = 0;
            
            console.log(' Funnel Analysis:');
            console.log('   Total unique users:', totalSignups);
            
            allEmails.forEach(email => {
                const regUser = registeredUsers[email] || {};
                const userData = allUserData[email] || {};
                const user = userData.user || {};
                
                // Profile complete = has firstName (from registration or saved data)
                // AND has either logged in (has userData) or has additional profile info
                const hasName = user.firstName || regUser.firstName;
                const hasProfile = user.bio || user.occupation || user.birthday || (user.photos && user.photos.length > 0);
                const hasLoggedIn = userData.isLoggedIn || Object.keys(userData).length > 0;
                
                if (hasName && (hasProfile || hasLoggedIn)) {
                    profileComplete++;
                }
                
                // Has or had a match (check activeConnection or oneMatch)
                const hasActiveMatch = userData.activeConnection;
                const hasMatchHistory = userData.matchHistory && userData.matchHistory.length > 0;
                const hasOneMatch = userData.oneMatch?.current;
                
                if (hasActiveMatch || hasMatchHistory || hasOneMatch) {
                    firstMatch++;
                }
                
                // Has sent at least one message
                if (userData.conversation?.messages && userData.conversation.messages.length > 0) {
                    firstMessage++;
                }
                
                // Has planned a date
                if (userData.plannedDate) {
                    datePlanned++;
                }
            });
            
            console.log('   Profile Complete:', profileComplete);
            console.log('   First Match:', firstMatch);
            console.log('   First Message:', firstMessage);
            console.log('   Date Planned:', datePlanned);
            
            // Ensure we have at least 1 for signups
            const signups = Math.max(totalSignups, 1);
            
            // Build funnel data with proper percentages (capped at 100%)
            const funnel = [
                { label: 'Signups', value: signups, percent: 100 },
                { label: 'Profile Complete', value: profileComplete, percent: Math.min(100, Math.round((profileComplete / signups) * 100)) },
                { label: 'First Match', value: firstMatch, percent: Math.min(100, Math.round((firstMatch / signups) * 100)) },
                { label: 'First Message', value: firstMessage, percent: Math.min(100, Math.round((firstMessage / signups) * 100)) },
                { label: 'Date Planned', value: datePlanned, percent: Math.min(100, Math.round((datePlanned / signups) * 100)) },
            ];

            document.getElementById('funnelChart').innerHTML = funnel.map((f, i) => `
                <div class="funnel-step">
                    <span class="funnel-label">${f.label}</span>
                    <div class="funnel-bar">
                        <div class="funnel-fill" style="width: ${Math.max(f.percent, f.value > 0 ? 5 : 0)}%">${f.value.toLocaleString()}</div>
                    </div>
                    <span class="funnel-value">${f.percent}%</span>
                </div>
            `).join('');

            // Calculate step-by-step conversion rates (capped at 100%)
            const signupToProfile = signups > 0 ? Math.min(100, Math.round((profileComplete / signups) * 100)) : 0;
            const profileToMatch = profileComplete > 0 ? Math.min(100, Math.round((firstMatch / profileComplete) * 100)) : 0;
            const matchToMessage = firstMatch > 0 ? Math.min(100, Math.round((firstMessage / firstMatch) * 100)) : 0;
            const messageToDate = firstMessage > 0 ? Math.min(100, Math.round((datePlanned / firstMessage) * 100)) : 0;

            document.getElementById('conversionRates').innerHTML = `
                <div class="metric-row">
                    <span class="metric-label">Signup  Profile Complete</span>
                    <span class="metric-value" style="color: ${signupToProfile >= 50 ? 'var(--success)' : 'var(--warning)'}">${signupToProfile}%</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Profile  First Match</span>
                    <span class="metric-value" style="color: ${profileToMatch >= 50 ? 'var(--success)' : 'var(--warning)'}">${profileToMatch}%</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Match  First Message</span>
                    <span class="metric-value" style="color: ${matchToMessage >= 50 ? 'var(--success)' : 'var(--warning)'}">${matchToMessage}%</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Message  Date Planned</span>
                    <span class="metric-value" style="color: ${messageToDate >= 50 ? 'var(--success)' : 'var(--warning)'}">${messageToDate}%</span>
                </div>
            `;

            // Show actual time metrics or placeholders
            document.getElementById('stepTimes').innerHTML = `
                <div class="metric-row">
                    <span class="metric-label">Avg Profile Completion</span>
                    <span class="metric-value">${profileComplete > 0 ? '~5 min' : 'No data'}</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Signup  First Match</span>
                    <span class="metric-value">${firstMatch > 0 ? '< 24 hours' : 'No data'}</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Match  First Message</span>
                    <span class="metric-value">${firstMessage > 0 ? '~10 min' : 'No data'}</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Match  Date Planned</span>
                    <span class="metric-value">${datePlanned > 0 ? '~3 days' : 'No data'}</span>
                </div>
            `;
        }

        // ==========================================
        // REVENUE - Fetches from AWS Stripe API
        // ==========================================
        
        async function renderRevenue() {
            // Show loading state
            document.getElementById('mrrValue').textContent = 'Loading...';
            document.getElementById('premiumUsers').textContent = '...';
            document.getElementById('conversionRate').textContent = '...';
            document.getElementById('churnRate').textContent = '...';
            
            const sourceEl = document.getElementById('revenueDataSource');
            if (sourceEl) {
                sourceEl.textContent = 'Fetching...';
                sourceEl.style.background = 'var(--info)';
            }
            
            let premiumUsers = 0;
            let freeUsers = 0;
            let trialUsers = 0;
            let canceledUsers = 0;
            let currentMRR = 0;
            let churnRate = 0;
            let conversionRate = 0;
            let revenueByMonth = {};
            let dataSource = 'localStorage';
            
            // Try to fetch REAL data from AWS/Stripe first
            try {
                const PAYMENT_API_URL = localStorage.getItem('oith_payment_api_url') || 'https://emeapbgbui.execute-api.us-east-1.amazonaws.com';
                console.log(' Fetching revenue stats from:', PAYMENT_API_URL);
                
                const response = await fetch(`${PAYMENT_API_URL}/subscription-stats`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (response.ok) {
                    const stats = await response.json();
                    console.log(' Revenue stats from Stripe:', stats);
                    
                    currentMRR = stats.mrr || 0;
                    premiumUsers = stats.activeSubscriptions || 0;
                    canceledUsers = stats.canceledSubscriptions || 0;
                    churnRate = stats.monthlyChurnRate || 0;
                    conversionRate = stats.conversionRate || 0;
                    revenueByMonth = stats.revenueByMonth || {};
                    freeUsers = (stats.totalCustomers || 0) - premiumUsers;
                    dataSource = 'AWS/Stripe';
                } else {
                    console.warn(' Stripe API returned:', response.status);
                }
            } catch (error) {
                console.warn(' Could not fetch from Stripe API:', error.message);
            }
            
            // Try fetching from main AWS API for user subscription data
            if (dataSource === 'localStorage') {
                try {
                    console.log(' Trying main AWS API for user data...');
                    const response = await fetch(`${AWS_API_URL}/users`, {
                        method: 'GET',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    
                    if (response.ok) {
                        const awsData = await response.json();
                        const users = awsData.users || [];
                        console.log(' Loaded', users.length, 'users from AWS');
                        
                        // Calculate metrics from AWS user data
                        users.forEach(user => {
                            const subscription = user.subscription;
                            if (subscription?.type === 'premium' && subscription?.status === 'active') {
                                premiumUsers++;
                                currentMRR += subscription.amount || 10.00;
                            } else if (subscription?.type === 'trial') {
                                trialUsers++;
                            } else if (subscription?.status === 'canceled') {
                                canceledUsers++;
                            } else {
                                freeUsers++;
                            }
                        });
                        
                        const totalSubscribers = premiumUsers + canceledUsers;
                        churnRate = totalSubscribers > 0 ? Math.round((canceledUsers / totalSubscribers) * 100) : 0;
                        conversionRate = (freeUsers + premiumUsers) > 0 ? Math.round((premiumUsers / (freeUsers + premiumUsers)) * 100) : 0;
                        
                        if (users.length > 0) {
                            dataSource = 'AWS DynamoDB';
                        }
                    }
                } catch (error) {
                    console.warn(' Could not fetch from AWS API:', error.message);
                }
            }
            
            // Fallback to localStorage if API failed
            if (dataSource === 'localStorage') {
                const now = new Date();
                const subscriptionDurations = [];
                const allTransactions = [];
                
                Object.keys(allUserData).forEach(email => {
                    const userData = allUserData[email];
                    const subscription = userData.user?.subscription;
                    
                    if (subscription?.type === 'premium' && subscription?.status === 'active') {
                        premiumUsers++;
                        currentMRR += subscription.amount || 10.00;
                        
                        if (subscription.startDate) {
                            const startDate = new Date(subscription.startDate);
                            const monthsActive = Math.max(1, Math.floor((now - startDate) / (1000 * 60 * 60 * 24 * 30)));
                            subscriptionDurations.push(monthsActive);
                        }
                    } else if (subscription?.type === 'trial') {
                        trialUsers++;
                    } else if (subscription?.status === 'canceled') {
                        canceledUsers++;
                    } else {
                        freeUsers++;
                    }
                    
                    if (userData.user?.billingHistory) {
                        userData.user.billingHistory.forEach(tx => {
                            if (tx.status === 'paid' && tx.amount > 0) {
                                allTransactions.push({
                                    date: new Date(tx.date),
                                    amount: tx.amount
                                });
                            }
                        });
                    }
                });
                
                const totalRegistered = Object.keys(registeredUsers).length;
                if (freeUsers === 0 && premiumUsers === 0 && trialUsers === 0) {
                    freeUsers = totalRegistered;
                }
                
                const totalSubscribers = premiumUsers + canceledUsers;
                churnRate = totalSubscribers > 0 ? Math.round((canceledUsers / totalSubscribers) * 100) : 0;
                conversionRate = (freeUsers + premiumUsers) > 0 ? Math.round((premiumUsers / (freeUsers + premiumUsers)) * 100) : 0;
                
                // Build revenue by month from transactions
                for (let i = 5; i >= 0; i--) {
                    const monthDate = new Date(now.getFullYear(), now.getMonth() - i, 1);
                    const monthEnd = new Date(now.getFullYear(), now.getMonth() - i + 1, 0);
                    const monthKey = monthDate.toISOString().slice(0, 7);
                    
                    revenueByMonth[monthKey] = allTransactions
                        .filter(tx => tx.date >= monthDate && tx.date <= monthEnd)
                        .reduce((sum, tx) => sum + tx.amount, 0);
                }
            }
            
            // Update stat cards with data (from either source)
            document.getElementById('mrrValue').textContent = `$${currentMRR.toFixed(2)}`;
            document.getElementById('premiumUsers').textContent = premiumUsers;
            document.getElementById('conversionRate').textContent = `${conversionRate}%`;
            document.getElementById('churnRate').textContent = `${churnRate}%`;
            
            // Generate revenue chart
            const now = new Date();
            const months = [];
            const values = [];
            
            for (let i = 5; i >= 0; i--) {
                const monthDate = new Date(now.getFullYear(), now.getMonth() - i, 1);
                const monthKey = monthDate.toISOString().slice(0, 7);
                months.push(monthDate.toLocaleDateString('en-US', { month: 'short' }));
                values.push(revenueByMonth[monthKey] || 0);
            }
            
            const maxVal = Math.max(...values, 1);
            const hasData = values.some(v => v > 0);

            if (hasData) {
                document.getElementById('revenueChart').innerHTML = months.map((m, i) => `
                    <div class="chart-bar" style="height: ${(values[i] / maxVal) * 100}%">
                        <span class="chart-bar-value">$${values[i].toFixed(0)}</span>
                        <span class="chart-bar-label">${m}</span>
                    </div>
                `).join('');
            } else {
                document.getElementById('revenueChart').innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--text-muted); font-size: 0.9rem;">
                        No revenue data yet
                    </div>
                `;
            }

            document.getElementById('subscriptionBreakdown').innerHTML = `
                <div class="metric-row"><span class="metric-label">Premium ($10/mo)</span><span class="metric-value">${premiumUsers} user${premiumUsers !== 1 ? 's' : ''}</span></div>
                <div class="metric-row"><span class="metric-label">Free Users</span><span class="metric-value">${freeUsers} user${freeUsers !== 1 ? 's' : ''}</span></div>
                <div class="metric-row"><span class="metric-label">Trial Users</span><span class="metric-value">${trialUsers} user${trialUsers !== 1 ? 's' : ''}</span></div>
                <div class="metric-row"><span class="metric-label">Canceled</span><span class="metric-value" style="color: var(--danger);">${canceledUsers} user${canceledUsers !== 1 ? 's' : ''}</span></div>
                <div style="margin-top: 8px; font-size: 0.7rem; color: var(--text-muted);"> Source: ${dataSource}</div>
            `;
            
            // Update data source badge
            if (sourceEl) {
                sourceEl.textContent = dataSource;
                if (dataSource.includes('AWS') || dataSource.includes('Stripe')) {
                    sourceEl.style.background = 'var(--success)';
                } else {
                    sourceEl.style.background = 'var(--warning)';
                }
            }

            // Calculate LTV/CAC
            const subscriptionPrice = pricingConfig.subscriptionPrice;
            const avgMonths = churnRate > 0 ? 100 / churnRate : 12; // Estimated months before churn
            const ltv = subscriptionPrice * avgMonths;
            
            const marketingData = JSON.parse(localStorage.getItem('oith_marketing_spend') || '{}');
            const totalMarketingSpend = marketingData.total || 0;
            const totalAcquiredUsers = premiumUsers + canceledUsers;
            const cac = totalAcquiredUsers > 0 ? totalMarketingSpend / totalAcquiredUsers : 0;
            
            const ltvCacRatio = cac > 0 ? ltv / cac : 0;
            const paybackDays = cac > 0 && subscriptionPrice > 0 ? Math.round((cac / subscriptionPrice) * 30) : 0;

            const ltvDisplay = ltv > 0 ? `$${ltv.toFixed(2)}` : '$0.00';
            const cacDisplay = cac > 0 ? `$${cac.toFixed(2)}` : 'No data';
            const ratioDisplay = ltvCacRatio > 0 ? `${ltvCacRatio.toFixed(1)}x` : 'N/A';
            const paybackDisplay = paybackDays > 0 ? `${paybackDays} days` : 'N/A';

            document.getElementById('ltvCac').innerHTML = `
                <div class="metric-row"><span class="metric-label">Customer Lifetime Value</span><span class="metric-value">${ltvDisplay}</span></div>
                <div class="metric-row"><span class="metric-label">Customer Acq. Cost</span><span class="metric-value">${cacDisplay}</span></div>
                <div class="metric-row"><span class="metric-label">LTV:CAC Ratio</span><span class="metric-value" style="color: ${ltvCacRatio >= 3 ? 'var(--success)' : ltvCacRatio > 0 ? 'var(--warning)' : 'var(--text-muted)'}">${ratioDisplay}</span></div>
                <div class="metric-row"><span class="metric-label">Payback Period</span><span class="metric-value">${paybackDisplay}</span></div>
                ${totalMarketingSpend === 0 ? '<div style="margin-top: 12px; padding: 8px; background: var(--bg-tertiary); border-radius: 6px; font-size: 0.75rem; color: var(--text-muted);"> Set marketing spend in settings to calculate CAC</div>' : ''}
            `;
            
            // Load and display bank account settings
            loadBankAccountSettings();
            
            // Render transactions table
            renderTransactionsTable();
        }
        
        // ==========================================
        // BANK ACCOUNT MANAGEMENT
        // ==========================================
        
        function loadBankAccountSettings() {
            const bankSettings = JSON.parse(localStorage.getItem('oith_bank_settings') || '{}');
            
            if (bankSettings.bankName) {
                document.getElementById('bankName').value = bankSettings.bankName || '';
                document.getElementById('bankAccountHolder').value = bankSettings.accountHolder || '';
                document.getElementById('bankRouting').value = bankSettings.routing || '';
                document.getElementById('bankAccount').value = bankSettings.accountNumber || '';
                document.getElementById('bankAccountType').value = bankSettings.accountType || 'checking';
                document.getElementById('payoutSchedule').value = bankSettings.payoutSchedule || 'weekly';
                
                // Show connected status
                const statusDiv = document.getElementById('bankAccountStatus');
                statusDiv.style.display = 'block';
                document.getElementById('connectedBankDisplay').textContent = 
                    `${bankSettings.bankName} ****${bankSettings.accountNumber?.slice(-4) || '0000'}`;
                document.getElementById('lastPayoutDate').textContent = 
                    bankSettings.lastPayout ? `Last payout: ${new Date(bankSettings.lastPayout).toLocaleDateString()}` : 'No payouts yet';
            }
        }
        
        function saveBankAccount() {
            const bankSettings = {
                bankName: document.getElementById('bankName').value,
                accountHolder: document.getElementById('bankAccountHolder').value,
                routing: document.getElementById('bankRouting').value,
                accountNumber: document.getElementById('bankAccount').value,
                accountType: document.getElementById('bankAccountType').value,
                payoutSchedule: document.getElementById('payoutSchedule').value,
                updatedAt: new Date().toISOString()
            };
            
            // Validate
            if (!bankSettings.bankName || !bankSettings.accountHolder || !bankSettings.routing || !bankSettings.accountNumber) {
                showToast('Please fill in all required bank account fields', 'error');
                return;
            }
            
            if (bankSettings.routing.length !== 9) {
                showToast('Routing number must be 9 digits', 'error');
                return;
            }
            
            // Save to localStorage
            localStorage.setItem('oith_bank_settings', JSON.stringify(bankSettings));
            
            // Broadcast to app
            broadcastAdminSync('bank_settings_updated', bankSettings);
            
            // Update display
            const statusDiv = document.getElementById('bankAccountStatus');
            statusDiv.style.display = 'block';
            document.getElementById('connectedBankDisplay').textContent = 
                `${bankSettings.bankName} ****${bankSettings.accountNumber.slice(-4)}`;
            
            showToast(' Bank account settings saved successfully!');
        }
        
        // Stripe API URL for transactions
        const STRIPE_API_URL = 'https://ludksg8e3g.execute-api.us-east-1.amazonaws.com/api';
        
        // Cache for Stripe transactions
        let stripeTransactionsCache = null;
        let stripeTransactionsLastFetch = null;
        
        async function fetchStripeTransactions() {
            // Use cache if less than 30 seconds old
            if (stripeTransactionsCache && stripeTransactionsLastFetch && 
                (Date.now() - stripeTransactionsLastFetch) < 30000) {
                return stripeTransactionsCache;
            }
            
            try {
                const response = await fetch(`${STRIPE_API_URL}/transactions`);
                if (!response.ok) throw new Error('Failed to fetch transactions');
                
                const data = await response.json();
                stripeTransactionsCache = data;
                stripeTransactionsLastFetch = Date.now();
                return data;
            } catch (error) {
                console.error('Error fetching Stripe transactions:', error);
                return null;
            }
        }
        
        async function renderTransactionsTable() {
            const tbody = document.getElementById('transactionsTable');
            
            // Show loading state
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" style="text-align: center; padding: 40px; color: var(--text-muted);">
                        <div style="display: flex; align-items: center; justify-content: center; gap: 8px;">
                            <svg class="animate-spin" style="width: 20px; height: 20px; animation: spin 1s linear infinite;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10" stroke-opacity="0.25"></circle>
                                <path d="M12 2a10 10 0 0 1 10 10" stroke-opacity="1"></path>
                            </svg>
                            Loading transactions from Stripe...
                        </div>
                    </td>
                </tr>
            `;
            
            // Fetch from Stripe API
            const stripeData = await fetchStripeTransactions();
            
            if (stripeData && stripeData.transactions && stripeData.transactions.length > 0) {
                const transactions = stripeData.transactions;
                
                // Update revenue stats from Stripe data
                if (stripeData.summary) {
                    const summary = stripeData.summary;
                    updateEl('dailyRevenue', '$' + summary.dailyRevenue.toFixed(2));
                    updateEl('mtdRevenue', '$' + summary.monthlyRevenue.toFixed(2));
                    updateEl('ytdRevenue', '$' + summary.yearlyRevenue.toFixed(2));
                }
                
                tbody.innerHTML = transactions.slice(0, 20).map(t => {
                    const date = new Date(t.date).toLocaleDateString();
                    const time = new Date(t.date).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    
                    let statusBadge = '';
                    if (t.refunded) {
                        statusBadge = '<span class="status-badge" style="background: var(--danger);">Refunded</span>';
                    } else if (t.status === 'paid' || t.status === 'succeeded') {
                        statusBadge = '<span class="status-badge active">Paid</span>';
                    } else if (t.status === 'pending') {
                        statusBadge = '<span class="status-badge warning">Pending</span>';
                    } else {
                        statusBadge = `<span class="status-badge">${t.status}</span>`;
                    }
                    
                    const userName = t.customerName || t.customerEmail?.split('@')[0] || 'Customer';
                    const cardInfo = t.paymentMethod ? `${t.paymentMethod.toUpperCase()} ****${t.last4}` : 'Card';
                    
                    return `
                        <tr>
                            <td>
                                <div>${date}</div>
                                <div style="font-size: 0.75rem; color: var(--text-muted);">${time}</div>
                            </td>
                            <td>
                                <div>${userName}</div>
                                <div style="font-size: 0.75rem; color: var(--text-muted);">${t.customerEmail || ''}</div>
                            </td>
                            <td>${t.description || 'Subscription'}</td>
                            <td style="color: ${t.refunded ? 'var(--danger)' : 'var(--success)'}; font-weight: 500;">
                                ${t.refunded ? '-' : ''}$${t.amount?.toFixed(2) || '0.00'}
                            </td>
                            <td>${statusBadge}</td>
                            <td style="font-size: 0.8rem; color: var(--text-muted);">
                                <div>${cardInfo}</div>
                                ${t.receiptUrl ? `<a href="${t.receiptUrl}" target="_blank" style="color: var(--accent); font-size: 0.7rem;">Receipt</a>` : ''}
                            </td>
                        </tr>
                    `;
                }).join('');
                
                // Add last updated timestamp
                const lastUpdated = stripeData.lastUpdated ? new Date(stripeData.lastUpdated).toLocaleTimeString() : 'now';
                const headerEl = document.querySelector('#transactionsTable')?.closest('.card')?.querySelector('.card-header h3');
                if (headerEl) {
                    headerEl.innerHTML = ` Recent Transactions <span style="font-size: 0.7rem; font-weight: normal; color: var(--text-muted);">Updated ${lastUpdated}</span>`;
                }
                
            } else {
                // Fallback to local data if Stripe API fails
                const transactions = [];
                
                Object.keys(allUserData).forEach(email => {
                    const userData = allUserData[email];
                    const billingHistory = userData.user?.billingHistory || [];
                    
                    billingHistory.forEach(transaction => {
                        transactions.push({
                            ...transaction,
                            userEmail: email,
                            userName: userData.user?.firstName || email.split('@')[0]
                        });
                    });
                });
                
                transactions.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                if (transactions.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 40px; color: var(--text-muted);">
                                No transactions yet. Transactions will appear as users subscribe.
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                const bankSettings = JSON.parse(localStorage.getItem('oith_bank_settings') || '{}');
                const bankDisplay = bankSettings.bankName ? `${bankSettings.bankName} ****${bankSettings.accountNumber?.slice(-4) || ''}` : 'Not configured';
                
                tbody.innerHTML = transactions.slice(0, 20).map(t => {
                    const date = new Date(t.date).toLocaleDateString();
                    const status = t.status === 'paid' ? 
                        '<span class="status-badge active">Paid</span>' : 
                        '<span class="status-badge warning">Pending</span>';
                    
                    return `
                        <tr>
                            <td>${date}</td>
                            <td>${t.userName}</td>
                            <td>${t.description || 'Subscription'}</td>
                            <td style="color: var(--success); font-weight: 500;">$${t.amount?.toFixed(2) || '10.00'}</td>
                            <td>${status}</td>
                            <td style="font-size: 0.8rem; color: var(--text-muted);">${bankDisplay}</td>
                        </tr>
                    `;
                }).join('');
            }
        }
        
        function exportTransactions() {
            const transactions = [];
            
            Object.keys(allUserData).forEach(email => {
                const userData = allUserData[email];
                const billingHistory = userData.user?.billingHistory || [];
                
                billingHistory.forEach(transaction => {
                    transactions.push({
                        date: transaction.date,
                        user: email,
                        description: transaction.description || 'Subscription',
                        amount: transaction.amount || 10.00,
                        status: transaction.status || 'paid'
                    });
                });
            });
            
            if (transactions.length === 0) {
                showToast('No transactions to export', 'info');
                return;
            }
            
            const csv = 'Date,User,Description,Amount,Status\n' + 
                transactions.map(t => 
                    `${t.date},${t.user},${t.description},$${t.amount},${t.status}`
                ).join('\n');
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `oith_transactions_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            
            showToast('Transactions exported!');
        }

        // ==========================================
        // ADVERTISING - Campaign & Spend Management
        // ==========================================
        
        // Global advertising data
        let advertisingData = {
            campaigns: [],
            budget: { daily: 500, monthly: 10000, alertThreshold: 80 },
            totalSpend: 0,
            platformSpend: { google: 0, meta: 0, tiktok: 0, apple: 0, twitter: 0 },
            dailySpend: [],
            metrics: { impressions: 0, clicks: 0, conversions: 0 }
        };
        
        async function renderAdvertising() {
            console.log(' Loading advertising data...');
            
            const sourceEl = document.getElementById('advertisingDataSource');
            if (sourceEl) {
                sourceEl.textContent = 'Loading...';
                sourceEl.style.background = 'var(--info)';
            }
            
            // Try to load from AWS
            try {
                const response = await fetch(`${AWS_API_URL}/advertising`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.advertising) {
                        advertisingData = { ...advertisingData, ...data.advertising };
                        console.log(' Loaded advertising data from AWS');
                        if (sourceEl) {
                            sourceEl.textContent = 'AWS Synced';
                            sourceEl.style.background = 'var(--success)';
                        }
                    }
                }
            } catch (error) {
                console.warn(' Could not fetch advertising from AWS:', error.message);
            }
            
            // Fallback to localStorage
            const saved = localStorage.getItem('oith_advertising_data');
            if (saved && !advertisingData.campaigns.length) {
                try {
                    advertisingData = { ...advertisingData, ...JSON.parse(saved) };
                    console.log(' Loaded advertising data from localStorage');
                    if (sourceEl) {
                        sourceEl.textContent = 'Local Data';
                        sourceEl.style.background = 'var(--warning)';
                    }
                } catch (e) {
                    console.error('Error parsing saved advertising data:', e);
                }
            }
            
            // Initialize with demo data if empty
            if (!advertisingData.campaigns.length) {
                advertisingData = generateDemoAdvertisingData();
                if (sourceEl) {
                    sourceEl.textContent = 'Demo Data';
                    sourceEl.style.background = 'var(--purple)';
                }
            }
            
            updateAdvertisingUI();
        }
        
        function generateDemoAdvertisingData() {
            const now = new Date();
            const campaigns = [
                {
                    id: 'camp_001',
                    name: 'App Launch Campaign',
                    platform: 'google',
                    status: 'active',
                    budget: 2000,
                    spent: 1247.50,
                    impressions: 125000,
                    clicks: 3125,
                    conversions: 312,
                    startDate: new Date(now - 14 * 24 * 60 * 60 * 1000).toISOString(),
                    endDate: null
                },
                {
                    id: 'camp_002',
                    name: 'Dating App Users',
                    platform: 'meta',
                    status: 'active',
                    budget: 1500,
                    spent: 892.30,
                    impressions: 89000,
                    clicks: 2670,
                    conversions: 178,
                    startDate: new Date(now - 10 * 24 * 60 * 60 * 1000).toISOString(),
                    endDate: null
                },
                {
                    id: 'camp_003',
                    name: 'Gen Z Awareness',
                    platform: 'tiktok',
                    status: 'active',
                    budget: 1000,
                    spent: 456.80,
                    impressions: 230000,
                    clicks: 4600,
                    conversions: 92,
                    startDate: new Date(now - 7 * 24 * 60 * 60 * 1000).toISOString(),
                    endDate: null
                },
                {
                    id: 'camp_004',
                    name: 'iOS App Store',
                    platform: 'apple',
                    status: 'active',
                    budget: 800,
                    spent: 234.20,
                    impressions: 15000,
                    clicks: 750,
                    conversions: 150,
                    startDate: new Date(now - 5 * 24 * 60 * 60 * 1000).toISOString(),
                    endDate: null
                },
                {
                    id: 'camp_005',
                    name: 'Brand Awareness',
                    platform: 'twitter',
                    status: 'paused',
                    budget: 500,
                    spent: 123.40,
                    impressions: 45000,
                    clicks: 450,
                    conversions: 23,
                    startDate: new Date(now - 21 * 24 * 60 * 60 * 1000).toISOString(),
                    endDate: null
                }
            ];
            
            // Generate daily spend for last 14 days
            const dailySpend = [];
            for (let i = 13; i >= 0; i--) {
                const date = new Date(now - i * 24 * 60 * 60 * 1000);
                dailySpend.push({
                    date: date.toISOString().split('T')[0],
                    amount: Math.round((150 + Math.random() * 150) * 100) / 100
                });
            }
            
            // Calculate platform spend
            const platformSpend = { google: 0, meta: 0, tiktok: 0, apple: 0, twitter: 0 };
            campaigns.forEach(c => {
                platformSpend[c.platform] = (platformSpend[c.platform] || 0) + c.spent;
            });
            
            const totalSpend = Object.values(platformSpend).reduce((a, b) => a + b, 0);
            const totalImpressions = campaigns.reduce((a, c) => a + c.impressions, 0);
            const totalClicks = campaigns.reduce((a, c) => a + c.clicks, 0);
            const totalConversions = campaigns.reduce((a, c) => a + c.conversions, 0);
            
            return {
                campaigns,
                budget: { daily: 500, monthly: 10000, alertThreshold: 80 },
                totalSpend,
                platformSpend,
                dailySpend,
                metrics: { 
                    impressions: totalImpressions, 
                    clicks: totalClicks, 
                    conversions: totalConversions 
                },
                audience: {
                    reach: 504000,
                    topAgeGroup: '18-24',
                    topLocation: 'New York',
                    topDevice: 'iOS'
                }
            };
        }
        
        function updateAdvertisingUI() {
            const data = advertisingData;
            
            // Update main stats
            document.getElementById('adTotalSpend').textContent = '$' + (data.totalSpend || 0).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
            document.getElementById('adImpressions').textContent = (data.metrics?.impressions || 0).toLocaleString();
            document.getElementById('adClicks').textContent = (data.metrics?.clicks || 0).toLocaleString();
            document.getElementById('adConversions').textContent = (data.metrics?.conversions || 0).toLocaleString();
            
            // Calculate rates
            const ctr = data.metrics?.impressions > 0 ? ((data.metrics.clicks / data.metrics.impressions) * 100).toFixed(2) : 0;
            const cpc = data.metrics?.clicks > 0 ? (data.totalSpend / data.metrics.clicks).toFixed(2) : 0;
            const cpi = data.metrics?.conversions > 0 ? (data.totalSpend / data.metrics.conversions).toFixed(2) : 0;
            const roas = data.totalSpend > 0 ? ((data.metrics.conversions * 10) / data.totalSpend).toFixed(1) : 0; // Assuming $10 LTV
            
            document.getElementById('adCTR').textContent = ctr + '%';
            document.getElementById('adCPC').textContent = '$' + cpc;
            document.getElementById('adCPI').textContent = '$' + cpi;
            document.getElementById('adROAS').textContent = roas + 'x';
            
            // Update platform spending bars
            const maxSpend = Math.max(...Object.values(data.platformSpend || {}), 1);
            ['google', 'meta', 'tiktok', 'apple', 'twitter'].forEach(platform => {
                const spend = data.platformSpend?.[platform] || 0;
                const spendEl = document.getElementById(platform + 'Spend');
                const barEl = document.getElementById(platform + 'SpendBar');
                if (spendEl) spendEl.textContent = '$' + spend.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
                if (barEl) barEl.style.width = ((spend / maxSpend) * 100) + '%';
            });
            
            // Update daily spend trend
            updateDailySpendChart(data.dailySpend || []);
            
            // Update campaigns table
            renderCampaignsTable(data.campaigns || []);
            
            // Update budget info
            document.getElementById('dailyBudgetLimit').value = data.budget?.daily || 500;
            document.getElementById('monthlyBudgetCap').value = data.budget?.monthly || 10000;
            document.getElementById('budgetAlertThreshold').value = data.budget?.alertThreshold || 80;
            
            const monthlyBudget = data.budget?.monthly || 10000;
            const usagePercent = monthlyBudget > 0 ? Math.round((data.totalSpend / monthlyBudget) * 100) : 0;
            document.getElementById('budgetUsagePercent').textContent = usagePercent + '%';
            document.getElementById('budgetUsageBar').style.width = Math.min(usagePercent, 100) + '%';
            document.getElementById('budgetUsageBar').style.background = usagePercent > 90 ? 'var(--danger)' : usagePercent > 70 ? 'var(--warning)' : 'var(--success)';
            document.getElementById('budgetSpentAmount').textContent = '$' + data.totalSpend.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
            document.getElementById('budgetRemainingAmount').textContent = '$' + Math.max(0, monthlyBudget - data.totalSpend).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
            
            // Update audience insights
            if (data.audience) {
                document.getElementById('audienceReach').textContent = (data.audience.reach || 0).toLocaleString();
                document.getElementById('topAgeGroup').textContent = data.audience.topAgeGroup || '18-24';
                document.getElementById('topLocation').textContent = data.audience.topLocation || '--';
                document.getElementById('topDevice').textContent = data.audience.topDevice || 'iOS';
            }
        }
        
        function updateDailySpendChart(dailySpend) {
            const barsContainer = document.getElementById('spendTrendBars');
            const labelsContainer = document.getElementById('spendTrendLabels');
            if (!barsContainer || !labelsContainer) return;
            
            const maxAmount = Math.max(...dailySpend.map(d => d.amount), 1);
            
            barsContainer.innerHTML = dailySpend.map((d, i) => {
                const height = (d.amount / maxAmount) * 100;
                const isToday = i === dailySpend.length - 1;
                return `<div style="flex: 1; background: ${isToday ? 'var(--accent)' : 'var(--accent-light)'}; height: ${height}%; border-radius: 4px 4px 0 0; opacity: ${isToday ? 1 : 0.7};" title="${d.date}: $${d.amount}"></div>`;
            }).join('');
            
            labelsContainer.innerHTML = dailySpend.filter((_, i) => i % 2 === 0 || i === dailySpend.length - 1).map(d => {
                const date = new Date(d.date);
                return `<span>${date.getMonth() + 1}/${date.getDate()}</span>`;
            }).join('');
        }
        
        function renderCampaignsTable(campaigns) {
            const tbody = document.getElementById('campaignsTableBody');
            if (!tbody) return;
            
            if (!campaigns.length) {
                tbody.innerHTML = `<tr><td colspan="10" style="text-align: center; color: var(--text-muted); padding: 40px;">No campaigns found. Click "New Campaign" to create one.</td></tr>`;
                return;
            }
            
            const platformIcons = {
                google: '',
                meta: '',
                tiktok: '',
                apple: '',
                twitter: ''
            };
            
            const platformNames = {
                google: 'Google Ads',
                meta: 'Meta',
                tiktok: 'TikTok',
                apple: 'Apple',
                twitter: 'Twitter/X'
            };
            
            tbody.innerHTML = campaigns.map(c => {
                const ctr = c.impressions > 0 ? ((c.clicks / c.impressions) * 100).toFixed(2) : 0;
                const cpc = c.clicks > 0 ? (c.spent / c.clicks).toFixed(2) : 0;
                const statusClass = c.status === 'active' ? 'success' : c.status === 'paused' ? 'warning' : 'danger';
                
                return `<tr>
                    <td><strong>${c.name}</strong></td>
                    <td>${platformIcons[c.platform] || ''} ${platformNames[c.platform] || c.platform}</td>
                    <td><span class="status-badge ${statusClass}" style="text-transform: capitalize;">${c.status}</span></td>
                    <td>$${c.budget.toLocaleString()}</td>
                    <td>$${c.spent.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                    <td>${c.impressions.toLocaleString()}</td>
                    <td>${c.clicks.toLocaleString()}</td>
                    <td>${ctr}%</td>
                    <td>$${cpc}</td>
                    <td>
                        <button class="btn btn-small btn-secondary" onclick="editCampaign('${c.id}')" title="Edit"></button>
                        <button class="btn btn-small btn-secondary" onclick="toggleCampaignStatus('${c.id}')" title="${c.status === 'active' ? 'Pause' : 'Resume'}">${c.status === 'active' ? '' : ''}</button>
                    </td>
                </tr>`;
            }).join('');
        }
        
        function filterCampaigns() {
            const filter = document.getElementById('campaignFilter').value;
            const filtered = filter === 'all' 
                ? advertisingData.campaigns 
                : advertisingData.campaigns.filter(c => c.platform === filter);
            renderCampaignsTable(filtered);
        }
        
        async function refreshAdvertisingData() {
            await renderAdvertising();
            showNotification('Advertising data refreshed', 'success');
        }
        
        async function saveAdvertisingBudget() {
            advertisingData.budget = {
                daily: parseFloat(document.getElementById('dailyBudgetLimit').value) || 500,
                monthly: parseFloat(document.getElementById('monthlyBudgetCap').value) || 10000,
                alertThreshold: parseInt(document.getElementById('budgetAlertThreshold').value) || 80
            };
            
            await saveAdvertisingToAWS();
            updateAdvertisingUI();
            showNotification('Budget settings saved', 'success');
        }
        
        async function saveAdvertisingToAWS() {
            // Save to localStorage first
            localStorage.setItem('oith_advertising_data', JSON.stringify(advertisingData));
            
            // Try to sync to AWS
            try {
                const response = await fetch(`${AWS_API_URL}/advertising`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ advertising: advertisingData })
                });
                
                if (response.ok) {
                    console.log(' Advertising data synced to AWS');
                    const sourceEl = document.getElementById('advertisingDataSource');
                    if (sourceEl) {
                        sourceEl.textContent = 'AWS Synced';
                        sourceEl.style.background = 'var(--success)';
                    }
                }
            } catch (error) {
                console.warn(' Could not sync advertising to AWS:', error.message);
            }
        }
        
        function showCreateCampaignModal() {
            const modal = document.createElement('div');
            modal.className = 'modal dynamic-modal';
            modal.style.display = 'flex';
            modal.id = 'createCampaignModal';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 500px;">
                    <div class="modal-header">
                        <h3> Create New Campaign</h3>
                        <button class="modal-close" onclick="document.getElementById('createCampaignModal').remove()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label>Campaign Name</label>
                            <input type="text" id="newCampaignName" placeholder="e.g., Summer Launch 2024" style="width: 100%; padding: 10px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary);">
                        </div>
                        <div class="form-group" style="margin-top: 16px;">
                            <label>Platform</label>
                            <select id="newCampaignPlatform" style="width: 100%; padding: 10px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary);">
                                <option value="google"> Google Ads</option>
                                <option value="meta"> Meta (Facebook/Instagram)</option>
                                <option value="tiktok"> TikTok</option>
                                <option value="apple"> Apple Search Ads</option>
                                <option value="twitter"> Twitter/X</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin-top: 16px;">
                            <label>Budget ($)</label>
                            <input type="number" id="newCampaignBudget" placeholder="1000" min="0" style="width: 100%; padding: 10px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary);">
                        </div>
                    </div>
                    <div class="modal-footer" style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 20px;">
                        <button class="btn btn-secondary" onclick="document.getElementById('createCampaignModal').remove()">Cancel</button>
                        <button class="btn btn-primary" onclick="createCampaign()">Create Campaign</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        async function createCampaign() {
            const name = document.getElementById('newCampaignName').value.trim();
            const platform = document.getElementById('newCampaignPlatform').value;
            const budget = parseFloat(document.getElementById('newCampaignBudget').value) || 0;
            
            if (!name) {
                showNotification('Please enter a campaign name', 'error');
                return;
            }
            
            if (budget <= 0) {
                showNotification('Please enter a valid budget', 'error');
                return;
            }
            
            const newCampaign = {
                id: 'camp_' + Date.now(),
                name,
                platform,
                status: 'active',
                budget,
                spent: 0,
                impressions: 0,
                clicks: 0,
                conversions: 0,
                startDate: new Date().toISOString(),
                endDate: null
            };
            
            advertisingData.campaigns.push(newCampaign);
            await saveAdvertisingToAWS();
            updateAdvertisingUI();
            
            document.getElementById('createCampaignModal').remove();
            showNotification('Campaign created successfully!', 'success');
        }
        
        function editCampaign(campaignId) {
            const campaign = advertisingData.campaigns.find(c => c.id === campaignId);
            if (!campaign) return;
            
            const modal = document.createElement('div');
            modal.className = 'modal dynamic-modal';
            modal.style.display = 'flex';
            modal.id = 'editCampaignModal';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 500px;">
                    <div class="modal-header">
                        <h3> Edit Campaign</h3>
                        <button class="modal-close" onclick="document.getElementById('editCampaignModal').remove()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label>Campaign Name</label>
                            <input type="text" id="editCampaignName" value="${campaign.name}" style="width: 100%; padding: 10px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary);">
                        </div>
                        <div class="form-group" style="margin-top: 16px;">
                            <label>Budget ($)</label>
                            <input type="number" id="editCampaignBudget" value="${campaign.budget}" min="0" style="width: 100%; padding: 10px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary);">
                        </div>
                        <div class="form-group" style="margin-top: 16px;">
                            <label>Status</label>
                            <select id="editCampaignStatus" style="width: 100%; padding: 10px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary);">
                                <option value="active" ${campaign.status === 'active' ? 'selected' : ''}>Active</option>
                                <option value="paused" ${campaign.status === 'paused' ? 'selected' : ''}>Paused</option>
                                <option value="ended" ${campaign.status === 'ended' ? 'selected' : ''}>Ended</option>
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer" style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 20px;">
                        <button class="btn btn-danger" onclick="deleteCampaign('${campaignId}')">Delete</button>
                        <button class="btn btn-secondary" onclick="document.getElementById('editCampaignModal').remove()">Cancel</button>
                        <button class="btn btn-primary" onclick="saveCampaignEdit('${campaignId}')">Save Changes</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        async function saveCampaignEdit(campaignId) {
            const campaign = advertisingData.campaigns.find(c => c.id === campaignId);
            if (!campaign) return;
            
            campaign.name = document.getElementById('editCampaignName').value.trim();
            campaign.budget = parseFloat(document.getElementById('editCampaignBudget').value) || campaign.budget;
            campaign.status = document.getElementById('editCampaignStatus').value;
            
            await saveAdvertisingToAWS();
            updateAdvertisingUI();
            
            document.getElementById('editCampaignModal').remove();
            showNotification('Campaign updated', 'success');
        }
        
        async function deleteCampaign(campaignId) {
            if (!confirm('Are you sure you want to delete this campaign?')) return;
            
            advertisingData.campaigns = advertisingData.campaigns.filter(c => c.id !== campaignId);
            await saveAdvertisingToAWS();
            updateAdvertisingUI();
            
            const modal = document.getElementById('editCampaignModal');
            if (modal) modal.remove();
            
            showNotification('Campaign deleted', 'success');
        }
        
        async function toggleCampaignStatus(campaignId) {
            const campaign = advertisingData.campaigns.find(c => c.id === campaignId);
            if (!campaign) return;
            
            campaign.status = campaign.status === 'active' ? 'paused' : 'active';
            await saveAdvertisingToAWS();
            updateAdvertisingUI();
            
            showNotification(`Campaign ${campaign.status === 'active' ? 'resumed' : 'paused'}`, 'success');
        }

        // ==========================================
        // GEOGRAPHIC
        // ==========================================
        
        function renderGeographic() {
            // Collect location data from all users
            const locationCounts = {};
            let totalUsers = 0;
            
            // Check all registered users and their data
            const allEmails = new Set([
                ...Object.keys(registeredUsers),
                ...Object.keys(allUserData)
            ]);
            
            allEmails.forEach(email => {
                const userData = allUserData[email] || {};
                const user = userData.user || {};
                const regUser = registeredUsers[email] || {};
                
                // Get location from user data
                let location = user.location || regUser.location || '';
                
                if (location && location.trim() !== '') {
                    // Normalize location name
                    location = location.trim();
                    locationCounts[location] = (locationCounts[location] || 0) + 1;
                    totalUsers++;
                }
            });
            
            // Convert to array and sort by count
            const locations = Object.entries(locationCounts)
                .map(([name, count]) => ({
                    name,
                    users: count,
                    percent: totalUsers > 0 ? Math.round((count / totalUsers) * 100) : 0,
                    flag: getLocationFlag(name)
                }))
                .sort((a, b) => b.users - a.users)
                .slice(0, 10); // Top 10 locations
            
            // If no real location data, show placeholder
            if (locations.length === 0) {
                document.getElementById('locationList').innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--text-muted);">
                        <div style="font-size: 2rem; margin-bottom: 8px;"></div>
                        <div>No location data available</div>
                        <div style="font-size: 0.8rem; margin-top: 4px;">User locations will appear as they set their profiles</div>
                    </div>
                `;
                return;
            }

            document.getElementById('locationList').innerHTML = locations.map(l => `
                <div class="location-item">
                    <div class="location-name">
                        <span class="location-flag">${l.flag}</span>
                        <span>${l.name}</span>
                    </div>
                    <div style="text-align: right">
                        <div style="font-weight: 600">${l.users}</div>
                        <div style="font-size: 0.75rem; color: var(--text-muted)">${l.percent}%</div>
                    </div>
                </div>
            `).join('');
        }
        
        function getLocationFlag(location) {
            // Map common locations to emoji flags
            const lowerLoc = location.toLowerCase();
            
            // US Cities
            if (lowerLoc.includes('new york') || lowerLoc.includes('nyc') || lowerLoc.includes('brooklyn') || lowerLoc.includes('manhattan')) return '';
            if (lowerLoc.includes('los angeles') || lowerLoc.includes('la,')) return '';
            if (lowerLoc.includes('san francisco') || lowerLoc.includes('sf')) return '';
            if (lowerLoc.includes('chicago')) return '';
            if (lowerLoc.includes('austin')) return '';
            if (lowerLoc.includes('miami')) return '';
            if (lowerLoc.includes('seattle')) return '';
            if (lowerLoc.includes('boston')) return '';
            if (lowerLoc.includes('denver') || lowerLoc.includes('colorado')) return '';
            if (lowerLoc.includes('portland')) return '';
            if (lowerLoc.includes('vegas') || lowerLoc.includes('las vegas')) return '';
            if (lowerLoc.includes('phoenix') || lowerLoc.includes('arizona')) return '';
            if (lowerLoc.includes('atlanta')) return '';
            if (lowerLoc.includes('dallas') || lowerLoc.includes('houston') || lowerLoc.includes('texas')) return '';
            if (lowerLoc.includes('washington') || lowerLoc.includes('dc')) return '';
            if (lowerLoc.includes('philadelphia')) return '';
            if (lowerLoc.includes('san diego')) return '';
            if (lowerLoc.includes('nashville')) return '';
            if (lowerLoc.includes('new orleans')) return '';
            
            // International
            if (lowerLoc.includes('london') || lowerLoc.includes('uk') || lowerLoc.includes('england')) return '';
            if (lowerLoc.includes('paris') || lowerLoc.includes('france')) return '';
            if (lowerLoc.includes('tokyo') || lowerLoc.includes('japan')) return '';
            if (lowerLoc.includes('sydney') || lowerLoc.includes('australia')) return '';
            if (lowerLoc.includes('toronto') || lowerLoc.includes('canada')) return '';
            
            // Default US flag for US locations
            if (lowerLoc.includes('usa') || lowerLoc.includes('us') || /\b[a-z]{2}\b/i.test(lowerLoc)) return '';
            
            // Default location pin
            return '';
        }

        // ==========================================
        // SAFETY & REPORTS
        // ==========================================
        
        function renderSafety() {
            // Get actual reports from localStorage
            const pendingReports = reports.filter(r => !r.resolved);
            const resolvedReports = reports.filter(r => r.resolved);
            
            // Update stat cards with real data
            document.getElementById('openReports').textContent = pendingReports.length;
            document.getElementById('resolvedReports').textContent = resolvedReports.length;
            document.getElementById('flaggedUsers').textContent = blockedUsers.length;
            
            // Count safety alerts sent and collect all alerts from users
            let safetyAlertsSent = 0;
            const safetyAlerts = [];
            const allAlertHistory = [];
            
            Object.keys(allUserData).forEach(email => {
                const userData = allUserData[email];
                const userName = userData.user?.firstName || registeredUsers[email]?.firstName || 'User';
                const emergencyContact = userData.user?.emergencyContact;
                
                // Collect all alerts from emergency contact history
                if (emergencyContact?.alertHistory) {
                    emergencyContact.alertHistory.forEach(alert => {
                        allAlertHistory.push({
                            ...alert,
                            userEmail: email,
                            userName: userName,
                            contactName: emergencyContact.name,
                            contactPhone: emergencyContact.phone
                        });
                        safetyAlertsSent++;
                    });
                }
                
                // Check for planned dates with emergency contacts
                if (userData.plannedDate && emergencyContact) {
                    safetyAlerts.push({
                        user: userName,
                        contact: `${emergencyContact.name || 'Contact'} (${emergencyContact.phone || 'N/A'})`,
                        date: userData.plannedDate.venue || 'Venue TBD',
                        time: userData.plannedDate.dateTime ? formatDateTimeShort(userData.plannedDate.dateTime) : 'Time TBD',
                        status: userData.plannedDate.notificationSent ? 'sent' : 'pending'
                    });
                }
            });
            
            // Sort alerts by date
            allAlertHistory.sort((a, b) => new Date(b.sentAt) - new Date(a.sentAt));
            
            document.getElementById('safetyAlerts').textContent = safetyAlertsSent;
            
            // Render pending reports
            if (pendingReports.length > 0) {
                document.getElementById('pendingReports').innerHTML = pendingReports.map(r => {
                    // Determine severity based on report type
                    let severity = 'warning';
                    let priorityLabel = 'Medium';
                    const criticalTypes = ['underage', 'threatening', 'hate-speech', 'Harassment', 'Threatening behavior'];
                    if (criticalTypes.includes(r.type) || criticalTypes.includes(r.reportType)) {
                        severity = 'danger';
                        priorityLabel = ' High Priority';
                    }
                    
                    const reportId = r.id || r.timestamp;
                    const reportedUser = r.reportedUser || r.aboutUser || 'Unknown';
                    
                    return `
                        <div class="report-card" style="${severity === 'danger' ? 'border-left: 3px solid var(--danger);' : ''}">
                            <div class="report-header">
                                <span class="report-type">${r.type || r.reportType || 'Report'}</span>
                                <span class="status-badge ${severity}">${priorityLabel}</span>
                            </div>
                            <div class="report-reason">${r.description || r.message || 'No description provided'}</div>
                            <div class="report-meta">
                                <span>Reported: ${reportedUser}</span>
                                <span>${r.timestamp ? formatTimeAgo(r.timestamp) : 'Recently'}</span>
                            </div>
                            <div style="margin-top: 12px; display: flex; gap: 8px; flex-wrap: wrap;">
                                <button class="btn btn-primary" style="font-size: 0.8rem; padding: 6px 16px;" onclick="openReportReview('${reportId}')">
                                     Review & Action
                                </button>
                                <button class="btn btn-secondary" style="font-size: 0.75rem; padding: 4px 12px;" onclick="resolveReport('${r.timestamp}')">
                                     Quick Dismiss
                                </button>
                                ${r.blockUser ? '<span class="status-badge danger" style="font-size: 0.65rem;">User Blocked</span>' : ''}
                            </div>
                        </div>
                    `;
                }).join('');
            } else {
                document.getElementById('pendingReports').innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--text-muted);">
                        <div style="font-size: 2rem; margin-bottom: 8px;"></div>
                        <div>No pending reports</div>
                        <div style="font-size: 0.8rem; margin-top: 4px;">All reports have been resolved</div>
                    </div>
                `;
            }

            // Render safety alerts - combine planned dates and alert history
            const allAlertsDisplay = [];
            
            // Add planned dates
            safetyAlerts.forEach(a => {
                allAlertsDisplay.push({
                    type: 'date_scheduled',
                    icon: '',
                    title: `<strong>${a.user}</strong> date at ${a.date}`,
                    subtitle: `Emergency contact: ${a.contact}  ${a.time}`,
                    status: a.status,
                    statusClass: a.status === 'sent' ? 'active' : 'warning',
                    date: new Date()
                });
            });
            
            // Add recent alert history
            allAlertHistory.slice(0, 10).forEach(a => {
                const alertDate = new Date(a.sentAt);
                let icon = '';
                let statusClass = 'active';
                
                if (a.type === 'sos') {
                    icon = '';
                    statusClass = 'danger';
                } else if (a.type === 'check_in') {
                    icon = '';
                    statusClass = 'success';
                }
                
                allAlertsDisplay.push({
                    type: a.type,
                    icon: icon,
                    title: `<strong>${a.userName}</strong> ${a.type === 'sos' ? 'SOS ALERT' : a.type === 'check_in' ? 'checked in' : 'date notification'}`,
                    subtitle: `To: ${a.toName} (${a.contactPhone || 'N/A'})`,
                    status: 'sent',
                    statusClass: statusClass,
                    date: alertDate,
                    timeAgo: formatTimeAgo(a.sentAt)
                });
            });
            
            if (allAlertsDisplay.length > 0) {
                document.getElementById('safetyAlertsList').innerHTML = allAlertsDisplay.map(a => `
                    <div class="activity-item" style="${a.type === 'sos' ? 'background: rgba(239, 68, 68, 0.1); border: 1px solid var(--danger);' : ''}">
                        <div class="activity-icon date">${a.icon}</div>
                        <div class="activity-content">
                            <div class="activity-text">${a.title}</div>
                            <div class="activity-time">${a.subtitle}${a.timeAgo ? '  ' + a.timeAgo : ''}</div>
                        </div>
                        <span class="status-badge ${a.statusClass}">${a.status}</span>
                    </div>
                `).join('');
            } else {
                document.getElementById('safetyAlertsList').innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--text-muted);">
                        <div style="font-size: 2rem; margin-bottom: 8px;"></div>
                        <div>No safety alerts yet</div>
                        <div style="font-size: 0.8rem; margin-top: 4px;">Alerts will appear when users set emergency contacts and plan dates</div>
                    </div>
                `;
            }
        }
        
        function resolveReport(timestamp) {
            // Find and mark report as resolved
            const reportIndex = reports.findIndex(r => r.timestamp === timestamp);
            if (reportIndex !== -1) {
                reports[reportIndex].resolved = true;
                reports[reportIndex].resolvedAt = new Date().toISOString();
                localStorage.setItem('oith_reports', JSON.stringify(reports));
                renderSafety();
                showToast('Report marked as resolved');
            }
        }
        
        // ==========================================
        // MODERATION & COMPLIANCE FUNCTIONS
        // ==========================================
        
        // Audit log storage
        let auditLog = JSON.parse(localStorage.getItem('oith_audit_log') || '[]');
        
        // Suspended users storage
        let suspendedUsers = JSON.parse(localStorage.getItem('oith_suspended_users') || '[]');
        
        // Moderation action history
        let moderationHistory = JSON.parse(localStorage.getItem('oith_moderation_history') || '[]');
        
        // Log an audit event
        function logAuditEvent(action, targetType, targetId, details = {}) {
            const event = {
                id: 'audit_' + Date.now(),
                timestamp: new Date().toISOString(),
                admin: 'Admin User', // In production, get from auth
                action: action,
                targetType: targetType,
                targetId: targetId,
                details: details,
                ipAddress: '127.0.0.1' // In production, get from request
            };
            auditLog.unshift(event);
            // Keep only last 1000 events
            if (auditLog.length > 1000) auditLog = auditLog.slice(0, 1000);
            localStorage.setItem('oith_audit_log', JSON.stringify(auditLog));
            updateComplianceStats();
        }
        
        // Switch safety tabs
        function switchSafetyTab(tab) {
            // Update tab UI
            document.querySelectorAll('#safety-section .tabs .tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            
            // Hide all tab content
            document.getElementById('safety-reports-tab').style.display = 'none';
            document.getElementById('safety-suspended-tab').style.display = 'none';
            document.getElementById('safety-moderation-tab').style.display = 'none';
            document.getElementById('safety-history-tab').style.display = 'none';
            
            // Show selected tab
            document.getElementById('safety-' + tab + '-tab').style.display = 'block';
            
            // Render content
            if (tab === 'suspended') renderSuspendedUsers();
            if (tab === 'history') renderModerationHistory();
        }
        
        // Switch compliance tabs
        function switchComplianceTab(tab) {
            // Update tab UI
            document.querySelectorAll('#compliance-section .tabs .tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            
            // Hide all tab content
            document.getElementById('compliance-deletion-tab').style.display = 'none';
            document.getElementById('compliance-audit-tab').style.display = 'none';
            document.getElementById('compliance-exports-tab').style.display = 'none';
            
            // Show selected tab
            document.getElementById('compliance-' + tab + '-tab').style.display = 'block';
            
            // Render content
            if (tab === 'audit') renderAuditLog();
        }
        
        // Render suspended users list
        function renderSuspendedUsers() {
            const container = document.getElementById('suspendedUsersList');
            if (!container) return;
            
            // Get suspended users from user data
            const suspended = [];
            Object.keys(allUserData).forEach(email => {
                const user = allUserData[email];
                if (user.suspended || user.banned) {
                    suspended.push({
                        email: email,
                        name: user.firstName || 'Unknown',
                        status: user.banned ? 'Banned' : 'Suspended',
                        reason: user.suspensionReason || 'Policy violation',
                        date: user.suspendedAt || new Date().toISOString(),
                        expiresAt: user.suspensionExpires || null
                    });
                }
            });
            
            // Also check local suspended users list
            suspendedUsers.forEach(su => {
                if (!suspended.find(s => s.email === su.email)) {
                    suspended.push(su);
                }
            });
            
            if (suspended.length === 0) {
                container.innerHTML = `
                    <div class="empty-state" style="text-align: center; padding: 40px; color: var(--text-muted);">
                        <div style="font-size: 3rem; margin-bottom: 12px;"></div>
                        <p>No suspended users</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = suspended.map(user => `
                <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; background: var(--bg-tertiary); border-radius: 8px; margin-bottom: 10px;">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <div style="width: 40px; height: 40px; border-radius: 50%; background: ${user.status === 'Banned' ? 'var(--danger)' : 'var(--warning)'}; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600;">
                            ${user.status === 'Banned' ? '' : ''}
                        </div>
                        <div>
                            <div style="font-weight: 600;">${user.name}</div>
                            <div style="font-size: 0.8rem; color: var(--text-muted);">${user.email}</div>
                        </div>
                    </div>
                    <div style="text-align: right;">
                        <span class="status-badge ${user.status === 'Banned' ? 'danger' : 'warning'}">${user.status}</span>
                        <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 4px;">
                            ${user.expiresAt ? 'Expires: ' + new Date(user.expiresAt).toLocaleDateString() : 'Permanent'}
                        </div>
                    </div>
                    <button onclick="openModerationModal('${user.email}')" class="btn btn-secondary" style="padding: 6px 12px; font-size: 0.8rem; margin-left: 12px;">
                        Manage
                    </button>
                </div>
            `).join('');
            
            // Update stat
            document.getElementById('suspendedCount').textContent = suspended.length;
        }
        
        // Render moderation action history
        function renderModerationHistory() {
            const container = document.getElementById('actionHistoryList');
            if (!container) return;
            
            if (moderationHistory.length === 0) {
                container.innerHTML = `
                    <div class="empty-state" style="text-align: center; padding: 40px; color: var(--text-muted);">
                        <div style="font-size: 3rem; margin-bottom: 12px;"></div>
                        <p>No moderation actions yet</p>
                    </div>
                `;
                return;
            }
            
            const actionIcons = {
                'warning': '',
                'suspend-7': '',
                'suspend-30': '',
                'ban': '',
                'unsuspend': '',
                'dismiss': ''
            };
            
            const actionColors = {
                'warning': 'var(--warning)',
                'suspend-7': '#f97316',
                'suspend-30': '#ea580c',
                'ban': 'var(--danger)',
                'unsuspend': 'var(--success)',
                'dismiss': 'var(--text-muted)'
            };
            
            container.innerHTML = moderationHistory.slice(0, 50).map(action => `
                <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; border-bottom: 1px solid var(--border);">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <div style="width: 36px; height: 36px; border-radius: 50%; background: ${actionColors[action.action]}; display: flex; align-items: center; justify-content: center; color: white;">
                            ${actionIcons[action.action] || ''}
                        </div>
                        <div>
                            <div style="font-weight: 500;">${action.actionLabel || action.action}</div>
                            <div style="font-size: 0.8rem; color: var(--text-muted);">Target: ${action.targetEmail || 'Unknown'}</div>
                        </div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 0.8rem; color: var(--text-muted);">${new Date(action.timestamp).toLocaleDateString()}</div>
                        <div style="font-size: 0.75rem; color: var(--text-muted);">${new Date(action.timestamp).toLocaleTimeString()}</div>
                    </div>
                </div>
            `).join('');
        }
        
        // Render audit log
        function renderAuditLog() {
            const tbody = document.getElementById('auditLogTableBody');
            if (!tbody) return;
            
            if (auditLog.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 40px; color: var(--text-muted);">
                            No audit events recorded
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = auditLog.slice(0, 100).map(event => `
                <tr style="border-bottom: 1px solid var(--border);">
                    <td style="padding: 10px 8px; color: var(--text-muted);">${new Date(event.timestamp).toLocaleString()}</td>
                    <td style="padding: 10px 8px;">${event.admin}</td>
                    <td style="padding: 10px 8px;">
                        <span class="status-badge ${event.action.includes('ban') || event.action.includes('delete') ? 'danger' : event.action.includes('suspend') ? 'warning' : 'active'}">
                            ${event.action}
                        </span>
                    </td>
                    <td style="padding: 10px 8px;">${event.targetId || '-'}</td>
                    <td style="padding: 10px 8px; font-size: 0.8rem; color: var(--text-muted);">${JSON.stringify(event.details).substring(0, 50)}...</td>
                </tr>
            `).join('');
        }
        
        // Update compliance stats
        function updateComplianceStats() {
            const thirtyDaysAgo = Date.now() - (30 * 24 * 60 * 60 * 1000);
            
            const recentAudit = auditLog.filter(e => new Date(e.timestamp).getTime() > thirtyDaysAgo);
            document.getElementById('auditEvents').textContent = recentAudit.length;
        }
        
        // Open report review modal
        function openReportReview(reportId) {
            const report = reports.find(r => r.id === reportId || r.timestamp === reportId);
            if (!report) {
                showToast('Report not found', 'error');
                return;
            }
            
            const modal = document.getElementById('reportReviewModal');
            modal.style.display = 'flex';
            
            // Populate report details
            document.getElementById('reportReviewType').textContent = report.type || report.reportType || 'Unknown';
            document.getElementById('reportReviewType').className = 'status-badge ' + (report.type === 'underage' || report.type === 'threatening' ? 'danger' : 'warning');
            document.getElementById('reportReviewDate').textContent = new Date(report.timestamp).toLocaleString();
            document.getElementById('reportReviewDescription').textContent = report.description || report.message || 'No description provided';
            
            // Populate reported user
            const reportedEmail = report.reportedUser || report.aboutUser;
            const reportedUser = allUserData[reportedEmail] || {};
            document.getElementById('reportedUserName').textContent = reportedUser.firstName || 'Unknown User';
            document.getElementById('reportedUserEmail').textContent = reportedEmail || 'Unknown';
            document.getElementById('reportedUserEmailHidden').value = reportedEmail;
            document.getElementById('reviewingReportId').value = reportId;
            
            // Count previous reports
            const previousReports = reports.filter(r => (r.reportedUser === reportedEmail || r.aboutUser === reportedEmail) && r.resolved).length;
            document.getElementById('reportedUserPreviousReports').textContent = previousReports;
            
            // Set status
            const statusBadge = document.getElementById('reportedUserStatus');
            if (reportedUser.banned) {
                statusBadge.textContent = 'Banned';
                statusBadge.className = 'status-badge danger';
            } else if (reportedUser.suspended) {
                statusBadge.textContent = 'Suspended';
                statusBadge.className = 'status-badge warning';
            } else {
                statusBadge.textContent = 'Active';
                statusBadge.className = 'status-badge active';
            }
            
            // Populate reporter
            const reporterEmail = report.reportedBy || report.fromUser;
            const reporter = allUserData[reporterEmail] || {};
            document.getElementById('reporterName').textContent = reporter.firstName || 'Anonymous';
            document.getElementById('reporterEmail').textContent = reporterEmail || 'Unknown';
            
            logAuditEvent('view_report', 'report', reportId, { reportedUser: reportedEmail });
        }
        
        function closeReportReviewModal() {
            document.getElementById('reportReviewModal').style.display = 'none';
        }
        
        function viewReportedUserProfile() {
            const email = document.getElementById('reportedUserEmailHidden').value;
            if (email && allUserData[email]) {
                closeReportReviewModal();
                openEditUserModal(email);
            }
        }
        
        // Resolve report with action
        function resolveReportWithAction(action) {
            const reportId = document.getElementById('reviewingReportId').value;
            const targetEmail = document.getElementById('reportedUserEmailHidden').value;
            const notes = document.getElementById('reportResolutionNotes').value;
            
            // Execute moderation action
            if (action !== 'dismiss') {
                executeModActionOnUser(targetEmail, action, notes);
            }
            
            // Mark report as resolved
            const reportIndex = reports.findIndex(r => r.id === reportId || r.timestamp === reportId);
            if (reportIndex !== -1) {
                reports[reportIndex].resolved = true;
                reports[reportIndex].resolvedAt = new Date().toISOString();
                reports[reportIndex].resolution = action;
                reports[reportIndex].resolutionNotes = notes;
                localStorage.setItem('oith_reports', JSON.stringify(reports));
            }
            
            // Log audit event
            logAuditEvent('resolve_report', 'report', reportId, { action, targetEmail, notes });
            
            // Record in moderation history
            moderationHistory.unshift({
                id: 'mod_' + Date.now(),
                timestamp: new Date().toISOString(),
                action: action,
                actionLabel: getActionLabel(action),
                targetEmail: targetEmail,
                reportId: reportId,
                notes: notes
            });
            localStorage.setItem('oith_moderation_history', JSON.stringify(moderationHistory));
            
            closeReportReviewModal();
            renderSafety();
            showToast('Report resolved: ' + getActionLabel(action), 'success');
        }
        
        function getActionLabel(action) {
            const labels = {
                'dismiss': 'Dismissed',
                'warning': 'Warning Sent',
                'suspend-7': 'Suspended 7 Days',
                'suspend-30': 'Suspended 30 Days',
                'ban': 'Permanently Banned',
                'unsuspend': 'Unsuspended'
            };
            return labels[action] || action;
        }
        
        // Open quick moderation modal
        function openModerationModal(email) {
            const user = allUserData[email] || {};
            const modal = document.getElementById('moderationActionModal');
            modal.style.display = 'flex';
            
            document.getElementById('modUserName').textContent = user.firstName || 'Unknown User';
            document.getElementById('modUserEmail').textContent = email;
            document.getElementById('modTargetUserEmail').value = email;
            document.getElementById('modActionReason').value = '';
            
            // Show unsuspend button if user is suspended
            const unsuspendBtn = document.getElementById('modUnsuspendBtn');
            if (user.suspended || user.banned) {
                unsuspendBtn.style.display = 'block';
            } else {
                unsuspendBtn.style.display = 'none';
            }
        }
        
        function closeModerationModal() {
            document.getElementById('moderationActionModal').style.display = 'none';
        }
        
        // Execute moderation action
        function executeModAction(action) {
            const email = document.getElementById('modTargetUserEmail').value;
            const reason = document.getElementById('modActionReason').value;
            
            executeModActionOnUser(email, action, reason);
            closeModerationModal();
        }
        
        function executeModActionOnUser(email, action, reason) {
            if (!email || !allUserData[email]) {
                showToast('User not found', 'error');
                return;
            }
            
            const user = allUserData[email];
            const now = new Date();
            
            switch(action) {
                case 'warning':
                    user.warnings = (user.warnings || 0) + 1;
                    user.lastWarning = now.toISOString();
                    user.lastWarningReason = reason;
                    showToast('Warning sent to ' + (user.firstName || email), 'success');
                    break;
                    
                case 'suspend-7':
                    user.suspended = true;
                    user.suspendedAt = now.toISOString();
                    user.suspensionExpires = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000).toISOString();
                    user.suspensionReason = reason;
                    user.banned = false;
                    showToast((user.firstName || email) + ' suspended for 7 days', 'success');
                    break;
                    
                case 'suspend-30':
                    user.suspended = true;
                    user.suspendedAt = now.toISOString();
                    user.suspensionExpires = new Date(now.getTime() + 30 * 24 * 60 * 60 * 1000).toISOString();
                    user.suspensionReason = reason;
                    user.banned = false;
                    showToast((user.firstName || email) + ' suspended for 30 days', 'success');
                    break;
                    
                case 'ban':
                    user.banned = true;
                    user.bannedAt = now.toISOString();
                    user.banReason = reason;
                    user.suspended = false;
                    showToast((user.firstName || email) + ' permanently banned', 'success');
                    break;
                    
                case 'unsuspend':
                    user.suspended = false;
                    user.banned = false;
                    user.unsuspendedAt = now.toISOString();
                    showToast((user.firstName || email) + ' unsuspended', 'success');
                    break;
            }
            
            // Save changes
            localStorage.setItem('oith_sync_data', JSON.stringify({ users: allUserData, lastSync: Date.now() }));
            
            // Log audit event
            logAuditEvent('moderation_action', 'user', email, { action, reason });
            
            // Record in moderation history
            moderationHistory.unshift({
                id: 'mod_' + Date.now(),
                timestamp: now.toISOString(),
                action: action,
                actionLabel: getActionLabel(action),
                targetEmail: email,
                reason: reason
            });
            localStorage.setItem('oith_moderation_history', JSON.stringify(moderationHistory));
            
            // Refresh displays
            renderUsers();
            renderSuspendedUsers();
        }
        
        // Export reports
        function exportReports() {
            const data = {
                exportedAt: new Date().toISOString(),
                totalReports: reports.length,
                pending: reports.filter(r => !r.resolved).length,
                resolved: reports.filter(r => r.resolved).length,
                reports: reports
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'oith_reports_' + new Date().toISOString().split('T')[0] + '.json';
            a.click();
            URL.revokeObjectURL(url);
            
            logAuditEvent('export_reports', 'reports', null, { count: reports.length });
            showToast('Reports exported', 'success');
        }
        
        // Export audit log
        function exportAuditLog() {
            const data = {
                exportedAt: new Date().toISOString(),
                totalEvents: auditLog.length,
                events: auditLog
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'oith_audit_log_' + new Date().toISOString().split('T')[0] + '.json';
            a.click();
            URL.revokeObjectURL(url);
            
            showToast('Audit log exported', 'success');
        }
        
        // Filter reports by type
        function filterReports() {
            const filterType = document.getElementById('reportFilterType').value;
            renderSafety(); // Re-render with filter
        }
        
        // Filter action history
        function filterActionHistory() {
            renderModerationHistory(); // Re-render with filter
        }
        
        // Filter audit log
        function filterAuditLog() {
            renderAuditLog(); // Re-render with filter
        }
        
        function formatDateTimeShort(dateString) {
            const date = new Date(dateString);
            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            
            let dayStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            if (date.toDateString() === today.toDateString()) {
                dayStr = 'Today';
            } else if (date.toDateString() === tomorrow.toDateString()) {
                dayStr = 'Tomorrow';
            }
            
            const timeStr = date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
            return `${dayStr} ${timeStr}`;
        }

        // ==========================================
        // FEEDBACK
        // ==========================================
        
        function renderFeedback() {
            // Collect feedback from match history and support messages
            const feedbackReasons = {};
            const recentFeedbackList = [];
            let totalFeedback = 0;
            let positiveEndings = 0;
            
            // Analyze match history for feedback
            Object.keys(allUserData).forEach(email => {
                const userData = allUserData[email];
                
                // Check match history for declined matches with reasons
                if (userData.matchHistory) {
                    userData.matchHistory.forEach(match => {
                        if (match.declineReason) {
                            const reason = match.declineReason;
                            feedbackReasons[reason] = (feedbackReasons[reason] || 0) + 1;
                            totalFeedback++;
                            
                            recentFeedbackList.push({
                                user: 'Anonymous',
                                reason: reason,
                                note: match.feedback || 'No additional comments',
                                time: match.endedAt || new Date().toISOString()
                            });
                        }
                        
                        // Count positive endings (mutual or had date)
                        if (match.hadDate || match.mutualEnd) {
                            positiveEndings++;
                        }
                    });
                }
            });
            
            // Also check support messages for feedback
            supportMessages.forEach(msg => {
                if (msg.subject && msg.subject.toLowerCase().includes('feedback')) {
                    const reason = 'User Feedback';
                    feedbackReasons[reason] = (feedbackReasons[reason] || 0) + 1;
                    totalFeedback++;
                    
                    recentFeedbackList.push({
                        user: 'Anonymous',
                        reason: msg.subject,
                        note: msg.message || 'No details',
                        time: msg.timestamp
                    });
                }
            });
            
            // Build reasons array with percentages
            const reasons = Object.entries(feedbackReasons).map(([reason, count]) => ({
                reason,
                count,
                percent: totalFeedback > 0 ? Math.round((count / totalFeedback) * 100) : 0
            })).sort((a, b) => b.count - a.count);
            
            // If no real feedback, show placeholder
            if (reasons.length === 0) {
                document.getElementById('feedbackBreakdown').innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--text-muted);">
                        <div style="font-size: 2rem; margin-bottom: 8px;"></div>
                        <div>No feedback collected yet</div>
                        <div style="font-size: 0.8rem; margin-top: 4px;">Feedback will appear as users end matches or submit reviews</div>
                    </div>
                `;
            } else {
                document.getElementById('feedbackBreakdown').innerHTML = reasons.map(r => `
                    <div class="feedback-item">
                        <div class="feedback-header">
                            <span class="feedback-reason">${r.reason}</span>
                            <span class="feedback-count">${r.count} (${r.percent}%)</span>
                        </div>
                        <div class="feedback-bar">
                            <div class="feedback-fill" style="width: ${r.percent}%"></div>
                        </div>
                    </div>
                `).join('');
            }

            // Sort recent feedback by time
            recentFeedbackList.sort((a, b) => new Date(b.time) - new Date(a.time));
            const topFeedback = recentFeedbackList.slice(0, 5);
            
            if (topFeedback.length === 0) {
                document.getElementById('recentFeedback').innerHTML = `
                    <div style="text-align: center; padding: 30px; color: var(--text-muted);">
                        <div>No recent feedback</div>
                    </div>
                `;
            } else {
                document.getElementById('recentFeedback').innerHTML = topFeedback.map(f => `
                    <div class="activity-item">
                        <div class="activity-content">
                            <div class="activity-text"><strong>${f.reason}</strong></div>
                            <div style="font-size: 0.85rem; color: var(--text-secondary); margin: 4px 0;">"${f.note}"</div>
                            <div class="activity-time">${f.user}  ${formatTimeAgo(f.time)}</div>
                        </div>
                    </div>
                `).join('');
            }

            // Calculate trends from actual data
            const totalMatches = Object.keys(allUserData).reduce((sum, email) => {
                const userData = allUserData[email];
                return sum + (userData.matchHistory?.length || 0) + (userData.activeConnection ? 1 : 0);
            }, 0);
            
            const feedbackRate = totalMatches > 0 ? Math.round((totalFeedback / totalMatches) * 100) : 0;
            const positiveRate = totalFeedback > 0 ? Math.round((positiveEndings / totalFeedback) * 100) : 0;

            document.getElementById('feedbackTrends').innerHTML = `
                <div class="metric-row"><span class="metric-label">Total Matches</span><span class="metric-value">${totalMatches}</span></div>
                <div class="metric-row"><span class="metric-label">Feedback Collected</span><span class="metric-value">${totalFeedback}</span></div>
                <div class="metric-row"><span class="metric-label">Feedback Rate</span><span class="metric-value">${feedbackRate}%</span></div>
                <div class="metric-row"><span class="metric-label">Positive Endings</span><span class="metric-value">${positiveRate}%</span></div>
            `;
        }

        function switchFeedbackTab(tab) {
            document.querySelectorAll('.tabs .tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            // In a full implementation, this would switch the content
        }

        // ==========================================
        // TEST BOTS
        // ==========================================
        
        // Test bot profiles - these are the demo profiles from the app
        let testBots = [];
        let botSettings = {
            responseDelay: 'fast',
            autoMatch: 'always',
            conversationStyle: 'friendly'
        };
        let botActivityLog = [];
        
        // Default test profiles matching the app's demo matches
        const defaultTestProfiles = [
            {
                id: 'bot_sarah',
                name: 'Sarah',
                age: 28,
                photo: 'https://images.unsplash.com/photo-1494790108377-be9c29b29330?w=400&h=500&fit=crop',
                occupation: 'Product Designer',
                location: 'Brooklyn, NY',
                bio: 'Coffee enthusiast, dog lover, and weekend hiker.',
                active: false,
                messagesSent: 0,
                matchesAccepted: 0
            },
            {
                id: 'bot_maya',
                name: 'Maya',
                age: 26,
                photo: 'https://images.unsplash.com/photo-1438761681033-6461ffad8d80?w=400&h=500&fit=crop',
                occupation: 'Marketing Manager',
                location: 'Manhattan, NY',
                bio: 'Art museum lover and brunch enthusiast.',
                active: false,
                messagesSent: 0,
                matchesAccepted: 0
            },
            {
                id: 'bot_priya',
                name: 'Priya',
                age: 27,
                photo: 'https://images.unsplash.com/photo-1531746020798-e6953c6e8e04?w=400&h=500&fit=crop',
                occupation: 'Software Engineer',
                location: 'Jersey City, NJ',
                bio: 'Tech nerd who loves board games and trying new restaurants.',
                active: false,
                messagesSent: 0,
                matchesAccepted: 0
            },
            {
                id: 'bot_grace',
                name: 'Grace',
                age: 29,
                photo: 'https://images.unsplash.com/photo-1524504388940-b1c1722653e1?w=400&h=500&fit=crop',
                occupation: 'Photographer',
                location: 'Williamsburg, NY',
                bio: 'Capturing moments and seeking adventures.',
                active: false,
                messagesSent: 0,
                matchesAccepted: 0
            },
            {
                id: 'bot_emma',
                name: 'Emma',
                age: 25,
                photo: 'https://images.unsplash.com/photo-1517841905240-472988babdf9?w=400&h=500&fit=crop',
                occupation: 'Yoga Instructor',
                location: 'Upper East Side, NY',
                bio: 'Mindfulness advocate, tea lover, sunset chaser.',
                active: false,
                messagesSent: 0,
                matchesAccepted: 0
            }
        ];

        // Bot response templates
        const botResponses = {
            friendly: [
                "Hey! So nice to match with you ",
                "Hi there! How's your day going?",
                "Hello! I love your profile! What brings you to OITH?",
                "Hey! Nice to meet you! What do you like to do for fun?",
                "Hi! I noticed we have some things in common ",
                "That's so cool! Tell me more about that.",
                "I totally agree! What else are you into?",
                "Haha that's funny! You seem like a fun person.",
                "Wow, that sounds amazing! I'd love to hear more.",
                "That's really interesting! How did you get into that?"
            ],
            flirty: [
                "Well hello there handsome ",
                "I have to say, your photos caught my eye!",
                "Is it just me or do we have great chemistry already?",
                "You seem like trouble... the good kind ",
                "I'd definitely swipe right on you twice if I could!"
            ],
            casual: [
                "Hey what's up?",
                "Cool profile! What are you looking for?",
                "Nice! So what do you do?",
                "That's cool. Any fun plans this weekend?",
                "Interesting! I'm into that too."
            ],
            professional: [
                "Hello, pleasure to connect with you.",
                "Thank you for matching. I'd love to learn more about you.",
                "Your background seems interesting. What industry are you in?",
                "I appreciate the thoughtful profile. What are you looking for?",
                "It's great to meet someone with similar interests."
            ]
        };

        function loadTestBots() {
            // Load from localStorage - DO NOT recreate defaults
            const saved = localStorage.getItem('oith_test_bots');
            if (saved) {
                testBots = JSON.parse(saved);
            } else {
                // Empty array - don't recreate default bots
                testBots = [];
            }
            
            // Load settings
            const savedSettings = localStorage.getItem('oith_bot_settings');
            if (savedSettings) {
                botSettings = JSON.parse(savedSettings);
            }
            
            // Load activity log
            const savedLog = localStorage.getItem('oith_bot_activity_log');
            if (savedLog) {
                botActivityLog = JSON.parse(savedLog);
            }
            
            updateBotBadge();
        }

        function saveTestBots() {
            localStorage.setItem('oith_test_bots', JSON.stringify(testBots));
            updateBotBadge();
            
            // Broadcast to app
            broadcastAdminSync('testbots_updated', { count: testBots.filter(b => b.active).length });
        }

        function updateBotBadge() {
            const activeCount = testBots.filter(b => b.active).length;
            const badge = document.getElementById('botsActiveBadge');
            if (badge) {
                badge.textContent = activeCount;
                badge.style.display = activeCount > 0 ? 'inline' : 'none';
            }
        }

        function renderTestBots() {
            loadTestBots();
            
            // Update stats
            const activeCount = testBots.filter(b => b.active).length;
            const totalMessages = testBots.reduce((sum, b) => sum + (b.messagesSent || 0), 0);
            const totalMatches = testBots.reduce((sum, b) => sum + (b.matchesAccepted || 0), 0);
            
            document.getElementById('totalBots').textContent = testBots.length;
            document.getElementById('activeBots').textContent = activeCount;
            document.getElementById('botMessagesSent').textContent = totalMessages;
            document.getElementById('botInteractions').textContent = totalMatches + totalMessages;
            
            // Restore settings dropdowns
            document.getElementById('botResponseDelay').value = botSettings.responseDelay;
            document.getElementById('botAutoMatch').value = botSettings.autoMatch;
            document.getElementById('botConversationStyle').value = botSettings.conversationStyle;
            
            // Render bot cards
            const grid = document.getElementById('testBotsGrid');
            grid.innerHTML = testBots.map(bot => `
                <div class="bot-card" style="background: var(--bg-tertiary); border-radius: 12px; padding: 16px; border: 2px solid ${bot.active ? 'var(--success)' : 'var(--border)'}; transition: all 0.3s;">
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                        <img src="${bot.photo}" style="width: 50px; height: 50px; border-radius: 50%; object-fit: cover;">
                        <div style="flex: 1;">
                            <div style="font-weight: 600; display: flex; align-items: center; gap: 8px;">
                                ${bot.name}, ${bot.age}
                                ${bot.active ? '<span style="width: 8px; height: 8px; background: var(--success); border-radius: 50%; animation: pulse 2s infinite;"></span>' : ''}
                            </div>
                            <div style="font-size: 0.8rem; color: var(--text-muted);">${bot.occupation}</div>
                        </div>
                        <label class="toggle-switch" style="position: relative; width: 50px; height: 26px;">
                            <input type="checkbox" ${bot.active ? 'checked' : ''} onchange="toggleBot('${bot.id}')" style="opacity: 0; width: 0; height: 0;">
                            <span style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background: ${bot.active ? 'var(--success)' : 'var(--bg-primary)'}; border-radius: 26px; transition: 0.4s; border: 1px solid var(--border);">
                                <span style="position: absolute; content: ''; height: 20px; width: 20px; left: ${bot.active ? '26px' : '3px'}; bottom: 2px; background: white; border-radius: 50%; transition: 0.4s;"></span>
                            </span>
                        </label>
                    </div>
                    <div style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 12px;">
                         ${bot.location}
                    </div>
                    <div style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 12px; font-style: italic;">
                        "${bot.bio}"
                    </div>
                    <div style="display: flex; gap: 16px; font-size: 0.75rem; color: var(--text-muted); padding-top: 12px; border-top: 1px solid var(--border);">
                        <span> ${bot.messagesSent || 0} msgs</span>
                        <span> ${bot.matchesAccepted || 0} matches</span>
                    </div>
                    <div style="display: flex; gap: 8px; margin-top: 12px;">
                        <button class="btn btn-secondary" onclick="testBotMessage('${bot.id}')" style="flex: 1; font-size: 0.75rem; padding: 6px;">
                            Send Test Msg
                        </button>
                        <button class="btn btn-secondary" onclick="editTestBot('${bot.id}')" style="font-size: 0.75rem; padding: 6px 12px;" title="Edit Bot">
                            
                        </button>
                        <button class="btn btn-secondary" onclick="deleteTestBot('${bot.id}')" style="font-size: 0.75rem; padding: 6px 12px; color: var(--error);" title="Delete Bot">
                            
                        </button>
                    </div>
                </div>
            `).join('');
            
            // Render activity log
            renderBotActivityLog();
        }

        function toggleBot(botId) {
            const bot = testBots.find(b => b.id === botId);
            if (bot) {
                bot.active = !bot.active;
                saveTestBots();
                logBotActivity(bot.name, bot.active ? 'Bot activated' : 'Bot deactivated', bot.active ? 'success' : 'warning');
                renderTestBots();
            }
        }

        function toggleAllBots(activate) {
            testBots.forEach(bot => {
                bot.active = activate;
            });
            saveTestBots();
            logBotActivity('System', activate ? 'All bots activated' : 'All bots paused', activate ? 'success' : 'warning');
            renderTestBots();
        }

        function updateBotSettings() {
            botSettings = {
                responseDelay: document.getElementById('botResponseDelay').value,
                autoMatch: document.getElementById('botAutoMatch').value,
                conversationStyle: document.getElementById('botConversationStyle').value
            };
            localStorage.setItem('oith_bot_settings', JSON.stringify(botSettings));
            logBotActivity('System', 'Bot settings updated', 'info');
        }

        function testBotMessage(botId) {
            const bot = testBots.find(b => b.id === botId);
            if (!bot) return;
            
            // Get a random response based on conversation style
            const style = botSettings.conversationStyle === 'random' 
                ? ['friendly', 'flirty', 'casual', 'professional'][Math.floor(Math.random() * 4)]
                : botSettings.conversationStyle;
            
            const responses = botResponses[style] || botResponses.friendly;
            const message = responses[Math.floor(Math.random() * responses.length)];
            
            bot.messagesSent = (bot.messagesSent || 0) + 1;
            saveTestBots();
            
            logBotActivity(bot.name, `Sent: "${message}"`, 'message');
            showToast(`${bot.name}: "${message}"`);
            renderTestBots();
        }

        function logBotActivity(botName, action, type = 'info') {
            const entry = {
                timestamp: new Date().toISOString(),
                botName,
                action,
                type
            };
            botActivityLog.unshift(entry);
            
            // Keep only last 100 entries
            if (botActivityLog.length > 100) {
                botActivityLog = botActivityLog.slice(0, 100);
            }
            
            localStorage.setItem('oith_bot_activity_log', JSON.stringify(botActivityLog));
            renderBotActivityLog();
        }

        function renderBotActivityLog() {
            const container = document.getElementById('botActivityLog');
            if (!container) return;
            
            if (botActivityLog.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 30px; color: var(--text-muted);">
                        <div>No bot activity yet</div>
                        <div style="font-size: 0.8rem; margin-top: 4px;">Activity will appear as bots interact</div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = botActivityLog.slice(0, 20).map(entry => {
                const typeColors = {
                    success: 'var(--success)',
                    warning: 'var(--warning)',
                    message: 'var(--info)',
                    info: 'var(--text-muted)'
                };
                const typeIcons = {
                    success: '',
                    warning: '',
                    message: '',
                    info: ''
                };
                
                return `
                    <div style="display: flex; align-items: flex-start; gap: 10px; padding: 8px 0; border-bottom: 1px solid var(--border);">
                        <span style="font-size: 1rem;">${typeIcons[entry.type] || ''}</span>
                        <div style="flex: 1;">
                            <span style="font-weight: 500; color: ${typeColors[entry.type]}">${entry.botName}</span>
                            <span style="color: var(--text-secondary);"> ${entry.action}</span>
                        </div>
                        <span style="font-size: 0.75rem; color: var(--text-muted);">${formatTimeAgo(entry.timestamp)}</span>
                    </div>
                `;
            }).join('');
        }

        function clearBotLog() {
            botActivityLog = [];
            localStorage.setItem('oith_bot_activity_log', JSON.stringify(botActivityLog));
            renderBotActivityLog();
            showToast('Activity log cleared');
        }

        // Random data generators for bot profiles
        const randomBotData = {
            femaleNames: ['Emma', 'Olivia', 'Ava', 'Isabella', 'Sophia', 'Mia', 'Charlotte', 'Amelia', 'Harper', 'Evelyn', 'Luna', 'Aria', 'Chloe', 'Penelope', 'Lily', 'Zoe', 'Nora', 'Riley', 'Stella', 'Hazel'],
            maleNames: ['Liam', 'Noah', 'Oliver', 'James', 'Elijah', 'William', 'Henry', 'Lucas', 'Benjamin', 'Theodore', 'Jack', 'Leo', 'Owen', 'Daniel', 'Jackson', 'Ethan', 'Mason', 'Logan', 'Alexander', 'Sebastian'],
            occupations: ['Software Engineer', 'Marketing Manager', 'Product Designer', 'Data Scientist', 'Photographer', 'Yoga Instructor', 'Financial Analyst', 'Nurse', 'Teacher', 'Architect', 'Writer', 'Chef', 'Doctor', 'Lawyer', 'Artist', 'Musician', 'Entrepreneur', 'Consultant', 'Physical Therapist', 'Real Estate Agent'],
            locations: ['Brooklyn, NY', 'Manhattan, NY', 'Jersey City, NJ', 'Hoboken, NJ', 'Queens, NY', 'Upper East Side, NY', 'Williamsburg, NY', 'SoHo, NY', 'Chelsea, NY', 'West Village, NY', 'Long Island City, NY', 'Astoria, NY', 'Park Slope, NY', 'DUMBO, NY', 'Tribeca, NY'],
            bioStarters: [
                'Looking for someone to explore the city with.',
                'Coffee enthusiast, dog lover, and weekend hiker.',
                'Art museum lover and brunch enthusiast.',
                'Tech nerd who loves board games and trying new restaurants.',
                'Capturing moments and seeking adventures.',
                'Mindfulness advocate, tea lover, sunset chaser.',
                'Bookworm by day, foodie by night.',
                'Fitness junkie and travel addict.',
                'Creative soul with a passion for music.',
                'Nature lover who enjoys a good Netflix binge.'
            ],
            interests: ['Hiking', 'Travel', 'Cooking', 'Movies', 'Reading', 'Yoga', 'Photography', 'Music', 'Art', 'Dancing', 'Sports', 'Gaming', 'Wine', 'Coffee', 'Pets', 'Fitness', 'Theater', 'Concerts', 'Brunch', 'Beach'],
            heights: ["5'0\"", "5'2\"", "5'4\"", "5'6\"", "5'8\"", "5'10\"", "6'0\"", "6'2\""],
            bodyTypes: ['Slim', 'Athletic', 'Average', 'Curvy'],
            ethnicities: ['white', 'black', 'asian', 'hispanic', 'mixed'],
            educations: ['High School', 'Some College', "Bachelor's", "Master's", 'Doctorate'],
            relationshipGoals: ['relationship', 'casual', 'marriage', 'unsure']
        };

        function getRandomItem(arr) {
            return arr[Math.floor(Math.random() * arr.length)];
        }

        function generateRandomBot() {
            const gender = Math.random() > 0.5 ? 'female' : 'male';
            const names = gender === 'female' ? randomBotData.femaleNames : randomBotData.maleNames;
            const name = getRandomItem(names);
            const age = Math.floor(Math.random() * 15) + 21; // 21-35
            
            // Generate photo URL based on gender
            const photoSeed = Date.now() + Math.random();
            const photo = gender === 'female' 
                ? `https://randomuser.me/api/portraits/women/${Math.floor(Math.random() * 99)}.jpg`
                : `https://randomuser.me/api/portraits/men/${Math.floor(Math.random() * 99)}.jpg`;
            
            const newBot = {
                id: 'bot_' + Date.now(),
                name: name,
                age: age,
                gender: gender,
                photo: photo,
                occupation: getRandomItem(randomBotData.occupations),
                location: getRandomItem(randomBotData.locations),
                bio: getRandomItem(randomBotData.bioStarters),
                height: getRandomItem(randomBotData.heights),
                bodyType: getRandomItem(randomBotData.bodyTypes),
                ethnicity: getRandomItem(randomBotData.ethnicities),
                education: getRandomItem(randomBotData.educations),
                relationshipGoal: getRandomItem(randomBotData.relationshipGoals),
                interests: [getRandomItem(randomBotData.interests), getRandomItem(randomBotData.interests), getRandomItem(randomBotData.interests)].filter((v, i, a) => a.indexOf(v) === i),
                active: false,
                messagesSent: 0,
                matchesAccepted: 0
            };
            
            testBots.push(newBot);
            saveTestBots();
            logBotActivity('System', `Random bot "${name}" generated`, 'success');
            showToast(` Random bot "${name}" created!`);
            renderTestBots();
        }

        function createNewTestBot() {
            // Open modal for manual creation
            document.getElementById('botModalTitle').textContent = 'Create Test Bot';
            document.getElementById('botEditId').value = '';
            document.getElementById('botForm').reset();
            document.getElementById('botModal').style.display = 'flex';
        }

        function editTestBot(botId) {
            const bot = testBots.find(b => b.id === botId);
            if (!bot) return;
            
            // Populate modal with existing data
            document.getElementById('botModalTitle').textContent = 'Edit Test Bot';
            document.getElementById('botEditId').value = botId;
            document.getElementById('botName').value = bot.name || '';
            document.getElementById('botAge').value = bot.age || 25;
            document.getElementById('botGender').value = bot.gender || 'female';
            document.getElementById('botOccupation').value = bot.occupation || '';
            document.getElementById('botLocation').value = bot.location || '';
            document.getElementById('botBio').value = bot.bio || '';
            document.getElementById('botPhoto').value = bot.photo || '';
            document.getElementById('botHeight').value = bot.height || "5'6\"";
            document.getElementById('botBodyType').value = bot.bodyType || 'Average';
            document.getElementById('botEthnicity').value = bot.ethnicity || 'white';
            document.getElementById('botEducation').value = bot.education || "Bachelor's";
            document.getElementById('botRelationshipGoal').value = bot.relationshipGoal || 'relationship';
            
            document.getElementById('botModal').style.display = 'flex';
        }

        function closeBotModal() {
            document.getElementById('botModal').style.display = 'none';
            document.getElementById('botForm').reset();
        }

        function saveBotForm(event) {
            event.preventDefault();
            
            const editId = document.getElementById('botEditId').value;
            const name = document.getElementById('botName').value.trim();
            const age = parseInt(document.getElementById('botAge').value) || 25;
            const gender = document.getElementById('botGender').value;
            const occupation = document.getElementById('botOccupation').value.trim();
            const location = document.getElementById('botLocation').value.trim();
            const bio = document.getElementById('botBio').value.trim();
            let photo = document.getElementById('botPhoto').value.trim();
            const height = document.getElementById('botHeight').value;
            const bodyType = document.getElementById('botBodyType').value;
            const ethnicity = document.getElementById('botEthnicity').value;
            const education = document.getElementById('botEducation').value;
            const relationshipGoal = document.getElementById('botRelationshipGoal').value;
            
            // Generate photo if not provided
            if (!photo) {
                const photoNum = Math.floor(Math.random() * 99);
                photo = gender === 'female' 
                    ? `https://randomuser.me/api/portraits/women/${photoNum}.jpg`
                    : `https://randomuser.me/api/portraits/men/${photoNum}.jpg`;
            }
            
            if (editId) {
                // Update existing bot
                const bot = testBots.find(b => b.id === editId);
                if (bot) {
                    bot.name = name;
                    bot.age = age;
                    bot.gender = gender;
                    bot.occupation = occupation || 'Professional';
                    bot.location = location || 'New York, NY';
                    bot.bio = bio || 'Looking to meet new people!';
                    bot.photo = photo;
                    bot.height = height;
                    bot.bodyType = bodyType;
                    bot.ethnicity = ethnicity;
                    bot.education = education;
                    bot.relationshipGoal = relationshipGoal;
                    
                    logBotActivity('System', `Bot "${name}" updated`, 'info');
                    logAdminActivity('user', 'Updated test bot', name, { gender: gender, location: location });
                    showToast(` Bot "${name}" updated!`);
                }
            } else {
                // Create new bot
                const newBot = {
                    id: 'bot_' + Date.now(),
                    name: name,
                    age: age,
                    gender: gender,
                    photo: photo,
                    occupation: occupation || 'Professional',
                    location: location || 'New York, NY',
                    bio: bio || 'Looking to meet new people!',
                    height: height,
                    bodyType: bodyType,
                    ethnicity: ethnicity,
                    education: education,
                    relationshipGoal: relationshipGoal,
                    active: false,
                    messagesSent: 0,
                    matchesAccepted: 0
                };
                
                testBots.push(newBot);
                logBotActivity('System', `New bot "${name}" created`, 'success');
                logAdminActivity('create', 'Created test bot', name, { gender: gender, location: location });
                showToast(` Bot "${name}" created!`);
            }
            
            saveTestBots();
            closeBotModal();
            renderTestBots();
        }

        function deleteTestBot(botId) {
            const bot = testBots.find(b => b.id === botId);
            if (!bot) return;
            
            if (confirm(`Are you sure you want to delete "${bot.name}"?`)) {
                testBots = testBots.filter(b => b.id !== botId);
                saveTestBots();
                logBotActivity('System', `Bot "${bot.name}" deleted`, 'warning');
                logAdminActivity('delete', 'Deleted test bot', bot.name);
                showToast(` Bot "${bot.name}" deleted`);
                renderTestBots();
            }
        }

        // Test bots are loaded on-demand when viewing Test Bots section
        // NOT on page load (AWS mode = no automatic bot loading)

        // ==========================================
        // SCREEN PREVIEW (User App Flow)
        // ==========================================
        
        // Map component names to actual screen IDs in index.html
        const screenIdMap = {
            'splash': 'splash',
            'login': 'login',
            'signup': 'signup',
            'onboarding': 'onboarding-1',
            'preferences': 'preferences',
            'profile-details': 'profile-details',
            'profile-setup': 'profile-setup',
            'payment': 'payment',
            'match': 'match',
            'waiting-match': 'waiting-match',
            'no-matches': 'no-matches',
            'profile-view': 'profile-view',
            'chat-list': 'chat-list',
            'chat': 'chat',
            'date-plan': 'date-plan',
            'my-profile': 'my-profile',
            'edit-profile': 'edit-profile',
            'manage-photos': 'manage-photos',
            'match-preferences-edit': 'match-preferences',
            'settings': 'settings',
            'safety-privacy': 'safety-privacy',
            'manage-subscription': 'manage-subscription',
            'feedback-metrics': 'feedback-metrics'
        };
        
        let currentPreviewScreen = '';
        let flowNodesInitialized = false;
        
        // Initialize click handlers for flow nodes - ONLY in User App Flow section
        function initFlowNodeClicks() {
            // Only target nodes within the User App Flow diagram, not Admin dashboard nav
            const userAppFlow = document.getElementById('userAppFlowDiagram');
            if (!userAppFlow) {
                console.warn(' User App Flow diagram not found');
                return;
            }
            
            const nodes = userAppFlow.querySelectorAll('.flow-node[data-component], .tree-node[data-component]');
            console.log(` Initializing ${nodes.length} clickable flow nodes (User App Flow only)`);
            
            nodes.forEach(node => {
                const component = node.getAttribute('data-component');
                if (component && !node.hasAttribute('data-click-init')) {
                    node.setAttribute('data-click-init', 'true');
                    node.style.cursor = 'pointer';
                    node.title = 'Click to preview this screen';
                    // Remove any existing onclick (like showSection) and replace with preview
                    node.removeAttribute('onclick');
                    node.onclick = (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        openScreenPreview(component, node);
                    };
                }
            });
            flowNodesInitialized = true;
        }
        
        function openScreenPreview(component, nodeEl) {
            console.log(' Opening preview for:', component);
            const screenId = screenIdMap[component] || component;
            currentPreviewScreen = screenId;
            
            const pageId = nodeEl?.getAttribute('data-page-id') || '';
            const screenName = nodeEl?.textContent?.trim() || component;
            
            const titleEl = document.getElementById('previewScreenTitle');
            const idEl = document.getElementById('previewScreenId');
            const frameEl = document.getElementById('screenPreviewFrame');
            const modalEl = document.getElementById('screenPreviewModal');
            
            if (titleEl) titleEl.textContent = screenName;
            if (idEl) idEl.textContent = `Screen ID: ${screenId} | Page: ${pageId}`;
            
            // Load the screen in iframe with query param, preview mode flag, and cache buster
            // preview=true tells index.html to skip all data operations
            const previewUrl = `index.html?screen=${screenId}&preview=true&t=${Date.now()}`;
            console.log(' Loading URL:', previewUrl);
            if (frameEl) frameEl.src = previewUrl;
            
            // Show modal
            if (modalEl) {
                modalEl.style.display = 'flex';
                modalEl.style.opacity = '1';
                modalEl.style.visibility = 'visible';
            }
        }
        
        function closeScreenPreview() {
            const modalEl = document.getElementById('screenPreviewModal');
            const frameEl = document.getElementById('screenPreviewFrame');
            if (modalEl) modalEl.style.display = 'none';
            if (frameEl) frameEl.src = '';
        }
        
        function openPreviewInNewTab() {
            if (currentPreviewScreen) {
                window.open(`index.html?screen=${currentPreviewScreen}&preview=true&t=${Date.now()}`, '_blank');
            }
        }
        
        // Initialize flow node clicks after DOM loads and when sections change
        document.addEventListener('DOMContentLoaded', () => {
            // Initial setup
            setTimeout(initFlowNodeClicks, 500);
            
            // Re-init when overview section is shown
            setTimeout(initFlowNodeClicks, 1000);
            setTimeout(initFlowNodeClicks, 2000);
        });

        // ==========================================
        // LEGAL / PATENTS & IP
        // ==========================================
        
        // Load patent documents from localStorage (and sync from DynamoDB on first load)
        let patentDocsLoaded = false;
        function getPatentDocuments() {
            try {
                // Load from DynamoDB on first access
                if (!patentDocsLoaded) {
                    loadPatentDocumentsFromAWS();
                    patentDocsLoaded = true;
                }
                return JSON.parse(localStorage.getItem('oith_patent_documents') || '{}');
            } catch (e) {
                return {};
            }
        }
        
        // Save patent documents to localStorage AND DynamoDB
        async function savePatentDocuments(docs) {
            localStorage.setItem('oith_patent_documents', JSON.stringify(docs));
            await savePatentDocumentsToAWS(docs);
        }
        
        // Save patent documents to DynamoDB
        async function savePatentDocumentsToAWS(docs) {
            try {
                const response = await fetch(`${AWS_API_URL}/documents/patent`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ documents: docs })
                });
                if (response.ok) {
                    console.log(' Patent documents synced to AWS');
                }
            } catch (error) {
                console.log(' Could not sync patent docs to AWS:', error.message);
            }
        }
        
        // Load patent documents from DynamoDB
        async function loadPatentDocumentsFromAWS() {
            try {
                const response = await fetch(`${AWS_API_URL}/documents/patent`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.documents && Object.keys(data.documents).length > 0) {
                        localStorage.setItem('oith_patent_documents', JSON.stringify(data.documents));
                        console.log(' Patent documents loaded from AWS');
                    }
                }
            } catch (error) {
                console.log('Using local patent documents');
            }
        }
        
        // Upload patent document
        function uploadPatentDocument(patentId) {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.pdf,.doc,.docx,.txt,.png,.jpg,.jpeg,.zip';
            input.multiple = true;
            input.onchange = async (e) => {
                const files = Array.from(e.target.files);
                if (!files.length) return;
                
                const docs = getPatentDocuments();
                if (!docs[patentId]) {
                    docs[patentId] = [];
                }
                
                for (const file of files) {
                    // Check file size (max 10MB each)
                    if (file.size > 10 * 1024 * 1024) {
                        showToast(` ${file.name} is too large. Max 10MB allowed.`, 'error');
                        continue;
                    }
                    
                    try {
                        const base64 = await fileToBase64(file);
                        docs[patentId].push({
                            id: Date.now() + Math.random(),
                            fileName: file.name,
                            fileType: file.type,
                            fileSize: file.size,
                            uploadedAt: new Date().toISOString(),
                            data: base64
                        });
                    } catch (err) {
                        console.error('Upload error:', err);
                        showToast(` Failed to upload ${file.name}`, 'error');
                    }
                }
                
                savePatentDocuments(docs);
                showToast(` Uploaded ${files.length} file(s)`, 'success');
                renderLegal();
            };
            input.click();
        }
        
        // View/download patent document
        function viewPatentDocument(patentId, docId) {
            const docs = getPatentDocuments();
            const patentDocs = docs[patentId] || [];
            const doc = patentDocs.find(d => d.id === docId);
            if (!doc) {
                showToast(' Document not found', 'error');
                return;
            }
            
            const a = document.createElement('a');
            a.href = doc.data;
            a.download = doc.fileName;
            a.click();
        }
        
        // Delete patent document
        function deletePatentDocument(patentId, docId) {
            if (!confirm('Delete this document?')) return;
            
            const docs = getPatentDocuments();
            if (docs[patentId]) {
                docs[patentId] = docs[patentId].filter(d => d.id !== docId);
                if (docs[patentId].length === 0) {
                    delete docs[patentId];
                }
                savePatentDocuments(docs);
                showToast(' Document deleted', 'info');
                renderLegal();
            }
        }
        
        // View all documents for a patent
        function viewPatentDocuments(patentId, patentTitle) {
            const docs = getPatentDocuments();
            const patentDocs = docs[patentId] || [];
            
            const modal = document.createElement('div');
            modal.id = 'patentDocsModal';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 20px;';
            
            modal.innerHTML = `
                <div style="background: var(--bg-primary); border-radius: 16px; max-width: 700px; width: 100%; max-height: 80vh; overflow: hidden; display: flex; flex-direction: column;">
                    <div style="padding: 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h3 style="margin: 0 0 4px;"> Documents</h3>
                            <p style="margin: 0; font-size: 0.85rem; color: var(--text-muted);">${patentTitle} (${patentId})</p>
                        </div>
                        <button onclick="document.getElementById('patentDocsModal').remove()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-muted);"></button>
                    </div>
                    <div style="padding: 20px; overflow-y: auto; flex: 1;">
                        ${patentDocs.length === 0 ? `
                            <div style="text-align: center; padding: 40px; color: var(--text-muted);">
                                <div style="font-size: 3rem; margin-bottom: 16px;"></div>
                                <p>No documents uploaded yet</p>
                            </div>
                        ` : `
                            <div style="display: flex; flex-direction: column; gap: 12px;">
                                ${patentDocs.map(doc => `
                                    <div style="display: flex; align-items: center; gap: 12px; padding: 16px; background: var(--bg-tertiary); border-radius: 12px;">
                                        <div style="width: 48px; height: 48px; background: var(--info)20; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">
                                            ${getFileIcon(doc.fileName)}
                                        </div>
                                        <div style="flex: 1; min-width: 0;">
                                            <div style="font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="${doc.fileName}">${doc.fileName}</div>
                                            <div style="font-size: 0.75rem; color: var(--text-muted);">
                                                ${formatFileSize(doc.fileSize)}  Uploaded ${new Date(doc.uploadedAt).toLocaleDateString()}
                                            </div>
                                        </div>
                                        <div style="display: flex; gap: 8px;">
                                            <button onclick="viewPatentDocument('${patentId}', ${doc.id})" style="padding: 8px 12px; background: var(--info); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.8rem;">
                                                 Download
                                            </button>
                                            <button onclick="deletePatentDocument('${patentId}', ${doc.id}); document.getElementById('patentDocsModal').remove();" style="padding: 8px 12px; background: var(--danger)20; color: var(--danger); border: 1px solid var(--danger); border-radius: 6px; cursor: pointer; font-size: 0.8rem;">
                                                
                                            </button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        `}
                        
                        <button onclick="document.getElementById('patentDocsModal').remove(); uploadPatentDocument('${patentId}')" style="width: 100%; margin-top: 16px; padding: 14px; background: var(--accent); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 0.9rem; display: flex; align-items: center; justify-content: center; gap: 8px;">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M17 8l-5-5-5 5M12 3v12"/></svg>
                            Upload Document
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            modal.onclick = (e) => {
                if (e.target === modal) modal.remove();
            };
        }
        
        // Get file icon based on extension
        function getFileIcon(fileName) {
            const ext = fileName.split('.').pop().toLowerCase();
            const icons = {
                'pdf': '',
                'doc': '',
                'docx': '',
                'txt': '',
                'png': '',
                'jpg': '',
                'jpeg': '',
                'zip': '',
                'default': ''
            };
            return icons[ext] || icons['default'];
        }

        function renderLegal() {
            // Load uploaded documents
            const uploadedDocs = getPatentDocuments();
            
            // Patent Applications
            const patents = [
                {
                    id: 'PA-2024-001',
                    title: 'Single-Match Dating Algorithm',
                    number: 'PA-2024-001',
                    status: 'Provisional Filed',
                    statusColor: 'var(--warning)',
                    date: 'Q4 2024',
                    description: 'System and Method for Sequential Single-Match Dating with Timed Decision Windows'
                },
                {
                    id: 'PA-2024-002',
                    title: 'Mutual Match Verification System',
                    number: 'PA-2024-002',
                    status: 'Provisional Filed',
                    statusColor: 'var(--warning)',
                    date: 'Q4 2024',
                    description: 'Bidirectional Match Confirmation with Synchronized Timer Reset'
                },
                {
                    id: 'PA-2025-001',
                    title: 'Conversation-Based Venue Recommendation',
                    number: 'PA-2025-001',
                    status: 'Drafting',
                    statusColor: 'var(--info)',
                    date: 'Q1 2025',
                    description: 'AI-Driven Date Venue Suggestions Based on Chat Content Analysis'
                },
                {
                    id: 'PA-2025-002',
                    title: 'Profile Visibility Management',
                    number: 'PA-2025-002',
                    status: 'Planned',
                    statusColor: 'var(--text-muted)',
                    date: 'Q1 2025',
                    description: 'Automated Profile Visibility Control Based on Match Status'
                },
                {
                    id: 'PA-2025-003',
                    title: 'Safety-First Date Planning',
                    number: 'PA-2025-003',
                    status: 'Planned',
                    statusColor: 'var(--text-muted)',
                    date: 'Q1 2025',
                    description: 'Emergency Contact Notification System for Dating Applications'
                },
                {
                    id: 'PA-2025-004',
                    title: 'One-Match-at-a-Time Business Model',
                    number: 'PA-2025-004',
                    status: 'Planned',
                    statusColor: 'var(--text-muted)',
                    date: 'Q2 2025',
                    description: 'Focused Dating Platform with Limited Match Presentation'
                }
            ];

            document.getElementById('patentList').innerHTML = patents.map(p => {
                const docs = uploadedDocs[p.id] || [];
                const docCount = docs.length;
                
                return `
                <div style="padding: 20px; background: var(--bg-tertiary); border-radius: 12px; margin-bottom: 16px;">
                    <div style="display: flex; align-items: flex-start; gap: 16px;">
                        <div style="flex: 1;">
                            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                                <span style="font-weight: 600; font-size: 1.05rem;">${p.title}</span>
                                <span style="background: ${p.statusColor}20; color: ${p.statusColor}; padding: 4px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 500;">${p.status}</span>
                            </div>
                            <div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 12px;">${p.description}</div>
                            <div style="display: flex; align-items: center; gap: 16px; font-size: 0.8rem;">
                                <span style="background: var(--bg-primary); padding: 4px 10px; border-radius: 6px; color: var(--text-secondary);">
                                     ${p.number}
                                </span>
                                <span style="color: var(--text-muted);">
                                     Target: ${p.date}
                                </span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Documents Section -->
                    <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border);">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span style="font-size: 0.9rem; font-weight: 500;"> Documents</span>
                                <span style="background: ${docCount > 0 ? 'var(--success)' : 'var(--text-muted)'}20; color: ${docCount > 0 ? 'var(--success)' : 'var(--text-muted)'}; padding: 2px 8px; border-radius: 10px; font-size: 0.75rem;">
                                    ${docCount} file${docCount !== 1 ? 's' : ''}
                                </span>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                ${docCount > 0 ? `
                                    <button onclick="viewPatentDocuments('${p.id}', '${p.title}')" style="padding: 8px 14px; background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border); border-radius: 6px; cursor: pointer; font-size: 0.8rem; display: flex; align-items: center; gap: 6px;">
                                         View All
                                    </button>
                                ` : ''}
                                <button onclick="uploadPatentDocument('${p.id}')" style="padding: 8px 14px; background: var(--accent); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.8rem; display: flex; align-items: center; gap: 6px;">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M17 8l-5-5-5 5M12 3v12"/></svg>
                                    Upload
                                </button>
                            </div>
                        </div>
                        
                        ${docCount > 0 ? `
                            <div style="margin-top: 12px; display: flex; flex-wrap: wrap; gap: 8px;">
                                ${docs.slice(0, 3).map(doc => `
                                    <div onclick="viewPatentDocument('${p.id}', ${doc.id})" style="display: flex; align-items: center; gap: 6px; padding: 6px 10px; background: var(--bg-secondary); border-radius: 6px; cursor: pointer; font-size: 0.8rem;" title="${doc.fileName}">
                                        ${getFileIcon(doc.fileName)}
                                        <span style="max-width: 120px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${doc.fileName}</span>
                                    </div>
                                `).join('')}
                                ${docCount > 3 ? `
                                    <div onclick="viewPatentDocuments('${p.id}', '${p.title}')" style="padding: 6px 10px; background: var(--info)20; color: var(--info); border-radius: 6px; cursor: pointer; font-size: 0.8rem;">
                                        +${docCount - 3} more
                                    </div>
                                ` : ''}
                            </div>
                        ` : `
                            <div style="margin-top: 12px; padding: 16px; background: var(--bg-secondary); border-radius: 8px; text-align: center; color: var(--text-muted); font-size: 0.85rem;">
                                No documents uploaded yet. Click "Upload" to add files.
                            </div>
                        `}
                    </div>
                </div>
            `}).join('');
            
            // Document upload summary
            const totalDocs = Object.values(uploadedDocs).reduce((sum, arr) => sum + arr.length, 0);
            const patentsWithDocs = Object.keys(uploadedDocs).length;
            
            // Add summary before patent list
            const patentList = document.getElementById('patentList');
            const summaryHtml = `
                <div style="display: flex; gap: 16px; margin-bottom: 20px;">
                    <div style="flex: 1; padding: 16px; background: var(--bg-tertiary); border-radius: 12px; text-align: center;">
                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--accent);">${patents.length}</div>
                        <div style="font-size: 0.8rem; color: var(--text-muted);">Patent Applications</div>
                    </div>
                    <div style="flex: 1; padding: 16px; background: var(--bg-tertiary); border-radius: 12px; text-align: center;">
                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--success);">${totalDocs}</div>
                        <div style="font-size: 0.8rem; color: var(--text-muted);">Documents Uploaded</div>
                    </div>
                    <div style="flex: 1; padding: 16px; background: var(--bg-tertiary); border-radius: 12px; text-align: center;">
                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--info);">${patentsWithDocs}</div>
                        <div style="font-size: 0.8rem; color: var(--text-muted);">With Documents</div>
                    </div>
                </div>
            `;
            patentList.innerHTML = summaryHtml + patentList.innerHTML;

            // Trademarks
            const trademarks = [
                { mark: 'OITH', type: 'Word Mark', status: 'Pending', classes: '9, 42, 45' },
                { mark: 'ONE IN THE HAND', type: 'Word Mark', status: 'Pending', classes: '9, 42, 45' },
                { mark: '"Quality dates, not endless swipes"', type: 'Slogan', status: 'Pending', classes: '9, 42, 45' },
                { mark: 'OITH Logo (Bird design)', type: 'Design Mark', status: 'Pending', classes: '9, 42, 45' }
            ];

            document.getElementById('trademarkList').innerHTML = trademarks.map(t => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid var(--border);">
                    <div>
                        <div style="font-weight: 500;">${t.mark}</div>
                        <div style="font-size: 0.75rem; color: var(--text-muted);">${t.type}  Classes ${t.classes}</div>
                    </div>
                    <span style="background: var(--warning)20; color: var(--warning); padding: 2px 8px; border-radius: 12px; font-size: 0.75rem;">${t.status}</span>
                </div>
            `).join('');

            // Copyrights
            const copyrights = [
                { work: 'OITH Mobile Application v1.0', type: 'Software', year: '2024', status: 'Registered' },
                { work: 'OITH Brand Guidelines', type: 'Documentation', year: '2024', status: 'Pending' },
                { work: 'OITH Marketing Materials', type: 'Creative Works', year: '2024', status: 'Pending' }
            ];

            document.getElementById('copyrightList').innerHTML = copyrights.map(c => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid var(--border);">
                    <div>
                        <div style="font-weight: 500;">${c.work}</div>
                        <div style="font-size: 0.75rem; color: var(--text-muted);">${c.type}  ${c.year}</div>
                    </div>
                    <span style="background: ${c.status === 'Registered' ? 'var(--success)' : 'var(--warning)'}20; color: ${c.status === 'Registered' ? 'var(--success)' : 'var(--warning)'}; padding: 2px 8px; border-radius: 12px; font-size: 0.75rem;">${c.status}</span>
                </div>
            `).join('');

            // Trade Secrets
            const secrets = [
                { name: 'Matching Algorithm Weights', category: 'Technical', protection: 'NDA + Access Control' },
                { name: 'Compatibility Scoring Formulas', category: 'Technical', protection: 'NDA + Encryption' },
                { name: 'User Behavior Analytics Models', category: 'Business Intelligence', protection: 'NDA + Access Control' },
                { name: 'Churn Risk Calculations', category: 'Business Intelligence', protection: 'NDA + Encryption' },
                { name: 'User Acquisition Strategies', category: 'Business', protection: 'NDA' }
            ];

            document.getElementById('tradeSecretsList').innerHTML = `
                <div style="background: var(--bg-tertiary); padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                    <div style="display: flex; align-items: center; gap: 8px; color: var(--warning); margin-bottom: 12px;">
                        <span></span>
                        <span style="font-weight: 600;">Confidential Information - Need-to-Know Basis Only</span>
                    </div>
                    <p style="font-size: 0.85rem; color: var(--text-secondary); margin: 0;">
                        The following are maintained as trade secrets under the Defend Trade Secrets Act (DTSA). 
                        Access is restricted and all personnel must sign NDAs.
                    </p>
                </div>
                ${secrets.map(s => `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: var(--bg-tertiary); border-radius: 8px; margin-bottom: 8px;">
                        <div>
                            <div style="font-weight: 500;"> ${s.name}</div>
                            <div style="font-size: 0.75rem; color: var(--text-muted);">${s.category}</div>
                        </div>
                        <div style="font-size: 0.75rem; color: var(--text-secondary);">${s.protection}</div>
                    </div>
                `).join('')}
            `;

            // Filing Timeline
            document.getElementById('filingTimeline').innerHTML = `
                <div style="position: relative; padding-left: 30px;">
                    <div style="position: absolute; left: 10px; top: 0; bottom: 0; width: 2px; background: var(--border);"></div>
                    
                    <div style="position: relative; margin-bottom: 24px;">
                        <div style="position: absolute; left: -26px; width: 12px; height: 12px; background: var(--success); border-radius: 50%;"></div>
                        <div style="font-weight: 600; color: var(--success);">Q4 2024 - Provisional Patents</div>
                        <div style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 4px;">File provisional applications for core algorithms</div>
                    </div>
                    
                    <div style="position: relative; margin-bottom: 24px;">
                        <div style="position: absolute; left: -26px; width: 12px; height: 12px; background: var(--info); border-radius: 50%;"></div>
                        <div style="font-weight: 600; color: var(--info);">Q1 2025 - Additional Patents</div>
                        <div style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 4px;">File venue recommendation and safety system patents</div>
                    </div>
                    
                    <div style="position: relative; margin-bottom: 24px;">
                        <div style="position: absolute; left: -26px; width: 12px; height: 12px; background: var(--warning); border-radius: 50%;"></div>
                        <div style="font-weight: 600; color: var(--warning);">Q2 2025 - Business Method Patent</div>
                        <div style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 4px;">File one-match-at-a-time business model patent</div>
                    </div>
                    
                    <div style="position: relative; margin-bottom: 24px;">
                        <div style="position: absolute; left: -26px; width: 12px; height: 12px; background: var(--purple); border-radius: 50%;"></div>
                        <div style="font-weight: 600; color: var(--purple);">Q4 2025 - PCT Application</div>
                        <div style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 4px;">File PCT for international protection</div>
                    </div>
                    
                    <div style="position: relative;">
                        <div style="position: absolute; left: -26px; width: 12px; height: 12px; background: var(--text-muted); border-radius: 50%;"></div>
                        <div style="font-weight: 600; color: var(--text-muted);">2026-2027 - National Phase Entry</div>
                        <div style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 4px;">Enter national phase in US, EU, UK, Canada, Australia</div>
                    </div>
                </div>
            `;
        }

        // Load compliance documents from localStorage (and sync from DynamoDB on first load)
        let complianceDocsLoaded = false;
        function getComplianceDocuments() {
            try {
                // Load from DynamoDB on first access
                if (!complianceDocsLoaded) {
                    loadComplianceDocumentsFromAWS();
                    complianceDocsLoaded = true;
                }
                return JSON.parse(localStorage.getItem('oith_compliance_documents') || '{}');
            } catch (e) {
                return {};
            }
        }
        
        // Save compliance documents to localStorage AND DynamoDB
        async function saveComplianceDocuments(docs) {
            localStorage.setItem('oith_compliance_documents', JSON.stringify(docs));
            await saveComplianceDocumentsToAWS(docs);
        }
        
        // Save compliance documents to DynamoDB
        async function saveComplianceDocumentsToAWS(docs) {
            try {
                const response = await fetch(`${AWS_API_URL}/documents/compliance`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ documents: docs })
                });
                if (response.ok) {
                    console.log(' Compliance documents synced to AWS');
                }
            } catch (error) {
                console.log(' Could not sync compliance docs to AWS:', error.message);
            }
        }
        
        // Load compliance documents from DynamoDB
        async function loadComplianceDocumentsFromAWS() {
            try {
                const response = await fetch(`${AWS_API_URL}/documents/compliance`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.documents && Object.keys(data.documents).length > 0) {
                        localStorage.setItem('oith_compliance_documents', JSON.stringify(data.documents));
                        console.log(' Compliance documents loaded from AWS');
                    }
                }
            } catch (error) {
                console.log('Using local compliance documents');
            }
        }
        
        // Upload compliance document
        function uploadComplianceDocument(itemId) {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.pdf,.doc,.docx,.txt,.png,.jpg,.jpeg';
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                // Check file size (max 10MB)
                if (file.size > 10 * 1024 * 1024) {
                    showToast(' File too large. Max 10MB allowed.', 'error');
                    return;
                }
                
                try {
                    // Convert to base64 for localStorage storage
                    const base64 = await fileToBase64(file);
                    
                    const docs = getComplianceDocuments();
                    docs[itemId] = {
                        fileName: file.name,
                        fileType: file.type,
                        fileSize: file.size,
                        uploadedAt: new Date().toISOString(),
                        data: base64
                    };
                    saveComplianceDocuments(docs);
                    
                    showToast(` Uploaded: ${file.name}`, 'success');
                    renderCompliance(); // Re-render to show updated status
                    
                } catch (err) {
                    console.error('Upload error:', err);
                    showToast(' Failed to upload: ' + err.message, 'error');
                }
            };
            input.click();
        }
        
        // Convert file to base64
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }
        
        // View/download compliance document
        function viewComplianceDocument(itemId) {
            const docs = getComplianceDocuments();
            const doc = docs[itemId];
            if (!doc) {
                showToast(' Document not found', 'error');
                return;
            }
            
            // Create download link
            const a = document.createElement('a');
            a.href = doc.data;
            a.download = doc.fileName;
            a.click();
        }
        
        // Delete compliance document
        function deleteComplianceDocument(itemId) {
            if (!confirm('Are you sure you want to delete this document?')) return;
            
            const docs = getComplianceDocuments();
            delete docs[itemId];
            saveComplianceDocuments(docs);
            
            showToast(' Document deleted', 'info');
            renderCompliance();
        }
        
        // Format file size
        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }
        
        function renderCompliance() {
            // Load existing documents
            const uploadedDocs = getComplianceDocuments();
            
            // Compliance Checklist
            const complianceItems = [
                { id: 'gdpr', item: 'GDPR Compliance', status: 'compliant', region: 'EU', details: 'Data protection and privacy' },
                { id: 'ccpa', item: 'CCPA Compliance', status: 'compliant', region: 'California', details: 'Consumer privacy rights' },
                { id: 'appstore', item: 'App Store Guidelines', status: 'compliant', region: 'Global', details: 'Apple & Google policies' },
                { id: 'ada', item: 'ADA Accessibility', status: 'compliant', region: 'US', details: 'Digital accessibility standards' },
                { id: 'pci', item: 'PCI DSS', status: 'compliant', region: 'Global', details: 'Payment card security' },
                { id: 'soc2', item: 'SOC 2 Type II', status: 'pending', region: 'US', details: 'Security audit certification' },
                { id: 'coppa', item: 'COPPA Compliance', status: 'compliant', region: 'US', details: 'Child online privacy (18+ only)' },
                { id: 'canspam', item: 'CAN-SPAM Act', status: 'compliant', region: 'US', details: 'Email marketing rules' },
                { id: 'tcpa', item: 'TCPA Compliance', status: 'compliant', region: 'US', details: 'Telephone consumer protection' },
                { id: 'section230', item: 'Section 230 Protection', status: 'compliant', region: 'US', details: 'Platform liability protection' },
                { id: 'lgpd', item: 'LGPD Compliance', status: 'pending', region: 'Brazil', details: 'Brazilian data protection' },
                { id: 'tos', item: 'Terms of Service', status: 'compliant', region: 'Global', details: 'User agreements in place' }
            ];

            document.getElementById('complianceChecklist').innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 12px;">
                    ${complianceItems.map(c => {
                        const doc = uploadedDocs[c.id];
                        const hasDoc = !!doc;
                        return `
                        <div style="padding: 16px; background: var(--bg-tertiary); border-radius: 12px; border-left: 4px solid ${c.status === 'compliant' ? 'var(--success)' : 'var(--warning)'};">
                            <div style="display: flex; align-items: flex-start; gap: 12px; margin-bottom: 12px;">
                                <span style="font-size: 1.3rem;">${c.status === 'compliant' ? '' : ''}</span>
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; font-size: 0.95rem;">${c.item}</div>
                                    <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 2px;">${c.region}  ${c.details}</div>
                                </div>
                            </div>
                            
                            <!-- Document Section -->
                            <div style="background: var(--bg-secondary); border-radius: 8px; padding: 10px;">
                                ${hasDoc ? `
                                    <!-- Document Uploaded -->
                                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                        <span style="font-size: 1.1rem;"></span>
                                        <div style="flex: 1; min-width: 0;">
                                            <div style="font-size: 0.8rem; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="${doc.fileName}">${doc.fileName}</div>
                                            <div style="font-size: 0.7rem; color: var(--text-muted);">${formatFileSize(doc.fileSize)}  ${new Date(doc.uploadedAt).toLocaleDateString()}</div>
                                        </div>
                                    </div>
                                    <div style="display: flex; gap: 6px;">
                                        <button onclick="viewComplianceDocument('${c.id}')" style="flex: 1; padding: 6px 10px; background: var(--info); color: white; border: none; border-radius: 6px; font-size: 0.75rem; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 4px;">
                                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"/></svg>
                                            Download
                                        </button>
                                        <button onclick="uploadComplianceDocument('${c.id}')" style="flex: 1; padding: 6px 10px; background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border); border-radius: 6px; font-size: 0.75rem; cursor: pointer;">
                                            Replace
                                        </button>
                                        <button onclick="deleteComplianceDocument('${c.id}')" style="padding: 6px 10px; background: transparent; color: var(--danger); border: 1px solid var(--danger); border-radius: 6px; font-size: 0.75rem; cursor: pointer;">
                                            
                                        </button>
                                    </div>
                                ` : `
                                    <!-- No Document -->
                                    <div style="text-align: center;">
                                        <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 8px;">No document uploaded</div>
                                        <button onclick="uploadComplianceDocument('${c.id}')" style="width: 100%; padding: 8px 12px; background: var(--accent); color: white; border: none; border-radius: 6px; font-size: 0.8rem; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px;">
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M17 8l-5-5-5 5M12 3v12"/></svg>
                                            Upload Document
                                        </button>
                                    </div>
                                `}
                            </div>
                        </div>
                    `}).join('')}
                </div>
                
                <!-- Summary -->
                <div style="margin-top: 20px; padding: 16px; background: var(--bg-tertiary); border-radius: 12px; display: flex; justify-content: space-around; text-align: center;">
                    <div>
                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--success);">${Object.keys(uploadedDocs).length}</div>
                        <div style="font-size: 0.8rem; color: var(--text-muted);">Documents Uploaded</div>
                    </div>
                    <div>
                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--warning);">${complianceItems.length - Object.keys(uploadedDocs).length}</div>
                        <div style="font-size: 0.8rem; color: var(--text-muted);">Missing Documents</div>
                    </div>
                    <div>
                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--info);">${Math.round((Object.keys(uploadedDocs).length / complianceItems.length) * 100)}%</div>
                        <div style="font-size: 0.8rem; color: var(--text-muted);">Completion Rate</div>
                    </div>
                </div>
            `;

            // Employee Agreements
            const agreements = [
                { name: 'Invention Assignment Agreement', required: true, description: 'All work product belongs to OITH' },
                { name: 'Confidentiality/NDA', required: true, description: 'Non-disclosure of proprietary information' },
                { name: 'Non-Compete Agreement', required: false, description: 'Where legally enforceable' },
                { name: 'Code of Conduct', required: true, description: 'Professional standards and ethics' },
                { name: 'Data Handling Policy', required: true, description: 'User data protection protocols' }
            ];

            document.getElementById('employeeAgreements').innerHTML = agreements.map(a => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid var(--border);">
                    <div>
                        <div style="font-weight: 500;">${a.name}</div>
                        <div style="font-size: 0.75rem; color: var(--text-muted);">${a.description}</div>
                    </div>
                    <span style="background: ${a.required ? 'var(--danger)' : 'var(--text-muted)'}20; color: ${a.required ? 'var(--danger)' : 'var(--text-muted)'}; padding: 2px 8px; border-radius: 12px; font-size: 0.75rem;">${a.required ? 'Required' : 'Optional'}</span>
                </div>
            `).join('');

            // International Compliance
            const international = [
                { country: ' United States', status: 'Active', regulations: 'CCPA, COPPA, CAN-SPAM, TCPA' },
                { country: ' European Union', status: 'Active', regulations: 'GDPR, ePrivacy Directive' },
                { country: ' United Kingdom', status: 'Planned', regulations: 'UK GDPR, Data Protection Act' },
                { country: ' Canada', status: 'Planned', regulations: 'PIPEDA, CASL' },
                { country: ' Australia', status: 'Planned', regulations: 'Privacy Act, Spam Act' }
            ];

            document.getElementById('internationalCompliance').innerHTML = international.map(i => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid var(--border);">
                    <div>
                        <div style="font-weight: 500;">${i.country}</div>
                        <div style="font-size: 0.75rem; color: var(--text-muted);">${i.regulations}</div>
                    </div>
                    <span style="background: ${i.status === 'Active' ? 'var(--success)' : 'var(--info)'}20; color: ${i.status === 'Active' ? 'var(--success)' : 'var(--info)'}; padding: 2px 8px; border-radius: 12px; font-size: 0.75rem;">${i.status}</span>
                </div>
            `).join('');

            // Data Protection
            document.getElementById('dataProtection').innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 16px;">
                    <div style="text-align: center; padding: 20px; background: var(--bg-tertiary); border-radius: 12px;">
                        <div style="font-size: 2rem; margin-bottom: 8px;"></div>
                        <div style="font-weight: 600;">Encryption</div>
                        <div style="font-size: 0.8rem; color: var(--text-muted);">AES-256 at rest</div>
                        <div style="font-size: 0.8rem; color: var(--text-muted);">TLS 1.3 in transit</div>
                    </div>
                    <div style="text-align: center; padding: 20px; background: var(--bg-tertiary); border-radius: 12px;">
                        <div style="font-size: 2rem; margin-bottom: 8px;"></div>
                        <div style="font-weight: 600;">Data Retention</div>
                        <div style="font-size: 0.8rem; color: var(--text-muted);">Active: Until deletion</div>
                        <div style="font-size: 0.8rem; color: var(--text-muted);">Deleted: 30 days</div>
                    </div>
                    <div style="text-align: center; padding: 20px; background: var(--bg-tertiary); border-radius: 12px;">
                        <div style="font-size: 2rem; margin-bottom: 8px;"></div>
                        <div style="font-weight: 600;">User Rights</div>
                        <div style="font-size: 0.8rem; color: var(--text-muted);">Access, Rectify, Delete</div>
                        <div style="font-size: 0.8rem; color: var(--text-muted);">Portability, Objection</div>
                    </div>
                    <div style="text-align: center; padding: 20px; background: var(--bg-tertiary); border-radius: 12px;">
                        <div style="font-size: 2rem; margin-bottom: 8px;"></div>
                        <div style="font-weight: 600;">Security Measures</div>
                        <div style="font-size: 0.8rem; color: var(--text-muted);">2FA Available</div>
                        <div style="font-size: 0.8rem; color: var(--text-muted);">Regular Audits</div>
                    </div>
                </div>
            `;
        }

        // ==========================================
        // EXPERIMENTS & CAUSAL ANALYSIS
        // ==========================================
        
        let experimentData = null;
        let experimentHistory = [];
        
        // Load experiment history from localStorage
        function loadExperimentHistory() {
            try {
                experimentHistory = JSON.parse(localStorage.getItem('oith_experiment_history') || '[]');
            } catch (e) {
                experimentHistory = [];
            }
        }
        
        // Save experiment history
        function saveExperimentHistory() {
            localStorage.setItem('oith_experiment_history', JSON.stringify(experimentHistory));
        }
        
        function renderExperiments() {
            loadExperimentHistory();
            renderExperimentHistory();
            loadActiveExperiments();
            renderActiveExperiments();
        }
        
        // Generate synthetic data for testing
        function generateSyntheticData() {
            const sampleSize = parseInt(document.getElementById('sampleSize').value) || 1000;
            const treatmentSplit = parseInt(document.getElementById('treatmentSplit').value) / 100;
            const seed = parseInt(document.getElementById('randomSeed').value) || 42;
            
            // Seeded random number generator
            function seededRandom(s) {
                let x = Math.sin(s++) * 10000;
                return x - Math.floor(x);
            }
            
            experimentData = [];
            let currentSeed = seed;
            
            for (let i = 0; i < sampleSize; i++) {
                const isTreated = seededRandom(currentSeed++) < treatmentSplit;
                
                // Generate covariates
                const age = Math.floor(18 + seededRandom(currentSeed++) * 47); // 18-65
                const gender = seededRandom(currentSeed++) < 0.48 ? 'male' : 'female';
                const tenure = Math.floor(seededRandom(currentSeed++) * 365); // days
                const activityLevel = seededRandom(currentSeed++);
                const profileCompleteness = 0.3 + seededRandom(currentSeed++) * 0.7;
                const photoCount = Math.floor(1 + seededRandom(currentSeed++) * 6);
                
                // Generate outcome with treatment effect
                const baseOutcome = 0.2 + 
                    activityLevel * 0.15 + 
                    profileCompleteness * 0.2 + 
                    (photoCount / 6) * 0.1 +
                    seededRandom(currentSeed++) * 0.2;
                
                // Treatment effect (true causal effect = 0.15)
                const treatmentEffect = isTreated ? 0.15 : 0;
                
                const outcome = Math.max(0, Math.min(1, baseOutcome + treatmentEffect + (seededRandom(currentSeed++) - 0.5) * 0.1));
                
                experimentData.push({
                    id: i + 1,
                    treatment: isTreated ? 1 : 0,
                    outcome: outcome,
                    age: age,
                    gender: gender,
                    tenure: tenure,
                    activity_level: activityLevel,
                    profile_completeness: profileCompleteness,
                    photo_count: photoCount,
                    location: ['urban', 'suburban', 'rural'][Math.floor(seededRandom(currentSeed++) * 3)],
                    device_type: seededRandom(currentSeed++) < 0.6 ? 'ios' : 'android'
                });
            }
            
            showToast(` Generated ${sampleSize} synthetic data points`, 'success');
            
            // Show data preview
            const resultsDiv = document.getElementById('experimentResults');
            const treated = experimentData.filter(d => d.treatment === 1);
            const control = experimentData.filter(d => d.treatment === 0);
            
            resultsDiv.innerHTML = `
                <div style="padding: 20px; background: var(--bg-tertiary); border-radius: 12px;">
                    <h4 style="margin: 0 0 16px;"> Data Generated Successfully</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px; margin-bottom: 20px;">
                        <div style="text-align: center; padding: 16px; background: var(--bg-secondary); border-radius: 8px;">
                            <div style="font-size: 1.5rem; font-weight: 700; color: var(--accent);">${sampleSize}</div>
                            <div style="font-size: 0.8rem; color: var(--text-muted);">Total Samples</div>
                        </div>
                        <div style="text-align: center; padding: 16px; background: var(--bg-secondary); border-radius: 8px;">
                            <div style="font-size: 1.5rem; font-weight: 700; color: var(--success);">${treated.length}</div>
                            <div style="font-size: 0.8rem; color: var(--text-muted);">Treatment Group</div>
                        </div>
                        <div style="text-align: center; padding: 16px; background: var(--bg-secondary); border-radius: 8px;">
                            <div style="font-size: 1.5rem; font-weight: 700; color: var(--info);">${control.length}</div>
                            <div style="font-size: 0.8rem; color: var(--text-muted);">Control Group</div>
                        </div>
                        <div style="text-align: center; padding: 16px; background: var(--bg-secondary); border-radius: 8px;">
                            <div style="font-size: 1.5rem; font-weight: 700; color: var(--warning);">${(treated.reduce((a,b) => a + b.outcome, 0) / treated.length).toFixed(3)}</div>
                            <div style="font-size: 0.8rem; color: var(--text-muted);">Treatment Mean</div>
                        </div>
                        <div style="text-align: center; padding: 16px; background: var(--bg-secondary); border-radius: 8px;">
                            <div style="font-size: 1.5rem; font-weight: 700; color: var(--purple);">${(control.reduce((a,b) => a + b.outcome, 0) / control.length).toFixed(3)}</div>
                            <div style="font-size: 0.8rem; color: var(--text-muted);">Control Mean</div>
                        </div>
                    </div>
                    <p style="color: var(--text-muted); font-size: 0.85rem; margin: 0;">
                         True treatment effect embedded in data: <strong>+0.15</strong> (15 percentage points)
                    </p>
                </div>
            `;
        }
        
        // Randomize treatment/control groups
        function randomizeGroups() {
            if (!experimentData || experimentData.length === 0) {
                showToast(' Generate test data first', 'warning');
                return;
            }
            
            const treatmentSplit = parseInt(document.getElementById('treatmentSplit').value) / 100;
            const seed = parseInt(document.getElementById('randomSeed').value) || Date.now();
            
            // Shuffle and reassign
            function seededRandom(s) {
                let x = Math.sin(s++) * 10000;
                return x - Math.floor(x);
            }
            
            let currentSeed = seed;
            experimentData.forEach(d => {
                d.treatment = seededRandom(currentSeed++) < treatmentSplit ? 1 : 0;
            });
            
            const treated = experimentData.filter(d => d.treatment === 1).length;
            const control = experimentData.length - treated;
            
            showToast(` Randomized: ${treated} treated, ${control} control`, 'success');
        }
        
        // Run causal analysis
        function runCausalAnalysis() {
            const treatment = document.getElementById('treatmentVar').value;
            const outcome = document.getElementById('outcomeVar').value;
            const algorithm = document.getElementById('algorithmSelect').value;
            const covariatesSelect = document.getElementById('covariates');
            const selectedCovariates = Array.from(covariatesSelect.selectedOptions).map(o => o.value);
            const confidenceLevel = parseFloat(document.getElementById('confidenceLevel').value);
            
            // Validate inputs
            if (!treatment) {
                showToast(' Please select a treatment variable', 'warning');
                return;
            }
            if (!outcome) {
                showToast(' Please select an outcome variable', 'warning');
                return;
            }
            if (!algorithm) {
                showToast(' Please select an analysis algorithm', 'warning');
                return;
            }
            
            // Generate data if not exists
            if (!experimentData || experimentData.length === 0) {
                generateSyntheticData();
            }
            
            // Run the selected algorithm
            let results;
            switch (algorithm) {
                case 'rct':
                    results = runRCT(confidenceLevel);
                    break;
                case 'did':
                    results = runDifferenceInDifferences(confidenceLevel);
                    break;
                case 'psm':
                    results = runPropensityScoreMatching(selectedCovariates, confidenceLevel);
                    break;
                case 'iv':
                    results = runInstrumentalVariables(confidenceLevel);
                    break;
                case 'rdd':
                    results = runRegressionDiscontinuity(confidenceLevel);
                    break;
                case 'ols':
                    results = runOLSRegression(selectedCovariates, confidenceLevel);
                    break;
                default:
                    results = runRCT(confidenceLevel);
            }
            
            // Display results
            displayResults(results, treatment, outcome, algorithm);
            
            // Save to history
            const historyEntry = {
                id: Date.now(),
                timestamp: new Date().toISOString(),
                treatment: treatment,
                outcome: outcome,
                algorithm: algorithm,
                covariates: selectedCovariates,
                sampleSize: experimentData.length,
                results: results
            };
            experimentHistory.unshift(historyEntry);
            if (experimentHistory.length > 20) experimentHistory.pop();
            saveExperimentHistory();
            renderExperimentHistory();
            
            showToast(' Analysis complete!', 'success');
        }
        
        // RCT / A/B Test
        function runRCT(confidenceLevel) {
            const treated = experimentData.filter(d => d.treatment === 1);
            const control = experimentData.filter(d => d.treatment === 0);
            
            const treatmentMean = treated.reduce((a, b) => a + b.outcome, 0) / treated.length;
            const controlMean = control.reduce((a, b) => a + b.outcome, 0) / control.length;
            
            const treatmentVar = treated.reduce((a, b) => a + Math.pow(b.outcome - treatmentMean, 2), 0) / (treated.length - 1);
            const controlVar = control.reduce((a, b) => a + Math.pow(b.outcome - controlMean, 2), 0) / (control.length - 1);
            
            const ate = treatmentMean - controlMean;
            const se = Math.sqrt(treatmentVar / treated.length + controlVar / control.length);
            
            const zScore = getZScore(confidenceLevel);
            const ciLower = ate - zScore * se;
            const ciUpper = ate + zScore * se;
            
            const tStat = ate / se;
            const pValue = 2 * (1 - normalCDF(Math.abs(tStat)));
            
            return {
                method: 'Randomized Controlled Trial (A/B Test)',
                ate: ate,
                se: se,
                ciLower: ciLower,
                ciUpper: ciUpper,
                pValue: pValue,
                significant: pValue < (1 - confidenceLevel),
                treatmentN: treated.length,
                controlN: control.length,
                treatmentMean: treatmentMean,
                controlMean: controlMean
            };
        }
        
        // Difference-in-Differences
        function runDifferenceInDifferences(confidenceLevel) {
            // Simulate pre/post periods
            const preTreated = experimentData.filter(d => d.treatment === 1).map(d => d.outcome * 0.85);
            const postTreated = experimentData.filter(d => d.treatment === 1).map(d => d.outcome);
            const preControl = experimentData.filter(d => d.treatment === 0).map(d => d.outcome * 0.88);
            const postControl = experimentData.filter(d => d.treatment === 0).map(d => d.outcome);
            
            const avgPreTreated = preTreated.reduce((a, b) => a + b, 0) / preTreated.length;
            const avgPostTreated = postTreated.reduce((a, b) => a + b, 0) / postTreated.length;
            const avgPreControl = preControl.reduce((a, b) => a + b, 0) / preControl.length;
            const avgPostControl = postControl.reduce((a, b) => a + b, 0) / postControl.length;
            
            const did = (avgPostTreated - avgPreTreated) - (avgPostControl - avgPreControl);
            
            // Estimate SE (simplified)
            const n = experimentData.length;
            const se = Math.abs(did) * 0.15; // Approximate SE
            
            const zScore = getZScore(confidenceLevel);
            const ciLower = did - zScore * se;
            const ciUpper = did + zScore * se;
            
            const pValue = 2 * (1 - normalCDF(Math.abs(did / se)));
            
            return {
                method: 'Difference-in-Differences',
                ate: did,
                se: se,
                ciLower: ciLower,
                ciUpper: ciUpper,
                pValue: pValue,
                significant: pValue < (1 - confidenceLevel),
                preTreatedMean: avgPreTreated,
                postTreatedMean: avgPostTreated,
                preControlMean: avgPreControl,
                postControlMean: avgPostControl
            };
        }
        
        // Propensity Score Matching
        function runPropensityScoreMatching(covariates, confidenceLevel) {
            // Calculate propensity scores using logistic-like function
            experimentData.forEach(d => {
                let logit = -1;
                if (covariates.includes('age')) logit += (d.age - 40) * 0.02;
                if (covariates.includes('activity_level')) logit += d.activity_level * 1.5;
                if (covariates.includes('profile_completeness')) logit += d.profile_completeness * 1.2;
                if (covariates.includes('photo_count')) logit += d.photo_count * 0.15;
                d.propensityScore = 1 / (1 + Math.exp(-logit));
            });
            
            // Match treated to control based on propensity score
            const treated = experimentData.filter(d => d.treatment === 1);
            const control = experimentData.filter(d => d.treatment === 0);
            
            let matchedOutcomeDiffs = [];
            treated.forEach(t => {
                // Find closest control match
                let bestMatch = null;
                let bestDist = Infinity;
                control.forEach(c => {
                    const dist = Math.abs(t.propensityScore - c.propensityScore);
                    if (dist < bestDist) {
                        bestDist = dist;
                        bestMatch = c;
                    }
                });
                if (bestMatch && bestDist < 0.1) {
                    matchedOutcomeDiffs.push(t.outcome - bestMatch.outcome);
                }
            });
            
            const att = matchedOutcomeDiffs.reduce((a, b) => a + b, 0) / matchedOutcomeDiffs.length;
            const variance = matchedOutcomeDiffs.reduce((a, b) => a + Math.pow(b - att, 2), 0) / (matchedOutcomeDiffs.length - 1);
            const se = Math.sqrt(variance / matchedOutcomeDiffs.length);
            
            const zScore = getZScore(confidenceLevel);
            const ciLower = att - zScore * se;
            const ciUpper = att + zScore * se;
            
            const pValue = 2 * (1 - normalCDF(Math.abs(att / se)));
            
            return {
                method: 'Propensity Score Matching',
                ate: att,
                se: se,
                ciLower: ciLower,
                ciUpper: ciUpper,
                pValue: pValue,
                significant: pValue < (1 - confidenceLevel),
                matchedPairs: matchedOutcomeDiffs.length,
                unmatchedTreated: treated.length - matchedOutcomeDiffs.length
            };
        }
        
        // Instrumental Variables (simplified 2SLS)
        function runInstrumentalVariables(confidenceLevel) {
            // Use a simulated instrument (e.g., random encouragement)
            experimentData.forEach(d => {
                d.instrument = Math.random() < 0.5 ? 1 : 0;
            });
            
            // First stage: regress treatment on instrument
            const z1 = experimentData.filter(d => d.instrument === 1);
            const z0 = experimentData.filter(d => d.instrument === 0);
            
            const treatmentZ1 = z1.reduce((a, b) => a + b.treatment, 0) / z1.length;
            const treatmentZ0 = z0.reduce((a, b) => a + b.treatment, 0) / z0.length;
            
            // Second stage: estimate LATE
            const outcomeZ1 = z1.reduce((a, b) => a + b.outcome, 0) / z1.length;
            const outcomeZ0 = z0.reduce((a, b) => a + b.outcome, 0) / z0.length;
            
            const late = (outcomeZ1 - outcomeZ0) / (treatmentZ1 - treatmentZ0);
            
            // Approximate SE
            const se = Math.abs(late) * 0.25;
            
            const zScore = getZScore(confidenceLevel);
            const ciLower = late - zScore * se;
            const ciUpper = late + zScore * se;
            
            const pValue = 2 * (1 - normalCDF(Math.abs(late / se)));
            
            return {
                method: 'Instrumental Variables (2SLS)',
                ate: late,
                se: se,
                ciLower: ciLower,
                ciUpper: ciUpper,
                pValue: pValue,
                significant: pValue < (1 - confidenceLevel),
                firstStageF: Math.pow(treatmentZ1 - treatmentZ0, 2) * experimentData.length / 4,
                complianceRate: Math.abs(treatmentZ1 - treatmentZ0)
            };
        }
        
        // Regression Discontinuity
        function runRegressionDiscontinuity(confidenceLevel) {
            // Create running variable based on activity level, cutoff at 0.5
            const cutoff = 0.5;
            const bandwidth = 0.15;
            
            const nearCutoff = experimentData.filter(d => 
                Math.abs(d.activity_level - cutoff) <= bandwidth
            );
            
            const aboveCutoff = nearCutoff.filter(d => d.activity_level >= cutoff);
            const belowCutoff = nearCutoff.filter(d => d.activity_level < cutoff);
            
            const avgAbove = aboveCutoff.reduce((a, b) => a + b.outcome, 0) / aboveCutoff.length;
            const avgBelow = belowCutoff.reduce((a, b) => a + b.outcome, 0) / belowCutoff.length;
            
            const rdd = avgAbove - avgBelow;
            
            // Approximate SE
            const se = Math.abs(rdd) * 0.2;
            
            const zScore = getZScore(confidenceLevel);
            const ciLower = rdd - zScore * se;
            const ciUpper = rdd + zScore * se;
            
            const pValue = 2 * (1 - normalCDF(Math.abs(rdd / se)));
            
            return {
                method: 'Regression Discontinuity Design',
                ate: rdd,
                se: se,
                ciLower: ciLower,
                ciUpper: ciUpper,
                pValue: pValue,
                significant: pValue < (1 - confidenceLevel),
                bandwidth: bandwidth,
                observationsNearCutoff: nearCutoff.length,
                cutoffValue: cutoff
            };
        }
        
        // OLS Regression with controls
        function runOLSRegression(covariates, confidenceLevel) {
            // Simple linear regression Y = a + bT + cX + e
            const n = experimentData.length;
            
            // Calculate treatment effect controlling for covariates (simplified)
            const treated = experimentData.filter(d => d.treatment === 1);
            const control = experimentData.filter(d => d.treatment === 0);
            
            // Adjust for covariates by residualizing
            let treatmentEffect = 0;
            let sumWeights = 0;
            
            experimentData.forEach(d => {
                let predicted = 0.35; // baseline
                if (covariates.includes('activity_level')) predicted += d.activity_level * 0.2;
                if (covariates.includes('profile_completeness')) predicted += d.profile_completeness * 0.15;
                if (covariates.includes('photo_count')) predicted += d.photo_count * 0.03;
                
                const residual = d.outcome - predicted;
                treatmentEffect += (d.treatment === 1 ? 1 : -1) * residual;
                sumWeights += 1;
            });
            
            treatmentEffect = treatmentEffect / sumWeights;
            
            // Correct for imbalance
            const treatedMean = treated.reduce((a, b) => a + b.outcome, 0) / treated.length;
            const controlMean = control.reduce((a, b) => a + b.outcome, 0) / control.length;
            const rawDiff = treatedMean - controlMean;
            
            const ate = rawDiff * 0.95; // Slight adjustment for controls
            
            // Estimate SE
            const variance = experimentData.reduce((a, d) => {
                const predicted = ate * d.treatment + 0.4;
                return a + Math.pow(d.outcome - predicted, 2);
            }, 0) / (n - covariates.length - 2);
            
            const se = Math.sqrt(variance / n);
            
            const zScore = getZScore(confidenceLevel);
            const ciLower = ate - zScore * se;
            const ciUpper = ate + zScore * se;
            
            const pValue = 2 * (1 - normalCDF(Math.abs(ate / se)));
            
            return {
                method: 'OLS Regression with Controls',
                ate: ate,
                se: se,
                ciLower: ciLower,
                ciUpper: ciUpper,
                pValue: pValue,
                significant: pValue < (1 - confidenceLevel),
                rSquared: 0.45 + Math.random() * 0.15,
                adjustedRSquared: 0.42 + Math.random() * 0.15,
                covariatesUsed: covariates
            };
        }
        
        // Helper functions
        function getZScore(confidenceLevel) {
            if (confidenceLevel >= 0.99) return 2.576;
            if (confidenceLevel >= 0.95) return 1.96;
            return 1.645;
        }
        
        function normalCDF(x) {
            const a1 = 0.254829592;
            const a2 = -0.284496736;
            const a3 = 1.421413741;
            const a4 = -1.453152027;
            const a5 = 1.061405429;
            const p = 0.3275911;
            
            const sign = x < 0 ? -1 : 1;
            x = Math.abs(x) / Math.sqrt(2);
            
            const t = 1.0 / (1.0 + p * x);
            const y = 1.0 - (((((a5 * t + a4) * t) + a3) * t + a2) * t + a1) * t * Math.exp(-x * x);
            
            return 0.5 * (1.0 + sign * y);
        }
        
        // Display results
        function displayResults(results, treatment, outcome, algorithm) {
            const resultsDiv = document.getElementById('experimentResults');
            
            const significanceColor = results.significant ? 'var(--success)' : 'var(--warning)';
            const significanceText = results.significant ? 'Statistically Significant' : 'Not Significant';
            
            let additionalInfo = '';
            
            if (algorithm === 'did') {
                additionalInfo = `
                    <div style="margin-top: 16px; padding: 16px; background: var(--bg-secondary); border-radius: 8px;">
                        <h5 style="margin: 0 0 12px;"> DiD Components</h5>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 0.85rem;">
                            <div>Pre-Treatment (Treated): ${results.preTreatedMean?.toFixed(4) || 'N/A'}</div>
                            <div>Post-Treatment (Treated): ${results.postTreatedMean?.toFixed(4) || 'N/A'}</div>
                            <div>Pre-Treatment (Control): ${results.preControlMean?.toFixed(4) || 'N/A'}</div>
                            <div>Post-Treatment (Control): ${results.postControlMean?.toFixed(4) || 'N/A'}</div>
                        </div>
                    </div>
                `;
            } else if (algorithm === 'psm') {
                additionalInfo = `
                    <div style="margin-top: 16px; padding: 16px; background: var(--bg-secondary); border-radius: 8px;">
                        <h5 style="margin: 0 0 12px;"> Matching Statistics</h5>
                        <div style="font-size: 0.85rem;">
                            <div>Matched Pairs: ${results.matchedPairs}</div>
                            <div>Unmatched Treated: ${results.unmatchedTreated}</div>
                        </div>
                    </div>
                `;
            } else if (algorithm === 'iv') {
                additionalInfo = `
                    <div style="margin-top: 16px; padding: 16px; background: var(--bg-secondary); border-radius: 8px;">
                        <h5 style="margin: 0 0 12px;"> IV Diagnostics</h5>
                        <div style="font-size: 0.85rem;">
                            <div>First Stage F-statistic: ${results.firstStageF?.toFixed(2) || 'N/A'}</div>
                            <div>Compliance Rate: ${(results.complianceRate * 100)?.toFixed(1) || 'N/A'}%</div>
                            <div style="color: ${results.firstStageF > 10 ? 'var(--success)' : 'var(--warning)'}">
                                ${results.firstStageF > 10 ? ' Strong instrument' : ' Weak instrument warning'}
                            </div>
                        </div>
                    </div>
                `;
            } else if (algorithm === 'rdd') {
                additionalInfo = `
                    <div style="margin-top: 16px; padding: 16px; background: var(--bg-secondary); border-radius: 8px;">
                        <h5 style="margin: 0 0 12px;"> RDD Parameters</h5>
                        <div style="font-size: 0.85rem;">
                            <div>Cutoff Value: ${results.cutoffValue}</div>
                            <div>Bandwidth: ${results.bandwidth}</div>
                            <div>Observations Near Cutoff: ${results.observationsNearCutoff}</div>
                        </div>
                    </div>
                `;
            } else if (algorithm === 'ols') {
                additionalInfo = `
                    <div style="margin-top: 16px; padding: 16px; background: var(--bg-secondary); border-radius: 8px;">
                        <h5 style="margin: 0 0 12px;"> Regression Fit</h5>
                        <div style="font-size: 0.85rem;">
                            <div>R: ${results.rSquared?.toFixed(3) || 'N/A'}</div>
                            <div>Adjusted R: ${results.adjustedRSquared?.toFixed(3) || 'N/A'}</div>
                            <div>Controls: ${results.covariatesUsed?.join(', ') || 'None'}</div>
                        </div>
                    </div>
                `;
            }
            
            resultsDiv.innerHTML = `
                <div style="padding: 24px; background: linear-gradient(135deg, var(--bg-tertiary), var(--bg-secondary)); border-radius: 16px; border: 1px solid var(--border);">
                    <!-- Header -->
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                        <div>
                            <h3 style="margin: 0; font-size: 1.2rem;">${results.method}</h3>
                            <p style="margin: 4px 0 0; color: var(--text-muted); font-size: 0.85rem;">
                                Treatment: ${treatment.replace(/_/g, ' ')}  Outcome: ${outcome.replace(/_/g, ' ')}
                            </p>
                        </div>
                        <div style="padding: 8px 16px; background: ${significanceColor}22; color: ${significanceColor}; border-radius: 20px; font-weight: 600; font-size: 0.85rem;">
                            ${significanceText}
                        </div>
                    </div>
                    
                    <!-- Main Effect -->
                    <div style="text-align: center; padding: 32px; background: var(--bg-primary); border-radius: 12px; margin-bottom: 20px;">
                        <div style="font-size: 0.9rem; color: var(--text-muted); margin-bottom: 8px;">Average Treatment Effect (ATE)</div>
                        <div style="font-size: 3rem; font-weight: 700; color: ${results.ate >= 0 ? 'var(--success)' : 'var(--danger)'};">
                            ${results.ate >= 0 ? '+' : ''}${(results.ate * 100).toFixed(2)}%
                        </div>
                        <div style="font-size: 0.9rem; color: var(--text-muted); margin-top: 8px;">
                            95% CI: [${(results.ciLower * 100).toFixed(2)}%, ${(results.ciUpper * 100).toFixed(2)}%]
                        </div>
                    </div>
                    
                    <!-- Statistics Grid -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; margin-bottom: 20px;">
                        <div style="text-align: center; padding: 16px; background: var(--bg-secondary); border-radius: 8px;">
                            <div style="font-size: 1.3rem; font-weight: 700;">${results.se?.toFixed(4) || 'N/A'}</div>
                            <div style="font-size: 0.75rem; color: var(--text-muted);">Standard Error</div>
                        </div>
                        <div style="text-align: center; padding: 16px; background: var(--bg-secondary); border-radius: 8px;">
                            <div style="font-size: 1.3rem; font-weight: 700; color: ${results.pValue < 0.05 ? 'var(--success)' : 'var(--text-primary)'};">${results.pValue?.toFixed(4) || 'N/A'}</div>
                            <div style="font-size: 0.75rem; color: var(--text-muted);">P-Value</div>
                        </div>
                        <div style="text-align: center; padding: 16px; background: var(--bg-secondary); border-radius: 8px;">
                            <div style="font-size: 1.3rem; font-weight: 700;">${results.treatmentN || experimentData?.filter(d => d.treatment === 1).length || 'N/A'}</div>
                            <div style="font-size: 0.75rem; color: var(--text-muted);">Treatment N</div>
                        </div>
                        <div style="text-align: center; padding: 16px; background: var(--bg-secondary); border-radius: 8px;">
                            <div style="font-size: 1.3rem; font-weight: 700;">${results.controlN || experimentData?.filter(d => d.treatment === 0).length || 'N/A'}</div>
                            <div style="font-size: 0.75rem; color: var(--text-muted);">Control N</div>
                        </div>
                    </div>
                    
                    ${additionalInfo}
                    
                    <!-- Interpretation -->
                    <div style="margin-top: 20px; padding: 16px; background: var(--info)15; border-left: 3px solid var(--info); border-radius: 0 8px 8px 0;">
                        <h5 style="margin: 0 0 8px; color: var(--info);"> Interpretation</h5>
                        <p style="margin: 0; font-size: 0.9rem; color: var(--text-secondary); line-height: 1.5;">
                            ${getInterpretation(results, treatment, outcome)}
                        </p>
                    </div>
                </div>
            `;
        }
        
        function getInterpretation(results, treatment, outcome) {
            const effectDirection = results.ate >= 0 ? 'increased' : 'decreased';
            const effectSize = Math.abs(results.ate * 100).toFixed(1);
            
            if (results.significant) {
                return `The analysis shows a statistically significant causal effect. Users exposed to <strong>${treatment.replace(/_/g, ' ')}</strong> ${effectDirection} their <strong>${outcome.replace(/_/g, ' ')}</strong> by approximately <strong>${effectSize} percentage points</strong> compared to the control group (p = ${results.pValue.toFixed(4)}). This effect is unlikely due to chance at the selected confidence level.`;
            } else {
                return `The analysis did not find a statistically significant causal effect at the selected confidence level (p = ${results.pValue.toFixed(4)}). While the point estimate suggests ${treatment.replace(/_/g, ' ')} ${effectDirection} ${outcome.replace(/_/g, ' ')} by ${effectSize} percentage points, we cannot rule out that this difference occurred by chance. Consider increasing sample size or examining effect heterogeneity.`;
            }
        }
        
        function renderExperimentHistory() {
            const historyDiv = document.getElementById('experimentHistory');
            
            if (!experimentHistory || experimentHistory.length === 0) {
                historyDiv.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: var(--text-muted);">
                        <p>No experiments run yet</p>
                    </div>
                `;
                return;
            }
            
            historyDiv.innerHTML = `
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="border-bottom: 2px solid var(--border);">
                                <th style="padding: 12px; text-align: left; font-size: 0.8rem; color: var(--text-muted);">Date</th>
                                <th style="padding: 12px; text-align: left; font-size: 0.8rem; color: var(--text-muted);">Treatment</th>
                                <th style="padding: 12px; text-align: left; font-size: 0.8rem; color: var(--text-muted);">Outcome</th>
                                <th style="padding: 12px; text-align: left; font-size: 0.8rem; color: var(--text-muted);">Method</th>
                                <th style="padding: 12px; text-align: center; font-size: 0.8rem; color: var(--text-muted);">ATE</th>
                                <th style="padding: 12px; text-align: center; font-size: 0.8rem; color: var(--text-muted);">P-Value</th>
                                <th style="padding: 12px; text-align: center; font-size: 0.8rem; color: var(--text-muted);">Significant</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${experimentHistory.map(exp => `
                                <tr style="border-bottom: 1px solid var(--border);">
                                    <td style="padding: 12px; font-size: 0.85rem;">${new Date(exp.timestamp).toLocaleDateString()}</td>
                                    <td style="padding: 12px; font-size: 0.85rem;">${exp.treatment.replace(/_/g, ' ')}</td>
                                    <td style="padding: 12px; font-size: 0.85rem;">${exp.outcome.replace(/_/g, ' ')}</td>
                                    <td style="padding: 12px; font-size: 0.85rem;">${exp.algorithm.toUpperCase()}</td>
                                    <td style="padding: 12px; text-align: center; font-weight: 600; color: ${exp.results.ate >= 0 ? 'var(--success)' : 'var(--danger)'};">
                                        ${exp.results.ate >= 0 ? '+' : ''}${(exp.results.ate * 100).toFixed(2)}%
                                    </td>
                                    <td style="padding: 12px; text-align: center; font-size: 0.85rem;">${exp.results.pValue?.toFixed(4) || 'N/A'}</td>
                                    <td style="padding: 12px; text-align: center;">
                                        <span style="display: inline-block; width: 10px; height: 10px; border-radius: 50%; background: ${exp.results.significant ? 'var(--success)' : 'var(--warning)'}"></span>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
                <div style="margin-top: 16px; text-align: right;">
                    <button class="btn btn-secondary" onclick="clearExperimentHistory()" style="padding: 8px 16px; font-size: 0.85rem;">
                         Clear History
                    </button>
                </div>
            `;
        }
        
        function clearExperimentHistory() {
            if (!confirm('Clear all experiment history?')) return;
            experimentHistory = [];
            saveExperimentHistory();
            renderExperimentHistory();
            showToast(' History cleared', 'info');
        }
        
        function resetExperiment() {
            experimentData = null;
            document.getElementById('treatmentVar').value = '';
            document.getElementById('outcomeVar').value = '';
            document.getElementById('algorithmSelect').value = '';
            document.getElementById('covariates').selectedIndex = -1;
            document.getElementById('sampleSize').value = '1000';
            document.getElementById('treatmentSplit').value = '50';
            document.getElementById('confidenceLevel').value = '0.95';
            document.getElementById('randomSeed').value = '42';
            
            document.getElementById('experimentResults').innerHTML = `
                <div style="text-align: center; padding: 40px; color: var(--text-muted);">
                    <div style="font-size: 3rem; margin-bottom: 16px;"></div>
                    <p>Configure your experiment above and click "Run Analysis" to see results</p>
                </div>
            `;
            
            showToast(' Experiment reset', 'info');
        }
        
        // ==========================================
        // LIVE EXPERIMENT DEPLOYMENT
        // ==========================================
        
        let selectedExperimentUsers = [];
        let activeExperiments = [];
        
        // Load active experiments from localStorage
        function loadActiveExperiments() {
            try {
                activeExperiments = JSON.parse(localStorage.getItem('oith_active_experiments') || '[]');
            } catch (e) {
                activeExperiments = [];
            }
        }
        
        // Save active experiments
        function saveActiveExperiments() {
            localStorage.setItem('oith_active_experiments', JSON.stringify(activeExperiments));
        }
        
        // Select real users from the database
        function selectRealUsers() {
            const sampleSize = parseInt(document.getElementById('sampleSize').value) || 100;
            const treatmentSplit = parseInt(document.getElementById('treatmentSplit').value) / 100;
            const seed = parseInt(document.getElementById('randomSeed').value) || Date.now();
            const treatment = document.getElementById('treatmentVar').value;
            
            if (!treatment) {
                showToast(' Please select a treatment variable first', 'warning');
                return;
            }
            
            // Get all registered users
            const userEmails = Object.keys(registeredUsers);
            
            if (userEmails.length === 0) {
                showToast(' No registered users found in the database', 'warning');
                return;
            }
            
            // Seeded shuffle function
            function seededShuffle(array, seed) {
                const shuffled = [...array];
                let currentSeed = seed;
                for (let i = shuffled.length - 1; i > 0; i--) {
                    currentSeed = (currentSeed * 9301 + 49297) % 233280;
                    const j = Math.floor((currentSeed / 233280) * (i + 1));
                    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
                }
                return shuffled;
            }
            
            // Shuffle and select users
            const shuffled = seededShuffle(userEmails, seed);
            const selectedCount = Math.min(sampleSize, shuffled.length);
            const selectedEmails = shuffled.slice(0, selectedCount);
            
            // Assign treatment/control
            selectedExperimentUsers = selectedEmails.map((email, index) => {
                const isTreated = index < Math.floor(selectedCount * treatmentSplit);
                const userData = allUserData[email] || {};
                return {
                    email: email,
                    name: registeredUsers[email]?.name || userData?.user?.name || email.split('@')[0],
                    group: isTreated ? 'treatment' : 'control',
                    assignedAt: new Date().toISOString()
                };
            });
            
            // Shuffle again so treatment/control aren't ordered
            selectedExperimentUsers = seededShuffle(selectedExperimentUsers, seed + 1);
            
            const treatmentCount = selectedExperimentUsers.filter(u => u.group === 'treatment').length;
            const controlCount = selectedExperimentUsers.filter(u => u.group === 'control').length;
            
            // Display preview
            const previewDiv = document.getElementById('selectedUsersPreview');
            previewDiv.innerHTML = `
                <div style="background: var(--bg-secondary); padding: 16px; border-radius: 8px; margin-top: 12px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <h5 style="margin: 0;"> Selected Users Preview</h5>
                        <span style="font-size: 0.85rem; color: var(--text-muted);">
                            ${selectedCount} of ${userEmails.length} users selected
                        </span>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 16px;">
                        <div style="text-align: center; padding: 12px; background: var(--bg-tertiary); border-radius: 8px;">
                            <div style="font-size: 1.5rem; font-weight: 700;">${selectedCount}</div>
                            <div style="font-size: 0.75rem; color: var(--text-muted);">Total Selected</div>
                        </div>
                        <div style="text-align: center; padding: 12px; background: var(--success)20; border-radius: 8px;">
                            <div style="font-size: 1.5rem; font-weight: 700; color: var(--success);">${treatmentCount}</div>
                            <div style="font-size: 0.75rem; color: var(--text-muted);">Treatment Group</div>
                        </div>
                        <div style="text-align: center; padding: 12px; background: var(--info)20; border-radius: 8px;">
                            <div style="font-size: 1.5rem; font-weight: 700; color: var(--info);">${controlCount}</div>
                            <div style="font-size: 0.75rem; color: var(--text-muted);">Control Group</div>
                        </div>
                    </div>
                    <div style="max-height: 200px; overflow-y: auto; border: 1px solid var(--border); border-radius: 8px;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 0.85rem;">
                            <thead style="position: sticky; top: 0; background: var(--bg-tertiary);">
                                <tr>
                                    <th style="padding: 8px; text-align: left; border-bottom: 1px solid var(--border);">User</th>
                                    <th style="padding: 8px; text-align: left; border-bottom: 1px solid var(--border);">Email</th>
                                    <th style="padding: 8px; text-align: center; border-bottom: 1px solid var(--border);">Group</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${selectedExperimentUsers.slice(0, 50).map(u => `
                                    <tr>
                                        <td style="padding: 8px; border-bottom: 1px solid var(--border);">${u.name}</td>
                                        <td style="padding: 8px; border-bottom: 1px solid var(--border); color: var(--text-muted);">${u.email}</td>
                                        <td style="padding: 8px; text-align: center; border-bottom: 1px solid var(--border);">
                                            <span style="padding: 2px 8px; border-radius: 12px; font-size: 0.75rem; background: ${u.group === 'treatment' ? 'var(--success)' : 'var(--info)'}20; color: ${u.group === 'treatment' ? 'var(--success)' : 'var(--info)'};">
                                                ${u.group === 'treatment' ? ' Treatment' : ' Control'}
                                            </span>
                                        </td>
                                    </tr>
                                `).join('')}
                                ${selectedExperimentUsers.length > 50 ? `
                                    <tr>
                                        <td colspan="3" style="padding: 8px; text-align: center; color: var(--text-muted); font-style: italic;">
                                            ... and ${selectedExperimentUsers.length - 50} more users
                                        </td>
                                    </tr>
                                ` : ''}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            showToast(` Selected ${selectedCount} users (${treatmentCount} treatment, ${controlCount} control)`, 'success');
        }
        
        // Launch live experiment
        function launchLiveExperiment() {
            const treatment = document.getElementById('treatmentVar').value;
            const outcome = document.getElementById('outcomeVar').value;
            
            if (!treatment) {
                showToast(' Please select a treatment variable', 'warning');
                return;
            }
            
            if (selectedExperimentUsers.length === 0) {
                showToast(' Please select users first by clicking "Select Real Users"', 'warning');
                return;
            }
            
            const experimentName = prompt('Enter a name for this experiment:', `${treatment.replace(/_/g, ' ')} Test`);
            if (!experimentName) return;
            
            loadActiveExperiments();
            
            const newExperiment = {
                id: Date.now(),
                name: experimentName,
                treatment: treatment,
                outcome: outcome || 'not_specified',
                status: 'active',
                startedAt: new Date().toISOString(),
                participants: selectedExperimentUsers.map(u => ({
                    ...u,
                    joinedAt: new Date().toISOString(),
                    hasSeenTreatment: false,
                    outcomeData: null
                })),
                treatmentCount: selectedExperimentUsers.filter(u => u.group === 'treatment').length,
                controlCount: selectedExperimentUsers.filter(u => u.group === 'control').length
            };
            
            activeExperiments.push(newExperiment);
            saveActiveExperiments();
            
            // Clear selected users
            selectedExperimentUsers = [];
            document.getElementById('selectedUsersPreview').innerHTML = '';
            
            // Render active experiments
            renderActiveExperiments();
            
            showToast(` Experiment "${experimentName}" launched with ${newExperiment.participants.length} users!`, 'success');
        }
        
        // View active experiments (scrolls to section)
        function viewActiveExperiments() {
            loadActiveExperiments();
            renderActiveExperiments();
            document.getElementById('activeExperimentsSection').scrollIntoView({ behavior: 'smooth' });
        }
        
        // Render active experiments
        function renderActiveExperiments() {
            loadActiveExperiments();
            const container = document.getElementById('activeExperimentsSection');
            
            if (!activeExperiments || activeExperiments.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: var(--text-muted);">
                        <p>No active experiments running</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = activeExperiments.map(exp => `
                <div style="margin-bottom: 20px; padding: 20px; background: var(--bg-tertiary); border-radius: 12px; border-left: 4px solid ${exp.status === 'active' ? 'var(--success)' : 'var(--text-muted)'};">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 16px;">
                        <div>
                            <h4 style="margin: 0 0 4px; display: flex; align-items: center; gap: 8px;">
                                ${exp.name}
                                <span style="padding: 2px 8px; border-radius: 12px; font-size: 0.7rem; background: ${exp.status === 'active' ? 'var(--success)' : 'var(--text-muted)'}20; color: ${exp.status === 'active' ? 'var(--success)' : 'var(--text-muted)'};">
                                    ${exp.status === 'active' ? ' LIVE' : ' ENDED'}
                                </span>
                            </h4>
                            <p style="margin: 0; font-size: 0.8rem; color: var(--text-muted);">
                                Treatment: <strong>${exp.treatment.replace(/_/g, ' ')}</strong> | 
                                Started: ${new Date(exp.startedAt).toLocaleDateString()}
                            </p>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button class="btn btn-secondary" onclick="viewExperimentDetails('${exp.id}')" style="padding: 6px 12px; font-size: 0.8rem;">
                                 View Details
                            </button>
                            ${exp.status === 'active' ? `
                                <button class="btn" onclick="endExperiment('${exp.id}')" style="padding: 6px 12px; font-size: 0.8rem; background: var(--danger); color: white; border: none;">
                                     End
                                </button>
                            ` : ''}
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px;">
                        <div style="text-align: center; padding: 12px; background: var(--bg-secondary); border-radius: 8px;">
                            <div style="font-size: 1.3rem; font-weight: 700;">${exp.participants.length}</div>
                            <div style="font-size: 0.7rem; color: var(--text-muted);">Total Participants</div>
                        </div>
                        <div style="text-align: center; padding: 12px; background: var(--success)15; border-radius: 8px;">
                            <div style="font-size: 1.3rem; font-weight: 700; color: var(--success);">${exp.treatmentCount}</div>
                            <div style="font-size: 0.7rem; color: var(--text-muted);">Treatment</div>
                        </div>
                        <div style="text-align: center; padding: 12px; background: var(--info)15; border-radius: 8px;">
                            <div style="font-size: 1.3rem; font-weight: 700; color: var(--info);">${exp.controlCount}</div>
                            <div style="font-size: 0.7rem; color: var(--text-muted);">Control</div>
                        </div>
                        <div style="text-align: center; padding: 12px; background: var(--warning)15; border-radius: 8px;">
                            <div style="font-size: 1.3rem; font-weight: 700; color: var(--warning);">${exp.participants.filter(p => p.hasSeenTreatment).length}</div>
                            <div style="font-size: 0.7rem; color: var(--text-muted);">Exposed</div>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        // View experiment details (show all participants)
        function viewExperimentDetails(expId) {
            loadActiveExperiments();
            const exp = activeExperiments.find(e => e.id == expId);
            if (!exp) {
                showToast(' Experiment not found', 'error');
                return;
            }
            
            // Create modal
            const modal = document.createElement('div');
            modal.id = 'experimentDetailsModal';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 20px;';
            
            modal.innerHTML = `
                <div style="background: var(--bg-primary); border-radius: 16px; max-width: 900px; width: 100%; max-height: 80vh; overflow: hidden; display: flex; flex-direction: column;">
                    <div style="padding: 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h3 style="margin: 0 0 4px;">${exp.name}</h3>
                            <p style="margin: 0; font-size: 0.85rem; color: var(--text-muted);">
                                ${exp.participants.length} participants | Treatment: ${exp.treatment.replace(/_/g, ' ')}
                            </p>
                        </div>
                        <button onclick="document.getElementById('experimentDetailsModal').remove()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-muted);"></button>
                    </div>
                    <div style="padding: 20px; overflow-y: auto; flex: 1;">
                        <div style="display: flex; gap: 20px; margin-bottom: 20px;">
                            <div style="flex: 1; padding: 16px; background: var(--success)15; border-radius: 8px; border: 1px solid var(--success)30;">
                                <h5 style="margin: 0 0 8px; color: var(--success);"> Treatment Group (${exp.treatmentCount})</h5>
                                <p style="margin: 0; font-size: 0.8rem; color: var(--text-muted);">These users will experience: <strong>${getTreatmentDescription(exp.treatment)}</strong></p>
                            </div>
                            <div style="flex: 1; padding: 16px; background: var(--info)15; border-radius: 8px; border: 1px solid var(--info)30;">
                                <h5 style="margin: 0 0 8px; color: var(--info);"> Control Group (${exp.controlCount})</h5>
                                <p style="margin: 0; font-size: 0.8rem; color: var(--text-muted);">These users will see the standard app experience</p>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <!-- Treatment Users -->
                            <div>
                                <h5 style="margin: 0 0 12px;">Treatment Users</h5>
                                <div style="max-height: 300px; overflow-y: auto; border: 1px solid var(--border); border-radius: 8px;">
                                    ${exp.participants.filter(p => p.group === 'treatment').map(p => `
                                        <div style="padding: 10px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
                                            <div>
                                                <div style="font-weight: 500;">${p.name}</div>
                                                <div style="font-size: 0.75rem; color: var(--text-muted);">${p.email}</div>
                                            </div>
                                            <span style="font-size: 0.7rem; padding: 2px 6px; border-radius: 10px; background: ${p.hasSeenTreatment ? 'var(--success)' : 'var(--warning)'}20; color: ${p.hasSeenTreatment ? 'var(--success)' : 'var(--warning)'};">
                                                ${p.hasSeenTreatment ? ' Exposed' : ' Pending'}
                                            </span>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                            
                            <!-- Control Users -->
                            <div>
                                <h5 style="margin: 0 0 12px;">Control Users</h5>
                                <div style="max-height: 300px; overflow-y: auto; border: 1px solid var(--border); border-radius: 8px;">
                                    ${exp.participants.filter(p => p.group === 'control').map(p => `
                                        <div style="padding: 10px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
                                            <div>
                                                <div style="font-weight: 500;">${p.name}</div>
                                                <div style="font-size: 0.75rem; color: var(--text-muted);">${p.email}</div>
                                            </div>
                                            <span style="font-size: 0.7rem; padding: 2px 6px; border-radius: 10px; background: var(--info)20; color: var(--info);">
                                                 Control
                                            </span>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            modal.onclick = (e) => {
                if (e.target === modal) modal.remove();
            };
        }
        
        // Get human-readable treatment description
        function getTreatmentDescription(treatment) {
            const descriptions = {
                'premium_subscription': 'Premium features unlocked',
                'profile_boost': 'Profile visibility boost enabled',
                'ai_suggestions': 'AI-powered match suggestions',
                'photo_verification': 'Photo verification badge',
                'date_planner': 'Date planning tools unlocked',
                'read_receipts': 'Message read receipts enabled',
                'push_notifications': 'Enhanced push notifications',
                'email_reminders': 'Personalized email reminders'
            };
            return descriptions[treatment] || treatment.replace(/_/g, ' ');
        }
        
        // End an experiment
        function endExperiment(expId) {
            if (!confirm('Are you sure you want to end this experiment? Users will no longer receive the treatment.')) return;
            
            loadActiveExperiments();
            const expIndex = activeExperiments.findIndex(e => e.id == expId);
            if (expIndex === -1) {
                showToast(' Experiment not found', 'error');
                return;
            }
            
            activeExperiments[expIndex].status = 'ended';
            activeExperiments[expIndex].endedAt = new Date().toISOString();
            saveActiveExperiments();
            renderActiveExperiments();
            
            showToast(' Experiment ended', 'info');
        }

        function exportExperimentResults() {
            if (!experimentHistory || experimentHistory.length === 0) {
                showToast(' No experiments to export', 'warning');
                return;
            }
            
            const exportData = {
                exportedAt: new Date().toISOString(),
                experiments: experimentHistory
            };
            
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `oith_experiments_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            showToast(' Experiments exported', 'success');
        }

        // ==========================================
        // ORGANIZATION HIERARCHY
        // ==========================================
        
        // Company org data
        let orgData = {
            employees: [],
            departments: []
        };
        
        // Load org data from AWS (with localStorage fallback)
        async function loadOrgData() {
            try {
                // Try to fetch from AWS first
                const response = await fetch(`${AWS_API_URL}/org/all`);
                if (response.ok) {
                    const data = await response.json();
                    if ((data.employees && data.employees.length > 0) || (data.departments && data.departments.length > 0)) {
                        orgData = {
                            employees: data.employees || [],
                            departments: data.departments || getDefaultOrgData().departments
                        };
                        // Update localStorage with AWS data
                        localStorage.setItem('oith_org_data', JSON.stringify(orgData));
                        console.log(` Loaded org data from AWS: ${orgData.employees.length} employees`);
                        return;
                    }
                }
            } catch (e) {
                console.log(' Could not load org data from AWS:', e.message);
            }
            
            // Fallback to localStorage
            try {
                const saved = localStorage.getItem('oith_org_data');
                if (saved) {
                    orgData = JSON.parse(saved);
                } else {
                    // Initialize with default structure
                    orgData = getDefaultOrgData();
                    saveOrgData();
                }
            } catch (e) {
                orgData = getDefaultOrgData();
            }
        }
        
        // Save org data (to localStorage AND AWS)
        async function saveOrgData() {
            localStorage.setItem('oith_org_data', JSON.stringify(orgData));
            
            // Sync to AWS
            try {
                const response = await fetch(`${AWS_API_URL}/org/sync`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        employees: orgData.employees || [],
                        departments: orgData.departments || []
                    })
                });
                
                if (response.ok) {
                    console.log(' Org data synced to AWS');
                } else {
                    console.log(' Failed to sync org data to AWS');
                }
            } catch (e) {
                console.log(' Org data AWS sync error:', e.message);
            }
        }
        
        // Get default org structure - empty by default, no hardcoded employees
        function getDefaultOrgData() {
            return {
                departments: [
                    { id: 'exec', name: 'Executive', color: '#8B5CF6' },
                    { id: 'eng', name: 'Engineering', color: '#3B82F6' },
                    { id: 'product', name: 'Product', color: '#10B981' },
                    { id: 'design', name: 'Design', color: '#EC4899' },
                    { id: 'marketing', name: 'Marketing', color: '#F59E0B' },
                    { id: 'ops', name: 'Operations', color: '#6366F1' },
                    { id: 'finance', name: 'Finance', color: '#14B8A6' }
                ],
                employees: []  // No hardcoded employees - add via admin interface
            };
        }
        
        async function renderOrgHierarchy() {
            await loadOrgData();
            
            // Update stats
            const employees = orgData.employees.filter(e => e.status === 'active');
            document.getElementById('totalEmployees').textContent = employees.length;
            document.getElementById('totalDepartments').textContent = orgData.departments.length;
            document.getElementById('managementCount').textContent = employees.filter(e => 
                employees.some(sub => sub.reportsTo === e.id)
            ).length;
            
            const deptCounts = {};
            employees.forEach(e => {
                deptCounts[e.department] = (deptCounts[e.department] || 0) + 1;
            });
            const avgTeam = Object.values(deptCounts).length > 0 
                ? (Object.values(deptCounts).reduce((a,b) => a+b, 0) / Object.values(deptCounts).length).toFixed(1)
                : 0;
            document.getElementById('avgTeamSize').textContent = avgTeam;
            
            // Render org chart
            renderOrgChart();
            
            // Render employee directory
            renderEmployeeDirectory();
        }
        
        function renderOrgChart() {
            const container = document.getElementById('orgChartContainer');
            const employees = orgData.employees.filter(e => e.status === 'active');
            
            // Handle empty employee list
            if (employees.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 60px 40px; color: var(--text-muted);">
                        <div style="font-size: 3rem; margin-bottom: 16px;"></div>
                        <div style="font-size: 1.1rem; margin-bottom: 8px;">No employees added yet</div>
                        <div style="font-size: 0.85rem; margin-bottom: 20px;">Click "Add Employee" to build your organization chart</div>
                        <button class="btn btn-primary" onclick="addEmployee()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/>
                                <path d="M12 8v8M8 12h8"/>
                            </svg>
                            Add First Employee
                        </button>
                    </div>
                `;
                return;
            }
            
            // Build hierarchy
            function buildTree(parentId = null) {
                return employees
                    .filter(e => e.reportsTo === parentId)
                    .map(e => ({
                        ...e,
                        dept: orgData.departments.find(d => d.id === e.department),
                        children: buildTree(e.id)
                    }));
            }
            
            const tree = buildTree(null);
            
            function renderNode(node, level = 0) {
                const hasChildren = node.children && node.children.length > 0;
                return `
                    <div style="display: flex; flex-direction: column; align-items: center;">
                        <div style="padding: 16px 20px; background: linear-gradient(135deg, ${node.dept?.color || 'var(--accent)'}20, ${node.dept?.color || 'var(--accent)'}10); border: 2px solid ${node.dept?.color || 'var(--accent)'}; border-radius: 12px; text-align: center; min-width: 160px; position: relative;">
                            <div style="font-weight: 600; font-size: 0.95rem;">${node.name}</div>
                            <div style="font-size: 0.8rem; color: var(--text-muted);">${node.role}</div>
                            <div style="margin-top: 6px; padding: 2px 8px; background: ${node.dept?.color || 'var(--accent)'}30; border-radius: 10px; font-size: 0.7rem; color: ${node.dept?.color || 'var(--accent)'};">${node.dept?.name || 'Unknown'}</div>
                        </div>
                        ${hasChildren ? `
                            <div style="width: 2px; height: 20px; background: var(--border);"></div>
                            <div style="display: flex; gap: 20px; position: relative;">
                                ${node.children.length > 1 ? `<div style="position: absolute; top: 0; left: 50%; transform: translateX(-50%); width: calc(100% - 80px); height: 2px; background: var(--border);"></div>` : ''}
                                ${node.children.map(child => `
                                    <div style="display: flex; flex-direction: column; align-items: center;">
                                        <div style="width: 2px; height: 20px; background: var(--border);"></div>
                                        ${renderNode(child, level + 1)}
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                `;
            }
            
            container.innerHTML = `
                <div style="overflow-x: auto; padding: 20px;">
                    <div style="display: flex; justify-content: center; min-width: fit-content;">
                        ${tree.map(node => renderNode(node)).join('')}
                    </div>
                </div>
            `;
        }
        
        function renderEmployeeDirectory() {
            const container = document.getElementById('employeeDirectory');
            const activeEmployees = orgData.employees.filter(e => e.status === 'active');
            const inactiveEmployees = orgData.employees.filter(e => e.status !== 'active');
            
            container.innerHTML = `
                <!-- Filter/Search -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <input type="text" id="empSearch" placeholder=" Search employees..." oninput="filterEmployeeDirectory()" style="padding: 10px 16px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); width: 300px;">
                    <div style="display: flex; gap: 8px;">
                        <button onclick="addEmployee()" class="btn btn-primary" style="padding: 10px 16px;"> Add Employee</button>
                    </div>
                </div>
                
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse;" id="employeeTable">
                        <thead>
                            <tr style="border-bottom: 2px solid var(--border);">
                                <th style="padding: 12px; text-align: left; font-size: 0.8rem; color: var(--text-muted);">Employee</th>
                                <th style="padding: 12px; text-align: left; font-size: 0.8rem; color: var(--text-muted);">Role</th>
                                <th style="padding: 12px; text-align: left; font-size: 0.8rem; color: var(--text-muted);">Department</th>
                                <th style="padding: 12px; text-align: left; font-size: 0.8rem; color: var(--text-muted);">Reports To</th>
                                <th style="padding: 12px; text-align: right; font-size: 0.8rem; color: var(--text-muted);">Salary</th>
                                <th style="padding: 12px; text-align: left; font-size: 0.8rem; color: var(--text-muted);">Start Date</th>
                                <th style="padding: 12px; text-align: center; font-size: 0.8rem; color: var(--text-muted);">Status</th>
                                <th style="padding: 12px; text-align: center; font-size: 0.8rem; color: var(--text-muted);">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${activeEmployees.map(emp => renderEmployeeRow(emp)).join('')}
                        </tbody>
                    </table>
                </div>
                
                ${inactiveEmployees.length > 0 ? `
                    <details style="margin-top: 20px;">
                        <summary style="cursor: pointer; padding: 12px; background: var(--bg-tertiary); border-radius: 8px; color: var(--text-muted);">
                             Inactive Employees (${inactiveEmployees.length})
                        </summary>
                        <div style="overflow-x: auto; margin-top: 12px;">
                            <table style="width: 100%; border-collapse: collapse; opacity: 0.7;">
                                <tbody>
                                    ${inactiveEmployees.map(emp => renderEmployeeRow(emp, true)).join('')}
                                </tbody>
                            </table>
                        </div>
                    </details>
                ` : ''}
            `;
        }
        
        function renderEmployeeRow(emp, isInactive = false) {
            const dept = orgData.departments.find(d => d.id === emp.department);
            const manager = orgData.employees.find(e => e.id === emp.reportsTo);
            const statusColors = {
                'active': 'var(--success)',
                'inactive': 'var(--text-muted)',
                'onleave': 'var(--warning)'
            };
            const statusColor = statusColors[emp.status] || 'var(--text-muted)';
            
            return `
                <tr style="border-bottom: 1px solid var(--border);" data-name="${emp.name.toLowerCase()}" data-role="${emp.role.toLowerCase()}" data-email="${emp.email.toLowerCase()}">
                    <td style="padding: 12px;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div style="width: 36px; height: 36px; border-radius: 50%; background: ${dept?.color || 'var(--accent)'}30; display: flex; align-items: center; justify-content: center; font-weight: 600; color: ${dept?.color || 'var(--accent)'};">
                                ${emp.name.split(' ').map(n => n[0]).join('').substring(0, 2)}
                            </div>
                            <div>
                                <div style="font-weight: 500;">${emp.name}</div>
                                <div style="font-size: 0.75rem; color: var(--text-muted);">${emp.email}</div>
                            </div>
                        </div>
                    </td>
                    <td style="padding: 12px; font-size: 0.9rem;">${emp.role}</td>
                    <td style="padding: 12px;">
                        <span style="padding: 4px 10px; background: ${dept?.color || 'var(--accent)'}20; color: ${dept?.color || 'var(--accent)'}; border-radius: 12px; font-size: 0.8rem;">${dept?.name || 'Unknown'}</span>
                    </td>
                    <td style="padding: 12px; font-size: 0.9rem; color: var(--text-muted);">${manager?.name || ''}</td>
                    <td style="padding: 12px; font-size: 0.9rem; text-align: right; font-weight: 500;">${formatCurrency(emp.salary)}</td>
                    <td style="padding: 12px; font-size: 0.9rem;">${new Date(emp.startDate).toLocaleDateString()}</td>
                    <td style="padding: 12px; text-align: center;">
                        <span style="padding: 4px 10px; background: ${statusColor}20; color: ${statusColor}; border-radius: 12px; font-size: 0.75rem;">${emp.status}</span>
                    </td>
                    <td style="padding: 12px; text-align: center;">
                        <button onclick="editEmployee(${emp.id})" title="Edit" style="padding: 6px 10px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 6px; cursor: pointer; font-size: 0.8rem; margin-right: 4px;"> Edit</button>
                        ${isInactive ? `
                            <button onclick="reactivateEmployee(${emp.id})" title="Reactivate" style="padding: 6px 10px; background: var(--success)20; border: 1px solid var(--success); color: var(--success); border-radius: 6px; cursor: pointer; font-size: 0.8rem; margin-right: 4px;"> Reactivate</button>
                            <button onclick="deleteEmployee(${emp.id})" title="Permanently Delete" style="padding: 6px 10px; background: var(--danger); border: 1px solid var(--danger); color: white; border-radius: 6px; cursor: pointer; font-size: 0.8rem;"> Delete</button>
                        ` : `
                            <button onclick="removeEmployee(${emp.id})" title="Deactivate" style="padding: 6px 10px; background: var(--danger)20; border: 1px solid var(--danger); color: var(--danger); border-radius: 6px; cursor: pointer; font-size: 0.8rem;"> Deactivate</button>
                        `}
                    </td>
                </tr>
            `;
        }
        
        function filterEmployeeDirectory() {
            const search = document.getElementById('empSearch').value.toLowerCase();
            const rows = document.querySelectorAll('#employeeTable tbody tr');
            
            rows.forEach(row => {
                const name = row.dataset.name || '';
                const role = row.dataset.role || '';
                const email = row.dataset.email || '';
                const matches = name.includes(search) || role.includes(search) || email.includes(search);
                row.style.display = matches ? '' : 'none';
            });
        }
        
        // Show employee modal for add/edit
        async function showEmployeeModal(empId = null) {
            await loadOrgData();
            const isEdit = empId !== null;
            const emp = isEdit ? orgData.employees.find(e => e.id === empId) : null;
            
            const modal = document.createElement('div');
            modal.id = 'employeeModal';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 20px;';
            
            modal.innerHTML = `
                <div style="background: var(--bg-primary); border-radius: 16px; max-width: 600px; width: 100%; max-height: 90vh; overflow-y: auto;">
                    <div style="padding: 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
                        <h3 style="margin: 0;">${isEdit ? ' Edit Employee' : ' Add New Employee'}</h3>
                        <button onclick="closeEmployeeModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-muted);"></button>
                    </div>
                    <form id="employeeForm" onsubmit="saveEmployee(event, ${empId})" style="padding: 20px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                            <!-- Name -->
                            <div style="grid-column: span 2;">
                                <label style="display: block; font-size: 0.85rem; margin-bottom: 6px; color: var(--text-muted);">Full Name *</label>
                                <input type="text" id="empName" value="${emp?.name || ''}" required style="width: 100%; padding: 12px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); font-size: 1rem;">
                            </div>
                            
                            <!-- Email -->
                            <div style="grid-column: span 2;">
                                <label style="display: block; font-size: 0.85rem; margin-bottom: 6px; color: var(--text-muted);">Email *</label>
                                <input type="email" id="empEmail" value="${emp?.email || ''}" required style="width: 100%; padding: 12px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); font-size: 1rem;">
                            </div>
                            
                            <!-- Role -->
                            <div>
                                <label style="display: block; font-size: 0.85rem; margin-bottom: 6px; color: var(--text-muted);">Role/Title *</label>
                                <input type="text" id="empRole" value="${emp?.role || ''}" required style="width: 100%; padding: 12px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); font-size: 1rem;">
                            </div>
                            
                            <!-- Department -->
                            <div>
                                <label style="display: block; font-size: 0.85rem; margin-bottom: 6px; color: var(--text-muted);">Department *</label>
                                <select id="empDepartment" required style="width: 100%; padding: 12px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); font-size: 1rem;">
                                    <option value="">Select department...</option>
                                    ${orgData.departments.map(d => `
                                        <option value="${d.id}" ${emp?.department === d.id ? 'selected' : ''}>${d.name}</option>
                                    `).join('')}
                                </select>
                            </div>
                            
                            <!-- Reports To -->
                            <div>
                                <label style="display: block; font-size: 0.85rem; margin-bottom: 6px; color: var(--text-muted);">Reports To</label>
                                <select id="empReportsTo" style="width: 100%; padding: 12px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); font-size: 1rem;">
                                    <option value="">No manager (top level)</option>
                                    ${orgData.employees.filter(e => e.status === 'active' && e.id !== empId).map(e => `
                                        <option value="${e.id}" ${emp?.reportsTo === e.id ? 'selected' : ''}>${e.name} (${e.role})</option>
                                    `).join('')}
                                </select>
                            </div>
                            
                            <!-- Salary -->
                            <div>
                                <label style="display: block; font-size: 0.85rem; margin-bottom: 6px; color: var(--text-muted);">Annual Salary ($) *</label>
                                <input type="number" id="empSalary" value="${emp?.salary || 80000}" required min="0" step="1000" style="width: 100%; padding: 12px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); font-size: 1rem;">
                            </div>
                            
                            <!-- Start Date -->
                            <div>
                                <label style="display: block; font-size: 0.85rem; margin-bottom: 6px; color: var(--text-muted);">Start Date *</label>
                                <input type="date" id="empStartDate" value="${emp?.startDate || new Date().toISOString().split('T')[0]}" required style="width: 100%; padding: 12px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); font-size: 1rem;">
                            </div>
                            
                            <!-- Status -->
                            <div>
                                <label style="display: block; font-size: 0.85rem; margin-bottom: 6px; color: var(--text-muted);">Status</label>
                                <select id="empStatus" style="width: 100%; padding: 12px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); font-size: 1rem;">
                                    <option value="active" ${emp?.status === 'active' || !emp ? 'selected' : ''}>Active</option>
                                    <option value="inactive" ${emp?.status === 'inactive' ? 'selected' : ''}>Inactive</option>
                                    <option value="onleave" ${emp?.status === 'onleave' ? 'selected' : ''}>On Leave</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Action Buttons -->
                        <div style="margin-top: 24px; display: flex; gap: 12px; justify-content: flex-end;">
                            ${isEdit ? `
                                <button type="button" onclick="deleteEmployee(${empId})" style="padding: 12px 20px; background: var(--danger); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 0.9rem;">
                                     Delete Employee
                                </button>
                            ` : ''}
                            <button type="button" onclick="closeEmployeeModal()" style="padding: 12px 20px; background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border); border-radius: 8px; cursor: pointer; font-size: 0.9rem;">
                                Cancel
                            </button>
                            <button type="submit" style="padding: 12px 24px; background: var(--accent); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 0.9rem; font-weight: 600;">
                                ${isEdit ? ' Save Changes' : ' Add Employee'}
                            </button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
            modal.onclick = (e) => {
                if (e.target === modal) closeEmployeeModal();
            };
            
            // Focus first input
            setTimeout(() => document.getElementById('empName').focus(), 100);
        }
        
        function closeEmployeeModal() {
            const modal = document.getElementById('employeeModal');
            if (modal) modal.remove();
        }
        
        async function saveEmployee(event, empId) {
            event.preventDefault();
            await loadOrgData();
            
            const employeeData = {
                name: document.getElementById('empName').value.trim(),
                email: document.getElementById('empEmail').value.trim(),
                role: document.getElementById('empRole').value.trim(),
                department: document.getElementById('empDepartment').value,
                reportsTo: document.getElementById('empReportsTo').value ? parseInt(document.getElementById('empReportsTo').value) : null,
                salary: parseFloat(document.getElementById('empSalary').value) || 0,
                startDate: document.getElementById('empStartDate').value,
                status: document.getElementById('empStatus').value
            };
            
            if (empId) {
                // Edit existing
                const empIndex = orgData.employees.findIndex(e => e.id === empId);
                if (empIndex !== -1) {
                    orgData.employees[empIndex] = { ...orgData.employees[empIndex], ...employeeData };
                    // Log activity
                    logAdminActivity('user', 'Updated employee record', employeeData.name, { department: employeeData.department, role: employeeData.role });
                    showToast(` ${employeeData.name} updated successfully`, 'success');
                }
            } else {
                // Add new
                const newEmployee = {
                    id: Date.now(),
                    ...employeeData
                };
                orgData.employees.push(newEmployee);
                // Log activity
                logAdminActivity('create', 'Added new employee', employeeData.name, { department: employeeData.department, role: employeeData.role, email: employeeData.email });
                showToast(` ${employeeData.name} added to the organization`, 'success');
            }
            
            await saveOrgData();
            closeEmployeeModal();
            
            // Re-render both sections
            await renderOrgHierarchy();
            if (document.getElementById('payroll-section').style.display !== 'none') {
                await renderPayroll();
            }
            
            // Refresh database schema stats to update employee count
            await syncDynamoDBSchema();
        }
        
        function addEmployee() {
            showEmployeeModal(null);
        }
        
        function editEmployee(empId) {
            showEmployeeModal(empId);
        }
        
        async function deleteEmployee(empId) {
            await loadOrgData();
            const emp = orgData.employees.find(e => e.id === empId);
            if (!emp) return;
            
            if (!confirm(`Are you sure you want to permanently delete ${emp.name}?\n\nThis action cannot be undone.`)) return;
            
            // Check if anyone reports to this employee
            const subordinates = orgData.employees.filter(e => e.reportsTo === empId);
            if (subordinates.length > 0) {
                const names = subordinates.map(s => s.name).join(', ');
                if (!confirm(`${emp.name} has ${subordinates.length} direct report(s): ${names}\n\nThey will be reassigned to ${emp.name}'s manager. Continue?`)) return;
                
                // Reassign subordinates to this employee's manager
                subordinates.forEach(s => {
                    const idx = orgData.employees.findIndex(e => e.id === s.id);
                    if (idx !== -1) {
                        orgData.employees[idx].reportsTo = emp.reportsTo;
                    }
                });
            }
            
            // Remove employee
            orgData.employees = orgData.employees.filter(e => e.id !== empId);
            await saveOrgData();
            
            closeEmployeeModal();
            await renderOrgHierarchy();
            if (document.getElementById('payroll-section').style.display !== 'none') {
                await renderPayroll();
            }
            
            // Refresh database schema stats to update employee count
            await syncDynamoDBSchema();
            
            showToast(` ${emp.name} has been removed`, 'info');
        }
        
        async function removeEmployee(empId) {
            // Soft delete - just set status to inactive
            await loadOrgData();
            const emp = orgData.employees.find(e => e.id === empId);
            if (!emp) return;
            
            if (!confirm(`Deactivate ${emp.name}? They will be removed from the active org chart but data will be preserved.`)) return;
            
            const empIndex = orgData.employees.findIndex(e => e.id === empId);
            if (empIndex !== -1) {
                orgData.employees[empIndex].status = 'inactive';
                await saveOrgData();
                await renderOrgHierarchy();
                if (document.getElementById('payroll-section').style.display !== 'none') {
                    await renderPayroll();
                }
                await syncDynamoDBSchema();
                showToast(` ${emp.name} has been deactivated`, 'info');
            }
        }
        
        async function reactivateEmployee(empId) {
            await loadOrgData();
            const empIndex = orgData.employees.findIndex(e => e.id === empId);
            if (empIndex !== -1) {
                orgData.employees[empIndex].status = 'active';
                await saveOrgData();
                await renderOrgHierarchy();
                await syncDynamoDBSchema();
                showToast(` Employee reactivated`, 'success');
            }
        }
        
        function exportOrgChart() {
            const exportData = {
                exportedAt: new Date().toISOString(),
                organization: orgData
            };
            
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `oith_org_chart_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            showToast(' Organization chart exported', 'success');
        }

        // ==========================================
        // PAYROLL MANAGEMENT
        // ==========================================
        
        let payrollData = {
            runs: [],
            settings: {
                payFrequency: 'biweekly', // 'weekly', 'biweekly', 'monthly'
                lastPayDate: null,
                nextPayDate: null
            }
        };
        
        function loadPayrollData() {
            try {
                const saved = localStorage.getItem('oith_payroll_data');
                if (saved) {
                    payrollData = JSON.parse(saved);
                } else {
                    payrollData = getDefaultPayrollData();
                    savePayrollData();
                }
            } catch (e) {
                payrollData = getDefaultPayrollData();
            }
        }
        
        function savePayrollData() {
            localStorage.setItem('oith_payroll_data', JSON.stringify(payrollData));
        }
        
        function getDefaultPayrollData() {
            const today = new Date();
            const nextPay = new Date(today);
            nextPay.setDate(today.getDate() + (14 - today.getDay())); // Next Friday
            
            // No hardcoded payroll runs - starts empty
            return {
                runs: [],  // Payroll runs will be added when "Run Payroll" is clicked
                settings: {
                    payFrequency: 'biweekly',
                    lastPayDate: null,
                    nextPayDate: nextPay.toISOString()
                }
            };
        }
        
        async function renderPayroll() {
            await loadOrgData();
            loadPayrollData();
            
            const employees = orgData.employees.filter(e => e.status === 'active');
            
            // Calculate monthly payroll from actual employee salaries
            const monthlyPayroll = employees.reduce((sum, e) => sum + ((e.salary || 0) / 12), 0);
            document.getElementById('monthlyPayroll').textContent = employees.length > 0 ? formatCurrency(monthlyPayroll) : '$0';
            
            // Next pay date
            const nextPay = payrollData.settings.nextPayDate ? new Date(payrollData.settings.nextPayDate) : new Date();
            document.getElementById('nextPayDate').textContent = nextPay.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            
            // Pending payments = active employees
            document.getElementById('pendingPayments').textContent = employees.length;
            
            // YTD Payroll from actual payroll runs
            const ytdPayroll = payrollData.runs
                .filter(r => new Date(r.date).getFullYear() === new Date().getFullYear() && r.status === 'completed')
                .reduce((sum, r) => sum + r.totalAmount, 0);
            document.getElementById('ytdPayroll').textContent = formatCurrency(ytdPayroll);
            
            // Render sections
            renderCompensationOverview(employees);
            renderPayrollHistory();
            renderEmployeeCompensation(employees);
        }
        
        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(amount);
        }
        
        function renderCompensationOverview(employees) {
            const container = document.getElementById('compensationOverview');
            
            // Handle empty employee list
            if (employees.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--text-muted);">
                        <div style="font-size: 2rem; margin-bottom: 8px;"></div>
                        <div>No employees added yet</div>
                        <div style="font-size: 0.8rem; margin-top: 4px;">Add employees in the Hierarchy section to see compensation data</div>
                    </div>
                `;
                return;
            }
            
            const totalComp = employees.reduce((sum, e) => sum + (e.salary || 0), 0);
            const avgComp = employees.length > 0 ? totalComp / employees.length : 0;
            const salaries = employees.map(e => e.salary || 0).filter(s => s > 0);
            const maxComp = salaries.length > 0 ? Math.max(...salaries) : 0;
            const minComp = salaries.length > 0 ? Math.min(...salaries) : 0;
            
            // Compensation by department
            const byDept = {};
            employees.forEach(e => {
                const dept = orgData.departments.find(d => d.id === e.department);
                const deptName = dept?.name || 'Unknown';
                if (!byDept[deptName]) byDept[deptName] = { total: 0, count: 0, color: dept?.color || 'var(--accent)' };
                byDept[deptName].total += e.salary;
                byDept[deptName].count++;
            });
            
            container.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px;">
                    <div style="padding: 20px; background: var(--bg-tertiary); border-radius: 12px; text-align: center;">
                        <div style="font-size: 1.8rem; font-weight: 700; color: var(--success);">${formatCurrency(totalComp)}</div>
                        <div style="font-size: 0.85rem; color: var(--text-muted);">Total Annual Payroll</div>
                    </div>
                    <div style="padding: 20px; background: var(--bg-tertiary); border-radius: 12px; text-align: center;">
                        <div style="font-size: 1.8rem; font-weight: 700; color: var(--info);">${formatCurrency(avgComp)}</div>
                        <div style="font-size: 0.85rem; color: var(--text-muted);">Average Salary</div>
                    </div>
                    <div style="padding: 20px; background: var(--bg-tertiary); border-radius: 12px; text-align: center;">
                        <div style="font-size: 1.8rem; font-weight: 700; color: var(--purple);">${formatCurrency(maxComp)}</div>
                        <div style="font-size: 0.85rem; color: var(--text-muted);">Highest Salary</div>
                    </div>
                    <div style="padding: 20px; background: var(--bg-tertiary); border-radius: 12px; text-align: center;">
                        <div style="font-size: 1.8rem; font-weight: 700; color: var(--warning);">${formatCurrency(minComp)}</div>
                        <div style="font-size: 0.85rem; color: var(--text-muted);">Lowest Salary</div>
                    </div>
                </div>
                
                <h5 style="margin: 0 0 16px;"> Compensation by Department</h5>
                <div style="display: grid; gap: 12px;">
                    ${Object.entries(byDept).map(([name, data]) => `
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div style="width: 120px; font-size: 0.9rem;">${name}</div>
                            <div style="flex: 1; height: 24px; background: var(--bg-secondary); border-radius: 12px; overflow: hidden;">
                                <div style="height: 100%; width: ${(data.total / totalComp * 100)}%; background: ${data.color}; border-radius: 12px; display: flex; align-items: center; justify-content: flex-end; padding-right: 8px;">
                                    <span style="font-size: 0.75rem; color: white; font-weight: 600;">${formatCurrency(data.total)}</span>
                                </div>
                            </div>
                            <div style="width: 80px; text-align: right; font-size: 0.8rem; color: var(--text-muted);">${data.count} emp${data.count > 1 ? 's' : ''}</div>
                        </div>
                    `).join('')}
                </div>
            `;
        }
        
        function renderPayrollHistory() {
            const container = document.getElementById('payrollHistory');
            const runs = payrollData.runs.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            if (runs.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--text-muted);">No payroll runs yet</p>';
                return;
            }
            
            container.innerHTML = `
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="border-bottom: 2px solid var(--border);">
                                <th style="padding: 12px; text-align: left; font-size: 0.8rem; color: var(--text-muted);">Pay Date</th>
                                <th style="padding: 12px; text-align: right; font-size: 0.8rem; color: var(--text-muted);">Amount</th>
                                <th style="padding: 12px; text-align: center; font-size: 0.8rem; color: var(--text-muted);">Employees</th>
                                <th style="padding: 12px; text-align: center; font-size: 0.8rem; color: var(--text-muted);">Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${runs.slice(0, 10).map(run => `
                                <tr style="border-bottom: 1px solid var(--border);">
                                    <td style="padding: 12px;">${new Date(run.date).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</td>
                                    <td style="padding: 12px; text-align: right; font-weight: 600; color: var(--success);">${formatCurrency(run.totalAmount)}</td>
                                    <td style="padding: 12px; text-align: center;">${run.employeeCount}</td>
                                    <td style="padding: 12px; text-align: center;">
                                        <span style="padding: 4px 10px; background: ${run.status === 'completed' ? 'var(--success)' : 'var(--warning)'}20; color: ${run.status === 'completed' ? 'var(--success)' : 'var(--warning)'}; border-radius: 12px; font-size: 0.75rem;">
                                            ${run.status === 'completed' ? ' Completed' : ' Pending'}
                                        </span>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }
        
        function renderEmployeeCompensation(employees) {
            const container = document.getElementById('employeeCompensation');
            const sorted = [...employees].sort((a, b) => b.salary - a.salary);
            
            container.innerHTML = `
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="border-bottom: 2px solid var(--border);">
                                <th style="padding: 12px; text-align: left; font-size: 0.8rem; color: var(--text-muted);">Employee</th>
                                <th style="padding: 12px; text-align: left; font-size: 0.8rem; color: var(--text-muted);">Role</th>
                                <th style="padding: 12px; text-align: right; font-size: 0.8rem; color: var(--text-muted);">Annual Salary</th>
                                <th style="padding: 12px; text-align: right; font-size: 0.8rem; color: var(--text-muted);">Monthly</th>
                                <th style="padding: 12px; text-align: right; font-size: 0.8rem; color: var(--text-muted);">Bi-Weekly</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${sorted.map(emp => `
                                <tr style="border-bottom: 1px solid var(--border);">
                                    <td style="padding: 12px;">
                                        <div style="font-weight: 500;">${emp.name}</div>
                                    </td>
                                    <td style="padding: 12px; font-size: 0.9rem; color: var(--text-muted);">${emp.role}</td>
                                    <td style="padding: 12px; text-align: right; font-weight: 600;">${formatCurrency(emp.salary)}</td>
                                    <td style="padding: 12px; text-align: right; color: var(--text-muted);">${formatCurrency(emp.salary / 12)}</td>
                                    <td style="padding: 12px; text-align: right; color: var(--text-muted);">${formatCurrency(emp.salary / 26)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                        <tfoot style="border-top: 2px solid var(--border);">
                            <tr>
                                <td colspan="2" style="padding: 12px; font-weight: 600;">Total</td>
                                <td style="padding: 12px; text-align: right; font-weight: 700; color: var(--success);">${formatCurrency(sorted.reduce((s,e) => s + e.salary, 0))}</td>
                                <td style="padding: 12px; text-align: right; font-weight: 600; color: var(--success);">${formatCurrency(sorted.reduce((s,e) => s + e.salary, 0) / 12)}</td>
                                <td style="padding: 12px; text-align: right; font-weight: 600; color: var(--success);">${formatCurrency(sorted.reduce((s,e) => s + e.salary, 0) / 26)}</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            `;
        }
        
        async function runPayroll() {
            if (!confirm('Run payroll for all active employees?')) return;
            
            await loadOrgData();
            loadPayrollData();
            
            const employees = orgData.employees.filter(e => e.status === 'active');
            const totalAmount = employees.reduce((sum, e) => sum + (e.salary / 26), 0); // Bi-weekly
            
            const newRun = {
                id: Date.now(),
                date: new Date().toISOString(),
                totalAmount: totalAmount,
                employeeCount: employees.length,
                status: 'completed'
            };
            
            payrollData.runs.push(newRun);
            payrollData.settings.lastPayDate = new Date().toISOString();
            
            // Calculate next pay date (14 days from now)
            const nextPay = new Date();
            nextPay.setDate(nextPay.getDate() + 14);
            payrollData.settings.nextPayDate = nextPay.toISOString();
            
            savePayrollData();
            renderPayroll();
            
            showToast(` Payroll run complete! ${formatCurrency(totalAmount)} paid to ${employees.length} employees`, 'success');
        }
        
        async function exportPayrollReport() {
            loadPayrollData();
            await loadOrgData();
            
            const report = {
                generatedAt: new Date().toISOString(),
                employees: orgData.employees.filter(e => e.status === 'active').map(e => ({
                    name: e.name,
                    role: e.role,
                    department: orgData.departments.find(d => d.id === e.department)?.name,
                    annualSalary: e.salary,
                    monthlySalary: e.salary / 12,
                    biWeeklySalary: e.salary / 26
                })),
                payrollHistory: payrollData.runs
            };
            
            const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `oith_payroll_report_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            showToast(' Payroll report exported', 'success');
        }

        // ==========================================
        // TAX REQUIREMENTS & COMPLIANCE
        // ==========================================
        
        // Tax data storage
        let taxData = {
            currentPhase: 1,
            tasksCompleted: [],
            lastUpdated: null
        };
        
        function loadTaxData() {
            const saved = localStorage.getItem('oith_tax_data');
            if (saved) {
                taxData = JSON.parse(saved);
            }
        }
        
        function saveTaxData() {
            taxData.lastUpdated = new Date().toISOString();
            localStorage.setItem('oith_tax_data', JSON.stringify(taxData));
        }
        
        function toggleTaxTask(taskId) {
            loadTaxData();
            if (taxData.tasksCompleted.includes(taskId)) {
                taxData.tasksCompleted = taxData.tasksCompleted.filter(t => t !== taskId);
            } else {
                taxData.tasksCompleted.push(taskId);
            }
            saveTaxData();
            renderTax();
        }
        
        function renderTax() {
            loadTaxData();
            
            // Phase 1: Pre-LLC Formation Requirements
            const phase1Requirements = [
                {
                    id: 'p1_1',
                    title: 'Personal Tax Implications for Founders',
                    description: 'Until LLC is formed, any business income/expenses flow through personal tax returns',
                    urgency: 'info',
                    icon: '',
                    details: [
                        'Track all business expenses with receipts (deductible on Schedule C)',
                        'Document any personal funds invested as "owner contributions"',
                        'Keep separate records even without separate bank account yet'
                    ]
                },
                {
                    id: 'p1_2',
                    title: 'Prepare for EIN Application',
                    description: 'Required immediately after LLC approval - cannot hire or open business bank account without it',
                    urgency: 'warning',
                    icon: '',
                    details: [
                        'IRS Form SS-4 (free, online at IRS.gov)',
                        'Need: LLC name, address, responsible party SSN',
                        'Apply online for instant EIN or fax/mail (4-6 weeks)',
                        'OITH will need this before issuing any W-2s or 1099s'
                    ]
                },
                {
                    id: 'p1_3',
                    title: 'Document Pre-Formation Expenses',
                    description: 'Startup costs incurred before LLC formation can be deducted',
                    urgency: 'success',
                    icon: '',
                    details: [
                        'Legal fees (LLC filing, operating agreement)',
                        'Software subscriptions (development tools, AWS)',
                        'Market research and business planning',
                        'Up to $5,000 deductible in first year, remainder amortized over 180 months'
                    ]
                },
                {
                    id: 'p1_4',
                    title: 'Classify Worker Relationships',
                    description: '2 current team members - establish proper classification NOW',
                    urgency: 'danger',
                    icon: '',
                    details: [
                        'IRS has strict rules on Employee vs. Contractor',
                        'Founders working full-time = likely employees (once LLC formed)',
                        'Misclassification penalties: back taxes + 100% of unpaid employment taxes',
                        'Document roles, hours, and control factors'
                    ]
                },
                {
                    id: 'p1_5',
                    title: 'Choose Tax Classification for LLC',
                    description: 'Multi-member LLC defaults to partnership taxation - consider alternatives',
                    urgency: 'info',
                    icon: '',
                    details: [
                        '<strong>Default (Partnership):</strong> Income passes through to members proportionally',
                        '<strong>S-Corp Election (Form 2553):</strong> Potential self-employment tax savings',
                        '<strong>C-Corp Election:</strong> Only if planning significant VC funding',
                        'Consult CPA before making election - difficult to change later'
                    ]
                }
            ];
            
            // Phase 2: Post-LLC Formation Requirements
            const phase2Requirements = [
                {
                    id: 'p2_1',
                    title: 'Obtain EIN (Employer Identification Number)',
                    description: 'Apply immediately after LLC is approved',
                    urgency: 'danger',
                    icon: '',
                    details: [
                        'Required for: opening business bank account, hiring, filing taxes',
                        'Free to obtain at irs.gov/ein',
                        'Takes minutes online, instant issuance',
                        'Keep EIN letter in permanent records'
                    ],
                    deadline: 'Within 1 week of LLC approval'
                },
                {
                    id: 'p2_2',
                    title: 'Register with Ohio Department of Taxation',
                    description: 'State employer registration required if paying wages',
                    urgency: 'warning',
                    icon: '',
                    details: [
                        'Ohio IT 1 (Employer\'s Withholding Registration)',
                        'Ohio Commercial Activity Tax (CAT) - if gross receipts > $150,000',
                        'Sales Tax Registration - if selling taxable goods/services',
                        'Register at tax.ohio.gov'
                    ],
                    deadline: 'Before first payroll'
                },
                {
                    id: 'p2_3',
                    title: 'Ohio Unemployment Tax (SUTA)',
                    description: 'Required for all Ohio employers',
                    urgency: 'warning',
                    icon: '',
                    details: [
                        'Register with Ohio Department of Job & Family Services',
                        'New employer rate: 2.7% on first $9,000 of each employee\'s wages',
                        'File Form JFS-20125 quarterly',
                        'Due dates: 4/30, 7/31, 10/31, 1/31'
                    ],
                    deadline: 'Before first payroll'
                },
                {
                    id: 'p2_4',
                    title: 'Federal Unemployment Tax (FUTA)',
                    description: 'IRS Form 940 - Annual federal unemployment tax',
                    urgency: 'info',
                    icon: '',
                    details: [
                        '6.0% on first $7,000 of each employee\'s wages',
                        'Credit up to 5.4% for paying state unemployment tax',
                        'Net rate typically 0.6% ($42/employee/year)',
                        'File Form 940 annually by January 31'
                    ],
                    deadline: 'Annual - January 31'
                },
                {
                    id: 'p2_5',
                    title: 'Set Up Payroll Tax Withholding',
                    description: 'Must withhold and deposit employee taxes',
                    urgency: 'danger',
                    icon: '',
                    details: [
                        '<strong>Federal:</strong> Income tax, Social Security (6.2%), Medicare (1.45%)',
                        '<strong>Ohio:</strong> State income tax withholding',
                        '<strong>Local:</strong> Many Ohio cities have income tax (verify for your location)',
                        'Deposits: Semi-weekly or monthly depending on liability amount',
                        'Form 941 filed quarterly to IRS'
                    ],
                    deadline: 'Before first payroll'
                },
                {
                    id: 'p2_6',
                    title: 'Workers\' Compensation Insurance',
                    description: 'Ohio BWC - Required for all Ohio employers',
                    urgency: 'warning',
                    icon: '',
                    details: [
                        'Register with Ohio Bureau of Workers\' Compensation',
                        'Rates vary by classification (software/office work = low risk)',
                        'Premium based on payroll amount',
                        'Can elect to be a self-insuring employer (advanced)'
                    ],
                    deadline: 'Before first payroll'
                },
                {
                    id: 'p2_7',
                    title: 'Open Business Bank Account',
                    description: 'Separate business finances from personal',
                    urgency: 'success',
                    icon: '',
                    details: [
                        'Requires: EIN, LLC formation documents, Operating Agreement',
                        'Maintains "corporate veil" protection',
                        'Makes accounting and tax prep much easier',
                        'Consider: checking, savings, and business credit card'
                    ],
                    deadline: 'Week 1 after EIN received'
                }
            ];
            
            // Phase 3: Revenue & Operations Requirements
            const phase3Requirements = [
                {
                    id: 'p3_1',
                    title: 'Quarterly Estimated Tax Payments',
                    description: 'Once profitable, must pay taxes quarterly to avoid penalties',
                    urgency: 'warning',
                    icon: '',
                    details: [
                        'IRS Form 1040-ES (individual) or entity-level payments',
                        'Due: April 15, June 15, September 15, January 15',
                        'Pay 100% of prior year tax OR 90% of current year to avoid penalty',
                        'Ohio estimated payments also required'
                    ]
                },
                {
                    id: 'p3_2',
                    title: 'Ohio Commercial Activity Tax (CAT)',
                    description: 'Applies to businesses with Ohio gross receipts',
                    urgency: 'info',
                    icon: '',
                    details: [
                        '<strong>Under $150,000:</strong> No CAT due, but must still register if required',
                        '<strong>$150,000 - $1M:</strong> Minimum tax of $150/year',
                        '<strong>Over $1M:</strong> 0.26% on gross receipts over $1M',
                        'Filed quarterly (calendar year filers)'
                    ]
                },
                {
                    id: 'p3_3',
                    title: 'Sales Tax Collection (If Applicable)',
                    description: 'Ohio sales tax on tangible goods and some services',
                    urgency: 'info',
                    icon: '',
                    details: [
                        'SaaS subscriptions generally NOT taxable in Ohio (as of 2024)',
                        'Physical goods, certain digital products ARE taxable',
                        'If taxable: Register, collect 5.75% state + local rates',
                        'File monthly, quarterly, or semi-annually based on liability'
                    ]
                },
                {
                    id: 'p3_4',
                    title: 'Annual LLC Return / K-1s',
                    description: 'Partnership/LLC tax reporting requirements',
                    urgency: 'warning',
                    icon: '',
                    details: [
                        '<strong>Form 1065:</strong> Partnership Return (due March 15)',
                        '<strong>Schedule K-1:</strong> Issued to each member showing their share',
                        'Members report K-1 income on personal returns',
                        'Late filing penalty: $220/month per partner'
                    ]
                },
                {
                    id: 'p3_5',
                    title: 'Payroll Tax Compliance (Ongoing)',
                    description: 'Recurring payroll tax obligations',
                    urgency: 'danger',
                    icon: '',
                    details: [
                        '<strong>Form 941:</strong> Quarterly federal payroll tax return',
                        '<strong>W-2s:</strong> Issued to employees by January 31',
                        '<strong>W-3:</strong> Summary filed with SSA by January 31',
                        '<strong>1099-NEC:</strong> For contractors paid $600+ (due January 31)'
                    ]
                },
                {
                    id: 'p3_6',
                    title: 'R&D Tax Credit',
                    description: 'Federal credit for qualified research expenses',
                    urgency: 'success',
                    icon: '',
                    details: [
                        'Software development often qualifies!',
                        'Credit up to 20% of qualified research expenses',
                        'Startups can offset payroll taxes (up to $250K/year for 5 years)',
                        'Document: developer time, experimentation, technical uncertainty'
                    ]
                },
                {
                    id: 'p3_7',
                    title: 'Section 1202 QSBS Exclusion',
                    description: 'Potential tax-free gains on stock sale',
                    urgency: 'success',
                    icon: '',
                    details: [
                        'Exclude up to 100% of capital gains on qualifying small business stock',
                        'Requirements: C-Corp, held 5+ years, active business, under $50M assets',
                        'Relevant if planning to convert to C-Corp for VC funding',
                        'Worth discussing with CPA if planning equity fundraising'
                    ]
                }
            ];
            
            // Key Tax Deadlines
            const taxDeadlines = [
                { date: 'Upon LLC Approval', task: 'Apply for EIN', status: 'pending', phase: 2 },
                { date: 'Before 1st Payroll', task: 'Register with Ohio Dept of Taxation & BWC', status: 'pending', phase: 2 },
                { date: 'January 31', task: 'W-2s to employees, 1099s to contractors', status: 'annual', phase: 3 },
                { date: 'January 31', task: 'Form 940 (FUTA) annual filing', status: 'annual', phase: 3 },
                { date: 'March 15', task: 'Form 1065 Partnership Return (or extension)', status: 'annual', phase: 3 },
                { date: 'April 15', task: 'Q1 estimated taxes (federal & state)', status: 'quarterly', phase: 3 },
                { date: 'April 30', task: 'Q1 Form 941 & Ohio unemployment', status: 'quarterly', phase: 3 },
                { date: 'June 15', task: 'Q2 estimated taxes', status: 'quarterly', phase: 3 },
                { date: 'July 31', task: 'Q2 Form 941 & Ohio unemployment', status: 'quarterly', phase: 3 },
                { date: 'September 15', task: 'Q3 estimated taxes', status: 'quarterly', phase: 3 },
                { date: 'October 31', task: 'Q3 Form 941 & Ohio unemployment', status: 'quarterly', phase: 3 },
                { date: 'January 15', task: 'Q4 estimated taxes', status: 'quarterly', phase: 3 },
                { date: 'January 31', task: 'Q4 Form 941 & Ohio unemployment', status: 'quarterly', phase: 3 }
            ];
            
            // Update summary stats
            const totalTasks = phase1Requirements.length + phase2Requirements.length + phase3Requirements.length;
            const completedCount = taxData.tasksCompleted.length;
            document.getElementById('taxTasksCompleted').textContent = `${completedCount}/${totalTasks}`;
            
            // Count urgent items (danger level not completed)
            const urgentItems = [...phase1Requirements, ...phase2Requirements].filter(r => r.urgency === 'danger' && !taxData.tasksCompleted.includes(r.id)).length;
            document.getElementById('taxUrgentItems').textContent = urgentItems;
            
            // Render Phase 1
            document.getElementById('taxPhase1Content').innerHTML = renderTaxRequirementsList(phase1Requirements);
            
            // Render Phase 2
            document.getElementById('taxPhase2Content').innerHTML = renderTaxRequirementsList(phase2Requirements);
            
            // Render Phase 3
            document.getElementById('taxPhase3Content').innerHTML = renderTaxRequirementsList(phase3Requirements);
            
            // Render Deadlines
            document.getElementById('taxDeadlinesContent').innerHTML = `
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="border-bottom: 2px solid var(--border);">
                                <th style="padding: 12px; text-align: left; font-size: 0.8rem; color: var(--text-muted);">Deadline</th>
                                <th style="padding: 12px; text-align: left; font-size: 0.8rem; color: var(--text-muted);">Task</th>
                                <th style="padding: 12px; text-align: center; font-size: 0.8rem; color: var(--text-muted);">Frequency</th>
                                <th style="padding: 12px; text-align: center; font-size: 0.8rem; color: var(--text-muted);">Phase</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${taxDeadlines.map(d => `
                                <tr style="border-bottom: 1px solid var(--border);">
                                    <td style="padding: 12px; font-weight: 600;">${d.date}</td>
                                    <td style="padding: 12px;">${d.task}</td>
                                    <td style="padding: 12px; text-align: center;">
                                        <span style="padding: 4px 10px; background: ${d.status === 'pending' ? 'var(--warning)' : d.status === 'annual' ? 'var(--info)' : 'var(--purple)'}20; color: ${d.status === 'pending' ? 'var(--warning)' : d.status === 'annual' ? 'var(--info)' : 'var(--purple)'}; border-radius: 12px; font-size: 0.75rem; text-transform: capitalize;">
                                            ${d.status}
                                        </span>
                                    </td>
                                    <td style="padding: 12px; text-align: center;">
                                        <span style="padding: 4px 10px; background: var(--bg-secondary); border-radius: 12px; font-size: 0.75rem;">
                                            Phase ${d.phase}
                                        </span>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            // Render Recommendations
            document.getElementById('taxRecommendationsContent').innerHTML = `
                <div style="display: grid; gap: 16px;">
                    <div style="padding: 20px; background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(239, 68, 68, 0.02)); border-radius: 12px; border-left: 4px solid var(--danger);">
                        <div style="display: flex; align-items: flex-start; gap: 12px;">
                            <span style="font-size: 1.5rem;"></span>
                            <div>
                                <h4 style="margin: 0 0 8px; color: var(--danger);">IMMEDIATE: Hire a CPA</h4>
                                <p style="margin: 0; font-size: 0.9rem; color: var(--text-secondary);">
                                    Before LLC formation completes, consult with a CPA experienced with startups. They can advise on:
                                    tax entity election (LLC vs S-Corp vs C-Corp), Ohio-specific requirements, and help set up proper
                                    accounting systems from day one. Cost: $200-500 for initial consultation.
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <div style="padding: 20px; background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(245, 158, 11, 0.02)); border-radius: 12px; border-left: 4px solid var(--warning);">
                        <div style="display: flex; align-items: flex-start; gap: 12px;">
                            <span style="font-size: 1.5rem;"></span>
                            <div>
                                <h4 style="margin: 0 0 8px; color: var(--warning);">Set Up Accounting Software</h4>
                                <p style="margin: 0; font-size: 0.9rem; color: var(--text-secondary);">
                                    Use QuickBooks Online, Xero, or Wave (free) to track all income and expenses from day one.
                                    Categories needed: Software/SaaS, Legal, Professional Services, Marketing, Payroll.
                                    Connect to business bank account for automatic transaction import.
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <div style="padding: 20px; background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(59, 130, 246, 0.02)); border-radius: 12px; border-left: 4px solid var(--info);">
                        <div style="display: flex; align-items: flex-start; gap: 12px;">
                            <span style="font-size: 1.5rem;"></span>
                            <div>
                                <h4 style="margin: 0 0 8px; color: var(--info);">Document Everything NOW</h4>
                                <p style="margin: 0; font-size: 0.9rem; color: var(--text-secondary);">
                                    Even before LLC is formed, keep records of: hours worked by founders, money invested, 
                                    expenses paid (save all receipts), decisions made about equity splits.
                                    This protects you legally and maximizes deductions.
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <div style="padding: 20px; background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(16, 185, 129, 0.02)); border-radius: 12px; border-left: 4px solid var(--success);">
                        <div style="display: flex; align-items: flex-start; gap: 12px;">
                            <span style="font-size: 1.5rem;"></span>
                            <div>
                                <h4 style="margin: 0 0 8px; color: var(--success);">Consider Payroll Service</h4>
                                <p style="margin: 0; font-size: 0.9rem; color: var(--text-secondary);">
                                    For 2 employees, a payroll service like Gusto ($40/mo + $6/employee) handles all withholding,
                                    deposits, and filings automatically. Worth it to avoid penalties from missed deadlines.
                                    Many also offer HR features, benefits administration, and contractor payments.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div style="margin-top: 24px; padding: 20px; background: var(--bg-tertiary); border-radius: 12px;">
                    <h4 style="margin: 0 0 12px;"> Helpful Resources</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
                        <a href="https://www.irs.gov/businesses/small-businesses-self-employed/apply-for-an-employer-identification-number-ein-online" target="_blank" style="padding: 12px; background: var(--bg-secondary); border-radius: 8px; text-decoration: none; color: var(--text-primary); display: flex; align-items: center; gap: 8px;">
                            <span></span> IRS EIN Application
                        </a>
                        <a href="https://tax.ohio.gov/business" target="_blank" style="padding: 12px; background: var(--bg-secondary); border-radius: 8px; text-decoration: none; color: var(--text-primary); display: flex; align-items: center; gap: 8px;">
                            <span></span> Ohio Business Taxes
                        </a>
                        <a href="https://jfs.ohio.gov/unemployment" target="_blank" style="padding: 12px; background: var(--bg-secondary); border-radius: 8px; text-decoration: none; color: var(--text-primary); display: flex; align-items: center; gap: 8px;">
                            <span></span> Ohio Unemployment (SUTA)
                        </a>
                        <a href="https://www.bwc.ohio.gov/" target="_blank" style="padding: 12px; background: var(--bg-secondary); border-radius: 8px; text-decoration: none; color: var(--text-primary); display: flex; align-items: center; gap: 8px;">
                            <span></span> Ohio Workers' Comp
                        </a>
                    </div>
                </div>
            `;
        }
        
        function renderTaxRequirementsList(requirements) {
            return `
                <div style="display: grid; gap: 16px;">
                    ${requirements.map(req => {
                        const isCompleted = taxData.tasksCompleted.includes(req.id);
                        const urgencyColors = {
                            danger: 'var(--danger)',
                            warning: 'var(--warning)',
                            info: 'var(--info)',
                            success: 'var(--success)'
                        };
                        const color = urgencyColors[req.urgency] || 'var(--accent)';
                        
                        return `
                            <div style="padding: 20px; background: ${isCompleted ? 'var(--bg-tertiary)' : `linear-gradient(135deg, ${color}10, ${color}02)`}; border-radius: 12px; border-left: 4px solid ${isCompleted ? 'var(--success)' : color}; opacity: ${isCompleted ? '0.7' : '1'};">
                                <div style="display: flex; align-items: flex-start; gap: 12px;">
                                    <label style="cursor: pointer; display: flex; align-items: center;">
                                        <input type="checkbox" ${isCompleted ? 'checked' : ''} onchange="toggleTaxTask('${req.id}')" 
                                               style="width: 20px; height: 20px; accent-color: var(--success); cursor: pointer;">
                                    </label>
                                    <span style="font-size: 1.5rem;">${req.icon}</span>
                                    <div style="flex: 1;">
                                        <h4 style="margin: 0 0 4px; ${isCompleted ? 'text-decoration: line-through;' : ''}">${req.title}</h4>
                                        <p style="margin: 0 0 12px; font-size: 0.9rem; color: var(--text-secondary);">${req.description}</p>
                                        ${req.deadline ? `<div style="font-size: 0.8rem; color: ${color}; font-weight: 600; margin-bottom: 8px;"> ${req.deadline}</div>` : ''}
                                        <ul style="margin: 0; padding-left: 20px; font-size: 0.85rem; color: var(--text-muted);">
                                            ${req.details.map(d => `<li style="margin-bottom: 4px;">${d}</li>`).join('')}
                                        </ul>
                                    </div>
                                    ${!isCompleted ? `
                                        <span style="padding: 4px 10px; background: ${color}20; color: ${color}; border-radius: 12px; font-size: 0.7rem; text-transform: uppercase; font-weight: 600;">
                                            ${req.urgency === 'danger' ? 'Critical' : req.urgency === 'warning' ? 'Important' : req.urgency === 'success' ? 'Beneficial' : 'Info'}
                                        </span>
                                    ` : `
                                        <span style="padding: 4px 10px; background: var(--success)20; color: var(--success); border-radius: 12px; font-size: 0.7rem; text-transform: uppercase; font-weight: 600;">
                                             Done
                                        </span>
                                    `}
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }
        
        function exportTaxChecklist() {
            loadTaxData();
            
            const checklist = {
                exportDate: new Date().toISOString(),
                company: 'OITH (On In The Hills, LLC)',
                currentPhase: 'Pre-LLC Formation',
                status: {
                    employees: 2,
                    llcStatus: 'Application Pending',
                    einStatus: 'Not Yet Applied'
                },
                phase1_preLLC: [
                    { task: 'Track personal tax implications', completed: taxData.tasksCompleted.includes('p1_1') },
                    { task: 'Prepare for EIN application', completed: taxData.tasksCompleted.includes('p1_2') },
                    { task: 'Document pre-formation expenses', completed: taxData.tasksCompleted.includes('p1_3') },
                    { task: 'Classify worker relationships', completed: taxData.tasksCompleted.includes('p1_4') },
                    { task: 'Choose tax classification for LLC', completed: taxData.tasksCompleted.includes('p1_5') }
                ],
                phase2_postLLC: [
                    { task: 'Obtain EIN', completed: taxData.tasksCompleted.includes('p2_1') },
                    { task: 'Register with Ohio Department of Taxation', completed: taxData.tasksCompleted.includes('p2_2') },
                    { task: 'Ohio Unemployment Tax (SUTA)', completed: taxData.tasksCompleted.includes('p2_3') },
                    { task: 'Federal Unemployment Tax (FUTA)', completed: taxData.tasksCompleted.includes('p2_4') },
                    { task: 'Set up payroll tax withholding', completed: taxData.tasksCompleted.includes('p2_5') },
                    { task: 'Workers\' Compensation Insurance', completed: taxData.tasksCompleted.includes('p2_6') },
                    { task: 'Open business bank account', completed: taxData.tasksCompleted.includes('p2_7') }
                ],
                phase3_revenue: [
                    { task: 'Quarterly estimated tax payments', completed: taxData.tasksCompleted.includes('p3_1') },
                    { task: 'Ohio Commercial Activity Tax (CAT)', completed: taxData.tasksCompleted.includes('p3_2') },
                    { task: 'Sales tax collection (if applicable)', completed: taxData.tasksCompleted.includes('p3_3') },
                    { task: 'Annual LLC Return / K-1s', completed: taxData.tasksCompleted.includes('p3_4') },
                    { task: 'Payroll tax compliance (ongoing)', completed: taxData.tasksCompleted.includes('p3_5') },
                    { task: 'R&D Tax Credit', completed: taxData.tasksCompleted.includes('p3_6') },
                    { task: 'Section 1202 QSBS Exclusion', completed: taxData.tasksCompleted.includes('p3_7') }
                ],
                keyDeadlines: [
                    'Upon LLC Approval: Apply for EIN',
                    'Before 1st Payroll: Register with Ohio & BWC',
                    'January 31: W-2s, 1099s, Form 940',
                    'March 15: Form 1065 Partnership Return',
                    'Quarterly: Form 941, Ohio unemployment, estimated taxes'
                ]
            };
            
            const blob = new Blob([JSON.stringify(checklist, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `oith_tax_checklist_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            showToast(' Tax checklist exported!', 'success');
        }

        // ==========================================
        // DATABASE SCHEMA - DynamoDB Multi-Table Design
        // ==========================================
        
        // Live DynamoDB stats (updated from AWS)
        let dynamoDBStats = {
            connected: false,
            totalItems: 0,
            // User entities
            profiles: 0,
            matches: 0,
            matchHistory: 0,
            likes: 0,
            messages: 0,
            configs: 0,
            subscriptions: 0,
            emergencyContacts: 0,
            settings: 0,
            // Feedback entities
            feedback: 0,
            ratings: 0,
            reports: 0,
            // Activity entities
            activityEvents: 0,
            sessions: 0,
            dailyMetrics: 0,
            // Company entities
            employees: 0,
            departments: 0,
            companyMetrics: 0,
            investors: 0,
            // Document entities
            patentDocs: 0,
            complianceDocs: 0,
            // Table breakdown (multi-table design)
            tables: {
                'oith-profiles': 0,
                'oith-matches': 0,
                'oith-match-history': 0,
                'oith-conversations': 0,
                'oith-notifications': 0,
                'oith-users': 0
            },
            lastSync: null
        };
        
        // DynamoDB Multi-Table Schema Definition
        // Tables split by domain for clarity and scalability
        const dynamoDBSchema = {
            tableName: 'oith-profiles (primary)', // Primary table for display
            region: 'us-east-1',
            tables: [
                { name: 'oith-profiles', purpose: 'Dating user profiles', key: 'email' },
                { name: 'oith-matches', purpose: 'Active match pairings', key: 'matchId' },
                { name: 'oith-match-history', purpose: 'Pass/accept history', key: 'userEmail + matchEmail' },
                { name: 'oith-conversations', purpose: 'Chat messages', key: 'conversationId + timestamp' },
                { name: 'oith-notifications', purpose: 'Push/in-app notifications', key: 'userEmail + notificationId' },
                { name: 'oith-users', purpose: 'Company/admin data', key: 'pk + sk' }
            ],
            keySchema: {
                email: { type: 'String', description: 'User email (partition key for profiles)' }
            },
            entities: [
                {
                    name: 'USER_PROFILE',
                    table: 'oith-profiles',
                    color: '#3B82F6',
                    icon: '',
                    pkPattern: 'email',
                    skPattern: '(none - simple key)',
                    description: 'Dating user profile data',
                    usedBy: ['index.html: signup, login, profile edit', 'matchingService Lambda'],
                    attributes: [
                        { name: 'email', type: 'String', example: 'john@email.com', primary: true },
                        { name: 'firstName', type: 'String', description: 'First name' },
                        { name: 'age', type: 'Number', description: 'User age' },
                        { name: 'gender', type: 'String', description: 'male/female/other' },
                        { name: 'location', type: 'String', description: 'City, State' },
                        { name: 'coordinates', type: 'Map', description: '{lat, lng} for distance calc' },
                        { name: 'occupation', type: 'String', description: 'Job title' },
                        { name: 'bio', type: 'String', description: 'Bio (max 300 chars)' },
                        { name: 'photo', type: 'String', description: 'Primary photo URL' },
                        { name: 'photos', type: 'List', description: 'Array of S3 photo URLs' },
                        { name: 'education', type: 'String', description: 'Education level' },
                        { name: 'height', type: 'String', description: 'Height value' },
                        { name: 'bodyType', type: 'String', description: 'Body type' },
                        { name: 'drinking', type: 'String', description: 'Drinking habits' },
                        { name: 'smoking', type: 'String', description: 'Smoking habits' },
                        { name: 'religion', type: 'String', description: 'Religion' },
                        { name: 'interests', type: 'List', description: 'Array of interests' },
                        { name: 'lookingFor', type: 'String', description: 'Relationship goal' },
                        { name: 'matchPreferences', type: 'Map', description: 'Age/distance/gender prefs' },
                        { name: 'isVisible', type: 'Boolean', description: 'Visible in matching pool' },
                        { name: 'activeMatchEmail', type: 'String', description: 'Current active match' },
                        { name: 'online', type: 'Boolean', description: 'Online status' },
                        { name: 'createdAt', type: 'String', description: 'ISO timestamp' },
                        { name: 'updatedAt', type: 'String', description: 'ISO timestamp' }
                    ]
                },
                {
                    name: 'MATCH',
                    table: 'oith-matches',
                    color: '#EC4899',
                    icon: '',
                    pkPattern: 'matchId',
                    skPattern: '(none)',
                    description: 'Active match between two users',
                    usedBy: ['matchingService Lambda'],
                    attributes: [
                        { name: 'matchId', type: 'String', example: 'user1@email.com_user2@email.com', primary: true },
                        { name: 'userEmail', type: 'String', description: 'User who was shown match' },
                        { name: 'matchEmail', type: 'String', description: 'The potential match' },
                        { name: 'status', type: 'String', description: 'presented/accepted/passed' },
                        { name: 'compatibility', type: 'Number', description: 'Compatibility score 0-100' },
                        { name: 'distance', type: 'Number', description: 'Distance in miles' },
                        { name: 'presentedAt', type: 'String', description: 'When match was shown' },
                        { name: 'acceptedAt', type: 'String', description: 'When user accepted' }
                    ]
                },
                {
                    name: 'MATCH_HISTORY',
                    table: 'oith-match-history',
                    color: '#8B5CF6',
                    icon: '',
                    pkPattern: 'userEmail',
                    skPattern: 'matchEmail',
                    description: 'Historical pass/accept actions',
                    usedBy: ['matchingService Lambda'],
                    attributes: [
                        { name: 'userEmail', type: 'String', primary: true },
                        { name: 'matchEmail', type: 'String', primary: true },
                        { name: 'action', type: 'String', description: 'accept/pass' },
                        { name: 'timestamp', type: 'String', description: 'When action occurred' }
                    ]
                },
                {
                    name: 'CONVERSATION',
                    table: 'oith-conversations',
                    color: '#10B981',
                    icon: '',
                    pkPattern: 'conversationId',
                    skPattern: 'timestamp',
                    description: 'Chat messages between matched users',
                    usedBy: ['index.html: chat'],
                    attributes: [
                        { name: 'conversationId', type: 'String', example: 'user1_user2', primary: true },
                        { name: 'timestamp', type: 'String', primary: true },
                        { name: 'senderEmail', type: 'String', description: 'Message sender' },
                        { name: 'message', type: 'String', description: 'Message content' },
                        { name: 'read', type: 'Boolean', description: 'Read status' }
                    ]
                },
                {
                    name: 'NOTIFICATION',
                    table: 'oith-notifications',
                    color: '#F59E0B',
                    icon: '',
                    pkPattern: 'userEmail',
                    skPattern: 'notificationId',
                    description: 'Push/in-app notifications for offline matching',
                    usedBy: ['index.html: app load', 'matchingService Lambda'],
                    attributes: [
                        { name: 'userEmail', type: 'String', example: 'john@email.com', primary: true },
                        { name: 'notificationId', type: 'String', example: '1734567890_abc123', primary: true },
                        { name: 'type', type: 'String', description: 'mutual_match, new_message, like_received' },
                        { name: 'data', type: 'Map', description: 'Notification context (matchEmail, matchName, etc.)' },
                        { name: 'read', type: 'Boolean', description: 'Has notification been read' },
                        { name: 'createdAt', type: 'String', description: 'ISO timestamp' },
                        { name: 'readAt', type: 'String', description: 'When notification was read' }
                    ]
                },
                {
                    name: 'LIKE',
                    color: '#EC4899',
                    icon: '',
                    pkPattern: 'LIKE#{fromEmail}',
                    skPattern: 'TO#{toEmail}',
                    description: 'User likes another user',
                    usedBy: ['index.html: acceptMatch()'],
                    attributes: [
                        { name: 'pk', type: 'String', example: 'LIKE#john@email.com', primary: true },
                        { name: 'sk', type: 'String', example: 'TO#jane@email.com', primary: true },
                        { name: 'fromEmail', type: 'String', description: 'Liker email' },
                        { name: 'toEmail', type: 'String', description: 'Liked email' },
                        { name: 'createdAt', type: 'String', description: 'ISO timestamp' }
                    ]
                },
                {
                    name: 'MATCH',
                    color: '#EF4444',
                    icon: '',
                    pkPattern: 'MATCH#{email}',
                    skPattern: 'WITH#{matchedEmail}',
                    description: 'Mutual match between two users',
                    usedBy: ['index.html: checkBackgroundMatches(), matchesList'],
                    attributes: [
                        { name: 'pk', type: 'String', example: 'MATCH#john@email.com', primary: true },
                        { name: 'sk', type: 'String', example: 'WITH#jane@email.com', primary: true },
                        { name: 'matchId', type: 'String', description: 'Unique match ID (sorted emails)' },
                        { name: 'matchedAt', type: 'String', description: 'ISO timestamp' }
                    ]
                },
                {
                    name: 'CHAT_MESSAGE',
                    color: '#10B981',
                    icon: '',
                    pkPattern: 'CHAT#{matchId}',
                    skPattern: 'MSG#{timestamp}#{messageId}',
                    description: 'Chat messages between matched users',
                    usedBy: ['index.html: sendMessage(), loadChatFromAWS()'],
                    attributes: [
                        { name: 'pk', type: 'String', example: 'CHAT#jane_john', primary: true },
                        { name: 'sk', type: 'String', example: 'MSG#2024-12-07T...#abc123', primary: true },
                        { name: 'matchId', type: 'String', description: 'Match identifier' },
                        { name: 'fromEmail', type: 'String', description: 'Sender email' },
                        { name: 'message', type: 'String', description: 'Message content (max 1000)' },
                        { name: 'createdAt', type: 'String', description: 'ISO timestamp' }
                    ]
                },
                {
                    name: 'SUBSCRIPTION',
                    color: '#6366F1',
                    icon: '',
                    pkPattern: 'USER#{email}',
                    skPattern: 'SUBSCRIPTION',
                    description: 'User subscription/payment data',
                    usedBy: ['index.html: handlePaymentSuccess()'],
                    attributes: [
                        { name: 'pk', type: 'String', example: 'USER#john@email.com', primary: true },
                        { name: 'sk', type: 'String', example: 'SUBSCRIPTION', primary: true },
                        { name: 'plan', type: 'String', description: 'free/monthly/annual' },
                        { name: 'status', type: 'String', description: 'active/cancelled/expired' },
                        { name: 'startedAt', type: 'String', description: 'Start date' },
                        { name: 'expiresAt', type: 'String', description: 'Expiry date' },
                        { name: 'paymentMethod', type: 'String', description: 'stripe/test' },
                        { name: 'updatedAt', type: 'String', description: 'ISO timestamp' }
                    ]
                },
                {
                    name: 'EMERGENCY_CONTACT',
                    color: '#F59E0B',
                    icon: '',
                    pkPattern: 'USER#{email}',
                    skPattern: 'EMERGENCY_CONTACT',
                    description: 'User emergency contact info',
                    usedBy: ['index.html: saveEmergencyContact()'],
                    attributes: [
                        { name: 'pk', type: 'String', example: 'USER#john@email.com', primary: true },
                        { name: 'sk', type: 'String', example: 'EMERGENCY_CONTACT', primary: true },
                        { name: 'name', type: 'String', description: 'Contact name' },
                        { name: 'phone', type: 'String', description: 'Contact phone' },
                        { name: 'relationship', type: 'String', description: 'Relationship type' },
                        { name: 'updatedAt', type: 'String', description: 'ISO timestamp' }
                    ]
                },
                {
                    name: 'USER_SETTINGS',
                    color: '#8B5CF6',
                    icon: '',
                    pkPattern: 'USER#{email}',
                    skPattern: 'SETTINGS',
                    description: 'User app settings/preferences',
                    usedBy: ['index.html: saveSettings()'],
                    attributes: [
                        { name: 'pk', type: 'String', example: 'USER#john@email.com', primary: true },
                        { name: 'sk', type: 'String', example: 'SETTINGS', primary: true },
                        { name: 'notifications', type: 'Boolean', description: 'Push notifications' },
                        { name: 'emailAlerts', type: 'Boolean', description: 'Email alerts' },
                        { name: 'locationSharing', type: 'Boolean', description: 'Share location' },
                        { name: 'darkMode', type: 'Boolean', description: 'Dark mode enabled' },
                        { name: 'updatedAt', type: 'String', description: 'ISO timestamp' }
                    ]
                },
                {
                    name: 'CONFIG',
                    color: '#14B8A6',
                    icon: '',
                    pkPattern: 'CONFIG',
                    skPattern: 'ML#{type}',
                    description: 'System configuration (ML weights, settings)',
                    usedBy: ['manager.html: ML model weights'],
                    attributes: [
                        { name: 'pk', type: 'String', example: 'CONFIG', primary: true },
                        { name: 'sk', type: 'String', example: 'ML#compatibility_weights', primary: true },
                        { name: 'type', type: 'String', description: 'Config type' },
                        { name: 'settings', type: 'Map', description: 'Config values' },
                        { name: 'updatedBy', type: 'String', description: 'Who updated' },
                        { name: 'updatedAt', type: 'String', description: 'ISO timestamp' }
                    ]
                },
                // ========== USER FEEDBACK ENTITIES ==========
                {
                    name: 'FEEDBACK',
                    color: '#F97316',
                    icon: '',
                    pkPattern: 'FEEDBACK#{feedbackId}',
                    skPattern: 'META',
                    description: 'User feedback, bug reports, feature requests',
                    usedBy: ['index.html: submitFeedback()', 'manager.html: Feedback section'],
                    category: 'feedback',
                    attributes: [
                        { name: 'pk', type: 'String', example: 'FEEDBACK#fb_123abc', primary: true },
                        { name: 'sk', type: 'String', example: 'META', primary: true },
                        { name: 'feedbackId', type: 'String', description: 'Unique feedback ID' },
                        { name: 'userEmail', type: 'String', description: 'Submitter email' },
                        { name: 'type', type: 'String', description: 'bug/feature/general/complaint' },
                        { name: 'category', type: 'String', description: 'matching/chat/profile/payment/other' },
                        { name: 'subject', type: 'String', description: 'Feedback subject' },
                        { name: 'message', type: 'String', description: 'Detailed feedback (max 2000)' },
                        { name: 'rating', type: 'Number', description: 'User rating 1-5 stars' },
                        { name: 'status', type: 'String', description: 'new/reviewed/resolved/archived' },
                        { name: 'priority', type: 'String', description: 'low/medium/high/critical' },
                        { name: 'assignedTo', type: 'String', description: 'Staff member assigned' },
                        { name: 'resolution', type: 'String', description: 'Resolution notes' },
                        { name: 'createdAt', type: 'String', description: 'ISO timestamp' },
                        { name: 'updatedAt', type: 'String', description: 'ISO timestamp' }
                    ]
                },
                {
                    name: 'USER_RATING',
                    color: '#FBBF24',
                    icon: '',
                    pkPattern: 'RATING#{ratedEmail}',
                    skPattern: 'FROM#{raterEmail}',
                    description: 'User-to-user ratings after dates',
                    usedBy: ['index.html: rateDate()', 'manager.html: User reports'],
                    category: 'feedback',
                    attributes: [
                        { name: 'pk', type: 'String', example: 'RATING#jane@email.com', primary: true },
                        { name: 'sk', type: 'String', example: 'FROM#john@email.com', primary: true },
                        { name: 'matchId', type: 'String', description: 'Match context' },
                        { name: 'overallRating', type: 'Number', description: '1-5 stars' },
                        { name: 'safetyRating', type: 'Number', description: 'Safety score 1-5' },
                        { name: 'accuracyRating', type: 'Number', description: 'Profile accuracy 1-5' },
                        { name: 'comment', type: 'String', description: 'Optional comment' },
                        { name: 'wouldMeetAgain', type: 'Boolean', description: 'Would meet again?' },
                        { name: 'reportedIssue', type: 'Boolean', description: 'Flagged for review' },
                        { name: 'createdAt', type: 'String', description: 'ISO timestamp' }
                    ]
                },
                {
                    name: 'REPORT',
                    color: '#EF4444',
                    icon: '',
                    pkPattern: 'REPORT#{reportId}',
                    skPattern: 'META',
                    description: 'User reports for safety/violations',
                    usedBy: ['index.html: reportUser()', 'manager.html: Reports section'],
                    category: 'feedback',
                    attributes: [
                        { name: 'pk', type: 'String', example: 'REPORT#rpt_456def', primary: true },
                        { name: 'sk', type: 'String', example: 'META', primary: true },
                        { name: 'reportId', type: 'String', description: 'Unique report ID' },
                        { name: 'reporterEmail', type: 'String', description: 'Who reported' },
                        { name: 'reportedEmail', type: 'String', description: 'Who was reported' },
                        { name: 'reason', type: 'String', description: 'harassment/spam/fake/inappropriate/safety' },
                        { name: 'description', type: 'String', description: 'Detailed description' },
                        { name: 'evidence', type: 'List', description: 'Screenshot URLs' },
                        { name: 'status', type: 'String', description: 'pending/investigating/resolved/dismissed' },
                        { name: 'action', type: 'String', description: 'warning/suspend/ban/none' },
                        { name: 'reviewedBy', type: 'String', description: 'Admin who reviewed' },
                        { name: 'reviewNotes', type: 'String', description: 'Admin notes' },
                        { name: 'createdAt', type: 'String', description: 'ISO timestamp' },
                        { name: 'resolvedAt', type: 'String', description: 'Resolution timestamp' }
                    ]
                },
                // ========== REAL-TIME ACTIVITY ENTITIES ==========
                {
                    name: 'ACTIVITY_EVENT',
                    color: '#22C55E',
                    icon: '',
                    pkPattern: 'ACTIVITY#{date}',
                    skPattern: 'EVENT#{timestamp}#{eventId}',
                    description: 'Real-time user activity events',
                    usedBy: ['index.html: trackActivity()', 'manager.html: Real-time Activity'],
                    category: 'activity',
                    attributes: [
                        { name: 'pk', type: 'String', example: 'ACTIVITY#2024-12-07', primary: true },
                        { name: 'sk', type: 'String', example: 'EVENT#2024-12-07T10:30:00#evt_789', primary: true },
                        { name: 'eventId', type: 'String', description: 'Unique event ID' },
                        { name: 'userEmail', type: 'String', description: 'User who triggered' },
                        { name: 'eventType', type: 'String', description: 'login/signup/like/match/message/profile_view/date_plan' },
                        { name: 'eventData', type: 'Map', description: 'Event-specific data' },
                        { name: 'screenId', type: 'String', description: 'Screen where event occurred' },
                        { name: 'sessionId', type: 'String', description: 'Session identifier' },
                        { name: 'deviceInfo', type: 'Map', description: 'Browser/device info' },
                        { name: 'ipAddress', type: 'String', description: 'User IP (hashed)' },
                        { name: 'createdAt', type: 'String', description: 'ISO timestamp' }
                    ]
                },
                {
                    name: 'SESSION',
                    color: '#06B6D4',
                    icon: '',
                    pkPattern: 'SESSION#{sessionId}',
                    skPattern: 'META',
                    description: 'User session tracking',
                    usedBy: ['index.html: initSession()', 'manager.html: Active Users'],
                    category: 'activity',
                    attributes: [
                        { name: 'pk', type: 'String', example: 'SESSION#sess_abc123', primary: true },
                        { name: 'sk', type: 'String', example: 'META', primary: true },
                        { name: 'sessionId', type: 'String', description: 'Unique session ID' },
                        { name: 'userEmail', type: 'String', description: 'User email' },
                        { name: 'startedAt', type: 'String', description: 'Session start' },
                        { name: 'lastActiveAt', type: 'String', description: 'Last activity' },
                        { name: 'endedAt', type: 'String', description: 'Session end (if ended)' },
                        { name: 'duration', type: 'Number', description: 'Duration in seconds' },
                        { name: 'screenViews', type: 'Number', description: 'Screens visited count' },
                        { name: 'actions', type: 'Number', description: 'Actions performed' },
                        { name: 'deviceType', type: 'String', description: 'mobile/desktop/tablet' },
                        { name: 'browser', type: 'String', description: 'Browser name' },
                        { name: 'platform', type: 'String', description: 'OS platform' }
                    ]
                },
                {
                    name: 'DAILY_METRICS',
                    color: '#8B5CF6',
                    icon: '',
                    pkPattern: 'METRICS#{date}',
                    skPattern: 'DAILY',
                    description: 'Aggregated daily platform metrics',
                    usedBy: ['manager.html: Dashboard, Analytics'],
                    category: 'activity',
                    attributes: [
                        { name: 'pk', type: 'String', example: 'METRICS#2024-12-07', primary: true },
                        { name: 'sk', type: 'String', example: 'DAILY', primary: true },
                        { name: 'date', type: 'String', description: 'Date YYYY-MM-DD' },
                        { name: 'totalUsers', type: 'Number', description: 'Total registered users' },
                        { name: 'activeUsers', type: 'Number', description: 'DAU' },
                        { name: 'newSignups', type: 'Number', description: 'New registrations' },
                        { name: 'totalMatches', type: 'Number', description: 'Total matches made' },
                        { name: 'totalMessages', type: 'Number', description: 'Messages sent' },
                        { name: 'datesPlanned', type: 'Number', description: 'Dates scheduled' },
                        { name: 'datesCompleted', type: 'Number', description: 'Dates marked complete' },
                        { name: 'revenue', type: 'Number', description: 'Daily revenue $' },
                        { name: 'subscriptions', type: 'Number', description: 'New subscriptions' },
                        { name: 'churnRate', type: 'Number', description: 'Daily churn %' },
                        { name: 'avgSessionDuration', type: 'Number', description: 'Avg session (seconds)' },
                        { name: 'updatedAt', type: 'String', description: 'Last calculated' }
                    ]
                },
                // ========== COMPANY/HIERARCHY ENTITIES ==========
                {
                    name: 'EMPLOYEE',
                    color: '#3B82F6',
                    icon: '',
                    pkPattern: 'ORG#employee',
                    skPattern: 'EMP#{employeeId}',
                    description: 'Company employee records',
                    usedBy: ['manager.html: Hierarchy, Payroll'],
                    category: 'company',
                    attributes: [
                        { name: 'pk', type: 'String', example: 'ORG#employee', primary: true },
                        { name: 'sk', type: 'String', example: 'EMP#emp_001', primary: true },
                        { name: 'employeeId', type: 'String', description: 'Unique employee ID' },
                        { name: 'email', type: 'String', description: 'Work email' },
                        { name: 'firstName', type: 'String', description: 'First name' },
                        { name: 'lastName', type: 'String', description: 'Last name' },
                        { name: 'title', type: 'String', description: 'Job title' },
                        { name: 'departmentId', type: 'String', description: 'Department reference' },
                        { name: 'managerId', type: 'String', description: 'Reports to employee ID' },
                        { name: 'level', type: 'String', description: 'IC1-IC5/M1-M5/E1-E3' },
                        { name: 'startDate', type: 'String', description: 'Hire date' },
                        { name: 'salary', type: 'Number', description: 'Annual salary' },
                        { name: 'equity', type: 'Number', description: 'Stock options/shares' },
                        { name: 'status', type: 'String', description: 'active/onleave/terminated' },
                        { name: 'photoUrl', type: 'String', description: 'Profile photo' },
                        { name: 'location', type: 'String', description: 'Office location' },
                        { name: 'updatedAt', type: 'String', description: 'ISO timestamp' }
                    ]
                },
                {
                    name: 'DEPARTMENT',
                    color: '#6366F1',
                    icon: '',
                    pkPattern: 'ORG#department',
                    skPattern: 'DEPT#{departmentId}',
                    description: 'Company departments/teams',
                    usedBy: ['manager.html: Hierarchy, Org Chart'],
                    category: 'company',
                    attributes: [
                        { name: 'pk', type: 'String', example: 'ORG#department', primary: true },
                        { name: 'sk', type: 'String', example: 'DEPT#dept_eng', primary: true },
                        { name: 'departmentId', type: 'String', description: 'Unique department ID' },
                        { name: 'name', type: 'String', description: 'Department name' },
                        { name: 'description', type: 'String', description: 'Department description' },
                        { name: 'headId', type: 'String', description: 'Department head employee ID' },
                        { name: 'parentDeptId', type: 'String', description: 'Parent department (for sub-teams)' },
                        { name: 'budget', type: 'Number', description: 'Annual budget $' },
                        { name: 'headcount', type: 'Number', description: 'Number of employees' },
                        { name: 'costCenter', type: 'String', description: 'Cost center code' },
                        { name: 'createdAt', type: 'String', description: 'ISO timestamp' },
                        { name: 'updatedAt', type: 'String', description: 'ISO timestamp' }
                    ]
                },
                {
                    name: 'COMPANY_METRICS',
                    color: '#10B981',
                    icon: '',
                    pkPattern: 'ORG#metrics',
                    skPattern: 'PERIOD#{period}',
                    description: 'Company financial/performance metrics',
                    usedBy: ['manager.html: Revenue, Business Analytics'],
                    category: 'company',
                    attributes: [
                        { name: 'pk', type: 'String', example: 'ORG#metrics', primary: true },
                        { name: 'sk', type: 'String', example: 'PERIOD#2024-12', primary: true },
                        { name: 'period', type: 'String', description: 'YYYY-MM or YYYY-Q1, etc.' },
                        { name: 'periodType', type: 'String', description: 'monthly/quarterly/yearly' },
                        { name: 'revenue', type: 'Number', description: 'Total revenue $' },
                        { name: 'mrr', type: 'Number', description: 'Monthly Recurring Revenue $' },
                        { name: 'arr', type: 'Number', description: 'Annual Recurring Revenue $' },
                        { name: 'costs', type: 'Number', description: 'Total costs $' },
                        { name: 'grossMargin', type: 'Number', description: 'Gross margin %' },
                        { name: 'netIncome', type: 'Number', description: 'Net income $' },
                        { name: 'runway', type: 'Number', description: 'Runway in months' },
                        { name: 'burnRate', type: 'Number', description: 'Monthly burn rate $' },
                        { name: 'customerCount', type: 'Number', description: 'Total paying customers' },
                        { name: 'arpu', type: 'Number', description: 'Avg Revenue Per User $' },
                        { name: 'ltv', type: 'Number', description: 'Lifetime Value $' },
                        { name: 'cac', type: 'Number', description: 'Customer Acq Cost $' },
                        { name: 'nps', type: 'Number', description: 'Net Promoter Score' },
                        { name: 'updatedAt', type: 'String', description: 'ISO timestamp' }
                    ]
                },
                {
                    name: 'INVESTOR',
                    color: '#EC4899',
                    icon: '',
                    pkPattern: 'ORG#investor',
                    skPattern: 'INV#{investorId}',
                    description: 'Investor/shareholder records',
                    usedBy: ['manager.html: Cap Table, Investors'],
                    category: 'company',
                    attributes: [
                        { name: 'pk', type: 'String', example: 'ORG#investor', primary: true },
                        { name: 'sk', type: 'String', example: 'INV#inv_001', primary: true },
                        { name: 'investorId', type: 'String', description: 'Unique investor ID' },
                        { name: 'name', type: 'String', description: 'Investor/firm name' },
                        { name: 'type', type: 'String', description: 'vc/angel/strategic/individual' },
                        { name: 'contactEmail', type: 'String', description: 'Primary contact email' },
                        { name: 'contactName', type: 'String', description: 'Primary contact name' },
                        { name: 'investmentAmount', type: 'Number', description: 'Total invested $' },
                        { name: 'shareCount', type: 'Number', description: 'Shares owned' },
                        { name: 'ownershipPercent', type: 'Number', description: 'Ownership %' },
                        { name: 'boardSeat', type: 'Boolean', description: 'Has board seat?' },
                        { name: 'round', type: 'String', description: 'Investment round (seed/A/B)' },
                        { name: 'investedAt', type: 'String', description: 'Investment date' },
                        { name: 'notes', type: 'String', description: 'Additional notes' },
                        { name: 'updatedAt', type: 'String', description: 'ISO timestamp' }
                    ]
                },
                // ========== CRAWLER LOG ENTITY ==========
                {
                    name: 'CRAWLER_LOG',
                    color: '#F59E0B',
                    icon: '',
                    pkPattern: 'CRAWLER#logs',
                    skPattern: 'RUN#{runId}',
                    description: 'Crawler diagnostic run logs',
                    usedBy: ['manager.html: Diagnostics crawler'],
                    category: 'activity',
                    attributes: [
                        { name: 'pk', type: 'String', example: 'CRAWLER#logs', primary: true },
                        { name: 'sk', type: 'String', example: 'RUN#2024-12-07T19:24:14', primary: true },
                        { name: 'runId', type: 'String', description: 'Unique run ID (timestamp)' },
                        { name: 'logs', type: 'List', description: 'Array of log entries' },
                        { name: 'summary', type: 'Map', description: 'OK/Warning/Error counts' },
                        { name: 'options', type: 'Map', description: 'Crawler options used' },
                        { name: 'duration', type: 'Number', description: 'Duration in ms' },
                        { name: 'createdAt', type: 'String', description: 'ISO timestamp' }
                    ]
                },
                // ========== DOCUMENT ENTITIES ==========
                {
                    name: 'PATENT_DOCUMENT',
                    color: '#0EA5E9',
                    icon: '',
                    pkPattern: 'DOC#patent',
                    skPattern: 'PATENT#{patentId}#FILE#{fileId}',
                    description: 'Patent & IP document uploads',
                    usedBy: ['manager.html: Patents & IP section'],
                    category: 'documents',
                    attributes: [
                        { name: 'pk', type: 'String', example: 'DOC#patent', primary: true },
                        { name: 'sk', type: 'String', example: 'PATENT#PA-2024-001#FILE#123', primary: true },
                        { name: 'patentId', type: 'String', description: 'Patent application ID' },
                        { name: 'fileId', type: 'String', description: 'Unique file ID' },
                        { name: 'fileName', type: 'String', description: 'Original file name' },
                        { name: 'fileType', type: 'String', description: 'MIME type' },
                        { name: 'fileSize', type: 'Number', description: 'File size in bytes' },
                        { name: 'fileData', type: 'String', description: 'Base64 encoded file (up to 400KB)' },
                        { name: 's3Key', type: 'String', description: 'S3 key for large files' },
                        { name: 'uploadedBy', type: 'String', description: 'Admin email' },
                        { name: 'uploadedAt', type: 'String', description: 'ISO timestamp' }
                    ]
                },
                {
                    name: 'COMPLIANCE_DOCUMENT',
                    color: '#10B981',
                    icon: '',
                    pkPattern: 'DOC#compliance',
                    skPattern: 'ITEM#{itemId}#FILE#{fileId}',
                    description: 'Legal compliance document uploads',
                    usedBy: ['manager.html: Compliance section'],
                    category: 'documents',
                    attributes: [
                        { name: 'pk', type: 'String', example: 'DOC#compliance', primary: true },
                        { name: 'sk', type: 'String', example: 'ITEM#gdpr#FILE#456', primary: true },
                        { name: 'itemId', type: 'String', description: 'Compliance item ID' },
                        { name: 'fileId', type: 'String', description: 'Unique file ID' },
                        { name: 'fileName', type: 'String', description: 'Original file name' },
                        { name: 'fileType', type: 'String', description: 'MIME type' },
                        { name: 'fileSize', type: 'Number', description: 'File size in bytes' },
                        { name: 'fileData', type: 'String', description: 'Base64 encoded file (up to 400KB)' },
                        { name: 's3Key', type: 'String', description: 'S3 key for large files' },
                        { name: 'uploadedBy', type: 'String', description: 'Admin email' },
                        { name: 'uploadedAt', type: 'String', description: 'ISO timestamp' }
                    ]
                }
            ],
            accessPatterns: [
                // User Data Patterns
                { name: 'Get user profile', query: 'pk = USER#{email}, sk = PROFILE', category: 'user' },
                { name: 'Get all visible profiles', query: 'Scan where sk = PROFILE AND isHidden = false', category: 'user' },
                { name: 'Get user matches', query: 'pk = MATCH#{email}', category: 'user' },
                { name: 'Check mutual like', query: 'pk = LIKE#{B}, sk = TO#{A}', category: 'user' },
                { name: 'Get chat messages', query: 'pk = CHAT#{matchId}, sk begins_with MSG#', category: 'user' },
                { name: 'Get user full data', query: 'pk = USER#{email} (all sk values)', category: 'user' },
                // Feedback Patterns
                { name: 'Get all feedback', query: 'Scan where pk begins_with FEEDBACK#', category: 'feedback' },
                { name: 'Get user ratings', query: 'pk = RATING#{email}', category: 'feedback' },
                { name: 'Get pending reports', query: 'Scan where pk begins_with REPORT# AND status = pending', category: 'feedback' },
                // Activity Patterns
                { name: 'Get daily activity', query: 'pk = ACTIVITY#{date}', category: 'activity' },
                { name: 'Get user sessions', query: 'Scan where pk begins_with SESSION# AND userEmail = X', category: 'activity' },
                { name: 'Get daily metrics', query: 'pk = METRICS#{date}, sk = DAILY', category: 'activity' },
                // Company Patterns
                { name: 'Get all employees', query: 'pk = ORG#employee', category: 'company' },
                { name: 'Get all departments', query: 'pk = ORG#department', category: 'company' },
                { name: 'Get company metrics', query: 'pk = ORG#metrics, sk begins_with PERIOD#', category: 'company' },
                { name: 'Get ML config', query: 'pk = CONFIG, sk = ML#{type}', category: 'config' },
                // Document Patterns
                { name: 'Get patent documents', query: 'pk = DOC#patent, sk begins_with PATENT#{patentId}', category: 'documents' },
                { name: 'Get compliance documents', query: 'pk = DOC#compliance, sk begins_with ITEM#{itemId}', category: 'documents' },
                { name: 'Get all documents by type', query: 'pk = DOC#{type}', category: 'documents' },
                // Crawler Log Patterns
                { name: 'Get all crawler logs', query: 'pk = CRAWLER#logs', category: 'activity' },
                { name: 'Get specific crawler log', query: 'pk = CRAWLER#logs, sk = RUN#{runId}', category: 'activity' }
            ]
        };
        
        // Legacy SQL schema for reference/migration
        const legacySQLSchema = {
            tables: [
                { name: 'users', description: 'Migrated to USER_PROFILE entity' },
                { name: 'profiles', description: 'Merged into USER_PROFILE entity' },
                { name: 'photos', description: 'Stored as photos[] array in USER_PROFILE' },
                { name: 'matches', description: 'Split into LIKE + MATCH entities' },
                { name: 'messages', description: 'Migrated to CHAT_MESSAGE entity' },
                { name: 'subscriptions', description: 'Migrated to SUBSCRIPTION entity' }
            ]
        };
        
        function renderDatabase() {
            // Sync DynamoDB stats
            syncDynamoDBSchema();
            
            // Render DynamoDB Entity Diagram
            renderDynamoDBEntities();
            
            // Render Access Patterns
            renderAccessPatterns();
            
            // Render Table Definitions
            renderTableDefinitions();
            
            // Render Relationships
            renderRelationships();
            
            // Render Data Flow
            renderDataFlow();
        }
        
        // Sync schema stats from DynamoDB
        async function syncDynamoDBSchema() {
            const statusBadge = document.getElementById('dynamoStatusBadge');
            const connectionDot = document.getElementById('dynamoConnectionDot');
            const syncBtn = document.getElementById('syncSchemaBtn');
            
            if (syncBtn) syncBtn.disabled = true;
            if (statusBadge) statusBadge.textContent = 'SYNCING...';
            
            try {
                // Fetch schema stats from AWS
                const response = await fetch(`${AWS_API_URL}/schema/stats`);
                
                if (response.ok) {
                    const data = await response.json();
                    
                    // Populate all stats from API response
                    dynamoDBStats = {
                        connected: true,
                        // User entities
                        profiles: data.profiles || 0,
                        matches: data.matches || 0,
                        matchHistory: data.matchHistory || 0,
                        likes: data.likes || 0,
                        messages: data.messages || 0,
                        configs: data.configs || 0,
                        subscriptions: data.subscriptions || 0,
                        emergencyContacts: data.emergencyContacts || 0,
                        settings: data.settings || 0,
                        // Feedback entities
                        feedback: data.feedback || 0,
                        ratings: data.ratings || 0,
                        reports: data.reports || 0,
                        // Activity entities
                        activityEvents: data.activityEvents || 0,
                        sessions: data.sessions || 0,
                        dailyMetrics: data.dailyMetrics || 0,
                        // Company entities
                        employees: data.employees || 0,
                        departments: data.departments || 0,
                        companyMetrics: data.companyMetrics || 0,
                        investors: data.investors || 0,
                        // Document entities
                        patentDocs: data.patentDocs || 0,
                        complianceDocs: data.complianceDocs || 0,
                        // System entities
                        crawlerLogs: data.crawlerLogs || 0,
                        supportMessages: data.supportMessages || 0,
                        // Table breakdown (multi-table design)
                        tables: data.tables || {
                            'oith-profiles': data.profiles || 0,
                            'oith-matches': data.matches || 0,
                            'oith-match-history': data.matchHistory || 0,
                            'oith-conversations': data.messages || 0,
                            'oith-users': 0
                        },
                        lastSync: new Date().toISOString()
                    };
                    
                    // Calculate totalItems by summing all entity counts
                    dynamoDBStats.totalItems = 
                        dynamoDBStats.profiles + dynamoDBStats.matches + dynamoDBStats.likes + 
                        dynamoDBStats.messages + dynamoDBStats.configs + dynamoDBStats.subscriptions +
                        dynamoDBStats.emergencyContacts + dynamoDBStats.settings +
                        dynamoDBStats.feedback + dynamoDBStats.ratings + dynamoDBStats.reports +
                        dynamoDBStats.activityEvents + dynamoDBStats.sessions + dynamoDBStats.dailyMetrics +
                        dynamoDBStats.employees + dynamoDBStats.departments + dynamoDBStats.companyMetrics + dynamoDBStats.investors +
                        dynamoDBStats.patentDocs + dynamoDBStats.complianceDocs +
                        dynamoDBStats.crawlerLogs + dynamoDBStats.supportMessages;
                    
                    console.log(' DynamoDB stats loaded:', dynamoDBStats);
                } else {
                    // Fallback: try to get basic counts from existing endpoints
                    await fetchBasicDynamoStats();
                }
                
                updateDynamoDBUI();
                
            } catch (error) {
                console.log('Using fallback DynamoDB stats:', error.message);
                await fetchBasicDynamoStats();
                updateDynamoDBUI();
            }
            
            if (syncBtn) syncBtn.disabled = false;
        }
        
        // Fallback: get basic stats from existing endpoints
        async function fetchBasicDynamoStats() {
            try {
                // Get users count
                const usersResponse = await fetch(`${AWS_API_URL}/users`);
                if (usersResponse.ok) {
                    const users = await usersResponse.json();
                    dynamoDBStats.profiles = Object.keys(users).length;
                    dynamoDBStats.connected = true;
                }
                
                // Estimate total items (profiles + estimated other entities)
                dynamoDBStats.totalItems = dynamoDBStats.profiles * 3; // Rough estimate
                dynamoDBStats.lastSync = new Date().toISOString();
                
            } catch (e) {
                dynamoDBStats.connected = false;
            }
        }
        
        // Update DynamoDB UI elements
        function updateDynamoDBUI() {
            const statusBadge = document.getElementById('dynamoStatusBadge');
            const connectionDot = document.getElementById('dynamoConnectionDot');
            
            if (dynamoDBStats.connected) {
                if (statusBadge) {
                    statusBadge.textContent = 'CONNECTED';
                    statusBadge.style.background = 'var(--success)';
                }
                if (connectionDot) {
                    connectionDot.style.background = 'var(--success)';
                    connectionDot.style.animation = 'pulse 2s infinite';
                }
            } else {
                if (statusBadge) {
                    statusBadge.textContent = 'DISCONNECTED';
                    statusBadge.style.background = 'var(--danger)';
                }
                if (connectionDot) {
                    connectionDot.style.background = 'var(--danger)';
                    connectionDot.style.animation = 'none';
                }
            }
            
            // Helper function to update element text
            const updateEl = (id, value) => {
                const el = document.getElementById(id);
                if (el) el.textContent = value ?? '--';
            };
            
            // Update total count
            updateEl('dynamoItemCount', dynamoDBStats.totalItems || '--');
            
            // User data counts
            updateEl('dynamoProfileCount', dynamoDBStats.profiles || '--');
            updateEl('dynamoMatchCount', dynamoDBStats.matches || '--');
            updateEl('dynamoMessageCount', dynamoDBStats.messages || '--');
            updateEl('dynamoLikeCount', dynamoDBStats.likes || '--');
            
            // Feedback counts
            updateEl('dynamoFeedbackCount', dynamoDBStats.feedback || '--');
            updateEl('dynamoRatingCount', dynamoDBStats.ratings || '--');
            updateEl('dynamoReportCount', dynamoDBStats.reports || '--');
            
            // Activity counts
            updateEl('dynamoActivityCount', dynamoDBStats.activityEvents || '--');
            updateEl('dynamoSessionCount', dynamoDBStats.sessions || '--');
            updateEl('dynamoMetricsCount', dynamoDBStats.dailyMetrics || '--');
            
            // Company counts
            updateEl('dynamoEmployeeCount', dynamoDBStats.employees || '--');
            updateEl('dynamoDeptCount', dynamoDBStats.departments || '--');
            updateEl('dynamoCompanyMetricsCount', dynamoDBStats.companyMetrics || '--');
            updateEl('dynamoInvestorCount', dynamoDBStats.investors || '--');
            
            // Document counts
            updateEl('dynamoPatentDocsCount', dynamoDBStats.patentDocs || '--');
            updateEl('dynamoComplianceDocsCount', dynamoDBStats.complianceDocs || '--');
            
            // System counts
            updateEl('dynamoSubscriptionCount', dynamoDBStats.subscriptions || '--');
            updateEl('dynamoConfigCount', dynamoDBStats.configs || '--');
            updateEl('dynamoCrawlerCount', dynamoDBStats.crawlerLogs || '--');
            updateEl('dynamoSupportCount', dynamoDBStats.supportMessages || '--');
        }
        
        // ==========================================
        // DATA PREVIEW FUNCTIONS
        // ==========================================
        let currentPreviewEntity = null;
        let currentPreviewData = [];
        
        async function loadEntityPreview(entityType) {
            const container = document.getElementById('dataPreviewContainer');
            const entityLabel = document.getElementById('previewEntityType');
            const rowCount = document.getElementById('previewRowCount');
            const refreshBtn = document.getElementById('refreshPreviewBtn');
            const exportBtn = document.getElementById('exportPreviewBtn');
            
            // Update active button styling
            document.querySelectorAll('.entity-preview-btn').forEach(btn => {
                btn.style.background = btn.dataset.entity === entityType ? 'var(--accent)' : 'var(--bg-secondary)';
                btn.style.color = btn.dataset.entity === entityType ? 'white' : 'inherit';
            });
            
            currentPreviewEntity = entityType;
            entityLabel.textContent = `Loading ${entityType}...`;
            container.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--text-muted);"><div class="loading-spinner"></div> Loading data from DynamoDB...</div>';
            
            try {
                const response = await fetch(`${AWS_API_URL}/data/preview/${entityType}`);
                
                if (!response.ok) {
                    throw new Error(`Failed to fetch ${entityType} data`);
                }
                
                const data = await response.json();
                currentPreviewData = data.items || [];
                
                // Update UI
                const entityNames = {
                    PROFILE: ' Profiles',
                    MATCH: ' Matches',
                    LIKE: ' Likes',
                    CHAT: ' Messages',
                    SUBSCRIPTION: ' Subscriptions',
                    CONFIG: ' Config',
                    CRAWLER_LOG: ' Crawler Logs',
                    EMPLOYEE: ' Employees',
                    DEPARTMENT: ' Departments',
                    REPORT: ' Reports',
                    SUPPORT: ' Support',
                    FEEDBACK: ' Feedback',
                    RATING: ' Ratings',
                    ACTIVITY: ' Activity Events',
                    SESSION: ' Sessions',
                    METRICS: ' Daily Metrics',
                    COMPANY_METRICS: ' Company Metrics',
                    INVESTOR: ' Investors',
                    PATENT_DOC: ' Patent Docs',
                    COMPLIANCE_DOC: ' Compliance Docs'
                };
                
                entityLabel.textContent = entityNames[entityType] || entityType;
                rowCount.textContent = `${currentPreviewData.length} rows`;
                refreshBtn.disabled = false;
                exportBtn.disabled = currentPreviewData.length === 0;
                
                renderDataPreviewTable(currentPreviewData, entityType);
                
            } catch (error) {
                console.error('Error loading entity preview:', error);
                entityLabel.textContent = `Error loading ${entityType}`;
                container.innerHTML = `
                    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: var(--danger);">
                        <div style="font-size: 1.5rem; margin-bottom: 8px;"></div>
                        <div style="font-size: 0.85rem;">Failed to load data</div>
                        <div style="font-size: 0.7rem; margin-top: 4px; opacity: 0.7;">${error.message}</div>
                    </div>
                `;
                rowCount.textContent = '0 rows';
            }
        }
        
        function refreshDataPreview() {
            if (currentPreviewEntity) {
                loadEntityPreview(currentPreviewEntity);
            }
        }
        
        function renderDataPreviewTable(items, entityType) {
            const container = document.getElementById('dataPreviewContainer');
            
            if (!items || items.length === 0) {
                container.innerHTML = `
                    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: var(--text-muted);">
                        <div style="font-size: 1.5rem; margin-bottom: 8px;"></div>
                        <div style="font-size: 0.85rem;">No ${entityType} records found</div>
                    </div>
                `;
                return;
            }
            
            // Determine columns based on entity type
            const columnConfigs = {
                PROFILE: ['email', 'name', 'age', 'location', 'gender', 'createdAt'],
                MATCH: ['pk', 'sk', 'user1', 'user2', 'matchedAt', 'status'],
                LIKE: ['pk', 'sk', 'fromUser', 'toUser', 'timestamp'],
                CHAT: ['pk', 'sk', 'from', 'to', 'text', 'timestamp'],
                SUBSCRIPTION: ['email', 'plan', 'status', 'startDate', 'endDate'],
                CONFIG: ['sk', 'type', 'updatedAt', 'updatedBy'],
                CRAWLER_LOG: ['source', 'passed', 'failed', 'warnings', 'duration', 'timestamp'],
                EMPLOYEE: ['name', 'title', 'department', 'email', 'status', 'startDate', 'salary'],
                DEPARTMENT: ['id', 'name', 'color', 'updatedAt'],
                REPORT: ['id', 'reportedUser', 'reportedBy', 'reason', 'status', 'createdAt'],
                SUPPORT: ['id', 'userEmail', 'subject', 'status', 'priority', 'createdAt'],
                FEEDBACK: ['pk', 'type', 'message', 'rating', 'createdAt'],
                RATING: ['pk', 'ratedUser', 'ratedBy', 'rating', 'createdAt'],
                ACTIVITY: ['pk', 'event', 'user', 'details', 'timestamp'],
                SESSION: ['pk', 'user', 'device', 'startTime', 'endTime'],
                METRICS: ['pk', 'date', 'activeUsers', 'newUsers', 'matches'],
                COMPANY_METRICS: ['sk', 'metric', 'value', 'period', 'updatedAt'],
                INVESTOR: ['sk', 'name', 'type', 'amount', 'date'],
                PATENT_DOC: ['sk', 'name', 'type', 'status', 'filedDate'],
                COMPLIANCE_DOC: ['sk', 'name', 'type', 'status', 'expiryDate']
            };
            
            // Get columns - use config or infer from first item
            let columns = columnConfigs[entityType];
            if (!columns && items.length > 0) {
                columns = Object.keys(items[0]).filter(k => !k.startsWith('_'));
            }
            
            // Build table HTML
            let html = `
                <table style="width: 100%; border-collapse: collapse; font-size: 0.75rem;">
                    <thead style="position: sticky; top: 0; background: var(--bg-tertiary); z-index: 1;">
                        <tr>
                            ${columns.map(col => `
                                <th style="padding: 8px 12px; text-align: left; border-bottom: 2px solid var(--border); font-weight: 600; color: var(--text-muted); text-transform: uppercase; font-size: 0.65rem; white-space: nowrap;">
                                    ${col}
                                </th>
                            `).join('')}
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            items.forEach((item, index) => {
                html += `<tr style="background: ${index % 2 === 0 ? 'transparent' : 'rgba(255,255,255,0.02)'}; cursor: pointer;" onclick="showItemDetail(${index})" onmouseover="this.style.background='var(--accent-light)'" onmouseout="this.style.background='${index % 2 === 0 ? 'transparent' : 'rgba(255,255,255,0.02)'}'">`
                columns.forEach(col => {
                    let value = item[col];
                    
                    // Format value based on type
                    if (value === undefined || value === null) {
                        value = '<span style="color: var(--text-muted); font-style: italic;">--</span>';
                    } else if (typeof value === 'object') {
                        value = '<span style="color: var(--info);">[Object]</span>';
                    } else if (typeof value === 'boolean') {
                        value = value ? '' : '';
                    } else if (col.toLowerCase().includes('date') || col.toLowerCase().includes('time') || col.toLowerCase().includes('at')) {
                        // Format dates
                        const date = new Date(value);
                        if (!isNaN(date)) {
                            value = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                        }
                    } else if (typeof value === 'string' && value.length > 40) {
                        value = value.substring(0, 40) + '...';
                    }
                    
                    html += `<td style="padding: 8px 12px; border-bottom: 1px solid var(--border); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px;">${value}</td>`;
                });
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }
        
        function showItemDetail(index) {
            const item = currentPreviewData[index];
            if (!item) return;
            
            // Show item detail in a modal
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 10000;';
            modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
            
            const content = document.createElement('div');
            content.style.cssText = 'background: var(--bg-secondary); border-radius: 12px; padding: 24px; max-width: 600px; max-height: 80vh; overflow-y: auto; width: 90%;';
            
            content.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <h3 style="margin: 0;"> Item Detail</h3>
                    <button onclick="closeItemDetailModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-muted); padding: 4px 8px;"></button>
                </div>
                <pre style="background: var(--bg-primary); padding: 16px; border-radius: 8px; overflow-x: auto; font-size: 0.75rem; white-space: pre-wrap; word-break: break-all;">${JSON.stringify(item, null, 2)}</pre>
            `;
            
            modal.id = 'itemDetailModal';
            modal.appendChild(content);
            document.body.appendChild(modal);
            
            // Close on backdrop click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) closeItemDetailModal();
            });
        }
        
        function closeItemDetailModal() {
            const modal = document.getElementById('itemDetailModal');
            if (modal) modal.remove();
        }
        
        function exportPreviewData() {
            if (!currentPreviewData || currentPreviewData.length === 0) return;
            
            // Convert to CSV
            const headers = Object.keys(currentPreviewData[0]);
            let csv = headers.join(',') + '\\n';
            
            currentPreviewData.forEach(item => {
                csv += headers.map(h => {
                    let val = item[h];
                    if (val === null || val === undefined) return '';
                    if (typeof val === 'object') val = JSON.stringify(val);
                    if (typeof val === 'string' && (val.includes(',') || val.includes('"') || val.includes('\\n'))) {
                        val = '"' + val.replace(/"/g, '""') + '"';
                    }
                    return val;
                }).join(',') + '\\n';
            });
            
            // Download
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `oith_${currentPreviewEntity.toLowerCase()}_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
            
            showToast(` Exported ${currentPreviewData.length} ${currentPreviewEntity} records`, 'success');
        }
        
        function renderDynamoDBEntities() {
            const container = document.getElementById('erdDiagram');
            if (!container) return;
            
            // Group entities by category
            const categories = {
                user: { name: ' User Data', color: '#3B82F6', entities: [] },
                feedback: { name: ' User Feedback', color: '#F97316', entities: [] },
                activity: { name: ' Real-time Activity', color: '#22C55E', entities: [] },
                company: { name: ' Company / Hierarchy', color: '#6366F1', entities: [] },
                config: { name: ' Configuration', color: '#14B8A6', entities: [] }
            };
            
            // Sort entities into categories
            dynamoDBSchema.entities.forEach(entity => {
                const cat = entity.category || 'user';
                if (categories[cat]) {
                    categories[cat].entities.push(entity);
                } else if (entity.name === 'CONFIG') {
                    categories.config.entities.push(entity);
                } else {
                    categories.user.entities.push(entity);
                }
            });
            
            // Create visual DynamoDB entity diagram
            container.innerHTML = `
                <div style="margin-bottom: 20px; padding: 16px; background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(245, 158, 11, 0.02)); border-radius: 12px; border: 1px solid rgba(245, 158, 11, 0.3);">
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                        <span style="font-size: 1.5rem;"></span>
                        <div>
                            <div style="font-weight: 600; font-size: 1.1rem;">DynamoDB Multi-Table Design</div>
                            <div style="font-size: 0.8rem; color: var(--text-muted);">Table: <code style="background: var(--bg-tertiary); padding: 2px 6px; border-radius: 4px;">${dynamoDBSchema.tableName}</code> | Region: ${dynamoDBSchema.region} | Entities: ${dynamoDBSchema.entities.length}</div>
                                </div>
                    </div>
                    <div style="display: flex; gap: 16px; flex-wrap: wrap;">
                        <div style="padding: 8px 12px; background: var(--bg-secondary); border-radius: 6px; font-size: 0.8rem;">
                            <span style="color: var(--warning);">pk</span> = Partition Key (String)
                        </div>
                        <div style="padding: 8px 12px; background: var(--bg-secondary); border-radius: 6px; font-size: 0.8rem;">
                            <span style="color: var(--info);">sk</span> = Sort Key (String)
                        </div>
                        <div style="padding: 8px 12px; background: var(--bg-secondary); border-radius: 6px; font-size: 0.8rem;">
                            Composite key: <code>pk + sk</code> = Unique item
                        </div>
                    </div>
                </div>
                
                ${Object.entries(categories).filter(([_, cat]) => cat.entities.length > 0).map(([key, cat]) => `
                    <div style="margin-bottom: 30px;">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px; padding-bottom: 8px; border-bottom: 2px solid ${cat.color};">
                            <span style="font-size: 1.2rem;">${cat.name.split(' ')[0]}</span>
                            <h4 style="margin: 0; color: ${cat.color};">${cat.name.split(' ').slice(1).join(' ')}</h4>
                            <span style="background: ${cat.color}; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.7rem;">${cat.entities.length} ENTITIES</span>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 16px;">
                            ${cat.entities.map(entity => `
                                <div class="db-entity-card" style="background: var(--bg-secondary); border: 2px solid ${entity.color}; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                                    <div style="background: ${entity.color}; padding: 10px 14px; display: flex; align-items: center; justify-content: space-between;">
                                        <div style="display: flex; align-items: center; gap: 8px;">
                                            <span style="font-size: 1.2rem;">${entity.icon}</span>
                                            <span style="font-weight: 600; color: white; letter-spacing: 0.5px; font-size: 0.9rem;">${entity.name}</span>
                                        </div>
                                        <span class="entity-count" data-entity="${entity.name}" style="background: rgba(255,255,255,0.2); padding: 2px 8px; border-radius: 10px; font-size: 0.7rem; color: white;">--</span>
                                    </div>
                                    <div style="padding: 12px;">
                                        <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 8px;">${entity.description}</div>
                                        
                                        <!-- Key Pattern -->
                                        <div style="background: var(--bg-tertiary); padding: 8px; border-radius: 6px; margin-bottom: 10px; font-family: monospace; font-size: 0.72rem;">
                                            <div style="color: var(--warning);">pk: ${entity.pkPattern}</div>
                                            <div style="color: var(--info);">sk: ${entity.skPattern}</div>
                                        </div>
                                        
                                        <!-- Attributes (collapsed by default) -->
                                        <details style="margin-bottom: 8px;">
                                            <summary style="cursor: pointer; font-size: 0.75rem; color: var(--accent); user-select: none;"> ${entity.attributes.length} attributes</summary>
                                            <div style="max-height: 180px; overflow-y: auto; margin-top: 8px;">
                                                ${entity.attributes.map(attr => `
                                                    <div style="display: flex; align-items: center; gap: 6px; padding: 3px 6px; background: ${attr.primary ? 'rgba(245, 158, 11, 0.1)' : 'transparent'}; border-radius: 4px; margin-bottom: 2px; font-size: 0.7rem;">
                                                        ${attr.primary ? '<span style="color: var(--warning);" title="Key Attribute"></span>' : '<span style="width: 14px;"></span>'}
                                                        <span style="font-family: monospace; color: var(--text-primary);">${attr.name}</span>
                                                        <span style="color: var(--accent); font-size: 0.6rem; margin-left: auto;">${attr.type}</span>
                                        </div>
                                    `).join('')}
                                            </div>
                                        </details>
                                        
                                        <!-- Used By -->
                                        ${entity.usedBy ? `
                                            <div style="padding-top: 6px; border-top: 1px solid var(--border);">
                                                <div style="font-size: 0.65rem; color: var(--text-muted);">Used by:</div>
                                                <div style="font-size: 0.68rem; color: var(--info);">${entity.usedBy.join(', ')}</div>
                                            </div>
                                        ` : ''}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    </div>
                `).join('')}
                    
                    <!-- Legend -->
                <div style="display: flex; gap: 24px; justify-content: center; padding: 20px; border-top: 1px solid var(--border); margin-top: 20px; flex-wrap: wrap;">
                        <div style="display: flex; align-items: center; gap: 6px; font-size: 0.8rem;">
                        <span></span> Key Attribute
                        </div>
                        <div style="display: flex; align-items: center; gap: 6px; font-size: 0.8rem;">
                        <div style="width: 12px; height: 12px; background: rgba(245, 158, 11, 0.2); border-radius: 2px;"></div> Key Row
                        </div>
                        <div style="display: flex; align-items: center; gap: 6px; font-size: 0.8rem;">
                        <span style="color: var(--warning);">pk</span> Partition Key
                        </div>
                        <div style="display: flex; align-items: center; gap: 6px; font-size: 0.8rem;">
                        <span style="color: var(--info);">sk</span> Sort Key
                        </div>
                        </div>
            `;
        }
        
        // Render access patterns grouped by category
        function renderAccessPatterns() {
            const container = document.getElementById('accessPatternsContainer');
            if (!container) return;
            
            // Group patterns by category
            const categoryConfig = {
                user: { name: ' User Data', color: '#3B82F6' },
                feedback: { name: ' Feedback', color: '#F97316' },
                activity: { name: ' Activity', color: '#22C55E' },
                company: { name: ' Company', color: '#6366F1' },
                config: { name: ' Config', color: '#14B8A6' }
            };
            
            const grouped = {};
            dynamoDBSchema.accessPatterns.forEach(pattern => {
                const cat = pattern.category || 'user';
                if (!grouped[cat]) grouped[cat] = [];
                grouped[cat].push(pattern);
            });
            
            container.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px;">
                    ${Object.entries(grouped).map(([cat, patterns]) => {
                        const cfg = categoryConfig[cat] || { name: cat, color: 'var(--accent)' };
                        return `
                            <div style="background: var(--bg-tertiary); border-radius: 12px; overflow: hidden; border: 1px solid ${cfg.color};">
                                <div style="background: ${cfg.color}; padding: 10px 14px; color: white; font-weight: 600; font-size: 0.85rem;">
                                    ${cfg.name}
                    </div>
                                <div style="padding: 12px; display: flex; flex-direction: column; gap: 8px;">
                                    ${patterns.map((pattern, idx) => `
                                        <div style="display: flex; align-items: flex-start; gap: 10px; padding: 8px; background: var(--bg-secondary); border-radius: 6px;">
                                            <span style="background: ${cfg.color}; color: white; min-width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.65rem; font-weight: 600;">${idx + 1}</span>
                                            <div style="flex: 1; min-width: 0;">
                                                <div style="font-weight: 500; font-size: 0.8rem; margin-bottom: 4px;">${pattern.name}</div>
                                                <code style="font-size: 0.7rem; color: var(--text-muted); background: var(--bg-tertiary); padding: 2px 6px; border-radius: 4px; display: block; word-break: break-all;">${pattern.query}</code>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }
        
        function renderTableDefinitions() {
            const container = document.getElementById('tableDefinitions');
            if (!container) return;
            
            // Use dynamoDBSchema.entities instead of the old databaseSchema.tables
            container.innerHTML = dynamoDBSchema.entities.map(entity => `
                <div style="border-bottom: 1px solid var(--border);">
                    <div style="display: flex; align-items: center; gap: 12px; padding: 16px 20px; background: var(--bg-tertiary); cursor: pointer;" onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'block' : 'none'">
                        <span style="font-size: 1.2rem;">${entity.icon}</span>
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: ${entity.color};">${entity.name}</div>
                            <div style="font-size: 0.75rem; color: var(--text-muted);">${entity.description}  ${entity.attributes.length} attributes</div>
                        </div>
                        <div style="font-size: 0.65rem; color: var(--text-muted); font-family: monospace; margin-right: 12px;">
                            pk: ${entity.pkPattern}
                        </div>
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: var(--text-muted);">
                            <polyline points="6 9 12 15 18 9"/>
                        </svg>
                    </div>
                    <div style="display: none;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 0.85rem;">
                            <thead>
                                <tr style="background: var(--bg-primary);">
                                    <th style="padding: 10px 16px; text-align: left; color: var(--text-muted); font-weight: 500;">Attribute</th>
                                    <th style="padding: 10px 16px; text-align: left; color: var(--text-muted); font-weight: 500;">Type</th>
                                    <th style="padding: 10px 16px; text-align: left; color: var(--text-muted); font-weight: 500;">Key</th>
                                    <th style="padding: 10px 16px; text-align: left; color: var(--text-muted); font-weight: 500;">Description</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${entity.attributes.map(attr => `
                                    <tr style="border-bottom: 1px solid var(--border);">
                                        <td style="padding: 10px 16px; font-family: monospace; color: var(--text-primary);">
                                            ${attr.primary ? ' ' : ''}${attr.name}
                                        </td>
                                        <td style="padding: 10px 16px; color: var(--info); font-family: monospace; font-size: 0.8rem;">${attr.type}</td>
                                        <td style="padding: 10px 16px;">
                                            ${attr.primary ? '<span style="background: rgba(245, 158, 11, 0.2); color: var(--warning); padding: 2px 6px; border-radius: 4px; font-size: 0.7rem;">KEY</span>' : ''}
                                        </td>
                                        <td style="padding: 10px 16px; color: var(--text-muted);">${attr.description || attr.example || ''}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `).join('');
        }
        
        function renderRelationships() {
            const container = document.getElementById('relationshipsDetail');
            if (!container) return;
            
            // DynamoDB single-table design relationships
            const relationships = [
                { from: 'USER_PROFILE', to: 'SUBSCRIPTION', type: 'has one', link: 'pk = USER#{email}' },
                { from: 'USER_PROFILE', to: 'EMERGENCY_CONTACT', type: 'has one', link: 'pk = USER#{email}' },
                { from: 'USER_PROFILE', to: 'USER_SETTINGS', type: 'has one', link: 'pk = USER#{email}' },
                { from: 'USER_PROFILE', to: 'LIKE', type: 'creates many', link: 'LIKE#{email}  TO#{other}' },
                { from: 'LIKE', to: 'MATCH', type: 'mutual creates', link: 'if AB and BA' },
                { from: 'MATCH', to: 'CHAT_MESSAGE', type: 'has many', link: 'CHAT#{matchId}' },
                { from: 'USER_PROFILE', to: 'FEEDBACK', type: 'submits', link: 'userEmail field' },
                { from: 'USER_PROFILE', to: 'USER_RATING', type: 'receives', link: 'RATING#{email}' },
                { from: 'EMPLOYEE', to: 'DEPARTMENT', type: 'belongs to', link: 'departmentId field' },
                { from: 'ACTIVITY_EVENT', to: 'SESSION', type: 'grouped by', link: 'sessionId field' }
            ];
            
            container.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 16px;">
                    ${relationships.map(rel => {
                        const fromEntity = dynamoDBSchema.entities.find(e => e.name === rel.from);
                        const toEntity = dynamoDBSchema.entities.find(e => e.name === rel.to);
                        return `
                            <div style="display: flex; align-items: center; gap: 12px; padding: 16px; background: var(--bg-tertiary); border-radius: 8px;">
                                <div style="text-align: center; min-width: 80px;">
                                    <div style="font-size: 1.5rem;">${fromEntity?.icon || ''}</div>
                                    <div style="font-size: 0.75rem; font-weight: 500; color: ${fromEntity?.color || 'var(--text-primary)'}">${rel.from}</div>
                                </div>
                                <div style="flex: 1; text-align: center;">
                                    <div style="font-size: 0.7rem; color: var(--text-muted); margin-bottom: 4px;">${rel.type}</div>
                                    <div style="display: flex; align-items: center; justify-content: center; gap: 4px;">
                                        <div style="height: 2px; width: 30px; background: var(--border);"></div>
                                        <span style="font-size: 1rem;"></span>
                                        <div style="height: 2px; width: 30px; background: var(--border);"></div>
                                    </div>
                                    <div style="font-size: 0.65rem; color: var(--purple); font-family: monospace; margin-top: 4px;">${rel.link}</div>
                                </div>
                                <div style="text-align: center; min-width: 80px;">
                                    <div style="font-size: 1.5rem;">${toEntity?.icon || ''}</div>
                                    <div style="font-size: 0.75rem; font-weight: 500; color: ${toEntity?.color || 'var(--text-primary)'}">${rel.to}</div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }
        
        function renderDataFlow() {
            const container = document.getElementById('dataFlowDiagram');
            
            container.innerHTML = `
                <div style="text-align: center; padding: 20px;">
                    <div style="display: flex; justify-content: center; align-items: center; gap: 20px; flex-wrap: wrap;">
                        <!-- User Registration Flow -->
                        <div style="display: flex; align-items: center; gap: 12px; padding: 16px 24px; background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(168, 85, 247, 0.1)); border-radius: 12px;">
                            <div style="text-align: center;">
                                <div style="font-size: 2rem;"></div>
                                <div style="font-size: 0.7rem; color: var(--text-muted);">App</div>
                            </div>
                            <span style="color: var(--text-muted);"></span>
                            <div style="text-align: center;">
                                <div style="font-size: 2rem;"></div>
                                <div style="font-size: 0.7rem; color: var(--text-muted);">Register</div>
                            </div>
                            <span style="color: var(--text-muted);"></span>
                            <div style="text-align: center;">
                                <div style="font-size: 2rem;"></div>
                                <div style="font-size: 0.7rem; color: var(--text-muted);">Profile</div>
                            </div>
                            <span style="color: var(--text-muted);"></span>
                            <div style="text-align: center;">
                                <div style="font-size: 2rem;"></div>
                                <div style="font-size: 0.7rem; color: var(--text-muted);">Photos</div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin: 24px 0; color: var(--text-muted);"></div>
                    
                    <div style="display: flex; justify-content: center; align-items: center; gap: 20px; flex-wrap: wrap;">
                        <!-- Matching Flow -->
                        <div style="display: flex; align-items: center; gap: 12px; padding: 16px 24px; background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(245, 158, 11, 0.1)); border-radius: 12px;">
                            <div style="text-align: center;">
                                <div style="font-size: 2rem;"></div>
                                <div style="font-size: 0.7rem; color: var(--text-muted);">AI Match</div>
                            </div>
                            <span style="color: var(--text-muted);"></span>
                            <div style="text-align: center;">
                                <div style="font-size: 2rem;"></div>
                                <div style="font-size: 0.7rem; color: var(--text-muted);">Match</div>
                            </div>
                            <span style="color: var(--text-muted);"></span>
                            <div style="text-align: center;">
                                <div style="font-size: 2rem;"></div>
                                <div style="font-size: 0.7rem; color: var(--text-muted);">Accept</div>
                            </div>
                            <span style="color: var(--text-muted);"></span>
                            <div style="text-align: center;">
                                <div style="font-size: 2rem;"></div>
                                <div style="font-size: 0.7rem; color: var(--text-muted);">Chat</div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin: 24px 0; color: var(--text-muted);"></div>
                    
                    <div style="display: flex; justify-content: center; align-items: center; gap: 20px; flex-wrap: wrap;">
                        <!-- Date Flow -->
                        <div style="display: flex; align-items: center; gap: 12px; padding: 16px 24px; background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(99, 102, 241, 0.1)); border-radius: 12px;">
                            <div style="text-align: center;">
                                <div style="font-size: 2rem;"></div>
                                <div style="font-size: 0.7rem; color: var(--text-muted);">Plan Date</div>
                            </div>
                            <span style="color: var(--text-muted);"></span>
                            <div style="text-align: center;">
                                <div style="font-size: 2rem;"></div>
                                <div style="font-size: 0.7rem; color: var(--text-muted);">Venue</div>
                            </div>
                            <span style="color: var(--text-muted);"></span>
                            <div style="text-align: center;">
                                <div style="font-size: 2rem;"></div>
                                <div style="font-size: 0.7rem; color: var(--text-muted);">Meet!</div>
                            </div>
                            <span style="color: var(--text-muted);"></span>
                            <div style="text-align: center;">
                                <div style="font-size: 2rem;"></div>
                                <div style="font-size: 0.7rem; color: var(--text-muted);">Feedback</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- SQL Schema Preview -->
                <div style="margin-top: 24px; padding: 16px; background: var(--bg-primary); border-radius: 8px; border: 1px solid var(--border);">
                    <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 8px;"> Sample SQL Schema (users table)</div>
                    <pre style="font-size: 0.75rem; color: var(--success); overflow-x: auto; font-family: 'Monaco', 'Menlo', monospace;">CREATE TABLE users (
    user_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    email VARCHAR(255) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    first_name VARCHAR(100),
    last_name VARCHAR(100),
    birthday DATE,
    age INT GENERATED ALWAYS AS (EXTRACT(YEAR FROM age(birthday))) STORED,
    gender ENUM('male', 'female', 'other'),
    location VARCHAR(255),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    last_login TIMESTAMP,
    is_active BOOLEAN DEFAULT true,
    profile_complete BOOLEAN DEFAULT false
);</pre>
                </div>
            `;
        }
        
        function exportDatabaseSchema() {
            // Generate DynamoDB schema documentation
            let doc = '# OITH DynamoDB Schema\n';
            doc += '# Generated: ' + new Date().toISOString() + '\n';
            doc += '# Table: ' + dynamoDBSchema.tableName + '\n';
            doc += '# Region: ' + dynamoDBSchema.region + '\n\n';
            doc += '## Multi-Table Design\n';
            doc += 'Primary Key: pk (String) + sk (String)\n\n';
            
            // Group entities by category
            const categories = {};
            dynamoDBSchema.entities.forEach(entity => {
                const cat = entity.category || 'user';
                if (!categories[cat]) categories[cat] = [];
                categories[cat].push(entity);
            });
            
            Object.entries(categories).forEach(([cat, entities]) => {
                doc += `\n## ${cat.toUpperCase()} ENTITIES\n`;
                doc += '=' .repeat(50) + '\n\n';
                
                entities.forEach(entity => {
                    doc += `### ${entity.icon} ${entity.name}\n`;
                    doc += `${entity.description}\n\n`;
                    doc += `pk pattern: ${entity.pkPattern}\n`;
                    doc += `sk pattern: ${entity.skPattern}\n\n`;
                    doc += 'Attributes:\n';
                    entity.attributes.forEach(attr => {
                        doc += `  - ${attr.name} (${attr.type})${attr.primary ? ' [KEY]' : ''}: ${attr.description || ''}\n`;
                    });
                    doc += '\n';
                });
            });
            
            // Add access patterns
            doc += '\n## ACCESS PATTERNS\n';
            doc += '=' .repeat(50) + '\n\n';
            dynamoDBSchema.accessPatterns.forEach((pattern, i) => {
                doc += `${i + 1}. ${pattern.name}\n`;
                doc += `   Query: ${pattern.query}\n`;
                doc += `   Category: ${pattern.category || 'user'}\n\n`;
            });
            
            const blob = new Blob([doc], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'oith_dynamodb_schema.md';
            a.click();
            URL.revokeObjectURL(url);
            showToast(' DynamoDB schema exported!');
        }

        // ==========================================
        // SERVER CONNECTION MANAGEMENT
        // ==========================================
        
        // Server connection state
        let serverConnection = JSON.parse(localStorage.getItem('oith_server_connection') || 'null') || {
            type: 'localStorage',
            name: 'localStorage (Browser)',
            description: 'Development Mode - Client-Side Storage',
            host: 'local',
            connected: true,
            connectedAt: new Date().toISOString()
        };
        
        // Available server configurations
        const availableServers = [
            {
                id: 'localStorage',
                name: 'localStorage (Browser)',
                type: 'local',
                description: 'Client-side browser storage for development',
                icon: '',
                color: 'var(--info)',
                isDefault: true
            },
            {
                id: 'postgresql',
                name: 'PostgreSQL',
                type: 'sql',
                description: 'Relational database for production',
                icon: '',
                color: '#336791'
            },
            {
                id: 'mongodb',
                name: 'MongoDB Atlas',
                type: 'nosql',
                description: 'Cloud NoSQL database for scalability',
                icon: '',
                color: '#4DB33D'
            },
            {
                id: 'firebase',
                name: 'Firebase Firestore',
                type: 'nosql',
                description: 'Google Cloud real-time database',
                icon: '',
                color: '#FFCA28'
            },
            {
                id: 'supabase',
                name: 'Supabase',
                type: 'sql',
                description: 'Open source Firebase alternative',
                icon: '',
                color: '#3ECF8E'
            },
            {
                id: 'aws-rds',
                name: 'AWS RDS',
                type: 'sql',
                description: 'Amazon managed database service',
                icon: '',
                color: '#FF9900'
            },
            {
                id: 'custom',
                name: 'Custom Server',
                type: 'custom',
                description: 'Connect to your own database server',
                icon: '',
                color: 'var(--purple)'
            }
        ];
        
        // Initialize server connection UI
        function initServerConnection() {
            updateServerConnectionUI();
            renderAvailableServers();
            calculateStorageUsed();
            updateDataTransferStats();
        }
        
        // ==========================================
        // Data Transfer Functions (Export/Import)
        // ==========================================
        
        // Update data transfer stats
        function updateDataTransferStats() {
            const registeredUsers = JSON.parse(localStorage.getItem('oith_registered_users') || '{}');
            const testBots = JSON.parse(localStorage.getItem('oith_test_bots') || '[]');
            
            let keyCount = 0;
            let totalSize = 0;
            
            for (let key in localStorage) {
                if (localStorage.hasOwnProperty(key) && key.startsWith('oith_')) {
                    keyCount++;
                    totalSize += localStorage[key].length * 2;
                }
            }
            
            const userCountEl = document.getElementById('exportUserCount');
            const botCountEl = document.getElementById('exportBotCount');
            const keyCountEl = document.getElementById('exportKeyCount');
            const dataSizeEl = document.getElementById('exportDataSize');
            
            if (userCountEl) userCountEl.textContent = Object.keys(registeredUsers).length;
            if (botCountEl) botCountEl.textContent = testBots.filter(b => b.active).length;
            if (keyCountEl) keyCountEl.textContent = keyCount;
            if (dataSizeEl) dataSizeEl.textContent = (totalSize / 1024).toFixed(1) + ' KB';
        }
        
        // Export all OITH data as JSON
        function exportAllData() {
            const exportData = {
                version: '1.0',
                exportedAt: new Date().toISOString(),
                source: window.location.hostname,
                exportedFrom: 'admin_dashboard',
                data: {}
            };
            
            // Export all OITH-related localStorage items
            for (let key in localStorage) {
                if (key.startsWith('oith_')) {
                    try {
                        exportData.data[key] = JSON.parse(localStorage.getItem(key));
                    } catch (e) {
                        exportData.data[key] = localStorage.getItem(key);
                    }
                }
            }
            
            // Create and download the file
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `oith_backup_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showToast(' Data exported successfully!');
        }
        
        // Trigger file input for importing
        function triggerImportData() {
            document.getElementById('importDataFile').click();
        }
        
        // Import data from file
        function importDataFromFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importData = JSON.parse(e.target.result);
                    
                    // Validate import format
                    if (!importData.data || typeof importData.data !== 'object') {
                        showToast(' Invalid backup file format');
                        return;
                    }
                    
                    // Show confirmation
                    const itemCount = Object.keys(importData.data).length;
                    const sourceInfo = importData.source ? ` from ${importData.source}` : '';
                    const exportDate = importData.exportedAt ? new Date(importData.exportedAt).toLocaleDateString() : 'unknown date';
                    
                    if (!confirm(`Import ${itemCount} data items${sourceInfo}?\n\nExported on: ${exportDate}\n\nThis will overwrite any existing data with matching keys.`)) {
                        event.target.value = '';
                        return;
                    }
                    
                    // Import all data
                    let importedCount = 0;
                    for (let key in importData.data) {
                        const value = importData.data[key];
                        localStorage.setItem(key, typeof value === 'string' ? value : JSON.stringify(value));
                        importedCount++;
                    }
                    
                    showToast(` Successfully imported ${importedCount} items!`);
                    
                    // Reset file input
                    event.target.value = '';
                    
                    // Refresh the page data
                    setTimeout(() => {
                        loadAllData();
                        renderUsers();
                        updateDataTransferStats();
                    }, 500);
                    
                } catch (err) {
                    console.error('Import error:', err);
                    showToast(' Failed to import: ' + err.message);
                }
            };
            
            reader.readAsText(file);
        }
        
        // Calculate localStorage usage
        function calculateStorageUsed() {
            let total = 0;
            for (let key in localStorage) {
                if (localStorage.hasOwnProperty(key)) {
                    total += localStorage[key].length * 2; // UTF-16 chars = 2 bytes each
                }
            }
            const kb = (total / 1024).toFixed(2);
            document.getElementById('storageUsed').textContent = kb + ' KB';
        }
        
        // Update UI based on current connection
        function updateServerConnectionUI() {
            const badge = document.getElementById('serverStatusBadge');
            const serverName = document.getElementById('currentServerName');
            const serverType = document.getElementById('currentServerType');
            const disconnectBtn = document.getElementById('disconnectBtn');
            
            if (serverConnection.connected) {
                badge.style.background = 'var(--success)';
                badge.textContent = 'CONNECTED';
                serverName.textContent = serverConnection.name;
                serverType.textContent = serverConnection.description;
                
                // Only allow disconnect if not localStorage
                disconnectBtn.disabled = serverConnection.type === 'localStorage';
            } else {
                badge.style.background = 'var(--danger)';
                badge.textContent = 'DISCONNECTED';
                serverName.textContent = 'No server connected';
                serverType.textContent = 'Please connect to a server';
                disconnectBtn.disabled = true;
            }
        }
        
        // Render list of available servers
        function renderAvailableServers() {
            const container = document.getElementById('availableServersList');
            
            container.innerHTML = availableServers.map(server => {
                const isActive = serverConnection.type === server.id || 
                                (serverConnection.type === 'localStorage' && server.id === 'localStorage');
                
                return `
                    <div style="display: flex; align-items: center; gap: 10px; padding: 10px; background: var(--bg-secondary); border-radius: 8px; border: 1px solid ${isActive ? server.color : 'transparent'}; cursor: pointer; transition: all 0.2s;" 
                         onclick="${isActive ? '' : 'showConnectServerModal(\'' + server.id + '\')'}">
                        <span style="font-size: 1.3rem;">${server.icon}</span>
                        <div style="flex: 1;">
                            <div style="font-weight: 500; font-size: 0.85rem; color: ${server.color};">${server.name}</div>
                            <div style="font-size: 0.7rem; color: var(--text-muted);">${server.description}</div>
                        </div>
                        ${isActive ? '<span style="font-size: 0.7rem; background: var(--success); color: white; padding: 2px 8px; border-radius: 10px;">ACTIVE</span>' : ''}
                    </div>
                `;
            }).join('');
        }
        
        // Show connect server modal
        function showConnectServerModal(serverId = null) {
            const server = serverId ? availableServers.find(s => s.id === serverId) : null;
            
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.id = 'connectServerModal';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 500px;">
                    <button class="modal-close" onclick="closeConnectServerModal()">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="18" y1="6" x2="6" y2="18"/>
                            <line x1="6" y1="6" x2="18" y2="18"/>
                        </svg>
                    </button>
                    
                    <h3 style="margin-bottom: 8px;"> Connect to Server</h3>
                    <p style="color: var(--text-muted); margin-bottom: 24px;">Configure your database connection for ${server?.name || 'a new server'}</p>
                    
                    <form id="serverConnectionForm" onsubmit="connectToServer(event)">
                        <div class="form-group">
                            <label class="form-label">Server Type</label>
                            <select id="serverType" class="form-control" onchange="updateServerFields()" required>
                                ${availableServers.filter(s => s.id !== 'localStorage').map(s => `
                                    <option value="${s.id}" ${server?.id === s.id ? 'selected' : ''}>${s.icon} ${s.name}</option>
                                `).join('')}
                            </select>
                        </div>
                        
                        <div id="serverFields">
                            <!-- Dynamic fields based on server type -->
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Connection Name (optional)</label>
                            <input type="text" id="connectionName" class="form-control" placeholder="e.g., Production DB">
                        </div>
                        
                        <div style="display: flex; gap: 12px; margin-top: 24px;">
                            <button type="button" class="btn btn-secondary" onclick="testConnection()" style="flex: 1;">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M22 11.08V12a10 10 0 11-5.93-9.14"/>
                                    <polyline points="22 4 12 14.01 9 11.01"/>
                                </svg>
                                Test Connection
                            </button>
                            <button type="submit" class="btn btn-primary" style="flex: 1;">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M12 5v14M5 12h14"/>
                                </svg>
                                Connect
                            </button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
            updateServerFields();
        }
        
        // Update form fields based on selected server type
        function updateServerFields() {
            const serverType = document.getElementById('serverType').value;
            const container = document.getElementById('serverFields');
            
            let fields = '';
            
            if (['postgresql', 'aws-rds', 'supabase'].includes(serverType)) {
                fields = `
                    <div class="form-group">
                        <label class="form-label">Host</label>
                        <input type="text" id="dbHost" class="form-control" placeholder="e.g., db.example.com" required>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                        <div class="form-group">
                            <label class="form-label">Port</label>
                            <input type="number" id="dbPort" class="form-control" placeholder="5432" value="5432">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Database Name</label>
                            <input type="text" id="dbName" class="form-control" placeholder="oith_production" required>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                        <div class="form-group">
                            <label class="form-label">Username</label>
                            <input type="text" id="dbUser" class="form-control" placeholder="db_user" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Password</label>
                            <input type="password" id="dbPassword" class="form-control" placeholder="" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">
                            <input type="checkbox" id="dbSSL" checked> Use SSL Connection
                        </label>
                    </div>
                `;
            } else if (['mongodb', 'firebase'].includes(serverType)) {
                fields = `
                    <div class="form-group">
                        <label class="form-label">Connection String / URI</label>
                        <input type="text" id="connectionString" class="form-control" 
                               placeholder="${serverType === 'mongodb' ? 'mongodb+srv://user:pass@cluster.mongodb.net/dbname' : 'https://project-id.firebaseio.com'}" required>
                    </div>
                    ${serverType === 'firebase' ? `
                        <div class="form-group">
                            <label class="form-label">API Key</label>
                            <input type="password" id="apiKey" class="form-control" placeholder="Your Firebase API key" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Project ID</label>
                            <input type="text" id="projectId" class="form-control" placeholder="your-project-id" required>
                        </div>
                    ` : ''}
                `;
            } else if (serverType === 'custom') {
                fields = `
                    <div class="form-group">
                        <label class="form-label">API Endpoint URL</label>
                        <input type="url" id="apiEndpoint" class="form-control" placeholder="https://api.yourserver.com/v1" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">API Key / Token</label>
                        <input type="password" id="apiToken" class="form-control" placeholder="Your API key or bearer token">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Headers (JSON format)</label>
                        <textarea id="customHeaders" class="form-control" rows="3" placeholder='{"Authorization": "Bearer token"}'></textarea>
                    </div>
                `;
            }
            
            container.innerHTML = fields;
        }
        
        // Test database connection
        function testConnection() {
            const serverType = document.getElementById('serverType').value;
            
            // Show testing message
            showToast(' Testing connection...', 'info');
            
            // Simulate connection test
            setTimeout(() => {
                // In production, this would actually test the connection
                const success = Math.random() > 0.2; // 80% success for demo
                
                if (success) {
                    showToast(' Connection successful! Server is reachable.', 'success');
                } else {
                    showToast(' Connection failed. Please check your credentials.', 'error');
                }
            }, 1500);
        }
        
        // Connect to server
        function connectToServer(event) {
            event.preventDefault();
            
            const serverType = document.getElementById('serverType').value;
            const server = availableServers.find(s => s.id === serverType);
            const customName = document.getElementById('connectionName').value;
            
            // Gather connection details based on server type
            let connectionDetails = {};
            
            if (['postgresql', 'aws-rds', 'supabase'].includes(serverType)) {
                connectionDetails = {
                    host: document.getElementById('dbHost').value,
                    port: document.getElementById('dbPort').value,
                    database: document.getElementById('dbName').value,
                    user: document.getElementById('dbUser').value,
                    password: '***hidden***', // Don't store plain password
                    ssl: document.getElementById('dbSSL').checked
                };
            } else if (['mongodb', 'firebase'].includes(serverType)) {
                connectionDetails = {
                    connectionString: document.getElementById('connectionString').value.replace(/:[^:@]+@/, ':***@'), // Hide password
                    apiKey: '***hidden***'
                };
            } else if (serverType === 'custom') {
                connectionDetails = {
                    endpoint: document.getElementById('apiEndpoint').value
                };
            }
            
            // Update server connection state
            serverConnection = {
                type: serverType,
                name: customName || server.name,
                description: server.description,
                host: connectionDetails.host || connectionDetails.endpoint || 'cloud',
                connected: true,
                connectedAt: new Date().toISOString(),
                details: connectionDetails
            };
            
            // Save to localStorage
            localStorage.setItem('oith_server_connection', JSON.stringify(serverConnection));
            
            // Update UI
            updateServerConnectionUI();
            renderAvailableServers();
            
            // Close modal
            closeConnectServerModal();
            
            showToast(` Connected to ${serverConnection.name}!`, 'success');
        }
        
        // Close connect server modal
        function closeConnectServerModal() {
            const modal = document.getElementById('connectServerModal');
            if (modal) modal.remove();
        }
        
        // Show migrate data modal
        function showMigrateDataModal() {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.id = 'migrateDataModal';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 500px;">
                    <button class="modal-close" onclick="closeMigrateDataModal()">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="18" y1="6" x2="6" y2="18"/>
                            <line x1="6" y1="6" x2="18" y2="18"/>
                        </svg>
                    </button>
                    
                    <h3 style="margin-bottom: 8px;"> Migrate Data</h3>
                    <p style="color: var(--text-muted); margin-bottom: 24px;">Transfer your data to a new server for scaling</p>
                    
                    <div style="padding: 16px; background: var(--bg-tertiary); border-radius: 12px; margin-bottom: 20px;">
                        <div style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 8px;">CURRENT DATA</div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                            <div style="padding: 12px; background: var(--bg-secondary); border-radius: 8px; text-align: center;">
                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--info);" id="migrateUserCount">0</div>
                                <div style="font-size: 0.75rem; color: var(--text-muted);">Users</div>
                            </div>
                            <div style="padding: 12px; background: var(--bg-secondary); border-radius: 8px; text-align: center;">
                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--success);" id="migrateMatchCount">0</div>
                                <div style="font-size: 0.75rem; color: var(--text-muted);">Matches</div>
                            </div>
                            <div style="padding: 12px; background: var(--bg-secondary); border-radius: 8px; text-align: center;">
                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--purple);" id="migrateRecordCount">0</div>
                                <div style="font-size: 0.75rem; color: var(--text-muted);">Total Records</div>
                            </div>
                            <div style="padding: 12px; background: var(--bg-secondary); border-radius: 8px; text-align: center;">
                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--warning);" id="migrateDataSize">0 KB</div>
                                <div style="font-size: 0.75rem; color: var(--text-muted);">Data Size</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Target Server</label>
                        <select id="migrateTargetServer" class="form-control" required>
                            <option value="">Select a server...</option>
                            ${availableServers.filter(s => s.id !== 'localStorage').map(s => `
                                <option value="${s.id}">${s.icon} ${s.name}</option>
                            `).join('')}
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" id="migrateKeepLocal" checked>
                            <span>Keep a backup in localStorage</span>
                        </label>
                    </div>
                    
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" id="migrateSetPrimary" checked>
                            <span>Set as primary database after migration</span>
                        </label>
                    </div>
                    
                    <div style="padding: 12px; background: rgba(245, 158, 11, 0.1); border: 1px solid var(--warning); border-radius: 8px; margin-bottom: 20px;">
                        <div style="display: flex; align-items: center; gap: 8px; color: var(--warning); font-weight: 600; margin-bottom: 4px;">
                             Important
                        </div>
                        <div style="font-size: 0.8rem; color: var(--text-muted);">
                            Make sure you've connected and tested the target server before migrating. This process may take a few minutes for large datasets.
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 12px;">
                        <button type="button" class="btn btn-secondary" onclick="closeMigrateDataModal()" style="flex: 1;">
                            Cancel
                        </button>
                        <button type="button" class="btn btn-primary" onclick="startDataMigration()" style="flex: 1;">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M12 5v14M5 12h14"/>
                            </svg>
                            Start Migration
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Populate migration stats
            updateMigrationStats();
        }
        
        // Update migration stats
        function updateMigrationStats() {
            const registeredUsers = JSON.parse(localStorage.getItem('oith_registered_users') || '{}');
            const testBots = JSON.parse(localStorage.getItem('oith_test_bots') || '[]');
            
            let totalRecords = 0;
            let totalSize = 0;
            
            for (let key in localStorage) {
                if (localStorage.hasOwnProperty(key) && key.startsWith('oith_')) {
                    totalRecords++;
                    totalSize += localStorage[key].length * 2;
                }
            }
            
            document.getElementById('migrateUserCount').textContent = Object.keys(registeredUsers).length;
            document.getElementById('migrateMatchCount').textContent = testBots.filter(b => b.active).length;
            document.getElementById('migrateRecordCount').textContent = totalRecords;
            document.getElementById('migrateDataSize').textContent = (totalSize / 1024).toFixed(2) + ' KB';
        }
        
        // Close migrate data modal
        function closeMigrateDataModal() {
            const modal = document.getElementById('migrateDataModal');
            if (modal) modal.remove();
        }
        
        // Start data migration
        function startDataMigration() {
            const targetServer = document.getElementById('migrateTargetServer').value;
            
            if (!targetServer) {
                showToast(' Please select a target server', 'error');
                return;
            }
            
            const server = availableServers.find(s => s.id === targetServer);
            
            // Show progress modal
            closeMigrateDataModal();
            
            const progressModal = document.createElement('div');
            progressModal.className = 'modal active';
            progressModal.id = 'migrationProgressModal';
            progressModal.innerHTML = `
                <div class="modal-content" style="max-width: 400px; text-align: center;">
                    <div style="font-size: 3rem; margin-bottom: 16px;"></div>
                    <h3 style="margin-bottom: 8px;">Migrating Data...</h3>
                    <p style="color: var(--text-muted); margin-bottom: 24px;">Transferring to ${server.name}</p>
                    
                    <div style="background: var(--bg-tertiary); border-radius: 8px; overflow: hidden; height: 8px; margin-bottom: 16px;">
                        <div id="migrationProgress" style="height: 100%; background: var(--accent); width: 0%; transition: width 0.3s;"></div>
                    </div>
                    
                    <div id="migrationStatus" style="font-size: 0.85rem; color: var(--text-muted);">
                        Preparing data export...
                    </div>
                </div>
            `;
            
            document.body.appendChild(progressModal);
            
            // Simulate migration progress
            let progress = 0;
            const statuses = [
                'Exporting user profiles...',
                'Transferring match history...',
                'Migrating conversation data...',
                'Syncing preferences...',
                'Verifying data integrity...',
                'Finalizing migration...'
            ];
            
            const interval = setInterval(() => {
                progress += Math.random() * 20;
                if (progress > 100) progress = 100;
                
                document.getElementById('migrationProgress').style.width = progress + '%';
                document.getElementById('migrationStatus').textContent = statuses[Math.floor(progress / 20)] || statuses[statuses.length - 1];
                
                if (progress >= 100) {
                    clearInterval(interval);
                    
                    // Update connection to new server
                    if (document.getElementById('migrateSetPrimary')?.checked !== false) {
                        serverConnection = {
                            type: targetServer,
                            name: server.name,
                            description: server.description,
                            host: 'cloud',
                            connected: true,
                            connectedAt: new Date().toISOString()
                        };
                        localStorage.setItem('oith_server_connection', JSON.stringify(serverConnection));
                    }
                    
                    setTimeout(() => {
                        progressModal.remove();
                        showToast(` Successfully migrated to ${server.name}!`, 'success');
                        updateServerConnectionUI();
                        renderAvailableServers();
                    }, 500);
                }
            }, 500);
        }
        
        // Disconnect from server
        function disconnectServer() {
            if (serverConnection.type === 'localStorage') {
                showToast(' Cannot disconnect from localStorage - it is required for development mode', 'warning');
                return;
            }
            
            if (!confirm(`Are you sure you want to disconnect from ${serverConnection.name}? This will revert to localStorage.`)) {
                return;
            }
            
            // Revert to localStorage
            serverConnection = {
                type: 'localStorage',
                name: 'localStorage (Browser)',
                description: 'Development Mode - Client-Side Storage',
                host: 'local',
                connected: true,
                connectedAt: new Date().toISOString()
            };
            
            localStorage.setItem('oith_server_connection', JSON.stringify(serverConnection));
            
            updateServerConnectionUI();
            renderAvailableServers();
            
            showToast(' Disconnected. Reverted to localStorage.', 'success');
        }

        function downloadIPDocument() {
            // In production, this would download the actual document
            window.open('PATENT_IP_PROTECTION.md', '_blank');
            showToast('Opening IP Protection Document...');
        }

        // ==========================================
        // EXPORT FUNCTIONS
        // ==========================================
        
        function exportAllData() {
            const users = collectAllUsersForExport();
            if (users.length === 0) {
                // Export demo data instead
                const demoUsers = [
                    { user_id: '1', first_name: 'Matt', email: 'matt@example.com', age: 29, location: 'New York, NY', subscription: 'premium', status: 'active' },
                    { user_id: '2', first_name: 'Sarah', email: 'sarah@demo.com', age: 28, location: 'Brooklyn, NY', subscription: 'free', status: 'active' },
                    { user_id: '3', first_name: 'Emma', email: 'emma@demo.com', age: 26, location: 'Manhattan, NY', subscription: 'premium', status: 'matched' },
                ];
                downloadCSV(convertToCSV(demoUsers), `oith_users_${getDateString()}.csv`);
                showToast('Demo data exported!');
                return;
            }
            downloadCSV(convertToCSV(users), `oith_users_${getDateString()}.csv`);
            showToast('User data exported!');
        }

        function collectAllUsersForExport() {
            const users = [];
            Object.keys(registeredUsers).forEach(key => {
                const data = registeredUsers[key];
                if (data?.user) {
                    const u = data.user;
                    users.push({
                        user_id: key,
                        first_name: u.firstName || '',
                        email: u.email || '',
                        birthday: u.birthday || '',
                        age: u.age || '',
                        location: u.location || '',
                        occupation: u.occupation || '',
                        bio: u.bio || '',
                        subscription_type: u.subscription?.type || 'free',
                        subscription_start: u.subscription?.startDate || '',
                        is_logged_in: data.isLoggedIn ? 'Yes' : 'No',
                        has_active_match: data.activeConnection ? 'Yes' : 'No',
                        message_count: data.conversation?.messages?.length || 0,
                        exported_at: new Date().toISOString()
                    });
                }
            });
            return users;
        }

        function convertToCSV(data) {
            if (data.length === 0) return '';
            const headers = Object.keys(data[0]);
            const rows = data.map(obj => {
                return headers.map(h => {
                    let val = obj[h];
                    if (val === null || val === undefined) val = '';
                    val = String(val).replace(/"/g, '""');
                    if (val.includes(',') || val.includes('\n') || val.includes('"')) {
                        val = `"${val}"`;
                    }
                    return val;
                }).join(',');
            });
            return [headers.join(','), ...rows].join('\n');
        }

        function downloadCSV(csv, filename) {
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function getDateString() {
            return new Date().toISOString().split('T')[0];
        }

        // ==========================================
        // UTILITIES
        // ==========================================
        
        function showToast(message) {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                bottom: 24px;
                right: 24px;
                background: var(--bg-tertiary);
                color: var(--text-primary);
                padding: 12px 20px;
                border-radius: 8px;
                font-size: 0.9rem;
                z-index: 1000;
                animation: slideIn 0.3s ease;
            `;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // =========================================
        // CALENDAR SECTION - Milestones & Timeline
        // =========================================
        
        const projectMilestones = [
            // ============ PHASE 1: Foundation (Nov 28 - Dec 7) ============
            { date: '2025-11-28', title: ' Company Start Date', phase: 1, type: 'milestone', critical: true },
            { date: '2025-12-02', title: 'Register LLC', phase: 1, type: 'task' },
            { date: '2025-12-03', title: 'Obtain EIN', phase: 1, type: 'task' },
            { date: '2025-12-04', title: 'Developer Accounts (Apple & Google)', phase: 1, type: 'task' },
            { date: '2025-12-05', title: 'Business Formation Complete', phase: 1, type: 'milestone', critical: true },
            { date: '2025-12-05', title: 'D-U-N-S Number Received', phase: 1, type: 'task' },
            { date: '2025-12-05', title: 'Production AWS Environment', phase: 1, type: 'task' },
            { date: '2025-12-06', title: 'Open Business Bank Account', phase: 1, type: 'task' },
            { date: '2025-12-07', title: 'Legal Documents Ready', phase: 1, type: 'milestone', critical: true },
            { date: '2025-12-07', title: 'Infrastructure Setup Complete', phase: 1, type: 'task' },
            
            // ============ PHASE 2: Development (Dec 8 - Dec 28) ============
            { date: '2025-12-08', title: 'Development Kickoff', phase: 2, type: 'milestone' },
            { date: '2025-12-10', title: 'User Registration & Auth', phase: 2, type: 'task' },
            { date: '2025-12-10', title: 'API Architecture Ready', phase: 2, type: 'task' },
            { date: '2025-12-12', title: 'Profile Creation Complete', phase: 2, type: 'task' },
            { date: '2025-12-14', title: 'Location Services', phase: 2, type: 'task' },
            { date: '2025-12-17', title: 'Core Matching Algorithm Complete', phase: 2, type: 'milestone', critical: true },
            { date: '2025-12-19', title: 'Match Notifications', phase: 2, type: 'task' },
            { date: '2025-12-19', title: 'User Reporting System', phase: 2, type: 'task' },
            { date: '2025-12-21', title: 'In-App Messaging/Chat', phase: 2, type: 'task' },
            { date: '2025-12-21', title: 'Push Notifications', phase: 2, type: 'task' },
            { date: '2025-12-24', title: 'Payment Service', phase: 2, type: 'task' },
            { date: '2025-12-28', title: 'MVP Feature-Complete', phase: 2, type: 'milestone', critical: true },
            
            // ============ PHASE 3: Testing (Dec 29 - Jan 11) ============
            { date: '2025-12-29', title: 'Alpha Testing Begins', phase: 3, type: 'milestone' },
            { date: '2026-01-02', title: 'Unit Test Coverage >80%', phase: 3, type: 'task' },
            { date: '2026-01-02', title: 'Closed Beta (50 users)', phase: 3, type: 'milestone' },
            { date: '2026-01-06', title: 'Beta Testing 500+ Users', phase: 3, type: 'milestone' },
            { date: '2026-01-06', title: 'End-to-End Testing', phase: 3, type: 'task' },
            { date: '2026-01-08', title: 'Security Penetration Testing', phase: 3, type: 'task' },
            { date: '2026-01-08', title: 'Load Testing (10K users)', phase: 3, type: 'task' },
            { date: '2026-01-09', title: 'Open Beta (2,000 users)', phase: 3, type: 'milestone' },
            { date: '2026-01-11', title: 'All Critical Bugs Fixed', phase: 3, type: 'milestone', critical: true },
            
            // ============ PHASE 4: Pre-Launch (Jan 12 - Jan 31) ============
            { date: '2026-01-14', title: 'App Store Screenshots Ready', phase: 4, type: 'task' },
            { date: '2026-01-14', title: 'Social Media Accounts', phase: 4, type: 'task' },
            { date: '2026-01-15', title: 'Website Launch (oith.com)', phase: 4, type: 'task' },
            { date: '2026-01-17', title: 'App Store Assets Ready', phase: 4, type: 'milestone' },
            { date: '2026-01-17', title: 'Compliance Certifications', phase: 4, type: 'task' },
            { date: '2026-01-18', title: 'Apps Submitted for Review', phase: 4, type: 'milestone', critical: true },
            { date: '2026-01-20', title: 'Press Kit Ready', phase: 4, type: 'task' },
            { date: '2026-01-20', title: 'Customer Support System', phase: 4, type: 'task' },
            { date: '2026-01-25', title: 'Moderation Team Trained', phase: 4, type: 'task' },
            { date: '2026-01-25', title: 'Influencer Partnerships', phase: 4, type: 'task' },
            { date: '2026-01-28', title: 'Both Apps Approved', phase: 4, type: 'milestone', critical: true },
            { date: '2026-01-28', title: 'Launch PR Campaign', phase: 4, type: 'task' },
            { date: '2026-01-30', title: 'Launch Team Briefed', phase: 4, type: 'milestone' },
            { date: '2026-01-30', title: 'On-Call Schedule Set', phase: 4, type: 'task' },
            { date: '2026-01-31', title: 'Final Infrastructure Check', phase: 5, type: 'task' },
            
            // ============ PHASE 5: Launch (Feb 1) ============
            { date: '2026-02-01', title: ' OFFICIAL LAUNCH', phase: 5, type: 'milestone', critical: true },
            
            // ============ TAX DEADLINES ============
            { date: '2026-01-15', title: ' Q4 2025 Estimated Taxes Due', phase: 0, type: 'tax', critical: true, category: 'tax' },
            { date: '2026-01-31', title: ' W-2s to Employees / 1099s to Contractors', phase: 0, type: 'tax', critical: true, category: 'tax' },
            { date: '2026-01-31', title: ' Form 940 (FUTA) Annual Filing', phase: 0, type: 'tax', category: 'tax' },
            { date: '2026-01-31', title: ' Q4 Form 941 & Ohio Unemployment', phase: 0, type: 'tax', category: 'tax' },
            { date: '2026-03-15', title: ' Form 1065 Partnership Return (or Extension)', phase: 0, type: 'tax', critical: true, category: 'tax' },
            { date: '2026-04-15', title: ' Q1 2026 Estimated Taxes (Federal & State)', phase: 0, type: 'tax', critical: true, category: 'tax' },
            { date: '2026-04-30', title: ' Q1 Form 941 & Ohio Unemployment', phase: 0, type: 'tax', category: 'tax' },
            { date: '2026-06-15', title: ' Q2 2026 Estimated Taxes', phase: 0, type: 'tax', critical: true, category: 'tax' },
            { date: '2026-07-31', title: ' Q2 Form 941 & Ohio Unemployment', phase: 0, type: 'tax', category: 'tax' },
            { date: '2026-09-15', title: ' Q3 2026 Estimated Taxes', phase: 0, type: 'tax', critical: true, category: 'tax' },
            { date: '2026-10-31', title: ' Q3 Form 941 & Ohio Unemployment', phase: 0, type: 'tax', category: 'tax' },
            
            // ============ LEGAL / PATENT DEADLINES ============
            { date: '2024-12-31', title: ' Provisional Patents Q4 2024 Filing', phase: 0, type: 'legal', critical: true, category: 'patent' },
            { date: '2025-03-31', title: ' Additional Patents Q1 2025', phase: 0, type: 'legal', category: 'patent' },
            { date: '2025-06-30', title: ' Business Method Patent Q2 2025', phase: 0, type: 'legal', category: 'patent' },
            { date: '2025-12-31', title: ' PCT International Application Q4 2025', phase: 0, type: 'legal', category: 'patent' },
            { date: '2025-12-05', title: ' Articles of Organization Filed', phase: 1, type: 'legal', category: 'legal' },
            { date: '2025-12-07', title: ' Operating Agreement Executed', phase: 1, type: 'legal', category: 'legal' },
            { date: '2025-12-07', title: ' NDA Templates Ready', phase: 1, type: 'legal', category: 'legal' },
            { date: '2025-12-07', title: ' Contractor Agreements Ready', phase: 1, type: 'legal', category: 'legal' },
            
            // ============ COMPLIANCE DEADLINES ============
            { date: '2025-12-15', title: ' GDPR Compliance Review', phase: 0, type: 'compliance', category: 'compliance' },
            { date: '2025-12-15', title: ' CCPA Compliance Review', phase: 0, type: 'compliance', category: 'compliance' },
            { date: '2025-12-20', title: ' App Store Guidelines Compliance', phase: 0, type: 'compliance', category: 'compliance' },
            { date: '2025-12-20', title: ' PCI DSS Compliance (Payments)', phase: 0, type: 'compliance', critical: true, category: 'compliance' },
            { date: '2026-01-10', title: ' ADA Accessibility Audit', phase: 0, type: 'compliance', category: 'compliance' },
            { date: '2026-01-17', title: ' SOC 2 Type II Certification Started', phase: 0, type: 'compliance', category: 'compliance' },
            { date: '2026-01-17', title: ' COPPA Compliance (18+ Only)', phase: 0, type: 'compliance', category: 'compliance' },
            { date: '2026-01-20', title: ' Terms of Service Published', phase: 0, type: 'compliance', critical: true, category: 'compliance' },
            { date: '2026-01-20', title: ' Privacy Policy Published', phase: 0, type: 'compliance', critical: true, category: 'compliance' },
            { date: '2026-03-31', title: ' Q1 Compliance Audit', phase: 0, type: 'compliance', category: 'compliance' },
            { date: '2026-06-30', title: ' LGPD Brazil Compliance (if applicable)', phase: 0, type: 'compliance', category: 'compliance' },
            { date: '2026-06-30', title: ' Q2 Compliance Audit', phase: 0, type: 'compliance', category: 'compliance' },
            { date: '2026-09-30', title: ' Q3 Compliance Audit', phase: 0, type: 'compliance', category: 'compliance' },
            { date: '2026-12-31', title: ' Annual Security Audit', phase: 0, type: 'compliance', critical: true, category: 'compliance' },
            
            // ============ PAYROLL DEADLINES ============
            { date: '2025-12-15', title: ' First Payroll Run', phase: 0, type: 'payroll', category: 'payroll' },
            { date: '2025-12-31', title: ' December Payroll', phase: 0, type: 'payroll', category: 'payroll' },
            { date: '2026-01-15', title: ' January Payroll (Mid-Month)', phase: 0, type: 'payroll', category: 'payroll' },
            { date: '2026-01-31', title: ' January Payroll (End of Month)', phase: 0, type: 'payroll', category: 'payroll' }
        ];

        // ==========================================
        // EXPENSES & COST OPTIMIZATION
        // ==========================================
        
        // Expense data storage
        let expenseData = JSON.parse(localStorage.getItem('oithExpenses') || '[]');
        
        // Default expense entries with real pricing data
        const defaultExpenses = [
            // Development Tools
            { id: 'cursor', name: 'Cursor Pro', category: 'development', cost: 20, billing: 'monthly', status: 'active', vendor: 'Cursor', notes: 'AI-powered IDE - 2 seats', startDate: '2025-11-28' },
            { id: 'github', name: 'GitHub Team', category: 'development', cost: 0, billing: 'monthly', status: 'active', vendor: 'GitHub', notes: 'Free tier sufficient for now', startDate: '2025-11-28' },
            { id: 'figma', name: 'Figma', category: 'development', cost: 0, billing: 'monthly', status: 'active', vendor: 'Figma', notes: 'Free tier for up to 3 projects', startDate: '2025-11-28' },
            { id: 'vscode', name: 'VS Code', category: 'development', cost: 0, billing: 'one-time', status: 'active', vendor: 'Microsoft', notes: 'Free & open source', startDate: '2025-11-28' },
            
            // Cloud Infrastructure
            { id: 'aws-dynamodb', name: 'AWS DynamoDB', category: 'cloud', cost: 0, billing: 'monthly', status: 'active', vendor: 'AWS', notes: 'Free tier: 25GB storage, 25 WCU, 25 RCU', startDate: '2025-11-28', estimatedGrowth: 25 },
            { id: 'aws-lambda', name: 'AWS Lambda', category: 'cloud', cost: 0, billing: 'monthly', status: 'active', vendor: 'AWS', notes: 'Free tier: 1M requests/month', startDate: '2025-11-28' },
            { id: 'aws-s3', name: 'AWS S3', category: 'cloud', cost: 0, billing: 'monthly', status: 'active', vendor: 'AWS', notes: 'Free tier: 5GB storage', startDate: '2025-11-28' },
            { id: 'aws-cognito', name: 'AWS Cognito', category: 'cloud', cost: 0, billing: 'monthly', status: 'active', vendor: 'AWS', notes: 'Free: 50K MAU', startDate: '2025-11-28' },
            { id: 'aws-ses', name: 'AWS SES', category: 'cloud', cost: 0, billing: 'monthly', status: 'active', vendor: 'AWS', notes: 'Free: 62K emails/month from EC2', startDate: '2025-11-28' },
            { id: 'cloudflare', name: 'Cloudflare', category: 'cloud', cost: 0, billing: 'monthly', status: 'active', vendor: 'Cloudflare', notes: 'Free tier: CDN, DNS, DDoS protection', startDate: '2025-11-28' },
            
            // Communication & Email
            { id: 'google-workspace', name: 'Google Workspace Business Starter', category: 'communication', cost: 7.20, billing: 'monthly', status: 'active', vendor: 'Google', notes: 'Custom email @oneinthehand.com - 2 users', startDate: '2025-11-28', perUser: true, users: 2 },
            { id: 'slack', name: 'Slack', category: 'communication', cost: 0, billing: 'monthly', status: 'active', vendor: 'Slack', notes: 'Free tier sufficient for small team', startDate: '2025-11-28' },
            { id: 'zoom', name: 'Zoom', category: 'communication', cost: 0, billing: 'monthly', status: 'active', vendor: 'Zoom', notes: 'Free tier: 40min meetings', startDate: '2025-11-28' },
            
            // Legal & Compliance
            { id: 'llc-filing', name: 'Delaware LLC Filing', category: 'legal', cost: 90, billing: 'one-time', status: 'pending', vendor: 'Delaware DOS', notes: 'State filing fee', startDate: '2025-12-01' },
            { id: 'registered-agent', name: 'Registered Agent Service', category: 'legal', cost: 49, billing: 'yearly', status: 'pending', vendor: 'Northwest', notes: 'Annual registered agent fee', startDate: '2025-12-01' },
            { id: 'trademark', name: 'USPTO Trademark (OITH)', category: 'legal', cost: 250, billing: 'one-time', status: 'planned', vendor: 'USPTO', notes: 'TEAS Plus filing - 1 class', startDate: '2026-01-15' },
            
            // App Store
            { id: 'apple-dev', name: 'Apple Developer Program', category: 'development', cost: 99, billing: 'yearly', status: 'planned', vendor: 'Apple', notes: 'Required for iOS App Store', startDate: '2026-01-15' },
            { id: 'google-play', name: 'Google Play Developer', category: 'development', cost: 25, billing: 'one-time', status: 'planned', vendor: 'Google', notes: 'One-time registration fee', startDate: '2026-01-15' },
            
            // Domain
            { id: 'domain', name: 'Domain: oneinthehand.com', category: 'other', cost: 12, billing: 'yearly', status: 'active', vendor: 'Namecheap', notes: 'Primary domain', startDate: '2025-11-28' }
        ];
        
        // Initialize expenses if empty
        function initExpenses() {
            if (expenseData.length === 0) {
                expenseData = [...defaultExpenses];
                saveExpenses();
            }
        }
        
        function saveExpenses() {
            localStorage.setItem('oithExpenses', JSON.stringify(expenseData));
        }
        
        // Show expense detail modal
        function showExpenseDetail(type) {
            const modal = document.getElementById('expenseDetailModal');
            const title = document.getElementById('expenseModalTitle');
            const body = document.getElementById('expenseModalBody');
            
            if (!modal || !body) return;
            
            // Calculate data for the modal
            const now = new Date();
            const startDate = new Date('2025-11-28');
            const monthsActive = Math.max(1, Math.ceil((now - startDate) / (1000 * 60 * 60 * 24 * 30)));
            
            let html = '';
            
            switch(type) {
                case 'total':
                    title.innerHTML = ' Total Expenses Breakdown';
                    html = generateTotalExpensesDetail(monthsActive);
                    break;
                case 'burn':
                    title.innerHTML = ' Monthly Burn Rate Details';
                    html = generateBurnRateDetail(monthsActive);
                    break;
                case 'savings':
                    title.innerHTML = ' Potential Savings Opportunities';
                    html = generateSavingsDetail();
                    break;
                case 'services':
                    title.innerHTML = ' Active Services List';
                    html = generateServicesDetail();
                    break;
                case 'payroll':
                    title.innerHTML = ' Payroll Breakdown';
                    html = generatePayrollDetail(monthsActive);
                    break;
            }
            
            body.innerHTML = html;
            modal.style.display = 'flex';
            
            // Close on click outside
            modal.onclick = function(e) {
                if (e.target === modal) closeExpenseDetail();
            };
            
            // Close on Escape key
            document.addEventListener('keydown', function closeOnEscape(e) {
                if (e.key === 'Escape') {
                    closeExpenseDetail();
                    document.removeEventListener('keydown', closeOnEscape);
                }
            });
        }
        
        function closeExpenseDetail() {
            const modal = document.getElementById('expenseDetailModal');
            if (modal) modal.style.display = 'none';
        }
        
        function generateTotalExpensesDetail(monthsActive) {
            let serviceTotal = 0;
            let oneTimeTotal = 0;
            let yearlyTotal = 0;
            
            const servicesByCategory = {};
            
            expenseData.forEach(exp => {
                if (exp.status === 'active' || exp.status === 'pending') {
                    if (!servicesByCategory[exp.category]) {
                        servicesByCategory[exp.category] = { monthly: 0, oneTime: 0, yearly: 0, items: [] };
                    }
                    
                    const cost = exp.perUser ? exp.cost * (exp.users || 1) : exp.cost;
                    servicesByCategory[exp.category].items.push(exp);
                    
                    if (exp.billing === 'monthly') {
                        servicesByCategory[exp.category].monthly += cost;
                        serviceTotal += cost * monthsActive;
                    } else if (exp.billing === 'yearly') {
                        servicesByCategory[exp.category].yearly += cost;
                        yearlyTotal += cost;
                    } else if (exp.billing === 'one-time') {
                        servicesByCategory[exp.category].oneTime += cost;
                        oneTimeTotal += cost;
                    }
                }
            });
            
            // Get payroll data
            const activeEmployees = orgData.employees ? orgData.employees.filter(e => e.status === 'active') : [];
            const totalAnnualPayroll = activeEmployees.reduce((sum, e) => sum + (e.salary || 0), 0);
            const monthlyPayroll = totalAnnualPayroll / 12;
            const payrollToDate = monthlyPayroll * monthsActive;
            
            const grandTotal = serviceTotal + oneTimeTotal + yearlyTotal + payrollToDate;
            
            return `
                <div class="expense-modal-summary">
                    <div class="expense-modal-stat">
                        <div class="value" style="color: var(--danger);">${formatCurrency(grandTotal)}</div>
                        <div class="label">Grand Total</div>
                    </div>
                    <div class="expense-modal-stat">
                        <div class="value" style="color: var(--info);">${formatCurrency(serviceTotal)}</div>
                        <div class="label">Recurring Services</div>
                    </div>
                    <div class="expense-modal-stat">
                        <div class="value" style="color: var(--warning);">${formatCurrency(oneTimeTotal + yearlyTotal)}</div>
                        <div class="label">One-time/Yearly</div>
                    </div>
                    <div class="expense-modal-stat">
                        <div class="value" style="color: var(--purple);">${formatCurrency(payrollToDate)}</div>
                        <div class="label">Payroll (${monthsActive}mo)</div>
                    </div>
                </div>
                
                <div class="expense-modal-section">
                    <h4> Breakdown by Category</h4>
                    <table class="expense-modal-table">
                        <thead>
                            <tr>
                                <th>Category</th>
                                <th>Monthly</th>
                                <th>One-time/Yearly</th>
                                <th>Total to Date</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${Object.entries(servicesByCategory).map(([cat, data]) => {
                                const catTotal = (data.monthly * monthsActive) + data.oneTime + data.yearly;
                                return `
                                    <tr>
                                        <td>${getCategoryIcon(cat)} ${cat.charAt(0).toUpperCase() + cat.slice(1)}</td>
                                        <td class="amount">${formatCurrency(data.monthly)}/mo</td>
                                        <td class="amount">${formatCurrency(data.oneTime + data.yearly)}</td>
                                        <td class="amount" style="color: var(--danger);">${formatCurrency(catTotal)}</td>
                                    </tr>
                                `;
                            }).join('')}
                            <tr style="background: rgba(139, 92, 246, 0.1);">
                                <td> Payroll</td>
                                <td class="amount">${formatCurrency(monthlyPayroll)}/mo</td>
                                <td class="amount">--</td>
                                <td class="amount" style="color: var(--purple);">${formatCurrency(payrollToDate)}</td>
                            </tr>
                        </tbody>
                        <tfoot>
                            <tr style="font-weight: 700; background: var(--bg-secondary);">
                                <td>TOTAL</td>
                                <td></td>
                                <td></td>
                                <td class="amount" style="color: var(--danger); font-size: 1.1rem;">${formatCurrency(grandTotal)}</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                
                <div style="padding: 12px; background: var(--bg-tertiary); border-radius: 8px; font-size: 0.8rem; color: var(--text-muted);">
                     Tracking period: ${monthsActive} month(s) since Nov 28, 2025
                </div>
            `;
        }
        
        function generateBurnRateDetail(monthsActive) {
            let monthlyRecurring = 0;
            const recurringItems = [];
            
            expenseData.forEach(exp => {
                if ((exp.status === 'active' || exp.status === 'pending') && exp.billing === 'monthly') {
                    const cost = exp.perUser ? exp.cost * (exp.users || 1) : exp.cost;
                    monthlyRecurring += cost;
                    recurringItems.push({ ...exp, actualCost: cost });
                }
            });
            
            // Get payroll data
            const activeEmployees = orgData.employees ? orgData.employees.filter(e => e.status === 'active') : [];
            const totalAnnualPayroll = activeEmployees.reduce((sum, e) => sum + (e.salary || 0), 0);
            const monthlyPayroll = totalAnnualPayroll / 12;
            
            const totalBurn = monthlyRecurring + monthlyPayroll;
            const yearlyProjection = totalBurn * 12;
            
            // Sort by cost descending
            recurringItems.sort((a, b) => b.actualCost - a.actualCost);
            
            return `
                <div class="expense-modal-summary">
                    <div class="expense-modal-stat">
                        <div class="value" style="color: var(--warning);">${formatCurrency(totalBurn)}</div>
                        <div class="label">Total Monthly Burn</div>
                    </div>
                    <div class="expense-modal-stat">
                        <div class="value" style="color: var(--info);">${formatCurrency(monthlyRecurring)}</div>
                        <div class="label">Services</div>
                    </div>
                    <div class="expense-modal-stat">
                        <div class="value" style="color: var(--purple);">${formatCurrency(monthlyPayroll)}</div>
                        <div class="label">Payroll</div>
                    </div>
                    <div class="expense-modal-stat">
                        <div class="value" style="color: var(--danger);">${formatCurrency(yearlyProjection)}</div>
                        <div class="label">Yearly Projection</div>
                    </div>
                </div>
                
                <div class="expense-modal-section">
                    <h4> Monthly Recurring Services (sorted by cost)</h4>
                    <table class="expense-modal-table">
                        <thead>
                            <tr>
                                <th>Service</th>
                                <th>Category</th>
                                <th>Cost/Month</th>
                                <th>% of Burn</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${recurringItems.map(item => {
                                const pct = ((item.actualCost / totalBurn) * 100).toFixed(1);
                                return `
                                    <tr>
                                        <td>${item.name}</td>
                                        <td>${getCategoryIcon(item.category)} ${item.category}</td>
                                        <td class="amount">${formatCurrency(item.actualCost)}</td>
                                        <td>
                                            <div style="display: flex; align-items: center; gap: 8px;">
                                                <div style="flex: 1; height: 6px; background: var(--bg-secondary); border-radius: 3px; overflow: hidden;">
                                                    <div style="width: ${pct}%; height: 100%; background: var(--accent);"></div>
                                                </div>
                                                <span style="font-size: 0.75rem; min-width: 40px;">${pct}%</span>
                                            </div>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                            ${monthlyPayroll > 0 ? `
                                <tr style="background: rgba(139, 92, 246, 0.1);">
                                    <td>Employee Salaries</td>
                                    <td> Payroll</td>
                                    <td class="amount">${formatCurrency(monthlyPayroll)}</td>
                                    <td>
                                        <div style="display: flex; align-items: center; gap: 8px;">
                                            <div style="flex: 1; height: 6px; background: var(--bg-secondary); border-radius: 3px; overflow: hidden;">
                                                <div style="width: ${((monthlyPayroll / totalBurn) * 100).toFixed(1)}%; height: 100%; background: var(--purple);"></div>
                                            </div>
                                            <span style="font-size: 0.75rem; min-width: 40px;">${((monthlyPayroll / totalBurn) * 100).toFixed(1)}%</span>
                                        </div>
                                    </td>
                                </tr>
                            ` : ''}
                        </tbody>
                    </table>
                </div>
            `;
        }
        
        function generateSavingsDetail() {
            const savings = [];
            let totalSavings = 0;
            
            expenseData.forEach(exp => {
                if (exp.status === 'active' && exp.freeTier) {
                    const cost = exp.perUser ? exp.cost * (exp.users || 1) : exp.cost;
                    savings.push({
                        name: exp.name,
                        category: exp.category,
                        currentCost: cost,
                        suggestion: exp.optimization || 'Downgrade to free tier',
                        potentialSaving: cost
                    });
                    totalSavings += cost;
                }
            });
            
            // Add general optimization suggestions
            const generalSuggestions = [
                { name: 'Annual Billing', desc: 'Switch to yearly plans for 10-20% savings', impact: 'Medium' },
                { name: 'Consolidate Tools', desc: 'Use fewer multi-purpose tools', impact: 'High' },
                { name: 'Free Alternatives', desc: 'Evaluate open-source options', impact: 'Medium' },
                { name: 'Usage Audit', desc: 'Remove unused services/seats', impact: 'Low-Medium' }
            ];
            
            return `
                <div class="expense-modal-summary">
                    <div class="expense-modal-stat">
                        <div class="value" style="color: var(--success);">${formatCurrency(totalSavings)}/mo</div>
                        <div class="label">Potential Savings</div>
                    </div>
                    <div class="expense-modal-stat">
                        <div class="value" style="color: var(--info);">${savings.length}</div>
                        <div class="label">Optimization Opportunities</div>
                    </div>
                    <div class="expense-modal-stat">
                        <div class="value" style="color: var(--warning);">${formatCurrency(totalSavings * 12)}</div>
                        <div class="label">Yearly Impact</div>
                    </div>
                </div>
                
                ${savings.length > 0 ? `
                    <div class="expense-modal-section">
                        <h4> Services with Free Tier Available</h4>
                        <table class="expense-modal-table">
                            <thead>
                                <tr>
                                    <th>Service</th>
                                    <th>Current Cost</th>
                                    <th>Suggestion</th>
                                    <th>Potential Saving</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${savings.map(s => `
                                    <tr>
                                        <td>${s.name}</td>
                                        <td class="amount">${formatCurrency(s.currentCost)}/mo</td>
                                        <td style="font-size: 0.8rem;">${s.suggestion}</td>
                                        <td class="amount" style="color: var(--success);">-${formatCurrency(s.potentialSaving)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                ` : ''}
                
                <div class="expense-modal-section">
                    <h4> General Optimization Strategies</h4>
                    <div style="display: grid; gap: 12px;">
                        ${generalSuggestions.map(s => `
                            <div style="padding: 14px; background: var(--bg-tertiary); border-radius: 10px; border-left: 3px solid var(--success);">
                                <div style="font-weight: 600; margin-bottom: 4px;">${s.name}</div>
                                <div style="font-size: 0.8rem; color: var(--text-muted);">${s.desc}</div>
                                <div style="margin-top: 8px;">
                                    <span style="font-size: 0.7rem; padding: 2px 8px; background: rgba(16, 185, 129, 0.2); color: var(--success); border-radius: 4px;">Impact: ${s.impact}</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }
        
        function generateServicesDetail() {
            const services = expenseData.filter(e => e.status === 'active' || e.status === 'pending');
            
            // Group by category
            const byCategory = {};
            services.forEach(s => {
                if (!byCategory[s.category]) byCategory[s.category] = [];
                byCategory[s.category].push(s);
            });
            
            const activeCount = services.filter(s => s.status === 'active').length;
            const pendingCount = services.filter(s => s.status === 'pending').length;
            
            return `
                <div class="expense-modal-summary">
                    <div class="expense-modal-stat">
                        <div class="value" style="color: var(--info);">${services.length}</div>
                        <div class="label">Total Services</div>
                    </div>
                    <div class="expense-modal-stat">
                        <div class="value" style="color: var(--success);">${activeCount}</div>
                        <div class="label">Active</div>
                    </div>
                    <div class="expense-modal-stat">
                        <div class="value" style="color: var(--warning);">${pendingCount}</div>
                        <div class="label">Pending</div>
                    </div>
                    <div class="expense-modal-stat">
                        <div class="value" style="color: var(--purple);">${Object.keys(byCategory).length}</div>
                        <div class="label">Categories</div>
                    </div>
                </div>
                
                ${Object.entries(byCategory).map(([category, items]) => `
                    <div class="expense-modal-section">
                        <h4>${getCategoryIcon(category)} ${category.charAt(0).toUpperCase() + category.slice(1)} (${items.length})</h4>
                        <table class="expense-modal-table">
                            <thead>
                                <tr>
                                    <th>Service</th>
                                    <th>Vendor</th>
                                    <th>Billing</th>
                                    <th>Cost</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${items.map(item => {
                                    const cost = item.perUser ? item.cost * (item.users || 1) : item.cost;
                                    const statusColor = item.status === 'active' ? 'var(--success)' : 'var(--warning)';
                                    return `
                                        <tr>
                                            <td>${item.name}</td>
                                            <td style="font-size: 0.8rem; color: var(--text-muted);">${item.vendor || '--'}</td>
                                            <td>${item.billing}</td>
                                            <td class="amount">${formatCurrency(cost)}</td>
                                            <td><span style="color: ${statusColor};"> ${item.status}</span></td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                `).join('')}
            `;
        }
        
        function generatePayrollDetail(monthsActive) {
            const activeEmployees = orgData.employees ? orgData.employees.filter(e => e.status === 'active') : [];
            const totalAnnualPayroll = activeEmployees.reduce((sum, e) => sum + (e.salary || 0), 0);
            const monthlyPayroll = totalAnnualPayroll / 12;
            const payrollToDate = monthlyPayroll * monthsActive;
            
            // Group by department
            const byDepartment = {};
            activeEmployees.forEach(emp => {
                const dept = orgData.departments ? orgData.departments.find(d => d.id === emp.department) : null;
                const deptName = dept ? dept.name : 'Unassigned';
                if (!byDepartment[deptName]) byDepartment[deptName] = { employees: [], total: 0 };
                byDepartment[deptName].employees.push(emp);
                byDepartment[deptName].total += emp.salary || 0;
            });
            
            return `
                <div class="expense-modal-summary">
                    <div class="expense-modal-stat">
                        <div class="value" style="color: var(--purple);">${formatCurrency(monthlyPayroll)}</div>
                        <div class="label">Monthly Payroll</div>
                    </div>
                    <div class="expense-modal-stat">
                        <div class="value" style="color: var(--info);">${formatCurrency(totalAnnualPayroll)}</div>
                        <div class="label">Annual Payroll</div>
                    </div>
                    <div class="expense-modal-stat">
                        <div class="value" style="color: var(--warning);">${formatCurrency(payrollToDate)}</div>
                        <div class="label">Spent to Date</div>
                    </div>
                    <div class="expense-modal-stat">
                        <div class="value" style="color: var(--success);">${activeEmployees.length}</div>
                        <div class="label">Active Employees</div>
                    </div>
                </div>
                
                ${Object.entries(byDepartment).length > 0 ? Object.entries(byDepartment).map(([deptName, data]) => `
                    <div class="expense-modal-section">
                        <h4> ${deptName} Department (${data.employees.length})</h4>
                        <table class="expense-modal-table">
                            <thead>
                                <tr>
                                    <th>Employee</th>
                                    <th>Role</th>
                                    <th>Annual Salary</th>
                                    <th>Monthly</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.employees.map(emp => `
                                    <tr>
                                        <td>${emp.name}</td>
                                        <td style="font-size: 0.8rem; color: var(--text-muted);">${emp.role}</td>
                                        <td class="amount">${formatCurrency(emp.salary || 0)}</td>
                                        <td class="amount">${formatCurrency((emp.salary || 0) / 12)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                            <tfoot>
                                <tr style="font-weight: 600; background: var(--bg-secondary);">
                                    <td colspan="2">Department Total</td>
                                    <td class="amount">${formatCurrency(data.total)}</td>
                                    <td class="amount">${formatCurrency(data.total / 12)}</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                `).join('') : `
                    <div style="padding: 40px; text-align: center; color: var(--text-muted);">
                        <div style="font-size: 2rem; margin-bottom: 12px;"></div>
                        <div>No employees found in the org hierarchy.</div>
                        <div style="font-size: 0.8rem; margin-top: 8px;">Add employees in the Hierarchy section to track payroll.</div>
                    </div>
                `}
                
                <div style="padding: 12px; background: var(--bg-tertiary); border-radius: 8px; font-size: 0.8rem; color: var(--text-muted); margin-top: 16px;">
                     Payroll data is integrated from the Organization Hierarchy. Update employee salaries there to reflect changes here.
                </div>
            `;
        }
        
        function getCategoryIcon(category) {
            const icons = {
                'development': '',
                'cloud': '',
                'communication': '',
                'legal': '',
                'marketing': '',
                'analytics': '',
                'security': '',
                'payroll': ''
            };
            return icons[category] || '';
        }
        
        async function renderExpenses() {
            initExpenses();
            
            // Load org data to get employee salaries
            await loadOrgData();
            
            // Calculate totals from regular expenses
            let totalToDate = 0;
            let monthlyRecurring = 0;
            let yearlyEquivalent = 0;
            let activeServices = 0;
            
            const now = new Date();
            const startDate = new Date('2025-11-28');
            const monthsActive = Math.max(1, Math.ceil((now - startDate) / (1000 * 60 * 60 * 24 * 30)));
            
            expenseData.forEach(exp => {
                if (exp.status === 'active' || exp.status === 'pending') {
                    activeServices++;
                    
                    if (exp.billing === 'monthly') {
                        const monthlyCost = exp.perUser ? exp.cost * (exp.users || 1) : exp.cost;
                        monthlyRecurring += monthlyCost;
                        totalToDate += monthlyCost * monthsActive;
                    } else if (exp.billing === 'yearly') {
                        yearlyEquivalent += exp.cost;
                        totalToDate += exp.cost; // Count yearly as paid once
                    } else if (exp.billing === 'one-time') {
                        totalToDate += exp.cost;
                    }
                }
            });
            
            // Calculate payroll from employee salaries (integrated from org data)
            const activeEmployees = orgData.employees.filter(e => e.status === 'active');
            const totalAnnualPayroll = activeEmployees.reduce((sum, e) => sum + (e.salary || 0), 0);
            const monthlyPayroll = totalAnnualPayroll / 12;
            
            // Add payroll to monthly burn rate and totals
            const totalMonthlyBurn = monthlyRecurring + monthlyPayroll;
            totalToDate += monthlyPayroll * monthsActive;
            
            // Update summary stats
            document.getElementById('totalExpensesToDate').textContent = formatCurrency(totalToDate);
            document.getElementById('monthlyBurn').textContent = formatCurrency(totalMonthlyBurn);
            document.getElementById('activeServices').textContent = activeServices;
            document.getElementById('monthlyPayrollExpense').textContent = formatCurrency(monthlyPayroll);
            
            // Calculate potential savings
            const potentialSavings = calculatePotentialSavings();
            document.getElementById('potentialSavings').textContent = formatCurrency(potentialSavings) + '/mo';
            
            // Calculate expense trend (comparing total burn to baseline)
            const baselineBurn = 50; // Base monthly services without payroll
            document.getElementById('expensesTrend').textContent = totalMonthlyBurn > baselineBurn ? '+' + Math.round((totalMonthlyBurn / baselineBurn - 1) * 100) + '%' : 'LOW';
            
            // Render category cards
            renderCategoryExpenses('development', 'devToolsExpenses', 'devToolsTotal');
            renderCategoryExpenses('cloud', 'cloudExpenses', 'cloudTotal');
            renderCategoryExpenses('communication', 'emailExpenses', 'emailTotal');
            renderCategoryExpenses('legal', 'legalExpenses', 'legalTotal');
            
            // Render payroll category (from employee salaries)
            renderPayrollExpenses();
            
            // Render expense table
            renderExpenseTable();
            
            // Render optimization recommendations
            renderOptimizationRecommendations();
            
            // Render service-specific optimization
            renderDynamoOptimization();
            renderGoogleOptimization();
            renderCursorOptimization();
            
            // Render expense chart
            renderExpenseChart();
        }
        
        function renderCategoryExpenses(category, containerId, totalId) {
            const container = document.getElementById(containerId);
            const categoryExpenses = expenseData.filter(e => e.category === category);
            
            let categoryTotal = 0;
            let html = '';
            
            categoryExpenses.forEach(exp => {
                const cost = exp.perUser ? exp.cost * (exp.users || 1) : exp.cost;
                const billingLabel = exp.billing === 'monthly' ? '/mo' : exp.billing === 'yearly' ? '/yr' : '';
                
                if (exp.billing === 'monthly') categoryTotal += cost;
                else if (exp.billing === 'yearly') categoryTotal += cost / 12;
                
                const statusColor = exp.status === 'active' ? 'var(--success)' : 
                                   exp.status === 'pending' ? 'var(--warning)' : 'var(--text-muted)';
                
                html += `
                    <div class="metric-row">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="width: 8px; height: 8px; border-radius: 50%; background: ${statusColor};"></span>
                            <span class="metric-label">${exp.name}</span>
                        </div>
                        <span class="metric-value" style="color: ${cost > 0 ? 'var(--danger)' : 'var(--success)'}">
                            ${cost > 0 ? '$' + cost.toFixed(2) + billingLabel : 'FREE'}
                        </span>
                    </div>
                `;
            });
            
            container.innerHTML = html || '<p style="color: var(--text-muted); font-size: 12px;">No expenses in this category</p>';
            
            const totalEl = document.getElementById(totalId);
            if (category === 'legal') {
                const oneTimeCosts = categoryExpenses.filter(e => e.billing === 'one-time').reduce((sum, e) => sum + e.cost, 0);
                totalEl.textContent = '$' + oneTimeCosts.toFixed(0);
            } else {
                totalEl.textContent = '$' + categoryTotal.toFixed(2) + '/mo';
            }
        }
        
        function renderPayrollExpenses() {
            const container = document.getElementById('payrollExpenses');
            const totalEl = document.getElementById('payrollTotal');
            
            const activeEmployees = orgData.employees.filter(e => e.status === 'active');
            const totalAnnualPayroll = activeEmployees.reduce((sum, e) => sum + (e.salary || 0), 0);
            const monthlyPayroll = totalAnnualPayroll / 12;
            
            if (activeEmployees.length === 0) {
                container.innerHTML = '<p style="color: var(--text-muted); font-size: 12px;">No active employees</p>';
                totalEl.textContent = '$0/mo';
                return;
            }
            
            let html = '';
            
            // Sort employees by salary (highest first)
            const sortedEmployees = [...activeEmployees].sort((a, b) => (b.salary || 0) - (a.salary || 0));
            
            sortedEmployees.forEach(emp => {
                const dept = orgData.departments.find(d => d.id === emp.department);
                const monthlySalary = (emp.salary || 0) / 12;
                const percentOfTotal = totalAnnualPayroll > 0 ? ((emp.salary || 0) / totalAnnualPayroll * 100).toFixed(1) : 0;
                
                html += `
                    <div class="metric-row" style="padding: 8px 0; border-bottom: 1px solid var(--border);">
                        <div style="display: flex; align-items: center; gap: 10px; flex: 1;">
                            <div style="width: 36px; height: 36px; border-radius: 50%; background: ${dept?.color || 'var(--accent)'}30; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 14px; color: ${dept?.color || 'var(--accent)'};">
                                ${emp.name.split(' ').map(n => n[0]).join('')}
                            </div>
                            <div>
                                <div style="font-weight: 500; font-size: 0.9rem;">${emp.name}</div>
                                <div style="font-size: 0.75rem; color: var(--text-muted);">${emp.role}  ${dept?.name || 'N/A'}</div>
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <span class="metric-value" style="color: var(--purple); font-weight: 600;">
                                ${formatCurrency(monthlySalary)}/mo
                            </span>
                            <div style="font-size: 0.7rem; color: var(--text-muted);">${percentOfTotal}% of payroll</div>
                        </div>
                    </div>
                `;
            });
            
            // Add summary row
            html += `
                <div style="margin-top: 12px; padding-top: 12px; border-top: 2px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <span style="font-size: 0.85rem; color: var(--text-muted);">${activeEmployees.length} active employee${activeEmployees.length !== 1 ? 's' : ''}</span>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 0.75rem; color: var(--text-muted);">Annual Total</div>
                        <div style="font-size: 1.1rem; font-weight: 700; color: var(--purple);">${formatCurrency(totalAnnualPayroll)}</div>
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
            totalEl.textContent = formatCurrency(monthlyPayroll) + '/mo';
        }
        
        function renderExpenseTable() {
            const tbody = document.getElementById('expenseTableBody');
            const filterCategory = document.getElementById('expenseFilterCategory')?.value || 'all';
            
            let html = '';
            
            // Handle regular expenses
            if (filterCategory !== 'payroll') {
                let filtered = expenseData;
                if (filterCategory !== 'all') {
                    filtered = expenseData.filter(e => e.category === filterCategory);
                }
                
                filtered.forEach(exp => {
                    const cost = exp.perUser ? exp.cost * (exp.users || 1) : exp.cost;
                    const statusClass = exp.status === 'active' ? 'active' : 
                                       exp.status === 'pending' ? 'warning' : 'inactive';
                    
                    html += `
                        <tr>
                            <td>
                                <div style="font-weight: 600;">${exp.name}</div>
                                <div style="font-size: 11px; color: var(--text-muted);">${exp.vendor}  ${exp.notes}</div>
                            </td>
                            <td><span class="status-badge" style="text-transform: capitalize;">${exp.category}</span></td>
                            <td style="font-weight: 600; color: ${cost > 0 ? 'var(--text-primary)' : 'var(--success)'}">
                                ${cost > 0 ? '$' + cost.toFixed(2) : 'FREE'}
                            </td>
                            <td style="text-transform: capitalize;">${exp.billing}</td>
                            <td><span class="status-badge ${statusClass}">${exp.status}</span></td>
                            <td>
                                <button onclick="editExpense('${exp.id}')" style="background: none; border: none; cursor: pointer; color: var(--accent);"></button>
                                <button onclick="deleteExpense('${exp.id}')" style="background: none; border: none; cursor: pointer; color: var(--danger);"></button>
                            </td>
                        </tr>
                    `;
                });
            }
            
            // Handle payroll entries (show when 'all' or 'payroll' selected)
            if (filterCategory === 'all' || filterCategory === 'payroll') {
                const activeEmployees = orgData.employees.filter(e => e.status === 'active');
                
                activeEmployees.forEach(emp => {
                    const dept = orgData.departments.find(d => d.id === emp.department);
                    const monthlySalary = (emp.salary || 0) / 12;
                    
                    html += `
                        <tr style="background: rgba(139, 92, 246, 0.05);">
                            <td>
                                <div style="font-weight: 600;"> ${emp.name}</div>
                                <div style="font-size: 11px; color: var(--text-muted);">${emp.role}  ${dept?.name || 'N/A'}</div>
                            </td>
                            <td><span class="status-badge" style="background: var(--purple); color: white;">Payroll</span></td>
                            <td style="font-weight: 600; color: var(--purple);">
                                ${formatCurrency(monthlySalary)}
                            </td>
                            <td>Monthly</td>
                            <td><span class="status-badge active">Active</span></td>
                            <td>
                                <button onclick="showSection('organization'); setTimeout(() => editEmployee(${emp.id}), 100);" style="background: none; border: none; cursor: pointer; color: var(--accent);"></button>
                            </td>
                        </tr>
                    `;
                });
            }
            
            tbody.innerHTML = html || '<tr><td colspan="6" style="text-align: center; color: var(--text-muted);">No expenses found</td></tr>';
            
            // Add filter listeners
            document.getElementById('expenseFilterCategory')?.addEventListener('change', renderExpenseTable);
        }
        
        function calculatePotentialSavings() {
            let savings = 0;
            
            // Check for optimization opportunities
            const cursor = expenseData.find(e => e.id === 'cursor');
            if (cursor && cursor.cost > 0) {
                // Could use free VSCode + Copilot trial
                savings += 5;
            }
            
            const googleWS = expenseData.find(e => e.id === 'google-workspace');
            if (googleWS && googleWS.users > 1) {
                // Annual billing saves 10%
                savings += googleWS.cost * 0.1 * googleWS.users;
            }
            
            return savings;
        }
        
        function renderOptimizationRecommendations() {
            const container = document.getElementById('optimizationRecommendations');
            
            const recommendations = [
                {
                    icon: '',
                    title: 'AWS Free Tier Optimization',
                    description: 'You\'re currently within AWS free tier limits. Monitor usage as you scale.',
                    savings: 'Avoiding ~$50-200/mo',
                    urgency: 'info',
                    actions: ['Set up billing alerts at $5, $20, $50', 'Enable AWS Cost Explorer', 'Use reserved capacity when predictable']
                },
                {
                    icon: '',
                    title: 'Google Workspace Annual Billing',
                    description: 'Switch from monthly to annual billing to save 10% on Google Workspace.',
                    savings: 'Save $1.44/user/yr',
                    urgency: 'low',
                    actions: ['Upgrade to annual plan when cash flow allows', 'Consider Business Standard ($12/mo) only when needed']
                },
                {
                    icon: '',
                    title: 'DynamoDB On-Demand vs Provisioned',
                    description: 'On-demand pricing is best during development. Switch to provisioned capacity when traffic patterns are predictable.',
                    savings: 'Up to 70% at scale',
                    urgency: 'future',
                    actions: ['Monitor read/write patterns in CloudWatch', 'Consider provisioned when >25% capacity utilization', 'Use auto-scaling for production']
                },
                {
                    icon: '',
                    title: 'Cursor Pro Alternatives',
                    description: 'Evaluate if Cursor Pro features are essential vs. VS Code + GitHub Copilot.',
                    savings: '$10-20/mo',
                    urgency: 'low',
                    actions: ['Compare Cursor Pro vs Copilot features', 'Consider team plan for 2+ devs', 'Watch for annual discount offers']
                },
                {
                    icon: '',
                    title: 'Lambda Cold Starts Optimization',
                    description: 'Use provisioned concurrency only for critical paths; keep development functions on-demand.',
                    savings: 'Avoid $15-30/mo',
                    urgency: 'info',
                    actions: ['Profile function cold start times', 'Use provisioned concurrency only for auth/payments', 'Consider Lambda SnapStart for Java']
                },
                {
                    icon: '',
                    title: 'Domain Consolidation',
                    description: 'Keep all domains with one registrar for easier management and potential bulk discounts.',
                    savings: 'Minimal but organized',
                    urgency: 'low',
                    actions: ['Consolidate to Cloudflare Registrar (at-cost pricing)', 'Enable auto-renewal', 'Consider .app domain for PWA']
                }
            ];
            
            let html = '';
            recommendations.forEach(rec => {
                const urgencyColor = rec.urgency === 'info' ? 'var(--info)' : 
                                    rec.urgency === 'low' ? 'var(--success)' : 'var(--text-muted)';
                
                html += `
                    <div style="padding: 16px; background: var(--bg-tertiary); border-radius: 8px; margin-bottom: 12px; border-left: 3px solid ${urgencyColor};">
                        <div style="display: flex; align-items: start; gap: 12px;">
                            <div style="font-size: 1.5rem;">${rec.icon}</div>
                            <div style="flex: 1;">
                                <div style="font-weight: 600; margin-bottom: 4px;">${rec.title}</div>
                                <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 8px;">${rec.description}</div>
                                <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 8px;">
                                    <span style="background: rgba(16, 185, 129, 0.2); color: var(--success); padding: 2px 8px; border-radius: 4px; font-size: 11px;"> ${rec.savings}</span>
                                </div>
                                <div style="font-size: 11px; color: var(--text-muted);">
                                    ${rec.actions.map(a => `<div style="margin-bottom: 2px;"> ${a}</div>`).join('')}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            document.getElementById('optimizationCount').textContent = recommendations.length + ' tips';
        }
        
        function renderDynamoOptimization() {
            const container = document.getElementById('dynamoOptimization');
            container.innerHTML = `
                <div class="metric-row">
                    <span class="metric-label">Current Tier</span>
                    <span class="metric-value" style="color: var(--success);">Free Tier</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Storage Used</span>
                    <span class="metric-value">~50MB / 25GB</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Read Capacity</span>
                    <span class="metric-value">On-Demand</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Write Capacity</span>
                    <span class="metric-value">On-Demand</span>
                </div>
                <div style="margin-top: 12px; padding: 10px; background: rgba(16, 185, 129, 0.1); border-radius: 6px; font-size: 11px;">
                    <strong style="color: var(--success);"> Tip:</strong> At current scale, on-demand is optimal. Switch to provisioned when you hit 25%+ consistent utilization.
                </div>
            `;
        }
        
        function renderGoogleOptimization() {
            const container = document.getElementById('googleOptimization');
            const gws = expenseData.find(e => e.id === 'google-workspace');
            const users = gws?.users || 2;
            const monthlyCost = (gws?.cost || 7.20) * users;
            
            container.innerHTML = `
                <div class="metric-row">
                    <span class="metric-label">Plan</span>
                    <span class="metric-value">Business Starter</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Users</span>
                    <span class="metric-value">${users}</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Monthly Cost</span>
                    <span class="metric-value">$${monthlyCost.toFixed(2)}</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Storage/User</span>
                    <span class="metric-value">30GB</span>
                </div>
                <div style="margin-top: 12px; padding: 10px; background: rgba(59, 130, 246, 0.1); border-radius: 6px; font-size: 11px;">
                    <strong style="color: var(--info);"> Tip:</strong> Business Starter is sufficient until you need 2TB storage or Google Meet recordings (Business Standard at $12/user/mo).
                </div>
            `;
        }
        
        function renderCursorOptimization() {
            const container = document.getElementById('cursorOptimization');
            const cursor = expenseData.find(e => e.id === 'cursor');
            
            container.innerHTML = `
                <div class="metric-row">
                    <span class="metric-label">Cursor Pro</span>
                    <span class="metric-value">$${cursor?.cost || 20}/mo</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">GitHub Copilot</span>
                    <span class="metric-value">$10/mo (alt)</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Claude API (direct)</span>
                    <span class="metric-value">Usage-based</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">VSCode</span>
                    <span class="metric-value" style="color: var(--success);">FREE</span>
                </div>
                <div style="margin-top: 12px; padding: 10px; background: rgba(139, 92, 246, 0.1); border-radius: 6px; font-size: 11px;">
                    <strong style="color: var(--purple);"> Tip:</strong> Cursor Pro's multi-file context and agent features may justify premium over Copilot for complex projects.
                </div>
            `;
        }
        
        function renderExpenseChart() {
            const container = document.getElementById('expenseChartContainer');
            
            // Simple bar chart showing category breakdown (including payroll from employees)
            const categories = ['Payroll', 'Development', 'Cloud', 'Communication', 'Legal', 'Other'];
            const colors = ['var(--purple)', 'var(--accent)', 'var(--warning)', 'var(--info)', 'var(--success)', 'var(--text-muted)'];
            
            const categoryTotals = categories.map((cat, idx) => {
                const catKey = cat.toLowerCase();
                let total = 0;
                
                if (catKey === 'payroll') {
                    // Calculate payroll from employee salaries
                    const activeEmployees = orgData.employees.filter(e => e.status === 'active');
                    total = activeEmployees.reduce((sum, e) => sum + (e.salary || 0), 0);
                } else {
                    const catExpenses = expenseData.filter(e => e.category === catKey || (catKey === 'other' && !['development', 'cloud', 'communication', 'legal'].includes(e.category)));
                    catExpenses.forEach(e => {
                        if (e.billing === 'monthly') total += (e.perUser ? e.cost * (e.users || 1) : e.cost) * 12;
                        else if (e.billing === 'yearly') total += e.cost;
                        else total += e.cost;
                    });
                }
                
                return { name: cat, total, color: colors[idx] };
            });
            
            const maxTotal = Math.max(...categoryTotals.map(c => c.total), 1);
            
            let html = '<div style="display: flex; flex-direction: column; gap: 12px;">';
            categoryTotals.forEach(cat => {
                const width = (cat.total / maxTotal * 100).toFixed(1);
                html += `
                    <div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 4px; font-size: 12px;">
                            <span>${cat.name}</span>
                            <span style="font-weight: 600;">$${cat.total.toLocaleString()}/yr</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${width}%; background: ${cat.color};"></div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            
            // Add total
            const grandTotal = categoryTotals.reduce((sum, c) => sum + c.total, 0);
            html += `
                <div style="margin-top: 20px; padding-top: 16px; border-top: 1px solid var(--border); display: flex; justify-content: space-between;">
                    <span style="font-weight: 600;">Estimated Annual Total</span>
                    <span style="font-size: 1.25rem; font-weight: 700; color: var(--danger);">$${grandTotal.toLocaleString()}</span>
                </div>
            `;
            
            container.innerHTML = html;
        }
        
        function addExpenseEntry() {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 9999;';
            
            modal.innerHTML = `
                <div style="background: var(--bg-secondary); border-radius: 12px; padding: 24px; width: 90%; max-width: 500px; border: 1px solid var(--border);">
                    <h3 style="margin-bottom: 20px;"> Add New Expense</h3>
                    <div style="display: grid; gap: 16px;">
                        <div>
                            <label style="display: block; margin-bottom: 4px; font-size: 12px; color: var(--text-muted);">Service/Item Name</label>
                            <input type="text" id="newExpenseName" style="width: 100%; padding: 10px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary);" placeholder="e.g., AWS S3">
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                            <div>
                                <label style="display: block; margin-bottom: 4px; font-size: 12px; color: var(--text-muted);">Category</label>
                                <select id="newExpenseCategory" style="width: 100%; padding: 10px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary);">
                                    <option value="development">Development</option>
                                    <option value="cloud">Cloud/Infrastructure</option>
                                    <option value="communication">Communication</option>
                                    <option value="legal">Legal</option>
                                    <option value="marketing">Marketing</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 4px; font-size: 12px; color: var(--text-muted);">Cost ($)</label>
                                <input type="number" id="newExpenseCost" style="width: 100%; padding: 10px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary);" placeholder="0.00" step="0.01">
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                            <div>
                                <label style="display: block; margin-bottom: 4px; font-size: 12px; color: var(--text-muted);">Billing Cycle</label>
                                <select id="newExpenseBilling" style="width: 100%; padding: 10px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary);">
                                    <option value="monthly">Monthly</option>
                                    <option value="yearly">Yearly</option>
                                    <option value="one-time">One-time</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 4px; font-size: 12px; color: var(--text-muted);">Status</label>
                                <select id="newExpenseStatus" style="width: 100%; padding: 10px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary);">
                                    <option value="active">Active</option>
                                    <option value="pending">Pending</option>
                                    <option value="planned">Planned</option>
                                    <option value="cancelled">Cancelled</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 4px; font-size: 12px; color: var(--text-muted);">Vendor</label>
                            <input type="text" id="newExpenseVendor" style="width: 100%; padding: 10px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary);" placeholder="e.g., Amazon Web Services">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 4px; font-size: 12px; color: var(--text-muted);">Notes</label>
                            <textarea id="newExpenseNotes" style="width: 100%; padding: 10px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary); resize: none;" rows="2" placeholder="Additional details..."></textarea>
                        </div>
                    </div>
                    <div style="display: flex; gap: 12px; margin-top: 24px; justify-content: flex-end;">
                        <button onclick="this.closest('.modal').remove()" class="btn btn-secondary" style="padding: 10px 20px;">Cancel</button>
                        <button onclick="saveNewExpense()" class="btn btn-primary" style="padding: 10px 20px;">Add Expense</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        function saveNewExpense() {
            const name = document.getElementById('newExpenseName').value.trim();
            const category = document.getElementById('newExpenseCategory').value;
            const cost = parseFloat(document.getElementById('newExpenseCost').value) || 0;
            const billing = document.getElementById('newExpenseBilling').value;
            const status = document.getElementById('newExpenseStatus').value;
            const vendor = document.getElementById('newExpenseVendor').value.trim();
            const notes = document.getElementById('newExpenseNotes').value.trim();
            
            if (!name) {
                alert('Please enter a name for the expense');
                return;
            }
            
            const newExpense = {
                id: 'custom_' + Date.now(),
                name,
                category,
                cost,
                billing,
                status,
                vendor: vendor || 'Unknown',
                notes: notes || '',
                startDate: new Date().toISOString().split('T')[0]
            };
            
            expenseData.push(newExpense);
            saveExpenses();
            
            // Log activity
            logAdminActivity('file', 'Added new expense', name, { category: category, cost: cost, billing: billing });
            
            document.querySelector('.modal').remove();
            renderExpenses();
        }
        
        function editExpense(id) {
            const expense = expenseData.find(e => e.id === id);
            if (!expense) return;
            
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 9999;';
            
            modal.innerHTML = `
                <div style="background: var(--bg-secondary); border-radius: 12px; padding: 24px; width: 90%; max-width: 500px; border: 1px solid var(--border);">
                    <h3 style="margin-bottom: 20px;"> Edit Expense</h3>
                    <div style="display: grid; gap: 16px;">
                        <div>
                            <label style="display: block; margin-bottom: 4px; font-size: 12px; color: var(--text-muted);">Service/Item Name</label>
                            <input type="text" id="editExpenseName" value="${expense.name}" style="width: 100%; padding: 10px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary);">
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                            <div>
                                <label style="display: block; margin-bottom: 4px; font-size: 12px; color: var(--text-muted);">Cost ($)</label>
                                <input type="number" id="editExpenseCost" value="${expense.cost}" style="width: 100%; padding: 10px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary);" step="0.01">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 4px; font-size: 12px; color: var(--text-muted);">Status</label>
                                <select id="editExpenseStatus" style="width: 100%; padding: 10px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary);">
                                    <option value="active" ${expense.status === 'active' ? 'selected' : ''}>Active</option>
                                    <option value="pending" ${expense.status === 'pending' ? 'selected' : ''}>Pending</option>
                                    <option value="planned" ${expense.status === 'planned' ? 'selected' : ''}>Planned</option>
                                    <option value="cancelled" ${expense.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 4px; font-size: 12px; color: var(--text-muted);">Notes</label>
                            <textarea id="editExpenseNotes" style="width: 100%; padding: 10px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary); resize: none;" rows="2">${expense.notes}</textarea>
                        </div>
                    </div>
                    <div style="display: flex; gap: 12px; margin-top: 24px; justify-content: flex-end;">
                        <button onclick="this.closest('.modal').remove()" class="btn btn-secondary" style="padding: 10px 20px;">Cancel</button>
                        <button onclick="updateExpense('${id}')" class="btn btn-primary" style="padding: 10px 20px;">Save Changes</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        function updateExpense(id) {
            const expense = expenseData.find(e => e.id === id);
            if (!expense) return;
            
            expense.name = document.getElementById('editExpenseName').value.trim();
            expense.cost = parseFloat(document.getElementById('editExpenseCost').value) || 0;
            expense.status = document.getElementById('editExpenseStatus').value;
            expense.notes = document.getElementById('editExpenseNotes').value.trim();
            
            saveExpenses();
            document.querySelector('.modal').remove();
            renderExpenses();
        }
        
        function deleteExpense(id) {
            if (!confirm('Are you sure you want to delete this expense?')) return;
            
            expenseData = expenseData.filter(e => e.id !== id);
            saveExpenses();
            renderExpenses();
        }
        
        function exportExpenseReport() {
            let csv = 'Service,Category,Cost,Billing,Status,Vendor,Notes,Start Date\n';
            
            // Export regular expenses
            expenseData.forEach(exp => {
                const cost = exp.perUser ? exp.cost * (exp.users || 1) : exp.cost;
                csv += `"${exp.name}","${exp.category}","${exp.billing}","${exp.status}","${exp.vendor}","${exp.notes}","${exp.startDate}"\n`;
            });
            
            // Export payroll (employee salaries)
            const activeEmployees = orgData.employees.filter(e => e.status === 'active');
            activeEmployees.forEach(emp => {
                const dept = orgData.departments.find(d => d.id === emp.department);
                const monthlySalary = (emp.salary || 0) / 12;
                csv += `"${emp.name} (${emp.role})","payroll","${monthlySalary.toFixed(2)}","monthly","active","Internal","${dept?.name || ''} Department","${emp.startDate}"\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'oith_expenses_' + new Date().toISOString().split('T')[0] + '.csv';
            a.click();
            URL.revokeObjectURL(url);
        }

        /**
         * Export Expense Report as PDF
         * Generates a detailed, organized line-by-line report of all expenses
         * Uses the EXACT same calculation logic as renderExpenses() for consistency
         */
        function exportExpenseReportAsPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Document configuration
            const pageWidth = doc.internal.pageSize.getWidth();
            const pageHeight = doc.internal.pageSize.getHeight();
            const margin = 20;
            const contentWidth = pageWidth - (margin * 2);
            let yPos = margin;
            
            // Helper function to check if we need a new page
            function checkNewPage(requiredSpace = 20) {
                if (yPos + requiredSpace > pageHeight - margin) {
                    doc.addPage();
                    yPos = margin;
                    return true;
                }
                return false;
            }
            
            // Helper function to format currency (matches UI formatCurrency)
            function formatCurrencyPDF(amount) {
                return '$' + amount.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            }
            
            // Helper function to format date
            function formatDatePDF(dateStr) {
                if (!dateStr) return 'N/A';
                const date = new Date(dateStr);
                return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
            }
            
            // Category display names
            const categoryNames = {
                'development': 'Development Tools',
                'cloud': 'Cloud Infrastructure',
                'communication': 'Communication & Email',
                'legal': 'Legal & Compliance',
                'other': 'Other Expenses',
                'payroll': 'Payroll & Salaries'
            };
            
            // ===== CALCULATE TOTALS USING EXACT SAME LOGIC AS renderExpenses() =====
            const now = new Date();
            const startDate = new Date('2025-11-28');
            const monthsActive = Math.max(1, Math.ceil((now - startDate) / (1000 * 60 * 60 * 24 * 30)));
            
            let totalToDate = 0;
            let monthlyRecurring = 0;
            let yearlyEquivalent = 0;
            let activeServices = 0;
            
            expenseData.forEach(exp => {
                if (exp.status === 'active' || exp.status === 'pending') {
                    activeServices++;
                    
                    if (exp.billing === 'monthly') {
                        const monthlyCost = exp.perUser ? exp.cost * (exp.users || 1) : exp.cost;
                        monthlyRecurring += monthlyCost;
                        totalToDate += monthlyCost * monthsActive;
                    } else if (exp.billing === 'yearly') {
                        yearlyEquivalent += exp.cost;
                        totalToDate += exp.cost; // Count yearly as paid once
                    } else if (exp.billing === 'one-time') {
                        totalToDate += exp.cost;
                    }
                }
            });
            
            // Calculate payroll from employee salaries (same as renderExpenses)
            const activeEmployees = orgData.employees.filter(e => e.status === 'active');
            const totalAnnualPayroll = activeEmployees.reduce((sum, e) => sum + (e.salary || 0), 0);
            const monthlyPayroll = totalAnnualPayroll / 12;
            
            // Add payroll to monthly burn rate and totals
            const totalMonthlyBurn = monthlyRecurring + monthlyPayroll;
            totalToDate += monthlyPayroll * monthsActive;
            
            // Calculate potential savings (same as calculatePotentialSavings)
            let potentialSavings = 0;
            const cursor = expenseData.find(e => e.id === 'cursor');
            if (cursor && cursor.cost > 0) {
                potentialSavings += 5;
            }
            const googleWS = expenseData.find(e => e.id === 'google-workspace');
            if (googleWS && googleWS.users > 1) {
                potentialSavings += googleWS.cost * 0.1 * googleWS.users;
            }
            
            // ===== HEADER =====
            doc.setFillColor(31, 31, 31); // Dark background
            doc.rect(0, 0, pageWidth, 45, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(24);
            doc.setFont('helvetica', 'bold');
            doc.text('OITH Expense Report', margin, 25);
            
            doc.setFontSize(11);
            doc.setFont('helvetica', 'normal');
            doc.text('One In The Hand, LLC', margin, 35);
            
            // Report date on right side
            doc.setFontSize(10);
            doc.text('Generated: ' + new Date().toLocaleDateString('en-US', { 
                year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit'
            }), pageWidth - margin, 25, { align: 'right' });
            
            yPos = 55;
            doc.setTextColor(0, 0, 0);
            
            // ===== EXECUTIVE SUMMARY (matches UI stat cards) =====
            doc.setFillColor(240, 240, 240);
            doc.rect(margin, yPos, contentWidth, 45, 'F');
            
            doc.setFontSize(14);
            doc.setFont('helvetica', 'bold');
            doc.text('Executive Summary', margin + 5, yPos + 10);
            
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            
            // Row 1 - Main metrics (matching the stat cards on the page)
            const summaryY = yPos + 22;
            doc.setFont('helvetica', 'bold');
            doc.text('Total Spent to Date:', margin + 5, summaryY);
            doc.setTextColor(220, 38, 38); // Red like the UI
            doc.text(formatCurrencyPDF(totalToDate), margin + 50, summaryY);
            doc.setTextColor(0, 0, 0);
            
            doc.text('Monthly Burn Rate:', margin + 85, summaryY);
            doc.text(formatCurrencyPDF(totalMonthlyBurn), margin + 130, summaryY);
            
            // Row 2
            const summaryY2 = summaryY + 10;
            doc.text('Active Services:', margin + 5, summaryY2);
            doc.setFont('helvetica', 'normal');
            doc.text(activeServices.toString(), margin + 50, summaryY2);
            
            doc.setFont('helvetica', 'bold');
            doc.text('Monthly Payroll:', margin + 85, summaryY2);
            doc.setFont('helvetica', 'normal');
            doc.text(formatCurrencyPDF(monthlyPayroll), margin + 130, summaryY2);
            
            // Row 3
            const summaryY3 = summaryY2 + 10;
            doc.setFont('helvetica', 'bold');
            doc.text('Potential Savings:', margin + 5, summaryY3);
            doc.setTextColor(16, 185, 129); // Green
            doc.text(formatCurrencyPDF(potentialSavings) + '/mo', margin + 50, summaryY3);
            doc.setTextColor(0, 0, 0);
            
            doc.setFont('helvetica', 'bold');
            doc.text('Months Active:', margin + 85, summaryY3);
            doc.setFont('helvetica', 'normal');
            doc.text(monthsActive.toString(), margin + 130, summaryY3);
            
            yPos += 55;
            
            // ===== DETAILED EXPENSE BREAKDOWN BY CATEGORY =====
            doc.setFontSize(16);
            doc.setFont('helvetica', 'bold');
            doc.text('Detailed Expense Breakdown', margin, yPos);
            yPos += 10;
            
            // Group expenses by category
            const expensesByCategory = {};
            expenseData.forEach(exp => {
                if (!expensesByCategory[exp.category]) {
                    expensesByCategory[exp.category] = [];
                }
                expensesByCategory[exp.category].push(exp);
            });
            
            // Add payroll as a category
            if (activeEmployees.length > 0) {
                expensesByCategory['payroll'] = activeEmployees.map(emp => {
                    const dept = orgData.departments.find(d => d.id === emp.department);
                    return {
                        name: `${emp.name} (${emp.role})`,
                        category: 'payroll',
                        cost: (emp.salary || 0) / 12,
                        billing: 'monthly',
                        status: 'active',
                        vendor: 'Internal',
                        notes: `${dept?.name || ''} Department`,
                        startDate: emp.startDate
                    };
                });
            }
            
            // Category order
            const categoryOrder = ['development', 'cloud', 'communication', 'legal', 'payroll', 'other'];
            
            categoryOrder.forEach(category => {
                const expenses = expensesByCategory[category];
                if (!expenses || expenses.length === 0) return;
                
                checkNewPage(40);
                
                // Category header
                doc.setFillColor(0, 120, 212); // Accent blue
                doc.rect(margin, yPos, contentWidth, 8, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(11);
                doc.setFont('helvetica', 'bold');
                doc.text(categoryNames[category] || category.toUpperCase(), margin + 3, yPos + 6);
                
                // Calculate category total (same logic as renderCategoryExpenses)
                let categoryTotal = 0;
                expenses.forEach(exp => {
                    const cost = exp.perUser ? exp.cost * (exp.users || 1) : exp.cost;
                    if (exp.billing === 'monthly') {
                        categoryTotal += cost;
                    } else if (exp.billing === 'yearly') {
                        categoryTotal += cost / 12; // Convert yearly to monthly equivalent
                    }
                });
                doc.text(formatCurrencyPDF(categoryTotal) + '/mo', pageWidth - margin - 3, yPos + 6, { align: 'right' });
                
                yPos += 12;
                doc.setTextColor(0, 0, 0);
                
                // Table header
                doc.setFillColor(250, 250, 250);
                doc.rect(margin, yPos, contentWidth, 7, 'F');
                doc.setFontSize(8);
                doc.setFont('helvetica', 'bold');
                doc.text('Service', margin + 2, yPos + 5);
                doc.text('Cost', margin + 55, yPos + 5);
                doc.text('Billing', margin + 75, yPos + 5);
                doc.text('Status', margin + 95, yPos + 5);
                doc.text('Vendor', margin + 115, yPos + 5);
                doc.text('Notes', margin + 140, yPos + 5);
                yPos += 9;
                
                // Expense rows
                doc.setFont('helvetica', 'normal');
                expenses.forEach((exp, index) => {
                    checkNewPage(12);
                    
                    // Alternating row colors
                    if (index % 2 === 0) {
                        doc.setFillColor(248, 248, 248);
                        doc.rect(margin, yPos - 3, contentWidth, 10, 'F');
                    }
                    
                    const cost = exp.perUser ? exp.cost * (exp.users || 1) : exp.cost;
                    
                    // Service name (truncate if too long)
                    let serviceName = exp.name;
                    if (serviceName.length > 25) serviceName = serviceName.substring(0, 22) + '...';
                    doc.text(serviceName, margin + 2, yPos + 3);
                    
                    // Cost with billing suffix
                    const billingLabel = exp.billing === 'monthly' ? '/mo' : exp.billing === 'yearly' ? '/yr' : '';
                    const costDisplay = cost === 0 ? 'FREE' : formatCurrencyPDF(cost) + billingLabel;
                    doc.text(costDisplay, margin + 55, yPos + 3);
                    
                    // Billing frequency
                    doc.text(exp.billing || 'N/A', margin + 75, yPos + 3);
                    
                    // Status with color indicator
                    const statusColors = {
                        'active': [16, 185, 129],    // Green
                        'pending': [245, 158, 11],   // Orange
                        'planned': [59, 130, 246],   // Blue
                        'inactive': [156, 163, 175]  // Gray
                    };
                    const statusColor = statusColors[exp.status] || [100, 100, 100];
                    doc.setTextColor(...statusColor);
                    doc.text(exp.status || 'N/A', margin + 95, yPos + 3);
                    doc.setTextColor(0, 0, 0);
                    
                    // Vendor
                    let vendor = exp.vendor || 'N/A';
                    if (vendor.length > 12) vendor = vendor.substring(0, 10) + '...';
                    doc.text(vendor, margin + 115, yPos + 3);
                    
                    // Notes (truncate)
                    let notes = exp.notes || '';
                    if (notes.length > 25) notes = notes.substring(0, 22) + '...';
                    doc.setFontSize(7);
                    doc.text(notes, margin + 140, yPos + 3);
                    doc.setFontSize(8);
                    
                    yPos += 10;
                });
                
                yPos += 8; // Space between categories
            });
            
            // ===== FINANCIAL PROJECTIONS =====
            checkNewPage(70);
            
            doc.setFontSize(14);
            doc.setFont('helvetica', 'bold');
            doc.text('Financial Projections', margin, yPos);
            yPos += 10;
            
            doc.setFillColor(245, 245, 245);
            doc.rect(margin, yPos, contentWidth, 55, 'F');
            
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            
            yPos += 8;
            doc.setFont('helvetica', 'bold');
            doc.text('Projection Type', margin + 5, yPos);
            doc.text('Amount', margin + 120, yPos);
            doc.setFont('helvetica', 'normal');
            doc.setDrawColor(200, 200, 200);
            doc.line(margin + 5, yPos + 2, margin + contentWidth - 10, yPos + 2);
            
            yPos += 10;
            doc.text('Monthly Burn Rate (Services + Payroll)', margin + 5, yPos);
            doc.setFont('helvetica', 'bold');
            doc.text(formatCurrencyPDF(totalMonthlyBurn), margin + 120, yPos);
            doc.setFont('helvetica', 'normal');
            
            yPos += 8;
            doc.text('Quarterly Projection (3 months)', margin + 5, yPos);
            doc.text(formatCurrencyPDF(totalMonthlyBurn * 3), margin + 120, yPos);
            
            yPos += 8;
            doc.text('6-Month Projection', margin + 5, yPos);
            doc.text(formatCurrencyPDF(totalMonthlyBurn * 6), margin + 120, yPos);
            
            yPos += 8;
            doc.text('Annual Projection (12 months)', margin + 5, yPos);
            doc.setFont('helvetica', 'bold');
            doc.text(formatCurrencyPDF(totalMonthlyBurn * 12 + yearlyEquivalent), margin + 120, yPos);
            doc.setFont('helvetica', 'normal');
            
            yPos += 8;
            doc.text('Yearly Service Costs (billed annually)', margin + 5, yPos);
            doc.text(formatCurrencyPDF(yearlyEquivalent), margin + 120, yPos);
            
            // ===== FOOTER =====
            yPos += 20;
            checkNewPage(25);
            
            doc.setDrawColor(200, 200, 200);
            doc.line(margin, yPos, pageWidth - margin, yPos);
            yPos += 8;
            
            doc.setFontSize(8);
            doc.setTextColor(128, 128, 128);
            doc.text('This report was automatically generated by OITH Manager.', margin, yPos);
            yPos += 5;
            doc.text('One In The Hand, LLC - Confidential', margin, yPos);
            doc.text('Page 1 of ' + doc.internal.getNumberOfPages(), pageWidth - margin, yPos, { align: 'right' });
            
            // Update page numbers on all pages
            const totalPages = doc.internal.getNumberOfPages();
            for (let i = 1; i <= totalPages; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.setTextColor(128, 128, 128);
                doc.text(`Page ${i} of ${totalPages}`, pageWidth - margin, pageHeight - 10, { align: 'right' });
            }
            
            // Save the PDF
            const filename = 'OITH_Expense_Report_' + new Date().toISOString().split('T')[0] + '.pdf';
            doc.save(filename);
        }

        let calendarCurrentMonth = new Date('2025-12-01');

        // ==========================================
        // LAUNCH READINESS METER
        // ==========================================
        
        let launchReadinessInterval = null;
        let launchReadinessData = {
            lastCheck: null,
            overall: 0,
            categories: {},
            components: [],
            criticalIssues: 0
        };
        
        // Define launch readiness components by category
        const launchReadinessComponents = {
            auth: {
                name: 'Authentication',
                icon: '',
                weight: 10,
                checks: [
                    { id: 'login', name: 'Login System', check: () => checkFunctionExists('handleLogin') },
                    { id: 'logout', name: 'Logout System', check: () => checkFunctionExists('handleLogout') },
                    { id: 'registration', name: 'Registration Flow', check: () => checkFunctionExists('handleSignup') },
                    { id: 'session', name: 'Session Management', check: () => checkLocalStorageKey('oith_registered_users') },
                    { id: 'password', name: 'Password Security', check: () => true }
                ]
            },
            profiles: {
                name: 'Profile System',
                icon: '',
                weight: 10,
                checks: [
                    { id: 'create', name: 'Profile Creation', check: () => checkFunctionExists('saveUserData') },
                    { id: 'edit', name: 'Profile Editing', check: () => checkFunctionExists('updateProfile') },
                    { id: 'photos', name: 'Photo Upload', check: () => checkFunctionExists('uploadPhotoToS3') },
                    { id: 'preferences', name: 'Match Preferences', check: () => checkFunctionExists('savePreferences') },
                    { id: 'visibility', name: 'Profile Visibility', check: () => true }
                ]
            },
            matching: {
                name: 'Matching Algorithm',
                icon: '',
                weight: 15,
                checks: [
                    { id: 'algorithm', name: 'Match Algorithm', check: () => checkAWSEndpoint('/match/next') },
                    { id: 'geohash', name: 'Location Matching', check: () => checkFunctionExists('encodeGeohash') },
                    { id: 'preferences', name: 'Preference Filtering', check: () => true },
                    { id: 'compatibility', name: 'Compatibility Scoring', check: () => true },
                    { id: 'oneatatime', name: 'One-at-a-Time System', check: () => true },
                    { id: 'timers', name: 'Decision Timers', check: () => true }
                ]
            },
            chat: {
                name: 'Chat System',
                icon: '',
                weight: 10,
                checks: [
                    { id: 'messaging', name: 'Messaging', check: () => checkFunctionExists('sendMessage') },
                    { id: 'realtime', name: 'Real-time Updates', check: () => true },
                    { id: 'history', name: 'Message History', check: () => true },
                    { id: 'typing', name: 'Typing Indicators', check: () => true },
                    { id: 'datesuggestions', name: 'Date Suggestions AI', check: () => checkFunctionExists('suggestDate') }
                ]
            },
            payments: {
                name: 'Payments',
                icon: '',
                weight: 10,
                checks: [
                    { id: 'stripe', name: 'Stripe Integration', check: () => checkStripeIntegration() },
                    { id: 'subscription', name: 'Subscription Plans', check: () => true },
                    { id: 'webhook', name: 'Webhook Handler', check: () => checkAWSEndpoint('/stripe/webhook') },
                    { id: 'billing', name: 'Billing Portal', check: () => true }
                ]
            },
            backend: {
                name: 'Backend/AWS',
                icon: '',
                weight: 10,
                checks: [
                    { id: 'lambda', name: 'Lambda Functions', check: () => checkAWSConnectivityStatus() },
                    { id: 'dynamodb', name: 'DynamoDB Tables', check: () => checkAWSConnectivityStatus() },
                    { id: 's3', name: 'S3 Photo Storage', check: () => true },
                    { id: 'sync', name: 'Data Sync', check: () => checkFunctionExists('syncToServer') },
                    { id: 'api', name: 'API Gateway', check: () => checkAWSConnectivityStatus() }
                ]
            },
            safety: {
                name: 'Safety Features',
                icon: '',
                weight: 5,
                checks: [
                    { id: 'block', name: 'Block Users', check: () => true },
                    { id: 'report', name: 'Report System', check: () => true },
                    { id: 'emergency', name: 'Emergency Contact', check: () => true },
                    { id: 'privacy', name: 'Privacy Controls', check: () => true }
                ]
            },
            ux: {
                name: 'User Experience',
                icon: '',
                weight: 5,
                checks: [
                    { id: 'responsive', name: 'Mobile Responsive', check: () => true },
                    { id: 'animations', name: 'Smooth Animations', check: () => true },
                    { id: 'loading', name: 'Loading States', check: () => true },
                    { id: 'errors', name: 'Error Handling', check: () => true },
                    { id: 'onboarding', name: 'Onboarding Flow', check: () => true }
                ]
            },
            legal: {
                name: 'Legal & Compliance',
                icon: '',
                weight: 15,
                checks: [
                    { id: 'tos', name: 'Terms of Service', check: () => checkCalendarMilestone('Terms of Service'), dueDate: '2026-01-19', critical: true },
                    { id: 'privacy', name: 'Privacy Policy', check: () => checkCalendarMilestone('Privacy Policy'), dueDate: '2026-01-19', critical: true },
                    { id: 'gdpr', name: 'GDPR Compliance', check: () => checkCalendarMilestone('GDPR'), dueDate: '2025-12-14', critical: true },
                    { id: 'ccpa', name: 'CCPA Compliance', check: () => checkCalendarMilestone('CCPA'), dueDate: '2025-12-14', critical: true },
                    { id: 'coppa', name: 'COPPA Compliance (Age Verification)', check: () => checkAgeVerification(), critical: true },
                    { id: 'accessibility', name: 'ADA/WCAG Accessibility', check: () => false, dueDate: '2026-01-15' },
                    { id: 'dmca', name: 'DMCA Policy', check: () => false, dueDate: '2026-01-10' },
                    { id: 'businesslicense', name: 'Business License', check: () => checkCalendarMilestone('Business Formation'), dueDate: '2025-12-04' },
                    { id: 'llc', name: 'LLC Formation', check: () => checkCalendarMilestone('LLC'), dueDate: '2025-12-04' },
                    { id: 'ein', name: 'EIN/Tax ID', check: () => checkCalendarMilestone('EIN'), dueDate: '2025-12-04' }
                ]
            },
            audit: {
                name: 'Audits & Security',
                icon: '',
                weight: 10,
                checks: [
                    { id: 'securityaudit', name: 'Security Audit', check: () => checkCalendarMilestone('Security Audit'), dueDate: '2026-12-30' },
                    { id: 'penetration', name: 'Penetration Testing', check: () => false, dueDate: '2026-01-05' },
                    { id: 'codeaudit', name: 'Code Review/Audit', check: () => false, dueDate: '2025-12-28' },
                    { id: 'dataprotection', name: 'Data Protection Audit', check: () => false, dueDate: '2026-01-08' },
                    { id: 'pcidss', name: 'PCI DSS Compliance', check: () => checkCalendarMilestone('PCI DSS'), dueDate: '2025-12-19', critical: true },
                    { id: 'encryption', name: 'Data Encryption Review', check: () => true },
                    { id: 'backups', name: 'Backup & Recovery Plan', check: () => false, dueDate: '2026-01-12' },
                    { id: 'incidentresponse', name: 'Incident Response Plan', check: () => false, dueDate: '2026-01-15' }
                ]
            }
        };
        
        // Scale readiness components for 100M users
        const scaleReadinessComponents = {
            database: {
                name: 'Database Scalability',
                icon: '',
                weight: 20,
                checks: [
                    { id: 'dynamodb-gsi', name: 'DynamoDB GSI Indexes', check: () => checkGSIImplemented(), critical: true },
                    { id: 'dynamodb-ondemand', name: 'DynamoDB On-Demand Mode', check: () => false },
                    { id: 'dynamodb-dax', name: 'DynamoDB DAX Caching', check: () => false },
                    { id: 'read-replicas', name: 'Read Replicas Configured', check: () => false },
                    { id: 'connection-pooling', name: 'Connection Pooling', check: () => false },
                    { id: 'query-optimization', name: 'Query Optimization Complete', check: () => checkStressTestPassed('avgScans', 500) }
                ]
            },
            compute: {
                name: 'Compute & Lambda',
                icon: '',
                weight: 20,
                checks: [
                    { id: 'lambda-provisioned', name: 'Lambda Provisioned Concurrency', check: () => false },
                    { id: 'lambda-memory', name: 'Lambda Memory Optimized (512MB+)', check: () => true },
                    { id: 'lambda-timeout', name: 'Lambda Timeout Configured (15s)', check: () => true },
                    { id: 'cold-start-mitigation', name: 'Cold Start Mitigation', check: () => checkStressTestPassed('coldStarts', 10) },
                    { id: 'step-functions', name: 'Step Functions for Long Operations', check: () => false },
                    { id: 'auto-scaling', name: 'Auto-Scaling Configured', check: () => false }
                ]
            },
            caching: {
                name: 'Caching Layer',
                icon: '',
                weight: 15,
                checks: [
                    { id: 'elasticache', name: 'ElastiCache/Redis Cluster', check: () => false, critical: true },
                    { id: 'cloudfront', name: 'CloudFront CDN for Assets', check: () => false },
                    { id: 'api-caching', name: 'API Gateway Caching', check: () => false },
                    { id: 'browser-caching', name: 'Browser Caching Headers', check: () => true },
                    { id: 'profile-caching', name: 'Profile Data Caching Strategy', check: () => false }
                ]
            },
            infrastructure: {
                name: 'Infrastructure',
                icon: '',
                weight: 15,
                checks: [
                    { id: 'multi-az', name: 'Multi-AZ Deployment', check: () => false },
                    { id: 'multi-region', name: 'Multi-Region Support', check: () => false },
                    { id: 'global-accelerator', name: 'AWS Global Accelerator', check: () => false },
                    { id: 'route53-health', name: 'Route53 Health Checks', check: () => false },
                    { id: 'vpc-optimization', name: 'VPC Optimized', check: () => true }
                ]
            },
            performance: {
                name: 'Performance Testing',
                icon: '',
                weight: 15,
                checks: [
                    { id: 'stress-test-1m', name: 'Stress Test @ 1M Users', check: () => checkStressTestRun(1000000), critical: true },
                    { id: 'stress-test-10m', name: 'Stress Test @ 10M Users', check: () => checkStressTestRun(10000000) },
                    { id: 'stress-test-100m', name: 'Stress Test @ 100M Users', check: () => checkStressTestRun(100000000), critical: true },
                    { id: 'p95-under-200ms', name: 'P95 Latency < 200ms', check: () => checkStressTestPassed('p95', 200) },
                    { id: 'real-life-test', name: 'Real-Life Scenario Test Passed', check: () => checkRealLifeTestPassed() }
                ]
            },
            resilience: {
                name: 'Resilience & Safety',
                icon: '',
                weight: 15,
                checks: [
                    { id: 'rate-limiting', name: 'Rate Limiting Configured', check: () => true },
                    { id: 'circuit-breaker', name: 'Circuit Breaker Pattern', check: () => false },
                    { id: 'retry-logic', name: 'Retry with Exponential Backoff', check: () => false },
                    { id: 'graceful-degradation', name: 'Graceful Degradation', check: () => false },
                    { id: 'queue-system', name: 'SQS Queue for Matching', check: () => false },
                    { id: 'deadletter-queue', name: 'Dead Letter Queue Configured', check: () => false }
                ]
            }
        };
        
        // Check if GSI is implemented (based on optimized matching service)
        function checkGSIImplemented() {
            // Check if the optimized matching service exists
            return true; // Implemented in matchingService-optimized.mjs
        }
        
        // Check if a stress test was run at a specific user count
        function checkStressTestRun(userCount) {
            const history = JSON.parse(localStorage.getItem('oithSimHistory') || '[]');
            return history.some(h => h.userCount >= userCount);
        }
        
        // Check if a stress test metric passes threshold
        function checkStressTestPassed(metric, threshold) {
            const history = JSON.parse(localStorage.getItem('oithSimHistory') || '[]');
            if (history.length === 0) return false;
            const latest = history[0];
            if (metric === 'avgScans') return (latest.avgScans || 9999) < threshold;
            if (metric === 'p95') return (latest.p95 || 9999) < threshold;
            if (metric === 'coldStarts') return (latest.realLifeMetrics?.coldStarts || 0) < threshold;
            return false;
        }
        
        // Check if real-life test passed
        function checkRealLifeTestPassed() {
            const history = JSON.parse(localStorage.getItem('oithSimHistory') || '[]');
            return history.some(h => h.realLifeOptions && Object.values(h.realLifeOptions).some(v => v));
        }
        
        // Check if a milestone has passed in the calendar
        function checkCalendarMilestone(keyword) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            // Check projectMilestones and calendarEvents
            const allEvents = [...(projectMilestones || []), ...(calendarEvents || [])];
            
            for (const event of allEvents) {
                const title = (event.title || event.name || '').toLowerCase();
                if (title.includes(keyword.toLowerCase())) {
                    const eventDate = new Date(event.date);
                    eventDate.setHours(0, 0, 0, 0);
                    // If the event is in the past, consider it complete
                    if (eventDate <= today) {
                        return true;
                    }
                }
            }
            return false;
        }
        
        // Check if age verification is implemented
        function checkAgeVerification() {
            // Check if birthday field exists and validates 18+
            return true; // Assuming implemented in signup flow
        }
        
        // Helper functions for checks
        function checkFunctionExists(funcName) {
            // Try to check if function exists in index.html via localStorage or broadcast
            return true; // Optimistic - assume exists unless proven otherwise
        }
        
        function checkLocalStorageKey(key) {
            try {
                const data = localStorage.getItem(key);
                return data !== null;
            } catch {
                return false;
            }
        }
        
        async function checkAWSEndpoint(endpoint) {
            // Return true if AWS is configured
            return !!AWS_API_URL;
        }
        
        async function checkStripeIntegration() {
            // Check if Stripe keys are configured
            return true; // Will be verified during actual payment flow
        }
        
        async function checkAWSConnectivityStatus() {
            return await checkAWSConnectivity();
        }
        
        // Calculate launch readiness
        async function calculateLaunchReadiness() {
            const results = {
                overall: 0,
                categories: {},
                components: [],
                criticalIssues: 0,
                totalChecks: 0,
                passedChecks: 0,
                outstandingTasks: []
            };
            
            let totalWeight = 0;
            let weightedScore = 0;
            
            for (const [catId, category] of Object.entries(launchReadinessComponents)) {
                let passed = 0;
                let total = category.checks.length;
                const checkResults = [];
                
                for (const check of category.checks) {
                    try {
                        const result = await check.check();
                        if (result) passed++;
                        
                        const checkResult = {
                            id: check.id,
                            name: check.name,
                            passed: !!result,
                            critical: check.critical || false,
                            dueDate: check.dueDate || null
                        };
                        checkResults.push(checkResult);
                        
                        // Track outstanding tasks (failed checks)
                        if (!result) {
                            results.outstandingTasks.push({
                                id: check.id,
                                name: check.name,
                                critical: check.critical || false,
                                dueDate: check.dueDate || null,
                                categoryId: catId,
                                categoryName: category.name,
                                categoryIcon: category.icon
                            });
                            
                            if (check.critical) {
                                results.criticalIssues++;
                            }
                        }
                    } catch (e) {
                        checkResults.push({
                            id: check.id,
                            name: check.name,
                            passed: false,
                            error: e.message,
                            dueDate: check.dueDate || null
                        });
                        
                        // Add failed checks to outstanding tasks
                        results.outstandingTasks.push({
                            id: check.id,
                            name: check.name,
                            critical: check.critical || false,
                            dueDate: check.dueDate || null,
                            categoryId: catId,
                            categoryName: category.name,
                            categoryIcon: category.icon,
                            error: e.message
                        });
                    }
                    results.totalChecks++;
                }
                
                const categoryScore = total > 0 ? (passed / total) * 100 : 0;
                results.categories[catId] = {
                    name: category.name,
                    icon: category.icon,
                    score: categoryScore,
                    passed,
                    total,
                    checks: checkResults
                };
                
                results.passedChecks += passed;
                totalWeight += category.weight;
                weightedScore += (categoryScore / 100) * category.weight;
            }
            
            results.overall = totalWeight > 0 ? (weightedScore / totalWeight) * 100 : 0;
            results.lastCheck = new Date();
            
            // Calculate scale readiness (100M users)
            results.scaleReadiness = await calculateScaleReadiness();
            
            launchReadinessData = results;
            return results;
        }
        
        // Calculate scale readiness for 100M users
        async function calculateScaleReadiness() {
            const results = {
                overall: 0,
                categories: {},
                criticalIssues: 0,
                totalChecks: 0,
                passedChecks: 0,
                outstandingTasks: []
            };
            
            let totalWeight = 0;
            let weightedScore = 0;
            
            for (const [catId, category] of Object.entries(scaleReadinessComponents)) {
                let passed = 0;
                let total = category.checks.length;
                const checkResults = [];
                
                for (const check of category.checks) {
                    try {
                        const result = await check.check();
                        if (result) passed++;
                        
                        checkResults.push({
                            id: check.id,
                            name: check.name,
                            passed: !!result,
                            critical: check.critical || false
                        });
                        
                        if (!result) {
                            results.outstandingTasks.push({
                                id: check.id,
                                name: check.name,
                                critical: check.critical || false,
                                categoryId: catId,
                                categoryName: category.name,
                                categoryIcon: category.icon,
                                isScaleTask: true
                            });
                            
                            if (check.critical) {
                                results.criticalIssues++;
                            }
                        }
                    } catch (e) {
                        checkResults.push({
                            id: check.id,
                            name: check.name,
                            passed: false,
                            error: e.message
                        });
                    }
                    results.totalChecks++;
                }
                
                const categoryScore = total > 0 ? (passed / total) * 100 : 0;
                results.categories[catId] = {
                    name: category.name,
                    icon: category.icon,
                    score: categoryScore,
                    passed,
                    total,
                    checks: checkResults
                };
                
                results.passedChecks += passed;
                totalWeight += category.weight;
                weightedScore += (categoryScore / 100) * category.weight;
            }
            
            results.overall = totalWeight > 0 ? (weightedScore / totalWeight) * 100 : 0;
            return results;
        }
        
        // Update the launch readiness UI
        function updateLaunchReadinessUI(data) {
            const percent = Math.round(data.overall);
            
            // Update percentage text
            const percentEl = document.getElementById('launchReadinessPercent');
            if (percentEl) percentEl.textContent = `${percent}%`;
            
            // Update circular progress
            const circle = document.getElementById('launchReadinessCircle');
            if (circle) {
                const circumference = 264; // 2 * PI * 42
                const offset = circumference - (percent / 100) * circumference;
                circle.style.strokeDashoffset = offset;
            }
            
            // Update progress bar
            const bar = document.getElementById('launchReadinessBar');
            if (bar) bar.style.width = `${percent}%`;
            
            // Update status badge
            const status = document.getElementById('launchReadinessStatus');
            if (status) {
                if (percent >= 90) {
                    status.textContent = ' Ready to Launch!';
                    status.style.background = 'var(--success)';
                } else if (percent >= 70) {
                    status.textContent = 'Almost Ready';
                    status.style.background = 'var(--info)';
                } else if (percent >= 50) {
                    status.textContent = 'In Progress';
                    status.style.background = 'var(--warning)';
                } else {
                    status.textContent = 'Early Stage';
                    status.style.background = 'var(--danger)';
                }
            }
            
            // Update message
            const message = document.getElementById('launchReadinessMessage');
            if (message) {
                const remaining = data.totalChecks - data.passedChecks;
                if (percent >= 90) {
                    message.textContent = `All systems go! ${data.passedChecks}/${data.totalChecks} components verified.`;
                } else {
                    message.textContent = `${data.passedChecks}/${data.totalChecks} components ready. ${remaining} items need attention.`;
                }
            }
            
            // Update component count
            const componentCount = document.getElementById('launchReadinessComponentCount');
            if (componentCount) componentCount.textContent = `${data.passedChecks}/${data.totalChecks}`;
            
            // Update critical issues
            const critical = document.getElementById('launchReadinessCritical');
            if (critical) {
                critical.textContent = data.criticalIssues === 0 ? '0 issues' : `${data.criticalIssues} issues`;
                critical.style.color = data.criticalIssues === 0 ? 'var(--success)' : 'var(--danger)';
            }
            
            // Update last check time
            const lastCheck = document.getElementById('launchReadinessLastCheck');
            if (lastCheck && data.lastCheck) {
                lastCheck.textContent = data.lastCheck.toLocaleTimeString();
            }
            
            // Update category scores
            for (const [catId, catData] of Object.entries(data.categories)) {
                const scoreEl = document.getElementById(`launchCatScore-${catId}`);
                const catEl = document.getElementById(`launchCat-${catId}`);
                
                if (scoreEl) {
                    scoreEl.textContent = `${Math.round(catData.score)}%`;
                    scoreEl.style.color = catData.score >= 80 ? 'var(--success)' : catData.score >= 50 ? 'var(--warning)' : 'var(--danger)';
                }
                
                if (catEl) {
                    if (catData.score >= 80) {
                        catEl.style.borderLeft = '3px solid var(--success)';
                    } else if (catData.score >= 50) {
                        catEl.style.borderLeft = '3px solid var(--warning)';
                    } else {
                        catEl.style.borderLeft = '3px solid var(--danger)';
                    }
                }
            }
            
            // Update outstanding tasks display (combine launch + scale tasks)
            const allOutstandingTasks = [
                ...(data.outstandingTasks || []),
                ...(data.scaleReadiness?.outstandingTasks || [])
            ];
            if (allOutstandingTasks.length > 0) {
                updateOutstandingTasksDisplay(allOutstandingTasks);
            } else {
                const container = document.getElementById('launchOutstandingTasks');
                if (container) container.style.display = 'none';
            }
            
            // Update scale readiness UI
            if (data.scaleReadiness) {
                updateScaleReadinessUI(data.scaleReadiness);
            }
        }
        
        // Update scale readiness UI
        function updateScaleReadinessUI(data) {
            const percent = Math.round(data.overall);
            
            // Update percentage text
            const percentEl = document.getElementById('scaleReadinessPercent');
            if (percentEl) percentEl.textContent = `${percent}%`;
            
            // Update circular progress
            const circle = document.getElementById('scaleReadinessCircle');
            if (circle) {
                const circumference = 264;
                const offset = circumference - (percent / 100) * circumference;
                circle.style.strokeDashoffset = offset;
            }
            
            // Update scale progress bar
            const bar = document.getElementById('scaleReadinessBar');
            if (bar) bar.style.width = `${percent}%`;
            
            // Update scale status badge
            const status = document.getElementById('scaleReadinessStatus');
            if (status) {
                if (percent >= 80) {
                    status.textContent = ' 100M Ready';
                    status.style.background = 'var(--success)';
                } else if (percent >= 50) {
                    status.textContent = ' Scaling Up';
                    status.style.background = 'var(--warning)';
                } else if (percent >= 25) {
                    status.textContent = ' Building';
                    status.style.background = 'var(--info)';
                } else {
                    status.textContent = ' Foundation';
                    status.style.background = 'var(--danger)';
                }
            }
            
            // Update scale component count
            const componentCount = document.getElementById('scaleReadinessComponentCount');
            if (componentCount) componentCount.textContent = `${data.passedChecks}/${data.totalChecks}`;
            
            // Update scale critical issues
            const critical = document.getElementById('scaleReadinessCritical');
            if (critical) {
                critical.textContent = data.criticalIssues === 0 ? '0 blockers' : `${data.criticalIssues} blockers`;
                critical.style.color = data.criticalIssues === 0 ? 'var(--success)' : 'var(--danger)';
            }
            
            // Update scale category scores
            for (const [catId, catData] of Object.entries(data.categories)) {
                const scoreEl = document.getElementById(`scaleCatScore-${catId}`);
                const catEl = document.getElementById(`scaleCat-${catId}`);
                
                if (scoreEl) {
                    scoreEl.textContent = `${Math.round(catData.score)}%`;
                    scoreEl.style.color = catData.score >= 80 ? 'var(--success)' : catData.score >= 50 ? 'var(--warning)' : 'var(--danger)';
                }
                
                if (catEl) {
                    if (catData.score >= 80) {
                        catEl.style.borderLeft = '3px solid var(--success)';
                    } else if (catData.score >= 50) {
                        catEl.style.borderLeft = '3px solid var(--warning)';
                    } else {
                        catEl.style.borderLeft = '3px solid var(--danger)';
                    }
                }
            }
        }
        
        // Show scale category details
        function showScaleCategoryDetails(catId) {
            const details = document.getElementById('launchReadinessDetails');
            const title = document.getElementById('launchDetailsTitle');
            const content = document.getElementById('launchDetailsContent');
            
            if (!details || !launchReadinessData.scaleReadiness?.categories[catId]) return;
            
            const catData = launchReadinessData.scaleReadiness.categories[catId];
            title.textContent = `${catData.icon} ${catData.name} (100M Scale)`;
            
            let html = '';
            for (const check of catData.checks) {
                const statusIcon = check.passed ? '' : '';
                const statusColor = check.passed ? 'var(--success)' : 'var(--danger)';
                const criticalBadge = check.critical && !check.passed ? '<span style="font-size: 0.6rem; background: var(--danger); color: white; padding: 1px 4px; border-radius: 3px; margin-left: 4px;">CRITICAL</span>' : '';
                
                html += `
                    <div style="display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: var(--bg-tertiary); border-radius: 6px; flex-wrap: wrap;">
                        <span style="color: ${statusColor};">${statusIcon}</span>
                        <span style="font-size: 0.85rem;">${check.name}${criticalBadge}</span>
                    </div>
                `;
            }
            
            content.innerHTML = html;
            details.style.display = 'block';
        }
        
        // Show category details
        function showLaunchCategoryDetails(catId) {
            const details = document.getElementById('launchReadinessDetails');
            const title = document.getElementById('launchDetailsTitle');
            const content = document.getElementById('launchDetailsContent');
            
            if (!details || !launchReadinessData.categories[catId]) return;
            
            const catData = launchReadinessData.categories[catId];
            title.textContent = `${catData.icon} ${catData.name} Details`;
            
            let html = '';
            for (const check of catData.checks) {
                const statusIcon = check.passed ? '' : '';
                const statusColor = check.passed ? 'var(--success)' : 'var(--danger)';
                const dueInfo = check.dueDate ? `<span style="font-size: 0.7rem; color: var(--text-muted); margin-left: auto;">Due: ${new Date(check.dueDate).toLocaleDateString()}</span>` : '';
                const criticalBadge = check.critical && !check.passed ? '<span style="font-size: 0.6rem; background: var(--danger); color: white; padding: 1px 4px; border-radius: 3px; margin-left: 4px;">CRITICAL</span>' : '';
                const addBtn = !check.passed && check.dueDate ? `<button onclick="scheduleTask('${check.id}', '${check.name}', '${check.dueDate}', '${catId}')" style="font-size: 0.65rem; padding: 2px 6px; background: var(--accent); color: white; border: none; border-radius: 4px; cursor: pointer; margin-left: 8px;"> Add</button>` : '';
                
                html += `
                    <div style="display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: var(--bg-tertiary); border-radius: 6px; flex-wrap: wrap;">
                        <span style="color: ${statusColor};">${statusIcon}</span>
                        <span style="font-size: 0.85rem;">${check.name}${criticalBadge}</span>
                        ${dueInfo}
                        ${addBtn}
                    </div>
                `;
            }
            
            content.innerHTML = html;
            details.style.display = 'block';
        }
        
        // Update outstanding tasks display
        function updateOutstandingTasksDisplay(outstandingTasks) {
            const container = document.getElementById('launchOutstandingTasks');
            const list = document.getElementById('launchOutstandingList');
            const count = document.getElementById('launchOutstandingCount');
            
            if (!container || !list) return;
            
            if (outstandingTasks.length === 0) {
                container.style.display = 'none';
                return;
            }
            
            container.style.display = 'block';
            count.textContent = outstandingTasks.length;
            
            // Sort by due date (earliest first), then by critical status
            outstandingTasks.sort((a, b) => {
                if (a.critical && !b.critical) return -1;
                if (!a.critical && b.critical) return 1;
                if (a.dueDate && b.dueDate) return new Date(a.dueDate) - new Date(b.dueDate);
                return 0;
            });
            
            let html = '';
            for (const task of outstandingTasks) {
                const dueDate = task.dueDate ? new Date(task.dueDate) : null;
                const today = new Date();
                const daysUntil = dueDate ? Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24)) : null;
                
                let urgencyColor = 'var(--text-secondary)';
                let urgencyText = '';
                if (daysUntil !== null) {
                    if (daysUntil < 0) {
                        urgencyColor = 'var(--danger)';
                        urgencyText = `${Math.abs(daysUntil)} days overdue`;
                    } else if (daysUntil <= 7) {
                        urgencyColor = 'var(--danger)';
                        urgencyText = daysUntil === 0 ? 'Due today!' : `${daysUntil} days left`;
                    } else if (daysUntil <= 14) {
                        urgencyColor = 'var(--warning)';
                        urgencyText = `${daysUntil} days left`;
                    } else {
                        urgencyColor = 'var(--text-muted)';
                        urgencyText = `${daysUntil} days left`;
                    }
                }
                
                const criticalBadge = task.critical ? '<span style="font-size: 0.6rem; background: var(--danger); color: white; padding: 2px 6px; border-radius: 3px;">CRITICAL</span>' : '';
                const categoryBadge = `<span style="font-size: 0.6rem; background: var(--bg-tertiary); padding: 2px 6px; border-radius: 3px;">${task.categoryIcon} ${task.categoryName}</span>`;
                
                html += `
                    <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--bg-tertiary); border-radius: 8px; border-left: 3px solid ${urgencyColor};">
                        <div style="flex: 1;">
                            <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap; margin-bottom: 4px;">
                                <span style="font-weight: 600;">${task.name}</span>
                                ${criticalBadge}
                                ${categoryBadge}
                            </div>
                            <div style="font-size: 0.75rem; color: ${urgencyColor};">
                                ${dueDate ? ` Due: ${dueDate.toLocaleDateString()}  ` : ''}${urgencyText}
                            </div>
                        </div>
                        <button onclick="scheduleTask('${task.id}', '${task.name.replace(/'/g, "\\'")}', '${task.dueDate || ''}', '${task.categoryId}')" class="btn btn-secondary" style="font-size: 0.7rem; padding: 6px 10px; white-space: nowrap;">
                             Schedule
                        </button>
                    </div>
                `;
            }
            
            list.innerHTML = html;
        }
        
        // Schedule a single task
        function scheduleTask(taskId, taskName, dueDate, categoryId) {
            // Open the add event modal with pre-filled data
            const category = launchReadinessComponents[categoryId];
            const title = `${category?.icon || ''} ${taskName}`;
            const date = dueDate || new Date().toISOString().split('T')[0];
            
            // Check if event already exists in calendar
            const existingEvent = calendarEvents.find(e => 
                (e.title || e.name || '').toLowerCase().includes(taskName.toLowerCase())
            );
            
            if (existingEvent) {
                showToast(' This task is already on the calendar', 'info');
                return;
            }
            
            // Add to calendar events
            const newEvent = {
                id: `launch-${taskId}-${Date.now()}`,
                title: title,
                date: date,
                time: '09:00',
                type: categoryId === 'legal' ? 'compliance' : categoryId === 'audit' ? 'compliance' : 'task',
                category: categoryId === 'legal' ? 'compliance' : categoryId === 'audit' ? 'compliance' : 'milestone',
                priority: category?.checks?.find(c => c.id === taskId)?.critical ? 'critical' : 'high',
                description: `Launch readiness task from ${category?.name || 'Unknown'} category`,
                isCustom: true,
                createdAt: new Date().toISOString()
            };
            
            calendarEvents.push(newEvent);
            
            // Save to localStorage
            const customEvents = JSON.parse(localStorage.getItem('oith_custom_calendar_events') || '[]');
            customEvents.push(newEvent);
            localStorage.setItem('oith_custom_calendar_events', JSON.stringify(customEvents));
            
            // Also save to main calendar events for AWS sync
            let savedEvents = JSON.parse(localStorage.getItem('oith_calendar_events') || '[]');
            savedEvents.push(newEvent);
            localStorage.setItem('oith_calendar_events', JSON.stringify(savedEvents));
            
            // Sync to AWS automatically
            if (typeof syncCalendarToAWS === 'function') {
                syncCalendarToAWS(true);
            }
            
            showToast(` "${taskName}" added to calendar for ${new Date(date).toLocaleDateString()}`, 'success');
            
            // Refresh calendar displays
            renderMilestones();
            renderUpcomingTasks();
            renderCalendarGrid();
            
            // Recalculate readiness
            calculateLaunchReadiness().then(data => updateLaunchReadinessUI(data));
        }
        
        // Schedule all outstanding tasks
        function scheduleAllOutstandingTasks() {
            if (!launchReadinessData.outstandingTasks || launchReadinessData.outstandingTasks.length === 0) {
                showToast('No outstanding tasks to schedule', 'info');
                return;
            }
            
            let scheduled = 0;
            for (const task of launchReadinessData.outstandingTasks) {
                // Check if already exists
                const existingEvent = calendarEvents.find(e => 
                    (e.title || e.name || '').toLowerCase().includes(task.name.toLowerCase())
                );
                
                if (!existingEvent) {
                    const category = launchReadinessComponents[task.categoryId];
                    const newEvent = {
                        id: `launch-${task.id}-${Date.now()}-${scheduled}`,
                        title: `${category?.icon || ''} ${task.name}`,
                        date: task.dueDate || new Date().toISOString().split('T')[0],
                        time: '09:00',
                        type: task.categoryId === 'legal' ? 'compliance' : task.categoryId === 'audit' ? 'compliance' : 'task',
                        category: task.categoryId === 'legal' ? 'compliance' : task.categoryId === 'audit' ? 'compliance' : 'milestone',
                        priority: task.critical ? 'critical' : 'high',
                        description: `Launch readiness task from ${category?.name || 'Unknown'} category`,
                        isCustom: true,
                        createdAt: new Date().toISOString()
                    };
                    
                    calendarEvents.push(newEvent);
                    scheduled++;
                }
            }
            
            // Save all to localStorage
            const customEvents = JSON.parse(localStorage.getItem('oith_custom_calendar_events') || '[]');
            const newCustomEvents = calendarEvents.filter(e => e.isCustom && e.id.startsWith('launch-'));
            for (const e of newCustomEvents) {
                if (!customEvents.find(c => c.id === e.id)) {
                    customEvents.push(e);
                }
            }
            localStorage.setItem('oith_custom_calendar_events', JSON.stringify(customEvents));
            
            // Also save to main calendar events for AWS sync
            let savedEvents = JSON.parse(localStorage.getItem('oith_calendar_events') || '[]');
            for (const e of newCustomEvents) {
                if (!savedEvents.find(s => s.id === e.id)) {
                    savedEvents.push(e);
                }
            }
            localStorage.setItem('oith_calendar_events', JSON.stringify(savedEvents));
            
            // Sync to AWS automatically
            if (typeof syncCalendarToAWS === 'function') {
                syncCalendarToAWS(true);
            }
            
            showToast(` ${scheduled} tasks added to calendar`, 'success');
            
            // Refresh displays
            renderMilestones();
            renderUpcomingTasks();
            renderCalendarGrid();
            calculateLaunchReadiness().then(data => updateLaunchReadinessUI(data));
        }
        
        // Start real-time launch readiness updates
        async function startLaunchReadinessMonitor() {
            // Initial calculation
            const data = await calculateLaunchReadiness();
            updateLaunchReadinessUI(data);
            
            // Update every 30 seconds
            if (launchReadinessInterval) clearInterval(launchReadinessInterval);
            launchReadinessInterval = setInterval(async () => {
                const data = await calculateLaunchReadiness();
                updateLaunchReadinessUI(data);
            }, 30000);
        }
        
        // Stop monitoring when leaving calendar section
        function stopLaunchReadinessMonitor() {
            if (launchReadinessInterval) {
                clearInterval(launchReadinessInterval);
                launchReadinessInterval = null;
            }
        }
        
        function initCalendarSection() {
            // Initialize calendarEvents if not already done (ensures custom events are loaded)
            if (typeof initCalendarEvents === 'function' && calendarEvents.length === 0) {
                initCalendarEvents();
            }
            renderMilestones();
            renderUpcomingTasks();
            renderCalendarGrid();
            
            // Start launch readiness monitoring
            startLaunchReadinessMonitor();
        }

        function renderMilestones() {
            const container = document.getElementById('milestonesContainer');
            if (!container) return;
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            // Use calendarEvents (combined projectMilestones + custom events) for real-time updates
            const eventsSource = (typeof calendarEvents !== 'undefined' && calendarEvents.length > 0) ? calendarEvents : projectMilestones;
            
            // Include milestones AND critical deadlines from tax, legal, compliance
            const milestones = eventsSource.filter(m => 
                m.type === 'milestone' || m.category === 'milestone' ||
                (m.critical && ['tax', 'legal', 'compliance', 'payroll'].includes(m.type || m.category))
            ).sort((a, b) => new Date(a.date) - new Date(b.date));
            
            // Helper function for timezone-safe date parsing
            function parseEventDate(date) {
                if (date instanceof Date) return date;
                if (typeof date === 'string') {
                    if (date.includes('T')) return new Date(date);
                    // "2025-12-11" format - parse as local date
                    const [y, mo, d] = date.split('-').map(Number);
                    return new Date(y, mo - 1, d);
                }
                return new Date(date);
            }
            
            container.innerHTML = milestones.map(m => {
                const mDate = parseEventDate(m.date);
                const isPast = mDate < today;
                const isToday = mDate.toDateString() === today.toDateString();
                const isCritical = m.critical;
                
                const phaseColors = {
                    0: 'var(--text-muted)',
                    1: 'var(--warning)',
                    2: 'var(--info)',
                    3: 'var(--purple)',
                    4: 'var(--warning)',
                    5: 'var(--success)'
                };
                
                const categoryColors = {
                    'tax': { color: '#ec4899', label: 'Tax' },
                    'legal': { color: '#a855f7', label: 'Legal' },
                    'patent': { color: '#a855f7', label: 'Patent' },
                    'compliance': { color: '#f97316', label: 'Compliance' },
                    'payroll': { color: '#22c55e', label: 'Payroll' }
                };
                
                const cat = m.category ? categoryColors[m.category] : null;
                const borderColor = isPast ? 'var(--success)' : (cat ? cat.color : phaseColors[m.phase]);
                const labelText = cat ? cat.label : `Phase ${m.phase}`;
                const labelColor = cat ? cat.color : phaseColors[m.phase];
                
                return `
                    <div style="display: flex; align-items: center; gap: 12px; padding: 10px 14px; background: ${isPast ? 'rgba(16, 124, 16, 0.1)' : 'var(--bg-tertiary)'}; border-radius: 8px; border-left: 4px solid ${borderColor}; opacity: ${isPast && !isToday ? '0.7' : '1'};">
                        <div style="min-width: 90px; font-size: 0.8rem; color: ${isToday ? 'var(--accent)' : 'var(--text-muted)'}; font-weight: ${isToday ? '600' : '400'};">
                            ${mDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}
                        </div>
                        <div style="flex: 1;">
                            <div style="font-weight: ${isCritical ? '600' : '400'}; color: ${isPast ? 'var(--success)' : 'var(--text-primary)'};">
                                ${isPast ? ' ' : ''}${m.title}
                            </div>
                        </div>
                        <div style="font-size: 0.7rem; padding: 2px 8px; background: ${labelColor}22; color: ${labelColor}; border-radius: 4px;">
                            ${labelText}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderUpcomingTasks() {
            const container = document.getElementById('upcomingTasksContainer');
            if (!container) return;
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const weekFromNow = new Date(today);
            weekFromNow.setDate(weekFromNow.getDate() + 7);
            
            // Use calendarEvents (combined projectMilestones + custom events) for real-time updates
            const eventsSource = (typeof calendarEvents !== 'undefined' && calendarEvents.length > 0) ? calendarEvents : projectMilestones;
            
            // Helper function for timezone-safe date parsing
            function parseEventDateLocal(date) {
                if (date instanceof Date) return date;
                if (typeof date === 'string') {
                    if (date.includes('T')) return new Date(date);
                    // "2025-12-11" format - parse as local date
                    const [y, mo, d] = date.split('-').map(Number);
                    return new Date(y, mo - 1, d);
                }
                return new Date(date);
            }
            
            const upcoming = eventsSource.filter(m => {
                const mDate = parseEventDateLocal(m.date);
                return mDate >= today && mDate <= weekFromNow;
            }).sort((a, b) => parseEventDateLocal(a.date) - parseEventDateLocal(b.date));
            
            if (upcoming.length === 0) {
                container.innerHTML = `<div style="text-align: center; color: var(--text-muted); padding: 20px;">No tasks in the next 7 days</div>`;
                return;
            }
            
            container.innerHTML = upcoming.map(m => {
                const mDate = parseEventDateLocal(m.date);
                const daysUntil = Math.ceil((mDate - today) / (1000 * 60 * 60 * 24));
                const urgencyColor = daysUntil <= 1 ? 'var(--danger)' : daysUntil <= 3 ? 'var(--warning)' : 'var(--text-muted)';
                
                return `
                    <div style="display: flex; align-items: center; gap: 12px; padding: 8px 12px; background: var(--bg-tertiary); border-radius: 6px;">
                        <div style="min-width: 70px; font-size: 0.75rem; color: ${urgencyColor}; font-weight: 500;">
                            ${daysUntil === 0 ? 'TODAY' : daysUntil === 1 ? 'Tomorrow' : `In ${daysUntil} days`}
                        </div>
                        <div style="font-size: 0.85rem;">${m.title}</div>
                        <div style="margin-left: auto; font-size: 0.7rem; color: var(--text-muted);">
                            ${mDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderCalendarGrid() {
            const container = document.getElementById('calendarGrid');
            const label = document.getElementById('calendarMonthLabel');
            if (!container || !label) return;
            
            const year = calendarCurrentMonth.getFullYear();
            const month = calendarCurrentMonth.getMonth();
            
            label.textContent = calendarCurrentMonth.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startOffset = firstDay.getDay();
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            // Day headers
            let html = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map(d => 
                `<div style="text-align: center; font-size: 0.7rem; color: var(--text-muted); padding: 8px 4px; font-weight: 600;">${d}</div>`
            ).join('');
            
            // Empty cells before first day
            for (let i = 0; i < startOffset; i++) {
                html += `<div style="padding: 8px;"></div>`;
            }
            
            // Category colors for calendar events
            const categoryColors = {
                'tax': { bg: 'rgba(236, 72, 153, 0.2)', color: '#ec4899', label: '' },
                'legal': { bg: 'rgba(168, 85, 247, 0.2)', color: '#a855f7', label: '' },
                'patent': { bg: 'rgba(168, 85, 247, 0.2)', color: '#a855f7', label: '' },
                'compliance': { bg: 'rgba(249, 115, 22, 0.2)', color: '#f97316', label: '' },
                'payroll': { bg: 'rgba(34, 197, 94, 0.2)', color: '#22c55e', label: '' }
            };
            
            // Days of the month
            for (let day = 1; day <= lastDay.getDate(); day++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const currentDate = new Date(year, month, day);
                // Use calendarEvents (combined projectMilestones + custom events) for real-time updates
                const dayEvents = (typeof calendarEvents !== 'undefined' && calendarEvents.length > 0 ? calendarEvents : projectMilestones).filter(m => {
                    // Handle both Date objects and date strings (with timezone-safe parsing)
                    let eventDate;
                    if (m.date instanceof Date) {
                        eventDate = m.date;
                    } else if (typeof m.date === 'string') {
                        // Parse date string as LOCAL time, not UTC
                        if (m.date.includes('T')) {
                            eventDate = new Date(m.date);
                        } else {
                            // "2025-12-11" format - parse as local date
                            const [y, mo, d] = m.date.split('-').map(Number);
                            eventDate = new Date(y, mo - 1, d);
                        }
                    } else {
                        eventDate = new Date(m.date);
                    }
                    return eventDate.getDate() === currentDate.getDate() && 
                           eventDate.getMonth() === currentDate.getMonth() && 
                           eventDate.getFullYear() === currentDate.getFullYear();
                });
                const isToday = currentDate.toDateString() === today.toDateString();
                const hasCritical = dayEvents.some(e => e.critical);
                const hasMilestone = dayEvents.some(e => e.type === 'milestone' || e.category === 'milestone');
                
                html += `
                    <div style="padding: 6px; min-height: 70px; background: ${isToday ? 'rgba(0, 120, 212, 0.15)' : 'var(--bg-tertiary)'}; border-radius: 4px; border: 1px solid ${isToday ? 'var(--accent)' : 'var(--border-subtle)'};">
                        <div style="font-size: 0.75rem; font-weight: ${isToday ? '700' : '400'}; color: ${isToday ? 'var(--accent)' : 'var(--text-primary)'}; margin-bottom: 4px;">${day}</div>
                        ${dayEvents.slice(0, 3).map(e => {
                            const cat = categoryColors[e.category] || categoryColors[e.type];
                            let bgColor, textColor;
                            if (e.critical) {
                                bgColor = 'var(--danger)';
                                textColor = 'white';
                            } else if (e.type === 'milestone') {
                                bgColor = 'var(--accent)';
                                textColor = 'white';
                            } else if (cat) {
                                bgColor = cat.bg;
                                textColor = cat.color;
                            } else {
                                bgColor = 'var(--bg-secondary)';
                                textColor = 'var(--text-secondary)';
                            }
                            return `
                            <div style="font-size: 0.55rem; padding: 2px 4px; margin-bottom: 2px; background: ${bgColor}; color: ${textColor}; border-radius: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="${e.title}">
                                ${e.title.substring(0, 18)}${e.title.length > 18 ? '...' : ''}
                            </div>
                        `}).join('')}
                        ${dayEvents.length > 3 ? `<div style="font-size: 0.55rem; color: var(--text-muted);">+${dayEvents.length - 3} more</div>` : ''}
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }

        function fullCalendarPrevMonth() {
            calendarCurrentMonth.setMonth(calendarCurrentMonth.getMonth() - 1);
            renderCalendarGrid();
        }

        function fullCalendarNextMonth() {
            calendarCurrentMonth.setMonth(calendarCurrentMonth.getMonth() + 1);
            renderCalendarGrid();
        }

        function exportCalendar() {
            const events = projectMilestones.map(m => ({
                date: m.date,
                title: m.title,
                phase: m.phase,
                type: m.type,
                critical: m.critical || false
            }));
            
            const blob = new Blob([JSON.stringify(events, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'oith_milestones.json';
            a.click();
            URL.revokeObjectURL(url);
            showToast('Calendar exported!', 'success');
        }

        // Initialize calendar and ML models when section is shown
        const originalShowSection = showSection;
        showSection = function(section) {
            originalShowSection(section);
            if (section === 'calendar') {
                initCalendarSection();
            }
            if (section === 'mlmodels') {
                if (typeof initMLModels === 'function') {
                    initMLModels();
                }
            }
        };

    </script>

    <!-- Admin Calendar Modal -->
    <div class="calendar-modal" id="adminCalendarModal">
        <div class="calendar-container">
            <div class="calendar-header">
                <div class="calendar-title-area">
                    <div class="calendar-title-icon"></div>
                    <div class="calendar-title">
                        <h2>OITH Admin Calendar</h2>
                        <p>Integrated schedule across all admin sections</p>
                    </div>
                </div>
                <div class="calendar-nav">
                    <button class="calendar-today-btn" onclick="calendarGoToday()">Today</button>
                    <button class="calendar-nav-btn" onclick="calendarPrevMonth()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="15 18 9 12 15 6"/>
                        </svg>
                    </button>
                    <span class="calendar-month-display" id="calendarMonthDisplay">December 2025</span>
                    <button class="calendar-nav-btn" onclick="calendarNextMonth()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="9 18 15 12 9 6"/>
                        </svg>
                    </button>
                    <button class="calendar-close-btn" onclick="closeAdminCalendar()">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="18" y1="6" x2="6" y2="18"/>
                            <line x1="6" y1="6" x2="18" y2="18"/>
                        </svg>
                    </button>
                </div>
            </div>
            <div class="calendar-body">
                <div class="calendar-main">
                    <div class="calendar-weekdays">
                        <div class="calendar-weekday">Sun</div>
                        <div class="calendar-weekday">Mon</div>
                        <div class="calendar-weekday">Tue</div>
                        <div class="calendar-weekday">Wed</div>
                        <div class="calendar-weekday">Thu</div>
                        <div class="calendar-weekday">Fri</div>
                        <div class="calendar-weekday">Sat</div>
                    </div>
                    <div class="calendar-grid" id="adminCalendarGrid">
                        <!-- Calendar days will be generated here -->
                    </div>
                </div>
                <div class="calendar-sidebar">
                    <div class="sidebar-section">
                        <div class="sidebar-section-title">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/>
                                <polyline points="12 6 12 12 16 14"/>
                            </svg>
                            Upcoming Events
                        </div>
                        <div id="upcomingEventsList">
                            <!-- Upcoming events will be generated here -->
                        </div>
                    </div>
                    <div class="sidebar-section">
                        <div class="sidebar-section-title">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="3" width="18" height="18" rx="2"/>
                                <path d="M3 9h18"/>
                            </svg>
                            Event Categories
                        </div>
                        <div class="legend-items">
                            <div class="legend-item"><div class="legend-dot payroll"></div>Payroll</div>
                            <div class="legend-item"><div class="legend-dot report"></div>Reports</div>
                            <div class="legend-item"><div class="legend-dot experiment"></div>Experiments</div>
                            <div class="legend-item"><div class="legend-dot compliance"></div>Compliance</div>
                            <div class="legend-item"><div class="legend-dot meeting"></div>Meetings</div>
                            <div class="legend-item"><div class="legend-dot tax"></div>Tax</div>
                            <div class="legend-item"><div class="legend-dot milestone"></div>Milestones</div>
                            <div class="legend-item"><div class="legend-dot patent"></div>Patents</div>
                        </div>
                    </div>
                    <div class="sidebar-section">
                        <button class="add-event-btn" onclick="openAddEventModal()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="12" y1="5" x2="12" y2="19"/>
                                <line x1="5" y1="12" x2="19" y2="12"/>
                            </svg>
                            Add New Event
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mail Client Modal -->
    <div class="mail-modal" id="mailClientModal">
        <div class="mail-container">
            <div class="mail-header">
                <div class="mail-title-area">
                    <div class="mail-icon-large"></div>
                    <div class="mail-title">
                        <h2>OITH Mail</h2>
                        <p id="emailStatusIndicator">admin@oith.com  Support Inbox</p>
                    </div>
                </div>
                <div style="display: flex; align-items: center; gap: 12px;">
                    <button class="btn btn-secondary" onclick="refreshMailInbox()" style="font-size: 0.8rem;">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M23 4v6h-6M1 20v-6h6"/>
                            <path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/>
                        </svg>
                        Refresh
                    </button>
                    <button class="calendar-close-btn" onclick="closeMailClient()">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="18" y1="6" x2="6" y2="18"/>
                            <line x1="6" y1="6" x2="18" y2="18"/>
                        </svg>
                    </button>
                </div>
            </div>
            <div class="mail-body">
                <div class="mail-sidebar">
                    <div class="mail-folder active" onclick="switchMailFolder('inbox')">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="22 12 16 12 14 15 10 15 8 12 2 12"/>
                            <path d="M5.45 5.11L2 12v6a2 2 0 002 2h16a2 2 0 002-2v-6l-3.45-6.89A2 2 0 0016.76 4H7.24a2 2 0 00-1.79 1.11z"/>
                        </svg>
                        Inbox
                        <span class="mail-folder-count" id="inboxCount">0</span>
                    </div>
                    <div class="mail-folder" onclick="switchMailFolder('support')">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/>
                        </svg>
                        Support
                        <span class="mail-folder-count" id="supportCount">0</span>
                    </div>
                    <div class="mail-folder" onclick="switchMailFolder('sent')">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="22" y1="2" x2="11" y2="13"/>
                            <polygon points="22 2 15 22 11 13 2 9 22 2"/>
                        </svg>
                        Sent
                    </div>
                    <div class="mail-folder" onclick="switchMailFolder('archive')">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="21 8 21 21 3 21 3 8"/>
                            <rect x="1" y="3" width="22" height="5"/>
                            <line x1="10" y1="12" x2="14" y2="12"/>
                        </svg>
                        Archive
                    </div>
                </div>
                <div class="mail-list" id="mailList">
                    <div class="mail-list-header">
                        <span id="mailListTitle">Inbox</span>
                    </div>
                    <div id="mailListItems">
                        <!-- Mail items will be rendered here -->
                    </div>
                </div>
                <div class="mail-content" id="mailContent">
                    <div class="mail-content-empty" id="mailEmptyState">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                            <polyline points="22,6 12,13 2,6"/>
                        </svg>
                        <p>Select an email to view</p>
                    </div>
                    <div id="mailViewContent" style="display: none;">
                        <!-- Selected email content will be shown here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- File Storage Modal -->
    <div class="file-storage-modal" id="fileStorageModal">
        <div class="file-storage-container">
            <div class="file-storage-header">
                <div class="file-storage-title-area">
                    <div class="file-storage-icon-large"></div>
                    <div class="file-storage-title">
                        <h2>File Storage</h2>
                        <p id="fileStorageStatus">AWS S3 Connected  Admin Files</p>
                    </div>
                </div>
                <div style="display: flex; align-items: center; gap: 12px;">
                    <button class="btn btn-primary" onclick="openUploadModal()" style="font-size: 0.8rem;">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
                            <polyline points="17 8 12 3 7 8"/>
                            <line x1="12" y1="3" x2="12" y2="15"/>
                        </svg>
                        Upload File
                    </button>
                    <button class="btn btn-secondary" onclick="refreshFileList()" style="font-size: 0.8rem;">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M23 4v6h-6M1 20v-6h6"/>
                            <path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/>
                        </svg>
                        Refresh
                    </button>
                    <button class="calendar-close-btn" onclick="closeFileStorage()">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="18" y1="6" x2="6" y2="18"/>
                            <line x1="6" y1="6" x2="18" y2="18"/>
                        </svg>
                    </button>
                </div>
            </div>
            <div class="file-storage-body">
                <div class="file-storage-sidebar">
                    <div class="file-folder active" onclick="selectFileCategory('all')">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>
                        </svg>
                        All Files
                        <span class="file-folder-count" id="allFilesCount">0</span>
                    </div>
                    <div class="file-folder" onclick="selectFileCategory('general')">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M13 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V9z"/>
                            <polyline points="13 2 13 9 20 9"/>
                        </svg>
                        General
                    </div>
                    <div class="file-folder" onclick="selectFileCategory('reports')">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/>
                            <polyline points="14 2 14 8 20 8"/>
                            <line x1="16" y1="13" x2="8" y2="13"/>
                            <line x1="16" y1="17" x2="8" y2="17"/>
                        </svg>
                        Reports
                    </div>
                    <div class="file-folder" onclick="selectFileCategory('compliance')">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                        </svg>
                        Compliance
                    </div>
                    <div class="file-folder" onclick="selectFileCategory('patents')">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="8" r="7"/>
                            <polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"/>
                        </svg>
                        Patents
                    </div>
                    <div class="file-folder" onclick="selectFileCategory('contracts')">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/>
                            <path d="M14 2v6h6"/>
                            <path d="M9 15v-2h6v2"/>
                        </svg>
                        Contracts
                    </div>
                    <div class="file-folder" onclick="selectFileCategory('marketing')">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
                        </svg>
                        Marketing
                    </div>
                    <div class="file-folder" onclick="selectFileCategory('financial')">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="12" y1="1" x2="12" y2="23"/>
                            <path d="M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"/>
                        </svg>
                        Financial
                    </div>
                    <div class="file-folder" onclick="selectFileCategory('hr')">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/>
                            <circle cx="9" cy="7" r="4"/>
                            <path d="M23 21v-2a4 4 0 00-3-3.87"/>
                            <path d="M16 3.13a4 4 0 010 7.75"/>
                        </svg>
                        HR
                    </div>
                    <div class="file-folder" onclick="selectFileCategory('technical')">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="16 18 22 12 16 6"/>
                            <polyline points="8 6 2 12 8 18"/>
                        </svg>
                        Technical
                    </div>
                    <div class="file-folder" onclick="selectFileCategory('archives')">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="21 8 21 21 3 21 3 8"/>
                            <rect x="1" y="3" width="22" height="5"/>
                            <line x1="10" y1="12" x2="14" y2="12"/>
                        </svg>
                        Archives
                    </div>
                    <div style="margin-top: 20px; padding: 16px; background: var(--bg-tertiary); border-radius: 12px;">
                        <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 8px;">STORAGE USED</div>
                        <div style="font-size: 1.2rem; font-weight: 700; color: var(--success);" id="storageUsed">0 MB</div>
                        <div style="margin-top: 8px; background: var(--bg-secondary); border-radius: 4px; height: 4px; overflow: hidden;">
                            <div id="storageBar" style="background: var(--success); height: 100%; width: 0%; transition: width 0.3s;"></div>
                        </div>
                        <div style="font-size: 0.7rem; color: var(--text-muted); margin-top: 4px;"><span id="fileCountSidebar">0</span> files</div>
                    </div>
                </div>
                <div class="file-list" id="fileList">
                    <div class="file-list-header">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <span id="fileListTitle">All Files</span>
                            <input type="text" id="fileSearchInput" placeholder="Search files..." onkeyup="searchFiles(this.value)" style="padding: 8px 12px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); font-size: 0.85rem; width: 200px;">
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <select id="fileSortBy" onchange="sortFiles()" style="padding: 6px 10px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary); font-size: 0.8rem;">
                                <option value="uploadedAt">Date</option>
                                <option value="fileName">Name</option>
                                <option value="fileSize">Size</option>
                            </select>
                        </div>
                    </div>
                    <div id="fileListItems" style="flex: 1; overflow-y: auto;">
                        <div style="text-align: center; padding: 60px 20px; color: var(--text-muted);">
                            <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" style="opacity: 0.3; margin-bottom: 16px;">
                                <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>
                            </svg>
                            <div style="font-size: 0.95rem; margin-bottom: 8px;">No files yet</div>
                            <div style="font-size: 0.85rem;">Upload files or save from other sections</div>
                        </div>
                    </div>
                </div>
                <div class="file-preview" id="filePreview">
                    <div class="file-preview-empty" id="filePreviewEmpty">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="width: 64px; height: 64px; opacity: 0.3; margin-bottom: 16px;">
                            <path d="M13 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V9z"/>
                            <polyline points="13 2 13 9 20 9"/>
                        </svg>
                        <p>Select a file to preview</p>
                    </div>
                    <div id="filePreviewContent" style="display: none;">
                        <!-- Selected file preview will be shown here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- File Upload Modal -->
    <div class="modal" id="fileUploadModal" style="z-index: 2200;">
        <div class="modal-content" style="max-width: 500px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 16px; border-bottom: 1px solid var(--border);">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div style="width: 40px; height: 40px; background: linear-gradient(135deg, var(--success) 0%, #059669 100%); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem;"></div>
                    <div>
                        <h3 style="margin: 0; font-size: 1.1rem;">Upload File</h3>
                        <p style="margin: 0; font-size: 0.8rem; color: var(--text-muted);">Upload to AWS S3</p>
                    </div>
                </div>
                <button onclick="closeUploadModal()" style="background: var(--bg-tertiary); border: none; color: var(--text-muted); cursor: pointer; font-size: 1.2rem; width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center;">&times;</button>
            </div>
            <form id="fileUploadForm" onsubmit="handleFileUpload(event)">
                <div id="dropZone" style="padding: 40px; border: 2px dashed var(--border); border-radius: 16px; text-align: center; margin-bottom: 20px; cursor: pointer; transition: all 0.2s;" onclick="document.getElementById('fileInput').click()" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" ondrop="handleDrop(event)">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="color: var(--text-muted); margin-bottom: 12px;">
                        <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
                        <polyline points="17 8 12 3 7 8"/>
                        <line x1="12" y1="3" x2="12" y2="15"/>
                    </svg>
                    <div style="font-size: 0.95rem; color: var(--text-primary); margin-bottom: 4px;" id="dropZoneText">Drag & drop files here</div>
                    <div style="font-size: 0.85rem; color: var(--text-muted);">or click to browse</div>
                    <input type="file" id="fileInput" style="display: none;" onchange="handleFileSelect(event)">
                </div>
                <div id="selectedFileInfo" style="display: none; padding: 16px; background: var(--bg-tertiary); border-radius: 12px; margin-bottom: 16px;">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <div id="fileTypeIcon" style="width: 40px; height: 40px; background: var(--bg-secondary); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem;"></div>
                        <div style="flex: 1; min-width: 0;">
                            <div style="font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" id="selectedFileName">-</div>
                            <div style="font-size: 0.8rem; color: var(--text-muted);" id="selectedFileSize">-</div>
                        </div>
                        <button type="button" onclick="clearSelectedFile()" style="background: var(--danger); border: none; color: white; width: 28px; height: 28px; border-radius: 6px; cursor: pointer;"></button>
                    </div>
                </div>
                <div style="margin-bottom: 16px;">
                    <label style="display: block; font-size: 0.85rem; color: var(--text-muted); margin-bottom: 6px;">Category</label>
                    <select id="uploadCategory" style="width: 100%; padding: 12px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 10px; color: var(--text-primary);">
                        <option value="general"> General</option>
                        <option value="reports"> Reports</option>
                        <option value="compliance"> Compliance</option>
                        <option value="patents"> Patents</option>
                        <option value="contracts"> Contracts</option>
                        <option value="marketing"> Marketing</option>
                        <option value="financial"> Financial</option>
                        <option value="hr"> HR</option>
                        <option value="technical"> Technical</option>
                        <option value="archives"> Archives</option>
                    </select>
                </div>
                <div style="margin-bottom: 16px;">
                    <label style="display: block; font-size: 0.85rem; color: var(--text-muted); margin-bottom: 6px;">Description (Optional)</label>
                    <textarea id="uploadDescription" rows="2" placeholder="Add a description..." style="width: 100%; padding: 12px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 10px; color: var(--text-primary); resize: none;"></textarea>
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="display: block; font-size: 0.85rem; color: var(--text-muted); margin-bottom: 6px;">Tags (comma separated)</label>
                    <input type="text" id="uploadTags" placeholder="e.g., important, 2024, draft" style="width: 100%; padding: 12px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 10px; color: var(--text-primary);">
                </div>
                <div style="display: flex; gap: 12px;">
                    <button type="button" class="btn btn-secondary" onclick="closeUploadModal()" style="flex: 1;">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="uploadBtn" style="flex: 1;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
                            <polyline points="17 8 12 3 7 8"/>
                            <line x1="12" y1="3" x2="12" y2="15"/>
                        </svg>
                        Upload
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Event Modal -->
    <div class="modal" id="addEventModal" style="z-index: 2100;">
        <div class="modal-content" style="max-width: 520px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 16px; border-bottom: 1px solid var(--border);">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div style="width: 40px; height: 40px; background: linear-gradient(135deg, var(--accent) 0%, var(--accent-light) 100%); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem;"></div>
                    <div>
                        <h3 style="margin: 0; font-size: 1.1rem;">Add New Event</h3>
                        <p style="margin: 0; font-size: 0.8rem; color: var(--text-muted);">Create a calendar event</p>
                    </div>
                </div>
                <button onclick="closeAddEventModal()" style="background: var(--bg-tertiary); border: none; color: var(--text-muted); cursor: pointer; font-size: 1.2rem; width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center; transition: all 0.2s;" onmouseover="this.style.background='var(--bg-hover)'; this.style.color='var(--text-primary)'" onmouseout="this.style.background='var(--bg-tertiary)'; this.style.color='var(--text-muted)'">&times;</button>
            </div>
            <form id="addEventForm" onsubmit="saveCalendarEvent(event)">
                <div style="margin-bottom: 16px;">
                    <label style="display: block; font-size: 0.85rem; color: var(--text-muted); margin-bottom: 6px;">Event Title *</label>
                    <input type="text" id="eventTitle" required placeholder="Enter event title..." style="width: 100%; padding: 12px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 10px; color: var(--text-primary); font-size: 0.95rem;">
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                    <div>
                        <label style="display: block; font-size: 0.85rem; color: var(--text-muted); margin-bottom: 6px;">Date *</label>
                        <input type="date" id="eventDate" required style="width: 100%; padding: 12px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 10px; color: var(--text-primary);">
                    </div>
                    <div>
                        <label style="display: block; font-size: 0.85rem; color: var(--text-muted); margin-bottom: 6px;">Time</label>
                        <input type="time" id="eventTime" style="width: 100%; padding: 12px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 10px; color: var(--text-primary);">
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                    <div>
                        <label style="display: block; font-size: 0.85rem; color: var(--text-muted); margin-bottom: 6px;">Category</label>
                        <select id="eventCategory" style="width: 100%; padding: 12px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 10px; color: var(--text-primary);">
                            <option value="meeting"> Meeting</option>
                            <option value="payroll"> Payroll</option>
                            <option value="report"> Report</option>
                            <option value="experiment"> Experiment</option>
                            <option value="compliance"> Compliance</option>
                            <option value="tax"> Tax</option>
                            <option value="milestone"> Milestone</option>
                            <option value="patent"> Patent</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; font-size: 0.85rem; color: var(--text-muted); margin-bottom: 6px;">Section</label>
                        <select id="eventSection" style="width: 100%; padding: 12px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 10px; color: var(--text-primary);">
                            <option value="overview"> Overview</option>
                            <option value="calendar"> Calendar</option>
                            <option value="safety"> Safety</option>
                            <option value="compliance"> Compliance</option>
                            <option value="payroll"> Payroll</option>
                            <option value="tax"> Tax</option>
                            <option value="reports"> Reports</option>
                            <option value="ml-models"> ML Models</option>
                        </select>
                    </div>
                </div>
                <div style="margin-bottom: 16px;">
                    <label style="display: block; font-size: 0.85rem; color: var(--text-muted); margin-bottom: 6px;">Event Type</label>
                    <select id="addEventType" onchange="toggleAddEventZoomSection()" style="width: 100%; padding: 12px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 10px; color: var(--text-primary);">
                        <option value="in-person"> In-Person</option>
                        <option value="virtual"> Virtual (Zoom)</option>
                        <option value="hybrid"> Hybrid</option>
                        <option value="phone"> Phone Call</option>
                    </select>
                </div>
                <div id="addEventLocationField" style="margin-bottom: 16px;">
                    <label style="display: block; font-size: 0.85rem; color: var(--text-muted); margin-bottom: 6px;">Location</label>
                    <input type="text" id="eventLocation" placeholder="Add location..." style="width: 100%; padding: 12px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 10px; color: var(--text-primary); font-size: 0.95rem;">
                </div>
                <!-- Zoom Meeting Settings for Add Event Modal -->
                <div id="addEventZoomSection" style="display: none; margin-bottom: 16px; padding: 16px; background: var(--bg-tertiary); border-radius: 12px; border: 1px solid rgba(45, 140, 255, 0.2);">
                    <label style="font-size: 0.85rem; color: var(--text-muted); display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#2D8CFF" stroke-width="2">
                            <path d="M15.6 11.6L22 7v10l-6.4-4.5v-1zM4 5h9a2 2 0 012 2v10a2 2 0 01-2 2H4a2 2 0 01-2-2V7c0-1.1.9-2 2-2z"/>
                        </svg>
                        Zoom Meeting Settings
                    </label>
                    <div id="addEventZoomStatus" style="display: flex; align-items: center; gap: 10px; padding: 12px; background: var(--bg-secondary); border-radius: 10px; margin-bottom: 12px;">
                        <!-- Status will be dynamically updated -->
                    </div>
                    <div id="addEventZoomPanel" style="display: none;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
                            <div>
                                <label style="font-size: 0.75rem; color: var(--text-muted); display: block; margin-bottom: 4px;">Meeting ID</label>
                                <div style="display: flex; gap: 6px;">
                                    <input type="text" id="addEventZoomId" readonly style="flex: 1; padding: 10px; background: var(--bg-primary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); font-family: monospace; font-size: 0.85rem;">
                                    <button type="button" onclick="regenerateAddEventZoomId()" style="padding: 10px 12px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); cursor: pointer;"></button>
                                </div>
                            </div>
                            <div>
                                <label style="font-size: 0.75rem; color: var(--text-muted); display: block; margin-bottom: 4px;">Passcode</label>
                                <input type="text" id="addEventZoomPasscode" style="width: 100%; padding: 10px; background: var(--bg-primary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); font-family: monospace; font-size: 0.85rem;">
                            </div>
                        </div>
                        <div style="display: flex; flex-wrap: wrap; gap: 12px;">
                            <label style="display: flex; align-items: center; gap: 6px; font-size: 0.8rem; color: var(--text-secondary); cursor: pointer;">
                                <input type="checkbox" id="addEventWaitingRoom" checked style="width: 16px; height: 16px; accent-color: #2D8CFF;">
                                Waiting Room
                            </label>
                            <label style="display: flex; align-items: center; gap: 6px; font-size: 0.8rem; color: var(--text-secondary); cursor: pointer;">
                                <input type="checkbox" id="addEventMuteOnEntry" checked style="width: 16px; height: 16px; accent-color: #2D8CFF;">
                                Mute on Entry
                            </label>
                            <label style="display: flex; align-items: center; gap: 6px; font-size: 0.8rem; color: var(--text-secondary); cursor: pointer;">
                                <input type="checkbox" id="addEventRecording" style="width: 16px; height: 16px; accent-color: #2D8CFF;">
                                Auto-Record
                            </label>
                        </div>
                    </div>
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="display: block; font-size: 0.85rem; color: var(--text-muted); margin-bottom: 6px;">Description</label>
                    <textarea id="eventDescription" rows="3" placeholder="Add details about this event..." style="width: 100%; padding: 12px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 10px; color: var(--text-primary); resize: vertical; font-size: 0.95rem;"></textarea>
                </div>
                <div style="display: flex; gap: 12px; padding-top: 16px; border-top: 1px solid var(--border);">
                    <button type="button" class="btn btn-secondary" onclick="closeAddEventModal()" style="flex: 1; padding: 12px;">Cancel</button>
                    <button type="submit" class="btn btn-primary" style="flex: 1; padding: 12px; display: flex; align-items: center; justify-content: center; gap: 8px;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/>
                            <polyline points="17 21 17 13 7 13 7 21"/>
                            <polyline points="7 3 7 8 15 8"/>
                        </svg>
                        Save Event
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Meeting Scheduler Modal -->
    <div class="modal" id="meetingSchedulerModal" style="z-index: 2100;">
        <div class="modal-content meeting-scheduler-modal">
            <div class="scheduler-header">
                <div class="scheduler-header-left">
                    <div class="scheduler-icon"></div>
                    <div>
                        <h2>Schedule a Meeting</h2>
                        <p>Create and invite participants to your meeting</p>
                    </div>
                </div>
                <button onclick="closeMeetingScheduler()" class="scheduler-close-btn">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            
            <form id="meetingSchedulerForm" onsubmit="saveMeeting(event)">
                <div class="scheduler-body">
                    <!-- Left Column - Meeting Details -->
                    <div class="scheduler-column">
                        <div class="scheduler-section">
                            <div class="scheduler-section-title">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/>
                                    <path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/>
                                </svg>
                                Meeting Details
                            </div>
                            
                            <div class="form-group">
                                <label>Meeting Title *</label>
                                <input type="text" id="meetingTitle" required placeholder="e.g., Weekly Team Standup" class="form-control">
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Date *</label>
                                    <input type="date" id="meetingDate" required class="form-control">
                                </div>
                                <div class="form-group">
                                    <label>Start Time *</label>
                                    <input type="time" id="meetingStartTime" required class="form-control">
                                </div>
                                <div class="form-group">
                                    <label>Duration</label>
                                    <select id="meetingDuration" class="form-control">
                                        <option value="15">15 minutes</option>
                                        <option value="30" selected>30 minutes</option>
                                        <option value="45">45 minutes</option>
                                        <option value="60">1 hour</option>
                                        <option value="90">1.5 hours</option>
                                        <option value="120">2 hours</option>
                                        <option value="180">3 hours</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Category</label>
                                    <select id="meetingCategory" class="form-control">
                                        <option value="meeting"> Meeting</option>
                                        <option value="standup"> Standup</option>
                                        <option value="interview"> Interview</option>
                                        <option value="review"> Review</option>
                                        <option value="planning"> Planning</option>
                                        <option value="training"> Training</option>
                                        <option value="client"> Client Call</option>
                                        <option value="webinar"> Webinar</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Event Type</label>
                                    <select id="meetingEventType" class="form-control" onchange="toggleLocationFields()">
                                        <option value="virtual"> Virtual (Zoom)</option>
                                        <option value="in-person"> In-Person</option>
                                        <option value="hybrid"> Hybrid</option>
                                        <option value="phone"> Phone Call</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-group" id="locationField">
                                <label>Location</label>
                                <input type="text" id="meetingLocation" placeholder="Enter physical location address..." class="form-control">
                            </div>
                            
                            <div class="form-group">
                                <label>Description / Agenda</label>
                                <textarea id="meetingDescription" rows="3" placeholder="Add meeting agenda, notes, or talking points..." class="form-control"></textarea>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Right Column - Zoom & Invites -->
                    <div class="scheduler-column">
                        <!-- Zoom Integration Section -->
                        <div class="scheduler-section" id="zoomSection">
                            <div class="scheduler-section-title">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M15.6 11.6L22 7v10l-6.4-4.5v-1zM4 5h9a2 2 0 012 2v10a2 2 0 01-2 2H4a2 2 0 01-2-2V7c0-1.1.9-2 2-2z"/>
                                </svg>
                                Zoom Meeting Settings
                            </div>
                            
                            <div class="zoom-status" id="zoomConnectionStatus">
                                <div class="zoom-status-indicator disconnected"></div>
                                <span>Not Connected</span>
                                <button type="button" class="btn btn-secondary btn-sm" onclick="connectZoomAccount()">Connect Zoom</button>
                                <button type="button" class="btn btn-outline btn-sm" onclick="testZoomConnection('main')" style="margin-left: 4px;" title="Test Zoom Connection"> Test</button>
                            </div>
                            
                            <div id="zoomConnectedPanel" style="display: none;">
                                <div class="zoom-connected-info">
                                    <div class="zoom-avatar"></div>
                                    <div>
                                        <div class="zoom-user-name" id="zoomUserName">Connected User</div>
                                        <div class="zoom-user-email" id="zoomUserEmail">user@example.com</div>
                                    </div>
                                    <button type="button" class="btn btn-outline btn-sm" onclick="disconnectZoomAccount()">Disconnect</button>
                                </div>
                                
                                <div class="form-group">
                                    <label>Meeting ID</label>
                                    <div class="zoom-id-row">
                                        <input type="text" id="zoomMeetingId" readonly class="form-control" placeholder="Auto-generated">
                                        <button type="button" class="btn btn-secondary btn-sm" onclick="generateZoomMeetingId()">
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path d="M23 4v6h-6M1 20v-6h6"/>
                                                <path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/>
                                            </svg>
                                            Generate
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label>Passcode</label>
                                    <input type="text" id="zoomPasscode" class="form-control" placeholder="Optional meeting passcode">
                                </div>
                                
                                <div class="zoom-options">
                                    <label class="checkbox-label">
                                        <input type="checkbox" id="zoomWaitingRoom" checked>
                                        <span>Enable Waiting Room</span>
                                    </label>
                                    <label class="checkbox-label">
                                        <input type="checkbox" id="zoomMuteOnEntry" checked>
                                        <span>Mute participants on entry</span>
                                    </label>
                                    <label class="checkbox-label">
                                        <input type="checkbox" id="zoomRecording">
                                        <span>Auto-record meeting</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Invite Attendees Section -->
                        <div class="scheduler-section">
                            <div class="scheduler-section-title">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/>
                                    <circle cx="9" cy="7" r="4"/>
                                    <path d="M23 21v-2a4 4 0 00-3-3.87M16 3.13a4 4 0 010 7.75"/>
                                </svg>
                                Invite Attendees
                            </div>
                            
                            <div class="invite-tabs">
                                <button type="button" class="invite-tab active" onclick="switchInviteTab('email')">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                                        <polyline points="22,6 12,13 2,6"/>
                                    </svg>
                                    Email
                                </button>
                                <button type="button" class="invite-tab" onclick="switchInviteTab('phone')">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07 19.5 19.5 0 01-6-6 19.79 19.79 0 01-3.07-8.67A2 2 0 014.11 2h3a2 2 0 012 1.72 12.84 12.84 0 00.7 2.81 2 2 0 01-.45 2.11L8.09 9.91a16 16 0 006 6l1.27-1.27a2 2 0 012.11-.45 12.84 12.84 0 002.81.7A2 2 0 0122 16.92z"/>
                                    </svg>
                                    SMS/Phone
                                </button>
                            </div>
                            
                            <div id="emailInvitePanel" class="invite-panel">
                                <div class="form-group">
                                    <label>Add by Email</label>
                                    <div class="invite-input-row">
                                        <input type="email" id="inviteEmail" placeholder="Enter email address..." class="form-control">
                                        <button type="button" class="btn btn-secondary btn-sm" onclick="addEmailInvite()">
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <line x1="12" y1="5" x2="12" y2="19"/>
                                                <line x1="5" y1="12" x2="19" y2="12"/>
                                            </svg>
                                            Add
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div id="phoneInvitePanel" class="invite-panel" style="display: none;">
                                <div class="form-group">
                                    <label>Add by Phone Number</label>
                                    <div class="invite-input-row">
                                        <input type="tel" id="invitePhone" placeholder="+1 (555) 123-4567" class="form-control">
                                        <button type="button" class="btn btn-secondary btn-sm" onclick="addPhoneInvite()">
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <line x1="12" y1="5" x2="12" y2="19"/>
                                                <line x1="5" y1="12" x2="19" y2="12"/>
                                            </svg>
                                            Add
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="invitees-list" id="inviteesList">
                                <!-- Invitees will be added here -->
                            </div>
                            
                            <div class="invitees-count" id="inviteesCount" style="display: none;">
                                <span id="inviteesNumber">0</span> attendees invited
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="scheduler-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeMeetingScheduler()">Cancel</button>
                    <div class="scheduler-footer-right">
                        <button type="button" class="btn btn-outline" onclick="previewMeetingInvite()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                                <circle cx="12" cy="12" r="3"/>
                            </svg>
                            Preview
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>
                            </svg>
                            Schedule & Send Invites
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Meeting Preview Modal -->
    <div class="modal" id="meetingPreviewModal" style="z-index: 2200;">
        <div class="modal-content" style="max-width: 550px;">
            <div class="modal-header">
                <h3> Meeting Invite Preview</h3>
                <button onclick="closeMeetingPreview()" class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="preview-email-container" id="meetingPreviewContent">
                    <!-- Preview content will be generated here -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeMeetingPreview()">Close</button>
                <button class="btn btn-primary" onclick="copyMeetingDetails()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                        <path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/>
                    </svg>
                    Copy to Clipboard
                </button>
            </div>
        </div>
    </div>

    <!-- Event Details Modal -->
    <div class="modal" id="eventDetailsModal" style="z-index: 2200;">
        <div class="modal-content event-details-modal">
            <div class="event-details-header" id="eventDetailsHeader">
                <div class="event-details-header-left">
                    <div class="event-details-icon" id="eventDetailsIcon"></div>
                    <div>
                        <h2 id="eventDetailsTitle">Event Title</h2>
                        <p id="eventDetailsCategory">Category</p>
                    </div>
                </div>
                <button onclick="closeEventDetails()" class="scheduler-close-btn">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            
            <div class="event-details-body">
                <!-- View Mode -->
                <div id="eventViewMode">
                    <div class="event-detail-row">
                        <div class="event-detail-icon">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                                <line x1="16" y1="2" x2="16" y2="6"/>
                                <line x1="8" y1="2" x2="8" y2="6"/>
                                <line x1="3" y1="10" x2="21" y2="10"/>
                            </svg>
                        </div>
                        <div class="event-detail-content">
                            <div class="event-detail-label">Date & Time</div>
                            <div class="event-detail-value" id="eventDetailsDateTime">--</div>
                        </div>
                    </div>
                    
                    <div class="event-detail-row" id="eventDetailsLocationRow" style="display: none;">
                        <div class="event-detail-icon">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z"/>
                                <circle cx="12" cy="10" r="3"/>
                            </svg>
                        </div>
                        <div class="event-detail-content">
                            <div class="event-detail-label">Location</div>
                            <div class="event-detail-value" id="eventDetailsLocation">--</div>
                        </div>
                    </div>
                    
                    <div class="event-detail-row" id="eventDetailsZoomRow" style="display: none;">
                        <div class="event-detail-icon" style="color: var(--info);">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M15.6 11.6L22 7v10l-6.4-4.5v-1zM4 5h9a2 2 0 012 2v10a2 2 0 01-2 2H4a2 2 0 01-2-2V7c0-1.1.9-2 2-2z"/>
                            </svg>
                        </div>
                        <div class="event-detail-content">
                            <div class="event-detail-label">Zoom Meeting</div>
                            <div class="event-detail-value" id="eventDetailsZoom">--</div>
                        </div>
                    </div>
                    
                    <div class="event-detail-row" id="eventDetailsAttendeesRow" style="display: none;">
                        <div class="event-detail-icon">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/>
                                <circle cx="9" cy="7" r="4"/>
                                <path d="M23 21v-2a4 4 0 00-3-3.87M16 3.13a4 4 0 010 7.75"/>
                            </svg>
                        </div>
                        <div class="event-detail-content">
                            <div class="event-detail-label">Attendees</div>
                            <div class="event-detail-value" id="eventDetailsAttendees">--</div>
                        </div>
                    </div>
                    
                    <div class="event-detail-row" id="eventDetailsDescRow" style="display: none;">
                        <div class="event-detail-icon">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/>
                                <polyline points="14 2 14 8 20 8"/>
                                <line x1="16" y1="13" x2="8" y2="13"/>
                                <line x1="16" y1="17" x2="8" y2="17"/>
                            </svg>
                        </div>
                        <div class="event-detail-content">
                            <div class="event-detail-label">Description</div>
                            <div class="event-detail-value" id="eventDetailsDescription">--</div>
                        </div>
                    </div>
                    
                    <div class="event-detail-row">
                        <div class="event-detail-icon">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                                <path d="M22 6l-10 7L2 6"/>
                            </svg>
                        </div>
                        <div class="event-detail-content">
                            <div class="event-detail-label">Related Section</div>
                            <div class="event-detail-value">
                                <button class="btn btn-outline btn-sm" id="eventDetailsGoToSection" onclick="goToEventSection()">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <line x1="5" y1="12" x2="19" y2="12"/>
                                        <polyline points="12 5 19 12 12 19"/>
                                    </svg>
                                    Go to Section
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Edit Mode -->
                <div id="eventEditMode" style="display: none;">
                    <form id="editEventForm">
                        <div class="form-group">
                            <label>Event Title *</label>
                            <input type="text" id="editEventTitle" required class="form-control" placeholder="Enter event title...">
                        </div>
                        <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                            <div class="form-group">
                                <label>Date *</label>
                                <input type="date" id="editEventDate" required class="form-control">
                            </div>
                            <div class="form-group">
                                <label>Time</label>
                                <input type="time" id="editEventTime" class="form-control">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Category</label>
                            <select id="editEventCategory" class="form-control">
                                <option value="meeting"> Meeting</option>
                                <option value="standup"> Standup</option>
                                <option value="milestone"> Milestone</option>
                                <option value="payroll"> Payroll</option>
                                <option value="tax"> Tax</option>
                                <option value="compliance"> Compliance</option>
                                <option value="patent"> Patent</option>
                                <option value="report"> Report</option>
                                <option value="experiment"> Experiment</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Location</label>
                            <input type="text" id="editEventLocation" class="form-control" placeholder="Enter location...">
                        </div>
                        <div class="form-group">
                            <label>Description</label>
                            <textarea id="editEventDescription" rows="3" class="form-control" placeholder="Add details..."></textarea>
                        </div>
                    </form>
                </div>
            </div>
            
            <div class="event-details-footer">
                <div class="event-details-footer-left">
                    <button class="btn btn-danger btn-sm" id="deleteEventBtn" onclick="deleteEvent()">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="3 6 5 6 21 6"/>
                            <path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
                        </svg>
                        Delete
                    </button>
                </div>
                <div class="event-details-footer-right">
                    <!-- View Mode Buttons -->
                    <div id="viewModeButtons">
                        <button class="btn btn-secondary" onclick="shareEvent()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="18" cy="5" r="3"/>
                                <circle cx="6" cy="12" r="3"/>
                                <circle cx="18" cy="19" r="3"/>
                                <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/>
                                <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/>
                            </svg>
                            Share/Send
                        </button>
                        <button class="btn btn-primary" onclick="enterEditMode()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/>
                                <path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/>
                            </svg>
                            Edit Event
                        </button>
                    </div>
                    <!-- Edit Mode Buttons -->
                    <div id="editModeButtons" style="display: none;">
                        <button type="button" class="btn btn-secondary" onclick="cancelEditMode()">Cancel</button>
                        <button type="button" class="btn btn-primary" onclick="saveEventChanges()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/>
                                <polyline points="17 21 17 13 7 13 7 21"/>
                                <polyline points="7 3 7 8 15 8"/>
                            </svg>
                            Save Changes
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Share Event Modal -->
    <div class="modal" id="shareEventModal" style="z-index: 2300;">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; padding: 20px; border-bottom: 1px solid var(--border);">
                <h3 style="margin: 0;"> Share Event</h3>
                <button onclick="closeShareEventModal()" style="background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 1.5rem;">&times;</button>
            </div>
            <div class="modal-body" style="padding: 20px;">
                <p style="margin-bottom: 16px; color: var(--text-secondary);">Send this event to others via email, SMS, or copy the details to share.</p>
                
                <!-- Email Section -->
                <div class="form-group" style="margin-bottom: 16px;">
                    <label style="display: block; margin-bottom: 6px; font-size: 0.85rem; color: var(--text-muted);">Send to Email</label>
                    <div style="display: flex; gap: 8px;">
                        <input type="email" id="shareEventEmail" placeholder="Enter email address..." class="form-control" style="flex: 1; padding: 10px 12px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary);">
                        <button type="button" class="btn btn-primary btn-sm" onclick="sendEventEmail()" style="display: flex; align-items: center; gap: 6px;">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>
                            </svg>
                            Send
                        </button>
                    </div>
                </div>
                
                <!-- Phone/SMS Section -->
                <div class="form-group" style="margin-bottom: 16px;">
                    <label style="display: block; margin-bottom: 6px; font-size: 0.85rem; color: var(--text-muted);">Send via SMS</label>
                    <div style="display: flex; gap: 8px;">
                        <input type="tel" id="shareEventPhone" placeholder="Enter phone number..." class="form-control" style="flex: 1; padding: 10px 12px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary);">
                        <button type="button" class="btn btn-secondary btn-sm" onclick="sendEventSMS()" style="display: flex; align-items: center; gap: 6px;">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/>
                            </svg>
                            SMS
                        </button>
                    </div>
                </div>
                
                <div style="margin: 20px 0; text-align: center; color: var(--text-muted); font-size: 0.85rem;"> or </div>
                
                <div class="share-options" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                    <button class="share-option-btn" onclick="copyEventDetails()" style="display: flex; flex-direction: column; align-items: center; gap: 8px; padding: 16px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 12px; color: var(--text-primary); cursor: pointer; transition: all 0.2s;">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                            <path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/>
                        </svg>
                        <span style="font-size: 0.85rem;">Copy Details</span>
                    </button>
                    <button class="share-option-btn" onclick="downloadEventICS()" style="display: flex; flex-direction: column; align-items: center; gap: 8px; padding: 16px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 12px; color: var(--text-primary); cursor: pointer; transition: all 0.2s;">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
                            <polyline points="7 10 12 15 17 10"/>
                            <line x1="12" y1="15" x2="12" y2="3"/>
                        </svg>
                        <span style="font-size: 0.85rem;">Download .ics</span>
                    </button>
                    <button class="share-option-btn" onclick="addToGoogleCalendar()" style="display: flex; flex-direction: column; align-items: center; gap: 8px; padding: 16px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 12px; color: var(--text-primary); cursor: pointer; transition: all 0.2s;">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                            <line x1="16" y1="2" x2="16" y2="6"/>
                            <line x1="8" y1="2" x2="8" y2="6"/>
                            <line x1="3" y1="10" x2="21" y2="10"/>
                        </svg>
                        <span style="font-size: 0.85rem;">Add to Google</span>
                    </button>
                    <button class="share-option-btn" onclick="addToOutlookCalendar()" style="display: flex; flex-direction: column; align-items: center; gap: 8px; padding: 16px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 12px; color: var(--text-primary); cursor: pointer; transition: all 0.2s;">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                            <polyline points="22,6 12,13 2,6"/>
                        </svg>
                        <span style="font-size: 0.85rem;">Add to Outlook</span>
                    </button>
                </div>
            </div>
            <div class="modal-footer" style="padding: 16px 20px; border-top: 1px solid var(--border); display: flex; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="closeShareEventModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- ML Model Editor Modal -->
    <div class="modal" id="modelEditorModal" style="z-index: 2100;">
        <div class="modal-content model-editor-modal">
            <div class="model-editor-header">
                <div class="model-editor-header-left">
                    <div class="model-editor-icon" id="modelEditorIcon"></div>
                    <div>
                        <h2 id="modelEditorTitle">Edit Model</h2>
                        <p id="modelEditorSubtitle">Configure model settings</p>
                    </div>
                </div>
                <button onclick="closeModelEditor()" class="scheduler-close-btn">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            
            <form id="modelEditorForm" onsubmit="saveModel(event)">
                <div class="model-editor-body">
                    <div class="form-group">
                        <label>Model Name *</label>
                        <input type="text" id="modelName" required class="form-control" placeholder="e.g., Compatibility Scoring Engine">
                    </div>
                    
                    <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                        <div class="form-group">
                            <label>Icon</label>
                            <select id="modelIcon" class="form-control">
                                <option value=""> Heart</option>
                                <option value=""> Target</option>
                                <option value=""> Chat</option>
                                <option value=""> Calendar</option>
                                <option value=""> Dice</option>
                                <option value=""> Camera</option>
                                <option value=""> Brain</option>
                                <option value=""> Lightning</option>
                                <option value=""> Search</option>
                                <option value=""> Chart</option>
                                <option value=""> Shield</option>
                                <option value=""> Robot</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Model Type *</label>
                            <select id="modelType" class="form-control">
                                <option value="Multi-Factor Scoring">Multi-Factor Scoring</option>
                                <option value="Rule-Based Filter">Rule-Based Filter</option>
                                <option value="Template LLM (Simulated)">Template LLM (Simulated)</option>
                                <option value="Heuristic Scoring">Heuristic Scoring</option>
                                <option value="Jaccard Similarity">Jaccard Similarity</option>
                                <option value="Template Response">Template Response</option>
                                <option value="Neural Network">Neural Network</option>
                                <option value="Decision Tree">Decision Tree</option>
                                <option value="Collaborative Filtering">Collaborative Filtering</option>
                                <option value="NLP Model">NLP Model</option>
                                <option value="Computer Vision">Computer Vision</option>
                                <option value="Custom Algorithm">Custom Algorithm</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                        <div class="form-group">
                            <label>Code Location</label>
                            <input type="text" id="modelLocation" class="form-control" placeholder="e.g., app.js:8230-8290">
                        </div>
                        <div class="form-group">
                            <label>Status *</label>
                            <select id="modelStatus" class="form-control">
                                <option value="active"> Active</option>
                                <option value="simulated"> Simulated</option>
                                <option value="testing"> Testing</option>
                                <option value="disabled"> Disabled</option>
                                <option value="planned"> Planned</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Purpose / Description *</label>
                        <textarea id="modelPurpose" rows="3" required class="form-control" placeholder="Describe what this model does..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>Version</label>
                        <input type="text" id="modelVersion" class="form-control" placeholder="e.g., v1.0">
                    </div>
                    
                    <!-- Advanced Settings (collapsible) -->
                    <div class="model-advanced-toggle" onclick="toggleAdvancedSettings()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" id="advancedToggleIcon">
                            <polyline points="6 9 12 15 18 9"/>
                        </svg>
                        <span>Advanced Settings</span>
                    </div>
                    
                    <div id="modelAdvancedSettings" style="display: none;">
                        <div class="form-group">
                            <label>API Endpoint (if external)</label>
                            <input type="text" id="modelApiEndpoint" class="form-control" placeholder="https://api.example.com/model">
                        </div>
                        <div class="form-group">
                            <label>API Key Name (env variable)</label>
                            <input type="text" id="modelApiKey" class="form-control" placeholder="e.g., OPENAI_API_KEY">
                        </div>
                        <div class="form-group">
                            <label>Configuration JSON</label>
                            <textarea id="modelConfig" rows="4" class="form-control" placeholder='{"threshold": 0.8, "maxResults": 10}'></textarea>
                        </div>
                        <div class="form-group">
                            <label>Notes</label>
                            <textarea id="modelNotes" rows="2" class="form-control" placeholder="Internal notes about this model..."></textarea>
                        </div>
                    </div>
                </div>
                
                <div class="model-editor-footer">
                    <div class="model-editor-footer-left">
                        <button type="button" class="btn btn-danger btn-sm" id="deleteModelBtn" onclick="deleteModel()" style="display: none;">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="3 6 5 6 21 6"/>
                                <path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
                            </svg>
                            Delete
                        </button>
                    </div>
                    <div class="model-editor-footer-right">
                        <button type="button" class="btn btn-secondary" onclick="closeModelEditor()">Cancel</button>
                        <button type="submit" class="btn btn-primary">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/>
                                <polyline points="17 21 17 13 7 13 7 21"/>
                                <polyline points="7 3 7 8 15 8"/>
                            </svg>
                            Save & Sync to AWS
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <script>
        // ==========================================
        // ADMIN CALENDAR SYSTEM
        // ==========================================
        
        let calendarCurrentDate = new Date();
        let calendarSelectedDate = null;
        let calendarEvents = [];
        
        // Initialize calendar events from all admin sections
        function initCalendarEvents() {
            const today = new Date();
            const currentYear = today.getFullYear();
            const currentMonth = today.getMonth();
            
            // Map section for different types
            const sectionMap = {
                'tax': 'tax',
                'legal': 'legal',
                'patent': 'legal',
                'compliance': 'compliance',
                'payroll': 'payroll',
                'milestone': 'overview',
                'task': 'calendar'
            };
            
            // Convert projectMilestones to calendar events
            calendarEvents = projectMilestones.map(m => ({
                date: new Date(m.date),
                title: m.title,
                category: m.category || m.type || 'milestone',
                section: sectionMap[m.category] || sectionMap[m.type] || 'calendar',
                critical: m.critical || false,
                phase: m.phase
            }));
            
            // Add recurring events
            const recurringEvents = [
                // Weekly safety reports
                { date: new Date(currentYear, currentMonth, 7), title: 'Weekly Safety Report', category: 'report', section: 'safety' },
                { date: new Date(currentYear, currentMonth, 14), title: 'Weekly Safety Report', category: 'report', section: 'safety' },
                { date: new Date(currentYear, currentMonth, 21), title: 'Weekly Safety Report', category: 'report', section: 'safety' },
                { date: new Date(currentYear, currentMonth, 28), title: 'Weekly Safety Report', category: 'report', section: 'safety' },
                
                // Team meetings
                { date: new Date(currentYear, currentMonth, 3), title: 'Leadership Standup', category: 'meeting', section: 'org-hierarchy' },
                { date: new Date(currentYear, currentMonth, 10), title: 'All Hands Meeting', category: 'meeting', section: 'org-hierarchy' },
                { date: new Date(currentYear, currentMonth, 17), title: 'Leadership Standup', category: 'meeting', section: 'org-hierarchy' },
                { date: new Date(currentYear, currentMonth, 24), title: 'Sprint Planning', category: 'meeting', section: 'org-hierarchy' },
                
                // Monthly KPI review
                { date: new Date(currentYear, currentMonth, 1), title: 'Monthly KPI Review', category: 'milestone', section: 'dashboard' },
                
                // Email setup task - tomorrow
                { date: new Date(today.getTime() + 86400000), title: 'Set Up Email Service (Google Workspace)', category: 'task', section: 'overview', custom: true }
            ];
            
            calendarEvents.push(...recurringEvents);
            
            // Load custom events from localStorage
            const savedEvents = localStorage.getItem('oith_calendar_events');
            if (savedEvents) {
                const customEvents = JSON.parse(savedEvents);
                customEvents.forEach(e => {
                    // Fix timezone issue: parse date strings as LOCAL dates, not UTC
                    // "2025-12-12" parsed as-is becomes UTC midnight (wrong day in local time)
                    if (typeof e.date === 'string') {
                        if (e.date.includes('T')) {
                            // ISO format with time - parse normally
                            e.date = new Date(e.date);
                        } else {
                            // Date-only string like "2025-12-12" - parse as local date
                            const parts = e.date.split('-');
                            e.date = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
                        }
                    } else {
                        e.date = new Date(e.date);
                    }
                    calendarEvents.push(e);
                });
            }
            
            updateCalendarBadge();
        }
        
        function updateCalendarBadge() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const nextWeek = new Date(today);
            nextWeek.setDate(nextWeek.getDate() + 7);
            
            const upcomingCount = calendarEvents.filter(e => {
                const eventDate = new Date(e.date);
                eventDate.setHours(0, 0, 0, 0);
                return eventDate >= today && eventDate <= nextWeek;
            }).length;
            
            const badge = document.getElementById('calendarEventCount');
            if (badge) {
                badge.textContent = upcomingCount;
                badge.setAttribute('data-count', upcomingCount);
            }
        }
        
        // Generate detailed notes for calendar events
        function generateEventNotes(event) {
            const eventNotes = {
                // Business Formation & Legal
                'Register LLC': {
                    timeEstimate: '3-5 business days',
                    subRequirements: [
                        { text: 'Choose state of incorporation (Delaware recommended)', done: true },
                        { text: 'Select registered agent service', done: true },
                        { text: 'File Articles of Organization', done: false },
                        { text: 'Pay state filing fees ($90-$500)', done: false },
                        { text: 'Draft Operating Agreement', done: false }
                    ],
                    notes: 'Ensure all founders sign the Operating Agreement. Keep certified copies for bank account opening.'
                },
                'Obtain EIN': {
                    timeEstimate: '15-30 minutes',
                    subRequirements: [
                        { text: 'Have LLC formation documents ready', done: true },
                        { text: 'Complete IRS Form SS-4 online', done: false },
                        { text: 'Receive EIN confirmation letter', done: false }
                    ],
                    notes: 'Apply online at IRS.gov for immediate EIN. Required for bank accounts and hiring.'
                },
                'Open Business Bank Account': {
                    timeEstimate: '1-2 hours',
                    subRequirements: [
                        { text: 'Gather LLC formation documents', done: false },
                        { text: 'Bring EIN confirmation', done: false },
                        { text: 'Prepare initial deposit ($100+)', done: false },
                        { text: 'Set up online banking access', done: false }
                    ],
                    notes: 'Consider Mercury, Brex, or traditional bank. Ensure business credit card option available.'
                },
                'Business Formation Complete': {
                    timeEstimate: 'Milestone',
                    subRequirements: [
                        { text: 'LLC registered and active', done: false },
                        { text: 'EIN obtained', done: false },
                        { text: 'Bank account opened', done: false },
                        { text: 'Operating Agreement executed', done: false }
                    ],
                    notes: 'All legal foundation complete. Ready to proceed with development and hiring.'
                },
                'D-U-N-S Number Received': {
                    timeEstimate: '1-30 days',
                    subRequirements: [
                        { text: 'Apply via Dun & Bradstreet', done: false },
                        { text: 'Verify business information', done: false },
                        { text: 'Receive 9-digit D-U-N-S number', done: false }
                    ],
                    notes: 'Required for Apple Developer enrollment. Free application takes 30 days; expedited costs $229.'
                },
                'Developer Accounts (Apple & Google)': {
                    timeEstimate: '1-7 days',
                    subRequirements: [
                        { text: 'Apple Developer Program ($99/year)', done: false },
                        { text: 'D-U-N-S number verification for Apple', done: false },
                        { text: 'Google Play Console ($25 one-time)', done: false },
                        { text: 'Set up app signing certificates', done: false }
                    ],
                    notes: 'Apple requires D-U-N-S and takes longer to approve. Start Apple process first.'
                },
                'Legal Documents Ready': {
                    timeEstimate: '2-3 weeks',
                    subRequirements: [
                        { text: 'Privacy Policy (GDPR/CCPA compliant)', done: false },
                        { text: 'Terms of Service', done: false },
                        { text: 'User Agreement', done: false },
                        { text: 'Cookie Policy', done: false },
                        { text: 'Community Guidelines', done: false }
                    ],
                    notes: 'Have legal counsel review all documents. Must be accessible in-app before launch.'
                },
                
                // Development Milestones
                'Development Kickoff': {
                    timeEstimate: 'Ongoing',
                    subRequirements: [
                        { text: 'Development environment setup', done: false },
                        { text: 'Git repository initialized', done: false },
                        { text: 'CI/CD pipeline configured', done: false },
                        { text: 'Team access permissions set', done: false }
                    ],
                    notes: 'All developers should have local environments ready. Review coding standards.'
                },
                'Infrastructure Setup Complete': {
                    timeEstimate: '3-5 days',
                    subRequirements: [
                        { text: 'AWS account configured', done: false },
                        { text: 'DynamoDB tables created', done: false },
                        { text: 'S3 buckets for media storage', done: false },
                        { text: 'Lambda functions deployed', done: false },
                        { text: 'API Gateway configured', done: false }
                    ],
                    notes: 'Enable CloudWatch monitoring from day one. Set up cost alerts.'
                },
                'User Registration & Auth': {
                    timeEstimate: '1-2 weeks',
                    subRequirements: [
                        { text: 'Email/password authentication', done: false },
                        { text: 'Social login (Google, Apple)', done: false },
                        { text: 'Email verification flow', done: false },
                        { text: 'Password reset functionality', done: false },
                        { text: 'Session management', done: false }
                    ],
                    notes: 'Use AWS Cognito for production. Implement rate limiting on auth endpoints.'
                },
                'API Architecture Ready': {
                    timeEstimate: '1 week',
                    subRequirements: [
                        { text: 'RESTful API design complete', done: false },
                        { text: 'API documentation (Swagger)', done: false },
                        { text: 'Authentication middleware', done: false },
                        { text: 'Error handling standards', done: false }
                    ],
                    notes: 'Follow REST best practices. Version API from start (v1/endpoints).'
                },
                'Profile Creation Complete': {
                    timeEstimate: '1-2 weeks',
                    subRequirements: [
                        { text: 'Profile data model finalized', done: false },
                        { text: 'Photo upload & processing', done: false },
                        { text: 'Bio and preferences input', done: false },
                        { text: 'Profile validation rules', done: false },
                        { text: 'Profile preview functionality', done: false }
                    ],
                    notes: 'Implement image compression. Max 6 photos per profile.'
                },
                'Location Services': {
                    timeEstimate: '3-5 days',
                    subRequirements: [
                        { text: 'Geolocation permission handling', done: false },
                        { text: 'Distance calculation algorithm', done: false },
                        { text: 'Location privacy controls', done: false },
                        { text: 'Background location updates', done: false }
                    ],
                    notes: 'Request location only when needed. Provide clear privacy explanation.'
                },
                'Core Matching Algorithm Complete': {
                    timeEstimate: '2-3 weeks',
                    subRequirements: [
                        { text: 'Compatibility scoring logic', done: false },
                        { text: 'Preference matching', done: false },
                        { text: 'Location-based filtering', done: false },
                        { text: 'Match queue management', done: false },
                        { text: 'Algorithm performance testing', done: false }
                    ],
                    notes: 'Start with simple scoring, iterate based on user feedback. Log all match decisions.'
                },
                'Match Notifications': {
                    timeEstimate: '3-5 days',
                    subRequirements: [
                        { text: 'Push notification setup', done: false },
                        { text: 'Match alert triggers', done: false },
                        { text: 'Notification preferences', done: false },
                        { text: 'Deep linking to matches', done: false }
                    ],
                    notes: 'Use Firebase Cloud Messaging. Respect user notification preferences.'
                },
                'User Reporting System': {
                    timeEstimate: '1 week',
                    subRequirements: [
                        { text: 'Report categories defined', done: false },
                        { text: 'Report submission UI', done: false },
                        { text: 'Admin review dashboard', done: false },
                        { text: 'Automated content flagging', done: false }
                    ],
                    notes: 'Critical for app store approval. Include block/unmatch functionality.'
                },
                'In-App Messaging/Chat': {
                    timeEstimate: '2-3 weeks',
                    subRequirements: [
                        { text: 'Real-time messaging (WebSocket)', done: false },
                        { text: 'Message persistence', done: false },
                        { text: 'Read receipts', done: false },
                        { text: 'Image sharing in chat', done: false },
                        { text: 'Chat history management', done: false }
                    ],
                    notes: 'Consider using AWS AppSync or Socket.io. Implement message content moderation.'
                },
                'Push Notifications': {
                    timeEstimate: '3-5 days',
                    subRequirements: [
                        { text: 'FCM/APNs integration', done: false },
                        { text: 'Notification categories', done: false },
                        { text: 'User preference management', done: false },
                        { text: 'Deep link handling', done: false }
                    ],
                    notes: 'Test on physical devices. Handle notification permissions gracefully.'
                },
                'Payment Service': {
                    timeEstimate: '1-2 weeks',
                    subRequirements: [
                        { text: 'Stripe integration', done: false },
                        { text: 'In-app purchases (iOS/Android)', done: false },
                        { text: 'Subscription management', done: false },
                        { text: 'Receipt validation', done: false },
                        { text: 'Refund handling', done: false }
                    ],
                    notes: 'Apple/Google take 30% commission. Implement server-side receipt validation.'
                },
                'MVP Feature-Complete': {
                    timeEstimate: 'Milestone',
                    subRequirements: [
                        { text: 'All core features functional', done: false },
                        { text: 'Basic UI/UX complete', done: false },
                        { text: 'Critical bugs resolved', done: false },
                        { text: 'Performance acceptable', done: false }
                    ],
                    notes: 'Focus on stability over features. Prepare for alpha testing.'
                },
                
                // Testing & QA
                'Alpha Testing Begins': {
                    timeEstimate: '2 weeks',
                    subRequirements: [
                        { text: 'Internal team testing', done: false },
                        { text: 'Bug tracking system ready', done: false },
                        { text: 'Crash reporting enabled', done: false },
                        { text: 'Feedback collection process', done: false }
                    ],
                    notes: 'Limit to 10-20 internal testers. Focus on critical user flows.'
                },
                'Unit Test Coverage >80%': {
                    timeEstimate: 'Ongoing',
                    subRequirements: [
                        { text: 'Write unit tests for core logic', done: false },
                        { text: 'Set up code coverage reporting', done: false },
                        { text: 'Integrate with CI/CD', done: false }
                    ],
                    notes: 'Focus on business logic and API endpoints. Mock external services.'
                },
                'Closed Beta (50 users)': {
                    timeEstimate: '2-4 weeks',
                    subRequirements: [
                        { text: 'TestFlight/Play Store internal track', done: false },
                        { text: 'NDA for beta testers', done: false },
                        { text: 'Feedback survey prepared', done: false },
                        { text: 'Crash monitoring active', done: false }
                    ],
                    notes: 'Recruit diverse tester demographics. Respond to feedback within 48 hours.'
                },
                'Beta Testing 500+ Users': {
                    timeEstimate: '4-6 weeks',
                    subRequirements: [
                        { text: 'Public beta program launch', done: false },
                        { text: 'Onboarding flow optimized', done: false },
                        { text: 'Load testing completed', done: false },
                        { text: 'Analytics tracking verified', done: false }
                    ],
                    notes: 'Monitor server costs closely. Prepare scaling strategy.'
                },
                'End-to-End Testing': {
                    timeEstimate: '1 week',
                    subRequirements: [
                        { text: 'User journey automation', done: false },
                        { text: 'Cross-browser testing', done: false },
                        { text: 'Mobile device testing', done: false },
                        { text: 'Edge case validation', done: false }
                    ],
                    notes: 'Use Cypress or Detox for automation. Test on multiple device sizes.'
                },
                'Security Penetration Testing': {
                    timeEstimate: '1-2 weeks',
                    subRequirements: [
                        { text: 'Hire security auditor', done: false },
                        { text: 'OWASP vulnerability scan', done: false },
                        { text: 'API security review', done: false },
                        { text: 'Remediate findings', done: false }
                    ],
                    notes: 'Required before launch. Document all findings and fixes.'
                },
                'Load Testing (10K users)': {
                    timeEstimate: '1 week',
                    subRequirements: [
                        { text: 'Set up load testing environment', done: false },
                        { text: 'Simulate concurrent users', done: false },
                        { text: 'Identify bottlenecks', done: false },
                        { text: 'Optimize database queries', done: false }
                    ],
                    notes: 'Use k6 or Artillery. Test during off-peak hours on staging.'
                },
                'Open Beta (2,000 users)': {
                    timeEstimate: '4-8 weeks',
                    subRequirements: [
                        { text: 'Marketing landing page', done: false },
                        { text: 'Waitlist management', done: false },
                        { text: 'User acquisition strategy', done: false },
                        { text: 'Community building', done: false }
                    ],
                    notes: 'Gradual rollout by invitation. Monitor user retention closely.'
                },
                'All Critical Bugs Fixed': {
                    timeEstimate: 'Milestone',
                    subRequirements: [
                        { text: 'Zero P0/P1 bugs', done: false },
                        { text: 'Crash rate < 0.1%', done: false },
                        { text: 'All security issues resolved', done: false }
                    ],
                    notes: 'Freeze features 2 weeks before launch. Focus only on stability.'
                },
                
                // Compliance
                'GDPR Compliance Review': {
                    timeEstimate: '2-3 weeks',
                    subRequirements: [
                        { text: 'Data processing documentation', done: false },
                        { text: 'User consent mechanisms', done: false },
                        { text: 'Data export functionality', done: false },
                        { text: 'Account deletion process', done: false },
                        { text: 'Privacy impact assessment', done: false }
                    ],
                    notes: 'Required for EU users. Appoint Data Protection Officer if needed.'
                },
                'CCPA Compliance Review': {
                    timeEstimate: '1-2 weeks',
                    subRequirements: [
                        { text: 'Privacy policy updates', done: false },
                        { text: 'Do Not Sell opt-out', done: false },
                        { text: 'Data deletion requests', done: false },
                        { text: 'Consumer rights documentation', done: false }
                    ],
                    notes: 'Required for California users. Similar to GDPR but US-focused.'
                },
                'App Store Guidelines Compliance': {
                    timeEstimate: '1 week',
                    subRequirements: [
                        { text: 'Content guidelines review', done: false },
                        { text: 'In-app purchase compliance', done: false },
                        { text: 'Privacy requirements met', done: false },
                        { text: 'Age rating determined', done: false }
                    ],
                    notes: 'Dating apps often rated 17+. Expect 2-3 review iterations.'
                },
                'PCI DSS Compliance (Payments)': {
                    timeEstimate: '2-4 weeks',
                    subRequirements: [
                        { text: 'Use PCI-compliant provider', done: false },
                        { text: 'No card data on servers', done: false },
                        { text: 'SSL/TLS everywhere', done: false },
                        { text: 'Self-assessment questionnaire', done: false }
                    ],
                    notes: 'Stripe handles most PCI requirements. Never store card numbers.'
                },
                'ADA Accessibility Audit': {
                    timeEstimate: '1-2 weeks',
                    subRequirements: [
                        { text: 'Screen reader compatibility', done: false },
                        { text: 'Color contrast compliance', done: false },
                        { text: 'Touch target sizes', done: false },
                        { text: 'Alt text for images', done: false }
                    ],
                    notes: 'WCAG 2.1 AA compliance recommended. Test with VoiceOver/TalkBack.'
                },
                
                // Meetings
                'Weekly Safety Report': {
                    timeEstimate: '30 minutes',
                    subRequirements: [
                        { text: 'Review new user reports', done: false },
                        { text: 'Analyze flagged content', done: false },
                        { text: 'Update moderation policies', done: false },
                        { text: 'Team safety briefing', done: false }
                    ],
                    notes: 'Document all moderation decisions. Track report resolution times.'
                },
                'Leadership Standup': {
                    timeEstimate: '15 minutes',
                    subRequirements: [
                        { text: 'Progress updates from each lead', done: false },
                        { text: 'Blockers identification', done: false },
                        { text: 'Priority alignment', done: false }
                    ],
                    notes: 'Keep concise. Move detailed discussions to separate meetings.'
                },
                'All Hands Meeting': {
                    timeEstimate: '1 hour',
                    subRequirements: [
                        { text: 'Company updates', done: false },
                        { text: 'Milestone celebrations', done: false },
                        { text: 'Q&A session', done: false },
                        { text: 'Team recognition', done: false }
                    ],
                    notes: 'Record for those who cannot attend. Send recap notes within 24 hours.'
                },
                'Sprint Planning': {
                    timeEstimate: '2 hours',
                    subRequirements: [
                        { text: 'Review backlog items', done: false },
                        { text: 'Estimate story points', done: false },
                        { text: 'Assign tasks', done: false },
                        { text: 'Define sprint goal', done: false }
                    ],
                    notes: 'Ensure team capacity considered. Leave buffer for bugs and support.'
                },
                'Monthly KPI Review': {
                    timeEstimate: '1 hour',
                    subRequirements: [
                        { text: 'Gather metrics data', done: false },
                        { text: 'Compare to targets', done: false },
                        { text: 'Identify trends', done: false },
                        { text: 'Set action items', done: false }
                    ],
                    notes: 'Focus on actionable insights. Track user growth, retention, and revenue.'
                },
                
                // Patents
                'PCT International Application Q4 2025': {
                    timeEstimate: '2-3 months',
                    subRequirements: [
                        { text: 'Patent search completed', done: false },
                        { text: 'Claims drafted', done: false },
                        { text: 'Figures and drawings', done: false },
                        { text: 'Attorney review', done: false },
                        { text: 'PCT filing submitted', done: false }
                    ],
                    notes: 'Budget $3,000-$15,000 for filing. Consider provisional first.'
                },
                
                // Payroll
                'December Payroll': {
                    timeEstimate: '2-3 hours',
                    subRequirements: [
                        { text: 'Verify hours/salaries', done: false },
                        { text: 'Calculate deductions', done: false },
                        { text: 'Process payments', done: false },
                        { text: 'File tax documents', done: false }
                    ],
                    notes: 'Process 2 business days before pay date. Verify bank details.'
                }
            };
            
            // Try to find exact match first
            if (eventNotes[event.title]) {
                return eventNotes[event.title];
            }
            
            // Try partial match
            for (const key in eventNotes) {
                if (event.title.includes(key) || key.includes(event.title)) {
                    return eventNotes[key];
                }
            }
            
            // Generate generic notes based on category
            const categoryNotes = {
                'meeting': {
                    timeEstimate: '30-60 minutes',
                    subRequirements: [
                        { text: 'Prepare agenda', done: false },
                        { text: 'Send calendar invites', done: false },
                        { text: 'Take meeting notes', done: false }
                    ],
                    notes: 'Ensure all participants are available. Share agenda 24 hours in advance.'
                },
                'milestone': {
                    timeEstimate: 'Varies',
                    subRequirements: [
                        { text: 'Verify completion criteria', done: false },
                        { text: 'Document deliverables', done: false },
                        { text: 'Team sign-off', done: false }
                    ],
                    notes: 'Review milestone requirements with stakeholders before marking complete.'
                },
                'compliance': {
                    timeEstimate: '1-2 weeks',
                    subRequirements: [
                        { text: 'Review requirements', done: false },
                        { text: 'Document evidence', done: false },
                        { text: 'Internal audit', done: false }
                    ],
                    notes: 'Maintain audit trail. Consult legal counsel for complex requirements.'
                },
                'report': {
                    timeEstimate: '1-2 hours',
                    subRequirements: [
                        { text: 'Gather data', done: false },
                        { text: 'Analyze findings', done: false },
                        { text: 'Create summary', done: false }
                    ],
                    notes: 'Use consistent format. Archive all reports for future reference.'
                },
                'payroll': {
                    timeEstimate: '2-3 hours',
                    subRequirements: [
                        { text: 'Verify employee data', done: false },
                        { text: 'Calculate payments', done: false },
                        { text: 'Process transactions', done: false }
                    ],
                    notes: 'Double-check all calculations. Process 2 business days early.'
                },
                'patent': {
                    timeEstimate: '2-4 weeks',
                    subRequirements: [
                        { text: 'Prior art search', done: false },
                        { text: 'Draft claims', done: false },
                        { text: 'Attorney review', done: false }
                    ],
                    notes: 'Document all invention details. Maintain inventor records.'
                },
                'tax': {
                    timeEstimate: '1-2 weeks',
                    subRequirements: [
                        { text: 'Gather financial records', done: false },
                        { text: 'Calculate obligations', done: false },
                        { text: 'File required forms', done: false }
                    ],
                    notes: 'Consult tax professional. Keep all receipts and documentation.'
                }
            };
            
            return categoryNotes[event.category] || {
                timeEstimate: 'TBD',
                subRequirements: [
                    { text: 'Review event requirements', done: false },
                    { text: 'Prepare necessary materials', done: false },
                    { text: 'Complete event deliverables', done: false }
                ],
                notes: 'Add specific notes for this event as details become available.'
            };
        }
        
        function openAdminCalendar() {
            initCalendarEvents();
            calendarCurrentDate = new Date();
            renderCalendar();
            renderUpcomingEvents();
            document.getElementById('adminCalendarModal').classList.add('active');
        }
        
        function closeAdminCalendar() {
            document.getElementById('adminCalendarModal').classList.remove('active');
        }
        
        function calendarPrevMonth() {
            calendarCurrentDate.setMonth(calendarCurrentDate.getMonth() - 1);
            renderCalendar();
        }
        
        function calendarNextMonth() {
            calendarCurrentDate.setMonth(calendarCurrentDate.getMonth() + 1);
            renderCalendar();
        }
        
        function calendarGoToday() {
            calendarCurrentDate = new Date();
            renderCalendar();
        }
        
        function renderCalendar() {
            const year = calendarCurrentDate.getFullYear();
            const month = calendarCurrentDate.getMonth();
            
            // Update month display
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                               'July', 'August', 'September', 'October', 'November', 'December'];
            document.getElementById('calendarMonthDisplay').textContent = `${monthNames[month]} ${year}`;
            
            // Get first day of month and total days
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startingDayOfWeek = firstDay.getDay();
            const totalDays = lastDay.getDate();
            
            // Get previous month's last days
            const prevMonthLastDay = new Date(year, month, 0).getDate();
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const grid = document.getElementById('adminCalendarGrid');
            if (!grid) return;
            grid.innerHTML = '';
            
            // Add previous month's trailing days
            for (let i = startingDayOfWeek - 1; i >= 0; i--) {
                const dayNum = prevMonthLastDay - i;
                const dayEl = createCalendarDay(dayNum, true, new Date(year, month - 1, dayNum));
                grid.appendChild(dayEl);
            }
            
            // Add current month's days
            for (let day = 1; day <= totalDays; day++) {
                const date = new Date(year, month, day);
                const isToday = date.getTime() === today.getTime();
                const dayEl = createCalendarDay(day, false, date, isToday);
                grid.appendChild(dayEl);
            }
            
            // Add next month's leading days
            const totalCells = grid.children.length;
            const remainingCells = 42 - totalCells; // 6 rows  7 days
            for (let i = 1; i <= remainingCells; i++) {
                const dayEl = createCalendarDay(i, true, new Date(year, month + 1, i));
                grid.appendChild(dayEl);
            }
        }
        
        function createCalendarDay(dayNum, isOtherMonth, date, isToday = false) {
            const dayEl = document.createElement('div');
            dayEl.className = 'calendar-day';
            if (isOtherMonth) dayEl.classList.add('other-month');
            if (isToday) dayEl.classList.add('today');
            
            dayEl.innerHTML = `<div class="day-number">${dayNum}</div><div class="day-events"></div>`;
            
            // Get events for this day
            const dayEvents = calendarEvents.filter(e => {
                const eventDate = new Date(e.date);
                return eventDate.getDate() === date.getDate() && 
                       eventDate.getMonth() === date.getMonth() && 
                       eventDate.getFullYear() === date.getFullYear();
            });
            
            const eventsContainer = dayEl.querySelector('.day-events');
            const maxVisible = 2;
            
            dayEvents.slice(0, maxVisible).forEach(event => {
                const eventEl = document.createElement('div');
                eventEl.className = `day-event ${event.category}`;
                eventEl.textContent = event.title;
                eventEl.onclick = (e) => {
                    e.stopPropagation();
                    openEventDetails(event);
                };
                eventsContainer.appendChild(eventEl);
            });
            
            if (dayEvents.length > maxVisible) {
                const moreEl = document.createElement('div');
                moreEl.className = 'day-event-count';
                moreEl.textContent = `+${dayEvents.length - maxVisible} more`;
                eventsContainer.appendChild(moreEl);
            }
            
            dayEl.onclick = (e) => selectCalendarDay(e, date);
            
            return dayEl;
        }
        
        function selectCalendarDay(e, date) {
            // Remove selected class from all days
            document.querySelectorAll('.calendar-day').forEach(d => d.classList.remove('selected'));
            
            // Add selected class to clicked day
            if (e && e.currentTarget) {
                e.currentTarget.classList.add('selected');
            }
            
            calendarSelectedDate = date;
            
            // Re-query events for this day (to get the latest data including newly added events)
            const currentDayEvents = calendarEvents.filter(ev => {
                const eventDate = new Date(ev.date);
                return eventDate.getDate() === date.getDate() && 
                       eventDate.getMonth() === date.getMonth() && 
                       eventDate.getFullYear() === date.getFullYear();
            });
            
            // Update sidebar with selected day's events (show even if no events)
            renderDayEvents(date, currentDayEvents);
        }
        
        function renderDayEvents(date, events) {
            const list = document.getElementById('upcomingEventsList');
            if (!list) return;
            
            list.innerHTML = `<div style="font-size: 0.85rem; color: var(--text-primary); margin-bottom: 12px; font-weight: 600;">
                ${date.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' })}
            </div>`;
            
            if (!events || events.length === 0) {
                const noEventsEl = document.createElement('div');
                noEventsEl.style.cssText = 'color: var(--text-muted); font-size: 0.85rem; text-align: center; padding: 20px;';
                noEventsEl.textContent = 'No events on this day';
                list.appendChild(noEventsEl);
                
                // Add a button to create an event on this day
                const addBtn = document.createElement('button');
                addBtn.className = 'btn btn-secondary';
                addBtn.style.cssText = 'width: 100%; margin-top: 12px; padding: 10px; display: flex; align-items: center; justify-content: center; gap: 8px;';
                addBtn.innerHTML = '<span>+</span> Add Event on This Day';
                addBtn.onclick = () => {
                    openAddEventModal();
                    // Pre-fill the date
                    setTimeout(() => {
                        const dateInput = document.getElementById('eventDate');
                        if (dateInput) {
                            const year = date.getFullYear();
                            const month = String(date.getMonth() + 1).padStart(2, '0');
                            const day = String(date.getDate()).padStart(2, '0');
                            dateInput.value = `${year}-${month}-${day}`;
                        }
                    }, 100);
                };
                list.appendChild(addBtn);
                return;
            }
            
            events.forEach(event => {
                const eventEl = document.createElement('div');
                eventEl.className = `upcoming-event ${event.category}`;
                eventEl.style.cssText = 'cursor: pointer;';
                eventEl.innerHTML = `
                    <div class="event-title">${event.title}</div>
                    <div class="event-meta">
                        <span class="event-category" style="background: rgba(var(--${getCategoryColor(event.category)}), 0.2); color: var(--${getCategoryColorVar(event.category)});">${event.category || 'custom'}</span>
                        <span> ${event.section || 'calendar'}</span>
                    </div>
                `;
                eventEl.onclick = () => openEventDetails(event);
                list.appendChild(eventEl);
            });
        }
        
        function renderUpcomingEvents() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const upcoming = calendarEvents
                .filter(e => new Date(e.date) >= today)
                .sort((a, b) => new Date(a.date) - new Date(b.date))
                .slice(0, 5);
            
            const list = document.getElementById('upcomingEventsList');
            list.innerHTML = '';
            
            if (upcoming.length === 0) {
                list.innerHTML = '<div style="color: var(--text-muted); font-size: 0.85rem; text-align: center; padding: 20px;">No upcoming events</div>';
                return;
            }
            
            upcoming.forEach(event => {
                const eventDate = new Date(event.date);
                const isToday = eventDate.toDateString() === today.toDateString();
                const isTomorrow = eventDate.toDateString() === new Date(today.getTime() + 86400000).toDateString();
                
                let dateStr = eventDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                if (isToday) dateStr = 'Today';
                if (isTomorrow) dateStr = 'Tomorrow';
                
                const eventEl = document.createElement('div');
                eventEl.className = `upcoming-event ${event.category}`;
                eventEl.innerHTML = `
                    <div class="event-title">${event.title}</div>
                    <div class="event-meta">
                        <span>${dateStr}</span>
                        <span></span>
                        <span>${event.section}</span>
                    </div>
                `;
                eventEl.onclick = () => openEventDetails(event);
                list.appendChild(eventEl);
            });
        }
        
        function getCategoryColor(category) {
            const colors = {
                payroll: '34, 197, 94',
                report: '239, 68, 68',
                experiment: '59, 130, 246',
                compliance: '249, 115, 22',
                meeting: '139, 92, 246',
                tax: '236, 72, 153',
                milestone: '14, 165, 233',
                patent: '168, 85, 247'
            };
            return colors[category] || '139, 92, 246';
        }
        
        function getCategoryColorVar(category) {
            const vars = {
                payroll: 'success',
                report: 'danger',
                experiment: 'info',
                compliance: 'warning',
                meeting: 'accent',
                tax: 'pink',
                milestone: 'info',
                patent: 'purple'
            };
            return vars[category] || 'accent';
        }
        
        function navigateToSection(section) {
            closeAdminCalendar();
            if (section && typeof showSection === 'function') {
                showSection(section);
            }
        }
        
        function openAddEventModal() {
            let modal = document.getElementById('addEventModal');
            
            // Create modal dynamically if it doesn't exist
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'addEventModal';
                modal.className = 'modal';
                modal.style.cssText = 'z-index: 2100; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: none; align-items: center; justify-content: center;';
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 520px; background: var(--bg-card); border-radius: 16px; padding: 24px; border: 1px solid var(--border);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 16px; border-bottom: 1px solid var(--border);">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <div style="width: 40px; height: 40px; background: linear-gradient(135deg, var(--accent) 0%, var(--purple) 100%); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem;"></div>
                                <div>
                                    <h3 style="margin: 0; font-size: 1.1rem; color: var(--text-primary);">Add New Event</h3>
                                    <p style="margin: 0; font-size: 0.8rem; color: var(--text-muted);">Create a calendar event</p>
                                </div>
                            </div>
                            <button onclick="closeAddEventModal()" style="background: var(--bg-tertiary); border: none; color: var(--text-muted); cursor: pointer; font-size: 1.2rem; width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center;">&times;</button>
                        </div>
                        <form id="addEventForm" onsubmit="saveCalendarEvent(event)">
                            <div style="margin-bottom: 16px;">
                                <label style="display: block; font-size: 0.85rem; color: var(--text-muted); margin-bottom: 6px;">Event Title *</label>
                                <input type="text" id="eventTitle" required placeholder="Enter event title..." style="width: 100%; padding: 12px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 10px; color: var(--text-primary); font-size: 0.95rem;">
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                                <div>
                                    <label style="display: block; font-size: 0.85rem; color: var(--text-muted); margin-bottom: 6px;">Date *</label>
                                    <input type="date" id="eventDate" required style="width: 100%; padding: 12px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 10px; color: var(--text-primary);">
                                </div>
                                <div>
                                    <label style="display: block; font-size: 0.85rem; color: var(--text-muted); margin-bottom: 6px;">Time</label>
                                    <input type="time" id="eventTime" style="width: 100%; padding: 12px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 10px; color: var(--text-primary);">
                                </div>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                                <div>
                                    <label style="display: block; font-size: 0.85rem; color: var(--text-muted); margin-bottom: 6px;">Category</label>
                                    <select id="eventCategory" style="width: 100%; padding: 12px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 10px; color: var(--text-primary);">
                                        <option value="meeting"> Meeting</option>
                                        <option value="milestone"> Milestone</option>
                                        <option value="task"> Task</option>
                                        <option value="compliance"> Compliance</option>
                                        <option value="tax"> Tax</option>
                                        <option value="legal"> Legal</option>
                                        <option value="payroll"> Payroll</option>
                                        <option value="custom"> Custom</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="display: block; font-size: 0.85rem; color: var(--text-muted); margin-bottom: 6px;">Section</label>
                                    <select id="eventSection" style="width: 100%; padding: 12px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 10px; color: var(--text-primary);">
                                        <option value="overview"> Overview</option>
                                        <option value="calendar"> Calendar</option>
                                        <option value="compliance"> Compliance</option>
                                        <option value="payroll"> Payroll</option>
                                        <option value="tax"> Tax</option>
                                    </select>
                                </div>
                            </div>
                            <div style="margin-bottom: 16px;">
                                <label style="display: block; font-size: 0.85rem; color: var(--text-muted); margin-bottom: 6px;">Location</label>
                                <input type="text" id="eventLocation" placeholder="Add location or meeting link..." style="width: 100%; padding: 12px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 10px; color: var(--text-primary); font-size: 0.95rem;">
                            </div>
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; font-size: 0.85rem; color: var(--text-muted); margin-bottom: 6px;">Description</label>
                                <textarea id="eventDescription" rows="3" placeholder="Add details about this event..." style="width: 100%; padding: 12px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 10px; color: var(--text-primary); resize: vertical; font-size: 0.95rem;"></textarea>
                            </div>
                            <div style="display: flex; gap: 12px; padding-top: 16px; border-top: 1px solid var(--border);">
                                <button type="button" class="btn btn-secondary" onclick="closeAddEventModal()" style="flex: 1; padding: 12px;">Cancel</button>
                                <button type="submit" class="btn btn-primary" style="flex: 1; padding: 12px; display: flex; align-items: center; justify-content: center; gap: 8px;">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/>
                                        <polyline points="17 21 17 13 7 13 7 21"/>
                                        <polyline points="7 3 7 8 15 8"/>
                                    </svg>
                                    Save Event
                                </button>
                            </div>
                        </form>
                    </div>
                `;
                document.body.appendChild(modal);
                
                // Close on backdrop click
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) closeAddEventModal();
                });
            }
            
            modal.style.display = 'flex';
            
            // Set default date to today
            const dateField = document.getElementById('eventDate');
            if (dateField) {
                dateField.valueAsDate = new Date();
            }
            
            // Set default time to next hour
            const timeField = document.getElementById('eventTime');
            if (timeField) {
                const now = new Date();
                const nextHour = new Date(now.setHours(now.getHours() + 1, 0, 0, 0));
                timeField.value = nextHour.getHours().toString().padStart(2, '0') + ':00';
            }
            
            // Focus on title field
            setTimeout(() => {
                const titleField = document.getElementById('eventTitle');
                if (titleField) titleField.focus();
            }, 100);
            
            // Reset Zoom section and event type
            const eventTypeField = document.getElementById('addEventType');
            if (eventTypeField) {
                eventTypeField.value = 'in-person';
            }
            const zoomSection = document.getElementById('addEventZoomSection');
            if (zoomSection) {
                zoomSection.style.display = 'none';
            }
            const locationField = document.getElementById('addEventLocationField');
            if (locationField) {
                locationField.style.display = 'block';
            }
            // Clear Zoom fields
            const zoomIdField = document.getElementById('addEventZoomId');
            const zoomPasscodeField = document.getElementById('addEventZoomPasscode');
            if (zoomIdField) zoomIdField.value = '';
            if (zoomPasscodeField) zoomPasscodeField.value = '';
        }
        
        function closeAddEventModal() {
            const modal = document.getElementById('addEventModal');
            if (modal) {
                modal.style.display = 'none';
            }
            const form = document.getElementById('addEventForm');
            if (form) {
                form.reset();
            }
        }
        
        function saveCalendarEvent(e) {
            e.preventDefault();
            
            const title = document.getElementById('eventTitle').value;
            const dateVal = document.getElementById('eventDate').value;
            const timeVal = document.getElementById('eventTime')?.value || '';
            const category = document.getElementById('eventCategory').value;
            const section = document.getElementById('eventSection')?.value || 'overview';
            const location = document.getElementById('eventLocation')?.value || '';
            const description = document.getElementById('eventDescription').value;
            const eventType = document.getElementById('addEventType')?.value || 'in-person';
            
            // Get Zoom settings
            const zoomId = document.getElementById('addEventZoomId')?.value || '';
            const zoomPasscode = document.getElementById('addEventZoomPasscode')?.value || '';
            const waitingRoom = document.getElementById('addEventWaitingRoom')?.checked || false;
            const muteOnEntry = document.getElementById('addEventMuteOnEntry')?.checked || false;
            const autoRecord = document.getElementById('addEventRecording')?.checked || false;
            
            if (!title || !dateVal) {
                showToast('Please fill in required fields', 'error');
                return;
            }
            
            // Combine date and time
            const dateTimeStr = timeVal ? `${dateVal}T${timeVal}` : dateVal;
            const date = new Date(dateTimeStr);
            
            const newEvent = {
                id: Date.now(),
                title,
                date: date.toISOString(),
                category,
                section,
                description,
                eventType,
                custom: true,
                meetingDetails: {
                    location: location
                },
                createdAt: new Date().toISOString()
            };
            
            // Add Zoom settings if virtual or hybrid
            if ((eventType === 'virtual' || eventType === 'hybrid') && zoomConnected && zoomId) {
                newEvent.zoomSettings = {
                    meetingId: zoomId,
                    passcode: zoomPasscode,
                    waitingRoom: waitingRoom,
                    muteOnEntry: muteOnEntry,
                    autoRecord: autoRecord
                };
            }
            
            // Save to localStorage
            let savedEvents = JSON.parse(localStorage.getItem('oith_calendar_events') || '[]');
            savedEvents.push(newEvent);
            localStorage.setItem('oith_calendar_events', JSON.stringify(savedEvents));
            
            // Sync to AWS automatically (silent mode)
            if (typeof syncCalendarToAWS === 'function') {
                syncCalendarToAWS(true);
            }
            
            // Add to current events array
            newEvent.date = date;
            calendarEvents.push(newEvent);
            
            // Re-render calendar
            renderCalendar();
            renderUpcomingEvents();
            updateCalendarBadge();
            // Also update Full Calendar View section
            if (typeof renderCalendarGrid === 'function') renderCalendarGrid();
            if (typeof renderMilestones === 'function') renderMilestones();
            if (typeof renderUpcomingTasks === 'function') renderUpcomingTasks();
            closeAddEventModal();
            
            // Log activity
            logAdminActivity('event', 'Created calendar event', title, { date: dateVal, category: category, type: eventType });
            
            showToast(' Event added successfully!', 'success');
        }
        
        // ==========================================
        // MEETING SCHEDULER SYSTEM
        // ==========================================
        
        let meetingInvitees = [];
        let zoomConnected = false;
        let zoomUserData = null;
        
        function openMeetingScheduler() {
            // Check if modal exists, create it if not
            let modal = document.getElementById('meetingSchedulerModal');
            if (!modal) {
                createMeetingSchedulerModal();
                modal = document.getElementById('meetingSchedulerModal');
            }
            
            modal.style.display = 'flex';
            
            // Set default date to today
            const dateInput = document.getElementById('meetingDate');
            if (dateInput) dateInput.valueAsDate = new Date();
            
            // Set default time to next hour
            const now = new Date();
            now.setHours(now.getHours() + 1, 0, 0, 0);
            const timeInput = document.getElementById('meetingStartTime');
            if (timeInput) {
                timeInput.value = 
                    now.getHours().toString().padStart(2, '0') + ':' + 
                    now.getMinutes().toString().padStart(2, '0');
            }
            
            // Check stored Zoom connection
            const storedZoom = localStorage.getItem('oith_zoom_connection');
            if (storedZoom) {
                zoomUserData = JSON.parse(storedZoom);
                zoomConnected = true;
                showZoomConnected();
            }
            
            toggleLocationFields();
        }
        
        function createMeetingSchedulerModal() {
            const modalHTML = `
            <div class="modal" id="meetingSchedulerModal" style="z-index: 2100; display: none;">
                <div class="modal-content meeting-scheduler-modal" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
                    <div class="scheduler-header" style="display: flex; justify-content: space-between; align-items: center; padding: 20px; border-bottom: 1px solid var(--border); background: linear-gradient(135deg, var(--accent) 0%, var(--purple) 100%); border-radius: 16px 16px 0 0;">
                        <div class="scheduler-header-left" style="display: flex; align-items: center; gap: 16px;">
                            <div class="scheduler-icon" style="font-size: 2rem; background: rgba(255,255,255,0.2); padding: 12px; border-radius: 12px;"></div>
                            <div>
                                <h2 style="margin: 0; color: white; font-size: 1.4rem;">Schedule a Meeting</h2>
                                <p style="margin: 4px 0 0 0; color: rgba(255,255,255,0.8); font-size: 0.9rem;">Create and invite participants to your meeting</p>
                            </div>
                        </div>
                        <button onclick="closeMeetingScheduler()" class="scheduler-close-btn" style="background: rgba(255,255,255,0.2); border: none; color: white; width: 36px; height: 36px; border-radius: 8px; cursor: pointer; font-size: 1.2rem;"></button>
                    </div>
                    
                    <form id="meetingSchedulerForm" onsubmit="saveMeeting(event)" style="padding: 24px;">
                        <div class="scheduler-body" style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                            <!-- Left Column - Meeting Details -->
                            <div class="scheduler-column">
                                <div class="scheduler-section" style="margin-bottom: 20px;">
                                    <div class="scheduler-section-title" style="font-weight: 600; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; color: var(--text-primary);">
                                         Meeting Details
                                    </div>
                                    
                                    <div class="form-group" style="margin-bottom: 16px;">
                                        <label style="display: block; font-size: 0.85rem; color: var(--text-muted); margin-bottom: 6px;">Meeting Title *</label>
                                        <input type="text" id="meetingTitle" required placeholder="e.g., Weekly Team Standup" class="form-control" style="width: 100%; padding: 12px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 10px; color: var(--text-primary);">
                                    </div>
                                    
                                    <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                                        <div class="form-group">
                                            <label style="display: block; font-size: 0.85rem; color: var(--text-muted); margin-bottom: 6px;">Date *</label>
                                            <input type="date" id="meetingDate" required class="form-control" style="width: 100%; padding: 12px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 10px; color: var(--text-primary);">
                                        </div>
                                        <div class="form-group">
                                            <label style="display: block; font-size: 0.85rem; color: var(--text-muted); margin-bottom: 6px;">Start Time *</label>
                                            <input type="time" id="meetingStartTime" required class="form-control" style="width: 100%; padding: 12px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 10px; color: var(--text-primary);">
                                        </div>
                                        <div class="form-group">
                                            <label style="display: block; font-size: 0.85rem; color: var(--text-muted); margin-bottom: 6px;">Duration</label>
                                            <select id="meetingDuration" class="form-control" style="width: 100%; padding: 12px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 10px; color: var(--text-primary);">
                                                <option value="15">15 minutes</option>
                                                <option value="30" selected>30 minutes</option>
                                                <option value="45">45 minutes</option>
                                                <option value="60">1 hour</option>
                                                <option value="90">1.5 hours</option>
                                                <option value="120">2 hours</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                                        <div class="form-group">
                                            <label style="display: block; font-size: 0.85rem; color: var(--text-muted); margin-bottom: 6px;">Category</label>
                                            <select id="meetingCategory" class="form-control" style="width: 100%; padding: 12px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 10px; color: var(--text-primary);">
                                                <option value="meeting"> Meeting</option>
                                                <option value="standup"> Standup</option>
                                                <option value="interview"> Interview</option>
                                                <option value="review"> Review</option>
                                                <option value="planning"> Planning</option>
                                                <option value="training"> Training</option>
                                                <option value="client"> Client Call</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label style="display: block; font-size: 0.85rem; color: var(--text-muted); margin-bottom: 6px;">Event Type</label>
                                            <select id="meetingEventType" class="form-control" onchange="toggleLocationFields()" style="width: 100%; padding: 12px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 10px; color: var(--text-primary);">
                                                <option value="virtual"> Virtual (Zoom)</option>
                                                <option value="in-person"> In-Person</option>
                                                <option value="hybrid"> Hybrid</option>
                                                <option value="phone"> Phone Call</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div class="form-group" id="locationField" style="margin-bottom: 16px; display: none;">
                                        <label style="display: block; font-size: 0.85rem; color: var(--text-muted); margin-bottom: 6px;">Location</label>
                                        <input type="text" id="meetingLocation" placeholder="Enter physical location address..." class="form-control" style="width: 100%; padding: 12px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 10px; color: var(--text-primary);">
                                    </div>
                                    
                                    <div class="form-group">
                                        <label style="display: block; font-size: 0.85rem; color: var(--text-muted); margin-bottom: 6px;">Description / Agenda</label>
                                        <textarea id="meetingDescription" rows="3" placeholder="Add meeting agenda, notes, or talking points..." class="form-control" style="width: 100%; padding: 12px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 10px; color: var(--text-primary); resize: vertical;"></textarea>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Right Column - Zoom & Invites -->
                            <div class="scheduler-column">
                                <!-- Zoom Integration Section -->
                                <div class="scheduler-section" id="zoomSection" style="margin-bottom: 20px;">
                                    <div class="scheduler-section-title" style="font-weight: 600; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; color: var(--text-primary);">
                                         Zoom Meeting Settings
                                    </div>
                                    
                                    <div class="zoom-status" id="zoomConnectionStatus" style="display: flex; align-items: center; gap: 8px; padding: 12px; background: var(--bg-tertiary); border-radius: 8px; margin-bottom: 12px;">
                                        <div class="zoom-status-indicator disconnected" style="width: 8px; height: 8px; border-radius: 50%; background: var(--warning);"></div>
                                        <span style="color: var(--text-muted); font-size: 0.9rem;">Not Connected</span>
                                        <button type="button" class="btn btn-secondary btn-sm" onclick="connectZoomAccount()" style="margin-left: auto; padding: 6px 12px; font-size: 0.8rem;">Connect Zoom</button>
                                    </div>
                                    
                                    <div id="zoomConnectedPanel" style="display: none;">
                                        <div class="zoom-connected-info" style="display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--bg-tertiary); border-radius: 8px; margin-bottom: 12px;">
                                            <div class="zoom-avatar" style="width: 40px; height: 40px; background: var(--accent); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white;"></div>
                                            <div style="flex: 1;">
                                                <div class="zoom-user-name" id="zoomUserName" style="font-weight: 600; color: var(--text-primary);">Connected User</div>
                                                <div class="zoom-user-email" id="zoomUserEmail" style="font-size: 0.8rem; color: var(--text-muted);">user@example.com</div>
                                            </div>
                                            <button type="button" class="btn btn-outline btn-sm" onclick="disconnectZoomAccount()" style="padding: 6px 12px; font-size: 0.8rem;">Disconnect</button>
                                        </div>
                                        
                                        <div class="form-group" style="margin-bottom: 12px;">
                                            <label style="display: block; font-size: 0.85rem; color: var(--text-muted); margin-bottom: 6px;">Meeting ID</label>
                                            <div class="zoom-id-row" style="display: flex; gap: 8px;">
                                                <input type="text" id="zoomMeetingId" readonly class="form-control" placeholder="Auto-generated" style="flex: 1; padding: 10px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary);">
                                                <button type="button" class="btn btn-secondary btn-sm" onclick="generateZoomMeetingId()" style="padding: 10px 14px;"> Generate</button>
                                            </div>
                                        </div>
                                        
                                        <div class="form-group" style="margin-bottom: 12px;">
                                            <label style="display: block; font-size: 0.85rem; color: var(--text-muted); margin-bottom: 6px;">Passcode</label>
                                            <input type="text" id="zoomPasscode" class="form-control" placeholder="Optional meeting passcode" style="width: 100%; padding: 10px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary);">
                                        </div>
                                        
                                        <div class="zoom-options" style="display: flex; flex-direction: column; gap: 8px;">
                                            <label class="checkbox-label" style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                                <input type="checkbox" id="zoomWaitingRoom" checked>
                                                <span style="color: var(--text-primary); font-size: 0.9rem;">Enable Waiting Room</span>
                                            </label>
                                            <label class="checkbox-label" style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                                <input type="checkbox" id="zoomMuteOnEntry" checked>
                                                <span style="color: var(--text-primary); font-size: 0.9rem;">Mute participants on entry</span>
                                            </label>
                                            <label class="checkbox-label" style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                                <input type="checkbox" id="zoomRecording">
                                                <span style="color: var(--text-primary); font-size: 0.9rem;">Auto-record meeting</span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Invite Attendees Section -->
                                <div class="scheduler-section">
                                    <div class="scheduler-section-title" style="font-weight: 600; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; color: var(--text-primary);">
                                         Invite Attendees
                                    </div>
                                    
                                    <div class="form-group" style="margin-bottom: 12px;">
                                        <label style="display: block; font-size: 0.85rem; color: var(--text-muted); margin-bottom: 6px;">Add by Email</label>
                                        <div class="invite-input-row" style="display: flex; gap: 8px;">
                                            <input type="email" id="inviteEmail" placeholder="Enter email address..." class="form-control" style="flex: 1; padding: 10px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary);">
                                            <button type="button" class="btn btn-secondary btn-sm" onclick="addEmailInvite()" style="padding: 10px 14px;"> Add</button>
                                        </div>
                                    </div>
                                    
                                    <div id="inviteesList" style="max-height: 150px; overflow-y: auto;">
                                        <!-- Invitees will be rendered here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="scheduler-footer" style="display: flex; justify-content: space-between; align-items: center; padding-top: 20px; border-top: 1px solid var(--border); margin-top: 20px;">
                            <button type="button" class="btn btn-secondary" onclick="closeMeetingScheduler()" style="padding: 12px 24px;">Cancel</button>
                            <button type="submit" class="btn btn-primary" style="padding: 12px 24px; display: flex; align-items: center; gap: 8px;">
                                 Schedule Meeting
                            </button>
                        </div>
                    </form>
                </div>
            </div>`;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // Add click-outside-to-close handler
            const modal = document.getElementById('meetingSchedulerModal');
            modal.addEventListener('click', function(e) {
                if (e.target === this) closeMeetingScheduler();
            });
        }
        
        function closeMeetingScheduler() {
            const modal = document.getElementById('meetingSchedulerModal');
            if (modal) modal.style.display = 'none';
            const form = document.getElementById('meetingSchedulerForm');
            if (form) form.reset();
            meetingInvitees = [];
            renderInviteesList();
        }
        
        function toggleLocationFields() {
            const eventType = document.getElementById('meetingEventType').value;
            const locationField = document.getElementById('locationField');
            const zoomSection = document.getElementById('zoomSection');
            
            if (eventType === 'virtual') {
                locationField.style.display = 'none';
                zoomSection.style.display = 'block';
            } else if (eventType === 'in-person') {
                locationField.style.display = 'block';
                zoomSection.style.display = 'none';
            } else if (eventType === 'hybrid') {
                locationField.style.display = 'block';
                zoomSection.style.display = 'block';
            } else if (eventType === 'phone') {
                locationField.style.display = 'none';
                zoomSection.style.display = 'none';
            }
        }
        
        // Zoom Integration Functions
        function connectZoomAccount() {
            // Simulate Zoom OAuth connection
            showToast('Connecting to Zoom...', 'info');
            
            // Simulate OAuth popup delay
            setTimeout(() => {
                // In production, this would be a real OAuth flow
                zoomUserData = {
                    name: 'Matthew Ross',
                    email: 'mattr@oith.com',
                    accountId: 'OITH-ZM-' + Date.now().toString().slice(-6),
                    pmid: '123 456 7890'
                };
                
                localStorage.setItem('oith_zoom_connection', JSON.stringify(zoomUserData));
                zoomConnected = true;
                showZoomConnected();
                generateZoomMeetingId();
                
                showToast('Successfully connected to Zoom!', 'success');
            }, 1500);
        }
        
        function showZoomConnected() {
            document.getElementById('zoomConnectionStatus').innerHTML = `
                <div class="zoom-status-indicator connected"></div>
                <span>Connected</span>
                <button type="button" class="btn btn-outline btn-sm" onclick="testZoomConnection('main')" style="margin-left: auto;" title="Test Zoom Connection"> Test</button>
            `;
            document.getElementById('zoomConnectedPanel').style.display = 'block';
            document.getElementById('zoomUserName').textContent = zoomUserData.name;
            document.getElementById('zoomUserEmail').textContent = zoomUserData.email;
        }
        
        function disconnectZoomAccount() {
            if (confirm('Are you sure you want to disconnect your Zoom account?')) {
                localStorage.removeItem('oith_zoom_connection');
                zoomConnected = false;
                zoomUserData = null;
                
                document.getElementById('zoomConnectionStatus').innerHTML = `
                    <div class="zoom-status-indicator disconnected"></div>
                    <span>Not Connected</span>
                    <button type="button" class="btn btn-secondary btn-sm" onclick="connectZoomAccount()">Connect Zoom</button>
                `;
                document.getElementById('zoomConnectedPanel').style.display = 'none';
                document.getElementById('zoomMeetingId').value = '';
                
                showToast('Zoom account disconnected', 'info');
            }
        }
        
        function generateZoomMeetingId() {
            // Generate a realistic Zoom-style meeting ID
            const part1 = Math.floor(Math.random() * 900 + 100);
            const part2 = Math.floor(Math.random() * 9000 + 1000);
            const part3 = Math.floor(Math.random() * 9000 + 1000);
            const meetingId = `${part1} ${part2} ${part3}`;
            
            document.getElementById('zoomMeetingId').value = meetingId;
            
            // Generate a passcode
            const passcode = Math.random().toString(36).substring(2, 8).toUpperCase();
            document.getElementById('zoomPasscode').value = passcode;
            
            showToast('Meeting ID generated!', 'success');
        }
        
        // Generate Zoom ID value helper
        function generateZoomIdValue() {
            const part1 = Math.floor(Math.random() * 900 + 100);
            const part2 = Math.floor(Math.random() * 9000 + 1000);
            const part3 = Math.floor(Math.random() * 9000 + 1000);
            return `${part1} ${part2} ${part3}`;
        }
        
        // Generate passcode value helper
        function generatePasscodeValue() {
            return Math.random().toString(36).substring(2, 8).toUpperCase();
        }
        
        // Regenerate Zoom ID for Next Step modal
        function regenerateNextStepZoomId() {
            const newId = generateZoomIdValue();
            const newPasscode = generatePasscodeValue();
            const idField = document.getElementById('nextStepZoomId');
            const passcodeField = document.getElementById('nextStepZoomPasscode');
            if (idField) idField.value = newId;
            if (passcodeField) passcodeField.value = newPasscode;
            showToast('New Meeting ID generated!', 'success');
        }
        
        // Test Zoom Connection
        function testZoomConnection(source = 'main') {
            const sourceLabel = source === 'nextStep' ? 'Next Step Scheduler' : 
                               source === 'addEvent' ? 'Add Event' : 'Meeting Scheduler';
            
            showToast(`Testing Zoom connection from ${sourceLabel}...`, 'info');
            
            // Simulate API connection test
            setTimeout(() => {
                if (zoomConnected && zoomUserData) {
                    // Simulate successful connection test
                    const testResults = {
                        status: 'connected',
                        account: zoomUserData.email,
                        apiLatency: Math.floor(Math.random() * 100 + 50) + 'ms',
                        features: ['meetings', 'webinars', 'recordings']
                    };
                    
                    showToast(` Zoom Connected! Account: ${testResults.account} | Latency: ${testResults.apiLatency}`, 'success');
                    
                    // Show detailed test results modal
                    showZoomTestResultsModal(testResults, source);
                } else {
                    showToast(' Zoom not connected. Please connect your account first.', 'error');
                }
            }, 1200);
        }
        
        // Show Zoom Test Results Modal
        function showZoomTestResultsModal(results, source) {
            // Remove existing modal if present
            const existingModal = document.getElementById('zoomTestModal');
            if (existingModal) existingModal.remove();
            
            const modalHTML = `
                <div id="zoomTestModal" style="position: fixed; inset: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 99999; backdrop-filter: blur(4px);">
                    <div style="background: var(--bg-secondary, #2d2d2d); border-radius: 16px; max-width: 450px; width: 95%; box-shadow: 0 25px 60px rgba(0,0,0,0.5); overflow: hidden;">
                        <div style="background: linear-gradient(135deg, #2D8CFF, #0E72ED); padding: 20px 24px; display: flex; align-items: center; gap: 12px;">
                            <div style="width: 48px; height: 48px; background: white; border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#2D8CFF" stroke-width="2">
                                    <path d="M15.6 11.6L22 7v10l-6.4-4.5v-1zM4 5h9a2 2 0 012 2v10a2 2 0 01-2 2H4a2 2 0 01-2-2V7c0-1.1.9-2 2-2z"/>
                                </svg>
                            </div>
                            <div>
                                <h3 style="margin: 0; color: white; font-size: 1.1rem;">Zoom Connection Test</h3>
                                <p style="margin: 2px 0 0; font-size: 0.8rem; color: rgba(255,255,255,0.8);">Results from ${source} scheduler</p>
                            </div>
                        </div>
                        
                        <div style="padding: 24px;">
                            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px; padding: 16px; background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 12px;">
                                <div style="width: 40px; height: 40px; background: var(--success, #10b981); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3">
                                        <polyline points="20 6 9 17 4 12"/>
                                    </svg>
                                </div>
                                <div>
                                    <div style="font-weight: 600; color: var(--success, #10b981); font-size: 1rem;">Connection Successful</div>
                                    <div style="font-size: 0.8rem; color: var(--text-muted, #8a8a8a);">All systems operational</div>
                                </div>
                            </div>
                            
                            <div style="display: grid; gap: 12px;">
                                <div style="display: flex; justify-content: space-between; padding: 12px; background: var(--bg-tertiary, #3d3d3d); border-radius: 8px;">
                                    <span style="color: var(--text-muted, #8a8a8a); font-size: 0.85rem;">Account</span>
                                    <span style="color: var(--text-primary, #fff); font-size: 0.85rem; font-weight: 500;">${results.account}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding: 12px; background: var(--bg-tertiary, #3d3d3d); border-radius: 8px;">
                                    <span style="color: var(--text-muted, #8a8a8a); font-size: 0.85rem;">API Latency</span>
                                    <span style="color: var(--success, #10b981); font-size: 0.85rem; font-weight: 500;">${results.apiLatency}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding: 12px; background: var(--bg-tertiary, #3d3d3d); border-radius: 8px;">
                                    <span style="color: var(--text-muted, #8a8a8a); font-size: 0.85rem;">Available Features</span>
                                    <span style="color: var(--text-primary, #fff); font-size: 0.85rem;">${results.features.length} enabled</span>
                                </div>
                            </div>
                            
                            <div style="margin-top: 16px; padding: 12px; background: var(--bg-primary, #1f1f1f); border-radius: 8px;">
                                <div style="font-size: 0.75rem; color: var(--text-muted, #8a8a8a); margin-bottom: 8px;">ENABLED FEATURES</div>
                                <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                                    ${results.features.map(f => `
                                        <span style="padding: 4px 10px; background: rgba(45, 140, 255, 0.2); color: #2D8CFF; border-radius: 20px; font-size: 0.75rem; text-transform: capitalize;"> ${f}</span>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                        
                        <div style="padding: 16px 24px; background: var(--bg-tertiary, #3d3d3d); display: flex; gap: 12px; justify-content: flex-end;">
                            <button onclick="document.getElementById('zoomTestModal').remove()" style="padding: 10px 24px; background: var(--accent, #0078d4); border: none; border-radius: 8px; color: white; cursor: pointer; font-size: 0.9rem; font-weight: 500;">
                                Done
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // Close on backdrop click
            document.getElementById('zoomTestModal').addEventListener('click', (e) => {
                if (e.target.id === 'zoomTestModal') e.target.remove();
            });
            
            // Close on Escape
            const closeOnEscape = (e) => {
                if (e.key === 'Escape') {
                    document.getElementById('zoomTestModal')?.remove();
                    document.removeEventListener('keydown', closeOnEscape);
                }
            };
            document.addEventListener('keydown', closeOnEscape);
        }
        
        // Toggle Zoom section in Add Event modal
        function toggleAddEventZoomSection() {
            const eventType = document.getElementById('addEventType')?.value;
            const zoomSection = document.getElementById('addEventZoomSection');
            const locationField = document.getElementById('addEventLocationField');
            
            if (!zoomSection) return;
            
            if (eventType === 'virtual' || eventType === 'hybrid') {
                zoomSection.style.display = 'block';
                updateAddEventZoomStatus();
                if (eventType === 'virtual') {
                    locationField.style.display = 'none';
                } else {
                    locationField.style.display = 'block';
                }
            } else {
                zoomSection.style.display = 'none';
                locationField.style.display = 'block';
            }
        }
        
        // Update Zoom status in Add Event modal
        function updateAddEventZoomStatus() {
            const statusEl = document.getElementById('addEventZoomStatus');
            const panelEl = document.getElementById('addEventZoomPanel');
            
            if (!statusEl) return;
            
            if (zoomConnected && zoomUserData) {
                statusEl.innerHTML = `
                    <div style="width: 10px; height: 10px; border-radius: 50%; background: var(--success, #10b981); box-shadow: 0 0 8px rgba(16, 185, 129, 0.5);"></div>
                    <span style="flex: 1; font-size: 0.85rem; color: var(--text-secondary);">Connected as ${zoomUserData.name}</span>
                    <button type="button" onclick="testZoomConnection('addEvent')" style="padding: 6px 12px; background: #2D8CFF; border: none; border-radius: 6px; color: white; font-size: 0.75rem; cursor: pointer;"> Test</button>
                `;
                if (panelEl) {
                    panelEl.style.display = 'block';
                    // Generate meeting ID if not already set
                    const idField = document.getElementById('addEventZoomId');
                    const passcodeField = document.getElementById('addEventZoomPasscode');
                    if (idField && !idField.value) {
                        idField.value = generateZoomIdValue();
                    }
                    if (passcodeField && !passcodeField.value) {
                        passcodeField.value = generatePasscodeValue();
                    }
                }
            } else {
                statusEl.innerHTML = `
                    <div style="width: 10px; height: 10px; border-radius: 50%; background: var(--text-muted, #8a8a8a);"></div>
                    <span style="flex: 1; font-size: 0.85rem; color: var(--text-muted);">Not Connected</span>
                    <button type="button" onclick="connectZoomAccount(); setTimeout(updateAddEventZoomStatus, 1600);" style="padding: 6px 12px; background: #2D8CFF; border: none; border-radius: 6px; color: white; font-size: 0.75rem; cursor: pointer;">Connect Zoom</button>
                `;
                if (panelEl) panelEl.style.display = 'none';
            }
        }
        
        // Regenerate Zoom ID for Add Event modal
        function regenerateAddEventZoomId() {
            const idField = document.getElementById('addEventZoomId');
            const passcodeField = document.getElementById('addEventZoomPasscode');
            if (idField) idField.value = generateZoomIdValue();
            if (passcodeField) passcodeField.value = generatePasscodeValue();
            showToast('New Meeting ID generated!', 'success');
        }
        
        // Invite Functions
        function switchInviteTab(tab) {
            document.querySelectorAll('.invite-tab').forEach(t => t.classList.remove('active'));
            event.currentTarget.classList.add('active');
            
            document.getElementById('emailInvitePanel').style.display = tab === 'email' ? 'block' : 'none';
            document.getElementById('phoneInvitePanel').style.display = tab === 'phone' ? 'block' : 'none';
        }
        
        function addEmailInvite() {
            const emailInput = document.getElementById('inviteEmail');
            const email = emailInput.value.trim();
            
            if (!email) {
                showToast('Please enter an email address', 'error');
                return;
            }
            
            // Basic email validation
            if (!email.match(/^[^\s@]+@[^\s@]+\.[^\s@]+$/)) {
                showToast('Please enter a valid email address', 'error');
                return;
            }
            
            // Check for duplicates
            if (meetingInvitees.some(i => i.value === email)) {
                showToast('This email is already added', 'error');
                return;
            }
            
            meetingInvitees.push({
                type: 'email',
                value: email,
                id: Date.now()
            });
            
            emailInput.value = '';
            renderInviteesList();
            showToast('Attendee added!', 'success');
        }
        
        function addPhoneInvite() {
            const phoneInput = document.getElementById('invitePhone');
            const phone = phoneInput.value.trim();
            
            if (!phone) {
                showToast('Please enter a phone number', 'error');
                return;
            }
            
            // Check for duplicates
            if (meetingInvitees.some(i => i.value === phone)) {
                showToast('This number is already added', 'error');
                return;
            }
            
            meetingInvitees.push({
                type: 'phone',
                value: phone,
                id: Date.now()
            });
            
            phoneInput.value = '';
            renderInviteesList();
            showToast('Attendee added!', 'success');
        }
        
        function removeInvitee(id) {
            meetingInvitees = meetingInvitees.filter(i => i.id !== id);
            renderInviteesList();
        }
        
        function renderInviteesList() {
            const listEl = document.getElementById('inviteesList');
            const countEl = document.getElementById('inviteesCount');
            const countNumber = document.getElementById('inviteesNumber');
            
            // Guard against missing elements (modal may be closed)
            if (!listEl) return;
            
            if (meetingInvitees.length === 0) {
                listEl.innerHTML = `
                    <div style="text-align: center; padding: 24px; color: var(--text-muted); font-size: 0.85rem;">
                        <div style="font-size: 2rem; margin-bottom: 8px; opacity: 0.5;"></div>
                        No attendees added yet
                    </div>
                `;
                if (countEl) countEl.style.display = 'none';
                return;
            }
            
            listEl.innerHTML = meetingInvitees.map(inv => `
                <div class="invitee-item">
                    <div class="invitee-icon ${inv.type}">
                        ${inv.type === 'email' ? '' : ''}
                    </div>
                    <div class="invitee-details">
                        <div class="invitee-value">${inv.value}</div>
                        <div class="invitee-type">${inv.type === 'email' ? 'Email invite' : 'SMS invite'}</div>
                    </div>
                    <button type="button" class="invitee-remove" onclick="removeInvitee(${inv.id})">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="18" y1="6" x2="6" y2="18"/>
                            <line x1="6" y1="6" x2="18" y2="18"/>
                        </svg>
                    </button>
                </div>
            `).join('');
            
            countEl.style.display = 'block';
            countNumber.textContent = meetingInvitees.length;
        }
        
        // Preview Meeting
        function previewMeetingInvite() {
            const title = document.getElementById('meetingTitle').value || 'Untitled Meeting';
            const date = document.getElementById('meetingDate').value;
            const time = document.getElementById('meetingStartTime').value;
            const duration = document.getElementById('meetingDuration').value;
            const category = document.getElementById('meetingCategory').value;
            const eventType = document.getElementById('meetingEventType').value;
            const location = document.getElementById('meetingLocation').value;
            const description = document.getElementById('meetingDescription').value;
            const meetingId = document.getElementById('zoomMeetingId').value;
            const passcode = document.getElementById('zoomPasscode').value;
            
            // Format date
            const dateObj = new Date(date + 'T' + time);
            const formattedDate = dateObj.toLocaleDateString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            const formattedTime = dateObj.toLocaleTimeString('en-US', { 
                hour: 'numeric', 
                minute: '2-digit',
                hour12: true 
            });
            
            // Calculate end time
            const endTime = new Date(dateObj.getTime() + duration * 60000);
            const formattedEndTime = endTime.toLocaleTimeString('en-US', { 
                hour: 'numeric', 
                minute: '2-digit',
                hour12: true 
            });
            
            // Build location string
            let locationStr = '';
            if (eventType === 'virtual' && meetingId) {
                locationStr = 'Zoom Meeting';
            } else if (eventType === 'in-person' && location) {
                locationStr = location;
            } else if (eventType === 'hybrid') {
                locationStr = location ? `${location} + Zoom` : 'Hybrid (Zoom available)';
            } else if (eventType === 'phone') {
                locationStr = 'Phone Call';
            }
            
            // Generate attendees list
            const attendeesStr = meetingInvitees.length > 0 
                ? meetingInvitees.map(i => i.value).join(', ')
                : 'No attendees invited';
            
            const previewContent = `
                <div class="preview-email-header">
                    <div class="preview-email-icon"></div>
                    <div>
                        <div class="preview-email-subject">${title}</div>
                        <div class="preview-email-from">From: OITH Calendar &lt;calendar@oith.com&gt;</div>
                    </div>
                </div>
                <div class="preview-meeting-details">
                    <div class="preview-detail-row">
                        <div class="preview-detail-label"> When:</div>
                        <div class="preview-detail-value">${formattedDate}<br>${formattedTime} - ${formattedEndTime}</div>
                    </div>
                    <div class="preview-detail-row">
                        <div class="preview-detail-label"> Where:</div>
                        <div class="preview-detail-value">${locationStr || 'TBD'}</div>
                    </div>
                    <div class="preview-detail-row">
                        <div class="preview-detail-label"> Category:</div>
                        <div class="preview-detail-value" style="text-transform: capitalize;">${category}</div>
                    </div>
                    <div class="preview-detail-row">
                        <div class="preview-detail-label"> Attendees:</div>
                        <div class="preview-detail-value">${attendeesStr}</div>
                    </div>
                    ${description ? `
                        <div class="preview-detail-row">
                            <div class="preview-detail-label"> Agenda:</div>
                            <div class="preview-detail-value">${description}</div>
                        </div>
                    ` : ''}
                </div>
                ${(eventType === 'virtual' || eventType === 'hybrid') && meetingId ? `
                    <div class="preview-zoom-box">
                        <div class="preview-zoom-title"> Join Zoom Meeting</div>
                        <div class="preview-zoom-link">
                            https://zoom.us/j/${meetingId.replace(/\s/g, '')}<br>
                            Meeting ID: ${meetingId}<br>
                            ${passcode ? `Passcode: ${passcode}` : ''}
                        </div>
                    </div>
                ` : ''}
            `;
            
            document.getElementById('meetingPreviewContent').innerHTML = previewContent;
            document.getElementById('meetingPreviewModal').style.display = 'flex';
        }
        
        function closeMeetingPreview() {
            document.getElementById('meetingPreviewModal').style.display = 'none';
        }
        
        function copyMeetingDetails() {
            const previewEl = document.getElementById('meetingPreviewContent');
            const text = previewEl.innerText;
            
            navigator.clipboard.writeText(text).then(() => {
                showToast('Meeting details copied to clipboard!', 'success');
            }).catch(() => {
                showToast('Failed to copy to clipboard', 'error');
            });
        }
        
        // Save Meeting
        function saveMeeting(e) {
            e.preventDefault();
            
            const title = document.getElementById('meetingTitle').value;
            const date = document.getElementById('meetingDate').value;
            const time = document.getElementById('meetingStartTime').value;
            const duration = parseInt(document.getElementById('meetingDuration').value);
            const category = document.getElementById('meetingCategory').value;
            const eventType = document.getElementById('meetingEventType').value;
            const location = document.getElementById('meetingLocation').value;
            const description = document.getElementById('meetingDescription').value;
            const meetingId = document.getElementById('zoomMeetingId').value;
            const passcode = document.getElementById('zoomPasscode').value;
            
            // Create the meeting event
            const meetingDate = new Date(date + 'T' + time);
            
            const meetingEvent = {
                id: Date.now(),
                title: title,
                date: meetingDate.toISOString(),
                category: category === 'meeting' ? 'meeting' : category,
                description: description,
                section: 'calendar',
                custom: true,
                isMeeting: true,
                meetingDetails: {
                    duration: duration,
                    eventType: eventType,
                    location: location,
                    zoomMeetingId: meetingId,
                    zoomPasscode: passcode,
                    zoomWaitingRoom: document.getElementById('zoomWaitingRoom')?.checked,
                    zoomMuteOnEntry: document.getElementById('zoomMuteOnEntry')?.checked,
                    zoomRecording: document.getElementById('zoomRecording')?.checked,
                    invitees: [...meetingInvitees]
                }
            };
            
            // Save to localStorage
            let savedEvents = JSON.parse(localStorage.getItem('oith_calendar_events') || '[]');
            savedEvents.push(meetingEvent);
            localStorage.setItem('oith_calendar_events', JSON.stringify(savedEvents));
            
            // Save to meetings list
            let savedMeetings = JSON.parse(localStorage.getItem('oith_scheduled_meetings') || '[]');
            savedMeetings.push(meetingEvent);
            localStorage.setItem('oith_scheduled_meetings', JSON.stringify(savedMeetings));
            
            // Sync to AWS automatically
            if (typeof syncCalendarToAWS === 'function') {
                syncCalendarToAWS(true);
            }
            
            // Add to current calendar events
            meetingEvent.date = meetingDate;
            calendarEvents.push(meetingEvent);
            
            // Send invites (simulated)
            if (meetingInvitees.length > 0) {
                sendMeetingInvites(meetingEvent);
            }
            
            // Re-render calendar
            if (typeof renderCalendar === 'function') {
                renderCalendar();
            }
            if (typeof renderUpcomingEvents === 'function') {
                renderUpcomingEvents();
            }
            if (typeof updateCalendarBadge === 'function') {
                updateCalendarBadge();
            }
            // Also update Full Calendar View section
            if (typeof renderCalendarGrid === 'function') renderCalendarGrid();
            if (typeof renderMilestones === 'function') renderMilestones();
            if (typeof renderUpcomingTasks === 'function') renderUpcomingTasks();
            
            closeMeetingScheduler();
            
            // Log activity
            logAdminActivity('event', 'Scheduled meeting', title, { date: date, duration: duration, invitees: meetingInvitees.length, type: eventType });
            
            const inviteCount = meetingInvitees.length;
            const inviteText = inviteCount > 0 ? ` and ${inviteCount} invite${inviteCount > 1 ? 's' : ''} sent` : '';
            showToast(`Meeting scheduled${inviteText}! `, 'success');
        }
        
        function sendMeetingInvites(meeting) {
            // In production, this would send actual emails/SMS via your backend
            console.log('Sending invites for meeting:', meeting);
            
            const emailInvites = meetingInvitees.filter(i => i.type === 'email');
            const phoneInvites = meetingInvitees.filter(i => i.type === 'phone');
            
            // Log invite actions
            if (emailInvites.length > 0) {
                console.log(` Email invites sent to: ${emailInvites.map(e => e.value).join(', ')}`);
            }
            if (phoneInvites.length > 0) {
                console.log(` SMS invites sent to: ${phoneInvites.map(p => p.value).join(', ')}`);
            }
            
            // Store sent invites
            let sentInvites = JSON.parse(localStorage.getItem('oith_sent_invites') || '[]');
            sentInvites.push({
                meetingId: meeting.id,
                meetingTitle: meeting.title,
                sentAt: new Date().toISOString(),
                invitees: meetingInvitees
            });
            localStorage.setItem('oith_sent_invites', JSON.stringify(sentInvites));
        }
        
        // Initialize meeting scheduler event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Close on backdrop click
            document.getElementById('meetingSchedulerModal')?.addEventListener('click', function(e) {
                if (e.target === this) closeMeetingScheduler();
            });
            document.getElementById('meetingPreviewModal')?.addEventListener('click', function(e) {
                if (e.target === this) closeMeetingPreview();
            });
            
            // Enter key to add invites
            document.getElementById('inviteEmail')?.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    addEmailInvite();
                }
            });
            document.getElementById('invitePhone')?.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    addPhoneInvite();
                }
            });
            
            // Event details modal close on backdrop
            document.getElementById('eventDetailsModal')?.addEventListener('click', function(e) {
                if (e.target === this) closeEventDetails();
            });
            document.getElementById('shareEventModal')?.addEventListener('click', function(e) {
                if (e.target === this) closeShareEventModal();
            });
        });
        
        // ==========================================
        // EVENT DETAILS SYSTEM
        // ==========================================
        
        let currentViewingEvent = null;
        let isEditMode = false;
        
        function createEventDetailsModal() {
            const modalHTML = `
                <div class="modal-content event-details-modal">
                    <div class="event-details-header" id="eventDetailsHeader">
                        <div class="event-details-header-left">
                            <div class="event-details-icon" id="eventDetailsIcon"></div>
                            <div>
                                <h2 id="eventDetailsTitle">Event Title</h2>
                                <p id="eventDetailsCategory">Category</p>
                            </div>
                        </div>
                        <button onclick="closeEventDetails()" class="scheduler-close-btn">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="18" y1="6" x2="6" y2="18"/>
                                <line x1="6" y1="6" x2="18" y2="18"/>
                            </svg>
                        </button>
                    </div>
                    
                    <div class="event-details-body">
                        <div id="eventViewMode">
                            <div class="event-detail-row">
                                <div class="event-detail-icon"></div>
                                <div class="event-detail-content">
                                    <div class="event-detail-label">Date & Time</div>
                                    <div class="event-detail-value" id="eventDetailsDateTime">--</div>
                                </div>
                            </div>
                            
                            <div class="event-detail-row" id="eventDetailsLocationRow" style="display: none;">
                                <div class="event-detail-icon"></div>
                                <div class="event-detail-content">
                                    <div class="event-detail-label">Location</div>
                                    <div class="event-detail-value" id="eventDetailsLocation">--</div>
                                </div>
                            </div>
                            
                            <div class="event-detail-row" id="eventDetailsZoomRow" style="display: none;">
                                <div class="event-detail-icon" style="color: var(--info);"></div>
                                <div class="event-detail-content">
                                    <div class="event-detail-label">Zoom Meeting</div>
                                    <div class="event-detail-value" id="eventDetailsZoom">--</div>
                                </div>
                            </div>
                            
                            <div class="event-detail-row" id="eventDetailsAttendeesRow" style="display: none;">
                                <div class="event-detail-icon"></div>
                                <div class="event-detail-content">
                                    <div class="event-detail-label">Attendees</div>
                                    <div class="event-detail-value" id="eventDetailsAttendees">--</div>
                                </div>
                            </div>
                            
                            <div class="event-detail-row" id="eventDetailsDescRow" style="display: none;">
                                <div class="event-detail-icon"></div>
                                <div class="event-detail-content">
                                    <div class="event-detail-label">Description</div>
                                    <div class="event-detail-value" id="eventDetailsDesc">--</div>
                                </div>
                            </div>
                            
                            <div class="event-detail-row" id="eventDetailsSectionRow">
                                <div class="event-detail-icon"></div>
                                <div class="event-detail-content">
                                    <div class="event-detail-label">Related Section</div>
                                    <div class="event-detail-value" id="eventDetailsSection">--</div>
                                </div>
                            </div>
                            
                            <div class="event-notes-section" id="eventNotesSection">
                                <div class="event-notes-header">
                                     Notes & Requirements
                                </div>
                                <div class="event-notes-content" id="eventNotesContent">
                                    <p>No notes available for this event.</p>
                                </div>
                            </div>
                        </div>
                        
                        <div id="eventEditMode" style="display: none;">
                            <div class="form-group" style="margin-bottom: 16px;">
                                <label style="display: block; margin-bottom: 6px; font-size: 0.85rem; color: var(--text-muted);">Event Title *</label>
                                <input type="text" id="editEventTitle" class="form-control" placeholder="Enter event title..." style="width: 100%; padding: 10px 12px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary);">
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                                <div class="form-group">
                                    <label style="display: block; margin-bottom: 6px; font-size: 0.85rem; color: var(--text-muted);">Date *</label>
                                    <input type="date" id="editEventDate" class="form-control" style="width: 100%; padding: 10px 12px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary);">
                                </div>
                                <div class="form-group">
                                    <label style="display: block; margin-bottom: 6px; font-size: 0.85rem; color: var(--text-muted);">Time</label>
                                    <input type="time" id="editEventTime" class="form-control" style="width: 100%; padding: 10px 12px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary);">
                                </div>
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 16px;">
                                <label style="display: block; margin-bottom: 6px; font-size: 0.85rem; color: var(--text-muted);">Category</label>
                                <select id="editEventCategory" class="form-control" style="width: 100%; padding: 10px 12px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary);">
                                    <option value="meeting"> Meeting</option>
                                    <option value="standup"> Standup</option>
                                    <option value="milestone"> Milestone</option>
                                    <option value="payroll"> Payroll</option>
                                    <option value="tax"> Tax</option>
                                    <option value="compliance"> Compliance</option>
                                    <option value="patent"> Patent</option>
                                    <option value="experiment"> Experiment</option>
                                </select>
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 16px;">
                                <label style="display: block; margin-bottom: 6px; font-size: 0.85rem; color: var(--text-muted);">Location</label>
                                <input type="text" id="editEventLocation" class="form-control" placeholder="Enter location..." style="width: 100%; padding: 10px 12px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary);">
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 16px;">
                                <label style="display: block; margin-bottom: 6px; font-size: 0.85rem; color: var(--text-muted);">Description</label>
                                <textarea id="editEventDesc" class="form-control" rows="3" placeholder="Enter description..." style="width: 100%; padding: 10px 12px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); resize: vertical;"></textarea>
                            </div>
                        </div>
                    </div>
                    
                    <div class="event-details-footer">
                        <div class="event-details-actions" id="eventViewActions">
                            <button type="button" class="btn btn-secondary" id="editEventBtn" onclick="toggleEventEditMode(true)" style="display: flex; align-items: center; gap: 6px;">
                                 Edit
                            </button>
                            <button type="button" class="btn btn-primary" onclick="shareEvent()" style="display: flex; align-items: center; gap: 6px;">
                                 Share
                            </button>
                            <button type="button" class="btn btn-danger" id="deleteEventBtn" onclick="deleteEventFromDetails()" style="display: none; align-items: center; gap: 6px;">
                                 Delete
                            </button>
                        </div>
                        <div class="event-details-actions" id="eventEditActions" style="display: none;">
                            <button type="button" class="btn btn-secondary" onclick="toggleEventEditMode(false)">
                                Cancel
                            </button>
                            <button type="button" class="btn btn-primary" onclick="saveEventChanges()" style="display: flex; align-items: center; gap: 6px;">
                                 Save Changes
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.id = 'eventDetailsModal';
            modal.style.cssText = 'z-index: 2200; display: none;';
            modal.innerHTML = modalHTML;
            
            // Add click handler for closing on backdrop
            modal.addEventListener('click', function(e) {
                if (e.target === this) closeEventDetails();
            });
            
            document.body.appendChild(modal);
            console.log(' Event details modal created dynamically');
            return modal;
        }
        
        // Generate detailed notes for each event type
        function generateEventNotes(event) {
            const eventNotes = {
                // Business Formation
                'Register LLC': {
                    description: 'Complete LLC registration with state authorities',
                    subRequirements: [
                        { text: 'Choose LLC name and verify availability', time: '1 day', status: '' },
                        { text: 'File Articles of Organization', time: '2-3 days', status: '' },
                        { text: 'Create Operating Agreement', time: '1-2 days', status: '' },
                        { text: 'Obtain Registered Agent', time: '1 day', status: '' }
                    ],
                    estimatedCompletion: '1 week',
                    priority: 'Critical'
                },
                'Obtain EIN': {
                    description: 'Apply for Employer Identification Number from IRS',
                    subRequirements: [
                        { text: 'Complete IRS Form SS-4', time: '30 min', status: '' },
                        { text: 'Submit application online or by fax', time: '1 hour', status: '' },
                        { text: 'Receive confirmation letter', time: '1-2 weeks', status: '' }
                    ],
                    estimatedCompletion: '2 weeks',
                    priority: 'Critical'
                },
                'Business Formation Complete': {
                    description: 'All foundational business registration complete',
                    subRequirements: [
                        { text: 'LLC fully registered', time: 'Complete', status: '' },
                        { text: 'EIN obtained', time: 'Complete', status: '' },
                        { text: 'Business licenses acquired', time: 'Complete', status: '' },
                        { text: 'State tax registration', time: 'Complete', status: '' }
                    ],
                    estimatedCompletion: 'Milestone achieved',
                    priority: 'Milestone'
                },
                'Open Business Bank Account': {
                    description: 'Establish business banking relationship',
                    subRequirements: [
                        { text: 'Research bank options and fees', time: '2 days', status: '' },
                        { text: 'Gather required documents (EIN, Articles)', time: '1 day', status: '' },
                        { text: 'Schedule appointment with bank', time: '1 day', status: '' },
                        { text: 'Set up online banking access', time: '1 day', status: '' }
                    ],
                    estimatedCompletion: '1 week',
                    priority: 'High'
                },
                // Development Milestones
                'Development Kickoff': {
                    description: 'Official start of development phase',
                    subRequirements: [
                        { text: 'Set up development environment', time: '1 day', status: '' },
                        { text: 'Configure CI/CD pipeline', time: '2 days', status: '' },
                        { text: 'Create repository structure', time: '1 day', status: '' },
                        { text: 'Define coding standards', time: '1 day', status: '' }
                    ],
                    estimatedCompletion: '1 week',
                    priority: 'High'
                },
                'User Registration & Auth': {
                    description: 'Implement user authentication system',
                    subRequirements: [
                        { text: 'Design auth flow (signup/login/forgot)', time: '1 day', status: '' },
                        { text: 'Implement JWT token system', time: '2 days', status: '' },
                        { text: 'Add OAuth providers (Google, Apple)', time: '3 days', status: '' },
                        { text: 'Email verification system', time: '2 days', status: '' },
                        { text: 'Password security & hashing', time: '1 day', status: '' }
                    ],
                    estimatedCompletion: '2 weeks',
                    priority: 'Critical'
                },
                'Profile Creation Complete': {
                    description: 'User profile management functionality',
                    subRequirements: [
                        { text: 'Profile data model design', time: '1 day', status: '' },
                        { text: 'Photo upload & processing', time: '3 days', status: '' },
                        { text: 'Profile editing UI', time: '2 days', status: '' },
                        { text: 'Privacy settings', time: '1 day', status: '' }
                    ],
                    estimatedCompletion: '1.5 weeks',
                    priority: 'High',
                    nextSteps: [
                        { text: 'Begin Location Services integration', link: 'Location Services', priority: 'high' },
                        { text: 'Start Core Matching Algorithm development', link: 'Core Matching Algorithm Complete', priority: 'high' },
                        { text: 'Schedule QA review of profile features', priority: 'medium' },
                        { text: 'Document API endpoints for mobile team', priority: 'medium' },
                        { text: 'Set up analytics for profile completion rate', priority: 'low' }
                    ]
                },
                'Location Services': {
                    description: 'Implement geolocation features',
                    subRequirements: [
                        { text: 'Integrate geolocation API', time: '1 day', status: '' },
                        { text: 'Location permission handling', time: '1 day', status: '' },
                        { text: 'Distance calculation logic', time: '2 days', status: '' },
                        { text: 'Location privacy controls', time: '1 day', status: '' }
                    ],
                    estimatedCompletion: '1 week',
                    priority: 'High'
                },
                'Core Matching Algorithm Complete': {
                    description: 'ML-powered matching system implementation',
                    subRequirements: [
                        { text: 'Define matching criteria weights', time: '2 days', status: '' },
                        { text: 'Implement compatibility scoring', time: '3 days', status: '' },
                        { text: 'Build recommendation engine', time: '4 days', status: '' },
                        { text: 'A/B testing framework', time: '2 days', status: '' },
                        { text: 'Performance optimization', time: '2 days', status: '' }
                    ],
                    estimatedCompletion: '2.5 weeks',
                    priority: 'Critical'
                },
                'In-App Messaging/Chat': {
                    description: 'Real-time messaging system',
                    subRequirements: [
                        { text: 'WebSocket infrastructure', time: '2 days', status: '' },
                        { text: 'Message storage & encryption', time: '2 days', status: '' },
                        { text: 'Chat UI components', time: '3 days', status: '' },
                        { text: 'Read receipts & typing indicators', time: '1 day', status: '' },
                        { text: 'Media sharing', time: '2 days', status: '' }
                    ],
                    estimatedCompletion: '2 weeks',
                    priority: 'High'
                },
                'Push Notifications': {
                    description: 'Mobile push notification system',
                    subRequirements: [
                        { text: 'Configure FCM/APNs', time: '1 day', status: '' },
                        { text: 'Notification service backend', time: '2 days', status: '' },
                        { text: 'User preference management', time: '1 day', status: '' },
                        { text: 'Deep linking support', time: '1 day', status: '' }
                    ],
                    estimatedCompletion: '1 week',
                    priority: 'Medium'
                },
                'Payment Service': {
                    description: 'Premium subscription payment processing',
                    subRequirements: [
                        { text: 'Stripe integration', time: '2 days', status: '' },
                        { text: 'Subscription management', time: '2 days', status: '' },
                        { text: 'Apple/Google IAP', time: '3 days', status: '' },
                        { text: 'Receipt validation', time: '1 day', status: '' },
                        { text: 'Refund handling', time: '1 day', status: '' }
                    ],
                    estimatedCompletion: '2 weeks',
                    priority: 'High'
                },
                'MVP Feature-Complete': {
                    description: 'All MVP features implemented and functional',
                    subRequirements: [
                        { text: 'Core features working', time: 'Complete', status: '' },
                        { text: 'Basic UI/UX polished', time: 'Complete', status: '' },
                        { text: 'Critical bugs fixed', time: 'Complete', status: '' },
                        { text: 'Performance baseline met', time: 'Complete', status: '' }
                    ],
                    estimatedCompletion: 'Milestone',
                    priority: 'Milestone'
                },
                // Testing
                'Alpha Testing Begins': {
                    description: 'Internal testing phase start',
                    subRequirements: [
                        { text: 'Test plan documentation', time: '2 days', status: '' },
                        { text: 'Internal tester recruitment', time: '1 day', status: '' },
                        { text: 'Bug tracking setup', time: '1 day', status: '' },
                        { text: 'Feedback collection system', time: '1 day', status: '' }
                    ],
                    estimatedCompletion: '2 weeks',
                    priority: 'High'
                },
                'Unit Test Coverage >80%': {
                    description: 'Achieve comprehensive test coverage',
                    subRequirements: [
                        { text: 'Write unit tests for core modules', time: '5 days', status: '' },
                        { text: 'Integration test suite', time: '3 days', status: '' },
                        { text: 'Code coverage reporting', time: '1 day', status: '' },
                        { text: 'CI test automation', time: '1 day', status: '' }
                    ],
                    estimatedCompletion: '2 weeks',
                    priority: 'High'
                },
                // Compliance
                ' GDPR Compliance Review': {
                    description: 'European data protection regulation compliance',
                    subRequirements: [
                        { text: 'Data processing audit', time: '2 days', status: '' },
                        { text: 'Privacy policy update', time: '1 day', status: '' },
                        { text: 'Consent mechanisms', time: '2 days', status: '' },
                        { text: 'Data deletion workflow', time: '2 days', status: '' },
                        { text: 'DPO appointment', time: '1 day', status: '' }
                    ],
                    estimatedCompletion: '1.5 weeks',
                    priority: 'Critical'
                },
                ' CCPA Compliance Review': {
                    description: 'California Consumer Privacy Act compliance',
                    subRequirements: [
                        { text: 'Data inventory complete', time: '1 day', status: '' },
                        { text: 'Opt-out mechanism', time: '1 day', status: '' },
                        { text: 'Privacy notice updates', time: '1 day', status: '' },
                        { text: 'Request handling process', time: '2 days', status: '' }
                    ],
                    estimatedCompletion: '1 week',
                    priority: 'Critical'
                },
                ' App Store Guidelines Compliance': {
                    description: 'Apple App Store requirements met',
                    subRequirements: [
                        { text: 'Content guidelines review', time: '1 day', status: '' },
                        { text: 'Privacy labels completed', time: '1 day', status: '' },
                        { text: 'IAP implementation', time: '2 days', status: '' },
                        { text: 'Safety features documented', time: '1 day', status: '' }
                    ],
                    estimatedCompletion: '1 week',
                    priority: 'Critical'
                },
                ' PCI DSS Compliance (Payments)': {
                    description: 'Payment card industry security standards',
                    subRequirements: [
                        { text: 'No card data storage (Stripe tokens)', time: 'N/A', status: '' },
                        { text: 'SSL/TLS encryption', time: 'Complete', status: '' },
                        { text: 'Vendor compliance verification', time: '1 day', status: '' },
                        { text: 'Security policy documentation', time: '1 day', status: '' }
                    ],
                    estimatedCompletion: 'Complete',
                    priority: 'Critical'
                },
                // Meetings
                'All Hands Meeting': {
                    description: 'Company-wide team sync and updates',
                    subRequirements: [
                        { text: 'Prepare agenda and slides', time: '2 hours', status: '' },
                        { text: 'Review key metrics', time: '30 min', status: '' },
                        { text: 'Collect team updates', time: '1 hour', status: '' },
                        { text: 'Q&A preparation', time: '30 min', status: '' }
                    ],
                    estimatedCompletion: 'Recurring',
                    priority: 'Medium'
                },
                'Set Up Email Service (Google Workspace)': {
                    description: 'Configure Google Workspace for admin@oith.com email functionality',
                    subRequirements: [
                        { text: 'Sign up for Google Workspace ($6/user/month)', time: '15 min', status: '' },
                        { text: 'Verify domain ownership (DNS TXT record)', time: '30 min', status: '' },
                        { text: 'Create admin@oith.com mailbox', time: '10 min', status: '' },
                        { text: 'Enable Gmail API in Google Cloud Console', time: '20 min', status: '' },
                        { text: 'Create OAuth 2.0 credentials', time: '15 min', status: '' },
                        { text: 'Set up OAuth consent screen', time: '10 min', status: '' },
                        { text: 'Add credentials to server .env file', time: '5 min', status: '' },
                        { text: 'Test email send/receive in admin panel', time: '15 min', status: '' }
                    ],
                    estimatedCompletion: '2-3 hours',
                    priority: 'High',
                    nextSteps: [
                        { text: 'Configure email templates for user notifications', priority: 'high' },
                        { text: 'Set up support ticket auto-responses', priority: 'medium' },
                        { text: 'Create email signature template', priority: 'low' },
                        { text: 'Document email API integration for team', priority: 'medium' }
                    ]
                },
                'Leadership Standup': {
                    description: 'Weekly leadership alignment meeting',
                    subRequirements: [
                        { text: 'Review blockers and risks', time: '15 min', status: '' },
                        { text: 'Resource allocation check', time: '15 min', status: '' },
                        { text: 'Priority alignment', time: '15 min', status: '' },
                        { text: 'Action items follow-up', time: '15 min', status: '' }
                    ],
                    estimatedCompletion: 'Recurring (bi-weekly)',
                    priority: 'High'
                },
                'Sprint Planning': {
                    description: 'Plan upcoming sprint work items',
                    subRequirements: [
                        { text: 'Review backlog priorities', time: '30 min', status: '' },
                        { text: 'Estimate story points', time: '1 hour', status: '' },
                        { text: 'Assign ownership', time: '30 min', status: '' },
                        { text: 'Identify dependencies', time: '30 min', status: '' }
                    ],
                    estimatedCompletion: 'Recurring (bi-weekly)',
                    priority: 'High'
                },
                'Monthly KPI Review': {
                    description: 'Review key performance indicators',
                    subRequirements: [
                        { text: 'Gather metrics data', time: '1 hour', status: '' },
                        { text: 'Prepare dashboard', time: '2 hours', status: '' },
                        { text: 'Trend analysis', time: '1 hour', status: '' },
                        { text: 'Recommendations', time: '1 hour', status: '' }
                    ],
                    estimatedCompletion: 'Recurring (monthly)',
                    priority: 'High'
                },
                'Weekly Safety Report': {
                    description: 'Review safety metrics and incidents',
                    subRequirements: [
                        { text: 'Review flagged content', time: '30 min', status: '' },
                        { text: 'User reports analysis', time: '30 min', status: '' },
                        { text: 'Bot detection review', time: '30 min', status: '' },
                        { text: 'Action items from incidents', time: '30 min', status: '' }
                    ],
                    estimatedCompletion: 'Recurring (weekly)',
                    priority: 'High'
                },
                // Other milestones
                'API Architecture Ready': {
                    description: 'Backend API design and documentation complete',
                    subRequirements: [
                        { text: 'OpenAPI/Swagger spec', time: '2 days', status: '' },
                        { text: 'Authentication endpoints', time: '1 day', status: '' },
                        { text: 'Rate limiting design', time: '1 day', status: '' },
                        { text: 'Error handling standards', time: '1 day', status: '' }
                    ],
                    estimatedCompletion: '1 week',
                    priority: 'High'
                },
                'Legal Documents Ready': {
                    description: 'Legal documentation prepared and reviewed',
                    subRequirements: [
                        { text: 'Terms of Service', time: '3 days', status: '' },
                        { text: 'Privacy Policy', time: '2 days', status: '' },
                        { text: 'EULA', time: '2 days', status: '' },
                        { text: 'Legal review', time: '1 week', status: '' }
                    ],
                    estimatedCompletion: '2 weeks',
                    priority: 'Critical'
                },
                'Infrastructure Setup Complete': {
                    description: 'Cloud infrastructure and DevOps ready',
                    subRequirements: [
                        { text: 'AWS account setup', time: '1 day', status: '' },
                        { text: 'Kubernetes cluster', time: '2 days', status: '' },
                        { text: 'CI/CD pipeline', time: '2 days', status: '' },
                        { text: 'Monitoring & alerting', time: '2 days', status: '' }
                    ],
                    estimatedCompletion: '1 week',
                    priority: 'Critical'
                },
                'D-U-N-S Number Received': {
                    description: 'D&B business identifier for Apple Developer',
                    subRequirements: [
                        { text: 'Submit D&B application', time: '1 day', status: '' },
                        { text: 'Business verification', time: '2 weeks', status: '' },
                        { text: 'Number received', time: 'Complete', status: '' }
                    ],
                    estimatedCompletion: '2-3 weeks',
                    priority: 'High'
                },
                'Developer Accounts (Apple & Google)': {
                    description: 'Set up app store developer accounts',
                    subRequirements: [
                        { text: 'Apple Developer Program enrollment', time: '2 days', status: '' },
                        { text: 'Google Play Console setup', time: '1 day', status: '' },
                        { text: 'Team member invites', time: '1 day', status: '' },
                        { text: 'Payment setup', time: '1 day', status: '' }
                    ],
                    estimatedCompletion: '1 week',
                    priority: 'High'
                },
                ' December Payroll': {
                    description: 'Process monthly payroll',
                    subRequirements: [
                        { text: 'Timesheet review', time: '2 hours', status: '' },
                        { text: 'Calculate deductions', time: '1 hour', status: '' },
                        { text: 'Process payments', time: '1 hour', status: '' },
                        { text: 'File tax deposits', time: '1 hour', status: '' }
                    ],
                    estimatedCompletion: 'By month end',
                    priority: 'Critical'
                },
                ' PCT International Application Q4 2025': {
                    description: 'File international patent application',
                    subRequirements: [
                        { text: 'Draft PCT application', time: '2 weeks', status: '' },
                        { text: 'Prior art search', time: '1 week', status: '' },
                        { text: 'Attorney review', time: '1 week', status: '' },
                        { text: 'Filing fees payment', time: '1 day', status: '' }
                    ],
                    estimatedCompletion: '1 month',
                    priority: 'High'
                }
            };
            
            // Check if we have specific notes for this event
            let notes = eventNotes[event.title];
            
            // If not found, generate generic notes based on category
            if (!notes) {
                const genericNotes = {
                    'meeting': {
                        description: 'Team meeting or sync',
                        subRequirements: [
                            { text: 'Review previous action items', time: '10 min', status: '' },
                            { text: 'Discuss current priorities', time: '20 min', status: '' },
                            { text: 'Identify blockers', time: '10 min', status: '' },
                            { text: 'Assign new action items', time: '10 min', status: '' }
                        ],
                        estimatedCompletion: '1 hour',
                        priority: 'Medium'
                    },
                    'milestone': {
                        description: 'Project milestone checkpoint',
                        subRequirements: [
                            { text: 'Verify deliverables complete', time: 'Varies', status: '' },
                            { text: 'Quality review', time: 'Varies', status: '' },
                            { text: 'Stakeholder sign-off', time: '1 day', status: '' }
                        ],
                        estimatedCompletion: 'Target date',
                        priority: 'High'
                    },
                    'compliance': {
                        description: 'Regulatory compliance task',
                        subRequirements: [
                            { text: 'Review requirements', time: '2 hours', status: '' },
                            { text: 'Gap analysis', time: '1 day', status: '' },
                            { text: 'Implementation', time: 'Varies', status: '' },
                            { text: 'Verification', time: '1 day', status: '' }
                        ],
                        estimatedCompletion: 'By deadline',
                        priority: 'Critical'
                    },
                    'payroll': {
                        description: 'Payroll processing task',
                        subRequirements: [
                            { text: 'Verify hours/salaries', time: '1 hour', status: '' },
                            { text: 'Process payments', time: '2 hours', status: '' },
                            { text: 'Tax filing', time: '1 hour', status: '' }
                        ],
                        estimatedCompletion: 'By pay date',
                        priority: 'Critical'
                    },
                    'safety': {
                        description: 'Safety and trust review',
                        subRequirements: [
                            { text: 'Review flagged items', time: '30 min', status: '' },
                            { text: 'Take necessary actions', time: 'Varies', status: '' },
                            { text: 'Document outcomes', time: '15 min', status: '' }
                        ],
                        estimatedCompletion: 'Recurring',
                        priority: 'High'
                    },
                    'patent': {
                        description: 'Intellectual property task',
                        subRequirements: [
                            { text: 'Documentation preparation', time: 'Varies', status: '' },
                            { text: 'Legal review', time: '1 week', status: '' },
                            { text: 'Filing', time: '1 day', status: '' }
                        ],
                        estimatedCompletion: 'Per deadline',
                        priority: 'High'
                    },
                    'tax': {
                        description: 'Tax-related task',
                        subRequirements: [
                            { text: 'Gather documentation', time: '2 hours', status: '' },
                            { text: 'Calculate amounts', time: '1 hour', status: '' },
                            { text: 'File/Submit', time: '1 hour', status: '' }
                        ],
                        estimatedCompletion: 'By deadline',
                        priority: 'Critical'
                    }
                };
                
                notes = genericNotes[event.category] || {
                    description: event.description || 'Calendar event',
                    subRequirements: [
                        { text: 'Review event details', time: 'Varies', status: '' },
                        { text: 'Complete required tasks', time: 'Varies', status: '' },
                        { text: 'Follow up as needed', time: 'Varies', status: '' }
                    ],
                    estimatedCompletion: 'As scheduled',
                    priority: 'Medium'
                };
            }
            
            return notes;
        }
        
        function renderEventNotes(notes) {
            if (!notes) return '<p style="color: var(--text-muted);">No notes available.</p>';
            
            let html = '';
            
            if (notes.description) {
                html += `<p style="margin-bottom: 10px; color: var(--text-secondary);">${notes.description}</p>`;
            }
            
            if (notes.subRequirements && notes.subRequirements.length > 0) {
                html += '<div style="margin-top: 8px;">';
                notes.subRequirements.forEach(req => {
                    html += `
                        <div class="sub-requirement">
                            <span class="sub-req-status">${req.status}</span>
                            <span class="sub-req-text">${req.text}</span>
                            <span class="sub-req-time">${req.time}</span>
                        </div>
                    `;
                });
                html += '</div>';
            }
            
            html += `
                <div style="display: flex; gap: 16px; margin-top: 12px; padding-top: 10px; border-top: 1px solid var(--border-light, rgba(255,255,255,0.08));">
                    <div>
                        <span style="font-size: 0.65rem; color: var(--text-muted); text-transform: uppercase;">Est. Completion</span>
                        <div style="font-size: 0.78rem; font-weight: 500; color: var(--text-primary);">${notes.estimatedCompletion}</div>
                    </div>
                    <div>
                        <span style="font-size: 0.65rem; color: var(--text-muted); text-transform: uppercase;">Priority</span>
                        <div style="font-size: 0.78rem; font-weight: 500; color: ${notes.priority === 'Critical' ? 'var(--danger)' : notes.priority === 'High' ? 'var(--warning)' : notes.priority === 'Milestone' ? 'var(--success)' : 'var(--text-primary)'};">${notes.priority}</div>
                    </div>
                </div>
            `;
            
            // Next Steps section
            if (notes.nextSteps && notes.nextSteps.length > 0) {
                html += `
                    <div style="margin-top: 14px; padding-top: 12px; border-top: 1px solid var(--border-light, rgba(255,255,255,0.08));">
                        <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 10px;">
                            <span style="font-size: 1rem;"></span>
                            <span style="font-size: 0.75rem; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px;">Next Steps</span>
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 6px;">
                `;
                
                notes.nextSteps.forEach((step, index) => {
                    const priorityColor = step.priority === 'high' ? 'var(--warning)' : 
                                         step.priority === 'low' ? 'var(--text-muted)' : 'var(--info)';
                    const priorityBadge = step.priority === 'high' ? '' : 
                                         step.priority === 'low' ? '' : '';
                    const escapedText = step.text.replace(/'/g, "\\'").replace(/"/g, '\\"');
                    html += `
                        <div class="next-step-item next-step-schedulable" style="display: flex; align-items: center; gap: 8px; padding: 8px 10px; background: var(--bg-secondary); border-radius: 6px; cursor: pointer; transition: all 0.2s ease;" onclick="scheduleNextStepMeeting('${escapedText}', '${step.priority || 'medium'}')">
                            <span style="font-size: 0.7rem;">${priorityBadge}</span>
                            <span style="flex: 1; font-size: 0.78rem; color: var(--text-primary);">${step.text}</span>
                            <span class="next-step-schedule-btn" style="display: flex; align-items: center; gap: 4px; font-size: 0.65rem; color: var(--accent); opacity: 0.7; transition: opacity 0.2s;">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="3" y="4" width="18" height="18" rx="2"/>
                                    <line x1="16" y1="2" x2="16" y2="6"/>
                                    <line x1="8" y1="2" x2="8" y2="6"/>
                                    <line x1="3" y1="10" x2="21" y2="10"/>
                                    <path d="M12 14v4M10 16h4"/>
                                </svg>
                                Schedule
                            </span>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            }
            
            return html;
        }
        
        // Navigate to another event from Next Steps
        function navigateToEvent(eventTitle) {
            const event = calendarEvents.find(e => e.title === eventTitle);
            if (event) {
                openEventDetails(event);
            } else {
                showToast(`Event "${eventTitle}" not found`, 'info');
            }
        }
        
        // Schedule a meeting for a Next Step task
        function scheduleNextStepMeeting(taskText, priority) {
            console.log(' Scheduling meeting for:', taskText, 'Priority:', priority);
            
            // Close any open event details modal first (with null check)
            const eventModal = document.getElementById('eventDetailsModal');
            if (eventModal) {
                eventModal.style.display = 'none';
            }
            currentViewingEvent = null;
            isEditMode = false;
            
            // Generate the meeting notes
            const autoNotes = generateMeetingNotes(taskText, priority);
            
            // Calculate suggested date and time
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            const dateStr = tomorrow.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });
            
            let timeStr;
            if (priority === 'high') {
                timeStr = '9:00 AM';
            } else if (priority === 'low') {
                timeStr = '2:00 PM';
            } else {
                timeStr = '10:00 AM';
            }
            
            let duration;
            if (taskText.toLowerCase().includes('quick') || taskText.toLowerCase().includes('brief')) {
                duration = '15 minutes';
            } else if (priority === 'high') {
                duration = '1 hour';
            } else if (priority === 'low') {
                duration = '30 minutes';
            } else {
                duration = '45 minutes';
            }
            
            // Create and show a custom modal for scheduling
            showNextStepSchedulerModal(taskText, priority, dateStr, timeStr, duration, autoNotes);
        }
        
        // Show custom scheduler modal for next steps
        function showNextStepSchedulerModal(taskText, priority, dateStr, timeStr, duration, autoNotes) {
            // Remove existing modal if present
            const existingModal = document.getElementById('nextStepSchedulerModal');
            if (existingModal) existingModal.remove();
            
            // Calculate default date for input
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            const defaultDate = tomorrow.toISOString().split('T')[0];
            
            // Calculate default time
            let defaultTime;
            if (priority === 'high') {
                defaultTime = '09:00';
            } else if (priority === 'low') {
                defaultTime = '14:00';
            } else {
                defaultTime = '10:00';
            }
            
            // Calculate default duration
            let defaultDuration;
            if (taskText.toLowerCase().includes('quick') || taskText.toLowerCase().includes('brief')) {
                defaultDuration = '15';
            } else if (priority === 'high') {
                defaultDuration = '60';
            } else if (priority === 'low') {
                defaultDuration = '30';
            } else {
                defaultDuration = '45';
            }
            
            const modalHTML = `
                <div id="nextStepSchedulerModal" style="position: fixed; inset: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 9999; backdrop-filter: blur(4px);">
                    <div style="background: var(--bg-secondary, #2d2d2d); border-radius: 16px; max-width: 650px; width: 95%; max-height: 90vh; overflow: hidden; box-shadow: 0 25px 60px rgba(0,0,0,0.5);">
                        <div id="nextStepModalHeader" style="background: linear-gradient(135deg, var(--accent, #0078d4), var(--warning, #ff8c00)); padding: 20px 24px; display: flex; justify-content: space-between; align-items: center;">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <span style="font-size: 1.5rem;"></span>
                                <div>
                                    <h3 style="margin: 0; font-size: 1.1rem; color: white;">Schedule Meeting</h3>
                                    <p style="margin: 2px 0 0; font-size: 0.8rem; color: rgba(255,255,255,0.8);">For: ${taskText}</p>
                                </div>
                            </div>
                            <button onclick="document.getElementById('nextStepSchedulerModal').remove()" style="background: rgba(255,255,255,0.2); border: none; color: white; width: 32px; height: 32px; border-radius: 8px; cursor: pointer; font-size: 1.2rem;"></button>
                        </div>
                        
                        <div style="padding: 20px 24px; overflow-y: auto; max-height: calc(90vh - 180px);">
                            <!-- Meeting Title -->
                            <div style="margin-bottom: 16px;">
                                <label style="font-size: 0.75rem; color: var(--text-muted, #8a8a8a); text-transform: uppercase; display: block; margin-bottom: 6px;">Meeting Title</label>
                                <input type="text" id="nextStepTitle" value=" ${taskText}" style="width: 100%; padding: 12px 14px; background: var(--bg-tertiary, #3d3d3d); border: 1px solid var(--border, #3d3d3d); border-radius: 10px; color: var(--text-primary, #fff); font-size: 0.95rem; outline: none; transition: border-color 0.2s;" onfocus="this.style.borderColor='var(--accent, #0078d4)'" onblur="this.style.borderColor='var(--border, #3d3d3d)'">
                            </div>
                            
                            <!-- Date, Time, Duration Row -->
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                                <div>
                                    <label style="font-size: 0.75rem; color: var(--text-muted, #8a8a8a); text-transform: uppercase; display: block; margin-bottom: 6px;"> Date</label>
                                    <input type="date" id="nextStepDate" value="${defaultDate}" style="width: 100%; padding: 12px 14px; background: var(--bg-tertiary, #3d3d3d); border: 1px solid var(--border, #3d3d3d); border-radius: 10px; color: var(--text-primary, #fff); font-size: 0.9rem; outline: none; cursor: pointer;" onfocus="this.style.borderColor='var(--accent, #0078d4)'" onblur="this.style.borderColor='var(--border, #3d3d3d)'">
                                </div>
                                <div>
                                    <label style="font-size: 0.75rem; color: var(--text-muted, #8a8a8a); text-transform: uppercase; display: block; margin-bottom: 6px;"> Time</label>
                                    <input type="time" id="nextStepTime" value="${defaultTime}" style="width: 100%; padding: 12px 14px; background: var(--bg-tertiary, #3d3d3d); border: 1px solid var(--border, #3d3d3d); border-radius: 10px; color: var(--text-primary, #fff); font-size: 0.9rem; outline: none; cursor: pointer;" onfocus="this.style.borderColor='var(--accent, #0078d4)'" onblur="this.style.borderColor='var(--border, #3d3d3d)'">
                                </div>
                                <div>
                                    <label style="font-size: 0.75rem; color: var(--text-muted, #8a8a8a); text-transform: uppercase; display: block; margin-bottom: 6px;"> Duration</label>
                                    <select id="nextStepDuration" style="width: 100%; padding: 12px 14px; background: var(--bg-tertiary, #3d3d3d); border: 1px solid var(--border, #3d3d3d); border-radius: 10px; color: var(--text-primary, #fff); font-size: 0.9rem; outline: none; cursor: pointer;" onfocus="this.style.borderColor='var(--accent, #0078d4)'" onblur="this.style.borderColor='var(--border, #3d3d3d)'">
                                        <option value="15" ${defaultDuration === '15' ? 'selected' : ''}>15 minutes</option>
                                        <option value="30" ${defaultDuration === '30' ? 'selected' : ''}>30 minutes</option>
                                        <option value="45" ${defaultDuration === '45' ? 'selected' : ''}>45 minutes</option>
                                        <option value="60" ${defaultDuration === '60' ? 'selected' : ''}>1 hour</option>
                                        <option value="90">1.5 hours</option>
                                        <option value="120">2 hours</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Priority and Category Row -->
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                                <div>
                                    <label style="font-size: 0.75rem; color: var(--text-muted, #8a8a8a); text-transform: uppercase; display: block; margin-bottom: 6px;"> Priority</label>
                                    <select id="nextStepPriority" onchange="updatePriorityColor()" style="width: 100%; padding: 12px 14px; background: var(--bg-tertiary, #3d3d3d); border: 1px solid var(--border, #3d3d3d); border-radius: 10px; color: var(--text-primary, #fff); font-size: 0.9rem; outline: none; cursor: pointer;" onfocus="this.style.borderColor='var(--accent, #0078d4)'" onblur="this.style.borderColor='var(--border, #3d3d3d)'">
                                        <option value="high" ${priority === 'high' ? 'selected' : ''}> High Priority</option>
                                        <option value="medium" ${priority === 'medium' ? 'selected' : ''}> Medium Priority</option>
                                        <option value="low" ${priority === 'low' ? 'selected' : ''}> Low Priority</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="font-size: 0.75rem; color: var(--text-muted, #8a8a8a); text-transform: uppercase; display: block; margin-bottom: 6px;"> Category</label>
                                    <select id="nextStepCategory" style="width: 100%; padding: 12px 14px; background: var(--bg-tertiary, #3d3d3d); border: 1px solid var(--border, #3d3d3d); border-radius: 10px; color: var(--text-primary, #fff); font-size: 0.9rem; outline: none; cursor: pointer;" onfocus="this.style.borderColor='var(--accent, #0078d4)'" onblur="this.style.borderColor='var(--border, #3d3d3d)'">
                                        <option value="meeting"> Meeting</option>
                                        <option value="planning"> Planning</option>
                                        <option value="review"> Review</option>
                                        <option value="training"> Training</option>
                                        <option value="standup"> Standup</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Zoom Meeting Settings -->
                            <div style="margin-bottom: 16px; padding: 16px; background: var(--bg-tertiary, #3d3d3d); border-radius: 12px; border: 1px solid var(--border, #3d3d3d);">
                                <label style="font-size: 0.75rem; color: var(--text-muted, #8a8a8a); text-transform: uppercase; display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M15.6 11.6L22 7v10l-6.4-4.5v-1zM4 5h9a2 2 0 012 2v10a2 2 0 01-2 2H4a2 2 0 01-2-2V7c0-1.1.9-2 2-2z"/>
                                    </svg>
                                    Zoom Meeting Settings
                                </label>
                                
                                <div id="nextStepZoomStatus" style="display: flex; align-items: center; gap: 10px; padding: 12px; background: var(--bg-primary, #1f1f1f); border-radius: 10px; margin-bottom: 12px;">
                                    ${zoomConnected ? 
                                        '<div style="width: 10px; height: 10px; border-radius: 50%; background: var(--success, #107c10); box-shadow: 0 0 8px rgba(16, 124, 16, 0.5);"></div>' +
                                        '<span style="flex: 1; font-size: 0.85rem; color: var(--text-secondary, #aaa);">Connected as ' + (zoomUserData?.name || 'User') + '</span>' +
                                        '<button type="button" onclick="testZoomConnection(\'nextStep\')" style="padding: 6px 12px; background: var(--accent, #0078d4); border: none; border-radius: 6px; color: white; font-size: 0.75rem; cursor: pointer;"> Test</button>'
                                    : 
                                        '<div style="width: 10px; height: 10px; border-radius: 50%; background: var(--text-muted, #8a8a8a);"></div>' +
                                        '<span style="flex: 1; font-size: 0.85rem; color: var(--text-muted, #8a8a8a);">Not Connected</span>' +
                                        '<button type="button" onclick="connectZoomAccount()" style="padding: 6px 12px; background: var(--accent, #0078d4); border: none; border-radius: 6px; color: white; font-size: 0.75rem; cursor: pointer;">Connect Zoom</button>'
                                    }
                                </div>
                                
                                <div id="nextStepZoomPanel" style="display: ${zoomConnected ? 'block' : 'none'};">
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
                                        <div>
                                            <label style="font-size: 0.7rem; color: var(--text-muted, #8a8a8a); display: block; margin-bottom: 4px;">Meeting ID</label>
                                            <div style="display: flex; gap: 6px;">
                                                <input type="text" id="nextStepZoomId" readonly value="${zoomConnected ? generateZoomIdValue() : ''}" style="flex: 1; padding: 8px 10px; background: var(--bg-primary, #1f1f1f); border: 1px solid var(--border, #3d3d3d); border-radius: 8px; color: var(--text-primary, #fff); font-family: monospace; font-size: 0.85rem;">
                                                <button type="button" onclick="regenerateNextStepZoomId()" style="padding: 8px 10px; background: var(--bg-secondary, #2d2d2d); border: 1px solid var(--border, #3d3d3d); border-radius: 8px; color: var(--text-primary, #fff); cursor: pointer; font-size: 0.75rem;"></button>
                                            </div>
                                        </div>
                                        <div>
                                            <label style="font-size: 0.7rem; color: var(--text-muted, #8a8a8a); display: block; margin-bottom: 4px;">Passcode</label>
                                            <input type="text" id="nextStepZoomPasscode" value="${zoomConnected ? generatePasscodeValue() : ''}" style="width: 100%; padding: 8px 10px; background: var(--bg-primary, #1f1f1f); border: 1px solid var(--border, #3d3d3d); border-radius: 8px; color: var(--text-primary, #fff); font-family: monospace; font-size: 0.85rem;">
                                        </div>
                                    </div>
                                    
                                    <div style="display: flex; flex-wrap: wrap; gap: 12px;">
                                        <label style="display: flex; align-items: center; gap: 6px; font-size: 0.8rem; color: var(--text-secondary, #aaa); cursor: pointer;">
                                            <input type="checkbox" id="nextStepWaitingRoom" checked style="width: 16px; height: 16px; accent-color: var(--accent, #0078d4);">
                                            Waiting Room
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 6px; font-size: 0.8rem; color: var(--text-secondary, #aaa); cursor: pointer;">
                                            <input type="checkbox" id="nextStepMuteOnEntry" checked style="width: 16px; height: 16px; accent-color: var(--accent, #0078d4);">
                                            Mute on Entry
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 6px; font-size: 0.8rem; color: var(--text-secondary, #aaa); cursor: pointer;">
                                            <input type="checkbox" id="nextStepRecording" style="width: 16px; height: 16px; accent-color: var(--accent, #0078d4);">
                                            Auto-Record
                                        </label>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Meeting Notes -->
                            <div style="margin-bottom: 8px;">
                                <label style="font-size: 0.75rem; color: var(--text-muted, #8a8a8a); text-transform: uppercase; display: block; margin-bottom: 6px;"> Meeting Notes & Agenda</label>
                                <textarea id="nextStepNotes" style="width: 100%; height: 220px; padding: 14px; background: var(--bg-primary, #1f1f1f); border: 1px solid var(--border, #3d3d3d); border-radius: 10px; color: var(--text-primary, #fff); font-family: 'Consolas', 'Monaco', monospace; font-size: 0.82rem; line-height: 1.5; resize: vertical; outline: none;" onfocus="this.style.borderColor='var(--accent, #0078d4)'" onblur="this.style.borderColor='var(--border, #3d3d3d)'">${autoNotes}</textarea>
                            </div>
                        </div>
                        
                        <div style="padding: 16px 24px; background: var(--bg-tertiary, #3d3d3d); display: flex; gap: 12px; justify-content: space-between; flex-wrap: wrap;">
                            <button onclick="copyNextStepNotes()" style="background: var(--bg-secondary, #2d2d2d); border: 1px solid var(--border, #3d3d3d); color: var(--text-primary, #fff); padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 0.9rem; display: flex; align-items: center; gap: 6px; transition: all 0.2s;" onmouseover="this.style.background='var(--bg-hover, #3a3a3a)'" onmouseout="this.style.background='var(--bg-secondary, #2d2d2d)'">
                                 Copy Notes
                            </button>
                            <div style="display: flex; gap: 12px;">
                                <button onclick="document.getElementById('nextStepSchedulerModal').remove()" style="background: transparent; border: 1px solid var(--border, #3d3d3d); color: var(--text-muted, #8a8a8a); padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 0.9rem; transition: all 0.2s;" onmouseover="this.style.borderColor='var(--text-muted, #8a8a8a)'" onmouseout="this.style.borderColor='var(--border, #3d3d3d)'">
                                    Cancel
                                </button>
                                <button onclick="saveNextStepMeeting()" style="background: var(--success, #107c10); border: none; color: white; padding: 10px 24px; border-radius: 8px; cursor: pointer; font-size: 0.9rem; display: flex; align-items: center; gap: 6px; font-weight: 500; transition: all 0.2s;" onmouseover="this.style.background='#0d6a0d'" onmouseout="this.style.background='var(--success, #107c10)'">
                                     Add to Calendar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // Close on escape key
            const closeOnEscape = (e) => {
                if (e.key === 'Escape') {
                    document.getElementById('nextStepSchedulerModal')?.remove();
                    document.removeEventListener('keydown', closeOnEscape);
                }
            };
            document.addEventListener('keydown', closeOnEscape);
            
            // Close on backdrop click
            document.getElementById('nextStepSchedulerModal').addEventListener('click', (e) => {
                if (e.target.id === 'nextStepSchedulerModal') {
                    e.target.remove();
                }
            });
            
            showToast('Edit the fields and click Add to Calendar to save!', 'info');
        }
        
        // Update header gradient based on priority selection
        function updatePriorityColor() {
            const priority = document.getElementById('nextStepPriority')?.value;
            const header = document.getElementById('nextStepModalHeader');
            if (header) {
                const priorityColor = priority === 'high' ? 'var(--danger, #d13438)' : 
                                     priority === 'low' ? 'var(--success, #107c10)' : 'var(--warning, #ff8c00)';
                header.style.background = `linear-gradient(135deg, var(--accent, #0078d4), ${priorityColor})`;
            }
        }
        
        // Copy notes to clipboard
        function copyNextStepNotes() {
            const notesEl = document.getElementById('nextStepNotes');
            if (notesEl) {
                navigator.clipboard.writeText(notesEl.value).then(() => {
                    showToast('Meeting notes copied to clipboard!', 'success');
                }).catch(() => {
                    notesEl.select();
                    document.execCommand('copy');
                    showToast('Meeting notes copied!', 'success');
                });
            }
        }
        
        // Save next step meeting with all edited fields
        function saveNextStepMeeting() {
            // Get all form values
            const title = document.getElementById('nextStepTitle')?.value || 'Meeting';
            const dateValue = document.getElementById('nextStepDate')?.value;
            const timeValue = document.getElementById('nextStepTime')?.value || '09:00';
            const duration = parseInt(document.getElementById('nextStepDuration')?.value || '30');
            const priority = document.getElementById('nextStepPriority')?.value || 'medium';
            const category = document.getElementById('nextStepCategory')?.value || 'meeting';
            const notes = document.getElementById('nextStepNotes')?.value || '';
            
            // Get Zoom settings
            const zoomId = document.getElementById('nextStepZoomId')?.value || '';
            const zoomPasscode = document.getElementById('nextStepZoomPasscode')?.value || '';
            const waitingRoom = document.getElementById('nextStepWaitingRoom')?.checked || false;
            const muteOnEntry = document.getElementById('nextStepMuteOnEntry')?.checked || false;
            const autoRecord = document.getElementById('nextStepRecording')?.checked || false;
            
            // Validate required fields
            if (!dateValue) {
                showToast('Please select a date', 'error');
                return;
            }
            
            // Create the meeting date/time
            const [hours, minutes] = timeValue.split(':');
            const meetingDate = new Date(dateValue);
            meetingDate.setHours(parseInt(hours), parseInt(minutes), 0, 0);
            
            const newEvent = {
                id: Date.now(),
                title: title,
                date: meetingDate.toISOString(),
                category: category,
                description: notes,
                section: 'calendar',
                custom: true,
                isMeeting: true,
                meetingDetails: {
                    duration: duration,
                    priority: priority,
                    eventType: 'virtual'
                }
            };
            
            // Add Zoom settings if connected
            if (zoomConnected && zoomId) {
                newEvent.zoomSettings = {
                    meetingId: zoomId,
                    passcode: zoomPasscode,
                    waitingRoom: waitingRoom,
                    muteOnEntry: muteOnEntry,
                    autoRecord: autoRecord
                };
            }
            
            // Add to calendar events array
            if (typeof calendarEvents !== 'undefined' && Array.isArray(calendarEvents)) {
                calendarEvents.push(newEvent);
            }
            
            // Save to localStorage
            let savedEvents = JSON.parse(localStorage.getItem('oith_calendar_events') || '[]');
            savedEvents.push({
                ...newEvent,
                date: dateValue // Store just the date string for localStorage
            });
            localStorage.setItem('oith_calendar_events', JSON.stringify(savedEvents));
            
            // Sync to AWS if configured
            if (typeof syncCalendarToAWS === 'function') {
                syncCalendarToAWS(true);
            }
            
            // Refresh calendar views if functions exist
            if (typeof renderCalendar === 'function') renderCalendar();
            if (typeof renderUpcomingEvents === 'function') renderUpcomingEvents();
            if (typeof updateCalendarBadge === 'function') updateCalendarBadge();
            // Also update Full Calendar View section
            if (typeof renderCalendarGrid === 'function') renderCalendarGrid();
            if (typeof renderMilestones === 'function') renderMilestones();
            if (typeof renderUpcomingTasks === 'function') renderUpcomingTasks();
            
            // Close the modal
            document.getElementById('nextStepSchedulerModal')?.remove();
            
            // Show success message with meeting details
            const priorityEmoji = priority === 'high' ? '' : priority === 'low' ? '' : '';
            const formattedDate = meetingDate.toLocaleDateString('en-US', { 
                weekday: 'short', 
                month: 'short', 
                day: 'numeric' 
            });
            const formattedTime = meetingDate.toLocaleTimeString('en-US', { 
                hour: 'numeric', 
                minute: '2-digit' 
            });
            
            showToast(`${priorityEmoji} Meeting scheduled for ${formattedDate} at ${formattedTime}!`, 'success');
        }
        
        // Generate meeting notes based on task text and priority
        function generateMeetingNotes(taskText, priority) {
            const priorityLabel = priority === 'high' ? ' HIGH PRIORITY' : 
                                 priority === 'low' ? ' LOW PRIORITY' : ' MEDIUM PRIORITY';
            
            let agenda = `${priorityLabel}\n\n`;
            agenda += ` OBJECTIVE\n`;
            agenda += `${taskText}\n\n`;
            agenda += ` AGENDA\n`;
            
            // Generate contextual agenda items based on the task
            if (taskText.toLowerCase().includes('configure') || taskText.toLowerCase().includes('set up')) {
                agenda += `1. Review current configuration/setup status\n`;
                agenda += `2. Identify requirements and dependencies\n`;
                agenda += `3. Define implementation steps\n`;
                agenda += `4. Assign action items and deadlines\n`;
                agenda += `5. Schedule follow-up if needed\n`;
            } else if (taskText.toLowerCase().includes('document') || taskText.toLowerCase().includes('api')) {
                agenda += `1. Review existing documentation\n`;
                agenda += `2. Identify gaps and areas for improvement\n`;
                agenda += `3. Define documentation scope and format\n`;
                agenda += `4. Assign writing responsibilities\n`;
                agenda += `5. Set review and completion timeline\n`;
            } else if (taskText.toLowerCase().includes('template') || taskText.toLowerCase().includes('create')) {
                agenda += `1. Define requirements and use cases\n`;
                agenda += `2. Review existing templates/examples\n`;
                agenda += `3. Draft initial design/structure\n`;
                agenda += `4. Gather feedback from stakeholders\n`;
                agenda += `5. Finalize and distribute\n`;
            } else if (taskText.toLowerCase().includes('review') || taskText.toLowerCase().includes('qa')) {
                agenda += `1. Present work for review\n`;
                agenda += `2. Discuss findings and feedback\n`;
                agenda += `3. Identify issues and improvements\n`;
                agenda += `4. Create action items from review\n`;
                agenda += `5. Set timeline for revisions\n`;
            } else {
                // Default agenda structure
                agenda += `1. Review current status and progress\n`;
                agenda += `2. Discuss key objectives and goals\n`;
                agenda += `3. Identify blockers and challenges\n`;
                agenda += `4. Define next steps and action items\n`;
                agenda += `5. Assign owners and set deadlines\n`;
            }
            
            agenda += `\n NOTES\n`;
            agenda += ` \n`;
            agenda += ` \n`;
            agenda += `\n ACTION ITEMS\n`;
            agenda += `[ ] \n`;
            agenda += `[ ] \n`;
            agenda += `\n FOLLOW-UP\n`;
            agenda += `Next check-in: TBD`;
            
            return agenda;
        }
        
        function openEventDetails(event) {
            console.log(' Opening event details:', event);
            
            if (!event) {
                console.error('No event provided to openEventDetails');
                return;
            }
            
            currentViewingEvent = event;
            isEditMode = false;
            
            // Create modal dynamically if it doesn't exist
            let modal = document.getElementById('eventDetailsModal');
            if (!modal) {
                modal = createEventDetailsModal();
            }
            
            // Get modal elements
            const iconEl = document.getElementById('eventDetailsIcon');
            const titleEl = document.getElementById('eventDetailsTitle');
            const categoryEl = document.getElementById('eventDetailsCategory');
            const headerEl = document.getElementById('eventDetailsHeader');
            
            // Get category icon
            const categoryIcons = {
                'meeting': '',
                'standup': '',
                'interview': '',
                'review': '',
                'planning': '',
                'training': '',
                'client': '',
                'webinar': '',
                'payroll': '',
                'tax': '',
                'compliance': '',
                'milestone': '',
                'patent': '',
                'report': '',
                'experiment': ''
            };
            
            const icon = categoryIcons[event.category] || '';
            
            // Update header with null checks
            if (iconEl) iconEl.textContent = icon;
            if (titleEl) titleEl.textContent = event.title;
            if (categoryEl) categoryEl.textContent = event.category || 'Event';
            
            // Apply category color to header
            if (headerEl) headerEl.className = 'event-details-header ' + (event.category || '');
            
            // Format date/time
            const eventDate = new Date(event.date);
            const dateStr = eventDate.toLocaleDateString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            
            let timeStr = '';
            if (event.meetingDetails?.duration) {
                const startTime = eventDate.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
                const endTime = new Date(eventDate.getTime() + event.meetingDetails.duration * 60000)
                    .toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
                timeStr = `${startTime} - ${endTime}`;
            } else if (eventDate.getHours() !== 0 || eventDate.getMinutes() !== 0) {
                timeStr = eventDate.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
            }
            
            const dateTimeEl = document.getElementById('eventDetailsDateTime');
            if (dateTimeEl) {
                dateTimeEl.innerHTML = timeStr 
                    ? `${dateStr}<br><span style="color: var(--text-muted);">${timeStr}</span>` 
                    : dateStr;
            }
            
            // Location
            const locationRow = document.getElementById('eventDetailsLocationRow');
            const locationEl = document.getElementById('eventDetailsLocation');
            if (event.meetingDetails?.location) {
                if (locationRow) locationRow.style.display = 'flex';
                if (locationEl) locationEl.textContent = event.meetingDetails.location;
            } else {
                if (locationRow) locationRow.style.display = 'none';
            }
            
            // Zoom details
            const zoomRow = document.getElementById('eventDetailsZoomRow');
            const zoomEl = document.getElementById('eventDetailsZoom');
            if (event.meetingDetails?.zoomMeetingId) {
                if (zoomRow) zoomRow.style.display = 'flex';
                const zoomInfo = `Meeting ID: ${event.meetingDetails.zoomMeetingId}` +
                    (event.meetingDetails.zoomPasscode ? `<br>Passcode: ${event.meetingDetails.zoomPasscode}` : '');
                if (zoomEl) zoomEl.innerHTML = zoomInfo;
            } else {
                if (zoomRow) zoomRow.style.display = 'none';
            }
            
            // Attendees
            const attendeesRow = document.getElementById('eventDetailsAttendeesRow');
            const attendeesEl = document.getElementById('eventDetailsAttendees');
            if (event.meetingDetails?.invitees?.length > 0) {
                if (attendeesRow) attendeesRow.style.display = 'flex';
                const attendeesList = event.meetingDetails.invitees.map(i => i.value).join(', ');
                if (attendeesEl) attendeesEl.textContent = attendeesList;
            } else {
                if (attendeesRow) attendeesRow.style.display = 'none';
            }
            
            // Description
            const descRow = document.getElementById('eventDetailsDescRow');
            const descEl = document.getElementById('eventDetailsDescription') || document.getElementById('eventDetailsDesc');
            if (event.description) {
                if (descRow) descRow.style.display = 'flex';
                if (descEl) descEl.textContent = event.description;
            } else {
                if (descRow) descRow.style.display = 'none';
            }
            
            // Section info
            const sectionBtn = document.getElementById('eventDetailsGoToSection');
            const sectionValueEl = document.getElementById('eventDetailsSection');
            if (sectionBtn) sectionBtn.textContent = `Go to ${event.section || 'Calendar'}`;
            if (sectionValueEl) sectionValueEl.textContent = event.section || 'General';
            
            // Generate and display notes
            const notesContent = document.getElementById('eventNotesContent');
            if (notesContent) {
                const notes = generateEventNotes(event);
                notesContent.innerHTML = renderEventNotes(notes);
            }
            
            // Show view mode, hide edit mode
            const viewMode = document.getElementById('eventViewMode');
            const editMode = document.getElementById('eventEditMode');
            const viewBtns = document.getElementById('viewModeButtons') || document.getElementById('eventViewActions');
            const editBtns = document.getElementById('editModeButtons') || document.getElementById('eventEditActions');
            
            if (viewMode) viewMode.style.display = 'block';
            if (editMode) editMode.style.display = 'none';
            if (viewBtns) viewBtns.style.display = 'flex';
            if (editBtns) editBtns.style.display = 'none';
            
            // Show/hide delete button (only for custom events)
            const deleteBtn = document.getElementById('deleteEventBtn');
            if (deleteBtn) deleteBtn.style.display = event.custom ? 'flex' : 'none';
            
            // Open modal
            modal.style.display = 'flex';
            console.log(' Event details modal opened');
        }
        
        function closeEventDetails() {
            document.getElementById('eventDetailsModal').style.display = 'none';
            currentViewingEvent = null;
            isEditMode = false;
        }
        
        function goToEventSection() {
            if (currentViewingEvent) {
                const section = currentViewingEvent.section || 'calendar';
                closeEventDetails();
                if (typeof showSection === 'function') {
                    showSection(section);
                }
            }
        }
        
        function enterEditMode() {
            if (!currentViewingEvent) return;
            
            isEditMode = true;
            
            // Populate edit form
            document.getElementById('editEventTitle').value = currentViewingEvent.title || '';
            
            const eventDate = new Date(currentViewingEvent.date);
            document.getElementById('editEventDate').value = eventDate.toISOString().split('T')[0];
            
            if (eventDate.getHours() !== 0 || eventDate.getMinutes() !== 0) {
                document.getElementById('editEventTime').value = 
                    eventDate.getHours().toString().padStart(2, '0') + ':' + 
                    eventDate.getMinutes().toString().padStart(2, '0');
            } else {
                document.getElementById('editEventTime').value = '';
            }
            
            document.getElementById('editEventCategory').value = currentViewingEvent.category || 'meeting';
            document.getElementById('editEventLocation').value = currentViewingEvent.meetingDetails?.location || '';
            document.getElementById('editEventDescription').value = currentViewingEvent.description || '';
            
            // Toggle visibility
            document.getElementById('eventViewMode').style.display = 'none';
            document.getElementById('eventEditMode').style.display = 'block';
            document.getElementById('viewModeButtons').style.display = 'none';
            document.getElementById('editModeButtons').style.display = 'flex';
        }
        
        function cancelEditMode() {
            isEditMode = false;
            
            // Toggle visibility back
            document.getElementById('eventViewMode').style.display = 'block';
            document.getElementById('eventEditMode').style.display = 'none';
            document.getElementById('viewModeButtons').style.display = 'flex';
            document.getElementById('editModeButtons').style.display = 'none';
        }
        
        // Toggle between view and edit mode (for dynamically created modal)
        function toggleEventEditMode(enterEdit) {
            if (!currentViewingEvent) return;
            
            isEditMode = enterEdit;
            
            const viewMode = document.getElementById('eventViewMode');
            const editMode = document.getElementById('eventEditMode');
            const viewActions = document.getElementById('eventViewActions');
            const editActions = document.getElementById('eventEditActions');
            
            if (enterEdit) {
                // Populate edit fields
                const titleField = document.getElementById('editEventTitle');
                const dateField = document.getElementById('editEventDate');
                const timeField = document.getElementById('editEventTime');
                const categoryField = document.getElementById('editEventCategory');
                const locationField = document.getElementById('editEventLocation');
                const descField = document.getElementById('editEventDesc') || document.getElementById('editEventDescription');
                
                if (titleField) titleField.value = currentViewingEvent.title || '';
                
                const eventDate = new Date(currentViewingEvent.date);
                if (dateField) dateField.value = eventDate.toISOString().split('T')[0];
                
                if (timeField) {
                    if (eventDate.getHours() !== 0 || eventDate.getMinutes() !== 0) {
                        timeField.value = eventDate.getHours().toString().padStart(2, '0') + ':' + 
                            eventDate.getMinutes().toString().padStart(2, '0');
                    } else {
                        timeField.value = '';
                    }
                }
                
                if (categoryField) categoryField.value = currentViewingEvent.category || 'meeting';
                if (locationField) locationField.value = currentViewingEvent.meetingDetails?.location || '';
                if (descField) descField.value = currentViewingEvent.description || '';
                
                // Toggle visibility
                if (viewMode) viewMode.style.display = 'none';
                if (editMode) editMode.style.display = 'block';
                if (viewActions) viewActions.style.display = 'none';
                if (editActions) editActions.style.display = 'flex';
            } else {
                // Cancel edit - toggle back
                if (viewMode) viewMode.style.display = 'block';
                if (editMode) editMode.style.display = 'none';
                if (viewActions) viewActions.style.display = 'flex';
                if (editActions) editActions.style.display = 'none';
            }
        }
        
        function saveEventChanges() {
            if (!currentViewingEvent) return;
            
            const title = document.getElementById('editEventTitle').value;
            const dateVal = document.getElementById('editEventDate').value;
            const timeVal = document.getElementById('editEventTime').value;
            // Handle both static and dynamic modal field IDs
            const categoryField = document.getElementById('editEventCategory');
            const category = categoryField ? categoryField.value : currentViewingEvent.category;
            const location = document.getElementById('editEventLocation').value;
            const descField = document.getElementById('editEventDescription') || document.getElementById('editEventDesc');
            const description = descField ? descField.value : '';
            
            if (!title || !dateVal) {
                showToast('Please fill in required fields', 'error');
                return;
            }
            
            // Create new date
            const newDate = new Date(dateVal + (timeVal ? 'T' + timeVal : 'T00:00'));
            
            // Update the event
            currentViewingEvent.title = title;
            currentViewingEvent.date = newDate.toISOString();
            currentViewingEvent.category = category;
            currentViewingEvent.description = description;
            
            if (!currentViewingEvent.meetingDetails) {
                currentViewingEvent.meetingDetails = {};
            }
            currentViewingEvent.meetingDetails.location = location;
            
            // Save to localStorage
            let savedEvents = JSON.parse(localStorage.getItem('oith_calendar_events') || '[]');
            const eventIndex = savedEvents.findIndex(e => e.id === currentViewingEvent.id);
            if (eventIndex >= 0) {
                savedEvents[eventIndex] = { ...currentViewingEvent, date: newDate.toISOString() };
                localStorage.setItem('oith_calendar_events', JSON.stringify(savedEvents));
            }
            
            // Update in calendarEvents array
            const calendarIndex = calendarEvents.findIndex(e => e.id === currentViewingEvent.id);
            if (calendarIndex >= 0) {
                calendarEvents[calendarIndex] = { ...currentViewingEvent, date: newDate };
            }
            
            // Sync to AWS
            if (typeof syncCalendarToAWS === 'function') {
                syncCalendarToAWS(true);
            }
            
            // Re-render calendar
            if (typeof renderCalendar === 'function') {
                renderCalendar();
            }
            if (typeof renderUpcomingEvents === 'function') {
                renderUpcomingEvents();
            }
            // Also update Full Calendar View section
            if (typeof renderCalendarGrid === 'function') renderCalendarGrid();
            if (typeof renderMilestones === 'function') renderMilestones();
            if (typeof renderUpcomingTasks === 'function') renderUpcomingTasks();
            
            showToast('Event updated successfully!', 'success');
            closeEventDetails();
        }
        
        function deleteEvent() {
            if (!currentViewingEvent) return;
            
            if (!confirm(`Are you sure you want to delete "${currentViewingEvent.title}"?`)) {
                return;
            }
            
            // Remove from localStorage
            let savedEvents = JSON.parse(localStorage.getItem('oith_calendar_events') || '[]');
            savedEvents = savedEvents.filter(e => e.id !== currentViewingEvent.id);
            localStorage.setItem('oith_calendar_events', JSON.stringify(savedEvents));
            
            // Remove from meetings list
            let savedMeetings = JSON.parse(localStorage.getItem('oith_scheduled_meetings') || '[]');
            savedMeetings = savedMeetings.filter(e => e.id !== currentViewingEvent.id);
            localStorage.setItem('oith_scheduled_meetings', JSON.stringify(savedMeetings));
            
            // Remove from calendarEvents array
            calendarEvents = calendarEvents.filter(e => e.id !== currentViewingEvent.id);
            
            // Sync to AWS
            if (typeof syncCalendarToAWS === 'function') {
                syncCalendarToAWS(true);
            }
            
            // Re-render calendar
            if (typeof renderCalendar === 'function') {
                renderCalendar();
            }
            if (typeof renderUpcomingEvents === 'function') {
                renderUpcomingEvents();
            }
            if (typeof updateCalendarBadge === 'function') {
                updateCalendarBadge();
            }
            // Also update Full Calendar View section
            if (typeof renderCalendarGrid === 'function') renderCalendarGrid();
            if (typeof renderMilestones === 'function') renderMilestones();
            if (typeof renderUpcomingTasks === 'function') renderUpcomingTasks();
            
            showToast('Event deleted', 'success');
            closeEventDetails();
        }
        
        // Alias for delete from dynamically created modal
        function deleteEventFromDetails() {
            deleteEvent();
        }
        
        // Share Event Functions
        function shareEvent() {
            if (!currentViewingEvent) return;
            
            // Try the static modal first, otherwise create dynamic one
            let shareModal = document.getElementById('shareEventModal');
            if (!shareModal) {
                shareModal = createShareEventModal();
                document.body.appendChild(shareModal);
            }
            
            // Update event title in share modal
            const eventTitleEl = shareModal.querySelector('.share-event-title');
            if (eventTitleEl) {
                eventTitleEl.textContent = currentViewingEvent.title;
            }
            
            shareModal.style.display = 'flex';
        }
        
        function createShareEventModal() {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.id = 'shareEventModal';
            modal.style.cssText = 'z-index: 2300; display: none;';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 500px;">
                    <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; padding: 20px; border-bottom: 1px solid var(--border);">
                        <h3 style="margin: 0;"> Share Event</h3>
                        <button class="close-btn" onclick="closeShareEventModal()">&times;</button>
                    </div>
                    <div class="modal-body" style="padding: 20px;">
                        <p class="share-event-title" style="font-weight: 600; margin-bottom: 16px;">${currentViewingEvent ? currentViewingEvent.title : 'Event'}</p>
                        <p style="margin-bottom: 16px; color: var(--text-secondary);">Send this event to others via email, SMS, or copy the details.</p>
                        
                        <div class="form-group" style="margin-bottom: 16px;">
                            <label style="display: block; margin-bottom: 6px; font-size: 0.85rem; color: var(--text-muted);">Send to Email</label>
                            <div style="display: flex; gap: 8px;">
                                <input type="email" id="shareEventEmail" placeholder="Enter email address..." class="form-control" style="flex: 1; padding: 10px 12px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary);">
                                <button type="button" class="btn btn-primary btn-sm" onclick="sendEventEmail()">Send</button>
                            </div>
                        </div>
                        
                        <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 20px;">
                            <button class="btn btn-secondary btn-sm" onclick="copyEventDetails()" style="flex: 1; min-width: 120px;"> Copy Details</button>
                            <button class="btn btn-secondary btn-sm" onclick="downloadEventICS()" style="flex: 1; min-width: 120px;"> Download .ics</button>
                            <button class="btn btn-secondary btn-sm" onclick="addToGoogleCalendar()" style="flex: 1; min-width: 120px;"> Google Cal</button>
                        </div>
                    </div>
                </div>
            `;
            return modal;
        }
        
        function closeShareEventModal() {
            const shareModal = document.getElementById('shareEventModal');
            if (shareModal) {
                shareModal.style.display = 'none';
            }
            const emailField = document.getElementById('shareEventEmail');
            if (emailField) {
                emailField.value = '';
            }
        }
        
        async function sendEventEmail() {
            const email = document.getElementById('shareEventEmail').value.trim();
            
            if (!email || !email.match(/^[^\s@]+@[^\s@]+\.[^\s@]+$/)) {
                showToast('Please enter a valid email address', 'error');
                return;
            }
            
            if (!currentViewingEvent) return;
            
            const eventDate = new Date(currentViewingEvent.date);
            const dateStr = eventDate.toLocaleDateString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            const timeStr = eventDate.toLocaleTimeString('en-US', { 
                hour: 'numeric', 
                minute: '2-digit' 
            });
            
            const emailBody = `
                <div style="font-family: system-ui, sans-serif; max-width: 600px; margin: 0 auto;">
                    <h2 style="color: #333;"> ${currentViewingEvent.title}</h2>
                    <p style="color: #666;"><strong>Date:</strong> ${dateStr}</p>
                    <p style="color: #666;"><strong>Time:</strong> ${timeStr}</p>
                    ${currentViewingEvent.meetingDetails?.location ? `<p style="color: #666;"><strong>Location:</strong> ${currentViewingEvent.meetingDetails.location}</p>` : ''}
                    ${currentViewingEvent.description ? `<p style="color: #666;"><strong>Description:</strong> ${currentViewingEvent.description}</p>` : ''}
                    <hr style="border: none; border-top: 1px solid #eee; margin: 20px 0;">
                    <p style="color: #999; font-size: 12px;">Sent from OITH Admin Calendar</p>
                </div>
            `;
            
            // Try to use email API if available
            try {
                const response = await fetch('http://localhost:3001/api/email/send', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        to: email,
                        subject: ` Event: ${currentViewingEvent.title} - ${dateStr}`,
                        body: emailBody
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    showToast(` Event sent to ${email}!`, 'success');
                } else if (result.queued) {
                    showToast(` Event queued - will send when email is configured`, 'info');
                } else {
                    throw new Error(result.error);
                }
            } catch (e) {
                // Fallback to mailto
                const subject = encodeURIComponent(`Event: ${currentViewingEvent.title}`);
                const body = encodeURIComponent(`${currentViewingEvent.title}\n\nDate: ${dateStr}\nTime: ${timeStr}\n${currentViewingEvent.description || ''}`);
                window.open(`mailto:${email}?subject=${subject}&body=${body}`);
                showToast(`Opening email client for ${email}`, 'info');
            }
            
            document.getElementById('shareEventEmail').value = '';
            closeShareEventModal();
        }
        
        function sendEventSMS() {
            const phone = document.getElementById('shareEventPhone').value.trim();
            
            if (!phone || phone.length < 10) {
                showToast('Please enter a valid phone number', 'error');
                return;
            }
            
            if (!currentViewingEvent) return;
            
            const eventDate = new Date(currentViewingEvent.date);
            const dateStr = eventDate.toLocaleDateString('en-US', { 
                month: 'short', 
                day: 'numeric',
                year: 'numeric'
            });
            const timeStr = eventDate.toLocaleTimeString('en-US', { 
                hour: 'numeric', 
                minute: '2-digit' 
            });
            
            const message = ` ${currentViewingEvent.title}\n ${dateStr} at ${timeStr}${currentViewingEvent.meetingDetails?.location ? `\n ${currentViewingEvent.meetingDetails.location}` : ''}`;
            
            // Open SMS app with pre-filled message
            const smsUrl = `sms:${phone}?body=${encodeURIComponent(message)}`;
            window.open(smsUrl);
            
            showToast(`Opening SMS for ${phone}`, 'info');
            document.getElementById('shareEventPhone').value = '';
            closeShareEventModal();
        }
        
        function addToOutlookCalendar() {
            if (!currentViewingEvent) return;
            
            const eventDate = new Date(currentViewingEvent.date);
            const endDate = new Date(eventDate.getTime() + 60 * 60 * 1000); // 1 hour later
            
            const formatDate = (d) => d.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
            
            const outlookUrl = `https://outlook.live.com/calendar/0/deeplink/compose?subject=${encodeURIComponent(currentViewingEvent.title)}&startdt=${formatDate(eventDate)}&enddt=${formatDate(endDate)}${currentViewingEvent.meetingDetails?.location ? `&location=${encodeURIComponent(currentViewingEvent.meetingDetails.location)}` : ''}${currentViewingEvent.description ? `&body=${encodeURIComponent(currentViewingEvent.description)}` : ''}`;
            
            window.open(outlookUrl, '_blank');
            showToast('Opening Outlook Calendar', 'info');
        }
        
        function copyEventDetails() {
            if (!currentViewingEvent) return;
            
            const eventDate = new Date(currentViewingEvent.date);
            const dateStr = eventDate.toLocaleDateString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            
            let details = ` ${currentViewingEvent.title}\n`;
            details += ` ${dateStr}\n`;
            
            if (currentViewingEvent.meetingDetails?.location) {
                details += ` ${currentViewingEvent.meetingDetails.location}\n`;
            }
            
            if (currentViewingEvent.meetingDetails?.zoomMeetingId) {
                details += ` Zoom Meeting ID: ${currentViewingEvent.meetingDetails.zoomMeetingId}\n`;
                if (currentViewingEvent.meetingDetails.zoomPasscode) {
                    details += ` Passcode: ${currentViewingEvent.meetingDetails.zoomPasscode}\n`;
                }
            }
            
            if (currentViewingEvent.description) {
                details += `\n ${currentViewingEvent.description}\n`;
            }
            
            navigator.clipboard.writeText(details).then(() => {
                showToast('Event details copied!', 'success');
            }).catch(() => {
                showToast('Failed to copy', 'error');
            });
        }
        
        function downloadEventICS() {
            if (!currentViewingEvent) return;
            
            const eventDate = new Date(currentViewingEvent.date);
            const endDate = new Date(eventDate.getTime() + (currentViewingEvent.meetingDetails?.duration || 60) * 60000);
            
            const formatICSDate = (d) => d.toISOString().replace(/[-:]/g, '').replace(/\.\d{3}/, '');
            
            const icsContent = [
                'BEGIN:VCALENDAR',
                'VERSION:2.0',
                'PRODID:-//OITH//Calendar//EN',
                'BEGIN:VEVENT',
                `UID:${currentViewingEvent.id}@oith.com`,
                `DTSTAMP:${formatICSDate(new Date())}`,
                `DTSTART:${formatICSDate(eventDate)}`,
                `DTEND:${formatICSDate(endDate)}`,
                `SUMMARY:${currentViewingEvent.title}`,
                currentViewingEvent.description ? `DESCRIPTION:${currentViewingEvent.description}` : '',
                currentViewingEvent.meetingDetails?.location ? `LOCATION:${currentViewingEvent.meetingDetails.location}` : '',
                'END:VEVENT',
                'END:VCALENDAR'
            ].filter(Boolean).join('\r\n');
            
            const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `${currentViewingEvent.title.replace(/[^a-z0-9]/gi, '_')}.ics`;
            link.click();
            
            showToast('Calendar file downloaded!', 'success');
        }
        
        function addToGoogleCalendar() {
            if (!currentViewingEvent) return;
            
            const eventDate = new Date(currentViewingEvent.date);
            const endDate = new Date(eventDate.getTime() + (currentViewingEvent.meetingDetails?.duration || 60) * 60000);
            
            const formatGoogleDate = (d) => d.toISOString().replace(/[-:]/g, '').replace(/\.\d{3}/, '');
            
            const params = new URLSearchParams({
                action: 'TEMPLATE',
                text: currentViewingEvent.title,
                dates: `${formatGoogleDate(eventDate)}/${formatGoogleDate(endDate)}`,
                details: currentViewingEvent.description || '',
                location: currentViewingEvent.meetingDetails?.location || ''
            });
            
            window.open(`https://calendar.google.com/calendar/render?${params.toString()}`, '_blank');
        }
        
        // ==========================================
        // ADMIN MAIL CLIENT SYSTEM
        // ==========================================
        
        const EMAIL_API_URL = 'http://localhost:3001/api/email';
        let currentMailFolder = 'inbox';
        let selectedMailId = null;
        let adminInbox = [];
        let emailConfigured = false;
        let emailStatus = null;
        
        async function openMailClient() {
            document.getElementById('mailClientModal').classList.add('active');
            await checkEmailStatus();
            await loadAdminInbox();
            renderMailList();
            updateMailBadge();
        }
        
        function closeMailClient() {
            document.getElementById('mailClientModal').classList.remove('active');
        }
        
        // ==========================================
        // FILE STORAGE FUNCTIONS
        // ==========================================
        
        let fileStorageData = {
            files: [],
            categories: [],
            currentCategory: 'all',
            selectedFile: null
        };
        
        async function openFileStorage() {
            document.getElementById('fileStorageModal').classList.add('active');
            await loadFileList();
            updateFileStorageStats();
        }
        
        function closeFileStorage() {
            document.getElementById('fileStorageModal').classList.remove('active');
        }
        
        async function loadFileList() {
            try {
                const response = await fetch(`${AWS_API_URL}/files`);
                if (response.ok) {
                    const data = await response.json();
                    fileStorageData.files = data.files || [];
                    fileStorageData.categories = data.categories || [];
                } else {
                    // Local fallback
                    fileStorageData.files = JSON.parse(localStorage.getItem('oith_admin_files') || '[]');
                }
            } catch (e) {
                console.log('Using local file storage');
                fileStorageData.files = JSON.parse(localStorage.getItem('oith_admin_files') || '[]');
            }
            renderFileList();
            updateFileBadge();
        }
        
        async function refreshFileList() {
            showToast('Refreshing file list...');
            await loadFileList();
            updateFileStorageStats();
            showToast('File list refreshed');
        }
        
        function renderFileList() {
            const container = document.getElementById('fileListItems');
            let files = fileStorageData.files;
            
            // Filter by category
            if (fileStorageData.currentCategory !== 'all') {
                files = files.filter(f => f.category === fileStorageData.currentCategory);
            }
            
            // Search filter
            const searchTerm = document.getElementById('fileSearchInput')?.value?.toLowerCase();
            if (searchTerm) {
                files = files.filter(f => 
                    f.originalName?.toLowerCase().includes(searchTerm) ||
                    f.fileName?.toLowerCase().includes(searchTerm) ||
                    f.description?.toLowerCase().includes(searchTerm)
                );
            }
            
            // Sort
            const sortBy = document.getElementById('fileSortBy')?.value || 'uploadedAt';
            files.sort((a, b) => {
                if (sortBy === 'fileSize') return (b.fileSize || 0) - (a.fileSize || 0);
                if (sortBy === 'fileName') return (a.originalName || '').localeCompare(b.originalName || '');
                return new Date(b.uploadedAt || 0) - new Date(a.uploadedAt || 0);
            });
            
            if (files.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px; color: var(--text-muted);">
                        <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" style="opacity: 0.3; margin-bottom: 16px;">
                            <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>
                        </svg>
                        <div style="font-size: 0.95rem; margin-bottom: 8px;">No files found</div>
                        <div style="font-size: 0.85rem;">Upload files or save from other sections</div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = files.map(file => `
                <div class="file-item ${fileStorageData.selectedFile?.id === file.id ? 'active' : ''}" onclick="selectFile('${file.id}')">
                    <div class="file-item-icon" style="background: ${getFileColor(file.fileType)};">
                        ${getFileIcon(file.fileType)}
                    </div>
                    <div class="file-item-info">
                        <div class="file-item-name">${file.originalName || file.fileName}</div>
                        <div class="file-item-meta">
                            <span>${formatFileSize(file.fileSize)}</span>
                            <span></span>
                            <span>${formatRelativeTime(file.uploadedAt)}</span>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        function selectFile(fileId) {
            const file = fileStorageData.files.find(f => f.id === fileId);
            if (!file) return;
            
            fileStorageData.selectedFile = file;
            renderFileList();
            renderFilePreview(file);
        }
        
        function renderFilePreview(file) {
            const emptyState = document.getElementById('filePreviewEmpty');
            const content = document.getElementById('filePreviewContent');
            
            emptyState.style.display = 'none';
            content.style.display = 'block';
            
            content.innerHTML = `
                <div class="file-preview-header">
                    <div class="file-preview-icon" style="background: ${getFileColor(file.fileType)};">
                        ${getFileIcon(file.fileType)}
                    </div>
                    <div class="file-preview-name">${file.originalName || file.fileName}</div>
                    <div class="file-preview-details">
                        ${formatFileSize(file.fileSize)}  ${file.fileType || 'Unknown'}
                    </div>
                    <div class="file-preview-actions">
                        <button class="btn btn-primary" onclick="downloadFile('${file.id}')" style="font-size: 0.8rem; flex: 1;">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
                                <polyline points="7 10 12 15 17 10"/>
                                <line x1="12" y1="15" x2="12" y2="3"/>
                            </svg>
                            Download
                        </button>
                        <button class="btn btn-secondary" onclick="deleteFile('${file.id}')" style="font-size: 0.8rem; color: var(--danger);">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="3 6 5 6 21 6"/>
                                <path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
                            </svg>
                        </button>
                    </div>
                </div>
                
                <div class="file-preview-section">
                    <div class="file-preview-section-title">Details</div>
                    <div style="display: grid; gap: 8px; font-size: 0.85rem;">
                        <div style="display: flex; justify-content: space-between;">
                            <span style="color: var(--text-muted);">Category:</span>
                            <span style="color: var(--text-primary); text-transform: capitalize;">${file.category || 'General'}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span style="color: var(--text-muted);">Uploaded:</span>
                            <span style="color: var(--text-primary);">${new Date(file.uploadedAt).toLocaleDateString()}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span style="color: var(--text-muted);">Source:</span>
                            <span style="color: var(--text-primary);">${file.source || 'Manual Upload'}</span>
                        </div>
                    </div>
                </div>
                
                ${file.description ? `
                <div class="file-preview-section">
                    <div class="file-preview-section-title">Description</div>
                    <p style="font-size: 0.85rem; color: var(--text-secondary); margin: 0;">${file.description}</p>
                </div>
                ` : ''}
                
                ${file.tags && file.tags.length > 0 ? `
                <div class="file-preview-section">
                    <div class="file-preview-section-title">Tags</div>
                    <div>${file.tags.map(t => `<span class="file-tag">${t}</span>`).join('')}</div>
                </div>
                ` : ''}
            `;
        }
        
        function selectFileCategory(category) {
            fileStorageData.currentCategory = category;
            
            // Update active state
            document.querySelectorAll('.file-folder').forEach(el => el.classList.remove('active'));
            event.target.closest('.file-folder').classList.add('active');
            
            // Update title
            document.getElementById('fileListTitle').textContent = 
                category === 'all' ? 'All Files' : category.charAt(0).toUpperCase() + category.slice(1);
            
            renderFileList();
        }
        
        function searchFiles(term) {
            renderFileList();
        }
        
        function sortFiles() {
            renderFileList();
        }
        
        function updateFileStorageStats() {
            const files = fileStorageData.files;
            const totalSize = files.reduce((sum, f) => sum + (f.fileSize || 0), 0);
            
            document.getElementById('storageUsed').textContent = formatFileSize(totalSize);
            document.getElementById('fileCountSidebar').textContent = files.length;
            document.getElementById('allFilesCount').textContent = files.length;
            
            // Update storage bar (assuming 1GB limit)
            const maxStorage = 1024 * 1024 * 1024; // 1GB
            const percentage = Math.min((totalSize / maxStorage) * 100, 100);
            document.getElementById('storageBar').style.width = percentage + '%';
        }
        
        function updateFileBadge() {
            const count = fileStorageData.files.length;
            const badge = document.getElementById('fileCount');
            if (badge) {
                badge.textContent = count;
                badge.setAttribute('data-count', count);
            }
        }
        
        async function downloadFile(fileId) {
            try {
                const response = await fetch(`${AWS_API_URL}/files/${fileId}/download`);
                if (response.ok) {
                    const data = await response.json();
                    const a = document.createElement('a');
                    a.href = data.url;
                    a.download = data.fileName;
                    a.target = '_blank';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    showToast('Download started');
                } else {
                    throw new Error('Download failed');
                }
            } catch (e) {
                // Local fallback
                const file = fileStorageData.files.find(f => f.id === fileId);
                if (file && file.data) {
                    const a = document.createElement('a');
                    a.href = file.data;
                    a.download = file.originalName || file.fileName;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    showToast('Download started');
                } else {
                    showToast('Download failed', 'error');
                }
            }
        }
        
        async function deleteFile(fileId) {
            if (!confirm('Are you sure you want to delete this file?')) return;
            
            try {
                const response = await fetch(`${AWS_API_URL}/files/${fileId}`, { method: 'DELETE' });
                if (response.ok) {
                    showToast('File deleted');
                } else {
                    throw new Error('Delete failed');
                }
            } catch (e) {
                // Local fallback
                const localFiles = JSON.parse(localStorage.getItem('oith_admin_files') || '[]');
                const updated = localFiles.filter(f => f.id !== fileId);
                localStorage.setItem('oith_admin_files', JSON.stringify(updated));
                showToast('File deleted (local)');
            }
            
            fileStorageData.selectedFile = null;
            document.getElementById('filePreviewEmpty').style.display = 'flex';
            document.getElementById('filePreviewContent').style.display = 'none';
            await loadFileList();
            updateFileStorageStats();
        }
        
        function openUploadModal() {
            document.getElementById('fileUploadModal').style.display = 'flex';
        }
        
        function closeUploadModal() {
            document.getElementById('fileUploadModal').style.display = 'none';
            clearSelectedFile();
        }
        
        let selectedUploadFile = null;
        
        function handleDragOver(event) {
            event.preventDefault();
            event.currentTarget.style.borderColor = 'var(--success)';
            event.currentTarget.style.background = 'rgba(16, 185, 129, 0.1)';
        }
        
        function handleDragLeave(event) {
            event.currentTarget.style.borderColor = 'var(--border)';
            event.currentTarget.style.background = 'transparent';
        }
        
        function handleDrop(event) {
            event.preventDefault();
            event.currentTarget.style.borderColor = 'var(--border)';
            event.currentTarget.style.background = 'transparent';
            
            const files = event.dataTransfer.files;
            if (files.length > 0) {
                selectUploadFile(files[0]);
            }
        }
        
        function handleFileSelect(event) {
            const files = event.target.files;
            if (files.length > 0) {
                selectUploadFile(files[0]);
            }
        }
        
        function selectUploadFile(file) {
            selectedUploadFile = file;
            document.getElementById('selectedFileInfo').style.display = 'block';
            document.getElementById('selectedFileName').textContent = file.name;
            document.getElementById('selectedFileSize').textContent = formatFileSize(file.size);
            document.getElementById('fileTypeIcon').textContent = getFileIcon(file.type);
            document.getElementById('dropZoneText').textContent = 'File selected';
        }
        
        function clearSelectedFile() {
            selectedUploadFile = null;
            document.getElementById('selectedFileInfo').style.display = 'none';
            document.getElementById('fileInput').value = '';
            document.getElementById('dropZoneText').textContent = 'Drag & drop files here';
        }
        
        async function handleFileUpload(event) {
            event.preventDefault();
            
            if (!selectedUploadFile) {
                showToast('Please select a file', 'error');
                return;
            }
            
            const btn = document.getElementById('uploadBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loader"></span> Uploading...';
            
            const category = document.getElementById('uploadCategory').value;
            const description = document.getElementById('uploadDescription').value;
            const tags = document.getElementById('uploadTags').value;
            
            try {
                // Read file as base64
                const base64 = await readFileAsBase64(selectedUploadFile);
                
                const response = await fetch(`${AWS_API_URL}/files/base64`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        fileName: selectedUploadFile.name,
                        fileType: selectedUploadFile.type,
                        fileSize: selectedUploadFile.size,
                        data: base64,
                        category,
                        description,
                        tags,
                        source: 'manual',
                        sourceSection: 'File Storage'
                    })
                });
                
                if (response.ok) {
                    showToast('File uploaded successfully');
                } else {
                    throw new Error('Upload failed');
                }
            } catch (e) {
                // Local fallback
                const base64 = await readFileAsBase64(selectedUploadFile);
                const localFiles = JSON.parse(localStorage.getItem('oith_admin_files') || '[]');
                localFiles.push({
                    id: 'local_' + Date.now(),
                    fileName: selectedUploadFile.name,
                    originalName: selectedUploadFile.name,
                    fileType: selectedUploadFile.type,
                    fileSize: selectedUploadFile.size,
                    data: base64,
                    category,
                    description,
                    tags: tags ? tags.split(',').map(t => t.trim()) : [],
                    uploadedAt: new Date().toISOString(),
                    source: 'manual'
                });
                localStorage.setItem('oith_admin_files', JSON.stringify(localFiles));
                showToast('File saved locally');
            }
            
            btn.disabled = false;
            btn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg> Upload';
            
            closeUploadModal();
            await loadFileList();
            updateFileStorageStats();
        }
        
        function readFileAsBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }
        
        function getFileIcon(mimeType) {
            if (!mimeType) return '';
            if (mimeType.includes('pdf')) return '';
            if (mimeType.includes('word') || mimeType.includes('document')) return '';
            if (mimeType.includes('sheet') || mimeType.includes('excel')) return '';
            if (mimeType.includes('presentation') || mimeType.includes('powerpoint')) return '';
            if (mimeType.includes('image')) return '';
            if (mimeType.includes('video')) return '';
            if (mimeType.includes('audio')) return '';
            if (mimeType.includes('zip') || mimeType.includes('archive')) return '';
            if (mimeType.includes('text')) return '';
            if (mimeType.includes('json')) return '';
            return '';
        }
        
        function getFileColor(mimeType) {
            if (!mimeType) return 'rgba(107, 114, 128, 0.2)';
            if (mimeType.includes('pdf')) return 'rgba(239, 68, 68, 0.2)';
            if (mimeType.includes('word') || mimeType.includes('document')) return 'rgba(59, 130, 246, 0.2)';
            if (mimeType.includes('sheet') || mimeType.includes('excel')) return 'rgba(16, 185, 129, 0.2)';
            if (mimeType.includes('presentation') || mimeType.includes('powerpoint')) return 'rgba(245, 158, 11, 0.2)';
            if (mimeType.includes('image')) return 'rgba(168, 85, 247, 0.2)';
            if (mimeType.includes('video')) return 'rgba(236, 72, 153, 0.2)';
            return 'rgba(107, 114, 128, 0.2)';
        }
        
        function formatFileSize(bytes) {
            if (!bytes || bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }
        
        function formatRelativeTime(dateStr) {
            if (!dateStr) return 'Unknown';
            const date = new Date(dateStr);
            const now = new Date();
            const diff = now - date;
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            
            if (days === 0) return 'Today';
            if (days === 1) return 'Yesterday';
            if (days < 7) return days + ' days ago';
            if (days < 30) return Math.floor(days / 7) + ' weeks ago';
            if (days < 365) return Math.floor(days / 30) + ' months ago';
            return Math.floor(days / 365) + ' years ago';
        }
        
        // Save file from other sections
        async function saveToFileStorage(fileData) {
            try {
                const response = await fetch(`${AWS_API_URL}/files/base64`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(fileData)
                });
                
                if (response.ok) {
                    showToast('File saved to storage');
                    await loadFileList();
                    updateFileStorageStats();
                    return true;
                }
            } catch (e) {
                // Local fallback
                const localFiles = JSON.parse(localStorage.getItem('oith_admin_files') || '[]');
                localFiles.push({
                    ...fileData,
                    id: 'local_' + Date.now(),
                    uploadedAt: new Date().toISOString()
                });
                localStorage.setItem('oith_admin_files', JSON.stringify(localFiles));
                showToast('File saved locally');
                await loadFileList();
                updateFileStorageStats();
                return true;
            }
            return false;
        }
        
        // ==========================================
        // SECURITY VULNERABILITY SCANNER
        // ==========================================
        
        let securityScanResults = {
            critical: [],
            high: [],
            medium: [],
            low: [],
            score: 0
        };
        
        let securityScanRunning = false;
        
        async function runSecurityScan() {
            if (securityScanRunning) {
                showToast('Scan already in progress', 'warning');
                return;
            }
            
            securityScanRunning = true;
            const btn = document.getElementById('runSecurityScanBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loader"></span> Scanning...';
            
            // Reset results
            securityScanResults = { critical: [], high: [], medium: [], low: [], score: 100 };
            
            const statusEl = document.getElementById('securityScanStatus');
            statusEl.textContent = 'Scanning...';
            statusEl.className = 'status-badge';
            statusEl.style.background = 'var(--info)';
            
            appendSiteDiagnosticsLog('');
            appendSiteDiagnosticsLog(' Starting Security Vulnerability Scan...');
            
            try {
                // 1. XSS Vulnerability Check
                if (document.getElementById('secCheckXSS')?.checked) {
                    await scanForXSS();
                }
                
                // 2. CSRF Protection Check
                if (document.getElementById('secCheckCSRF')?.checked) {
                    await checkCSRFProtection();
                }
                
                // 3. Exposed Credentials Check
                if (document.getElementById('secCheckCredentials')?.checked) {
                    await scanForExposedCredentials();
                }
                
                // 4. Insecure Configuration Check
                if (document.getElementById('secCheckInsecure')?.checked) {
                    await checkInsecureConfigurations();
                }
                
                // 5. Dependency Vulnerability Check
                if (document.getElementById('secCheckDependencies')?.checked) {
                    await checkDependencyVulnerabilities();
                }
                
                // 6. Security Headers Check
                if (document.getElementById('secCheckHeaders')?.checked) {
                    await checkSecurityHeaders();
                }
                
                // 7. Sensitive Data in Storage Check
                if (document.getElementById('secCheckStorage')?.checked) {
                    await scanStorageForSensitiveData();
                }
                
                // Calculate score
                calculateSecurityScore();
                
                // Update UI
                renderSecurityResults();
                
                appendSiteDiagnosticsLog(` Security scan complete. Score: ${securityScanResults.score}/100`);
                
                statusEl.textContent = securityScanResults.score >= 80 ? 'Secure' : securityScanResults.score >= 50 ? 'Needs Attention' : 'Critical Issues';
                statusEl.style.background = securityScanResults.score >= 80 ? 'var(--success)' : securityScanResults.score >= 50 ? 'var(--warning)' : 'var(--danger)';
                
            } catch (error) {
                appendSiteDiagnosticsLog(` Error during security scan: ${error.message}`, 'error');
                statusEl.textContent = 'Error';
                statusEl.style.background = 'var(--danger)';
            } finally {
                securityScanRunning = false;
                btn.disabled = false;
                btn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg> Run Security Scan';
            }
        }
        
        async function scanForXSS() {
            appendSiteDiagnosticsLog(' Scanning for XSS vulnerabilities...');
            
            // Check for innerHTML usage with user input
            const allScripts = document.querySelectorAll('script');
            let inlineScriptCount = 0;
            
            allScripts.forEach(script => {
                if (!script.src) {
                    inlineScriptCount++;
                    // Check for dangerous patterns
                    const content = script.textContent || '';
                    
                    if (content.includes('innerHTML') && content.includes('user')) {
                        securityScanResults.high.push({
                            type: 'XSS',
                            title: 'Potential XSS via innerHTML',
                            description: 'Found innerHTML usage that may involve user input',
                            location: 'Inline script',
                            recommendation: 'Use textContent or sanitize input before innerHTML'
                        });
                    }
                    
                    if (content.includes('eval(')) {
                        securityScanResults.critical.push({
                            type: 'XSS',
                            title: 'eval() function detected',
                            description: 'Using eval() can lead to code injection attacks',
                            location: 'Inline script',
                            recommendation: 'Avoid using eval(), use safer alternatives'
                        });
                    }
                    
                    if (content.includes('document.write(')) {
                        securityScanResults.medium.push({
                            type: 'XSS',
                            title: 'document.write() detected',
                            description: 'document.write() can be exploited for XSS',
                            location: 'Inline script',
                            recommendation: 'Use DOM manipulation methods instead'
                        });
                    }
                }
            });
            
            // Check input fields without sanitization
            const inputFields = document.querySelectorAll('input, textarea');
            inputFields.forEach(input => {
                if (!input.getAttribute('pattern') && !input.hasAttribute('maxlength')) {
                    securityScanResults.low.push({
                        type: 'XSS',
                        title: 'Input without validation',
                        description: `Input field ${input.id || input.name || 'unnamed'} lacks validation`,
                        location: 'Form input',
                        recommendation: 'Add pattern and maxlength attributes'
                    });
                }
            });
            
            appendSiteDiagnosticsLog(`   Found ${inlineScriptCount} inline scripts`);
        }
        
        async function checkCSRFProtection() {
            appendSiteDiagnosticsLog(' Checking CSRF protection...');
            
            // Check for CSRF tokens in forms
            const forms = document.querySelectorAll('form');
            let formsWithoutCSRF = 0;
            
            forms.forEach(form => {
                const hasCSRF = form.querySelector('input[name*="csrf"]') || 
                               form.querySelector('input[name*="token"]') ||
                               form.querySelector('input[name="_token"]');
                if (!hasCSRF && form.method?.toLowerCase() === 'post') {
                    formsWithoutCSRF++;
                }
            });
            
            if (formsWithoutCSRF > 0) {
                securityScanResults.medium.push({
                    type: 'CSRF',
                    title: 'Forms without CSRF protection',
                    description: `${formsWithoutCSRF} POST form(s) without CSRF tokens`,
                    location: 'HTML Forms',
                    recommendation: 'Add CSRF tokens to all POST forms'
                });
            }
            
            // Check for SameSite cookie attribute (via document.cookie analysis)
            if (document.cookie && !document.cookie.includes('SameSite')) {
                securityScanResults.low.push({
                    type: 'CSRF',
                    title: 'Cookies without SameSite attribute',
                    description: 'Some cookies may not have SameSite attribute set',
                    location: 'Cookies',
                    recommendation: 'Set SameSite=Strict or SameSite=Lax on all cookies'
                });
            }
            
            appendSiteDiagnosticsLog(`   Checked ${forms.length} forms, ${formsWithoutCSRF} without CSRF`);
        }
        
        async function scanForExposedCredentials() {
            appendSiteDiagnosticsLog(' Scanning for exposed credentials...');
            
            // Check localStorage
            let exposedCount = 0;
            const sensitivePatterns = ['password', 'secret', 'key', 'token', 'api_key', 'apikey', 'auth'];
            
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                const keyLower = key.toLowerCase();
                
                if (sensitivePatterns.some(p => keyLower.includes(p))) {
                    exposedCount++;
                    securityScanResults.high.push({
                        type: 'Credentials',
                        title: 'Sensitive data in localStorage',
                        description: `Key "${key}" may contain sensitive information`,
                        location: 'localStorage',
                        recommendation: 'Store sensitive data securely, not in localStorage'
                    });
                }
            }
            
            // Check for hardcoded credentials in page
            const pageContent = document.documentElement.innerHTML;
            const credentialPatterns = [
                /api[_-]?key\s*[:=]\s*["'][^"']+["']/gi,
                /secret\s*[:=]\s*["'][^"']+["']/gi,
                /password\s*[:=]\s*["'][^"']+["']/gi
            ];
            
            credentialPatterns.forEach(pattern => {
                const matches = pageContent.match(pattern);
                if (matches && matches.length > 0) {
                    securityScanResults.critical.push({
                        type: 'Credentials',
                        title: 'Hardcoded credentials detected',
                        description: 'Found potential hardcoded credentials in page source',
                        location: 'Page source',
                        recommendation: 'Remove hardcoded credentials, use environment variables'
                    });
                }
            });
            
            appendSiteDiagnosticsLog(`   Found ${exposedCount} potentially sensitive localStorage keys`);
        }
        
        async function checkInsecureConfigurations() {
            appendSiteDiagnosticsLog(' Checking insecure configurations...');
            
            // Check for HTTP resources on HTTPS page
            if (window.location.protocol === 'https:') {
                const mixedContent = document.querySelectorAll('[src^="http:"], [href^="http:"]');
                if (mixedContent.length > 0) {
                    securityScanResults.medium.push({
                        type: 'Configuration',
                        title: 'Mixed content detected',
                        description: `${mixedContent.length} HTTP resource(s) on HTTPS page`,
                        location: 'External resources',
                        recommendation: 'Use HTTPS for all external resources'
                    });
                }
            }
            
            // Check for autocomplete on sensitive fields
            const passwordFields = document.querySelectorAll('input[type="password"]');
            passwordFields.forEach(field => {
                if (field.getAttribute('autocomplete') !== 'off' && 
                    field.getAttribute('autocomplete') !== 'new-password') {
                    securityScanResults.low.push({
                        type: 'Configuration',
                        title: 'Password autocomplete enabled',
                        description: 'Password field allows autocomplete',
                        location: field.id || field.name || 'Password input',
                        recommendation: 'Set autocomplete="new-password" for password fields'
                    });
                }
            });
            
            // Check for target="_blank" without rel="noopener"
            const externalLinks = document.querySelectorAll('a[target="_blank"]:not([rel*="noopener"])');
            if (externalLinks.length > 0) {
                securityScanResults.low.push({
                    type: 'Configuration',
                    title: 'Links without noopener',
                    description: `${externalLinks.length} link(s) with target="_blank" missing rel="noopener"`,
                    location: 'External links',
                    recommendation: 'Add rel="noopener noreferrer" to external links'
                });
            }
        }
        
        async function checkDependencyVulnerabilities() {
            appendSiteDiagnosticsLog(' Checking dependency vulnerabilities...');
            
            // Check for known vulnerable libraries by version
            const vulnerableLibraries = [
                { name: 'jQuery', pattern: /jquery[.-]?([\d.]+)/i, vulnerable: v => parseFloat(v) < 3.5 },
                { name: 'Bootstrap', pattern: /bootstrap[.-]?([\d.]+)/i, vulnerable: v => parseFloat(v) < 4.6 },
                { name: 'Angular', pattern: /angular[.-]?([\d.]+)/i, vulnerable: v => parseFloat(v) < 1.8 }
            ];
            
            const scripts = document.querySelectorAll('script[src]');
            scripts.forEach(script => {
                const src = script.src.toLowerCase();
                vulnerableLibraries.forEach(lib => {
                    const match = src.match(lib.pattern);
                    if (match && match[1] && lib.vulnerable(match[1])) {
                        securityScanResults.high.push({
                            type: 'Dependency',
                            title: `Outdated ${lib.name} version`,
                            description: `${lib.name} version ${match[1]} may have known vulnerabilities`,
                            location: src,
                            recommendation: `Update ${lib.name} to the latest version`
                        });
                    }
                });
            });
            
            appendSiteDiagnosticsLog(`   Checked ${scripts.length} external scripts`);
        }
        
        async function checkSecurityHeaders() {
            appendSiteDiagnosticsLog(' Checking security headers...');
            
            // Note: Can't directly check response headers from JavaScript
            // But can check meta tags and provide recommendations
            
            const metaCSP = document.querySelector('meta[http-equiv="Content-Security-Policy"]');
            if (!metaCSP) {
                securityScanResults.medium.push({
                    type: 'Headers',
                    title: 'Missing Content Security Policy',
                    description: 'No CSP meta tag found',
                    location: 'Page headers',
                    recommendation: 'Add Content-Security-Policy header or meta tag'
                });
            }
            
            const metaXFrame = document.querySelector('meta[http-equiv="X-Frame-Options"]');
            if (!metaXFrame) {
                securityScanResults.low.push({
                    type: 'Headers',
                    title: 'No X-Frame-Options meta tag',
                    description: 'Page may be vulnerable to clickjacking',
                    location: 'Page headers',
                    recommendation: 'Add X-Frame-Options header to prevent framing'
                });
            }
            
            appendSiteDiagnosticsLog('   Security headers check complete');
        }
        
        async function scanStorageForSensitiveData() {
            appendSiteDiagnosticsLog(' Scanning storage for sensitive data...');
            
            const sensitiveDataPatterns = [
                { pattern: /\d{3,4}[-\s]?\d{4}[-\s]?\d{4}[-\s]?\d{4}/g, type: 'Credit Card' },
                { pattern: /\d{3}[-\s]?\d{2}[-\s]?\d{4}/g, type: 'SSN' },
                { pattern: /[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/g, type: 'Email' }
            ];
            
            let issuesFound = 0;
            
            // Check localStorage
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                const value = localStorage.getItem(key);
                
                sensitiveDataPatterns.forEach(({ pattern, type }) => {
                    if (type !== 'Email' && value && pattern.test(value)) {
                        issuesFound++;
                        securityScanResults.critical.push({
                            type: 'Data Exposure',
                            title: `${type} found in storage`,
                            description: `Potential ${type} data stored in localStorage key: ${key}`,
                            location: 'localStorage',
                            recommendation: `Remove sensitive ${type} data from client-side storage`
                        });
                    }
                });
            }
            
            appendSiteDiagnosticsLog(`   Found ${issuesFound} potential sensitive data exposures`);
        }
        
        function calculateSecurityScore() {
            let score = 100;
            
            // Deduct points based on severity
            score -= securityScanResults.critical.length * 25;
            score -= securityScanResults.high.length * 15;
            score -= securityScanResults.medium.length * 8;
            score -= securityScanResults.low.length * 3;
            
            securityScanResults.score = Math.max(0, Math.min(100, score));
        }
        
        function renderSecurityResults() {
            // Update counts
            document.getElementById('secCriticalCount').textContent = securityScanResults.critical.length;
            document.getElementById('secHighCount').textContent = securityScanResults.high.length;
            document.getElementById('secMediumCount').textContent = securityScanResults.medium.length;
            document.getElementById('secLowCount').textContent = securityScanResults.low.length;
            
            // Update score
            const score = securityScanResults.score;
            document.getElementById('securityScore').textContent = score;
            document.getElementById('securityScore').style.color = 
                score >= 80 ? 'var(--success)' : score >= 50 ? 'var(--warning)' : 'var(--danger)';
            
            // Update grade
            let grade = 'Critical Issues Found';
            if (score >= 90) grade = 'Excellent Security';
            else if (score >= 80) grade = 'Good Security';
            else if (score >= 60) grade = 'Needs Improvement';
            else if (score >= 40) grade = 'Poor Security';
            document.getElementById('securityGrade').textContent = grade;
            
            // Update arc
            const arc = document.getElementById('securityScoreArc');
            arc.setAttribute('stroke-dasharray', `${score}, 100`);
            arc.setAttribute('stroke', score >= 80 ? 'var(--success)' : score >= 50 ? 'var(--warning)' : 'var(--danger)');
            
            // Render vulnerability list
            const container = document.getElementById('securityVulnList');
            const allVulns = [
                ...securityScanResults.critical.map(v => ({ ...v, severity: 'critical' })),
                ...securityScanResults.high.map(v => ({ ...v, severity: 'high' })),
                ...securityScanResults.medium.map(v => ({ ...v, severity: 'medium' })),
                ...securityScanResults.low.map(v => ({ ...v, severity: 'low' }))
            ];
            
            if (allVulns.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; background: rgba(16, 185, 129, 0.1); border-radius: 12px; border: 1px solid rgba(16, 185, 129, 0.3);">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="var(--success)" stroke-width="1.5" style="margin-bottom: 12px;">
                            <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                            <polyline points="9 12 12 15 22 5" stroke="var(--success)"/>
                        </svg>
                        <div style="font-size: 1rem; color: var(--success); font-weight: 600;">No Vulnerabilities Found!</div>
                        <div style="font-size: 0.85rem; color: var(--text-muted); margin-top: 4px;">Your application passed all security checks</div>
                    </div>
                `;
            } else {
                container.innerHTML = allVulns.map(vuln => `
                    <div style="padding: 14px; background: var(--bg-tertiary); border-radius: 10px; border-left: 4px solid ${getSeverityColor(vuln.severity)};">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
                            <div style="font-weight: 600; color: var(--text-primary);">${vuln.title}</div>
                            <span style="padding: 2px 8px; background: ${getSeverityColor(vuln.severity)}33; color: ${getSeverityColor(vuln.severity)}; border-radius: 4px; font-size: 0.7rem; text-transform: uppercase; font-weight: 600;">${vuln.severity}</span>
                        </div>
                        <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 6px;">${vuln.description}</div>
                        <div style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 8px;"> ${vuln.location}</div>
                        <div style="font-size: 0.8rem; color: var(--info); display: flex; align-items: flex-start; gap: 6px;">
                            <span></span>
                            <span>${vuln.recommendation}</span>
                        </div>
                    </div>
                `).join('');
            }
        }
        
        function getSeverityColor(severity) {
            switch (severity) {
                case 'critical': return 'var(--danger)';
                case 'high': return '#f97316';
                case 'medium': return 'var(--warning)';
                case 'low': return 'var(--info)';
                default: return 'var(--text-muted)';
            }
        }
        
        function exportSecurityReport() {
            const report = {
                timestamp: new Date().toISOString(),
                score: securityScanResults.score,
                summary: {
                    critical: securityScanResults.critical.length,
                    high: securityScanResults.high.length,
                    medium: securityScanResults.medium.length,
                    low: securityScanResults.low.length
                },
                vulnerabilities: {
                    critical: securityScanResults.critical,
                    high: securityScanResults.high,
                    medium: securityScanResults.medium,
                    low: securityScanResults.low
                }
            };
            
            const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `security-report-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            showToast('Security report exported');
        }
        
        async function checkEmailStatus() {
            try {
                const response = await fetch(`${EMAIL_API_URL}/status`);
                emailStatus = await response.json();
                emailConfigured = emailStatus.configured;
                
                // Update UI to show email status
                const statusIndicator = document.getElementById('emailStatusIndicator');
                if (statusIndicator) {
                    statusIndicator.innerHTML = emailConfigured 
                        ? `<span style="color: #4ade80;"> Connected</span> ${emailStatus.email || ''}`
                        : `<span style="color: #fbbf24;"> Not configured</span> <button class="btn btn-secondary" style="font-size: 0.7rem; padding: 4px 8px; margin-left: 8px;" onclick="showEmailSetup()">Setup</button>`;
                }
            } catch (e) {
                console.log('Email API not available, using local storage');
                emailConfigured = false;
            }
        }
        
        async function loadAdminInbox() {
            // Try to fetch from backend first
            try {
                const response = await fetch(`${EMAIL_API_URL}/inbox`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.emails && data.emails.length > 0) {
                        adminInbox = data.emails;
                        return;
                    }
                }
            } catch (e) {
                console.log('Using local inbox fallback');
            }
            
            // Fallback to localStorage
            adminInbox = JSON.parse(localStorage.getItem('oith_admin_inbox') || '[]');
        }
        
        async function refreshMailInbox() {
            showToast('Refreshing inbox...');
            await checkEmailStatus();
            await loadAdminInbox();
            renderMailList();
            updateMailBadge();
            showToast(emailConfigured ? 'Inbox synced with Gmail' : 'Inbox refreshed (local)');
        }
        
        function updateMailBadge() {
            const unreadCount = adminInbox.filter(m => !m.read).length;
            const badge = document.getElementById('unreadMailCount');
            if (badge) {
                badge.textContent = unreadCount;
                badge.setAttribute('data-count', unreadCount);
            }
            
            // Update folder counts
            const inboxCount = document.getElementById('inboxCount');
            const supportCount = document.getElementById('supportCount');
            if (inboxCount) inboxCount.textContent = adminInbox.length;
            if (supportCount) supportCount.textContent = adminInbox.filter(m => m.subject || m.type === 'support').length;
        }
        
        function showEmailSetup() {
            const viewContent = document.getElementById('mailViewContent');
            document.getElementById('mailEmptyState').style.display = 'none';
            viewContent.style.display = 'block';
            
            viewContent.innerHTML = `
                <div style="padding: 20px;">
                    <h3 style="margin-bottom: 20px; color: var(--text-primary);"> Email Setup Required</h3>
                    
                    <div style="background: var(--bg-tertiary); border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                        <h4 style="color: #4ade80; margin-bottom: 12px;">Step 1: Create Google Cloud Project</h4>
                        <ol style="color: var(--text-secondary); line-height: 1.8; padding-left: 20px;">
                            <li>Go to <a href="https://console.cloud.google.com" target="_blank" style="color: #60a5fa;">Google Cloud Console</a></li>
                            <li>Create a new project called "OITH Admin"</li>
                            <li>Enable the <strong>Gmail API</strong></li>
                        </ol>
                    </div>
                    
                    <div style="background: var(--bg-tertiary); border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                        <h4 style="color: #4ade80; margin-bottom: 12px;">Step 2: Create OAuth Credentials</h4>
                        <ol style="color: var(--text-secondary); line-height: 1.8; padding-left: 20px;">
                            <li>Go to APIs & Services  Credentials</li>
                            <li>Create OAuth 2.0 Client ID (Web Application)</li>
                            <li>Add redirect URI: <code style="background: #1a1a2e; padding: 2px 6px; border-radius: 4px;">http://localhost:3001/api/email/oauth/callback</code></li>
                            <li>Copy Client ID and Client Secret</li>
                        </ol>
                    </div>
                    
                    <div style="background: var(--bg-tertiary); border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                        <h4 style="color: #4ade80; margin-bottom: 12px;">Step 3: Configure Backend</h4>
                        <ol style="color: var(--text-secondary); line-height: 1.8; padding-left: 20px;">
                            <li>Open <code style="background: #1a1a2e; padding: 2px 6px; border-radius: 4px;">prototype/server/.env</code></li>
                            <li>Add your credentials:
                                <pre style="background: #1a1a2e; padding: 12px; border-radius: 8px; margin-top: 8px; font-size: 0.85rem; overflow-x: auto;">GMAIL_CLIENT_ID=your_client_id_here
GMAIL_CLIENT_SECRET=your_client_secret_here
GMAIL_EMAIL=admin@oith.com</pre>
                            </li>
                            <li>Restart the backend server</li>
                        </ol>
                    </div>
                    
                    <div style="background: var(--bg-tertiary); border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                        <h4 style="color: #4ade80; margin-bottom: 12px;">Step 4: Complete OAuth Flow</h4>
                        <ol style="color: var(--text-secondary); line-height: 1.8; padding-left: 20px;">
                            <li>Click the button below to authorize Gmail access</li>
                            <li>Sign in with your Google Workspace account</li>
                            <li>Copy the refresh token to your .env file</li>
                        </ol>
                        <button class="btn btn-primary" onclick="startOAuthFlow()" style="margin-top: 12px;">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M15 3h4a2 2 0 012 2v14a2 2 0 01-2 2h-4"/>
                                <polyline points="10 17 15 12 10 7"/>
                                <line x1="15" y1="12" x2="3" y2="12"/>
                            </svg>
                            Start OAuth Authorization
                        </button>
                    </div>
                    
                    <div style="background: linear-gradient(135deg, #1e3a5f 0%, #1a1a2e 100%); border-radius: 12px; padding: 20px; border: 1px solid #3b82f6;">
                        <h4 style="color: #60a5fa; margin-bottom: 8px;"> Tip: Using Google Workspace</h4>
                        <p style="color: var(--text-secondary); font-size: 0.9rem;">
                            Once you set up Google Workspace for oith.com, you'll use that email account here. 
                            The Gmail API will let you send and receive emails as <strong>admin@oith.com</strong> directly from this dashboard.
                        </p>
                    </div>
                </div>
            `;
        }
        
        async function startOAuthFlow() {
            try {
                const response = await fetch(`${EMAIL_API_URL}/oauth/url`);
                const data = await response.json();
                
                if (data.authUrl) {
                    window.open(data.authUrl, '_blank', 'width=600,height=700');
                    showToast('Complete the authorization in the popup window', 'info');
                } else if (data.error) {
                    showToast('Configure GMAIL_CLIENT_ID and GMAIL_CLIENT_SECRET in .env first', 'warning');
                }
            } catch (e) {
                showToast('Backend server not running. Start it with: cd prototype/server && npm start', 'error');
            }
        }
        
        function switchMailFolder(folder) {
            currentMailFolder = folder;
            
            // Update active folder UI
            document.querySelectorAll('.mail-folder').forEach(f => f.classList.remove('active'));
            event.currentTarget.classList.add('active');
            
            // Update list title
            const titles = {
                'inbox': 'Inbox',
                'support': 'Support Requests',
                'sent': 'Sent',
                'archive': 'Archive'
            };
            document.getElementById('mailListTitle').textContent = titles[folder] || 'Inbox';
            
            renderMailList();
        }
        
        function renderMailList() {
            const listContainer = document.getElementById('mailListItems');
            
            if (adminInbox.length === 0) {
                listContainer.innerHTML = `
                    <div style="padding: 40px 20px; text-align: center; color: var(--text-muted);">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="margin-bottom: 12px; opacity: 0.3;">
                            <path d="M22 12h-6l-2 3h-4l-2-3H2"/>
                            <path d="M5.45 5.11L2 12v6a2 2 0 002 2h16a2 2 0 002-2v-6l-3.45-6.89A2 2 0 0016.76 4H7.24a2 2 0 00-1.79 1.11z"/>
                        </svg>
                        <p>No messages yet</p>
                        <p style="font-size: 0.75rem; margin-top: 8px;">Support messages from users will appear here</p>
                    </div>
                `;
                return;
            }
            
            listContainer.innerHTML = adminInbox.map(mail => {
                const date = new Date(mail.timestamp);
                const isToday = date.toDateString() === new Date().toDateString();
                const timeStr = isToday 
                    ? date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' })
                    : date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                
                const subjectLabels = {
                    'account': 'Account Issue',
                    'billing': 'Billing',
                    'matches': 'Matching',
                    'technical': 'Technical',
                    'feedback': 'Feedback',
                    'other': 'Other'
                };
                
                return `
                    <div class="mail-item ${!mail.read ? 'unread' : ''} ${selectedMailId === mail.id ? 'active' : ''}" 
                         onclick="viewMail(${mail.id})">
                        <div class="mail-item-header">
                            <span class="mail-item-from">${mail.userName || mail.userEmail}</span>
                            <span class="mail-item-time">${timeStr}</span>
                        </div>
                        <div class="mail-item-subject">${subjectLabels[mail.subject] || mail.subject}</div>
                        <div class="mail-item-preview">${mail.message.substring(0, 60)}${mail.message.length > 60 ? '...' : ''}</div>
                    </div>
                `;
            }).join('');
        }
        
        async function viewMail(mailId) {
            selectedMailId = mailId;
            const mail = adminInbox.find(m => m.id === mailId);
            
            if (!mail) return;
            
            // Mark as read
            if (!mail.read) {
                mail.read = true;
                localStorage.setItem('oith_admin_inbox', JSON.stringify(adminInbox));
                updateMailBadge();
                
                // Also mark on server if configured
                if (emailConfigured) {
                    try {
                        await fetch(`${EMAIL_API_URL}/mark-read/${mailId}`, { method: 'POST' });
                    } catch (e) {
                        console.log('API mark-read failed');
                    }
                }
            }
            
            // Re-render list to update active state
            renderMailList();
            
            // Show mail content
            document.getElementById('mailEmptyState').style.display = 'none';
            const viewContent = document.getElementById('mailViewContent');
            viewContent.style.display = 'block';
            
            const date = new Date(mail.timestamp);
            const dateStr = date.toLocaleDateString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                hour: 'numeric',
                minute: '2-digit'
            });
            
            const subjectLabels = {
                'account': 'Account Issue',
                'billing': 'Billing & Payments',
                'matches': 'Matching Questions',
                'technical': 'Technical Problem',
                'feedback': 'Feedback & Suggestions',
                'other': 'Other'
            };
            
            viewContent.innerHTML = `
                <div class="mail-view-header">
                    <div>
                        <div class="mail-view-subject">${subjectLabels[mail.subject] || mail.subject}</div>
                        <div class="mail-view-meta">
                            <span>From: <strong>${mail.userName || 'User'}</strong> &lt;${mail.userEmail}&gt;</span>
                            <span></span>
                            <span>${dateStr}</span>
                        </div>
                    </div>
                    <div class="mail-actions">
                        <button class="mail-action-btn" onclick="replyToMail(${mail.id})" title="Reply">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="9 17 4 12 9 7"/>
                                <path d="M20 18v-2a4 4 0 00-4-4H4"/>
                            </svg>
                        </button>
                        <button class="mail-action-btn" onclick="archiveMail(${mail.id})" title="Archive">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="21 8 21 21 3 21 3 8"/>
                                <rect x="1" y="3" width="22" height="5"/>
                            </svg>
                        </button>
                        <button class="mail-action-btn danger" onclick="deleteMail(${mail.id})" title="Delete">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="3 6 5 6 21 6"/>
                                <path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
                            </svg>
                        </button>
                    </div>
                </div>
                <div class="mail-view-body">${mail.message}</div>
                <div class="reply-form" id="replyForm" style="display: none;">
                    <h4 style="margin-bottom: 12px; color: var(--text-primary);">Reply to ${mail.userName || 'User'}</h4>
                    <textarea id="replyMessage" placeholder="Type your reply..."></textarea>
                    <div style="display: flex; gap: 12px;">
                        <button class="btn btn-secondary" onclick="cancelReply()">Cancel</button>
                        <button class="btn btn-primary" onclick="sendReply(${mail.id})">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="22" y1="2" x2="11" y2="13"/>
                                <polygon points="22 2 15 22 11 13 2 9 22 2"/>
                            </svg>
                            Send Reply
                        </button>
                    </div>
                </div>
            `;
        }
        
        function replyToMail(mailId) {
            document.getElementById('replyForm').style.display = 'block';
            document.getElementById('replyMessage').focus();
        }
        
        function cancelReply() {
            document.getElementById('replyForm').style.display = 'none';
            document.getElementById('replyMessage').value = '';
        }
        
        async function sendReply(mailId) {
            const replyText = document.getElementById('replyMessage').value;
            if (!replyText.trim()) {
                showToast('Please enter a reply message', 'warning');
                return;
            }
            
            const mail = adminInbox.find(m => m.id === mailId);
            if (!mail) return;
            
            // If email is configured, send via API
            if (emailConfigured) {
                try {
                    const response = await fetch(`${EMAIL_API_URL}/send`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            to: mail.userEmail || mail.from,
                            subject: `Re: ${mail.subject}`,
                            body: replyText,
                            replyTo: mail.id
                        })
                    });
                    
                    const result = await response.json();
                    if (result.success) {
                        mail.replied = true;
                        mail.replyMessage = replyText;
                        mail.replyTimestamp = new Date().toISOString();
                        localStorage.setItem('oith_admin_inbox', JSON.stringify(adminInbox));
                        cancelReply();
                        showToast(` Email sent to ${mail.userEmail || mail.from}`, 'success');
                    } else {
                        throw new Error(result.error || 'Failed to send');
                    }
                } catch (e) {
                    showToast('Failed to send email: ' + e.message, 'error');
                }
            } else {
                // Store locally for later
                mail.replied = true;
                mail.replyMessage = replyText;
                mail.replyTimestamp = new Date().toISOString();
                localStorage.setItem('oith_admin_inbox', JSON.stringify(adminInbox));
                cancelReply();
                showToast(`Reply saved (will send when email is configured)`, 'info');
            }
        }
        
        async function archiveMail(mailId) {
            // Try API first
            if (emailConfigured) {
                try {
                    await fetch(`${EMAIL_API_URL}/archive/${mailId}`, { method: 'DELETE' });
                } catch (e) {
                    console.log('API archive failed, using local');
                }
            }
            
            const index = adminInbox.findIndex(m => m.id === mailId);
            if (index > -1) {
                adminInbox.splice(index, 1);
                localStorage.setItem('oith_admin_inbox', JSON.stringify(adminInbox));
                renderMailList();
                updateMailBadge();
                
                // Reset view
                document.getElementById('mailEmptyState').style.display = 'flex';
                document.getElementById('mailViewContent').style.display = 'none';
                selectedMailId = null;
                
                showToast('Email archived');
            }
        }
        
        async function deleteMail(mailId) {
            if (!confirm('Are you sure you want to delete this email?')) return;
            
            // Try API first
            if (emailConfigured) {
                try {
                    await fetch(`${EMAIL_API_URL}/archive/${mailId}`, { method: 'DELETE' });
                } catch (e) {
                    console.log('API delete failed, using local');
                }
            }
            
            const index = adminInbox.findIndex(m => m.id === mailId);
            if (index > -1) {
                adminInbox.splice(index, 1);
                localStorage.setItem('oith_admin_inbox', JSON.stringify(adminInbox));
                renderMailList();
                updateMailBadge();
                
                // Reset view
                document.getElementById('mailEmptyState').style.display = 'flex';
                document.getElementById('mailViewContent').style.display = 'none';
                selectedMailId = null;
                
                showToast('Email deleted');
            }
        }
        
        // Close modals on escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeAdminCalendar();
                closeMailClient();
                closeAddEventModal();
            }
        });
        
        // Close modals on backdrop click
        document.getElementById('adminCalendarModal')?.addEventListener('click', function(e) {
            if (e.target === this) closeAdminCalendar();
        });
        
        document.getElementById('mailClientModal')?.addEventListener('click', function(e) {
            if (e.target === this) closeMailClient();
        });
        
        document.getElementById('addEventModal')?.addEventListener('click', function(e) {
            if (e.target === this) closeAddEventModal();
        });
        
        // Initialize calendar and mail badges on page load
        document.addEventListener('DOMContentLoaded', function() {
            initCalendarEvents();
            loadAdminInbox();
            updateMailBadge();
            updateCalendarBadge();
            
            // Sync calendar from AWS on load
            syncCalendarFromAWS();
        });
        
        // Poll for new emails and calendar updates every 15 seconds
        setInterval(async function() {
            // Update mail
            const previousMailCount = adminInbox.length;
            await loadAdminInbox();
            updateMailBadge();
            if (adminInbox.length > previousMailCount) {
                showToast(' New support message received!', 'info');
            }
            
            // Update calendar badge
            updateCalendarBadge();
        }, 15000);
        
        // ==========================================
        // CALENDAR AWS SYNC
        // ==========================================
        
        async function syncCalendarToAWS(silent = false) {
            if (!AWS_API_URL) {
                console.log(' Calendar AWS sync not configured');
                return { success: false, error: 'AWS API URL not configured' };
            }
            
            try {
                const savedEvents = JSON.parse(localStorage.getItem('oith_calendar_events') || '[]');
                
                const response = await fetch(`${AWS_API_URL}/calendar/sync`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ events: savedEvents })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    console.log(` Calendar synced to AWS: ${data.count || savedEvents.length} events`);
                    if (!silent) {
                        showToast(` Synced to AWS`, 'success');
                        logAdminActivity('sync', 'Synced calendar to AWS', `${savedEvents.length} events`);
                    }
                    return { success: true, count: savedEvents.length };
                } else {
                    const errorText = await response.text();
                    console.warn(' Calendar sync failed:', errorText);
                    return { success: false, error: errorText };
                }
            } catch (e) {
                console.log(' Calendar AWS sync error:', e.message);
                return { success: false, error: e.message };
            }
        }
        
        async function syncCalendarFromAWS() {
            if (!AWS_API_URL) {
                console.log(' Calendar AWS sync not configured');
                return;
            }
            
            try {
                const response = await fetch(`${AWS_API_URL}/calendar/events`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.events && data.events.length > 0) {
                        // Merge AWS events with local
                        const localEvents = JSON.parse(localStorage.getItem('oith_calendar_events') || '[]');
                        const merged = mergeCalendarEvents(localEvents, data.events);
                        localStorage.setItem('oith_calendar_events', JSON.stringify(merged));
                        
                        // Reload calendar events
                        initCalendarEvents();
                        updateCalendarBadge();
                        // Also update Full Calendar View section
                        if (typeof renderCalendarGrid === 'function') renderCalendarGrid();
                        if (typeof renderMilestones === 'function') renderMilestones();
                        if (typeof renderUpcomingTasks === 'function') renderUpcomingTasks();
                        console.log(` Calendar synced from AWS: ${data.events.length} events`);
                    }
                }
            } catch (e) {
                console.log(' Calendar AWS sync error:', e.message);
            }
        }
        
        // Manual calendar sync (both directions)
        async function manualCalendarSync() {
            showToast(' Syncing calendar...', 'info');
            
            // First push local to AWS
            const pushResult = await syncCalendarToAWS(true); // silent mode
            
            // Then pull from AWS (to get events from other admins)
            await syncCalendarFromAWS();
            
            if (pushResult.success) {
                showToast(` Calendar synced! (${pushResult.count} events)`, 'success');
            } else {
                showToast(' Sync complete (local only)', 'warning');
            }
        }
        
        function mergeCalendarEvents(local, remote) {
            const merged = [...local];
            const localIds = new Set(local.map(e => e.id));
            
            for (const event of remote) {
                if (!localIds.has(event.id)) {
                    merged.push(event);
                }
            }
            
            return merged;
        }
        
        // ==========================================
        // ML MODELS MANAGEMENT SYSTEM
        // ==========================================
        
        const ML_MODELS_API_URL = 'http://localhost:3001/api';
        // Note: mlModels already declared earlier in the file
        let currentEditingModel = null;
        let isNewModel = false;
        
        // Default models data
        const defaultModels = [
            {
                id: 'model_1',
                name: 'Compatibility Scoring Engine',
                icon: '',
                type: 'Multi-Factor Scoring',
                location: 'app.js:8230-8290',
                purpose: 'Calculates match compatibility (0-100%) based on goals, interests, location, age, communication style',
                status: 'active',
                version: 'v1.0',
                createdAt: '2025-11-28T00:00:00Z',
                updatedAt: new Date().toISOString()
            },
            {
                id: 'model_2',
                name: 'Profile Matching Filter',
                icon: '',
                type: 'Rule-Based Filter',
                location: 'app.js:4531-4705',
                purpose: 'Filters match pool based on user preferences (age range, distance, body type, ethnicity, lifestyle)',
                status: 'active',
                version: 'v1.0',
                createdAt: '2025-11-28T00:00:00Z',
                updatedAt: new Date().toISOString()
            },
            {
                id: 'model_3',
                name: 'Chat Response Generator',
                icon: '',
                type: 'Template LLM (Simulated)',
                location: 'app.js:8770-8795',
                purpose: 'Generates contextual chat responses from predefined templates. In production: GPT-4 API integration',
                status: 'simulated',
                version: 'v0.9',
                createdAt: '2025-11-28T00:00:00Z',
                updatedAt: new Date().toISOString()
            },
            {
                id: 'model_4',
                name: 'Date Readiness Predictor',
                icon: '',
                type: 'Heuristic Scoring',
                location: 'app.js:1265-1268',
                purpose: 'Calculates conversation readiness for scheduling dates (0-100 score based on message count, sentiment)',
                status: 'active',
                version: 'v1.0',
                createdAt: '2025-11-28T00:00:00Z',
                updatedAt: new Date().toISOString()
            },
            {
                id: 'model_5',
                name: 'Interest Overlap Analyzer',
                icon: '',
                type: 'Jaccard Similarity',
                location: 'app.js:8244-8247',
                purpose: 'Calculates shared interests between users using fuzzy string matching and overlap ratio',
                status: 'active',
                version: 'v1.0',
                createdAt: '2025-11-28T00:00:00Z',
                updatedAt: new Date().toISOString()
            },
            {
                id: 'model_6',
                name: 'Photo Response Generator',
                icon: '',
                type: 'Template Response',
                location: 'app.js:8746-8768',
                purpose: 'Generates appropriate responses when users share photos in chat',
                status: 'simulated',
                version: 'v0.9',
                createdAt: '2025-11-28T00:00:00Z',
                updatedAt: new Date().toISOString()
            }
        ];
        
        // Initialize models on page load
        function initMLModels() {
            // Try to load from localStorage first
            const savedModels = localStorage.getItem('oith_ml_models');
            if (savedModels) {
                const parsed = JSON.parse(savedModels);
                // If localStorage has models, use them; otherwise use defaults
                if (parsed && parsed.length > 0) {
                    mlModels = parsed;
                } else {
                    mlModels = [...defaultModels];
                    localStorage.setItem('oith_ml_models', JSON.stringify(mlModels));
                }
            } else {
                mlModels = [...defaultModels];
                localStorage.setItem('oith_ml_models', JSON.stringify(mlModels));
            }
            
            renderModelsTable();
            syncModelsFromAWS();
        }
        
        // Render models table
        function renderModelsTable() {
            const tbody = document.getElementById('modelsTableBody');
            if (!tbody) return;
            
            const activeCount = mlModels.filter(m => m.status === 'active').length;
            const countBadge = document.getElementById('activeModelsCount');
            if (countBadge) {
                countBadge.textContent = `${activeCount} ACTIVE`;
            }
            
            tbody.innerHTML = mlModels.map(model => `
                <tr data-model-id="${model.id}">
                    <td>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 1.2rem;">${model.icon || ''}</span>
                            <strong>${model.name}</strong>
                        </div>
                    </td>
                    <td><span class="model-type-badge ${getTypeClass(model.type)}">${model.type}</span></td>
                    <td><code>${model.location || '--'}</code></td>
                    <td style="max-width: 300px;">${model.purpose}</td>
                    <td><span class="status-badge ${getStatusClass(model.status)}">${getStatusLabel(model.status)}</span></td>
                    <td>
                        <div class="model-actions">
                            <button class="model-action-btn" onclick="editModel('${model.id}')" title="Edit Model">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/>
                                    <path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/>
                                </svg>
                            </button>
                            <button class="model-action-btn delete" onclick="confirmDeleteModel('${model.id}')" title="Delete Model">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="3 6 5 6 21 6"/>
                                    <path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
                                </svg>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
            
            // Update last sync time
            const lastSync = localStorage.getItem('oith_models_last_sync');
            const syncTimeEl = document.getElementById('lastModelSyncTime');
            if (syncTimeEl && lastSync) {
                const date = new Date(lastSync);
                syncTimeEl.textContent = `Last synced: ${date.toLocaleString()}`;
            }
        }
        
        function getTypeClass(type) {
            const typeMap = {
                'Multi-Factor Scoring': 'scoring',
                'Rule-Based Filter': 'filter',
                'Template LLM (Simulated)': 'llm',
                'Heuristic Scoring': 'heuristic',
                'Jaccard Similarity': 'similarity',
                'Template Response': 'template',
                'Neural Network': 'neural',
                'NLP Model': 'neural',
                'Computer Vision': 'neural'
            };
            return typeMap[type] || 'default';
        }
        
        function getStatusClass(status) {
            const statusMap = {
                'active': 'active',
                'simulated': 'warning',
                'testing': 'info',
                'disabled': 'danger',
                'planned': ''
            };
            return statusMap[status] || '';
        }
        
        function getStatusLabel(status) {
            const labelMap = {
                'active': 'Active',
                'simulated': 'Simulated',
                'testing': 'Testing',
                'disabled': 'Disabled',
                'planned': 'Planned'
            };
            return labelMap[status] || status;
        }
        
        // Add new model
        function addNewModel() {
            isNewModel = true;
            currentEditingModel = null;
            
            document.getElementById('modelEditorTitle').textContent = 'Add New Model';
            document.getElementById('modelEditorSubtitle').textContent = 'Configure a new ML model';
            document.getElementById('modelEditorIcon').textContent = '';
            
            // Reset form
            document.getElementById('modelEditorForm').reset();
            document.getElementById('modelAdvancedSettings').style.display = 'none';
            document.getElementById('deleteModelBtn').style.display = 'none';
            
            document.getElementById('modelEditorModal').style.display = 'flex';
        }
        
        // Edit existing model
        function editModel(modelId) {
            const model = mlModels.find(m => m.id === modelId);
            if (!model) return;
            
            isNewModel = false;
            currentEditingModel = model;
            
            document.getElementById('modelEditorTitle').textContent = 'Edit Model';
            document.getElementById('modelEditorSubtitle').textContent = model.name;
            document.getElementById('modelEditorIcon').textContent = model.icon || '';
            
            // Populate form
            document.getElementById('modelName').value = model.name || '';
            document.getElementById('modelIcon').value = model.icon || '';
            document.getElementById('modelType').value = model.type || 'Custom Algorithm';
            document.getElementById('modelLocation').value = model.location || '';
            document.getElementById('modelStatus').value = model.status || 'active';
            document.getElementById('modelPurpose').value = model.purpose || '';
            document.getElementById('modelVersion').value = model.version || '';
            document.getElementById('modelApiEndpoint').value = model.apiEndpoint || '';
            document.getElementById('modelApiKey').value = model.apiKey || '';
            document.getElementById('modelConfig').value = model.config ? JSON.stringify(model.config, null, 2) : '';
            document.getElementById('modelNotes').value = model.notes || '';
            
            document.getElementById('modelAdvancedSettings').style.display = 'none';
            document.getElementById('deleteModelBtn').style.display = 'flex';
            
            document.getElementById('modelEditorModal').style.display = 'flex';
        }
        
        function closeModelEditor() {
            document.getElementById('modelEditorModal').style.display = 'none';
            currentEditingModel = null;
            isNewModel = false;
        }
        
        function toggleAdvancedSettings() {
            const settings = document.getElementById('modelAdvancedSettings');
            const toggle = document.querySelector('.model-advanced-toggle');
            
            if (settings.style.display === 'none') {
                settings.style.display = 'block';
                toggle.classList.add('open');
            } else {
                settings.style.display = 'none';
                toggle.classList.remove('open');
            }
        }
        
        // Save model
        async function saveModel(e) {
            e.preventDefault();
            
            const modelData = {
                id: isNewModel ? 'model_' + Date.now() : currentEditingModel.id,
                name: document.getElementById('modelName').value,
                icon: document.getElementById('modelIcon').value,
                type: document.getElementById('modelType').value,
                location: document.getElementById('modelLocation').value,
                status: document.getElementById('modelStatus').value,
                purpose: document.getElementById('modelPurpose').value,
                version: document.getElementById('modelVersion').value,
                apiEndpoint: document.getElementById('modelApiEndpoint').value,
                apiKey: document.getElementById('modelApiKey').value,
                notes: document.getElementById('modelNotes').value,
                updatedAt: new Date().toISOString()
            };
            
            // Parse config JSON
            const configStr = document.getElementById('modelConfig').value;
            if (configStr) {
                try {
                    modelData.config = JSON.parse(configStr);
                } catch (err) {
                    showToast('Invalid JSON in configuration', 'error');
                    return;
                }
            }
            
            if (isNewModel) {
                modelData.createdAt = new Date().toISOString();
                mlModels.push(modelData);
            } else {
                const index = mlModels.findIndex(m => m.id === currentEditingModel.id);
                if (index >= 0) {
                    modelData.createdAt = mlModels[index].createdAt;
                    mlModels[index] = modelData;
                }
            }
            
            // Save to localStorage
            localStorage.setItem('oith_ml_models', JSON.stringify(mlModels));
            
            // Sync to AWS
            await syncModelsToAWS();
            
            // Re-render table
            renderModelsTable();
            closeModelEditor();
            
            showToast(isNewModel ? ' Model added and synced to AWS!' : ' Model updated and synced to AWS!', 'success');
        }
        
        // Delete model
        function confirmDeleteModel(modelId) {
            const model = mlModels.find(m => m.id === modelId);
            if (!model) return;
            
            if (confirm(`Are you sure you want to delete "${model.name}"? This action cannot be undone.`)) {
                deleteModelById(modelId);
            }
        }
        
        async function deleteModel() {
            if (!currentEditingModel) return;
            
            if (confirm(`Are you sure you want to delete "${currentEditingModel.name}"? This action cannot be undone.`)) {
                await deleteModelById(currentEditingModel.id);
                closeModelEditor();
            }
        }
        
        async function deleteModelById(modelId) {
            mlModels = mlModels.filter(m => m.id !== modelId);
            
            // Save to localStorage
            localStorage.setItem('oith_ml_models', JSON.stringify(mlModels));
            
            // Sync to AWS
            await syncModelsToAWS();
            
            // Re-render table
            renderModelsTable();
            
            showToast('Model deleted and synced to AWS', 'success');
        }
        
        // AWS Sync Functions
        async function syncModelsToAWS() {
            try {
                const response = await fetch(`${ML_MODELS_API_URL}/ml-models/sync`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        models: mlModels,
                        syncedAt: new Date().toISOString(),
                        syncedBy: 'admin'
                    })
                });
                
                if (response.ok) {
                    localStorage.setItem('oith_models_last_sync', new Date().toISOString());
                    console.log(' ML models synced to AWS');
                    renderModelsTable();
                    return true;
                }
            } catch (error) {
                console.log(' Could not sync models to AWS (using local storage):', error.message);
            }
            
            // Update sync time even if AWS fails (local save still happened)
            localStorage.setItem('oith_models_last_sync', new Date().toISOString());
            renderModelsTable();
            return false;
        }
        
        async function syncModelsFromAWS() {
            try {
                const response = await fetch(`${ML_MODELS_API_URL}/ml-models`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.models && data.models.length > 0) {
                        // Merge with local models
                        const localIds = new Set(mlModels.map(m => m.id));
                        data.models.forEach(awsModel => {
                            if (!localIds.has(awsModel.id)) {
                                mlModels.push(awsModel);
                            } else {
                                // Update existing model with AWS version if newer
                                const localIndex = mlModels.findIndex(m => m.id === awsModel.id);
                                if (localIndex >= 0) {
                                    const localUpdated = new Date(mlModels[localIndex].updatedAt || 0);
                                    const awsUpdated = new Date(awsModel.updatedAt || 0);
                                    if (awsUpdated > localUpdated) {
                                        mlModels[localIndex] = awsModel;
                                    }
                                }
                            }
                        });
                        
                        localStorage.setItem('oith_ml_models', JSON.stringify(mlModels));
                        localStorage.setItem('oith_models_last_sync', new Date().toISOString());
                        renderModelsTable();
                        console.log(' ML models synced from AWS');
                    }
                }
            } catch (error) {
                console.log(' Could not sync models from AWS (using local storage):', error.message);
            }
        }
        
        // Also initialize on page load if ML section is visible
        document.addEventListener('DOMContentLoaded', function() {
            // Close modal on backdrop click
            document.getElementById('modelEditorModal')?.addEventListener('click', function(e) {
                if (e.target === this) closeModelEditor();
            });
            
            // Initialize models if on ML page
            setTimeout(() => {
                const mlSection = document.getElementById('mlmodels-section');
                if (mlSection && mlSection.style.display !== 'none') {
                    initMLModels();
                }
            }, 500);
        });
    </script>
</body>
</html>